/**
 * å·¥å…·è°ƒç”¨çŠ¶æ€å±•ç¤ºç»„ä»¶
 * ç”¨äºæ˜¾ç¤ºAIæ¶ˆæ¯ä¸­çš„å·¥å…·è°ƒç”¨çŠ¶æ€ä¿¡æ¯
 */

import { Message, MessageRole } from '../models/ChatModels';
import { Logger } from '../utils/Logger';

/**
 * å·¥å…·è°ƒç”¨çŠ¶æ€ç»„ä»¶
 */
@ComponentV2
export struct ToolCallStatusComponent {
  @Param message: Message = new Message(MessageRole.ASSISTANT, '');
  @Param onSearchDetailsClick: ((searchDetails: string) => void) | undefined = undefined;

  /**
   * è·å–å·¥å…·è°ƒç”¨çŠ¶æ€æ–‡æœ¬
   */
  private getToolStatusText(): string {
    const toolNames = this.getMCPToolNamesText();

    switch (this.message.toolStatus) {
      case 'calling':
        return this.getCallingStatusText() + toolNames;
      case 'completed':
        return this.getCompletedStatusText() + toolNames;
      case 'failed':
        return this.getFailedStatusText() + toolNames;
      default:
        return '';
    }
  }

  /**
   * è·å–MCPå·¥å…·åç§°æ–‡æœ¬
   */
  private getMCPToolNamesText(): string {
    if (this.message.mcpToolNames && this.message.mcpToolNames.length > 0) {
      // æœ€å¤šæ˜¾ç¤ºå‰3ä¸ªå·¥å…·åç§°ï¼Œæ¯ä¸ªåç§°æœ€å¤š30å­—ç¬¦ï¼ˆè¶³å¤Ÿæ˜¾ç¤ºcalculatorã€app_launcherç­‰ï¼‰
      const toolsToShow = this.message.mcpToolNames.slice(0, 3).map(name => {
        return name.length > 30 ? name.substring(0, 27) + '...' : name;
      });
      const hasMore = this.message.mcpToolNames.length > 3;
      const toolNamesStr = toolsToShow.join(', ');
      const moreText = hasMore ? ` +${this.message.mcpToolNames.length - 3}` : '';
      return `: ${toolNamesStr}${moreText}`;
    }
    // åœ¨è°ƒç”¨çŠ¶æ€ä¸‹ï¼Œå¦‚æœè¿˜æ²¡æœ‰å®é™…æ‰§è¡Œçš„å·¥å…·ï¼Œä¸æ˜¾ç¤ºå·¥å…·åç§°
    if (this.message.toolStatus === 'calling') {
      return '';
    }
    // å‘åå…¼å®¹ï¼Œå¦‚æœæ²¡æœ‰mcpToolNamesï¼Œä½¿ç”¨åŸæœ‰çš„toolName
    return this.message.toolName ? `: ${this.message.toolName}` : '';
  }

  /**
   * è·å–è°ƒç”¨ä¸­çŠ¶æ€æ–‡æœ¬
   */
  private getCallingStatusText(): string {
    // åªå¤„ç†MCPå·¥å…·ç±»å‹
    if (this.message.toolType === 'mcp') {
      return 'ğŸ”§ æ­£åœ¨æ‰§è¡ŒMCPå·¥å…·';
    }
    return '';
  }

  /**
   * è·å–å®ŒæˆçŠ¶æ€æ–‡æœ¬
   */
  private getCompletedStatusText(): string {
    // åªå¤„ç†MCPå·¥å…·ç±»å‹ï¼ˆå›¾æ ‡å·²ç»æ˜¾ç¤ºâœ…ï¼Œæ–‡æœ¬ä¸éœ€è¦é‡å¤æ˜¾ç¤ºï¼‰
    if (this.message.toolType === 'mcp') {
      return 'MCP';
    }
    return '';
  }

  /**
   * è·å–å¤±è´¥çŠ¶æ€æ–‡æœ¬
   */
  private getFailedStatusText(): string {
    // åªå¤„ç†MCPå·¥å…·ç±»å‹ï¼ˆå›¾æ ‡å·²ç»æ˜¾ç¤ºâŒï¼Œæ–‡æœ¬ä¸éœ€è¦é‡å¤æ˜¾ç¤ºï¼‰
    if (this.message.toolType === 'mcp') {
      return 'MCP';
    }
    return '';
  }

  /**
   * è·å–å·¥å…·è°ƒç”¨çŠ¶æ€å›¾æ ‡
   */
  private getToolStatusIcon(): string {
    switch (this.message.toolStatus) {
      case 'calling':
        return this.getCallingIcon();
      case 'completed':
        return 'âœ…';
      case 'failed':
        return 'âŒ';
      default:
        return '';
    }
  }

  /**
   * è·å–è°ƒç”¨ä¸­çŠ¶æ€å›¾æ ‡
   */
  private getCallingIcon(): string {
    // åªå¤„ç†MCPå·¥å…·ç±»å‹
    if (this.message.toolType === 'mcp') {
      return 'ğŸ”§';
    }
    return '';
  }

  /**
   * è·å–å·¥å…·è°ƒç”¨çŠ¶æ€é¢œè‰²
   */
  private getToolStatusColor(): ResourceStr {
    switch (this.message.toolStatus) {
      case 'calling':
        return $r('app.color.primary_color');
      case 'completed':
        return '#4CAF50'; // ç»¿è‰²
      case 'failed':
        return $r('app.color.error_color');
      default:
        return $r('app.color.text_secondary');
    }
  }

  /**
   * æ˜¯å¦åº”è¯¥æ˜¾ç¤ºåŠ¨ç”»
   */
  private shouldShowAnimation(): boolean {
    return this.message.toolStatus === 'calling';
  }

  /**
   * æ„å»ºå·¥å…·è°ƒç”¨çŠ¶æ€å¡ç‰‡
   */
  @Builder
  buildToolStatusCard() {
    // åªæ˜¾ç¤ºMCPå·¥å…·è°ƒç”¨çŠ¶æ€
    if (this.shouldShowToolStatus()) {
      Column({ space: 4 }) {
        // MCPå·¥å…·è°ƒç”¨çŠ¶æ€è¡Œ
        Row({ space: 8 }) {
          // çŠ¶æ€å›¾æ ‡
          Text(this.getToolStatusIcon())
            .fontSize(14)
            .animation({
              duration: this.shouldShowAnimation() ? 1000 : 0,
              curve: Curve.EaseInOut,
              iterations: this.shouldShowAnimation() ? -1 : 1,
              playMode: PlayMode.Alternate
            })
            .scale({
              x: this.shouldShowAnimation() ? 1.2 : 1.0,
              y: this.shouldShowAnimation() ? 1.2 : 1.0
            })

          // çŠ¶æ€æ–‡æœ¬
          Text(this.getToolStatusText())
            .fontSize(12)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.getToolStatusColor())
            .opacity(this.shouldShowAnimation() ? 0.8 : 1.0)
            .animation({
              duration: this.shouldShowAnimation() ? 1500 : 0,
              curve: Curve.EaseInOut,
              iterations: this.shouldShowAnimation() ? -1 : 1,
              playMode: PlayMode.Alternate
            })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)
        }
      }
      .padding({ top: 6, bottom: 6, left: 12, right: 12 })
      .backgroundColor(this.getToolStatusBackgroundColor())
      .borderRadius(16)
      .border({
        width: 1,
        color: this.getToolStatusColor()
      })
      .margin({ top: 8, bottom: 4 })
      .onClick(() => {
        this.handleToolStatusClick();
      })
      .gesture(
        TapGesture({ count: 1 })
          .onAction(() => {
            this.handleToolStatusClick();
          })
      )
    } else {
      Blank()
        .width(0)
        .height(0)
    }
  }

  /**
   * æ˜¯å¦åº”è¯¥æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€
   */
  private shouldShowToolStatus(): boolean {
    // åªæ˜¾ç¤ºMCPå·¥å…·è°ƒç”¨çŠ¶æ€ï¼Œæ’é™¤ç½‘ç»œæœç´¢å’Œå…¶ä»–å·¥å…·ç±»å‹
    return !!(this.message.toolStatus &&
              this.message.toolStatus !== 'idle' &&
              this.message.toolType === 'mcp');
  }


  /**
   * è·å–å·¥å…·è°ƒç”¨çŠ¶æ€èƒŒæ™¯è‰²
   */
  private getToolStatusBackgroundColor(): ResourceStr {
    switch (this.message.toolStatus) {
      case 'calling':
        return 'rgba(33, 150, 243, 0.1)'; // è“è‰²èƒŒæ™¯
      case 'completed':
        return 'rgba(76, 175, 80, 0.1)'; // ç»¿è‰²èƒŒæ™¯
      case 'failed':
        return 'rgba(244, 67, 54, 0.1)'; // çº¢è‰²èƒŒæ™¯
      default:
        return $r('app.color.card_background');
    }
  }

  /**
   * å¤„ç†å·¥å…·çŠ¶æ€ç‚¹å‡»äº‹ä»¶
   */
  private handleToolStatusClick(): void {
    if (this.message.mcpToolNames && this.message.mcpToolNames.length > 0) {
      const toolsList = this.message.mcpToolNames.join(', ');
      Logger.info('ToolCallStatusComponent', `MCPå·¥å…·çŠ¶æ€è¢«ç‚¹å‡»: ${this.message.toolStatus}, å·¥å…·åˆ—è¡¨: ${toolsList}`);

      // å¯ä»¥åœ¨æœªæ¥æ·»åŠ è¯¦ç»†ä¿¡æ¯æ˜¾ç¤ºï¼Œæ¯”å¦‚å¼¹å‡ºå¯¹è¯æ¡†æ˜¾ç¤ºæ‰€æœ‰å·¥å…·åç§°å’Œæ‰§è¡Œç»“æœ
      // ç›®å‰ä»…è®°å½•æ—¥å¿—ä»¥ä¾›è°ƒè¯•
    } else {
      Logger.info('ToolCallStatusComponent', `MCPå·¥å…·çŠ¶æ€è¢«ç‚¹å‡»: ${this.message.toolStatus}`);
    }
  }

  build() {
    this.buildToolStatusCard()
  }
}