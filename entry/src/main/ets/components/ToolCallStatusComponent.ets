/**
 * å·¥å…·è°ƒç”¨çŠ¶æ€å±•ç¤ºç»„ä»¶
 * ç”¨äºæ˜¾ç¤ºAIæ¶ˆæ¯ä¸­çš„å·¥å…·è°ƒç”¨çŠ¶æ€ä¿¡æ¯
 */

import { Message, MessageRole } from '../models/ChatModels';
import { Logger } from '../utils/Logger';

/**
 * å·¥å…·è°ƒç”¨çŠ¶æ€æšä¸¾
 */
export enum ToolCallStatus {
  IDLE = 'idle',        // ç©ºé—²çŠ¶æ€
  CALLING = 'calling',  // è°ƒç”¨ä¸­
  COMPLETED = 'completed', // è°ƒç”¨å®Œæˆ
  FAILED = 'failed'     // è°ƒç”¨å¤±è´¥
}

/**
 * å·¥å…·è°ƒç”¨çŠ¶æ€ç»„ä»¶
 */
@ComponentV2
export struct ToolCallStatusComponent {
  @Param message: Message = new Message(MessageRole.ASSISTANT, '');
  @Param onSearchDetailsClick: ((searchDetails: string) => void) | undefined = undefined;

  /**
   * è·å–å·¥å…·è°ƒç”¨çŠ¶æ€æ–‡æœ¬
   */
  private getToolStatusText(): string {
    switch (this.message.toolStatus) {
      case ToolCallStatus.CALLING:
        if (this.message.webUsed) {
          return 'ğŸ” æ­£åœ¨æœç´¢ç½‘ç»œä¿¡æ¯...';
        }
        return 'âš™ï¸ æ­£åœ¨è°ƒç”¨å·¥å…·...';
      case ToolCallStatus.COMPLETED:
        if (this.message.webUsed) {
          return 'âœ… æœç´¢å®Œæˆ';
        }
        return 'âœ… å·¥å…·è°ƒç”¨å®Œæˆ';
      case ToolCallStatus.FAILED:
        return 'âŒ å·¥å…·è°ƒç”¨å¤±è´¥';
      default:
        return '';
    }
  }

  /**
   * è·å–å·¥å…·è°ƒç”¨çŠ¶æ€å›¾æ ‡
   */
  private getToolStatusIcon(): string {
    switch (this.message.toolStatus) {
      case ToolCallStatus.CALLING:
        return this.message.webUsed ? 'ğŸ”' : 'âš™ï¸';
      case ToolCallStatus.COMPLETED:
        return 'âœ…';
      case ToolCallStatus.FAILED:
        return 'âŒ';
      default:
        return '';
    }
  }

  /**
   * è·å–å·¥å…·è°ƒç”¨çŠ¶æ€é¢œè‰²
   */
  private getToolStatusColor(): ResourceStr {
    switch (this.message.toolStatus) {
      case ToolCallStatus.CALLING:
        return $r('app.color.primary_color');
      case ToolCallStatus.COMPLETED:
        return '#4CAF50'; // ç»¿è‰²
      case ToolCallStatus.FAILED:
        return $r('app.color.error_color');
      default:
        return $r('app.color.text_secondary');
    }
  }

  /**
   * æ˜¯å¦åº”è¯¥æ˜¾ç¤ºåŠ¨ç”»
   */
  private shouldShowAnimation(): boolean {
    return this.message.toolStatus === ToolCallStatus.CALLING;
  }

  /**
   * æ„å»ºå·¥å…·è°ƒç”¨çŠ¶æ€å¡ç‰‡
   */
  @Builder
  buildToolStatusCard() {
    // æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€æˆ–ç½‘ç»œæœç´¢ä¿¡æ¯
    if (this.shouldShowToolStatus() || this.shouldShowSearchInfo()) {
      Column({ space: 4 }) {
        // å·¥å…·è°ƒç”¨çŠ¶æ€è¡Œ
        if (this.shouldShowToolStatus()) {
          Row({ space: 8 }) {
            // çŠ¶æ€å›¾æ ‡
            Text(this.getToolStatusIcon())
              .fontSize(14)
              .animation({
                duration: this.shouldShowAnimation() ? 1000 : 0,
                curve: Curve.EaseInOut,
                iterations: this.shouldShowAnimation() ? -1 : 1,
                playMode: PlayMode.Alternate
              })
              .scale({
                x: this.shouldShowAnimation() ? 1.2 : 1.0,
                y: this.shouldShowAnimation() ? 1.2 : 1.0
              })

            // çŠ¶æ€æ–‡æœ¬
            Text(this.getToolStatusText())
              .fontSize(12)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.getToolStatusColor())
              .opacity(this.shouldShowAnimation() ? 0.8 : 1.0)
              .animation({
                duration: this.shouldShowAnimation() ? 1500 : 0,
                curve: Curve.EaseInOut,
                iterations: this.shouldShowAnimation() ? -1 : 1,
                playMode: PlayMode.Alternate
              })
          }
        }

        // æœç´¢ä¿¡æ¯è¡Œï¼ˆåœ¨å®ŒæˆçŠ¶æ€æ—¶æ˜¾ç¤ºï¼‰
        if (this.shouldShowSearchInfo()) {
          Row({ space: 6 }) {
            Text('ğŸ”')
              .fontSize(12)
            Text(this.truncateSearchInfo(this.message.searchInfo || ''))
              .fontSize(11)
              .fontColor($r('app.color.text_secondary'))
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)
          }
        }
      }
      .padding({ top: 6, bottom: 6, left: 12, right: 12 })
      .backgroundColor(this.getToolStatusBackgroundColor())
      .borderRadius(16)
      .border({
        width: 1,
        color: this.getToolStatusColor()
      })
      .margin({ top: 8, bottom: 4 })
      .onClick(() => {
        this.handleToolStatusClick();
      })
    } else {
      Blank()
        .width(0)
        .height(0)
    }
  }

  /**
   * æ˜¯å¦åº”è¯¥æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€
   */
  private shouldShowToolStatus(): boolean {
    return !!(this.message.toolStatus && this.message.toolStatus !== ToolCallStatus.IDLE);
  }

  /**
   * æ˜¯å¦åº”è¯¥æ˜¾ç¤ºæœç´¢ä¿¡æ¯
   */
  private shouldShowSearchInfo(): boolean {
    return !!(this.message.webUsed && this.message.searchInfo &&
      this.message.toolStatus === ToolCallStatus.COMPLETED);
  }

  /**
   * æˆªæ–­æœç´¢ä¿¡æ¯ä»¥é€‚åˆæ˜¾ç¤º
   */
  private truncateSearchInfo(searchInfo: string): string {
    if (!searchInfo) return '';
    const maxLength = 60;
    return searchInfo.length > maxLength ?
      searchInfo.substring(0, maxLength) + '...' : searchInfo;
  }

  /**
   * è·å–å·¥å…·è°ƒç”¨çŠ¶æ€èƒŒæ™¯è‰²
   */
  private getToolStatusBackgroundColor(): ResourceStr {
    switch (this.message.toolStatus) {
      case ToolCallStatus.CALLING:
        return 'rgba(33, 150, 243, 0.1)'; // è“è‰²èƒŒæ™¯
      case ToolCallStatus.COMPLETED:
        return 'rgba(76, 175, 80, 0.1)'; // ç»¿è‰²èƒŒæ™¯
      case ToolCallStatus.FAILED:
        return 'rgba(244, 67, 54, 0.1)'; // çº¢è‰²èƒŒæ™¯
      default:
        return $r('app.color.card_background');
    }
  }

  /**
   * å¤„ç†å·¥å…·çŠ¶æ€ç‚¹å‡»äº‹ä»¶
   */
  private handleToolStatusClick(): void {
    Logger.info('ToolCallStatusComponent', `å·¥å…·çŠ¶æ€è¢«ç‚¹å‡»: ${this.message.toolStatus}`);

    // å¦‚æœæ˜¯ç½‘ç»œæœç´¢ç›¸å…³ï¼Œæ˜¾ç¤ºæœç´¢è¯¦æƒ…
    if (this.message.webUsed && (this.message.searchDetails || this.message.searchInfo)) {
      Logger.info('ToolCallStatusComponent', 'æ˜¾ç¤ºæœç´¢è¯¦æƒ…');

      // ä¼˜å…ˆä½¿ç”¨è¯¦ç»†ä¿¡æ¯ï¼Œå¦åˆ™ä½¿ç”¨ç®€åŒ–ä¿¡æ¯
      const detailsToShow = this.message.searchDetails || this.message.searchInfo || '';

      if (detailsToShow && this.onSearchDetailsClick) {
        this.onSearchDetailsClick(detailsToShow);
      }
    }
  }

  build() {
    this.buildToolStatusCard()
  }
}