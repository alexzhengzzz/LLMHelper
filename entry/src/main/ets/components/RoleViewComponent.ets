import { SystemPrompt } from '../models/ChatModels';
import { RoleCardComponent } from './RoleCardComponent';
import { AppStorage } from '../utils/AppStorage';
import { Logger } from '../utils/Logger';
import { COMMON_CONSTANTS } from '../utils/Constants';

/**
 * è§’è‰²åˆ†ç±»æ¥å£
 */
interface CategoryItem {
  id: string;
  name: string;
  icon: string;
}

/**
 * è§’è‰²è§†å›¾ç»„ä»¶å±æ€§
 */
interface RoleViewProps {
  onRoleSelect?: (role: SystemPrompt) => void;
}

/**
 * è§’è‰²è§†å›¾ç»„ä»¶ - æ˜¾ç¤ºè§’è‰²åˆ—è¡¨å’Œåˆ†ç±»
 */
@ComponentV2
export struct RoleViewComponent {
  @Param onRoleSelect: (role: SystemPrompt) => void = () => {};
  @Local roles: SystemPrompt[] = [];
  @Local selectedCategory: string = 'all';
  @Local isLoading: boolean = true;
  @Local isDarkMode: boolean = false;

  // åˆ†ç±»é€‰é¡¹
  private readonly categories: CategoryItem[] = [
    { id: 'all', name: 'å…¨éƒ¨è§’è‰²', icon: 'ğŸ­' },
    { id: 'professional', name: 'ä¸“ä¸šè§’è‰²', icon: 'ğŸ’¼' },
    { id: 'creative', name: 'åˆ›æ„è§’è‰²', icon: 'ğŸ¨' },
    { id: 'life', name: 'ç”Ÿæ´»è§’è‰²', icon: 'ğŸ ' },
    { id: 'psychology', name: 'å¿ƒç†è§’è‰²', icon: 'ğŸ§ ' },
    { id: 'custom', name: 'è‡ªå®šä¹‰è§’è‰²', icon: 'âš™ï¸' }
  ];

  aboutToAppear(): void {
    this.loadRoles();
  }

  aboutToDisappear(): void {
    // æ¸…ç†èµ„æº
  }

  /**
   * åŠ è½½è§’è‰²æ•°æ®
   */
  private async loadRoles(): Promise<void> {
    try {
      this.isLoading = true;
      Logger.info('RoleViewComponent', 'å¼€å§‹åŠ è½½è§’è‰²æ•°æ®');

      Logger.info('RoleViewComponent', 'è§’è‰²æ•°æ®åŠ è½½å®Œæˆ');
    } catch (error) {
      Logger.error('RoleViewComponent', `åŠ è½½è§’è‰²æ•°æ®å¤±è´¥: ${error}`);
      this.roles = [];
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * è·å–å½“å‰åˆ†ç±»çš„è§’è‰²
   */
  private getFilteredRoles(): SystemPrompt[] {
    if (this.selectedCategory === 'all') {
      return this.roles;
    }
    return this.roles.filter(role => role.roleCategory === this.selectedCategory);
  }

  /**
   * è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
   */
  private getCategoryDisplayName(category: string): string {
    const categoryInfo = this.categories.find(c => c.id === category);
    return categoryInfo ? categoryInfo.name : category;
  }

  /**
   * é€‰æ‹©åˆ†ç±»
   */
  private onSelectCategory(categoryId: string): void {
    this.selectedCategory = categoryId;
    Logger.info('RoleViewComponent', `åˆ‡æ¢åˆ°åˆ†ç±»: ${categoryId}`);
  }

  /**
   * å¤„ç†è§’è‰²é€‰æ‹©
   */
  private onRoleSelected(role: SystemPrompt): void {
    Logger.info('RoleViewComponent', `é€‰æ‹©è§’è‰²: ${role.name}`);
    if (this.onRoleSelect) {
      this.onRoleSelect(role);
    }
  }

  
  build() {
    Column() {
      // æ ‡é¢˜
      Row() {
        Text('AI è§’è‰²åŠ©æ‰‹')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.isDarkMode ? '#FFFFFF' : '#333333')
          .layoutWeight(1);

        // åˆ·æ–°æŒ‰é’®
        Button('ğŸ”„')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor(this.isDarkMode ? '#CCCCCC' : '#666666')
          .borderRadius(16)
          .width(32)
          .height(32)
          .onClick(() => {
            this.loadRoles();
          });
      }
      .width('100%')
      .margin({ bottom: 16 });

      // åˆ†ç±»é€‰æ‹©å™¨
      Row() {
        Scroll() {
          Row() {
            ForEach(this.categories, (category: CategoryItem) => {
              Button() {
                Row() {
                  Text(category.icon)
                    .fontSize(14)
                    .margin({ right: 4 });
                  Text(category.name)
                    .fontSize(14)
                    .fontWeight(this.selectedCategory === category.id ? FontWeight.Medium : FontWeight.Normal);
                }
                .padding({ left: 12, right: 12, top: 6, bottom: 6 });
              }
              .backgroundColor(this.selectedCategory === category.id ? COMMON_CONSTANTS.THEME_COLORS.primary : Color.Transparent)
              .fontColor(this.selectedCategory === category.id ? Color.White : (this.isDarkMode ? '#CCCCCC' : '#666666'))
              .borderRadius(16)
              .onClick(() => {
                this.onSelectCategory(category.id);
              });
            });
          }
        }
        .scrollable(ScrollDirection.Horizontal)
      }
      .width('100%')
      .margin({ bottom: 16 });

      // è§’è‰²åˆ—è¡¨
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(24)
            .height(24);
          Text('åŠ è½½è§’è‰²ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 8 });
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center);
      } else {
        // è§’è‰²ç½‘æ ¼
        if (this.getFilteredRoles().length === 0) {
          // ç©ºçŠ¶æ€
          Column() {
            Text('ğŸ­')
              .fontSize(48)
              .margin({ bottom: 16 });
            Text(this.selectedCategory === 'all' ? 'æš‚æ— è§’è‰²' : `æš‚æ— ${this.getCategoryDisplayName(this.selectedCategory)}`)
              .fontSize(16)
              .fontColor('#999999')
              .margin({ bottom: 8 });
            Text('å¿«å»åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªAIè§’è‰²å§ï¼')
              .fontSize(14)
              .fontColor('#CCCCCC');
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center);
        } else {
          // è§’è‰²åˆ—è¡¨
          List() {
            ForEach(this.getFilteredRoles(), (role: SystemPrompt) => {
              ListItem() {
                RoleCardComponent({
                  role: role,
                  onRoleSelect: (selectedRole: SystemPrompt) => {
                    this.onRoleSelected(selectedRole);
                  }
                });
              }
              .padding({ bottom: 12 });
            });
          }
          .width('100%')
          .layoutWeight(1);
        }
      }
    }
    .padding(16)
    .backgroundColor(this.isDarkMode ? '#1E1E1E' : '#F8F9FA')
    .height('100%');
  }
}