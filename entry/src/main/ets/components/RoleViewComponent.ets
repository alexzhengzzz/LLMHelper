import { SystemPrompt } from '../models/ChatModels';
import { RoleCardComponent } from './RoleCardComponent';
import { RoleManager, RoleCategory } from '../utils/RoleManager';
import { Logger } from '../utils/Logger';
import { COMMON_CONSTANTS } from '../utils/Constants';

/**
 * è§’è‰²åˆ†ç±»æŽ¥å£
 */
interface CategoryItem {
  id: string;
  name: string;
  icon: string;
}

/**
 * è§’è‰²è§†å›¾ç»„ä»¶å±žæ€§
 */
interface RoleViewProps {
  appliedRoles?: SystemPrompt[]; // æ–°å¢žï¼šå·²åº”ç”¨è§’è‰²æ•°æ®
  onRoleSelect?: (role: SystemPrompt) => void;
  onRoleFilterRequest?: (role: SystemPrompt) => void;
  onRoleLongPress?: (role: SystemPrompt) => void; // æ–°å¢žï¼šé•¿æŒ‰å›žè°ƒ
}

/**
 * è§’è‰²è§†å›¾ç»„ä»¶ - æ˜¾ç¤ºè§’è‰²åˆ—è¡¨å’Œåˆ†ç±»
 */
@ComponentV2
export struct RoleViewComponent {
  @Param appliedRoles: SystemPrompt[] = []; // æ–°å¢žï¼šå·²åº”ç”¨è§’è‰²æ•°æ®
  @Param onRoleSelect: (role: SystemPrompt) => void = () => {};
  @Param onRoleFilterRequest: (role: SystemPrompt) => void = () => {};
  @Param onRoleLongPress: (role: SystemPrompt) => void = () => {}; // æ–°å¢žï¼šé•¿æŒ‰å›žè°ƒ
  @Local selectedCategory: string = 'all';
  @Local isLoading: boolean = true;
  @Local isDarkMode: boolean = false;

  // ç›´æŽ¥ä½¿ç”¨appliedRolesï¼Œä¸éœ€è¦ä¸­é—´å˜é‡
  private getDisplayRoles(): SystemPrompt[] {
    return this.appliedRoles;
  }
  private roleManager: RoleManager = RoleManager.getInstance();

  // åˆ†ç±»é€‰é¡¹ - ä¸Žè§’è‰²ç®¡ç†é¡µé¢ä¿æŒä¸€è‡´
  private readonly categories: CategoryItem[] = [
    { id: 'all', name: 'å…¨éƒ¨è§’è‰²', icon: 'ðŸŽ­' },
    { id: 'professional', name: 'ä¸“ä¸šè§’è‰²', icon: 'ðŸ’¼' },
    { id: 'character', name: 'äººç‰©è§’è‰²', icon: 'ðŸŽ­' },
    { id: 'custom', name: 'è‡ªå®šä¹‰è§’è‰²', icon: 'âš™ï¸' }
  ];

  aboutToAppear(): void {
    // åˆå§‹åŒ–çŠ¶æ€
    this.isLoading = false;
  }

  aboutToDisappear(): void {
    // æ¸…ç†èµ„æº
  }

  
  /**
   * èŽ·å–å½“å‰åˆ†ç±»çš„è§’è‰²
   */
  private getFilteredRoles(): SystemPrompt[] {
    const displayRoles = this.getDisplayRoles();
    if (this.selectedCategory === 'all') {
      return displayRoles;
    }
    return displayRoles.filter(role => role.roleCategory === this.selectedCategory);
  }

  /**
   * èŽ·å–åˆ†ç±»æ˜¾ç¤ºåç§°
   */
  private getCategoryDisplayName(category: string): string {
    const categoryInfo = this.categories.find(c => c.id === category);
    return categoryInfo ? categoryInfo.name : category;
  }

  /**
   * é€‰æ‹©åˆ†ç±»
   */
  private onSelectCategory(categoryId: string): void {
    this.selectedCategory = categoryId;
    Logger.info('RoleViewComponent', `åˆ‡æ¢åˆ°åˆ†ç±»: ${categoryId}`);
  }

  /**
   * å¤„ç†è§’è‰²é€‰æ‹©
   */
  private onRoleSelected(role: SystemPrompt): void {
    Logger.info('RoleViewComponent', `é€‰æ‹©è§’è‰²: ${role.name}`);
    if (this.onRoleSelect) {
      this.onRoleSelect(role);
    }
  }

  /**
   * å¤„ç†è§’è‰²ç­›é€‰è¯·æ±‚ï¼ˆæŸ¥çœ‹åŽ†å²ï¼‰
   */
  private onRoleFilterRequested(role: SystemPrompt): void {
    Logger.info('RoleViewComponent', `è¯·æ±‚æŸ¥çœ‹è§’è‰²åŽ†å²: ${role.name}`);
    if (this.onRoleFilterRequest) {
      this.onRoleFilterRequest(role);
    }
  }

  
  build() {
    Column() {
      // åˆ†ç±»é€‰æ‹©å™¨ - ä»…åœ¨æ˜¾ç¤ºæ‰€æœ‰è§’è‰²æ—¶æ˜¾ç¤ºï¼Œå·²åº”ç”¨è§’è‰²æ—¶ä¸æ˜¾ç¤º
      if (this.appliedRoles.length === 0) {
        Row() {
          Scroll() {
            Row() {
              ForEach(this.categories, (category: CategoryItem) => {
                Button() {
                  Row() {
                    Text(category.icon)
                      .fontSize(14)
                      .margin({ right: 4 });
                    Text(category.name)
                      .fontSize(14)
                      .fontWeight(this.selectedCategory === category.id ? FontWeight.Medium : FontWeight.Normal);
                  }
                  .padding({ left: 12, right: 12, top: 6, bottom: 6 });
                }
                .backgroundColor(this.selectedCategory === category.id ? COMMON_CONSTANTS.THEME_COLORS.primary : Color.Transparent)
                .fontColor(this.selectedCategory === category.id ? Color.White : (this.isDarkMode ? '#CCCCCC' : '#666666'))
                .borderRadius(16)
                .onClick(() => {
                  this.onSelectCategory(category.id);
                });
              });
            }
          }
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
        }
        .width('100%')
        .margin({ bottom: 16 });
      }

      // è§’è‰²åˆ—è¡¨
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(24)
            .height(24);
          Text('åŠ è½½è§’è‰²ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 8 });
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center);
      } else {
        // è§’è‰²ç½‘æ ¼
        if (this.getFilteredRoles().length === 0) {
          // ç©ºçŠ¶æ€
          Column() {
            Text('ðŸŽ­')
              .fontSize(48)
              .margin({ bottom: 16 });
            // ä¾§è¾¹æ æ¨¡å¼ï¼šæ˜¾ç¤ºå·²åº”ç”¨è§’è‰²ä¸ºç©º
            Text('æš‚æ— åº”ç”¨çš„è§’è‰²')
              .fontSize(16)
              .fontColor('#999999')
              .margin({ bottom: 8 });
            Text('åœ¨è§’è‰²ç®¡ç†é¡µé¢å°†è§’è‰²åº”ç”¨åˆ°ä¾§è¾¹æ ')
              .fontSize(14)
              .fontColor('#CCCCCC');
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center);
        } else {
          // è§’è‰²åˆ—è¡¨
          List() {
            ForEach(this.getFilteredRoles(), (role: SystemPrompt) => {
              ListItem() {
                RoleCardComponent({
                  role: role,
                  onRoleSelect: (selectedRole: SystemPrompt) => {
                    this.onRoleSelected(selectedRole);
                  },
                  onViewHistory: (selectedRole: SystemPrompt) => {
                    this.onRoleFilterRequested(selectedRole);
                  },
                  onRoleLongPress: (selectedRole: SystemPrompt) => {
                    this.onRoleLongPress(selectedRole);
                  }
                });
              }
              .padding({ bottom: 12 });
            });
          }
          .width('100%')
          .layoutWeight(1);
        }
      }
    }
    .padding(16)
    .backgroundColor(this.isDarkMode ? '#1E1E1E' : '#F8F9FA')
    .height('100%');
  }
}