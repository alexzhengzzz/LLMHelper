import { Session } from '../models/ChatModels';
import { curves } from '@kit.ArkUI';
import { Logger } from '../utils/Logger';
import { vibrator } from '@kit.SensorServiceKit';

interface SwipeAction {
  id: string;
  title: string;
  icon: string;
  color: string;
  backgroundColor: string;
  action: () => void;
}

@ComponentV2
export struct SwipeableSessionItemComponent {
  @Param @Require session: Session;
  @Param systemPromptName: string | null = null; // ç³»ç»Ÿæç¤ºè¯åç§°
  @Param @Require isCurrentSession: boolean;
  @Param @Require isLast: boolean;
  @Param @Require onSessionClick: (sessionId: string) => void;
  @Param @Require onDelete: (sessionId: string) => void;
  @Param onSwipeStart?: () => void = undefined; // æ»‘åŠ¨å¼€å§‹å›è°ƒ
  @Param onSwipeEnd?: () => void = undefined; // æ»‘åŠ¨ç»“æŸå›è°ƒ
  
  @Local swipeOffset: number = 0; // æ»‘åŠ¨åç§»é‡
  @Local isSwipeActive: boolean = false; // æ˜¯å¦å¤„äºæ»‘åŠ¨çŠ¶æ€
  @Local isDragging: boolean = false; // æ˜¯å¦æ­£åœ¨æ‹–æ‹½
  @Local hasTriggeredHaptic: boolean = false; // æ˜¯å¦å·²è§¦å‘è§¦è§‰åé¦ˆ
  @Local isProcessingClick: boolean = false; // é˜²æ­¢é‡å¤ç‚¹å‡»çŠ¶æ€
  @Local cachedBgColor: string = 'transparent'; // ç¼“å­˜çš„èƒŒæ™¯é¢œè‰²
  @Local cachedOpacity: number = 1.0; // ç¼“å­˜çš„é€æ˜åº¦
  
  private readonly DELETE_THRESHOLD = 120; // æ»‘åŠ¨åˆ é™¤é˜ˆå€¼
  private readonly ANIMATION_DURATION = 200; // åŠ¨ç”»æŒç»­æ—¶é—´
  private readonly CLICK_DEBOUNCE_TIME = 500; // ç‚¹å‡»é˜²æŠ–æ—¶é—´(ms)

  build() {
    // ä¼šè¯å†…å®¹å±‚ï¼ˆå¯æ»‘åŠ¨ï¼‰
      Column() {
        Row() {
          // ä¼šè¯å›¾æ ‡
          Text('ğŸ’¬')
            .fontSize(16)
            .margin({ right: 12 })

          // ä¼šè¯ä¿¡æ¯
          Column() {
            // ä¼šè¯åç§°
            Text(this.session.name)
              .fontSize(15)
              .fontWeight(this.isCurrentSession ? FontWeight.Medium : FontWeight.Normal)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .textAlign(TextAlign.Start)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            // ç³»ç»Ÿæç¤ºè¯æ˜¾ç¤º
            if (this.systemPromptName) {
              Text(`è§’è‰²: ${this.systemPromptName}`)
                .fontSize(11)
                .fontColor($r('app.color.primary_color'))
                .width('100%')
                .textAlign(TextAlign.Start)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .margin({ top: 2 })
            }

            // æ›´æ–°æ—¶é—´å’Œæ¶ˆæ¯æ•°
            Row() {
              Text(this.session.getFormattedTime())
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
              
              if (this.session.messageCount > 0) {
                Text(`Â·`)
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ left: 4, right: 4 })
                
                Text(`${this.session.messageCount}æ¡æ¶ˆæ¯`)
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
              }
            }
            .margin({ top: 2 })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

          // å½“å‰ä¼šè¯æ ‡è¯†
          if (this.isCurrentSession) {
            Circle({ width: 6, height: 6 })
              .fill('#4285F4')
          }
        }
        .width('100%')
        .height(56)
        .alignItems(VerticalAlign.Center)
        .padding({ left: 16, right: 16 })
        .backgroundColor(this.cachedBgColor)
        .borderRadius(8)

        // åˆ†å‰²çº¿
        if (!this.isLast) {
          Divider()
            .color($r('app.color.border_color'))
            .height(0.5)
            .margin({ left: 44, right: 16 })
        }
      }
      .width('100%')
      .backgroundColor($r('app.color.card_background'))
      .translate({ x: this.swipeOffset })
      .opacity(this.cachedOpacity)
      .animation({
        duration: this.isDragging ? 0 : this.ANIMATION_DURATION,
        curve: curves.springMotion(0.8, 0.9)
      })
      .onClick(() => {
        this.handleSessionClick();
      })
      .gesture(
        PanGesture({ fingers: 1, direction: PanDirection.Horizontal, distance: 5 })
          .onActionStart((event) => {
            this.handleSwipeStart(event);
          })
          .onActionUpdate((event) => {
            this.handleSwipeUpdate(event);
          })
          .onActionEnd((event) => {
            this.handleSwipeEnd(event);
          })
      )
    .width('100%')
    .height(this.isLast ? 56 : 64) // æ ¹æ®æ˜¯å¦ä¸ºæœ€åä¸€é¡¹è°ƒæ•´é«˜åº¦
    .clip(true)
  }

  /**
   * å¤„ç†ä¼šè¯ç‚¹å‡»äº‹ä»¶ï¼ˆå¸¦é˜²æŠ–å’ŒçŠ¶æ€æ£€æŸ¥ï¼‰
   */
  private handleSessionClick(): void {
    // å¦‚æœæ­£åœ¨æ‹–æ‹½æˆ–å¤„ç†ç‚¹å‡»ï¼Œå¿½ç•¥æ­¤æ¬¡ç‚¹å‡»
    if (this.isDragging || this.isProcessingClick) {
      Logger.debug('SwipeableSessionItem', 'å¿½ç•¥ç‚¹å‡»äº‹ä»¶ï¼šæ­£åœ¨æ‹–æ‹½æˆ–å¤„ç†ä¸­');
      return;
    }

    // å¦‚æœå­˜åœ¨æ»‘åŠ¨åç§»ï¼Œå…ˆé‡ç½®æ»‘åŠ¨çŠ¶æ€
    if (Math.abs(this.swipeOffset) > 0) {
      Logger.debug('SwipeableSessionItem', 'é‡ç½®æ»‘åŠ¨çŠ¶æ€åå†å¤„ç†ç‚¹å‡»');
      this.resetSwipe();
      return;
    }

    // è®¾ç½®å¤„ç†çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
    this.isProcessingClick = true;
    
    Logger.info('SwipeableSessionItem', `ç‚¹å‡»ä¼šè¯: ${this.session.name} (${this.session.id})`);
    
    // è°ƒç”¨å›è°ƒå‡½æ•°
    this.onSessionClick(this.session.id);
    
    // å»¶è¿Ÿé‡ç½®å¤„ç†çŠ¶æ€
    setTimeout(() => {
      this.isProcessingClick = false;
    }, this.CLICK_DEBOUNCE_TIME);
  }

  /**
   * å¼€å§‹æ»‘åŠ¨
   */
  private handleSwipeStart(event: GestureEvent): void {
    this.isDragging = true;
    this.hasTriggeredHaptic = false;
    this.cachedBgColor = 'transparent';
    this.cachedOpacity = 1.0;
    Logger.info('SwipeableSessionItem', `å¼€å§‹æ»‘åŠ¨ä¼šè¯: ${this.session.name}`);
    
    // é€šçŸ¥çˆ¶ç»„ä»¶å¼€å§‹æ»‘åŠ¨
    this.onSwipeStart?.();
  }

  /**
   * æ»‘åŠ¨æ›´æ–°
   */
  private handleSwipeUpdate(event: GestureEvent): void {
    if (!this.isDragging) return;

    const deltaX = event.offsetX;
    
    // åªå…è®¸å‘å·¦æ»‘åŠ¨
    if (deltaX >= 0) {
      this.swipeOffset = 0;
      this.isSwipeActive = false;
      this.cachedBgColor = 'transparent';
      this.cachedOpacity = 1.0;
      return;
    }

    // è®¡ç®—æ»‘åŠ¨è·ç¦»
    let swipeDistance = Math.abs(deltaX);
    
    // é™åˆ¶æœ€å¤§æ»‘åŠ¨è·ç¦»ï¼Œæ·»åŠ é˜»å°¼æ•ˆæœ
    if (swipeDistance > this.DELETE_THRESHOLD * 1.5) {
      const excess = swipeDistance - this.DELETE_THRESHOLD * 1.5;
      swipeDistance = this.DELETE_THRESHOLD * 1.5 + excess * 0.2;
    }
    
    // ä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºå‘å·¦æ»‘åŠ¨
    this.swipeOffset = -swipeDistance;
    
    // åˆ¤æ–­æ˜¯å¦æ¥è¿‘åˆ é™¤é˜ˆå€¼
    const wasActive = this.isSwipeActive;
    this.isSwipeActive = swipeDistance >= this.DELETE_THRESHOLD * 0.8;
    
    // æ›´æ–°ç¼“å­˜çš„èƒŒæ™¯é¢œè‰²å’Œé€æ˜åº¦
    this.updateCachedStyles(swipeDistance);
    
    // è§¦å‘è§¦è§‰åé¦ˆï¼ˆæ¥è¿‘åˆ é™¤é˜ˆå€¼æ—¶ï¼‰
    if (this.isSwipeActive && !wasActive && !this.hasTriggeredHaptic) {
      this.triggerHapticFeedback();
      this.hasTriggeredHaptic = true;
    }
  }

  /**
   * æ»‘åŠ¨ç»“æŸ
   */
  private handleSwipeEnd(event: GestureEvent): void {
    this.isDragging = false;
    
    const currentOffset = Math.abs(this.swipeOffset);
    
    if (currentOffset >= this.DELETE_THRESHOLD) {
      // è¶…è¿‡åˆ é™¤é˜ˆå€¼ï¼Œç›´æ¥åˆ é™¤ä¼šè¯
      Logger.info('SwipeableSessionItem', `æ»‘åŠ¨è·ç¦» ${currentOffset} è¶…è¿‡åˆ é™¤é˜ˆå€¼ ${this.DELETE_THRESHOLD}ï¼Œåˆ é™¤ä¼šè¯: ${this.session.name}`);
      this.triggerHapticFeedback();
      this.onDelete(this.session.id);
    } else {
      // æœªè¶…è¿‡é˜ˆå€¼ï¼Œå›å¼¹åˆ°åŸä½
      this.resetSwipe();
      Logger.info('SwipeableSessionItem', `æ»‘åŠ¨è·ç¦» ${currentOffset} æœªè¾¾åˆ°åˆ é™¤é˜ˆå€¼ï¼Œå›å¼¹åˆ°åŸä½`);
    }
    
    // é€šçŸ¥çˆ¶ç»„ä»¶æ»‘åŠ¨ç»“æŸ
    this.onSwipeEnd?.();
  }

  /**
   * æ›´æ–°ç¼“å­˜çš„æ ·å¼
   */
  private updateCachedStyles(swipeDistance: number): void {
    // è®¡ç®—æ»‘åŠ¨è¿›åº¦
    const swipeProgress = swipeDistance / this.DELETE_THRESHOLD;
    
    // æ›´æ–°èƒŒæ™¯é¢œè‰²
    if (this.isCurrentSession) {
      this.cachedBgColor = 'rgba(66, 133, 244, 0.1)';
    } else if (swipeProgress > 0.8) {
      const redIntensity = Math.min((swipeProgress - 0.8) * 5, 1) * 0.2;
      this.cachedBgColor = `rgba(255, 71, 87, ${redIntensity})`;
    } else {
      this.cachedBgColor = 'transparent';
    }
    
    // æ›´æ–°é€æ˜åº¦
    this.cachedOpacity = Math.max(1 - swipeProgress * 0.3, 0.7);
  }


  /**
   * é‡ç½®æ»‘åŠ¨çŠ¶æ€
   */
  public resetSwipe(): void {
    animateTo(
      {
        duration: this.ANIMATION_DURATION,
        curve: curves.springMotion(0.8, 0.9)
      },
      () => {
        this.swipeOffset = 0;
        this.isSwipeActive = false;
        this.cachedBgColor = this.isCurrentSession ? 'rgba(66, 133, 244, 0.1)' : 'transparent';
        this.cachedOpacity = 1.0;
      }
    );
  }

  /**
   * è·å–å½“å‰æ»‘åŠ¨çŠ¶æ€
   */
  public getSwipeState(): boolean {
    return this.isSwipeActive;
  }

  /**
   * è§¦å‘è§¦è§‰åé¦ˆ
   */
  private triggerHapticFeedback(): void {
    try {
      // æ£€æŸ¥æ˜¯å¦æ”¯æŒéœ‡åŠ¨
      vibrator.isSupportEffect('haptic.clock.timer').then((isSupported: boolean) => {
        if (isSupported) {
          vibrator.startVibration({
            type: 'time',
            duration: 15
          }, {
            id: 0,
            usage: 'notification'
          });
        }
      }).catch((err: Error) => {
        // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œç›´æ¥å°è¯•éœ‡åŠ¨
        vibrator.startVibration({
          type: 'time',
          duration: 15
        }, {
          id: 0,
          usage: 'notification'
        });
      });
    } catch (error) {
      Logger.warn('SwipeableSessionItem', `è§¦è§‰åé¦ˆå¤±è´¥: ${error}`);
    }
  }

  /**
   * å¼ºåˆ¶é‡ç½®æ‰€æœ‰çŠ¶æ€
   */
  public forceReset(): void {
    this.swipeOffset = 0;
    this.isSwipeActive = false;
    this.isDragging = false;
    this.hasTriggeredHaptic = false;
    this.isProcessingClick = false;
    this.cachedBgColor = this.isCurrentSession ? 'rgba(66, 133, 244, 0.1)' : 'transparent';
    this.cachedOpacity = 1.0;
  }

  /**
   * è·å–èƒŒæ™¯é¢œè‰²
   */
  private getBackgroundColor(): string {
    if (this.isCurrentSession) {
      return 'rgba(66, 133, 244, 0.1)';
    }
    
    // æ»‘åŠ¨æ—¶æ¸å˜ä¸ºçº¢è‰²èƒŒæ™¯ï¼Œæç¤ºå³å°†åˆ é™¤
    const swipeProgress = Math.abs(this.swipeOffset) / this.DELETE_THRESHOLD;
    if (swipeProgress > 0.8) {
      const redIntensity = Math.min((swipeProgress - 0.8) * 5, 1) * 0.2;
      return `rgba(255, 71, 87, ${redIntensity})`;
    }
    
    return 'transparent';
  }

  /**
   * è·å–å†…å®¹é€æ˜åº¦
   */
  private getContentOpacity(): number {
    // æ»‘åŠ¨æ—¶é™ä½é€æ˜åº¦ï¼Œæç¤ºå³å°†åˆ é™¤
    const swipeProgress = Math.abs(this.swipeOffset) / this.DELETE_THRESHOLD;
    return Math.max(1 - swipeProgress * 0.3, 0.7);
  }
}