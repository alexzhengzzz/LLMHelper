/**
 * æ·±åº¦æ€è€ƒè¿‡ç¨‹å¯è§†åŒ–ç»„ä»¶
 */

import { ThinkingStep, ThinkingStatus, StepStatus } from '../models/ChatModels';

// æ€è€ƒè¿‡ç¨‹å±•ç¤ºå‚æ•°
@ObservedV2
class ThinkingProcessParams {
  @Trace thinkingSteps: ThinkingStep[] = [];
  @Trace thinkingStatus: ThinkingStatus = ThinkingStatus.IDLE;
  @Trace showDetails: boolean = true;
  @Trace compact: boolean = false;
}

@ComponentV2
export struct ThinkingProcessComponent {
  @Param @Require thinkingSteps: ThinkingStep[];
  @Param @Require thinkingStatus: ThinkingStatus;
  @Param showDetails: boolean = true;
  @Param compact: boolean = false;
  @Param onStepTap: (step: ThinkingStep) => void = () => {};

  @Local expandedSteps: Set<string> = new Set();

  build() {
    Column({ space: this.compact ? 8 : 12 }) {
      if (this.thinkingSteps.length === 0) {
        Blank();
      } else {
      // æ•´ä½“çŠ¶æ€æŒ‡ç¤ºå™¨
      this.buildOverallStatus()
      
      // æ­¥éª¤åˆ—è¡¨
      ForEach(this.thinkingSteps, (step: ThinkingStep, index: number) => {
        this.buildStepItem(step, index)
      })
      
      // åº•éƒ¨è¿›åº¦ä¿¡æ¯
      if (!this.compact) {
        this.buildProgressInfo()
      }
      }
    }
    .width('100%')
    .padding({ 
      left: this.compact ? 8 : 12, 
      right: this.compact ? 8 : 12, 
      top: 8, 
      bottom: 8 
    })
    .backgroundColor('#F8F9FF')
    .borderRadius(this.compact ? 6 : 8)
    .border({
      width: 1,
      color: this.getBorderColor()
    })
  }

  @Builder
  private buildOverallStatus() {
    Row({ space: 8 }) {
      // çŠ¶æ€å›¾æ ‡
      Text(this.getStatusIcon())
        .fontSize(this.compact ? 14 : 16)
        .animation({ duration: 600, curve: Curve.EaseInOut })
      
      // çŠ¶æ€æ–‡å­—
      Text(this.getStatusText())
        .fontSize(this.compact ? 12 : 14)
        .fontColor('#2D3142')
        .fontWeight(500)
      
      Blank()
      
      // æ€»ä½“è¿›åº¦
      if (this.thinkingStatus !== ThinkingStatus.IDLE) {
        Text(this.getProgressText())
          .fontSize(this.compact ? 10 : 12)
          .fontColor('#666')
      }
    }
    .width('100%')
    .height(this.compact ? 28 : 32)
  }

  @Builder
  private buildStepItem(step: ThinkingStep, index: number) {
    Column({ space: 6 }) {
      // æ­¥éª¤æ ‡é¢˜è¡Œ
      Row({ space: 8 }) {
        // æ­¥éª¤åºå·å’ŒçŠ¶æ€å›¾æ ‡
        Row({ space: 4 }) {
          Text(`${index + 1}`)
            .fontSize(this.compact ? 10 : 12)
            .fontColor('#fff')
            .width(this.compact ? 16 : 20)
            .height(this.compact ? 16 : 20)
            .textAlign(TextAlign.Center)
            .backgroundColor(this.getStepColor(step.status))
            .borderRadius(this.compact ? 8 : 10)
            .scale({
              x: step.status === StepStatus.PROCESSING ? 1.1 : 1.0,
              y: step.status === StepStatus.PROCESSING ? 1.1 : 1.0
            })
            .animation({
              duration: 800,
              curve: Curve.EaseInOut,
              iterations: -1
            })
          
          Text(this.getStepStatusIcon(step.status))
            .fontSize(this.compact ? 12 : 14)
            .animation({ duration: 500, curve: Curve.EaseInOut })
        }
        
        // æ­¥éª¤æ ‡é¢˜
        Text(step.title)
          .fontSize(this.compact ? 12 : 14)
          .fontColor('#2D3142')
          .fontWeight(500)
          .flexGrow(1)
        
        // è€—æ—¶ä¿¡æ¯
        if (step.duration) {
          Text(`${(step.duration / 1000).toFixed(1)}s`)
            .fontSize(this.compact ? 10 : 11)
            .fontColor('#999')
        }
        
        // å±•å¼€/æŠ˜å æŒ‰é’®
        if (this.showDetails && step.content && !this.compact) {
          Text(this.expandedSteps.has(step.id) ? 'ğŸ“–' : 'ğŸ“‘')
            .fontSize(12)
            .padding(4)
            .onClick(() => this.toggleStepExpansion(step.id))
        }
      }
      .width('100%')
      .onClick(() => {
        if (this.onStepTap) {
          this.onStepTap(step);
        } else if (this.showDetails && step.content) {
          this.toggleStepExpansion(step.id);
        }
      })
      
      // æ­¥éª¤æè¿°
      if (!this.compact) {
        Text(step.description)
          .fontSize(11)
          .fontColor('#666')
          .margin({ left: 28 })
      }
      
      // æ­¥éª¤å†…å®¹ï¼ˆå¯å±•å¼€ï¼‰
      if (this.showDetails && step.content && this.expandedSteps.has(step.id) && !this.compact) {
        this.buildStepContent(step)
      }
      
      // é”™è¯¯ä¿¡æ¯
      if (step.error && step.status === StepStatus.FAILED) {
        this.buildErrorInfo(step.error)
      }
    }
    .width('100%')
    .padding({ 
      left: this.compact ? 6 : 8, 
      right: this.compact ? 6 : 8, 
      top: this.compact ? 4 : 6, 
      bottom: this.compact ? 4 : 6 
    })
    .backgroundColor('#fff')
    .borderRadius(this.compact ? 4 : 6)
    .border({
      width: 1,
      color: step.status === StepStatus.PROCESSING ? '#4A90E2' : '#E5E7EB'
    })
  }

  @Builder
  private buildStepContent(step: ThinkingStep) {
    Column({ space: 4 }) {
      Divider()
        .color('#E5E7EB')
        .margin({ left: 28, right: 8 })
      
      Text(step.content)
        .fontSize(12)
        .fontColor('#374151')
        .lineHeight(18)
        .margin({ left: 28, right: 8, top: 4, bottom: 4 })
        .maxLines(this.compact ? 3 : -1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
  }

  @Builder
  private buildErrorInfo(error: string) {
    Row({ space: 6 }) {
      Text('âš ï¸')
        .fontSize(12)
      
      Text(error)
        .fontSize(11)
        .fontColor('#DC2626')
        .flexGrow(1)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .padding(8)
    .margin({ left: 28 })
    .backgroundColor('#FEF2F2')
    .borderRadius(4)
    .border({
      width: 1,
      color: '#FECACA'
    })
  }

  @Builder
  private buildProgressInfo() {
    if (this.thinkingStatus !== ThinkingStatus.IDLE && this.thinkingStatus !== ThinkingStatus.COMPLETED) {
      Row({ space: 8 }) {
      // è¿›åº¦æ¡
      Row() {
        ForEach(this.thinkingSteps, (step: ThinkingStep, index: number) => {
          Row()
            .width(20)
            .height(3)
            .backgroundColor(this.getProgressBarColor(step.status))
            .borderRadius(1.5)
            .margin({ right: index < this.thinkingSteps.length - 1 ? 2 : 0 })
        })
      }
      .flexGrow(1)
      
      // è¿›åº¦æ–‡å­—
      Text(this.getDetailedProgressText())
        .fontSize(10)
        .fontColor('#666')
      }
      .width('100%')
      .padding({ top: 4 })
    }
  }

  // å·¥å…·æ–¹æ³•
  private getStatusIcon(): string {
    switch (this.thinkingStatus) {
      case ThinkingStatus.PLANNING: return 'ğŸ—ºï¸';
      case ThinkingStatus.ANALYZING: return 'ğŸ”';
      case ThinkingStatus.RESEARCHING: return 'ğŸŒ';
      case ThinkingStatus.THINKING: return 'ğŸ§ ';
      case ThinkingStatus.VERIFYING: return 'âœ…';
      case ThinkingStatus.INTEGRATING: return 'ğŸ¯';
      case ThinkingStatus.REFINING: return 'ğŸ”';
      case ThinkingStatus.COMPLETED: return 'âœ¨';
      case ThinkingStatus.FAILED: return 'âŒ';
      case ThinkingStatus.CANCELLED: return 'â¹ï¸';
      default: return 'ğŸ’­';
    }
  }

  private getStatusText(): string {
    switch (this.thinkingStatus) {
      case ThinkingStatus.PLANNING: return 'æ­£åœ¨è§„åˆ’æ¨ç†è·¯å¾„...';
      case ThinkingStatus.ANALYZING: return 'æ·±åº¦åˆ†æä¸­...';
      case ThinkingStatus.RESEARCHING: return 'èµ„æ–™æ£€ç´¢ä¸­...';
      case ThinkingStatus.THINKING: return 'å¤šè§’åº¦æ€è€ƒä¸­...';
      case ThinkingStatus.VERIFYING: return 'æ‰¹åˆ¤æ€§éªŒè¯ä¸­...';
      case ThinkingStatus.INTEGRATING: return 'ç»¼åˆæ•´åˆä¸­...';
      case ThinkingStatus.REFINING: return 'è´¨é‡å¤ç›˜ä¸­...';
      case ThinkingStatus.COMPLETED: return 'æ·±åº¦æ€è€ƒå®Œæˆ';
      case ThinkingStatus.FAILED: return 'æ€è€ƒè¿‡ç¨‹å¤±è´¥';
      case ThinkingStatus.CANCELLED: return 'æ€è€ƒè¿‡ç¨‹å·²å–æ¶ˆ';
      default: return 'æ·±åº¦æ€è€ƒå‡†å¤‡ä¸­';
    }
  }

  private getBorderColor(): string {
    switch (this.thinkingStatus) {
      case ThinkingStatus.PLANNING:
      case ThinkingStatus.ANALYZING:
      case ThinkingStatus.RESEARCHING:
      case ThinkingStatus.THINKING:
      case ThinkingStatus.VERIFYING:
      case ThinkingStatus.INTEGRATING:
      case ThinkingStatus.REFINING:
        return '#4A90E2';
      case ThinkingStatus.COMPLETED:
        return '#10B981';
      case ThinkingStatus.FAILED:
        return '#DC2626';
      case ThinkingStatus.CANCELLED:
        return '#6B7280';
      default:
        return '#E5E7EB';
    }
  }

  private getStepStatusIcon(status: StepStatus): string {
    switch (status) {
      case StepStatus.PENDING: return 'â³';
      case StepStatus.PROCESSING: return 'âš¡';
      case StepStatus.COMPLETED: return 'âœ…';
      case StepStatus.FAILED: return 'âŒ';
      default: return 'â³';
    }
  }

  private getStepColor(status: StepStatus): string {
    switch (status) {
      case StepStatus.PENDING: return '#9CA3AF';
      case StepStatus.PROCESSING: return '#4A90E2';
      case StepStatus.COMPLETED: return '#10B981';
      case StepStatus.FAILED: return '#DC2626';
      default: return '#9CA3AF';
    }
  }

  private getProgressBarColor(status: StepStatus): string {
    switch (status) {
      case StepStatus.COMPLETED: return '#10B981';
      case StepStatus.PROCESSING: return '#4A90E2';
      case StepStatus.FAILED: return '#DC2626';
      default: return '#E5E7EB';
    }
  }

  private getProgressText(): string {
    const completed = this.thinkingSteps.filter(s => s.status === StepStatus.COMPLETED).length;
    const total = this.thinkingSteps.length;
    return `${completed}/${total}`;
  }

  private getDetailedProgressText(): string {
    const completed = this.thinkingSteps.filter(s => s.status === StepStatus.COMPLETED).length;
    const processing = this.thinkingSteps.filter(s => s.status === StepStatus.PROCESSING).length;
    const failed = this.thinkingSteps.filter(s => s.status === StepStatus.FAILED).length;
    const total = this.thinkingSteps.length;
    
    if (failed > 0) {
      return `å·²å®Œæˆ ${completed}/${total}ï¼Œå¤±è´¥ ${failed} ä¸ª`;
    } else if (processing > 0) {
      return `å·²å®Œæˆ ${completed}/${total}ï¼Œè¿›è¡Œä¸­ ${processing} ä¸ª`;
    } else {
      return `å·²å®Œæˆ ${completed}/${total}`;
    }
  }

  private toggleStepExpansion(stepId: string): void {
    if (this.expandedSteps.has(stepId)) {
      this.expandedSteps.delete(stepId);
    } else {
      this.expandedSteps.add(stepId);
    }
    // è§¦å‘é‡æ–°æ¸²æŸ“
    this.expandedSteps = new Set(this.expandedSteps);
  }
}
