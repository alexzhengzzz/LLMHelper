import { router } from '@kit.ArkUI';
import { curves } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { ThemeManager } from '../utils/ThemeManager';
import { AvatarSettings, UserProfile, AppStorage as StorageManager } from '../utils/AppStorage';
import { UserProfileManager } from '../utils/UserProfileManager';
import { Constants } from '../utils/Constants';
import { Logger } from '../utils/Logger';
import { Session, SystemPrompt } from '../models/ChatModels';
import { ChatViewModel } from '../viewmodels/ChatViewModel';
import { SwipeableSessionItemComponent } from './SwipeableSessionItemComponent';
import { NewSessionDialogComponent } from './NewSessionDialogComponent';
import { RoleViewComponent } from './RoleViewComponent';
import { AppConfigManager } from '../utils/AppConfigManager';

interface AvatarOption {
  text: string;
  value: string;
}

interface MenuItem {
  id: string;
  title: string;
  subtitle: string;
  icon: string;
  iconColor: string;
  action: () => void;
}

interface MenuSection {
  title: string;
  items: MenuItem[];
}

@ComponentV2
export struct SideDrawerComponent {
  @Param @Require onClose: () => void;
  @Param @Require onSessionSwitched?: () => void; // ä¼šè¯åˆ‡æ¢æˆåŠŸåçš„å›è°ƒ
  @Param chatViewModel: ChatViewModel | null = null;
  @Param sessions: Session[] = []; // ä¼šè¯åˆ—è¡¨ï¼Œå•ç‹¬ä¼ é€’ä»¥ç¡®ä¿å“åº”å¼æ›´æ–°
  @Param systemPrompts: SystemPrompt[] = []; // ç³»ç»Ÿæç¤ºè¯åˆ—è¡¨ï¼Œç”¨äºæ˜¾ç¤ºä¼šè¯ç»‘å®šçš„æç¤ºè¯
  @Param swipeProgress: number = 0; // å¤–éƒ¨æ»‘åŠ¨è¿›åº¦ (0-1)
  @Param isSwipeActive: boolean = false; // æ˜¯å¦æ­£åœ¨æ»‘åŠ¨
  @Param onSessionSwipeStateChange?: (isSwiping: boolean) => void = undefined; // ä¼šè¯é¡¹æ»‘åŠ¨çŠ¶æ€å˜åŒ–å›è°ƒ
  @Local isDarkMode: boolean = false;
  @Local userAvatarType: 'default' | 'emoji' | 'image' = 'default';
  @Local userAvatarValue: string = '#4285F4';
  @Local aiAvatarType: 'default' | 'emoji' | 'image' = 'default';
  @Local aiAvatarValue: string = '#34A853';
  @Local userName: string = 'Javisç”¨æˆ·';
  @Local userSignature: string = 'è®©AIæˆä¸ºä½ çš„ç¼–ç¨‹ä¼™ä¼´';
  @Local showRenameDialog: boolean = false;
  @Local renameSessionId: string = '';
  @Local renameText: string = '';
  @Local drawerVisible: boolean = false; // æŠ½å±‰å¯è§çŠ¶æ€
  @Local animationProgress: number = 0; // èœå•æ»‘åŠ¨åŠ¨ç”»è¿›åº¦ (0-1)
  @Local maskOpacity: number = 0; // é®ç½©å±‚é€æ˜åº¦ (0-1)ï¼Œç‹¬ç«‹æ§åˆ¶
  @Local showNewSessionDialog: boolean = false; // æ–°å¢ï¼šæ–°å»ºä¼šè¯å¯¹è¯æ¡†çŠ¶æ€
  @Local isSessionItemSwiping: boolean = false; // ä¼šè¯é¡¹æ­£åœ¨æ»‘åŠ¨çŠ¶æ€
  @Local isExiting: boolean = false; // æ˜¯å¦æ­£åœ¨æ‰§è¡Œé€€å‡ºåŠ¨ç”»
  @Local activeTab: 'sessions' | 'roles' = 'sessions'; // æ´»è·ƒæ ‡ç­¾é¡µï¼šä¼šè¯æˆ–è§’è‰²
  @Local globalSearchQuery: string = ''; // å…¨å±€æœç´¢å…³é”®è¯
  @Local filteredSessions: Session[] = []; // æœç´¢è¿‡æ»¤åçš„ä¼šè¯åˆ—è¡¨
  @Local selectedRoleFilter: SystemPrompt | null = null; // é€‰ä¸­çš„è§’è‰²ç­›é€‰å™¨
  @Local showRoleFilter: boolean = false; // æ˜¯å¦æ˜¾ç¤ºè§’è‰²ç­›é€‰å™¨
  
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private userProfileManager: UserProfileManager = UserProfileManager.getInstance();
  private swipeableItemRefs: Map<string, SwipeableSessionItemComponent> = new Map(); // ä¾§æ»‘ç»„ä»¶å¼•ç”¨
  private debounceTimer: number = 0; // é˜²æŠ–å®šæ—¶å™¨
  private readonly DEBOUNCE_DELAY = 300; // é˜²æŠ–å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  private avatarListener: (settings: AvatarSettings) => void = (settings: AvatarSettings) => {
    this.userAvatarType = settings.userAvatarType;
    this.userAvatarValue = settings.userAvatarValue;
    this.aiAvatarType = settings.aiAvatarType;
    this.aiAvatarValue = settings.aiAvatarValue;
    Logger.info('SideDrawerComponent', 'å¤´åƒè®¾ç½®å·²æ›´æ–°');
  };
  private userProfileListener: (profile: UserProfile) => void = (profile: UserProfile) => {
    this.userName = profile.userName;
    this.userSignature = profile.userSignature;
    this.userAvatarType = profile.userAvatarType;
    this.userAvatarValue = profile.userAvatarValue;
    Logger.info('SideDrawerComponent', 'ç”¨æˆ·èµ„æ–™å·²æ›´æ–°');
  };

  async aboutToAppear(): Promise<void> {
    this.isDarkMode = this.themeManager.getDarkMode();
    
    // åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™ç®¡ç†å™¨
    try {
      await this.userProfileManager.initialize();
      const currentProfile = this.userProfileManager.getCurrentProfile();
      if (currentProfile) {
        this.userName = currentProfile.userName;
        this.userSignature = currentProfile.userSignature;
        this.userAvatarType = currentProfile.userAvatarType;
        this.userAvatarValue = currentProfile.userAvatarValue;
        Logger.info('SideDrawerComponent', `ç”¨æˆ·èµ„æ–™åŠ è½½æˆåŠŸ: ${this.userName}`);
      }
    } catch (error) {
      Logger.error('SideDrawerComponent', `åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™ç®¡ç†å™¨å¤±è´¥: ${error}`);
    }
    
    // åŠ è½½AIå¤´åƒè®¾ç½®
    try {
      const avatarSettings = await StorageManager.getAvatarSettings();
      this.aiAvatarType = avatarSettings.aiAvatarType;
      this.aiAvatarValue = avatarSettings.aiAvatarValue;
      Logger.info('SideDrawerComponent', `AIå¤´åƒè®¾ç½®åŠ è½½æˆåŠŸ: ${JSON.stringify(avatarSettings)}`);
    } catch (error) {
      Logger.error('SideDrawerComponent', `åŠ è½½AIå¤´åƒè®¾ç½®å¤±è´¥: ${error}`);
    }
    
    // æ·»åŠ ç”¨æˆ·èµ„æ–™ç›‘å¬å™¨
    this.userProfileManager.addProfileListener(this.userProfileListener);
    
    // æ·»åŠ å¤´åƒè®¾ç½®ç›‘å¬å™¨ï¼ˆä»…ç”¨äºAIå¤´åƒï¼‰
    StorageManager.addAvatarListener(this.avatarListener);
    
    // æ·»åŠ ä¼šè¯æ•°æ®æ¸…é™¤ç›‘å¬å™¨
    StorageManager.addSessionDataClearedListener(() => this.onSessionDataCleared());
    
    // å¯åŠ¨è¿›å…¥åŠ¨ç”»
    this.startEnterAnimation();

    // åˆå§‹åŒ–è¿‡æ»¤åçš„ä¼šè¯åˆ—è¡¨
    this.filteredSessions = [...this.sessions];
  }

  /**
   * å¯åŠ¨è¿›å…¥åŠ¨ç”»
   */
  private startEnterAnimation(): void {
    // å…ˆæ˜¾ç¤ºæŠ½å±‰
    this.drawerVisible = true;
    
    // å¦‚æœæ­£åœ¨å¤–éƒ¨æ»‘åŠ¨ï¼Œä¸æ‰§è¡ŒåŠ¨ç”»ï¼Œç›´æ¥è®¾ç½®çŠ¶æ€
    if (this.isSwipeActive) {
      this.maskOpacity = Math.max(0.3, this.swipeProgress * 0.5);
      this.animationProgress = this.swipeProgress;
      Logger.debug('SideDrawerComponent', 'æ»‘åŠ¨æ¿€æ´»çŠ¶æ€ï¼Œè·³è¿‡è¿›å…¥åŠ¨ç”»');
      return;
    }
    
    // å»¶è¿Ÿä¸€å¸§åå¼€å§‹åŠ¨ç”»
    setTimeout(() => {
      // é®ç½©å±‚åŠ¨ç”»
      animateTo(
        {
          duration: 300,
          curve: curves.springMotion(0.8, 0.9),
          iterations: 1,
          playMode: PlayMode.Normal
        },
        () => {
          this.maskOpacity = 1;
        }
      );
      
      // èœå•æ»‘å…¥åŠ¨ç”»ï¼ˆç¨å¾®å»¶è¿Ÿï¼‰
      setTimeout(() => {
        animateTo(
          {
            duration: 300,
            curve: curves.springMotion(0.8, 0.9), // å¼¹æ€§é€€å‡ºæ›²çº¿
            iterations: 1,
            playMode: PlayMode.Normal
          },
          () => {
            this.animationProgress = 1;
          }
        );
      }, 50);
    }, 16);
  }

  /**
   * å¯åŠ¨é€€å‡ºåŠ¨ç”»
   */
  private startExitAnimation(callback?: () => void): void {
    // å§‹ç»ˆæ‰§è¡Œå¹³æ»‘çš„å¸¸è§„é€€å‡ºåŠ¨ç”»
    // ä¸å†åŒºåˆ†æ»‘åŠ¨çŠ¶æ€ï¼Œç¡®ä¿æ‰€æœ‰å…³é—­æ“ä½œéƒ½æœ‰æµç•…çš„åŠ¨ç”»
    Logger.debug('SideDrawerComponent', 'æ‰§è¡Œé€€å‡ºåŠ¨ç”»');

    // æ ‡è®°è¿›å…¥é€€å‡ºåŠ¨ç”»çŠ¶æ€
    this.isExiting = true;
    
    // èœå•æ»‘å‡ºåŠ¨ç”»
    this.animationProgress = 1;
    animateTo(
      {
        duration: 300,
        curve: curves.springMotion(0.75, 0.85),
        iterations: 1,
        playMode: PlayMode.Normal,
        onFinish: () => {
          this.drawerVisible = false;
          this.isExiting = false; // é€€å‡ºåŠ¨ç”»å®Œæˆ
          callback?.();
        }
      },
      () => {
        this.animationProgress = 0;
      }
    );
  }

  /**
   * å…³é—­æŠ½å±‰ï¼ˆå¸¦åŠ¨ç”»ï¼‰
   */
  private closeDrawer(): void {
    // å¦‚æœæ­£åœ¨æ»‘åŠ¨ï¼Œç«‹å³åœæ­¢æ»‘åŠ¨çŠ¶æ€
    if (this.isSwipeActive) {
      Logger.debug('SideDrawerComponent', 'å¼ºåˆ¶ç»“æŸæ»‘åŠ¨çŠ¶æ€ï¼Œæ‰§è¡Œå…³é—­åŠ¨ç”»');
    }
    
    this.startExitAnimation(() => {
      this.onClose();
    });
  }

  aboutToDisappear(): void {
    // æ¸…ç†é˜²æŠ–å®šæ—¶å™¨
    if (this.debounceTimer) {
      clearTimeout(this.debounceTimer);
      this.debounceTimer = 0;
    }

    // ç§»é™¤ç”¨æˆ·èµ„æ–™ç›‘å¬å™¨
    this.userProfileManager.removeProfileListener(this.userProfileListener);

    // ç§»é™¤å¤´åƒè®¾ç½®ç›‘å¬å™¨
    StorageManager.removeAvatarListener(this.avatarListener);

    // ç§»é™¤ä¼šè¯æ•°æ®æ¸…é™¤ç›‘å¬å™¨
    // æ³¨æ„ï¼šç”±äºä½¿ç”¨äº†ç®­å¤´å‡½æ•°ï¼Œè¿™é‡Œç§»é™¤ç›‘å¬å™¨éœ€è¦ä¿å­˜å¼•ç”¨
    // åœ¨å½“å‰å®ç°ä¸­ï¼Œç›‘å¬å™¨ä¼šåœ¨é¡µé¢é”€æ¯æ—¶è‡ªåŠ¨æ¸…ç†
  }

  /**
   * å¤„ç†ä¼šè¯æ•°æ®æ¸…é™¤äº‹ä»¶
   */
  private onSessionDataCleared(): void {
    Logger.info('SideDrawerComponent', 'æ”¶åˆ°ä¼šè¯æ•°æ®æ¸…é™¤é€šçŸ¥ï¼Œå…³é—­ä¾§è¾¹èœå•');
    
    // å…³é—­ä¾§è¾¹èœå•
    this.startExitAnimation(() => {
      this.onClose();
    });
  }

  private get menuSections(): MenuSection[] {
    return [
      {
        title: 'åŠŸèƒ½',
        items: [
          {
            id: 'memory',
            title: 'è®°å¿†ä¸­å¿ƒ',
            subtitle: 'ç®¡ç†AIè®°å¿†å’ŒçŸ¥è¯†',
            icon: 'ğŸ§ ',
            iconColor: '#E74C3C',
            action: () => {
              this.navigateToMemoryManager();
            }
          }
        ]
      },
      {
        title: 'è®¾ç½®',
        items: [
          {
            id: 'settings',
            title: 'è®¾ç½®',
            subtitle: 'åº”ç”¨è®¾ç½®å’Œåå¥½',
            icon: 'âš™ï¸',
            iconColor: '#8E44AD',
            action: () => {
              this.navigateToSettings();
            }
          }
        ]
      }
    ];
  }

  build() {
    Stack() {
      // ä¾§è¾¹æŠ½å±‰ä¸»å†…å®¹
      Row() {
        // æŠ½å±‰å†…å®¹
        Column() {
          // å¤´éƒ¨
          this.buildHeader()

          // ä¸»å†…å®¹åŒºåŸŸ - ä¼šè¯åˆ—è¡¨æˆ–è§’è‰²åˆ—è¡¨
          this.buildMainContentSection()
        }
        .width(280)
        .height('100%')
        .backgroundColor($r('app.color.surface_color'))
        .borderRadius({ topRight: 16, bottomRight: 16 })
        .shadow({
          radius: 32,
          color: 'rgba(0, 0, 0, 0.2)',
          offsetX: 8,
          offsetY: 0
        })
        
        // å³ä¾§èƒŒæ™¯é®ç½©åŒºåŸŸï¼ˆå¯ç‚¹å‡»å…³é—­ï¼‰
        Column()
          .layoutWeight(1)
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0)')
          .opacity(Math.max(this.maskOpacity, this.swipeProgress * 0.5))
          .onClick(() => {
            this.closeDrawer();
          })
      }
      .width('100%')
      .height('100%')
      .alignItems(VerticalAlign.Top)
      .justifyContent(FlexAlign.Start)
      .translate({ 
        x: -280 * (1 - (this.isExiting ? this.animationProgress : Math.max(this.animationProgress, this.swipeProgress))) 
      }) // é€€å‡ºåŠ¨ç”»æœŸé—´ä¼˜å…ˆä½¿ç”¨å†…éƒ¨animationProgressï¼Œé¿å…å¤–éƒ¨çŠ¶æ€å¹²æ‰°
      .visibility(this.drawerVisible ? Visibility.Visible : Visibility.Hidden)

      // é‡å‘½åå¯¹è¯æ¡†ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰
      if (this.showRenameDialog) {
        Column() {
          this.buildRenameDialog()
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('rgba(0, 0, 0, 0.3)')
        .onClick(() => {
          // ç‚¹å‡»èƒŒæ™¯å…³é—­å¯¹è¯æ¡†
          this.cancelRename();
        })
      }
      
      // æ–°å»ºä¼šè¯å¯¹è¯æ¡†ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰
      if (this.showNewSessionDialog) {
        Stack() {
          // èƒŒæ™¯é®ç½©
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .onClick(() => {
              this.cancelNewSession();
            })

          // å¯¹è¯æ¡†
          NewSessionDialogComponent({
            systemPrompts: this.chatViewModel?.systemPrompts || [],
            onConfirm: (prompt) => this.confirmNewSession(prompt),
            onCancel: () => this.cancelNewSession()
          })
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(2000) // æé«˜z-indexç¡®ä¿åœ¨æœ€ä¸Šå±‚
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildHeader() {
    Column() {
      // ç”¨æˆ·èµ„æ–™åŒºåŸŸ
      Column() {
        // ç”¨æˆ·å¤´åƒ
        Column() {
          this.buildUserAvatar()
        }
        .margin({ bottom: 12 })

        // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼ˆå¯ç‚¹å‡»ç¼–è¾‘ï¼‰
        Column() {
          // ç”¨æˆ·åå­—
          Text(this.userName)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .margin({ bottom: 4 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // ä¸ªæ€§ç­¾å
          Text(this.userSignature)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ bottom: 16 })
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.navigateToProfileEdit();
        })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)

    }
    .width('100%')
    .padding({ top: 48, left: 24, right: 24 })
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildUserAvatar() {
    if (this.userAvatarType === 'emoji') {
      Text(this.userAvatarValue)
        .fontSize(32)
        .width(64)
        .height(64)
        .textAlign(TextAlign.Center)
        .border({ width: 2, color: $r('app.color.border_color'), radius: 32 })
        .backgroundColor($r('app.color.surface_color'))
        .onClick(() => {
          this.navigateToProfileEdit();
        })
    } else if (this.userAvatarType === 'image') {
      Image(this.userAvatarValue)
        .width(64)
        .height(64)
        .borderRadius(32)
        .border({ width: 2, color: $r('app.color.border_color') })
        .objectFit(ImageFit.Cover)
        .onError(() => {
          // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
          Logger.warn('SideDrawerComponent', 'ç”¨æˆ·å¤´åƒå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ');
        })
        .onClick(() => {
          this.navigateToProfileEdit();
        })
    } else {
      Circle({ width: 64, height: 64 })
        .fill(this.userAvatarValue)
        .border({ width: 2, color: $r('app.color.border_color') })
        .onClick(() => {
          this.navigateToProfileEdit();
        })
    }
  }

  @Builder
  buildMenuSection(section: MenuSection) {
    Column() {
      Text(section.title)
        .fontSize(12)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .textAlign(TextAlign.Start)
        .margin({ left: 24, top: 24, bottom: 8 })

      Column() {
        ForEach(section.items, (item: MenuItem, index: number) => {
          this.buildMenuItem(item, index === section.items.length - 1)
        })
      }
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(12)
      .margin({ left: 16, right: 16 })
    }
    .width('100%')
  }

  @Builder
  buildMenuItem(item: MenuItem, isLast: boolean) {
    Column() {
      Row() {
        // å›¾æ ‡
        Text(item.icon)
          .fontSize(20)
          .fontColor(item.iconColor)
          .margin({ right: 16 })

        // æ–‡å­—å†…å®¹
        Column() {
          Text(item.title)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .width('100%')
            .textAlign(TextAlign.Start)

          Text(item.subtitle)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .width('100%')
            .textAlign(TextAlign.Start)
            .margin({ top: 2 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        // ç®­å¤´
        Text('â€º')
          .fontSize(20)
          .fontColor($r('app.color.text_secondary'))
      }
      .width('100%')
      .height(64)
      .alignItems(VerticalAlign.Center)
      .onClick(() => {
        item.action();
      })

      if (!isLast) {
        Divider()
          .color($r('app.color.border_color'))
          .height(0.5)
          .margin({ left: 56, right: 16 })
      }
    }
    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
  }

  //=================== ä¼šè¯å’Œè§’è‰²ç®¡ç†ç›¸å…³Builder ===================

  @Builder
  buildMainContentSection() {
    Column() {
      // æ ‡ç­¾é¡µåˆ‡æ¢
      Row() {
        // ä¼šè¯æ ‡ç­¾
        Button() {
          Text('ä¼šè¯')
            .fontSize(14)
            .fontWeight(this.activeTab === 'sessions' ? FontWeight.Medium : FontWeight.Normal)
            .fontColor(this.activeTab === 'sessions' ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.activeTab = 'sessions';
        })
        .layoutWeight(1)
        .height(40)
        .borderRadius(0)
        .border({ width: { bottom: 2 }, color: this.activeTab === 'sessions' ? $r('app.color.text_primary') : Color.Transparent })

        // è§’è‰²æ ‡ç­¾
        Button() {
          Text('è§’è‰²')
            .fontSize(14)
            .fontWeight(this.activeTab === 'roles' ? FontWeight.Medium : FontWeight.Normal)
            .fontColor(this.activeTab === 'roles' ? $r('app.color.text_primary') : $r('app.color.text_secondary'))
        }
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.activeTab = 'roles';
        })
        .layoutWeight(1)
        .height(40)
        .borderRadius(0)
        .border({ width: { bottom: 2 }, color: this.activeTab === 'roles' ? $r('app.color.text_primary') : Color.Transparent })
      }
      .width('100%')
      .margin({ top: 16, left: 16, right: 16 })

      // å…¨å±€æœç´¢åŒºåŸŸ
      this.buildGlobalSearchSection()

      // å†…å®¹åŒºåŸŸ
      if (this.activeTab === 'sessions') {
        this.buildSessionSection()
      } else {
        this.buildRoleSection()
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildGlobalSearchSection() {
    Column() {
      // å…¨å±€æœç´¢æ¡†
      if (this.activeTab === 'sessions') {
        Search({ placeholder: this.activeTab === 'sessions' ? 'æœç´¢ä¼šè¯å†å²...' : 'æœç´¢è§’è‰²...' })
          .width('90%')
          .height(36)
          .margin({ top: 8, bottom: 8 })
          .onChange((value: string) => {
            this.globalSearchQuery = value;
            if (this.activeTab === 'sessions') {
              this.performGlobalSearch();
            }
          })
      }

      // è§’è‰²ç­›é€‰å™¨ï¼ˆæ¡ä»¶æ˜¾ç¤ºï¼Œä»…åœ¨ä¼šè¯é¡µé¢æ˜¾ç¤ºï¼‰
      if (this.activeTab === 'sessions' && this.showRoleFilter && this.selectedRoleFilter) {
        Row() {
          // è§’è‰²å›¾æ ‡
          Text(this.selectedRoleFilter.roleIcon || 'ğŸ­')
            .fontSize(14)
            .margin({ right: 6 })

          // è§’è‰²åç§°
          Text(`${this.selectedRoleFilter.name}`)
            .fontSize(12)
            .fontColor($r('app.color.text_primary'))
            .fontWeight(FontWeight.Medium)
            .layoutWeight(1)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // æ¸…é™¤ç­›é€‰æŒ‰é’®
          Button() {
            Text('âœ•')
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
          }
          .type(ButtonType.Circle)
          .width(20)
          .height(20)
          .backgroundColor('transparent')
          .stateEffect(true)
          .hitTestBehavior(HitTestMode.Block)
          .onClick(() => {
            this.clearRoleFilter();
          })
        }
        .width('auto')
        .height(32)
        .padding({ left: 8, right: 6, top: 4, bottom: 4 })
        .backgroundColor('#E3F2FD')
        .borderRadius(16)
        .margin({ top: 4, bottom: 8, left: 16, right: 16 })
        .border({ width: 1, color: '#2196F3' })
        .alignSelf(ItemAlign.Start)
        .stateStyles({
          pressed: {
            .backgroundColor('#BBDEFB')
            .scale({ x: 0.95, y: 0.95 })
          },
          normal: {
            .backgroundColor('#E3F2FD')
            .scale({ x: 1.0, y: 1.0 })
          }
        })
        .animation({
          duration: 120,
          curve: Curve.EaseInOut
        })
        .hitTestBehavior(HitTestMode.Block)
        .onClick(() => {
          this.clearRoleFilter();
        })
      }
    }
    .width('100%')
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildSessionSection() {
    Scroll() {
      Column() {
        // ä¼šè¯åˆ—è¡¨å¤´éƒ¨
        Row() {
          Text('ä¼šè¯åˆ—è¡¨')
            .fontSize(12)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_secondary'))
            .margin({ left: 24 })

          Blank()

          // æ–°å»ºä¼šè¯æŒ‰é’®
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            Text('+')
              .fontSize(16)
              .fontColor($r('app.color.text_primary'))
          }
          .width(28)
          .height(28)
          .backgroundColor('transparent')
          .border({ width: 1, color: $r('app.color.border_color'), radius: 14 })
          .margin({ right: 24 })
          .onClick(() => {
            this.handleNewSession();
          })
        }
        .width('100%')
        .height(40)
        .alignItems(VerticalAlign.Center)
        .margin({ top: 8 })


        // ä¼šè¯åˆ—è¡¨
        Column() {
          if (this.filteredSessions.length > 0) {
            ForEach(this.filteredSessions, (session: Session, index: number) => {
              SwipeableSessionItemComponent({
                session: session,
                systemPromptName: this.getSystemPromptName(session.systemPromptId), // ä¼ é€’ç³»ç»Ÿæç¤ºè¯åç§°
                isCurrentSession: this.isCurrentSession(session),
                isLast: index === this.filteredSessions.length - 1,
                onSessionClick: (sessionId: string) => {
                  this.switchToSession(sessionId);
                },
                onDelete: (sessionId: string) => {
                  this.confirmDeleteSession(sessionId);
                },
                onSwipeStart: () => {
                  this.handleSessionSwipeStart();
                },
                onSwipeEnd: () => {
                  this.handleSessionSwipeEnd();
                }
              })
            }, (session: Session) => session.id)
          } else {
            // ç©ºçŠ¶æ€
            Column() {
              Text(this.globalSearchQuery.trim() || this.showRoleFilter ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¼šè¯' : 'æš‚æ— ä¼šè¯')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ top: 20, bottom: 20 })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Center)
          }
        }
        .backgroundColor($r('app.color.card_background'))
        .borderRadius(12)
        .margin({ left: 16, right: 16, top: 8, bottom: 8 })
      }
      .width('100%')
    }
    .width('100%')
    .layoutWeight(1)
    .align(Alignment.TopStart)
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }

  @Builder
  buildRoleSection() {
    RoleViewComponent({
      onRoleSelect: (role: SystemPrompt) => {
        this.handleRoleSelect(role);
      },
      onRoleFilterRequest: (role: SystemPrompt) => {
        this.setRoleFilter(role);
      }
    })
  }


  @Builder
  buildRenameDialog() {
    Column() {
      // æ ‡é¢˜
      Text('é‡å‘½åä¼šè¯')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 16 })

      // è¾“å…¥æ¡†
      TextInput({ text: this.renameText, placeholder: 'è¯·è¾“å…¥ä¼šè¯åç§°' })
        .width('100%')
        .height(40)
        .fontSize(16)
        .backgroundColor($r('app.color.input_background'))
        .borderRadius(8)
        .padding({ left: 12, right: 12 })
        .margin({ bottom: 24 })
        .onChange((value: string) => {
          this.renameText = value;
        })

      // æŒ‰é’®
      Row() {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .fontColor($r('app.color.text_secondary'))
          .backgroundColor('transparent')
          .width(80)
          .height(36)
          .onClick(() => {
            this.cancelRename();
          })

        Button('ç¡®å®š')
          .type(ButtonType.Normal)
          .fontColor('#FFFFFF')
          .backgroundColor('#4285F4')
          .width(80)
          .height(36)
          .margin({ left: 12 })
          .onClick(() => {
            this.confirmRename();
          })
      }
      .justifyContent(FlexAlign.End)
      .width('100%')
    }
    .width(280)
    .padding({ top: 24, bottom: 24, left: 24, right: 24 })
    .backgroundColor($r('app.color.surface_color'))
    .borderRadius(12)
    .shadow({ 
      radius: 16, 
      color: 'rgba(0,0,0,0.1)', 
      offsetX: 0, 
      offsetY: 4 
    })
    .onClick(() => {
      // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…ç‚¹å‡»å¯¹è¯æ¡†æ—¶å…³é—­ 
    })
  }

  //=================== ä¼šè¯å’Œè§’è‰²ç®¡ç†ç›¸å…³æ–¹æ³• ===================

  /**
   * åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰ä¼šè¯
   */
  private isCurrentSession(session: Session): boolean {
    return this.chatViewModel?.currentSession?.id === session.id;
  }

  /**
   * å¤„ç†ä¼šè¯é¡¹æ»‘åŠ¨å¼€å§‹
   */
  private handleSessionSwipeStart(): void {
    this.isSessionItemSwiping = true;
    Logger.debug('SideDrawerComponent', 'ä¼šè¯é¡¹å¼€å§‹æ»‘åŠ¨ï¼Œç¦ç”¨ä¾§è¾¹æ æ»‘åŠ¨');
    
    // é€šçŸ¥çˆ¶ç»„ä»¶
    this.onSessionSwipeStateChange?.(true);
  }

  /**
   * å¤„ç†ä¼šè¯é¡¹æ»‘åŠ¨ç»“æŸ
   */
  private handleSessionSwipeEnd(): void {
    this.isSessionItemSwiping = false;
    Logger.debug('SideDrawerComponent', 'ä¼šè¯é¡¹æ»‘åŠ¨ç»“æŸï¼Œæ¢å¤ä¾§è¾¹æ æ»‘åŠ¨');
    
    // é€šçŸ¥çˆ¶ç»„ä»¶
    this.onSessionSwipeStateChange?.(false);
  }

  /**
   * è·å–ä¼šè¯é¡¹æ»‘åŠ¨çŠ¶æ€
   */
  public isSessionItemSwipingActive(): boolean {
    return this.isSessionItemSwiping;
  }

  /**
   * æ˜¾ç¤ºæ–°å»ºä¼šè¯å¯¹è¯æ¡†
   */
  private handleNewSession(): void {
    Logger.info('SideDrawerComponent', 'æ˜¾ç¤ºæ–°å»ºä¼šè¯å¯¹è¯æ¡†');
    Logger.info('SideDrawerComponent', `ChatViewModelå­˜åœ¨: ${!!this.chatViewModel}`);
    Logger.info('SideDrawerComponent', `ç³»ç»Ÿæç¤ºè¯æ•°é‡: ${this.chatViewModel?.systemPrompts?.length || 0}`);
    Logger.info('SideDrawerComponent', `å½“å‰showNewSessionDialogçŠ¶æ€: ${this.showNewSessionDialog}`);
    
    this.showNewSessionDialog = true;
    
    Logger.info('SideDrawerComponent', `è®¾ç½®åshowNewSessionDialogçŠ¶æ€: ${this.showNewSessionDialog}`);
  }

  /**
   * ç¡®è®¤åˆ›å»ºæ–°ä¼šè¯
   */
  private async confirmNewSession(selectedPrompt: SystemPrompt | null): Promise<void> {
    try {
      Logger.info('SideDrawerComponent', `ç¡®è®¤åˆ›å»ºæ–°ä¼šè¯ï¼Œç³»ç»Ÿæç¤ºè¯: ${selectedPrompt?.name || 'æ— '}`);
      
      this.showNewSessionDialog = false;
      
      if (!this.chatViewModel) {
        Logger.warn('SideDrawerComponent', 'æ²¡æœ‰ChatViewModelï¼Œæ— æ³•åˆ›å»ºä¼šè¯');
        return;
      }

      // ä½¿ç”¨æ–°çš„å¸¦ç³»ç»Ÿæç¤ºè¯çš„åˆ›å»ºæ–¹æ³•
      const newSession = await this.chatViewModel.createNewSessionWithPrompt(selectedPrompt);
      if (newSession) {
        Logger.info('SideDrawerComponent', `æ–°ä¼šè¯åˆ›å»ºæˆåŠŸ: ${newSession.name}`);
        
        // é€šçŸ¥çˆ¶ç»„ä»¶ä¼šè¯å·²åˆ‡æ¢
        this.onSessionSwitched?.();
      }
    } catch (error) {
      Logger.error('SideDrawerComponent', `åˆ›å»ºæ–°ä¼šè¯å¤±è´¥: ${error}`);
    }
    
    // å…³é—­ä¾§è¾¹æ 
    this.closeDrawer();
  }

  /**
   * å–æ¶ˆæ–°å»ºä¼šè¯
   */
  private cancelNewSession(): void {
    Logger.info('SideDrawerComponent', 'å–æ¶ˆæ–°å»ºä¼šè¯');
    this.showNewSessionDialog = false;
  }

  /**
   * æ ¹æ®ç³»ç»Ÿæç¤ºè¯IDè·å–æç¤ºè¯åç§°
   */
  private getSystemPromptName(systemPromptId: string | null): string | null {
    if (!systemPromptId || this.systemPrompts.length === 0) {
      return null;
    }
    const prompt = this.systemPrompts.find(p => p.id === systemPromptId);
    return prompt ? prompt.name : null;
  }

  /**
   * åˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯
   */
  private async switchToSession(sessionId: string): Promise<void> {
    try {
      if (!this.chatViewModel) {
        Logger.warn('SideDrawerComponent', 'æ²¡æœ‰ChatViewModelï¼Œæ— æ³•åˆ‡æ¢ä¼šè¯');
        return;
      }

      const success = await this.chatViewModel.switchToSession(sessionId);
      if (success) {
        Logger.info('SideDrawerComponent', `ä¼šè¯åˆ‡æ¢æˆåŠŸ: ${sessionId}`);
        this.closeDrawer(); // å¸¦åŠ¨ç”»å…³é—­ä¾§è¾¹æ 
        
        // é€šçŸ¥ä¼šè¯åˆ‡æ¢æˆåŠŸï¼Œè§¦å‘æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        if (this.onSessionSwitched) {
          this.onSessionSwitched();
        }
      }
    } catch (error) {
      Logger.error('SideDrawerComponent', `åˆ‡æ¢ä¼šè¯å¤±è´¥: ${error}`);
    }
  }


  /**
   * å¼€å§‹é‡å‘½åä¼šè¯
   */
  private startRename(session: Session): void {
    this.renameSessionId = session.id;
    this.renameText = session.name;
    this.showRenameDialog = true;
  }

  /**
   * å–æ¶ˆé‡å‘½å
   */
  private cancelRename(): void {
    this.showRenameDialog = false;
    this.renameSessionId = '';
    this.renameText = '';
  }

  /**
   * ç¡®è®¤é‡å‘½å
   */
  private async confirmRename(): Promise<void> {
    try {
      if (!this.chatViewModel || !this.renameSessionId || !this.renameText.trim()) {
        return;
      }

      const success = await this.chatViewModel.renameSession(this.renameSessionId, this.renameText.trim());
      if (success) {
        Logger.info('SideDrawerComponent', 'ä¼šè¯é‡å‘½åæˆåŠŸ');
      }

      this.cancelRename();
    } catch (error) {
      Logger.error('SideDrawerComponent', `é‡å‘½åä¼šè¯å¤±è´¥: ${error}`);
    }
  }

  /**
   * ç¡®è®¤åˆ é™¤ä¼šè¯ (ä¾§æ»‘åˆ é™¤ï¼Œæ— éœ€ç¡®è®¤)
   */
  private confirmDeleteSession(sessionId: string): void {
    this.deleteSession(sessionId);
  }

  /**
   * åˆ é™¤ä¼šè¯
   */
  private async deleteSession(sessionId: string): Promise<void> {
    try {
      if (!this.chatViewModel) {
        Logger.warn('SideDrawerComponent', 'æ²¡æœ‰ChatViewModelï¼Œæ— æ³•åˆ é™¤ä¼šè¯');
        return;
      }

      const success = await this.chatViewModel.deleteSession(sessionId);
      if (success) {
        Logger.info('SideDrawerComponent', `ä¼šè¯åˆ é™¤æˆåŠŸ: ${sessionId}`);

        // ç«‹å³æ›´æ–°è¿‡æ»¤ä¼šè¯åˆ—è¡¨ï¼Œä»å½“å‰åˆ—è¡¨ä¸­ç§»é™¤å·²åˆ é™¤çš„ä¼šè¯
        this.filteredSessions = this.filteredSessions.filter(session => session.id !== sessionId);

        // åŒæ—¶æ›´æ–°æœç´¢ç»“æœï¼Œç¡®ä¿ç•Œé¢ç«‹å³åæ˜ åˆ é™¤æ“ä½œ
        this.updateFilteredSessions();
      }
    } catch (error) {
      Logger.error('SideDrawerComponent', `åˆ é™¤ä¼šè¯å¤±è´¥: ${error}`);
    }
  }

  /**
   * æ‰§è¡Œå…¨å±€æœç´¢è¿‡æ»¤ï¼ˆå¸¦é˜²æŠ–åŠŸèƒ½ï¼Œæ”¯æŒè§’è‰²ç­›é€‰ï¼‰
   */
  private performGlobalSearch(): void {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.debounceTimer) {
      clearTimeout(this.debounceTimer);
    }

    // è®¾ç½®æ–°çš„å®šæ—¶å™¨
    this.debounceTimer = setTimeout(async () => {
      try {
        let searchResults: Session[] = [];

        // 1. é¦–å…ˆæ ¹æ®è§’è‰²ç­›é€‰è·å–åŸºç¡€ä¼šè¯åˆ—è¡¨
        if (this.selectedRoleFilter) {
          Logger.debug('SideDrawerComponent', `ä½¿ç”¨è§’è‰²ç­›é€‰: ${this.selectedRoleFilter.name}`);
          const sessionManager = this.chatViewModel?.getSessionManager();
          if (sessionManager) {
            searchResults = await sessionManager.getSessionsByRole(this.selectedRoleFilter.id);
            Logger.debug('SideDrawerComponent', `è§’è‰²ç­›é€‰æ‰¾åˆ° ${searchResults.length} ä¸ªç›¸å…³ä¼šè¯`);
          } else {
            searchResults = [...this.sessions];
          }
        } else {
          // æ²¡æœ‰è§’è‰²ç­›é€‰ï¼Œä½¿ç”¨æ‰€æœ‰ä¼šè¯
          searchResults = [...this.sessions];
        }

        // 2. åœ¨ç­›é€‰ç»“æœåŸºç¡€ä¸Šæ‰§è¡Œå…³é”®è¯æœç´¢
        if (!this.globalSearchQuery.trim()) {
          // å¦‚æœæœç´¢è¯ä¸ºç©ºï¼Œç›´æ¥ä½¿ç”¨ç­›é€‰ç»“æœ
          this.filteredSessions = searchResults;
          Logger.debug('SideDrawerComponent', `æ— æœç´¢å…³é”®è¯ï¼Œæ˜¾ç¤º${this.selectedRoleFilter ? 'è§’è‰²ç­›é€‰' : 'æ‰€æœ‰'}ä¼šè¯: ${searchResults.length} ä¸ª`);
        } else {
          Logger.debug('SideDrawerComponent', `åœ¨${searchResults.length}ä¸ªä¼šè¯ä¸­æœç´¢å…³é”®è¯: "${this.globalSearchQuery}"`);

          // ä½¿ç”¨ SessionManager çš„æœç´¢æ–¹æ³•ï¼Œä½†å…ˆç­›é€‰ä¼šè¯èŒƒå›´
          const sessionManager = this.chatViewModel?.getSessionManager();
          if (sessionManager) {
            // å¦‚æœæœ‰è§’è‰²ç­›é€‰ï¼Œéœ€è¦åœ¨ç­›é€‰ç»“æœä¸­è¿›ä¸€æ­¥æœç´¢
            if (this.selectedRoleFilter) {
              const query = this.globalSearchQuery.toLowerCase().trim();
              const matchedSessions: Session[] = [];

              for (const session of searchResults) {
                // æ£€æŸ¥ä¼šè¯æ ‡é¢˜
                if (session.name.toLowerCase().includes(query)) {
                  matchedSessions.push(session);
                  continue;
                }

                // æ£€æŸ¥ä¼šè¯æ¶ˆæ¯å†…å®¹
                try {
                  const messages = await sessionManager.getSessionMessages(session.id);
                  const hasContentMatch = messages.some(msg =>
                    msg.content && typeof msg.content === 'string' &&
                    msg.content.toLowerCase().includes(query)
                  );
                  if (hasContentMatch) {
                    matchedSessions.push(session);
                  }
                } catch (error) {
                  Logger.warn('SideDrawerComponent', `æœç´¢ä¼šè¯ ${session.id} å†…å®¹æ—¶å‡ºé”™: ${error}`);
                }
              }

              this.filteredSessions = matchedSessions;
              Logger.info('SideDrawerComponent', `è§’è‰²ç­›é€‰+å…³é”®è¯æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${matchedSessions.length} ä¸ªåŒ¹é…ä¼šè¯`);
            } else {
              // æ²¡æœ‰è§’è‰²ç­›é€‰ï¼Œç›´æ¥ä½¿ç”¨å…¨å±€æœç´¢
              this.filteredSessions = await sessionManager.searchSessions(this.globalSearchQuery);
              Logger.info('SideDrawerComponent', `å…¨å±€æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${this.filteredSessions.length} ä¸ªåŒ¹é…ä¼šè¯`);
            }
          } else {
            Logger.warn('SideDrawerComponent', 'æœªæ‰¾åˆ°SessionManagerï¼Œä½¿ç”¨æœ¬åœ°æœç´¢ï¼ˆä»…æœç´¢ä¼šè¯åç§°ï¼‰');
            // å¦‚æœæ²¡æœ‰ SessionManagerï¼Œä½¿ç”¨æœ¬åœ°æœç´¢ä½œä¸ºåå¤‡æ–¹æ¡ˆ
            const query = this.globalSearchQuery.toLowerCase().trim();
            this.filteredSessions = searchResults.filter(session =>
              session.name.toLowerCase().includes(query)
            );
            Logger.info('SideDrawerComponent', `æœ¬åœ°æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${this.filteredSessions.length} ä¸ªåŒ¹é…ä¼šè¯`);
          }
        }
      } catch (error) {
        Logger.error('SideDrawerComponent', `æœç´¢ä¼šè¯å¤±è´¥: ${error}`);
        // æœç´¢å¤±è´¥æ—¶æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯
        this.filteredSessions = [...this.sessions];
      }
    }, this.DEBOUNCE_DELAY);
  }

  /**
   * æ›´æ–°è¿‡æ»¤åçš„ä¼šè¯åˆ—è¡¨
   */
  private updateFilteredSessions(): void {
    this.performGlobalSearch();
  }

  /**
   * å½“sessionså‚æ•°å˜åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨
   */
  protected onSessionsChanged(): void {
    this.updateFilteredSessions();
  }

  /**
   * å¤„ç†è§’è‰²é€‰æ‹©
   */
  private async handleRoleSelect(role: SystemPrompt): Promise<void> {
    try {
      Logger.info('SideDrawerComponent', `é€‰æ‹©è§’è‰²: ${role.name}`);

      if (!this.chatViewModel) {
        Logger.warn('SideDrawerComponent', 'æ²¡æœ‰ChatViewModelï¼Œæ— æ³•å¤„ç†è§’è‰²é€‰æ‹©');
        return;
      }

      // ä½¿ç”¨SessionManageråˆ›å»ºåŸºäºè§’è‰²çš„ä¼šè¯
      const sessionManager = this.chatViewModel.getSessionManager();
      const newSession = await sessionManager.createRoleSession(role);

      if (newSession) {
        Logger.info('SideDrawerComponent', `åŸºäºè§’è‰²åˆ›å»ºä¼šè¯æˆåŠŸ: ${newSession.name}`);

        // å…³é—­ä¾§è¾¹æ 
        this.closeDrawer();

        // é€šçŸ¥çˆ¶ç»„ä»¶ä¼šè¯å·²åˆ‡æ¢
        this.onSessionSwitched?.();
      }
    } catch (error) {
      Logger.error('SideDrawerComponent', `å¤„ç†è§’è‰²é€‰æ‹©å¤±è´¥: ${error}`);
    }
  }

  /**
   * è®¾ç½®è§’è‰²ç­›é€‰å™¨ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼Œç”¨äºå¿«æ·ç­›é€‰ï¼‰
   */
  public setRoleFilter(role: SystemPrompt): void {
    try {
      Logger.info('SideDrawerComponent', `è®¾ç½®è§’è‰²ç­›é€‰å™¨: ${role.name}`);

      this.selectedRoleFilter = role;
      this.showRoleFilter = true;

      // åˆ‡æ¢åˆ°ä¼šè¯æ ‡ç­¾é¡µ
      this.activeTab = 'sessions';

      // è§¦å‘æœç´¢æ›´æ–°
      this.performGlobalSearch();

      Logger.info('SideDrawerComponent', `è§’è‰²ç­›é€‰å™¨è®¾ç½®å®Œæˆï¼Œåˆ‡æ¢åˆ°ä¼šè¯æ ‡ç­¾é¡µ`);
    } catch (error) {
      Logger.error('SideDrawerComponent', `è®¾ç½®è§’è‰²ç­›é€‰å™¨å¤±è´¥: ${error}`);
    }
  }

  /**
   * æ¸…é™¤è§’è‰²ç­›é€‰å™¨
   */
  private clearRoleFilter(): void {
    try {
      Logger.info('SideDrawerComponent', 'æ¸…é™¤è§’è‰²ç­›é€‰å™¨');

      this.selectedRoleFilter = null;
      this.showRoleFilter = false;

      // é‡æ–°æ‰§è¡Œæœç´¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰ä¼šè¯
      this.performGlobalSearch();

      Logger.info('SideDrawerComponent', 'è§’è‰²ç­›é€‰å™¨å·²æ¸…é™¤');
    } catch (error) {
      Logger.error('SideDrawerComponent', `æ¸…é™¤è§’è‰²ç­›é€‰å™¨å¤±è´¥: ${error}`);
    }
  }

  
  private navigateToSettings(): void {
    this.closeDrawer();
    setTimeout(() => {
      router.pushUrl({ url: 'pages/SettingsPage' });
    }, 300);
  }

  private navigateToMemoryManager(): void {
    this.closeDrawer();
    setTimeout(() => {
      router.pushUrl({ url: 'pages/MemoryManagerPage' });
    }, 300);
  }

  private navigateToProfileEdit(): void {
    this.closeDrawer();
    setTimeout(() => {
      router.pushUrl({ url: 'pages/UserProfileEditPage' });
    }, 300);
  }

  //=================== å¤´åƒé€‰æ‹©ç›¸å…³æ–¹æ³• ===================

  /**
   * æ˜¾ç¤ºå¤´åƒé€‰æ‹©å¯¹è¯æ¡†
   */
  private showAvatarSelectionDialog(): void {
    const avatarOptions: AvatarOption[] = [
      { text: 'é»˜è®¤è“è‰²', value: 'default:#4285F4' },
      { text: 'é»˜è®¤ç»¿è‰²', value: 'default:#34A853' },
      { text: 'é»˜è®¤çº¢è‰²', value: 'default:#EA4335' },
      { text: 'é»˜è®¤æ©™è‰²', value: 'default:#FBBC05' },
      { text: 'é»˜è®¤ç´«è‰²', value: 'default:#9C27B0' },
      { text: 'ğŸ˜€', value: 'emoji:ğŸ˜€' },
      { text: 'ğŸ™‚', value: 'emoji:ğŸ™‚' },
      { text: 'ğŸ˜Š', value: 'emoji:ğŸ˜Š' },
      { text: 'ğŸ¤”', value: 'emoji:ğŸ¤”' },
      { text: 'ğŸ¤–', value: 'emoji:ğŸ¤–' },
      { text: 'ğŸ‘¨â€ğŸ’»', value: 'emoji:ğŸ‘¨â€ğŸ’»' },
      { text: 'ğŸ‘©â€ğŸ’»', value: 'emoji:ğŸ‘©â€ğŸ’»' },
      { text: 'é€‰æ‹©å›¾ç‰‡', value: 'image:select' }
    ];

    this.showAvatarGridDialog(true, avatarOptions);
  }

  /**
   * æ˜¾ç¤ºå¤´åƒç½‘æ ¼é€‰æ‹©å¯¹è¯æ¡†
   */
  private showAvatarGridDialog(isUserAvatar: boolean, options: AvatarOption[]): void {
    const optionTexts = options.map((opt: AvatarOption) => opt.text);
    
    TextPickerDialog.show({
      range: optionTexts,
      selected: 0,
      onAccept: async (value: TextPickerResult) => {
        const selectedIndex: number = value.index as number;
        const selectedOption = options[selectedIndex];
        
        if (selectedOption.value === 'image:select') {
          await this.selectImageFromGallery(isUserAvatar);
        } else {
          const parts = selectedOption.value.split(':');
          const type = parts[0] as 'default' | 'emoji';
          const val = parts[1];
          await this.updateAvatarSetting(isUserAvatar, type, val);
        }
      },
      onCancel: () => {
        // å–æ¶ˆå¤´åƒé€‰æ‹©
      }
    });
  }

  /**
   * ä»ç›¸å†Œé€‰æ‹©å›¾ç‰‡
   */
  private async selectImageFromGallery(isUserAvatar: boolean): Promise<void> {
    try {
      const photoSelectOptions: picker.PhotoSelectOptions = {
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      };

      const photoPicker: picker.PhotoViewPicker = new picker.PhotoViewPicker();
      const photoSelectResult: picker.PhotoSelectResult = await photoPicker.select(photoSelectOptions);

      if (photoSelectResult.photoUris.length > 0) {
        const imageUri: string = photoSelectResult.photoUris[0];
        await this.updateAvatarSetting(isUserAvatar, 'image', imageUri);
        Logger.info('SideDrawerComponent', 'å¤´åƒå›¾ç‰‡é€‰æ‹©æˆåŠŸ');
      }
    } catch (error) {
      Logger.error('SideDrawerComponent', `é€‰æ‹©å¤´åƒå›¾ç‰‡å¤±è´¥: ${error}`);
      AlertDialog.show({
        title: 'é€‰æ‹©å¤±è´¥',
        message: 'æ— æ³•é€‰æ‹©å›¾ç‰‡ï¼Œè¯·é‡è¯•',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    }
  }

  /**
   * æ›´æ–°å¤´åƒè®¾ç½®
   */
  private async updateAvatarSetting(isUserAvatar: boolean, type: 'default' | 'emoji' | 'image', value: string): Promise<void> {
    try {
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      if (isUserAvatar) {
        this.userAvatarType = type;
        this.userAvatarValue = value;
      } else {
        this.aiAvatarType = type;
        this.aiAvatarValue = value;
      }
      
      // åˆ›å»ºæ–°çš„å¤´åƒè®¾ç½®å¯¹è±¡ç”¨äºä¿å­˜
      const newAvatarSettings = new AvatarSettings(
        this.userAvatarType,
        this.userAvatarValue,
        this.aiAvatarType,
        this.aiAvatarValue
      );
      
      // ä¿å­˜åˆ°å­˜å‚¨å¹¶é€šçŸ¥å…¶ä»–ç»„ä»¶
      await StorageManager.updateAvatarSettings(newAvatarSettings.toObject());
      
      Logger.info('SideDrawerComponent', `å¤´åƒè®¾ç½®å·²æ›´æ–°: ${type} = ${value}`);
    } catch (error) {
      Logger.error('SideDrawerComponent', `æ›´æ–°å¤´åƒè®¾ç½®å¤±è´¥: ${error}`);
    }
  }
}