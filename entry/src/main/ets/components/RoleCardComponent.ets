import { SystemPrompt } from '../models/ChatModels';
import { AppStorage } from '../utils/AppStorage';
import { SessionManager } from '../utils/SessionManager';
import { Logger } from '../utils/Logger';
import { router } from '@kit.ArkUI';
import { COMMON_CONSTANTS } from '../utils/Constants';

/**
 * è§’è‰²å¡ç‰‡ç»„ä»¶å±æ€§
 */
interface RoleCardProps {
  role: SystemPrompt;
  onRoleSelect?: (role: SystemPrompt) => void;
  onViewHistory?: (role: SystemPrompt) => void;
  onRoleLongPress?: (role: SystemPrompt) => void; // æ–°å¢ï¼šé•¿æŒ‰å›è°ƒ
}

/**
 * è§’è‰²å¡ç‰‡ç»„ä»¶ - æ˜¾ç¤ºå•ä¸ªè§’è‰²ä¿¡æ¯
 */
@ComponentV2
export struct RoleCardComponent {
  @Param @Require role: SystemPrompt = new SystemPrompt();
  @Param onRoleSelect: (role: SystemPrompt) => void = () => {};
  @Param onViewHistory: (role: SystemPrompt) => void = () => {};
  @Param onRoleLongPress: (role: SystemPrompt) => void = () => {}; // æ–°å¢ï¼šé•¿æŒ‰å›è°ƒ
  @Local isDarkMode: boolean = false;
  @Local isPressed: boolean = false;
  @Local isHovered: boolean = false;

  // è·å–è§’è‰²åˆ†ç±»å¯¹åº”çš„ä¸»é¢˜è‰²
  private getCategoryColor(category: string): string {
    const colorMap: Record<string, string> = {
      'professional': '#4F46E5', // æ·±è“è‰² - ä¸“ä¸š
      'creative': '#EC4899',     // ç²‰è‰² - åˆ›æ„
      'life': '#10B981',        // ç»¿è‰² - ç”Ÿæ´»
      'psychology': '#8B5CF6',  // ç´«è‰² - å¿ƒç†
      'custom': '#F59E0B'       // æ©™è‰² - è‡ªå®šä¹‰
    };
    return colorMap[category] || '#6B7280';
  }

  // è·å–è§’è‰²åˆ†ç±»å¯¹åº”çš„æµ…è‰²èƒŒæ™¯
  private getCategoryLightBg(category: string): string {
    const colorMap: Record<string, string> = {
      'professional': '#EEF2FF', // æ·¡è“è‰²
      'creative': '#FDF2F8',     // æ·¡ç²‰è‰²
      'life': '#F0FDF4',         // æ·¡ç»¿è‰²
      'psychology': '#F3E8FF',   // æ·¡ç´«è‰²
      'custom': '#FEF3C7'        // æ·¡æ©™è‰²
    };
    return colorMap[category] || '#F9FAFB';
  }


  aboutToAppear(): void {
    // è¿™é‡Œå¯ä»¥ä»ä¸»é¢˜ç®¡ç†å™¨è·å–ä¸»é¢˜çŠ¶æ€ï¼Œæš‚æ—¶ç®€åŒ–å¤„ç†
  }

  build() {
    Stack() {
      Column() {
        // è§’è‰²å¤´éƒ¨ä¿¡æ¯
        Row() {
          // è§’è‰²å›¾æ ‡
          Text(this.role.roleIcon || 'ğŸ­')
            .fontSize(32)
            .textAlign(TextAlign.Center)
            .width(48)
            .height(48)
            .margin({ right: 16 });

          // è§’è‰²åç§°å’Œåˆ†ç±»
          Column() {
            Row() {
              Text(this.role.name)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .fontColor(this.isDarkMode ? '#FFFFFF' : '#1F2937')
                .layoutWeight(1);

              // ç½®é¡¶æ ‡è¯†
              if (this.role.isPinned) {
                Text('ğŸ“Œ')
                  .fontSize(14)
                  .margin({ left: 4 });
              }

            }
            .width('100%')
            .alignItems(VerticalAlign.Center);

            // åˆ†ç±»æ ‡ç­¾å’Œå†å²æŒ‰é’®è¡Œ
            if (this.role.roleCategory) {
              Row() {
                Text(this.getCategoryDisplayName(this.role.roleCategory))
                  .fontSize(12)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.getCategoryColor(this.role.roleCategory))
                  .padding({ left: 10, right: 10, top: 3, bottom: 3 })
                  .backgroundColor(this.getCategoryLightBg(this.role.roleCategory))
                  .borderRadius(14);

                Blank();

                // å†å²æŒ‰é’®
                Button() {
                  Text('ğŸ“š')
                    .fontSize(14)
                    .fontColor(this.isDarkMode ? '#FFFFFF' : '#666666');
                }
                .width(28)
                .height(28)
                .backgroundColor(this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)')
                .borderRadius(14)
                .onClick(() => {
                  this.onViewRoleHistory();
                })
                .opacity(0.8);
              }
              .width('100%')
              .alignItems(VerticalAlign.Center)
              .margin({ top: 6 });
            }
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start);
        }
        .width('100%')
        .alignItems(VerticalAlign.Top)
        .margin({ bottom: 12 });

        // è§’è‰²æè¿° - é™ä½é€æ˜åº¦å’Œå‡å°‘è¡Œæ•°
        if (this.role.roleDescription) {
          Text(this.role.roleDescription)
            .fontSize(14)
            .fontWeight(FontWeight.Regular)
            .fontColor(this.isDarkMode ? '#9CA3AF' : '#9CA3AF')
            .opacity(0.8)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .lineHeight(20)
            .width('100%');
        }
      }
      .width('100%');
    }
    .padding(16)
    .backgroundColor(this.isPressed ?
      (this.isDarkMode ? '#2A2A2A' : '#F7F8FC') :
      (this.isDarkMode ? '#1E1E1E' : '#FFFFFF'))
    .borderRadius(20)
    .shadow({
      radius: this.isPressed ? 4 : 12,
      color: this.isDarkMode ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.08)',
      offsetX: 0,
      offsetY: this.isPressed ? 2 : 6
    })
    .border({
      width: 1,
      color: this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.06)'
    })
    .onClick(() => {
      this.onCreateSessionWithRole();
    })
    .onTouch((event: TouchEvent) => {
      if (event.type === TouchType.Down) {
        this.isPressed = true;
      } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
        this.isPressed = false;
      }
    })
    .onHover((isHovered: boolean) => {
      this.isHovered = isHovered;
    })
    .gesture(
      // é•¿æŒ‰æ‰‹åŠ¿
      LongPressGesture({ repeat: false, duration: 500 })
        .onAction(() => {
          this.onRoleLongPress(this.role);
        })
    );
  }

  /**
   * è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
   */
  private getCategoryDisplayName(category: string): string {
    const categoryMap: Record<string, string> = {
      'professional': 'ä¸“ä¸š',
      'creative': 'åˆ›æ„',
      'life': 'ç”Ÿæ´»',
      'psychology': 'å¿ƒç†',
      'custom': 'è‡ªå®šä¹‰'
    };
    return categoryMap[category] || category;
  }

  
  /**
   * åŸºäºè§’è‰²åˆ›å»ºä¼šè¯
   */
  private async onCreateSessionWithRole(): Promise<void> {
    try {
      Logger.info('RoleCardComponent', `åŸºäºè§’è‰²åˆ›å»ºä¼šè¯: ${this.role.name}`);

      // åˆ›å»ºæ–°ä¼šè¯å¹¶ç»‘å®šè§’è‰²
      const sessionManager = SessionManager.getInstance();
      const session = await sessionManager.createRoleSession(this.role);

      // è·³è½¬åˆ°èŠå¤©é¡µé¢
      router.pushUrl({
        url: 'pages/ChatPage',
        params: {
          sessionId: session.id,
          rolePromptId: this.role.id
        }
      });

      Logger.info('RoleCardComponent', `åŸºäºè§’è‰² ${this.role.name} åˆ›å»ºä¼šè¯æˆåŠŸ: ${session.id}`);
    } catch (error) {
      Logger.error('RoleCardComponent', `åŸºäºè§’è‰²åˆ›å»ºä¼šè¯å¤±è´¥: ${error}`);
    }
  }

  /**
   * æŸ¥çœ‹è§’è‰²å†å²ä¼šè¯
   */
  private onViewRoleHistory(): void {
    try {
      Logger.info('RoleCardComponent', `æŸ¥çœ‹è§’è‰²å†å²: ${this.role.name}`);

      // è°ƒç”¨çˆ¶ç»„ä»¶ä¼ å…¥çš„å›è°ƒï¼Œè§¦å‘è§’è‰²ç­›é€‰
      if (this.onViewHistory) {
        this.onViewHistory(this.role);
      }

      Logger.info('RoleCardComponent', `è§’è‰²å†å²æŸ¥çœ‹è¯·æ±‚å·²å‘é€: ${this.role.id}`);
    } catch (error) {
      Logger.error('RoleCardComponent', `æŸ¥çœ‹è§’è‰²å†å²å¤±è´¥: ${error}`);
    }
  }
}