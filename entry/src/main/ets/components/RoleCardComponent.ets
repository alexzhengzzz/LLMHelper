import { SystemPrompt } from '../models/ChatModels';
import { AppStorage } from '../utils/AppStorage';
import { SessionManager } from '../utils/SessionManager';
import { Logger } from '../utils/Logger';
import { router } from '@kit.ArkUI';
import { COMMON_CONSTANTS } from '../utils/Constants';

/**
 * è§’è‰²å¡ç‰‡ç»„ä»¶å±æ€§
 */
interface RoleCardProps {
  role: SystemPrompt;
  onRoleSelect?: (role: SystemPrompt) => void;
}

/**
 * è§’è‰²å¡ç‰‡ç»„ä»¶ - æ˜¾ç¤ºå•ä¸ªè§’è‰²ä¿¡æ¯
 */
@ComponentV2
export struct RoleCardComponent {
  @Param @Require role: SystemPrompt = new SystemPrompt();
  @Param onRoleSelect: (role: SystemPrompt) => void = () => {};
  @Local isDarkMode: boolean = false;
  @Local isPressed: boolean = false;

  aboutToAppear(): void {
    // è¿™é‡Œå¯ä»¥ä»ä¸»é¢˜ç®¡ç†å™¨è·å–ä¸»é¢˜çŠ¶æ€ï¼Œæš‚æ—¶ç®€åŒ–å¤„ç†
  }

  build() {
    Column() {
      // è§’è‰²å¤´éƒ¨ä¿¡æ¯
      Row() {
        // è§’è‰²å›¾æ ‡
        if (this.role.roleIcon) {
          Text(this.role.roleIcon)
            .fontSize(24)
            .margin({ right: 12 });
        } else {
          Text('ğŸ­')
            .fontSize(24)
            .margin({ right: 12 });
        }

        // è§’è‰²åç§°å’Œåˆ†ç±»
        Column() {
          Text(this.role.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis });

          if (this.role.roleCategory) {
            Text(this.getCategoryDisplayName(this.role.roleCategory))
              .fontSize(12)
              .fontColor('#666666')
              .margin({ top: 2 });
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start);

        // ç½®é¡¶æ ‡è¯†
        if (this.role.isPinned) {
          Text('ğŸ“Œ')
            .fontSize(14)
            .margin({ right: 8 });
        }

        // å†…ç½®è§’è‰²æ ‡è¯†
        if (this.role.isBuiltIn) {
          Text('ğŸ”’')
            .fontSize(12)
            .fontColor('#999999');
        }
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 8 });

      // è§’è‰²æè¿°
      if (this.role.roleDescription) {
        Text(this.role.roleDescription)
          .fontSize(14)
          .fontColor('#666666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .lineHeight(18)
          .width('100%')
          .margin({ bottom: 8 });
      }

      // è§’è‰²ç»Ÿè®¡ä¿¡æ¯
      Row() {
        // ä½¿ç”¨æ¬¡æ•°
        Row() {
          Text('ğŸ“Š')
            .fontSize(12);
          Text(`ä½¿ç”¨ ${this.role.usageCount} æ¬¡`)
            .fontSize(12)
            .fontColor('#999999');
        }
        .margin({ right: 16 });

        // æœ€åä½¿ç”¨æ—¶é—´
        Row() {
          Text('â°')
            .fontSize(12);
          Text(this.formatLastUsedTime(this.role.timestamp))
            .fontSize(12)
            .fontColor('#999999');
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween);

      // æ“ä½œæŒ‰é’®åŒºåŸŸ
      Row() {
        // åŸºäºè§’è‰²åˆ›å»ºä¼šè¯æŒ‰é’®
        Button('å¼€å§‹å¯¹è¯')
          .fontSize(14)
          .backgroundColor(COMMON_CONSTANTS.THEME_COLORS.primary)
          .fontColor(Color.White)
          .borderRadius(16)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.onCreateSessionWithRole();
          })
          .layoutWeight(1);
      }
      .width('100%')
      .margin({ top: 8 })
      .justifyContent(FlexAlign.Center);
    }
    .padding(16)
    .backgroundColor(this.isPressed ? '#F5F5F5' : Color.White)
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#000000',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      if (this.onRoleSelect) {
        this.onRoleSelect(this.role);
      }
    })
    .onTouch((event: TouchEvent) => {
      if (event.type === TouchType.Down) {
        this.isPressed = true;
      } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
        this.isPressed = false;
      }
    });
  }

  /**
   * è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
   */
  private getCategoryDisplayName(category: string): string {
    const categoryMap: Record<string, string> = {
      'professional': 'ä¸“ä¸šè§’è‰²',
      'creative': 'åˆ›æ„è§’è‰²',
      'life': 'ç”Ÿæ´»è§’è‰²',
      'psychology': 'å¿ƒç†è§’è‰²',
      'custom': 'è‡ªå®šä¹‰è§’è‰²'
    };
    return categoryMap[category] || category;
  }

  /**
   * æ ¼å¼åŒ–æœ€åä½¿ç”¨æ—¶é—´
   */
  private formatLastUsedTime(timestamp: number): string {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (minutes < 1) {
      return 'åˆšåˆš';
    } else if (minutes < 60) {
      return `${minutes}åˆ†é’Ÿå‰`;
    } else if (hours < 24) {
      return `${hours}å°æ—¶å‰`;
    } else if (days < 7) {
      return `${days}å¤©å‰`;
    } else {
      return new Date(timestamp).toLocaleDateString();
    }
  }

  /**
   * åŸºäºè§’è‰²åˆ›å»ºä¼šè¯
   */
  private async onCreateSessionWithRole(): Promise<void> {
    try {
      Logger.info('RoleCardComponent', `åŸºäºè§’è‰²åˆ›å»ºä¼šè¯: ${this.role.name}`);

      // åˆ›å»ºæ–°ä¼šè¯å¹¶ç»‘å®šè§’è‰²
      const sessionManager = SessionManager.getInstance();
      const session = await sessionManager.createNewSessionWithPrompt(this.role.id);

      // è·³è½¬åˆ°èŠå¤©é¡µé¢
      router.pushUrl({
        url: 'pages/ChatPage',
        params: {
          sessionId: session.id,
          rolePromptId: this.role.id
        }
      });

      Logger.info('RoleCardComponent', `åŸºäºè§’è‰² ${this.role.name} åˆ›å»ºä¼šè¯æˆåŠŸ: ${session.id}`);
    } catch (error) {
      Logger.error('RoleCardComponent', `åŸºäºè§’è‰²åˆ›å»ºä¼šè¯å¤±è´¥: ${error}`);
    }
  }
}