import { SystemPrompt } from '../models/ChatModels';
import { AppStorage } from '../utils/AppStorage';
import { SessionManager } from '../utils/SessionManager';
import { Logger } from '../utils/Logger';
import { router } from '@kit.ArkUI';
import { COMMON_CONSTANTS } from '../utils/Constants';

/**
 * è§’è‰²å¡ç‰‡ç»„ä»¶å±æ€§
 */
interface RoleCardProps {
  role: SystemPrompt;
  onRoleSelect?: (role: SystemPrompt) => void;
}

/**
 * è§’è‰²å¡ç‰‡ç»„ä»¶ - æ˜¾ç¤ºå•ä¸ªè§’è‰²ä¿¡æ¯
 */
@ComponentV2
export struct RoleCardComponent {
  @Param @Require role: SystemPrompt = new SystemPrompt();
  @Param onRoleSelect: (role: SystemPrompt) => void = () => {};
  @Local isDarkMode: boolean = false;
  @Local isPressed: boolean = false;
  @Local isHovered: boolean = false;

  // è·å–è§’è‰²åˆ†ç±»å¯¹åº”çš„ä¸»é¢˜è‰²
  private getCategoryColor(category: string): string {
    const colorMap: Record<string, string> = {
      'professional': '#4F46E5', // æ·±è“è‰² - ä¸“ä¸š
      'creative': '#EC4899',     // ç²‰è‰² - åˆ›æ„
      'life': '#10B981',        // ç»¿è‰² - ç”Ÿæ´»
      'psychology': '#8B5CF6',  // ç´«è‰² - å¿ƒç†
      'custom': '#F59E0B'       // æ©™è‰² - è‡ªå®šä¹‰
    };
    return colorMap[category] || '#6B7280';
  }

  // è·å–è§’è‰²åˆ†ç±»å¯¹åº”çš„æµ…è‰²èƒŒæ™¯
  private getCategoryLightBg(category: string): string {
    const colorMap: Record<string, string> = {
      'professional': '#EEF2FF', // æ·¡è“è‰²
      'creative': '#FDF2F8',     // æ·¡ç²‰è‰²
      'life': '#F0FDF4',         // æ·¡ç»¿è‰²
      'psychology': '#F3E8FF',   // æ·¡ç´«è‰²
      'custom': '#FEF3C7'        // æ·¡æ©™è‰²
    };
    return colorMap[category] || '#F9FAFB';
  }

  aboutToAppear(): void {
    // è¿™é‡Œå¯ä»¥ä»ä¸»é¢˜ç®¡ç†å™¨è·å–ä¸»é¢˜çŠ¶æ€ï¼Œæš‚æ—¶ç®€åŒ–å¤„ç†
  }

  build() {
    Column() {
      // è§’è‰²å¤´éƒ¨ä¿¡æ¯
      Row() {
        // è§’è‰²å›¾æ ‡å®¹å™¨
        Stack() {
          Circle({ width: 48, height: 48 })
            .fill(this.getCategoryLightBg(this.role.roleCategory))
            .stroke(this.getCategoryColor(this.role.roleCategory))
            .strokeWidth(1);

          Text(this.role.roleIcon || 'ğŸ­')
            .fontSize(24)
            .textAlign(TextAlign.Center);
        }
        .width(48)
        .height(48)
        .margin({ right: 16 });

        // è§’è‰²åç§°å’Œåˆ†ç±»
        Column() {
          Row() {
            Text(this.role.name)
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .fontColor(this.isDarkMode ? '#FFFFFF' : '#1F2937')
              .layoutWeight(1);

            // ç½®é¡¶æ ‡è¯†
            if (this.role.isPinned) {
              Text('ğŸ“Œ')
                .fontSize(14)
                .margin({ left: 4 });
            }

            // å†…ç½®è§’è‰²æ ‡è¯†
            if (this.role.isBuiltIn) {
              Text('ğŸ”’')
                .fontSize(12)
                .fontColor('#9CA3AF')
                .margin({ left: 4 });
            }
          }
          .width('100%')
          .alignItems(VerticalAlign.Center);

          // åˆ†ç±»æ ‡ç­¾
          if (this.role.roleCategory) {
            Row() {
              Text(this.getCategoryDisplayName(this.role.roleCategory))
                .fontSize(12)
                .fontWeight(FontWeight.Medium)
                .fontColor(this.getCategoryColor(this.role.roleCategory))
                .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                .backgroundColor(this.getCategoryLightBg(this.role.roleCategory))
                .borderRadius(12);
            }
            .width('100%')
            .margin({ top: 4 });
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start);
      }
      .width('100%')
      .alignItems(VerticalAlign.Top)
      .margin({ bottom: 12 });

      // è§’è‰²æè¿°
      if (this.role.roleDescription) {
        Text(this.role.roleDescription)
          .fontSize(14)
          .fontWeight(FontWeight.Regular)
          .fontColor(this.isDarkMode ? '#D1D5DB' : '#6B7280')
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .lineHeight(20)
          .width('100%')
          .margin({ bottom: 16 });
      }

  
      // æ“ä½œæŒ‰é’®åŒºåŸŸ
      Row() {
        // åŸºäºè§’è‰²åˆ›å»ºä¼šè¯æŒ‰é’®
        Button() {
          Row() {
            Text('ğŸ’¬')
              .fontSize(14)
              .margin({ right: 6 });
            Text('å¼€å§‹å¯¹è¯')
              .fontSize(14)
              .fontWeight(FontWeight.Medium);
          }
        }
        .backgroundColor(COMMON_CONSTANTS.THEME_COLORS.primary)
        .fontColor(Color.White)
        .borderRadius(20)
        .padding({ left: 20, right: 20, top: 10, bottom: 10 })
        .onClick(() => {
          this.onCreateSessionWithRole();
        })
        .layoutWeight(1)
        .shadow({
          radius: 4,
          color: COMMON_CONSTANTS.THEME_COLORS.primary,
          offsetX: 0,
          offsetY: 2
        });
      }
      .width('100%')
      .justifyContent(FlexAlign.Center);
    }
    .padding(20)
    .backgroundColor(this.isPressed ?
      (this.isDarkMode ? '#2A2A2A' : '#F0F0F0') :
      (this.isDarkMode ? '#1E1E1E' : '#FFFFFF'))
    .borderRadius(16)
    .shadow({
      radius: this.isPressed ? 2 : 8,
      color: '#000000',
      offsetX: 0,
      offsetY: this.isPressed ? 1 : 4
    })
    .border({
      width: 1,
      color: this.isDarkMode ? '#333333' : '#E5E7EB'
    })
    .onClick(() => {
      if (this.onRoleSelect) {
        this.onRoleSelect(this.role);
      }
    })
    .onTouch((event: TouchEvent) => {
      if (event.type === TouchType.Down) {
        this.isPressed = true;
      } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
        this.isPressed = false;
      }
    })
    .onHover((isHovered: boolean) => {
      this.isHovered = isHovered;
    });
  }

  /**
   * è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
   */
  private getCategoryDisplayName(category: string): string {
    const categoryMap: Record<string, string> = {
      'professional': 'ä¸“ä¸š',
      'creative': 'åˆ›æ„',
      'life': 'ç”Ÿæ´»',
      'psychology': 'å¿ƒç†',
      'custom': 'è‡ªå®šä¹‰'
    };
    return categoryMap[category] || category;
  }

  
  /**
   * åŸºäºè§’è‰²åˆ›å»ºä¼šè¯
   */
  private async onCreateSessionWithRole(): Promise<void> {
    try {
      Logger.info('RoleCardComponent', `åŸºäºè§’è‰²åˆ›å»ºä¼šè¯: ${this.role.name}`);

      // åˆ›å»ºæ–°ä¼šè¯å¹¶ç»‘å®šè§’è‰²
      const sessionManager = SessionManager.getInstance();
      const session = await sessionManager.createRoleSession(this.role);

      // è·³è½¬åˆ°èŠå¤©é¡µé¢
      router.pushUrl({
        url: 'pages/ChatPage',
        params: {
          sessionId: session.id,
          rolePromptId: this.role.id
        }
      });

      Logger.info('RoleCardComponent', `åŸºäºè§’è‰² ${this.role.name} åˆ›å»ºä¼šè¯æˆåŠŸ: ${session.id}`);
    } catch (error) {
      Logger.error('RoleCardComponent', `åŸºäºè§’è‰²åˆ›å»ºä¼šè¯å¤±è´¥: ${error}`);
    }
  }
}