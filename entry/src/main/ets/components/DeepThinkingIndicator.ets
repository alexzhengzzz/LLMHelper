/**
 * æ·±åº¦æ€è€ƒæŒ‡ç¤ºå™¨ç»„ä»¶ - åœ¨èŠå¤©ç•Œé¢ä¸­ç®€æ´æ˜¾ç¤º
 */

import { ThinkingStep, ThinkingStatus, StepStatus, Message } from '../models/ChatModels';
import { ThinkingProgressComponent } from './ThinkingProgressComponent';

// æŒ‡ç¤ºå™¨å‚æ•°
@ObservedV2
class ThinkingIndicatorParams {
  @Trace message: Message | null = null;
  @Trace compact: boolean = true;
}

@ComponentV2
export struct DeepThinkingIndicator {
  @Param @Require message: Message;
  @Param compact: boolean = true;
  @Param onTap: () => void = () => {};
  @Param onStop: () => void = () => {};

  @Local currentStatus: ThinkingStatus = ThinkingStatus.IDLE;
  @Local progressText: string = '';

  aboutToAppear() {
    this.updateStatus();
  }

  build() {
    if (this.message.isDeepThinking && this.message.thinkingStatus !== ThinkingStatus.IDLE) {
      Row() {
        // ä¸»è¦å†…å®¹
        Row() {
          // çŠ¶æ€å›¾æ ‡å’Œè¿›åº¦
          this.buildStatusSection()
          
          // è¿›åº¦æ–‡æœ¬
          if (!this.compact) {
            Text(this.progressText)
              .fontSize(11)
              .fontColor('#666')
              .margin({ left: 6 })
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
        }
        .layoutWeight(1)
        .constraintSize({ maxWidth: '100%' })

        // æ“ä½œæŒ‰é’®
        if (!this.compact) {
          this.buildActionButtons()
        }
      }
      .width('100%')
      .constraintSize({ 
        maxWidth: '100%',
        minHeight: this.compact ? 32 : 40
      })
      .padding({
        left: this.compact ? 6 : 8,
        right: this.compact ? 6 : 8,
        top: this.compact ? 4 : 6,
        bottom: this.compact ? 4 : 6
      })
      .backgroundColor(this.getBackgroundColor())
      .borderRadius(this.compact ? 6 : 8)
      .border({
        width: 1,
        color: this.getBorderColor()
      })
      .clip(true)
      .onClick(() => {
        this.onTap();
      })
    }
  }

  @Builder
  private buildStatusSection() {
    Row() {
      // è¿›åº¦æŒ‡ç¤ºå™¨
      if (this.compact) {
        ThinkingProgressComponent({
          thinkingSteps: this.message.thinkingSteps || [],
          thinkingStatus: this.message.thinkingStatus,
          progressSize: 'small',
          showText: false
        })
          .margin({ right: 4 })
          .width('100%')
          .height(24)
      } else {
        ThinkingProgressComponent({
          thinkingSteps: this.message.thinkingSteps || [],
          thinkingStatus: this.message.thinkingStatus,
          progressSize: 'medium',
          showText: false
        })
          .margin({ right: 6 })
          .width(32)
          .height(32)
      }

      // çŠ¶æ€æ–‡æœ¬
      Column() {
        Text(this.getStatusTitle())
          .fontSize(this.compact ? 10 : 11)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getTextColor())
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .constraintSize({ maxWidth: '100%' })

        // æ­¥éª¤è¿›åº¦
        if (this.message.thinkingSteps && this.message.thinkingSteps.length > 0) {
          Text(`${this.getCompletedStepsCount()}/${this.message.thinkingSteps.length}`)
            .fontSize(this.compact ? 8 : 9)
            .fontColor('#666')
            .margin({ top: 1 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .constraintSize({ maxWidth: '100%' })
      .layoutWeight(1)
    }
    .constraintSize({ maxWidth: '100%' })
  }

  @Builder
  private buildActionButtons() {
    Row() {
      // åœæ­¢æŒ‰é’®ï¼ˆä»…åœ¨æ€è€ƒè¿›è¡Œä¸­æ˜¾ç¤ºï¼‰
      if (this.message.thinkingStatus !== ThinkingStatus.COMPLETED && 
          this.message.thinkingStatus !== ThinkingStatus.FAILED &&
          this.message.thinkingStatus !== ThinkingStatus.CANCELLED) {
        Button() {
          Text('â¹ï¸')
            .fontSize(10)
        }
        .width(20)
        .height(20)
        .backgroundColor('#FEE2E2')
        .borderRadius(10)
        .onClick(() => {
          this.onStop();
        })
        .margin({ right: 4 })
      }

      // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
      Button() {
        Text('è¯¦æƒ…')
          .fontSize(9)
          .fontColor($r('app.color.primary_color'))
      }
        .width(40)
        .height(20)
        .backgroundColor('#EFF6FF')
        .borderRadius(10)
        .onClick(() => {
          this.onTap();
        })
    }
    .constraintSize({ maxWidth: '100%' })
  }

  // å·¥å…·æ–¹æ³•
  private updateStatus(): void {
    this.currentStatus = this.message.thinkingStatus || ThinkingStatus.IDLE;
    this.progressText = this.getProgressText();
  }

  private getCompletedStepsCount(): number {
    if (!this.message.thinkingSteps) return 0;
    return this.message.thinkingSteps.filter(s => s.status === StepStatus.COMPLETED).length;
  }

  private getStatusTitle(): string {
    switch (this.currentStatus) {
      case ThinkingStatus.PLANNING: return 'ğŸ—ºï¸ æ€è·¯è§„åˆ’ä¸­';
      case ThinkingStatus.ANALYZING: return 'ğŸ” æ·±åº¦åˆ†æä¸­';
      case ThinkingStatus.RESEARCHING: return 'ğŸŒ èµ„æ–™æ£€ç´¢ä¸­';
      case ThinkingStatus.THINKING: return 'ğŸ§  å¤šè§’åº¦æ€è€ƒä¸­';
      case ThinkingStatus.VERIFYING: return 'âœ… æ‰¹åˆ¤æ€§éªŒè¯ä¸­';
      case ThinkingStatus.INTEGRATING: return 'ğŸ¯ ç»¼åˆæ•´åˆä¸­';
      case ThinkingStatus.REFINING: return 'ğŸ” è´¨é‡å¤ç›˜ä¸­';
      case ThinkingStatus.COMPLETED: return 'âœ¨ æ€è€ƒå®Œæˆ';
      case ThinkingStatus.FAILED: return 'âŒ æ€è€ƒå¤±è´¥';
      case ThinkingStatus.CANCELLED: return 'â¹ï¸ æ€è€ƒå–æ¶ˆ';
      default: return 'ğŸ’­ å‡†å¤‡æ€è€ƒ';
    }
  }

  private getProgressText(): string {
    if (!this.message.thinkingSteps || this.message.thinkingSteps.length === 0) {
      return 'æ­£åœ¨å‡†å¤‡æ·±åº¦æ€è€ƒ...';
    }

    const completedSteps = this.message.thinkingSteps.filter(s => s.status === StepStatus.COMPLETED).length;
    const totalSteps = this.message.thinkingSteps.length;
    
    if (this.currentStatus === ThinkingStatus.COMPLETED) {
      return `æ·±åº¦æ€è€ƒå®Œæˆï¼Œè€—æ—¶ ${this.getTotalDuration().toFixed(1)}s`;
    } else if (this.currentStatus === ThinkingStatus.FAILED) {
      return `æ·±åº¦æ€è€ƒå¤±è´¥ï¼Œå®Œæˆ ${completedSteps}/${totalSteps} æ­¥`;
    } else {
      return `æ­£åœ¨è¿›è¡Œæ·±åº¦æ€è€ƒ (${completedSteps}/${totalSteps})`;
    }
  }

  private getTotalDuration(): number {
    if (!this.message.thinkingSteps) return 0;
    
    return this.message.thinkingSteps
      .filter(s => s.duration)
      .reduce((total, step) => total + (step.duration || 0), 0) / 1000;
  }

  private getBackgroundColor(): string {
    switch (this.currentStatus) {
      case ThinkingStatus.COMPLETED:
        return '#F0FDF4'; // ç»¿è‰²èƒŒæ™¯
      case ThinkingStatus.FAILED:
      case ThinkingStatus.CANCELLED:
        return '#FEF2F2'; // çº¢è‰²èƒŒæ™¯
      default:
        return '#F8F9FF'; // è“è‰²èƒŒæ™¯
    }
  }

  private getBorderColor(): string {
    switch (this.currentStatus) {
      case ThinkingStatus.COMPLETED:
        return '#86EFAC'; // ç»¿è‰²è¾¹æ¡†
      case ThinkingStatus.FAILED:
      case ThinkingStatus.CANCELLED:
        return '#FECACA'; // çº¢è‰²è¾¹æ¡†
      default:
        return '#C7D2FE'; // è“è‰²è¾¹æ¡†
    }
  }

  private getTextColor(): string {
    switch (this.currentStatus) {
      case ThinkingStatus.COMPLETED:
        return '#166534'; // ç»¿è‰²æ–‡å­—
      case ThinkingStatus.FAILED:
      case ThinkingStatus.CANCELLED:
        return '#991B1B'; // çº¢è‰²æ–‡å­—
      default:
        return '#3730A3'; // è“è‰²æ–‡å­—
    }
  }

}
