import { router } from '@kit.ArkUI';
import { Constants, PromptTemplate, PromptCategory } from '../utils/Constants';
import { PromptRecommendationManager } from '../utils/PromptRecommendationManager';

export interface QuickCommand {
  id: string;
  title: string;
  subtitle: string;
  icon: string;
  color: string;
  backgroundColor: string;
  action: () => void;
}

@ComponentV2
export struct QuickCommandsComponent {
  @Param commands: QuickCommand[] = [];
  @Param phrases: [] = [];
  @Param onClose: () => void = () => {};
  @Param onPromptSelected?: (prompt: string) => void = () => {};
  @Local showAnimation: boolean = false;
  @Local searchText: string = '';
  @Local selectedCategory: string = 'all';
  @Local showPrompts: boolean = true;
  @Local showRecommendations: boolean = false;
  
  private promptTemplates: PromptTemplate[] = Constants.PROMPT_TEMPLATES;
  private categories: PromptCategory[] = Constants.PROMPT_CATEGORIES;
  private recommendationManager: PromptRecommendationManager = PromptRecommendationManager.getInstance();
  private scroller: Scroller = new Scroller();

  async aboutToAppear(): Promise<void> {
    // åˆå§‹åŒ–æŽ¨èç®¡ç†å™¨
    await this.recommendationManager.initialize();
    
    // å»¶è¿Ÿæ˜¾ç¤ºåŠ¨ç”»æ•ˆæžœ
    setTimeout(() => {
      this.showAnimation = true;
    }, 50);
  }

  build() {
    Stack({ alignContent: Alignment.Center }) {
      // èƒŒæ™¯è’™å±‚
      Column() {}
        .width('100%')
        .height('100%')
        .backgroundColor(this.showAnimation ? 'rgba(0, 0, 0, 0.5)' : 'rgba(0, 0, 0, 0.01)')
        .animation({
          duration: 300,
          curve: Curve.FastOutSlowIn
        })
        .onClick(() => {
          this.closePanel();
        })

      // ä¸»é¢æ¿
      Column({ space: 0 }) {
        // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
        this.buildHeader()
        
        // æœç´¢æ¡†
        this.buildSearchBox()
        
        // æ¨¡å¼åˆ‡æ¢
        this.buildModeToggle()
        
        // åˆ†ç±»æ ‡ç­¾é¡µ (åªåœ¨Promptæ¨¡å¼æ˜¾ç¤º)
        if (this.showPrompts) {
          this.buildCategoryTabs()
        }
        
        // å†…å®¹åˆ—è¡¨
        this.buildContentList()
      }
      .width('90%')
      .constraintSize({ maxWidth: 450, maxHeight: '80%' })
      .backgroundColor(Color.White)
      .borderRadius(20)
      .clip(true)
      .shadow({
        radius: 20,
        color: 'rgba(0, 0, 0, 0.15)',
        offsetY: 10
      })
      .scale({ x: this.showAnimation ? 1 : 0.8, y: this.showAnimation ? 1 : 0.8 })
      .opacity(this.showAnimation ? 1 : 0)
      .animation({
        duration: 350,
        curve: Curve.FastOutSlowIn
      })
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildHeader() {
    Row() {
      // æ ‡é¢˜
      Text(this.showPrompts ? 'æ™ºèƒ½åŠ©æ‰‹' : 'å¿«æ·æŒ‡ä»¤')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
      
      Blank()
      
      // å…³é—­æŒ‰é’®
      Button() {
        Text('âœ•')
          .fontSize(16)
          .fontColor('#666666')
      }
      .width(32)
      .height(32)
      .backgroundColor('#F5F5F5')
      .borderRadius(16)
      .onClick(() => {
        this.closePanel();
      })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 12 })
  }

  @Builder
  buildSearchBox() {
    Row() {
      // æœç´¢å›¾æ ‡
      Text('ðŸ”')
        .fontSize(16)
        .margin({ right: 8 })
      
      // æœç´¢è¾“å…¥æ¡†
      TextInput({ placeholder: 'æœç´¢æŒ‡ä»¤...', text: $$this.searchText })
        .layoutWeight(1)
        .height(36)
        .backgroundColor('#F8F9FA')
        .borderRadius(18)
        .padding({ left: 12, right: 12 })
        .border({ width: 0 })
        .placeholderColor('#999999')
        .fontColor('#333333')
        .onChange((value: string) => {
          this.searchText = value;
        })
      
      // æ¸…é™¤æŒ‰é’®
      if (this.searchText.length > 0) {
        Button() {
          Text('âœ•')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width(28)
        .height(28)
        .backgroundColor('#F0F0F0')
        .borderRadius(14)
        .margin({ left: 8 })
        .onClick(() => {
          this.searchText = '';
        })
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20, bottom: 12 })
  }

  @Builder
  buildModeToggle() {
    Row() {
      // æ™ºèƒ½æŽ¨è
      Button() {
        Row({ space: 4 }) {
          Text('ðŸ”¥')
            .fontSize(12)
          Text('æŽ¨è')
            .fontSize(14)
            .fontColor(this.showRecommendations ? '#FFFFFF' : '#666666')
        }
      }
      .layoutWeight(1)
      .height(36)
      .backgroundColor(this.showRecommendations ? '#FF6B35' : '#F8F9FA')
      .borderRadius(18)
      .margin({ left: 3 })
      .onClick(() => {
        this.showPrompts = true;
        this.showRecommendations = true;
        this.selectedCategory = 'recommendations';
      })

      // AIæ¨¡æ¿
      Button() {
        Text('AIæ¨¡æ¿')
          .fontSize(14)
          .fontColor(this.showPrompts && !this.showRecommendations ? '#FFFFFF' : '#666666')
      }
      .layoutWeight(1)
      .height(36)
      .backgroundColor(this.showPrompts && !this.showRecommendations ? '#007AFF' : '#F8F9FA')
      .borderRadius(18)
      .onClick(() => {
        this.showPrompts = true;
        this.showRecommendations = false;
        this.selectedCategory = 'all';
      })
    }
    .width('100%')
    .padding({ left: 20, right: 20, bottom: 12 })
  }

  @Builder
  buildCategoryTabs() {
    Scroll(this.scroller) {
      Row({ space: 8 }) {
        if (this.showRecommendations) {
          // æŽ¨èæ¨¡å¼çš„é€‰é¡¹
          Button() {
            Row({ space: 4 }) {
              Text('â­')
                .fontSize(12)
              Text('æ™ºèƒ½æŽ¨è')
                .fontSize(13)
                .fontColor(this.selectedCategory === 'recommendations' ? '#FFFFFF' : '#666666')
            }
          }
          .height(32)
          .padding({ left: 12, right: 12 })
          .backgroundColor(this.selectedCategory === 'recommendations' ? '#FF6B35' : '#F0F0F0')
          .borderRadius(16)
          .onClick(() => {
            this.selectedCategory = 'recommendations';
          })

          Button() {
            Row({ space: 4 }) {
              Text('ðŸ•’')
                .fontSize(12)
              Text('æœ€è¿‘ä½¿ç”¨')
                .fontSize(13)
                .fontColor(this.selectedCategory === 'recent' ? '#FFFFFF' : '#666666')
            }
          }
          .height(32)
          .padding({ left: 12, right: 12 })
          .backgroundColor(this.selectedCategory === 'recent' ? '#34C759' : '#F0F0F0')
          .borderRadius(16)
          .onClick(() => {
            this.selectedCategory = 'recent';
          })

          Button() {
            Row({ space: 4 }) {
              Text('ðŸŽ¤')
                .fontSize(12)
              Text('è¯­éŸ³å¸¸ç”¨')
                .fontSize(13)
                .fontColor(this.selectedCategory === 'voice' ? '#FFFFFF' : '#666666')
            }
          }
          .height(32)
          .padding({ left: 12, right: 12 })
          .backgroundColor(this.selectedCategory === 'voice' ? '#5856D6' : '#F0F0F0')
          .borderRadius(16)
          .onClick(() => {
            this.selectedCategory = 'voice';
          })
        } else {
          // å…¨éƒ¨åˆ†ç±»
          Button() {
            Text('å…¨éƒ¨')
              .fontSize(13)
              .fontColor(this.selectedCategory === 'all' ? '#FFFFFF' : '#666666')
          }
          .height(32)
          .padding({ left: 16, right: 16 })
          .backgroundColor(this.selectedCategory === 'all' ? '#007AFF' : '#F0F0F0')
          .borderRadius(16)
          .onClick(() => {
            this.selectedCategory = 'all';
          })
          
          // å„ä¸ªåˆ†ç±»
          ForEach(this.categories, (category: PromptCategory) => {
            Button() {
              Row({ space: 4 }) {
                Text(category.icon)
                  .fontSize(12)
                Text(category.name)
                  .fontSize(13)
                  .fontColor(this.selectedCategory === category.id ? '#FFFFFF' : '#666666')
              }
            }
            .height(32)
            .padding({ left: 12, right: 12 })
            .backgroundColor(this.selectedCategory === category.id ? category.color : '#F0F0F0')
            .borderRadius(16)
            .onClick(() => {
              this.selectedCategory = category.id;
            })
          }, (category: PromptCategory) => category.id)
        }
      }
      .padding({ left: 20, right: 20 })
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off)
    .align(Alignment.TopStart)
    .edgeEffect(EdgeEffect.Spring)
    .width('100%')
    .margin({ bottom: 12 })
  }

  @Builder
  buildContentList() {
    Scroll() {
      Column({ space: 8 }) {
        if (this.showPrompts) {
          // æ˜¾ç¤ºPromptæ¨¡æ¿
          ForEach(this.getFilteredPrompts(), (prompt: PromptTemplate, index: number) => {
            this.buildPromptItem(prompt, index)
          }, (prompt: PromptTemplate) => prompt.id)
        } else {
          // æ˜¾ç¤ºå¿«æ·å‘½ä»¤
          ForEach(this.getFilteredCommands(), (command: QuickCommand, index: number) => {
            this.buildCommandItem(command, index)
          }, (command: QuickCommand) => command.id)
        }
      }
      .align(Alignment.TopStart)
      .justifyContent(FlexAlign.Start)
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 16 })
    }
    .align(Alignment.TopStart)
    .layoutWeight(1)
  }

  @Builder
  buildPromptItem(prompt: PromptTemplate, index: number) {
    Row({ space: 12 }) {
      // å·¦ä¾§å›¾æ ‡åŒºåŸŸ
      Stack() {
        Circle()
          .width(44)
          .height(44)
          .fill(prompt.backgroundColor)
        
        Text(prompt.icon)
          .fontSize(18)
      }
      
      // å³ä¾§å†…å®¹åŒºåŸŸ
      Column({ space: 4 }) {
        Row() {
          // è·‘é©¬ç¯æ•ˆæžœæ˜¾ç¤ºé•¿æ ‡é¢˜
          Text(prompt.title)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
            .textAlign(TextAlign.Start)
            .layoutWeight(1)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.MARQUEE })
          
          // åˆ†ç±»æ ‡ç­¾
          Text(prompt.category.name)
            .fontSize(11)
            .fontColor(prompt.category.color)
            .backgroundColor(`${prompt.category.color}20`)
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(8)
            .margin({ left: 8 })
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
        
        Text(prompt.description)
          .fontSize(12)
          .fontColor('#666666')
          .textAlign(TextAlign.Start)
          .width('100%')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // å³ä¾§ç®­å¤´
      Text('â€º')
        .fontSize(18)
        .fontColor('#CCCCCC')
    }
    .width('100%')
    .height(68)
    .padding({ left: 12, right: 12 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .border({
      width: 1,
      color: '#F0F0F0'
    })
    .stateStyles({
      normal: {
        .backgroundColor(Color.White)
        .scale({ x: 1, y: 1 })
      },
      pressed: {
        .backgroundColor('#F8F9FA')
        .scale({ x: 0.98, y: 0.98 })
      }
    })
    .animation({
      duration: 150,
      curve: Curve.FastOutSlowIn
    })
    .onClick(() => {
      this.executePrompt(prompt);
    })
  }

  @Builder
  buildCommandItem(command: QuickCommand, index: number) {
    Row({ space: 16 }) {
      // å·¦ä¾§å›¾æ ‡åŒºåŸŸ
      Stack() {
        Circle()
          .width(48)
          .height(48)
          .fill(command.backgroundColor)
        
        Text(command.icon)
          .fontSize(20)
          .fontColor(command.color)
      }
      
      // å³ä¾§å†…å®¹åŒºåŸŸ
      Column({ space: 4 }) {
        Text(command.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .textAlign(TextAlign.Start)
          .width('100%')
        
        Text(command.subtitle)
          .fontSize(13)
          .fontColor('#666666')
          .textAlign(TextAlign.Start)
          .width('100%')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // å³ä¾§ç®­å¤´
      Text('â€º')
        .fontSize(20)
        .fontColor('#CCCCCC')
    }
    .width('100%')
    .height(72)
    .padding({ left: 12, right: 12 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .border({
      width: 1,
      color: '#F0F0F0'
    })
    .margin({ top: index > 0 ? 8 : 0 })
    .stateStyles({
      normal: {
        .backgroundColor(Color.White)
        .scale({ x: 1, y: 1 })
      },
      pressed: {
        .backgroundColor('#F8F9FA')
        .scale({ x: 0.98, y: 0.98 })
      }
    })
    .animation({
      duration: 150,
      curve: Curve.FastOutSlowIn
    })
    .onClick(() => {
      this.executeCommand(command);
    })
  }


  private executeCommand(command: QuickCommand): void {
    // å…ˆå…³é—­é¢æ¿
    this.closePanel();
    
    // å»¶è¿Ÿæ‰§è¡Œå‘½ä»¤ï¼Œç¡®ä¿å…³é—­åŠ¨ç”»å®Œæˆ
    setTimeout(() => {
      command.action();
    }, 200);
  }

  private async executePrompt(prompt: PromptTemplate): Promise<void> {
    // è®°å½•ä½¿ç”¨ç»Ÿè®¡
    await this.recommendationManager.recordPromptUsage(prompt.id, false);
    
    // å…ˆå…³é—­é¢æ¿
    this.closePanel();
    
    // å»¶è¿Ÿæ‰§è¡ŒPrompté€‰æ‹©ï¼Œç¡®ä¿å…³é—­åŠ¨ç”»å®Œæˆ
    setTimeout(() => {
      if (this.onPromptSelected) {
        this.onPromptSelected(prompt.prompt);
      }
    }, 200);
  }

  private getFilteredPrompts(): PromptTemplate[] {
    if (this.showRecommendations) {
      return this.getRecommendationPrompts();
    }

    let filtered = this.promptTemplates;
    
    // æŒ‰åˆ†ç±»è¿‡æ»¤
    if (this.selectedCategory !== 'all') {
      filtered = filtered.filter(prompt => prompt.category.id === this.selectedCategory);
    }
    
    // æŒ‰æœç´¢æ–‡æœ¬è¿‡æ»¤
    if (this.searchText.length > 0) {
      const searchLower = this.searchText.toLowerCase();
      filtered = filtered.filter(prompt => 
        prompt.title.toLowerCase().includes(searchLower) ||
        prompt.description.toLowerCase().includes(searchLower) ||
        prompt.prompt.toLowerCase().includes(searchLower) ||
        (prompt.voiceTriggers && prompt.voiceTriggers.some(trigger => 
          trigger.toLowerCase().includes(searchLower)
        ))
      );
    }
    
    // ä½¿ç”¨é¢‘çŽ‡æŽ’åº
    return this.recommendationManager.getFrequencyBasedSorting(filtered);
  }

  private getRecommendationPrompts(): PromptTemplate[] {
    switch (this.selectedCategory) {
      case 'recommendations':
        return this.recommendationManager.getPersonalizedRecommendations(8);
      case 'recent':
        return this.recommendationManager.getRecentlyUsedPrompts(6);
      case 'voice':
        return this.recommendationManager.getVoiceBasedRecommendations();
      default:
        return this.recommendationManager.getPersonalizedRecommendations(8);
    }
  }

  private getFilteredCommands(): QuickCommand[] {
    let filtered = this.commands;
    
    // æŒ‰æœç´¢æ–‡æœ¬è¿‡æ»¤
    if (this.searchText.length > 0) {
      const searchLower = this.searchText.toLowerCase();
      filtered = filtered.filter(command => 
        command.title.toLowerCase().includes(searchLower) ||
        command.subtitle.toLowerCase().includes(searchLower)
      );
    }
    
    return filtered;
  }


  private closePanel(): void {
    this.showAnimation = false;
    
    // å»¶è¿Ÿè°ƒç”¨onCloseï¼Œç¡®ä¿åŠ¨ç”»å®Œæˆ
    setTimeout(() => {
      this.onClose();
    }, 300);
  }
}