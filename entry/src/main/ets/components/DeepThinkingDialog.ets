/**
 * æ·±åº¦æ€è€ƒå¯¹è¯æ¡†ç»„ä»¶
 */

import { ThinkingStep, ThinkingStatus, StepStatus, Message } from '../models/ChatModels';
import { ThinkingProcessComponent } from './ThinkingProcessComponent';
import { Logger } from '../utils/Logger';
import { pasteboard } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';

// å¯¹è¯æ¡†å‚æ•°
@ObservedV2
class DeepThinkingDialogParams {
  @Trace isShowing: boolean = false;
  @Trace message: Message | null = null;
  @Trace autoScroll: boolean = true;
}

@ComponentV2
export struct DeepThinkingDialog {
  @Param @Require isShowing: boolean;
  @Param message: Message | null = null;
  @Param onClose: () => void = () => {};
  @Param onShowDetails: (step: ThinkingStep) => void = () => {};

  @Local autoScroll: boolean = true;
  @Local lastStepCount: number = 0;

  aboutToAppear() {
    Logger.info('DeepThinkingDialog', `å¯¹è¯æ¡†çŠ¶æ€: ${this.isShowing}`);
  }

  aboutToDisappear() {
    Logger.info('DeepThinkingDialog', 'å¯¹è¯æ¡†å…³é—­');
  }

  build() {
    if (this.isShowing && this.message) {
      Stack() {
        // èƒŒæ™¯é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.onClose();
          })

        // å¯¹è¯æ¡†å†…å®¹
        Column() {
          // æ ‡é¢˜æ 
          this.buildHeader()

          // å†…å®¹åŒºåŸŸ
          if (this.message?.thinkingSteps && this.message.thinkingSteps.length > 0) {
            this.buildContent()
          } else {
            this.buildEmptyContent()
          }

          // åº•éƒ¨æ“ä½œæ 
          this.buildFooter()
        }
        .width('90%')
        .constraintSize({ maxWidth: 600 })
        .height('70%')
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .shadow({
          radius: 20,
          color: 'rgba(0, 0, 0, 0.1)',
          offsetX: 0,
          offsetY: 8
        })
        .onClick((event: ClickEvent) => {
          // åœæ­¢äº‹ä»¶ä¼ æ’­
        })
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(1000)
    }
  }

  @Builder
  private buildHeader() {
    Row() {
      Column() {
        Row() {
          Text('ğŸ§ ')
            .fontSize(24)
            .margin({ right: 8 })
          
          Column() {
            Text('æ·±åº¦æ€è€ƒè¿‡ç¨‹')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2D3142')
            
            if (this.message?.thinkingStatus !== ThinkingStatus.COMPLETED && 
                this.message?.thinkingStatus !== ThinkingStatus.FAILED) {
              Text('å®æ—¶æ›´æ–°ä¸­...')
                .fontSize(12)
                .fontColor('#666')
                .margin({ top: 2 })
            }
          }
          .alignItems(HorizontalAlign.Start)
        }
        .alignItems(VerticalAlign.Center)
      }
      .alignItems(HorizontalAlign.Start)

      // å…³é—­æŒ‰é’®
      Button() {
        Text('âœ•')
          .fontSize(20)
          .fontColor('#666')
      }
      .width(32)
      .height(32)
      .backgroundColor('#F3F4F6')
      .borderRadius(16)
      .onClick(() => {
        this.onClose();
      })
    }
    .width('100%')
    .padding({ left: 20, right: 16, top: 20, bottom: 16 })
    .justifyContent(FlexAlign.SpaceBetween)
  }

  @Builder
  private buildContent() {
    Scroll() {
      Column() {
        // æ•´ä½“çŠ¶æ€ä¿¡æ¯
        this.buildStatusInfo()

        // æ€è€ƒæ­¥éª¤
        ThinkingProcessComponent({
          thinkingSteps: this.message?.thinkingSteps || [],
          thinkingStatus: this.message?.thinkingStatus || ThinkingStatus.IDLE,
          showDetails: true,
          compact: false,
          onStepTap: (step: ThinkingStep) => {
            this.onShowDetails(step);
          }
        })

        // å¦‚æœæ€è€ƒå®Œæˆï¼Œæ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆé¢„è§ˆ
        if (this.message?.thinkingStatus === ThinkingStatus.COMPLETED && 
            this.message?.content) {
          this.buildFinalAnswerPreview()
        }
      }
      .width('100%')
      .padding(16)
    }
    .width('100%')
    .layoutWeight(1)
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }

  @Builder
  private buildEmptyContent() {
    Column() {
      Text('â³')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æ­£åœ¨å‡†å¤‡æ·±åº¦æ€è€ƒè¿‡ç¨‹...')
        .fontSize(16)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
      
      LoadingProgress()
        .width(40)
        .height(40)
        .margin({ top: 20 })
        .color($r('app.color.primary_color'))
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  private buildStatusInfo() {
    if (this.message?.thinkingStatus) {
      Column() {
        Row() {
          Text(this.getStatusIcon(this.message?.thinkingStatus || ThinkingStatus.IDLE))
            .fontSize(16)
            .margin({ right: 8 })
          
          Text(this.getStatusText(this.message?.thinkingStatus || ThinkingStatus.IDLE))
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#2D3142')
          
          Blank()
          
          // æ­¥éª¤è¿›åº¦
          if (this.message?.thinkingSteps && this.message.thinkingSteps.length > 0) {
            Text(`${this.getCompletedStepsCount()}/${this.message.thinkingSteps.length}`)
              .fontSize(12)
              .fontColor('#666')
              .backgroundColor('#F3F4F6')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
          }
        }
        .width('100%')
        
        // çŠ¶æ€æè¿°
        Text(this.getStatusDescription(this.message?.thinkingStatus || ThinkingStatus.IDLE))
          .fontSize(12)
          .fontColor('#666')
          .margin({ top: 4 })
      }
      .width('100%')
      .padding(12)
      .backgroundColor('#F8F9FF')
      .borderRadius(8)
      .margin({ bottom: 12 })
    }
  }

  @Builder
  private buildFinalAnswerPreview() {
    Column() {
      Row() {
        Text('âœ¨')
          .fontSize(16)
          .margin({ right: 8 })
        
        Text('æœ€ç»ˆç­”æ¡ˆ')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#2D3142')
      }
      .width('100%')
      .margin({ bottom: 8 })

      // æ˜¾ç¤ºç­”æ¡ˆçš„å‰å‡ è¡Œä½œä¸ºé¢„è§ˆ
      Text(((this.message?.content || '') as string).substring(0, 200) + (((this.message?.content || '') as string).length > 200 ? '...' : ''))
        .fontSize(12)
        .fontColor('#374151')
        .lineHeight(16)
        .width('100%')
        .padding(12)
        .backgroundColor('#F9FAFB')
        .borderRadius(6)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#F0FDF4')
    .borderRadius(8)
    .margin({ top: 12 })
  }

  @Builder
  private buildFooter() {
    Row() {
      // è‡ªåŠ¨æ»šåŠ¨å¼€å…³
      Row() {
        Text('è‡ªåŠ¨æ»šåŠ¨')
          .fontSize(12)
          .fontColor('#666')
        
        Toggle({ type: ToggleType.Switch, isOn: this.autoScroll })
          .width(36)
          .height(20)
          .onChange((isOn: boolean) => {
            this.autoScroll = isOn;
          })
      }
      .margin({ left: 16 })

      Blank()

      // æ“ä½œæŒ‰é’®
      Row() {
        // å¤åˆ¶æ€è€ƒè¿‡ç¨‹
        Button() {
          Text('ğŸ“‹ å¤åˆ¶')
            .fontSize(12)
        }
        .width(80)
        .height(32)
        .fontSize(12)
        .backgroundColor('#F3F4F6')
        .fontColor('#374151')
        .borderRadius(16)
        .onClick(() => {
          this.copyThinkingProcess();
        })

        // å…³é—­æŒ‰é’®
        Button() {
          Text('å…³é—­')
            .fontSize(12)
        }
        .width(60)
        .height(32)
        .fontSize(12)
        .backgroundColor($r('app.color.primary_color'))
        .fontColor(Color.White)
        .borderRadius(16)
        .onClick(() => {
          this.onClose();
        })
        .margin({ left: 8 })
      }
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 12, bottom: 16 })
    .backgroundColor('#F9FAFB')
    .borderRadius({ bottomLeft: 16, bottomRight: 16 })
  }

  // å·¥å…·æ–¹æ³•
  private getCompletedStepsCount(): number {
    if (!this.message?.thinkingSteps || this.message.thinkingSteps.length === 0) return 0;
    return this.message.thinkingSteps.filter(s => s.status === StepStatus.COMPLETED).length;
  }

  private getStatusIcon(status: ThinkingStatus): string {
    switch (status) {
      case ThinkingStatus.ANALYZING: return 'ğŸ”';
      case ThinkingStatus.THINKING: return 'ğŸ§ ';
      case ThinkingStatus.VERIFYING: return 'âœ…';
      case ThinkingStatus.INTEGRATING: return 'ğŸ¯';
      case ThinkingStatus.COMPLETED: return 'âœ¨';
      case ThinkingStatus.FAILED: return 'âŒ';
      case ThinkingStatus.CANCELLED: return 'â¹ï¸';
      default: return 'ğŸ’­';
    }
  }

  private getStatusText(status: ThinkingStatus): string {
    switch (status) {
      case ThinkingStatus.ANALYZING: return 'æ·±åº¦åˆ†æ';
      case ThinkingStatus.THINKING: return 'å¤šè§’åº¦æ€è€ƒ';
      case ThinkingStatus.VERIFYING: return 'æ‰¹åˆ¤æ€§éªŒè¯';
      case ThinkingStatus.INTEGRATING: return 'ç»¼åˆæ•´åˆ';
      case ThinkingStatus.COMPLETED: return 'æ€è€ƒå®Œæˆ';
      case ThinkingStatus.FAILED: return 'æ€è€ƒå¤±è´¥';
      case ThinkingStatus.CANCELLED: return 'æ€è€ƒå–æ¶ˆ';
      default: return 'å‡†å¤‡æ€è€ƒ';
    }
  }

  private getStatusDescription(status: ThinkingStatus): string {
    switch (status) {
      case ThinkingStatus.ANALYZING: return 'æ­£åœ¨åˆ†æé—®é¢˜çš„æ ¸å¿ƒè¦ç‚¹å’Œå…³é”®ä¿¡æ¯';
      case ThinkingStatus.THINKING: return 'æ­£åœ¨ä»å¤šä¸ªè§’åº¦æ·±å…¥æ€è€ƒå¯èƒ½çš„è§£å†³æ–¹æ¡ˆ';
      case ThinkingStatus.VERIFYING: return 'æ­£åœ¨æ‰¹åˆ¤æ€§åœ°éªŒè¯å’Œåé©³å‰é¢çš„æ€è€ƒç»“æœ';
      case ThinkingStatus.INTEGRATING: return 'æ­£åœ¨æ•´åˆæ‰€æœ‰æ€è€ƒç»“æœï¼Œæä¾›æœ€ç»ˆç­”æ¡ˆ';
      case ThinkingStatus.COMPLETED: return 'æ·±åº¦æ€è€ƒè¿‡ç¨‹å·²æˆåŠŸå®Œæˆ';
      case ThinkingStatus.FAILED: return 'æ·±åº¦æ€è€ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯';
      case ThinkingStatus.CANCELLED: return 'æ·±åº¦æ€è€ƒè¿‡ç¨‹å·²è¢«ç”¨æˆ·å–æ¶ˆ';
      default: return 'æ­£åœ¨å‡†å¤‡æ·±åº¦æ€è€ƒè¿‡ç¨‹';
    }
  }

  private copyThinkingProcess(): void {
    if (!this.message?.thinkingSteps) return;
    
    let processText = 'æ·±åº¦æ€è€ƒè¿‡ç¨‹\n';
    processText += '=' .repeat(50) + '\n\n';
    
    for (const step of this.message?.thinkingSteps || []) {
      processText += `${step.title}\n`;
      processText += '-'.repeat(30) + '\n';
      processText += `${step.description}\n\n`;
      
      if (step.content) {
        processText += `æ€è€ƒå†…å®¹ï¼š\n${step.content}\n\n`;
      }
      
      if (step.status === StepStatus.COMPLETED && step.duration) {
        processText += `è€—æ—¶ï¼š${(step.duration / 1000).toFixed(1)}ç§’\n`;
      }
      
      processText += '\n' + '='.repeat(50) + '\n\n';
    }
    
    if (this.message?.content) {
      processText += `æœ€ç»ˆç­”æ¡ˆï¼š\n${this.message.content}`;
    }
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    try {
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, processText);
      const systemPasteboard = pasteboard.getSystemPasteboard();
      systemPasteboard.setData(pasteData).then(() => {
        Logger.info('DeepThinkingDialog', 'æ€è€ƒè¿‡ç¨‹å¤åˆ¶æˆåŠŸ');
        promptAction.showToast({
          message: 'æ€è€ƒè¿‡ç¨‹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
          duration: 2000
        });
      }).catch((error: Error) => {
        Logger.error('DeepThinkingDialog', `å¤åˆ¶å¤±è´¥: ${error.message}`);
        promptAction.showToast({
          message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•',
          duration: 2000
        });
      });
    } catch (error) {
      const err = error as Error;
      Logger.error('DeepThinkingDialog', `å¤åˆ¶å¼‚å¸¸: ${err.message}`);
      promptAction.showToast({
        message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }
}