import { SystemPrompt } from '../models/ChatModels';
import { AppStorage } from './AppStorage';
import { Logger } from './Logger';
import { DefaultPrompts } from '../data/DefaultPrompts';
import { PromptsConfigManager } from './PromptsConfigManager';

/**
 * è§’è‰²åˆ†ç±»æšä¸¾
 */
export enum RoleCategory {
  PROFESSIONAL = 'professional',  // ä¸“ä¸šè§’è‰²
  CHARACTER = 'character',      // äººç‰©è§’è‰²
  CUSTOM = 'custom'             // è‡ªå®šä¹‰è§’è‰²
}

/**
 * è§’è‰²æ’åºé€‰é¡¹
 */
export interface RoleSortOption {
  field: 'usageCount' | 'timestamp' | 'name' | 'pinned';
  order: 'asc' | 'desc';
}

/**
 * è§’è‰²ç»Ÿè®¡ä¿¡æ¯
 */
export interface RoleStats {
  totalRoles: number;
  totalUsage: number;
  categoryStats: Record<string, number>;
  mostUsedRole: SystemPrompt | null;
}

/**
 * è§’è‰²ç­›é€‰é€‰é¡¹
 */
export interface RoleFilterOptions {
  category?: RoleCategory;
  searchQuery?: string;
  isPinned?: boolean;
  isBuiltIn?: boolean;
}

/**
 * è§’è‰²ç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†AIè§’è‰²ï¼ˆç³»ç»Ÿæç¤ºè¯ï¼‰
 */
export class RoleManager {
  private static instance: RoleManager | null = null;

  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance(): RoleManager {
    if (!RoleManager.instance) {
      RoleManager.instance = new RoleManager();
    }
    return RoleManager.instance;
  }

  /**
   * è·å–æ‰€æœ‰è§’è‰²
   */
  async getAllRoles(): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', 'è·å–æ‰€æœ‰è§’è‰²');
      const allPrompts = await AppStorage.getSystemPrompts();
      Logger.info('RoleManager', `ä»å­˜å‚¨è·å–åˆ° ${allPrompts.length} ä¸ªç³»ç»Ÿæç¤ºè¯`);

      const rolePrompts = allPrompts.filter(role => role.isRole);
      Logger.info('RoleManager', `å…¶ä¸­æ ‡è®°ä¸ºè§’è‰²çš„æœ‰ ${rolePrompts.length} ä¸ª`);

      // å¦‚æœå‘ç°æœ‰ç³»ç»Ÿæç¤ºè¯æ²¡æœ‰æ ‡è®°ä¸ºè§’è‰²ï¼Œè®°å½•æ—¥å¿—
      const nonRolePrompts = allPrompts.filter(prompt => !prompt.isRole);
      if (nonRolePrompts.length > 0) {
        Logger.warn('RoleManager', `å‘ç° ${nonRolePrompts.length} ä¸ªç³»ç»Ÿæç¤ºè¯æœªæ ‡è®°ä¸ºè§’è‰²:`);
        nonRolePrompts.forEach((prompt, index) => {
          Logger.warn('RoleManager', `  [${index + 1}] ${prompt.name} (ID: ${prompt.id})`);
        });
      }

      return rolePrompts; // åªè¿”å›è§’è‰²ç±»å‹çš„æç¤ºè¯
    } catch (error) {
      Logger.error('RoleManager', `è·å–è§’è‰²åˆ—è¡¨å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * æŒ‰åˆ†ç±»è·å–è§’è‰²
   */
  async getRolesByCategory(category: RoleCategory): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `è·å–åˆ†ç±»è§’è‰²: ${category}`);
      const allRoles = await this.getAllRoles();
      const filteredRoles = allRoles.filter(role => role.roleCategory === category);
      Logger.info('RoleManager', `åˆ†ç±» ${category} æœ‰ ${filteredRoles.length} ä¸ªè§’è‰²`);
      return filteredRoles;
    } catch (error) {
      Logger.error('RoleManager', `è·å–åˆ†ç±»è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * ç­›é€‰è§’è‰²
   */
  async filterRoles(options: RoleFilterOptions): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `ç­›é€‰è§’è‰²ï¼Œé€‰é¡¹: ${JSON.stringify(options)}`);
      let roles = await this.getAllRoles();

      // æŒ‰åˆ†ç±»ç­›é€‰
      if (options.category) {
        roles = roles.filter(role => role.roleCategory === options.category);
      }

      // æŒ‰ç½®é¡¶çŠ¶æ€ç­›é€‰
      if (options.isPinned !== undefined) {
        roles = roles.filter(role => role.isPinned === options.isPinned);
      }

      // æŒ‰å†…ç½®çŠ¶æ€ç­›é€‰
      if (options.isBuiltIn !== undefined) {
        roles = roles.filter(role => role.isBuiltIn === options.isBuiltIn);
      }

      // æŒ‰æœç´¢æŸ¥è¯¢ç­›é€‰
      if (options.searchQuery && options.searchQuery.trim()) {
        const query = options.searchQuery.toLowerCase().trim();
        roles = roles.filter(role =>
          role.name.toLowerCase().includes(query) ||
          role.content.toLowerCase().includes(query) ||
          role.roleDescription.toLowerCase().includes(query)
        );
      }

      Logger.info('RoleManager', `ç­›é€‰åå¾—åˆ° ${roles.length} ä¸ªè§’è‰²`);
      return roles;
    } catch (error) {
      Logger.error('RoleManager', `ç­›é€‰è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * æ’åºè§’è‰²
   */
  sortRoles(roles: SystemPrompt[], sortOption: RoleSortOption): SystemPrompt[] {
    try {
      Logger.info('RoleManager', `æ’åºè§’è‰²ï¼Œé€‰é¡¹: ${JSON.stringify(sortOption)}`);

      const sortedRoles = [...roles].sort((a, b) => {
        let valueA: number | string, valueB: number | string;

        switch (sortOption.field) {
          case 'usageCount':
            valueA = a.usageCount;
            valueB = b.usageCount;
            break;
          case 'timestamp':
            valueA = a.timestamp;
            valueB = b.timestamp;
            break;
          case 'name':
            valueA = a.name.toLowerCase();
            valueB = b.name.toLowerCase();
            break;
          case 'pinned':
            valueA = a.isPinned ? 1 : 0;
            valueB = b.isPinned ? 1 : 0;
            break;
          default:
            valueA = a.timestamp;
            valueB = b.timestamp;
        }

        if (sortOption.order === 'asc') {
          return valueA > valueB ? 1 : -1;
        } else {
          return valueA < valueB ? 1 : -1;
        }
      });

      Logger.info('RoleManager', 'è§’è‰²æ’åºå®Œæˆ');
      return sortedRoles;
    } catch (error) {
      Logger.error('RoleManager', `æ’åºè§’è‰²å¤±è´¥: ${error}`);
      return roles;
    }
  }

  /**
   * æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
   */
  async isRoleNameExists(name: string, excludeRoleId?: string): Promise<boolean> {
    try {
      Logger.debug('RoleManager', `æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å­˜åœ¨: ${name}`);

      const allRoles = await this.getAllRoles();
      const trimmedName = name.trim();

      // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤åç§°ï¼ˆæ’é™¤æŒ‡å®šçš„è§’è‰²IDï¼Œç”¨äºæ›´æ–°åœºæ™¯ï¼‰
      const existingRole = allRoles.find(role =>
        role.name.toLowerCase() === trimmedName.toLowerCase() &&
        role.id !== excludeRoleId
      );

      const exists = !!existingRole;
      Logger.debug('RoleManager', `è§’è‰²åç§° "${trimmedName}" ${exists ? 'å·²å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
      return exists;
    } catch (error) {
      Logger.error('RoleManager', `æ£€æŸ¥è§’è‰²åç§°å­˜åœ¨æ€§å¤±è´¥: ${error}`);
      return false;
    }
  }

  /**
   * åˆ›å»ºæ–°è§’è‰²
   */
  async createRole(name: string, content: string, category: RoleCategory = RoleCategory.CUSTOM,
                   roleIcon: string = '', roleDescription: string = ''): Promise<SystemPrompt> {
    try {
      Logger.info('RoleManager', `åˆ›å»ºæ–°è§’è‰²: ${name}`);

      // æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å·²å­˜åœ¨
      if (await this.isRoleNameExists(name)) {
        throw new Error(`è§’è‰²åç§° "${name.trim()}" å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`);
      }

      // æ³¨æ„ï¼šæ­¤æ–¹æ³•æ²¡æœ‰è§’è‰²æ•°é‡é™åˆ¶ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„è§’è‰²

      const newRole = new SystemPrompt(
        name.trim(),
        content.trim(),
        undefined, // è‡ªåŠ¨ç”ŸæˆID
        true,     // isRole = true
        category,
        roleIcon || this.getDefaultIconForCategory(category),
        roleDescription || name,
        false    // isBuiltIn = false
      );

      await AppStorage.addSystemPrompt(newRole);
      Logger.info('RoleManager', `è§’è‰²åˆ›å»ºæˆåŠŸ: ${newRole.id}`);
      return newRole;
    } catch (error) {
      Logger.error('RoleManager', `åˆ›å»ºè§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * æ›´æ–°è§’è‰²
   */
  async updateRole(role: SystemPrompt): Promise<void> {
    try {
      Logger.info('RoleManager', `æ›´æ–°è§’è‰²: ${role.name}`);

      // æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ’é™¤å½“å‰è§’è‰²IDï¼‰
      if (await this.isRoleNameExists(role.name, role.id)) {
        throw new Error(`è§’è‰²åç§° "${role.name.trim()}" å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`);
      }

      // ç¡®ä¿æ˜¯è§’è‰²ç±»å‹
      role.isRole = true;
      role.timestamp = Date.now(); // æ›´æ–°æ—¶é—´æˆ³

      await AppStorage.updateSystemPrompt(role);
      Logger.info('RoleManager', `è§’è‰²æ›´æ–°æˆåŠŸ: ${role.id}`);
    } catch (error) {
      Logger.error('RoleManager', `æ›´æ–°è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * åˆ é™¤è§’è‰²
   */
  async deleteRole(roleId: string): Promise<void> {
    try {
      Logger.info('RoleManager', `åˆ é™¤è§’è‰²: ${roleId}`);

      // æ£€æŸ¥æ˜¯å¦ä¸ºå†…ç½®è§’è‰²
      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role && role.isBuiltIn) {
        throw new Error('ä¸èƒ½åˆ é™¤å†…ç½®è§’è‰²');
      }

      // åˆ é™¤è§’è‰²
      await AppStorage.deleteSystemPrompt(roleId);

      // åŒæ—¶ä»å·²åº”ç”¨è§’è‰²åˆ—è¡¨ä¸­ç§»é™¤
      await this.removeRoleFromSidebar(roleId);

      Logger.info('RoleManager', `è§’è‰²åˆ é™¤æˆåŠŸ: ${roleId}`);
    } catch (error) {
      Logger.error('RoleManager', `åˆ é™¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * å†…éƒ¨æ–¹æ³•ï¼šå¼ºåˆ¶åˆ é™¤è§’è‰²ï¼ˆåŒ…æ‹¬å†…ç½®è§’è‰²ï¼Œä»…ä¾›å†…éƒ¨é‡ç½®ä½¿ç”¨ï¼‰
   */
  private async forceDeleteRole(roleId: string): Promise<void> {
    try {
      await AppStorage.deleteSystemPrompt(roleId);
      Logger.info('RoleManager', `å¼ºåˆ¶åˆ é™¤è§’è‰²æˆåŠŸ: ${roleId}`);
    } catch (error) {
      Logger.error('RoleManager', `å¼ºåˆ¶åˆ é™¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * å¢åŠ è§’è‰²ä½¿ç”¨ç»Ÿè®¡
   */
  async incrementRoleUsage(roleId: string): Promise<void> {
    try {
      Logger.debug('RoleManager', `å¢åŠ è§’è‰²ä½¿ç”¨ç»Ÿè®¡: ${roleId}`);

      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role) {
        role.usageCount++;
        role.timestamp = Date.now();
        await AppStorage.updateSystemPrompt(role);
        Logger.debug('RoleManager', `è§’è‰² ${roleId} ä½¿ç”¨æ¬¡æ•°: ${role.usageCount}`);
      }
    } catch (error) {
      Logger.error('RoleManager', `å¢åŠ è§’è‰²ä½¿ç”¨ç»Ÿè®¡å¤±è´¥: ${error}`);
    }
  }

  /**
   * è®¾ç½®è§’è‰²ç½®é¡¶çŠ¶æ€
   */
  async pinRole(roleId: string, pinned: boolean): Promise<void> {
    try {
      Logger.info('RoleManager', `è®¾ç½®è§’è‰²ç½®é¡¶çŠ¶æ€: ${roleId} -> ${pinned}`);

      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role) {
        role.isPinned = pinned;
        role.timestamp = Date.now();
        await AppStorage.updateSystemPrompt(role);
        Logger.info('RoleManager', `è§’è‰²ç½®é¡¶çŠ¶æ€è®¾ç½®æˆåŠŸ: ${roleId}`);
      }
    } catch (error) {
      Logger.error('RoleManager', `è®¾ç½®è§’è‰²ç½®é¡¶çŠ¶æ€å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * è·å–è§’è‰²è¯¦æƒ…
   */
  async getRoleById(roleId: string): Promise<SystemPrompt | null> {
    try {
      Logger.debug('RoleManager', `è·å–è§’è‰²è¯¦æƒ…: ${roleId}`);

      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role) {
        Logger.debug('RoleManager', `æ‰¾åˆ°è§’è‰²: ${role.name}`);
        return role;
      }

      Logger.warn('RoleManager', `æœªæ‰¾åˆ°è§’è‰²: ${roleId}`);
      return null;
    } catch (error) {
      Logger.error('RoleManager', `è·å–è§’è‰²è¯¦æƒ…å¤±è´¥: ${error}`);
      return null;
    }
  }

  /**
   * æœç´¢è§’è‰²
   */
  async searchRoles(query: string): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `æœç´¢è§’è‰²: ${query}`);

      if (!query || !query.trim()) {
        return await this.getAllRoles();
      }

      const options: RoleFilterOptions = {
        searchQuery: query.trim()
      };

      const results = await this.filterRoles(options);
      Logger.info('RoleManager', `æœç´¢åˆ° ${results.length} ä¸ªè§’è‰²`);
      return results;
    } catch (error) {
      Logger.error('RoleManager', `æœç´¢è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–æœ€å¸¸ç”¨çš„è§’è‰²
   */
  async getMostUsedRoles(limit: number = 5): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `è·å–æœ€å¸¸ç”¨çš„ ${limit} ä¸ªè§’è‰²`);

      const roles = await this.getAllRoles();
      const sortedRoles = this.sortRoles(roles, {
        field: 'usageCount',
        order: 'desc'
      });

      return sortedRoles.slice(0, limit);
    } catch (error) {
      Logger.error('RoleManager', `è·å–æœ€å¸¸ç”¨è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–æœ€è¿‘ä½¿ç”¨çš„è§’è‰²
   */
  async getRecentRoles(limit: number = 5): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `è·å–æœ€è¿‘ä½¿ç”¨çš„ ${limit} ä¸ªè§’è‰²`);

      const roles = await this.getAllRoles();
      const sortedRoles = this.sortRoles(roles, {
        field: 'timestamp',
        order: 'desc'
      });

      return sortedRoles.slice(0, limit);
    } catch (error) {
      Logger.error('RoleManager', `è·å–æœ€è¿‘ä½¿ç”¨è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–ç½®é¡¶è§’è‰²
   */
  async getPinnedRoles(): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', 'è·å–ç½®é¡¶è§’è‰²');

      const options: RoleFilterOptions = {
        isPinned: true
      };

      const pinnedRoles = await this.filterRoles(options);
      const sortedRoles = this.sortRoles(pinnedRoles, {
        field: 'timestamp',
        order: 'desc'
      });

      Logger.info('RoleManager', `æ‰¾åˆ° ${sortedRoles.length} ä¸ªç½®é¡¶è§’è‰²`);
      return sortedRoles;
    } catch (error) {
      Logger.error('RoleManager', `è·å–ç½®é¡¶è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–è§’è‰²ç»Ÿè®¡ä¿¡æ¯
   */
  async getRoleStats(): Promise<RoleStats> {
    try {
      Logger.info('RoleManager', 'è·å–è§’è‰²ç»Ÿè®¡ä¿¡æ¯');

      const roles = await this.getAllRoles();
      const totalRoles = roles.length;
      const totalUsage = roles.reduce((sum, role) => sum + role.usageCount, 0);

      // åˆ†ç±»ç»Ÿè®¡
      const categoryStats: Record<string, number> = {};
      roles.forEach(role => {
        categoryStats[role.roleCategory] = (categoryStats[role.roleCategory] || 0) + 1;
      });

      // æœ€å¸¸ç”¨è§’è‰²
      const mostUsedRole = roles.length > 0
        ? roles.reduce((prev, current) => prev.usageCount > current.usageCount ? prev : current)
        : null;

      const stats: RoleStats = {
        totalRoles,
        totalUsage,
        categoryStats,
        mostUsedRole
      };

      Logger.info('RoleManager', `è§’è‰²ç»Ÿè®¡: ${JSON.stringify(stats)}`);
      return stats;
    } catch (error) {
      Logger.error('RoleManager', `è·å–è§’è‰²ç»Ÿè®¡å¤±è´¥: ${error}`);
      return {
        totalRoles: 0,
        totalUsage: 0,
        categoryStats: {},
        mostUsedRole: null
      } as RoleStats;
    }
  }

  /**
   * åˆå§‹åŒ–é»˜è®¤è§’è‰²
   */
  async initializeDefaultRoles(): Promise<void> {
    try {
      Logger.info('RoleManager', 'åˆå§‹åŒ–é»˜è®¤è§’è‰²');

      const existingRoles = await this.getAllRoles();
      const builtInRoles = existingRoles.filter(role => role.isBuiltIn);
      Logger.info('RoleManager', `å½“å‰å­˜åœ¨ ${existingRoles.length} ä¸ªè§’è‰²ï¼Œå…¶ä¸­ ${builtInRoles.length} ä¸ªå†…ç½®è§’è‰²`);

      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»»ä½•å†…ç½®è§’è‰²ï¼Œå¦‚æœå­˜åœ¨åˆ™è·³è¿‡åˆå§‹åŒ–
      if (builtInRoles.length > 0) {
        Logger.info('RoleManager', 'å·²å­˜åœ¨å†…ç½®è§’è‰²ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      await this.forceInitializeDefaultRoles();
    } catch (error) {
      Logger.error('RoleManager', `åˆå§‹åŒ–é»˜è®¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * ä¿®å¤è§’è‰²åˆ†ç±»ï¼šé‡æ–°åˆ†ç±»é”™è¯¯æ ‡è®°çš„å†…ç½®è§’è‰²
   */
  async fixRoleCategories(): Promise<number> {
    try {
      Logger.info('RoleManager', 'å¼€å§‹ä¿®å¤è§’è‰²åˆ†ç±»');

      const allRoles = await this.getAllRoles();
      let fixedCount = 0;

      // å®šä¹‰å†…ç½®è§’è‰²åç§°å’Œå…¶æ­£ç¡®åˆ†ç±»çš„æ˜ å°„
      const builtInRoleCategories: Record<string, RoleCategory> = {
        'æŠ€æœ¯ä¸“å®¶': RoleCategory.PROFESSIONAL,
        'äº§å“ç»ç†': RoleCategory.PROFESSIONAL,
        'é¡¹ç›®ç®¡ç†æ•™ç»ƒ': RoleCategory.PROFESSIONAL,
        'è‹±è¯­è€å¸ˆ': RoleCategory.PROFESSIONAL,
        'æŠ•èµ„é¡¾é—®': RoleCategory.PROFESSIONAL,
        'UI/UXè®¾è®¡å¸ˆ': RoleCategory.PROFESSIONAL,
        'æ•°æ®åˆ†æå¸ˆ': RoleCategory.PROFESSIONAL,
        'å¾‹å¸ˆé¡¾é—®': RoleCategory.PROFESSIONAL,
        'èŒä¸šè§„åˆ’å¸ˆ': RoleCategory.PROFESSIONAL,
        'ç†è´¢è§„åˆ’å¸ˆ': RoleCategory.PROFESSIONAL,
        'å°è¯´ä½œå®¶': RoleCategory.PROFESSIONAL,
        'æ‘„å½±å¸ˆ': RoleCategory.PROFESSIONAL,
        'æ¸¸æˆç­–åˆ’å¸ˆ': RoleCategory.PROFESSIONAL,
        'çŸ¥å¿ƒæœ‹å‹': RoleCategory.PROFESSIONAL,
        'å¥èº«æ•™ç»ƒ': RoleCategory.PROFESSIONAL,
        'æ—…è¡Œè§„åˆ’å¸ˆ': RoleCategory.PROFESSIONAL,
        'è¥å…»å¸ˆ': RoleCategory.PROFESSIONAL,
        'å¿ƒç†å’¨è¯¢å¸ˆ': RoleCategory.PROFESSIONAL,
        'å„¿ç«¥æ•™è‚²ä¸“å®¶': RoleCategory.PROFESSIONAL
      };

      for (const role of allRoles) {
        const correctCategory = builtInRoleCategories[role.name];
        if (correctCategory && role.roleCategory !== correctCategory) {
          Logger.info('RoleManager', `ä¿®å¤è§’è‰² ${role.name} çš„åˆ†ç±»: ${role.roleCategory} -> ${correctCategory}`);

          role.roleCategory = correctCategory;
          role.isBuiltIn = true; // ç¡®ä¿æ ‡è®°ä¸ºå†…ç½®è§’è‰²
          role.roleIcon = role.roleIcon || this.getDefaultIconForCategory(correctCategory);

          await AppStorage.updateSystemPrompt(role);
          fixedCount++;
        }
      }

      Logger.info('RoleManager', `è§’è‰²åˆ†ç±»ä¿®å¤å®Œæˆï¼Œå…±ä¿®å¤ ${fixedCount} ä¸ªè§’è‰²`);
      return fixedCount;
    } catch (error) {
      Logger.error('RoleManager', `ä¿®å¤è§’è‰²åˆ†ç±»å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * ä¿®å¤ç°æœ‰ç³»ç»Ÿæç¤ºè¯ï¼šå°†æœªæ ‡è®°ä¸ºè§’è‰²çš„ç³»ç»Ÿæç¤ºè¯è½¬æ¢ä¸ºè§’è‰²
   */
  async convertSystemPromptsToRoles(): Promise<number> {
    try {
      Logger.info('RoleManager', 'å¼€å§‹ä¿®å¤ç°æœ‰ç³»ç»Ÿæç¤ºè¯');

      const allPrompts = await AppStorage.getSystemPrompts();
      const nonRolePrompts = allPrompts.filter(prompt => !prompt.isRole);

      if (nonRolePrompts.length === 0) {
        Logger.info('RoleManager', 'æ‰€æœ‰ç³»ç»Ÿæç¤ºè¯éƒ½å·²æ­£ç¡®æ ‡è®°ä¸ºè§’è‰²');
        return 0;
      }

      Logger.info('RoleManager', `å‘ç° ${nonRolePrompts.length} ä¸ªéœ€è¦è½¬æ¢çš„ç³»ç»Ÿæç¤ºè¯`);

      // è½¬æ¢æ¯ä¸ªç³»ç»Ÿæç¤ºè¯ä¸ºè§’è‰²
      let convertedCount = 0;
      for (const prompt of nonRolePrompts) {
        try {
          Logger.info('RoleManager', `è½¬æ¢ç³»ç»Ÿæç¤ºè¯: ${prompt.name}`);

          // è®¾ç½®ä¸ºè§’è‰²
          prompt.isRole = true;
          prompt.roleCategory = RoleCategory.CUSTOM; // é»˜è®¤è®¾ä¸ºè‡ªå®šä¹‰è§’è‰²
          prompt.roleIcon = this.getDefaultIconForCategory(RoleCategory.CUSTOM);
          prompt.roleDescription = prompt.roleDescription || prompt.name;

          // æ›´æ–°åˆ°å­˜å‚¨
          await AppStorage.updateSystemPrompt(prompt);
          convertedCount++;

          Logger.info('RoleManager', `æˆåŠŸè½¬æ¢: ${prompt.name}`);
        } catch (error) {
          Logger.error('RoleManager', `è½¬æ¢å¤±è´¥ ${prompt.name}: ${error}`);
        }
      }

      Logger.info('RoleManager', `ç³»ç»Ÿæç¤ºè¯ä¿®å¤å®Œæˆï¼ŒæˆåŠŸè½¬æ¢ ${convertedCount} ä¸ª`);
      return convertedCount;
    } catch (error) {
      Logger.error('RoleManager', `ä¿®å¤ç³»ç»Ÿæç¤ºè¯å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–é»˜è®¤è§’è‰²ï¼ˆæ¸…é™¤ç°æœ‰å†…ç½®è§’è‰²åé‡æ–°åˆ›å»ºï¼‰
   */
  async forceInitializeDefaultRoles(): Promise<void> {
    try {
      Logger.info('RoleManager', 'å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–é»˜è®¤è§’è‰²');

      // é¦–å…ˆåˆ é™¤æ‰€æœ‰ç°æœ‰çš„å†…ç½®è§’è‰²
      const existingRoles = await this.getAllRoles();
      const builtInRoles = existingRoles.filter(role => role.isBuiltIn);

      Logger.info('RoleManager', `åˆ é™¤ç°æœ‰çš„ ${builtInRoles.length} ä¸ªå†…ç½®è§’è‰²`);
      for (const role of builtInRoles) {
        await this.forceDeleteRole(role.id);
        Logger.info('RoleManager', `å·²åˆ é™¤å†…ç½®è§’è‰²: ${role.name}`);
      }

      // ä½¿ç”¨å¼‚æ­¥æ–¹å¼è·å– DefaultPrompts ä¸­çš„æ‰€æœ‰è§’è‰²ä½œä¸ºé»˜è®¤è§’è‰²
      Logger.info('RoleManager', 'å¼€å§‹æ·»åŠ  DefaultPrompts ä¸­çš„è§’è‰²');
      const manager = PromptsConfigManager.getInstance();

      // ç¡®ä¿æç¤ºè¯å·²å¼‚æ­¥åŠ è½½å®Œæˆ
      const defaultPromptsRoles = await manager.getAllPrompts();
      Logger.info('RoleManager', `ä» DefaultPrompts è·å–åˆ° ${defaultPromptsRoles.length} ä¸ªè§’è‰²`);

      for (const promptRole of defaultPromptsRoles) {
        try {
          // ç¡®ä¿è§’è‰²æ ‡è®°å’Œåˆ†ç±»æ­£ç¡®
          promptRole.isRole = true;
          promptRole.isBuiltIn = true;

          // ä¿®æ­£åˆ†ç±»æ˜ å°„
          if (promptRole.roleCategory === 'professional') {
            promptRole.roleCategory = RoleCategory.PROFESSIONAL;
          } else if (promptRole.roleCategory === 'character') {
            promptRole.roleCategory = RoleCategory.CHARACTER;
          } else {
            // é»˜è®¤è®¾ç½®åˆ†ç±»ï¼šåˆ›æ„ã€ç”Ÿæ´»ã€å¿ƒç†ç­‰éƒ½å½’ç±»ä¸ºä¸“ä¸šè§’è‰²
            promptRole.roleCategory = RoleCategory.PROFESSIONAL;
          }

          // ç¡®ä¿æœ‰æ­£ç¡®çš„å›¾æ ‡
          if (!promptRole.roleIcon) {
            promptRole.roleIcon = this.getDefaultIconForCategory(promptRole.roleCategory as RoleCategory);
          }

          await AppStorage.addSystemPrompt(promptRole);
          Logger.info('RoleManager', `DefaultPrompts è§’è‰²åˆ›å»ºæˆåŠŸ: ${promptRole.id} - ${promptRole.name} (åˆ†ç±»: ${promptRole.roleCategory})`);
        } catch (error) {
          Logger.error('RoleManager', `åˆ›å»º DefaultPrompts è§’è‰²å¤±è´¥ ${promptRole.name}: ${error}`);
        }
      }

      Logger.info('RoleManager', `å¼ºåˆ¶åˆå§‹åŒ–é»˜è®¤è§’è‰²å®Œæˆï¼Œå…±åˆ›å»º ${defaultPromptsRoles.length} ä¸ªå†…ç½®è§’è‰²`);
    } catch (error) {
      Logger.error('RoleManager', `å¼ºåˆ¶åˆå§‹åŒ–é»˜è®¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * è·å–åˆ†ç±»é»˜è®¤å›¾æ ‡
   */
  private getDefaultIconForCategory(category: RoleCategory): string {
    const iconMap: Record<RoleCategory, string> = {
      [RoleCategory.PROFESSIONAL]: 'ğŸ’¼',
      [RoleCategory.CHARACTER]: 'ğŸ­',
      [RoleCategory.CUSTOM]: 'âš™ï¸'
    };
    return iconMap[category] || 'ğŸ­';
  }

  /**
   * è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
   */
  static getCategoryDisplayName(category: RoleCategory): string {
    const nameMap: Record<RoleCategory, string> = {
      [RoleCategory.PROFESSIONAL]: 'ä¸“ä¸šè§’è‰²',
      [RoleCategory.CHARACTER]: 'äººç‰©è§’è‰²',
      [RoleCategory.CUSTOM]: 'è‡ªå®šä¹‰è§’è‰²'
    };
    return nameMap[category] || category;
  }

  /**
   * è·å–æ‰€æœ‰åˆ†ç±»
   */
  static getAllCategories(): RoleCategory[] {
    return [
      RoleCategory.PROFESSIONAL,
      RoleCategory.CHARACTER,
      RoleCategory.CUSTOM
    ];
  }

  //=================== å·²åº”ç”¨è§’è‰²ç®¡ç†ç›¸å…³æ–¹æ³• ===================

  /**
   * è·å–å·²åº”ç”¨åˆ°ä¾§è¾¹æ çš„è§’è‰²åˆ—è¡¨
   */
  async getAppliedRoles(): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', 'è·å–å·²åº”ç”¨åˆ°ä¾§è¾¹æ çš„è§’è‰²åˆ—è¡¨');

      // è·å–å·²åº”ç”¨è§’è‰²çš„IDåˆ—è¡¨
      const appliedRoleIds = await AppStorage.getAppliedRoleIds();
      if (appliedRoleIds.length === 0) {
        Logger.debug('RoleManager', 'æ²¡æœ‰å·²åº”ç”¨çš„è§’è‰²');
        return [];
      }

      // è·å–æ‰€æœ‰è§’è‰²
      const allRoles = await this.getAllRoles();

      // ç­›é€‰å‡ºå·²åº”ç”¨çš„è§’è‰²ï¼Œä¿æŒIDåˆ—è¡¨çš„é¡ºåº
      const appliedRoles: SystemPrompt[] = [];
      const invalidRoleIds: string[] = []; // è®°å½•æ— æ•ˆçš„è§’è‰²ID

      for (const roleId of appliedRoleIds) {
        const role = allRoles.find(r => r.id === roleId);
        if (role) {
          appliedRoles.push(role);
        } else {
          Logger.warn('RoleManager', `å·²åº”ç”¨è§’è‰²ID ${roleId} å¯¹åº”çš„è§’è‰²ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤`);
          invalidRoleIds.push(roleId);
        }
      }

      // æ¸…ç†æ— æ•ˆçš„è§’è‰²IDï¼ˆä»å·²åº”ç”¨åˆ—è¡¨ä¸­ç§»é™¤ï¼‰
      if (invalidRoleIds.length > 0) {
        Logger.info('RoleManager', `æ¸…ç† ${invalidRoleIds.length} ä¸ªæ— æ•ˆçš„è§’è‰²ID`);
        for (const invalidRoleId of invalidRoleIds) {
          try {
            await this.removeRoleFromSidebar(invalidRoleId);
          } catch (error) {
            Logger.error('RoleManager', `æ¸…ç†æ— æ•ˆè§’è‰²IDå¤±è´¥ ${invalidRoleId}: ${error}`);
          }
        }
      }

      Logger.info('RoleManager', `è·å–åˆ° ${appliedRoles.length} ä¸ªå·²åº”ç”¨è§’è‰²`);
      return appliedRoles;
    } catch (error) {
      Logger.error('RoleManager', `è·å–å·²åº”ç”¨è§’è‰²åˆ—è¡¨å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * å°†è§’è‰²åº”ç”¨åˆ°ä¾§è¾¹æ 
   */
  async applyRoleToSidebar(roleId: string): Promise<void> {
    try {
      Logger.info('RoleManager', `å°†è§’è‰²åº”ç”¨åˆ°ä¾§è¾¹æ : ${roleId}`);

      // æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨
      const role = await this.getRoleById(roleId);
      if (!role) {
        throw new Error(`è§’è‰²ä¸å­˜åœ¨: ${roleId}`);
      }

      // æ·»åŠ åˆ°å·²åº”ç”¨åˆ—è¡¨
      await AppStorage.addAppliedRole(roleId);
      Logger.info('RoleManager', `è§’è‰² ${role.name} å·²åº”ç”¨åˆ°ä¾§è¾¹æ `);
    } catch (error) {
      Logger.error('RoleManager', `åº”ç”¨è§’è‰²åˆ°ä¾§è¾¹æ å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * ä»ä¾§è¾¹æ ç§»é™¤å·²åº”ç”¨çš„è§’è‰²
   */
  async removeRoleFromSidebar(roleId: string): Promise<void> {
    try {
      Logger.info('RoleManager', `ä»ä¾§è¾¹æ ç§»é™¤è§’è‰²: ${roleId}`);

      // ä»å·²åº”ç”¨åˆ—è¡¨ä¸­ç§»é™¤
      await AppStorage.removeAppliedRole(roleId);

      // è·å–è§’è‰²åç§°ç”¨äºæ—¥å¿—
      const role = await this.getRoleById(roleId);
      const roleName = role ? role.name : roleId;

      Logger.info('RoleManager', `è§’è‰² ${roleName} å·²ä»ä¾§è¾¹æ ç§»é™¤`);
    } catch (error) {
      Logger.error('RoleManager', `ä»ä¾§è¾¹æ ç§»é™¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * æ£€æŸ¥è§’è‰²æ˜¯å¦å·²åº”ç”¨åˆ°ä¾§è¾¹æ 
   */
  async isRoleAppliedToSidebar(roleId: string): Promise<boolean> {
    try {
      Logger.debug('RoleManager', `æ£€æŸ¥è§’è‰²æ˜¯å¦å·²åº”ç”¨åˆ°ä¾§è¾¹æ : ${roleId}`);
      const isApplied = await AppStorage.isRoleApplied(roleId);
      Logger.debug('RoleManager', `è§’è‰² ${roleId} ä¾§è¾¹æ åº”ç”¨çŠ¶æ€: ${isApplied}`);
      return isApplied;
    } catch (error) {
      Logger.error('RoleManager', `æ£€æŸ¥è§’è‰²ä¾§è¾¹æ åº”ç”¨çŠ¶æ€å¤±è´¥: ${error}`);
      return false;
    }
  }

  /**
   * æ¸…ç©ºä¾§è¾¹æ æ‰€æœ‰å·²åº”ç”¨è§’è‰²
   */
  async clearAllAppliedRoles(): Promise<void> {
    try {
      Logger.info('RoleManager', 'æ¸…ç©ºä¾§è¾¹æ æ‰€æœ‰å·²åº”ç”¨è§’è‰²');
      await AppStorage.clearAppliedRoles();
      Logger.info('RoleManager', 'ä¾§è¾¹æ å·²åº”ç”¨è§’è‰²å·²å…¨éƒ¨æ¸…ç©º');
    } catch (error) {
      Logger.error('RoleManager', `æ¸…ç©ºä¾§è¾¹æ å·²åº”ç”¨è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * è·å–å·²åº”ç”¨è§’è‰²çš„æ•°é‡
   */
  async getAppliedRolesCount(): Promise<number> {
    try {
      const appliedRoleIds = await AppStorage.getAppliedRoleIds();
      return appliedRoleIds.length;
    } catch (error) {
      Logger.error('RoleManager', `è·å–å·²åº”ç”¨è§’è‰²æ•°é‡å¤±è´¥: ${error}`);
      return 0;
    }
  }
}