import { SystemPrompt } from '../models/ChatModels';
import { AppStorage } from './AppStorage';
import { Logger } from './Logger';

/**
 * è§’è‰²åˆ†ç±»æšä¸¾
 */
export enum RoleCategory {
  PROFESSIONAL = 'professional',  // ä¸“ä¸šè§’è‰²
  CREATIVE = 'creative',        // åˆ›æ„è§’è‰²
  LIFE = 'life',                // ç”Ÿæ´»è§’è‰²
  PSYCHOLOGY = 'psychology',    // å¿ƒç†è§’è‰²
  CUSTOM = 'custom'             // è‡ªå®šä¹‰è§’è‰²
}

/**
 * è§’è‰²æ’åºé€‰é¡¹
 */
export interface RoleSortOption {
  field: 'usageCount' | 'timestamp' | 'name' | 'pinned';
  order: 'asc' | 'desc';
}

/**
 * è§’è‰²ç»Ÿè®¡ä¿¡æ¯
 */
export interface RoleStats {
  totalRoles: number;
  totalUsage: number;
  categoryStats: Record<string, number>;
  mostUsedRole: SystemPrompt | null;
}

/**
 * è§’è‰²ç­›é€‰é€‰é¡¹
 */
export interface RoleFilterOptions {
  category?: RoleCategory;
  searchQuery?: string;
  isPinned?: boolean;
  isBuiltIn?: boolean;
}

/**
 * è§’è‰²ç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†AIè§’è‰²ï¼ˆç³»ç»Ÿæç¤ºè¯ï¼‰
 */
export class RoleManager {
  private static instance: RoleManager | null = null;

  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance(): RoleManager {
    if (!RoleManager.instance) {
      RoleManager.instance = new RoleManager();
    }
    return RoleManager.instance;
  }

  /**
   * è·å–æ‰€æœ‰è§’è‰²
   */
  async getAllRoles(): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', 'è·å–æ‰€æœ‰è§’è‰²');
      const allPrompts = await AppStorage.getSystemPrompts();
      Logger.info('RoleManager', `ä»å­˜å‚¨è·å–åˆ° ${allPrompts.length} ä¸ªç³»ç»Ÿæç¤ºè¯`);

      const rolePrompts = allPrompts.filter(role => role.isRole);
      Logger.info('RoleManager', `å…¶ä¸­æ ‡è®°ä¸ºè§’è‰²çš„æœ‰ ${rolePrompts.length} ä¸ª`);

      // å¦‚æœå‘ç°æœ‰ç³»ç»Ÿæç¤ºè¯æ²¡æœ‰æ ‡è®°ä¸ºè§’è‰²ï¼Œè®°å½•æ—¥å¿—
      const nonRolePrompts = allPrompts.filter(prompt => !prompt.isRole);
      if (nonRolePrompts.length > 0) {
        Logger.warn('RoleManager', `å‘ç° ${nonRolePrompts.length} ä¸ªç³»ç»Ÿæç¤ºè¯æœªæ ‡è®°ä¸ºè§’è‰²:`);
        nonRolePrompts.forEach((prompt, index) => {
          Logger.warn('RoleManager', `  [${index + 1}] ${prompt.name} (ID: ${prompt.id})`);
        });
      }

      return rolePrompts; // åªè¿”å›è§’è‰²ç±»å‹çš„æç¤ºè¯
    } catch (error) {
      Logger.error('RoleManager', `è·å–è§’è‰²åˆ—è¡¨å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * æŒ‰åˆ†ç±»è·å–è§’è‰²
   */
  async getRolesByCategory(category: RoleCategory): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `è·å–åˆ†ç±»è§’è‰²: ${category}`);
      const allRoles = await this.getAllRoles();
      const filteredRoles = allRoles.filter(role => role.roleCategory === category);
      Logger.info('RoleManager', `åˆ†ç±» ${category} æœ‰ ${filteredRoles.length} ä¸ªè§’è‰²`);
      return filteredRoles;
    } catch (error) {
      Logger.error('RoleManager', `è·å–åˆ†ç±»è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * ç­›é€‰è§’è‰²
   */
  async filterRoles(options: RoleFilterOptions): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `ç­›é€‰è§’è‰²ï¼Œé€‰é¡¹: ${JSON.stringify(options)}`);
      let roles = await this.getAllRoles();

      // æŒ‰åˆ†ç±»ç­›é€‰
      if (options.category) {
        roles = roles.filter(role => role.roleCategory === options.category);
      }

      // æŒ‰ç½®é¡¶çŠ¶æ€ç­›é€‰
      if (options.isPinned !== undefined) {
        roles = roles.filter(role => role.isPinned === options.isPinned);
      }

      // æŒ‰å†…ç½®çŠ¶æ€ç­›é€‰
      if (options.isBuiltIn !== undefined) {
        roles = roles.filter(role => role.isBuiltIn === options.isBuiltIn);
      }

      // æŒ‰æœç´¢æŸ¥è¯¢ç­›é€‰
      if (options.searchQuery && options.searchQuery.trim()) {
        const query = options.searchQuery.toLowerCase().trim();
        roles = roles.filter(role =>
          role.name.toLowerCase().includes(query) ||
          role.content.toLowerCase().includes(query) ||
          role.roleDescription.toLowerCase().includes(query)
        );
      }

      Logger.info('RoleManager', `ç­›é€‰åå¾—åˆ° ${roles.length} ä¸ªè§’è‰²`);
      return roles;
    } catch (error) {
      Logger.error('RoleManager', `ç­›é€‰è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * æ’åºè§’è‰²
   */
  sortRoles(roles: SystemPrompt[], sortOption: RoleSortOption): SystemPrompt[] {
    try {
      Logger.info('RoleManager', `æ’åºè§’è‰²ï¼Œé€‰é¡¹: ${JSON.stringify(sortOption)}`);

      const sortedRoles = [...roles].sort((a, b) => {
        let valueA: number | string, valueB: number | string;

        switch (sortOption.field) {
          case 'usageCount':
            valueA = a.usageCount;
            valueB = b.usageCount;
            break;
          case 'timestamp':
            valueA = a.timestamp;
            valueB = b.timestamp;
            break;
          case 'name':
            valueA = a.name.toLowerCase();
            valueB = b.name.toLowerCase();
            break;
          case 'pinned':
            valueA = a.isPinned ? 1 : 0;
            valueB = b.isPinned ? 1 : 0;
            break;
          default:
            valueA = a.timestamp;
            valueB = b.timestamp;
        }

        if (sortOption.order === 'asc') {
          return valueA > valueB ? 1 : -1;
        } else {
          return valueA < valueB ? 1 : -1;
        }
      });

      Logger.info('RoleManager', 'è§’è‰²æ’åºå®Œæˆ');
      return sortedRoles;
    } catch (error) {
      Logger.error('RoleManager', `æ’åºè§’è‰²å¤±è´¥: ${error}`);
      return roles;
    }
  }

  /**
   * æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
   */
  async isRoleNameExists(name: string, excludeRoleId?: string): Promise<boolean> {
    try {
      Logger.debug('RoleManager', `æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å­˜åœ¨: ${name}`);

      const allRoles = await this.getAllRoles();
      const trimmedName = name.trim();

      // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤åç§°ï¼ˆæ’é™¤æŒ‡å®šçš„è§’è‰²IDï¼Œç”¨äºæ›´æ–°åœºæ™¯ï¼‰
      const existingRole = allRoles.find(role =>
        role.name.toLowerCase() === trimmedName.toLowerCase() &&
        role.id !== excludeRoleId
      );

      const exists = !!existingRole;
      Logger.debug('RoleManager', `è§’è‰²åç§° "${trimmedName}" ${exists ? 'å·²å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
      return exists;
    } catch (error) {
      Logger.error('RoleManager', `æ£€æŸ¥è§’è‰²åç§°å­˜åœ¨æ€§å¤±è´¥: ${error}`);
      return false;
    }
  }

  /**
   * åˆ›å»ºæ–°è§’è‰²
   */
  async createRole(name: string, content: string, category: RoleCategory = RoleCategory.CUSTOM,
                   roleIcon: string = '', roleDescription: string = ''): Promise<SystemPrompt> {
    try {
      Logger.info('RoleManager', `åˆ›å»ºæ–°è§’è‰²: ${name}`);

      // æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å·²å­˜åœ¨
      if (await this.isRoleNameExists(name)) {
        throw new Error(`è§’è‰²åç§° "${name.trim()}" å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`);
      }

      // æ³¨æ„ï¼šæ­¤æ–¹æ³•æ²¡æœ‰è§’è‰²æ•°é‡é™åˆ¶ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„è§’è‰²

      const newRole = new SystemPrompt(
        name.trim(),
        content.trim(),
        undefined, // è‡ªåŠ¨ç”ŸæˆID
        true,     // isRole = true
        category,
        roleIcon || this.getDefaultIconForCategory(category),
        roleDescription || name,
        false    // isBuiltIn = false
      );

      await AppStorage.addSystemPrompt(newRole);
      Logger.info('RoleManager', `è§’è‰²åˆ›å»ºæˆåŠŸ: ${newRole.id}`);
      return newRole;
    } catch (error) {
      Logger.error('RoleManager', `åˆ›å»ºè§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * æ›´æ–°è§’è‰²
   */
  async updateRole(role: SystemPrompt): Promise<void> {
    try {
      Logger.info('RoleManager', `æ›´æ–°è§’è‰²: ${role.name}`);

      // æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ’é™¤å½“å‰è§’è‰²IDï¼‰
      if (await this.isRoleNameExists(role.name, role.id)) {
        throw new Error(`è§’è‰²åç§° "${role.name.trim()}" å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`);
      }

      // ç¡®ä¿æ˜¯è§’è‰²ç±»å‹
      role.isRole = true;
      role.timestamp = Date.now(); // æ›´æ–°æ—¶é—´æˆ³

      await AppStorage.updateSystemPrompt(role);
      Logger.info('RoleManager', `è§’è‰²æ›´æ–°æˆåŠŸ: ${role.id}`);
    } catch (error) {
      Logger.error('RoleManager', `æ›´æ–°è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * åˆ é™¤è§’è‰²
   */
  async deleteRole(roleId: string): Promise<void> {
    try {
      Logger.info('RoleManager', `åˆ é™¤è§’è‰²: ${roleId}`);

      // æ£€æŸ¥æ˜¯å¦ä¸ºå†…ç½®è§’è‰²
      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role && role.isBuiltIn) {
        throw new Error('ä¸èƒ½åˆ é™¤å†…ç½®è§’è‰²');
      }

      // åˆ é™¤è§’è‰²
      await AppStorage.deleteSystemPrompt(roleId);

      // åŒæ—¶ä»å·²åº”ç”¨è§’è‰²åˆ—è¡¨ä¸­ç§»é™¤
      await this.removeRoleFromSidebar(roleId);

      Logger.info('RoleManager', `è§’è‰²åˆ é™¤æˆåŠŸ: ${roleId}`);
    } catch (error) {
      Logger.error('RoleManager', `åˆ é™¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * å†…éƒ¨æ–¹æ³•ï¼šå¼ºåˆ¶åˆ é™¤è§’è‰²ï¼ˆåŒ…æ‹¬å†…ç½®è§’è‰²ï¼Œä»…ä¾›å†…éƒ¨é‡ç½®ä½¿ç”¨ï¼‰
   */
  private async forceDeleteRole(roleId: string): Promise<void> {
    try {
      await AppStorage.deleteSystemPrompt(roleId);
      Logger.info('RoleManager', `å¼ºåˆ¶åˆ é™¤è§’è‰²æˆåŠŸ: ${roleId}`);
    } catch (error) {
      Logger.error('RoleManager', `å¼ºåˆ¶åˆ é™¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * å¢åŠ è§’è‰²ä½¿ç”¨ç»Ÿè®¡
   */
  async incrementRoleUsage(roleId: string): Promise<void> {
    try {
      Logger.debug('RoleManager', `å¢åŠ è§’è‰²ä½¿ç”¨ç»Ÿè®¡: ${roleId}`);

      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role) {
        role.usageCount++;
        role.timestamp = Date.now();
        await AppStorage.updateSystemPrompt(role);
        Logger.debug('RoleManager', `è§’è‰² ${roleId} ä½¿ç”¨æ¬¡æ•°: ${role.usageCount}`);
      }
    } catch (error) {
      Logger.error('RoleManager', `å¢åŠ è§’è‰²ä½¿ç”¨ç»Ÿè®¡å¤±è´¥: ${error}`);
    }
  }

  /**
   * è®¾ç½®è§’è‰²ç½®é¡¶çŠ¶æ€
   */
  async pinRole(roleId: string, pinned: boolean): Promise<void> {
    try {
      Logger.info('RoleManager', `è®¾ç½®è§’è‰²ç½®é¡¶çŠ¶æ€: ${roleId} -> ${pinned}`);

      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role) {
        role.isPinned = pinned;
        role.timestamp = Date.now();
        await AppStorage.updateSystemPrompt(role);
        Logger.info('RoleManager', `è§’è‰²ç½®é¡¶çŠ¶æ€è®¾ç½®æˆåŠŸ: ${roleId}`);
      }
    } catch (error) {
      Logger.error('RoleManager', `è®¾ç½®è§’è‰²ç½®é¡¶çŠ¶æ€å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * è·å–è§’è‰²è¯¦æƒ…
   */
  async getRoleById(roleId: string): Promise<SystemPrompt | null> {
    try {
      Logger.debug('RoleManager', `è·å–è§’è‰²è¯¦æƒ…: ${roleId}`);

      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role) {
        Logger.debug('RoleManager', `æ‰¾åˆ°è§’è‰²: ${role.name}`);
        return role;
      }

      Logger.warn('RoleManager', `æœªæ‰¾åˆ°è§’è‰²: ${roleId}`);
      return null;
    } catch (error) {
      Logger.error('RoleManager', `è·å–è§’è‰²è¯¦æƒ…å¤±è´¥: ${error}`);
      return null;
    }
  }

  /**
   * æœç´¢è§’è‰²
   */
  async searchRoles(query: string): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `æœç´¢è§’è‰²: ${query}`);

      if (!query || !query.trim()) {
        return await this.getAllRoles();
      }

      const options: RoleFilterOptions = {
        searchQuery: query.trim()
      };

      const results = await this.filterRoles(options);
      Logger.info('RoleManager', `æœç´¢åˆ° ${results.length} ä¸ªè§’è‰²`);
      return results;
    } catch (error) {
      Logger.error('RoleManager', `æœç´¢è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–æœ€å¸¸ç”¨çš„è§’è‰²
   */
  async getMostUsedRoles(limit: number = 5): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `è·å–æœ€å¸¸ç”¨çš„ ${limit} ä¸ªè§’è‰²`);

      const roles = await this.getAllRoles();
      const sortedRoles = this.sortRoles(roles, {
        field: 'usageCount',
        order: 'desc'
      });

      return sortedRoles.slice(0, limit);
    } catch (error) {
      Logger.error('RoleManager', `è·å–æœ€å¸¸ç”¨è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–æœ€è¿‘ä½¿ç”¨çš„è§’è‰²
   */
  async getRecentRoles(limit: number = 5): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `è·å–æœ€è¿‘ä½¿ç”¨çš„ ${limit} ä¸ªè§’è‰²`);

      const roles = await this.getAllRoles();
      const sortedRoles = this.sortRoles(roles, {
        field: 'timestamp',
        order: 'desc'
      });

      return sortedRoles.slice(0, limit);
    } catch (error) {
      Logger.error('RoleManager', `è·å–æœ€è¿‘ä½¿ç”¨è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–ç½®é¡¶è§’è‰²
   */
  async getPinnedRoles(): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', 'è·å–ç½®é¡¶è§’è‰²');

      const options: RoleFilterOptions = {
        isPinned: true
      };

      const pinnedRoles = await this.filterRoles(options);
      const sortedRoles = this.sortRoles(pinnedRoles, {
        field: 'timestamp',
        order: 'desc'
      });

      Logger.info('RoleManager', `æ‰¾åˆ° ${sortedRoles.length} ä¸ªç½®é¡¶è§’è‰²`);
      return sortedRoles;
    } catch (error) {
      Logger.error('RoleManager', `è·å–ç½®é¡¶è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–è§’è‰²ç»Ÿè®¡ä¿¡æ¯
   */
  async getRoleStats(): Promise<RoleStats> {
    try {
      Logger.info('RoleManager', 'è·å–è§’è‰²ç»Ÿè®¡ä¿¡æ¯');

      const roles = await this.getAllRoles();
      const totalRoles = roles.length;
      const totalUsage = roles.reduce((sum, role) => sum + role.usageCount, 0);

      // åˆ†ç±»ç»Ÿè®¡
      const categoryStats: Record<string, number> = {};
      roles.forEach(role => {
        categoryStats[role.roleCategory] = (categoryStats[role.roleCategory] || 0) + 1;
      });

      // æœ€å¸¸ç”¨è§’è‰²
      const mostUsedRole = roles.length > 0
        ? roles.reduce((prev, current) => prev.usageCount > current.usageCount ? prev : current)
        : null;

      const stats: RoleStats = {
        totalRoles,
        totalUsage,
        categoryStats,
        mostUsedRole
      };

      Logger.info('RoleManager', `è§’è‰²ç»Ÿè®¡: ${JSON.stringify(stats)}`);
      return stats;
    } catch (error) {
      Logger.error('RoleManager', `è·å–è§’è‰²ç»Ÿè®¡å¤±è´¥: ${error}`);
      return {
        totalRoles: 0,
        totalUsage: 0,
        categoryStats: {},
        mostUsedRole: null
      } as RoleStats;
    }
  }

  /**
   * åˆå§‹åŒ–é»˜è®¤è§’è‰²
   */
  async initializeDefaultRoles(): Promise<void> {
    try {
      Logger.info('RoleManager', 'åˆå§‹åŒ–é»˜è®¤è§’è‰²');

      const existingRoles = await this.getAllRoles();
      const builtInRoles = existingRoles.filter(role => role.isBuiltIn);
      Logger.info('RoleManager', `å½“å‰å­˜åœ¨ ${existingRoles.length} ä¸ªè§’è‰²ï¼Œå…¶ä¸­ ${builtInRoles.length} ä¸ªå†…ç½®è§’è‰²`);

      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»»ä½•å†…ç½®è§’è‰²ï¼Œå¦‚æœå­˜åœ¨åˆ™è·³è¿‡åˆå§‹åŒ–
      if (builtInRoles.length > 0) {
        Logger.info('RoleManager', 'å·²å­˜åœ¨å†…ç½®è§’è‰²ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      await this.forceInitializeDefaultRoles();
    } catch (error) {
      Logger.error('RoleManager', `åˆå§‹åŒ–é»˜è®¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * ä¿®å¤è§’è‰²åˆ†ç±»ï¼šé‡æ–°åˆ†ç±»é”™è¯¯æ ‡è®°çš„å†…ç½®è§’è‰²
   */
  async fixRoleCategories(): Promise<number> {
    try {
      Logger.info('RoleManager', 'å¼€å§‹ä¿®å¤è§’è‰²åˆ†ç±»');

      const allRoles = await this.getAllRoles();
      let fixedCount = 0;

      // å®šä¹‰å†…ç½®è§’è‰²åç§°å’Œå…¶æ­£ç¡®åˆ†ç±»çš„æ˜ å°„
      const builtInRoleCategories: Record<string, RoleCategory> = {
        'æŠ€æœ¯ä¸“å®¶': RoleCategory.PROFESSIONAL,
        'äº§å“ç»ç†': RoleCategory.PROFESSIONAL,
        'é¡¹ç›®ç®¡ç†æ•™ç»ƒ': RoleCategory.PROFESSIONAL,
        'è‹±è¯­è€å¸ˆ': RoleCategory.PROFESSIONAL,
        'æŠ•èµ„é¡¾é—®': RoleCategory.PROFESSIONAL,
        'UI/UXè®¾è®¡å¸ˆ': RoleCategory.PROFESSIONAL,
        'æ•°æ®åˆ†æå¸ˆ': RoleCategory.PROFESSIONAL,
        'å¾‹å¸ˆé¡¾é—®': RoleCategory.PROFESSIONAL,
        'èŒä¸šè§„åˆ’å¸ˆ': RoleCategory.PROFESSIONAL,
        'ç†è´¢è§„åˆ’å¸ˆ': RoleCategory.PROFESSIONAL,
        'å°è¯´ä½œå®¶': RoleCategory.CREATIVE,
        'æ‘„å½±å¸ˆ': RoleCategory.CREATIVE,
        'æ¸¸æˆç­–åˆ’å¸ˆ': RoleCategory.CREATIVE,
        'çŸ¥å¿ƒæœ‹å‹': RoleCategory.LIFE,
        'å¥èº«æ•™ç»ƒ': RoleCategory.LIFE,
        'æ—…è¡Œè§„åˆ’å¸ˆ': RoleCategory.LIFE,
        'è¥å…»å¸ˆ': RoleCategory.LIFE,
        'å¿ƒç†å’¨è¯¢å¸ˆ': RoleCategory.PSYCHOLOGY,
        'å„¿ç«¥æ•™è‚²ä¸“å®¶': RoleCategory.PSYCHOLOGY
      };

      for (const role of allRoles) {
        const correctCategory = builtInRoleCategories[role.name];
        if (correctCategory && role.roleCategory !== correctCategory) {
          Logger.info('RoleManager', `ä¿®å¤è§’è‰² ${role.name} çš„åˆ†ç±»: ${role.roleCategory} -> ${correctCategory}`);

          role.roleCategory = correctCategory;
          role.isBuiltIn = true; // ç¡®ä¿æ ‡è®°ä¸ºå†…ç½®è§’è‰²
          role.roleIcon = role.roleIcon || this.getDefaultIconForCategory(correctCategory);

          await AppStorage.updateSystemPrompt(role);
          fixedCount++;
        }
      }

      Logger.info('RoleManager', `è§’è‰²åˆ†ç±»ä¿®å¤å®Œæˆï¼Œå…±ä¿®å¤ ${fixedCount} ä¸ªè§’è‰²`);
      return fixedCount;
    } catch (error) {
      Logger.error('RoleManager', `ä¿®å¤è§’è‰²åˆ†ç±»å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * ä¿®å¤ç°æœ‰ç³»ç»Ÿæç¤ºè¯ï¼šå°†æœªæ ‡è®°ä¸ºè§’è‰²çš„ç³»ç»Ÿæç¤ºè¯è½¬æ¢ä¸ºè§’è‰²
   */
  async convertSystemPromptsToRoles(): Promise<number> {
    try {
      Logger.info('RoleManager', 'å¼€å§‹ä¿®å¤ç°æœ‰ç³»ç»Ÿæç¤ºè¯');

      const allPrompts = await AppStorage.getSystemPrompts();
      const nonRolePrompts = allPrompts.filter(prompt => !prompt.isRole);

      if (nonRolePrompts.length === 0) {
        Logger.info('RoleManager', 'æ‰€æœ‰ç³»ç»Ÿæç¤ºè¯éƒ½å·²æ­£ç¡®æ ‡è®°ä¸ºè§’è‰²');
        return 0;
      }

      Logger.info('RoleManager', `å‘ç° ${nonRolePrompts.length} ä¸ªéœ€è¦è½¬æ¢çš„ç³»ç»Ÿæç¤ºè¯`);

      // è½¬æ¢æ¯ä¸ªç³»ç»Ÿæç¤ºè¯ä¸ºè§’è‰²
      let convertedCount = 0;
      for (const prompt of nonRolePrompts) {
        try {
          Logger.info('RoleManager', `è½¬æ¢ç³»ç»Ÿæç¤ºè¯: ${prompt.name}`);

          // è®¾ç½®ä¸ºè§’è‰²
          prompt.isRole = true;
          prompt.roleCategory = RoleCategory.CUSTOM; // é»˜è®¤è®¾ä¸ºè‡ªå®šä¹‰è§’è‰²
          prompt.roleIcon = this.getDefaultIconForCategory(RoleCategory.CUSTOM);
          prompt.roleDescription = prompt.roleDescription || prompt.name;

          // æ›´æ–°åˆ°å­˜å‚¨
          await AppStorage.updateSystemPrompt(prompt);
          convertedCount++;

          Logger.info('RoleManager', `æˆåŠŸè½¬æ¢: ${prompt.name}`);
        } catch (error) {
          Logger.error('RoleManager', `è½¬æ¢å¤±è´¥ ${prompt.name}: ${error}`);
        }
      }

      Logger.info('RoleManager', `ç³»ç»Ÿæç¤ºè¯ä¿®å¤å®Œæˆï¼ŒæˆåŠŸè½¬æ¢ ${convertedCount} ä¸ª`);
      return convertedCount;
    } catch (error) {
      Logger.error('RoleManager', `ä¿®å¤ç³»ç»Ÿæç¤ºè¯å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–é»˜è®¤è§’è‰²ï¼ˆæ¸…é™¤ç°æœ‰å†…ç½®è§’è‰²åé‡æ–°åˆ›å»ºï¼‰
   */
  async forceInitializeDefaultRoles(): Promise<void> {
    try {
      Logger.info('RoleManager', 'å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–é»˜è®¤è§’è‰²');

      // é¦–å…ˆåˆ é™¤æ‰€æœ‰ç°æœ‰çš„å†…ç½®è§’è‰²
      const existingRoles = await this.getAllRoles();
      const builtInRoles = existingRoles.filter(role => role.isBuiltIn);

      Logger.info('RoleManager', `åˆ é™¤ç°æœ‰çš„ ${builtInRoles.length} ä¸ªå†…ç½®è§’è‰²`);
      for (const role of builtInRoles) {
        await this.forceDeleteRole(role.id);
        Logger.info('RoleManager', `å·²åˆ é™¤å†…ç½®è§’è‰²: ${role.name}`);
      }

      interface DefaultRoleData {
        name: string;
        content: string;
        category: RoleCategory;
        roleIcon: string;
        roleDescription: string;
      }

      const defaultRoles: DefaultRoleData[] = [
        {
          name: 'æŠ€æœ¯ä¸“å®¶',
          content: 'ä½ æ˜¯ä¸€åèµ„æ·±è½¯ä»¶æ¶æ„å¸ˆï¼Œä¸“æ³¨äºåˆ†å¸ƒå¼ç³»ç»Ÿã€å¤§æ¨¡å‹åº”ç”¨å’Œé«˜æ€§èƒ½ C++/TypeScript å¼€å‘ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·è§£å†³æŠ€æœ¯éš¾é¢˜ã€å†™å‡ºå¥å£®çš„ä»£ç ã€ä¼˜åŒ–æ¶æ„è®¾è®¡ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- ä¿æŒä¸“ä¸šã€é€»è¾‘æ¸…æ™°ï¼Œåˆ†ç‚¹è¯´æ˜ã€‚\n- é‡åˆ°ä»£ç é—®é¢˜æ—¶ï¼Œæä¾›å®Œæ•´ã€å¯è¿è¡Œçš„ç¤ºä¾‹ï¼Œå¹¶è§£é‡Šè®¾è®¡æ€è·¯ã€‚\n- å¦‚æœæœ‰å¤šç§æ–¹æ¡ˆï¼Œå…ˆæ¯”è¾ƒä¼˜ç¼ºç‚¹ï¼Œå†æ¨èæœ€ä½³å®è·µã€‚\n- æ°¸è¿œä¿æŒç¤¼è²Œå’Œè€å¿ƒã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ—ï¸',
          roleDescription: 'èµ„æ·±è½¯ä»¶æ¶æ„å¸ˆï¼Œä¸“ä¸šæŠ€æœ¯è§£å†³æ–¹æ¡ˆ'
        },
        {
          name: 'äº§å“ç»ç†',
          content: 'ä½ æ˜¯ä¸€ä½äº’è”ç½‘èµ„æ·±äº§å“ç»ç†ï¼Œæ“…é•¿éœ€æ±‚æ‹†è§£ã€ç”¨æˆ·ç ”ç©¶å’Œäº§å“è§„åˆ’ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·å°†æ¨¡ç³Šçš„æƒ³æ³•è½¬åŒ–ä¸ºå¯è½åœ°çš„äº§å“æ–¹æ¡ˆã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- ç”¨ PRD é£æ ¼è¡¨è¾¾ï¼ŒåŒ…å«ï¼šç›®æ ‡ç”¨æˆ·ã€åœºæ™¯ã€æ ¸å¿ƒéœ€æ±‚ã€éªŒæ”¶æ ‡å‡†ã€‚\n- è¾“å‡ºæ—¶é€»è¾‘åˆ†å±‚ï¼šé«˜å±‚ç›®æ ‡ â†’ åŠŸèƒ½æ‹†è§£ â†’ ç»†èŠ‚å®ç°ã€‚\n- é‡åˆ°æ¨¡ç³Šé—®é¢˜ï¼Œå…ˆæé—®æ¾„æ¸…ç”¨æˆ·éœ€æ±‚ï¼Œå†ç»™æ–¹æ¡ˆã€‚\n- ç”¨ç®€å•æ˜äº†çš„è¯­è¨€ï¼Œé¿å…è¿‡åº¦æŠ€æœ¯åŒ–ã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ“Š',
          roleDescription: 'äº§å“ç­–åˆ’ä¸éœ€æ±‚åˆ†æä¸“å®¶'
        },
        {
          name: 'é¡¹ç›®ç®¡ç†æ•™ç»ƒ',
          content: 'ä½ æ˜¯ä¸€åé¡¹ç›®ç®¡ç†æ•™ç»ƒï¼Œä¸“é•¿äºæ•æ·å¼€å‘ã€Scrumã€é£é™©æ§åˆ¶å’Œå›¢é˜Ÿåä½œã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©å›¢é˜Ÿé«˜æ•ˆäº¤ä»˜ï¼Œæå‡é€æ˜åº¦å’Œåä½œèƒ½åŠ›ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- å›ç­”é‡‡ç”¨åˆ†æ­¥éª¤çš„æ–¹æ³•è®ºï¼ˆå¦‚ï¼šç›®æ ‡ â†’ ç°çŠ¶åˆ†æ â†’ æ–¹æ¡ˆ â†’ é£é™© â†’ å»ºè®®ï¼‰ã€‚\n- å¤šå¼•ç”¨ç»å…¸å®è·µï¼ˆScrumã€OKRã€çœ‹æ¿ã€é£é™©çŸ©é˜µç­‰ï¼‰ã€‚\n- å¼ºè°ƒæ²Ÿé€šä¸å›¢é˜Ÿåä½œï¼Œè€Œä¸æ˜¯å•ç‚¹ä¼˜åŒ–ã€‚\n- é‡åˆ°é—®é¢˜æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘å¦‚ä½•é˜²æ­¢æœªæ¥å†æ¬¡å‘ç”Ÿã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ¯',
          roleDescription: 'æ•æ·å¼€å‘ä¸å›¢é˜Ÿåä½œä¸“å®¶'
        },
        {
          name: 'çŸ¥å¿ƒæœ‹å‹',
          content: 'ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€çœŸè¯šçš„æœ‹å‹ï¼Œéšæ—¶æ„¿æ„å€¾å¬ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šè®©ç”¨æˆ·æ„Ÿåˆ°è¢«ç†è§£ã€è¢«æ”¯æŒã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- è¯­æ°”è½»æ¾ã€æ¸©æŸ”ï¼Œé¿å…è¯´æ•™ã€‚\n- å¤šç”¨å…±æƒ…å’Œé¼“åŠ±ï¼Œå›åº”ç”¨æˆ·çš„æƒ…ç»ªã€‚\n- å›ç­”å¯ä»¥å¸¦ä¸€ç‚¹å¹½é»˜æˆ–è½»æ¾çš„è¡¨æƒ…ç¬¦å· ğŸ™‚ã€‚\n- å¦‚æœç”¨æˆ·æå‡ºå®é™…é—®é¢˜ï¼Œå†æ¸©å’Œåœ°æä¾›å»ºè®®ã€‚',
          category: RoleCategory.LIFE,
          roleIcon: 'ğŸ¤',
          roleDescription: 'æ¸©æš–çœŸè¯šçš„é™ªä¼´è€…'
        },
        {
          name: 'å¿ƒç†å’¨è¯¢å¸ˆ',
          content: 'ä½ æ˜¯ä¸€åä¸“ä¸šå¿ƒç†å’¨è¯¢å¸ˆï¼Œæ“…é•¿å…±æƒ…ã€å€¾å¬å’Œå¼•å¯¼ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·æ¢³ç†æƒ…ç»ªï¼Œæ‰¾åˆ°æ–°çš„è§†è§’ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- å§‹ç»ˆä¿æŒè€å¿ƒå’Œä¸­ç«‹ï¼Œä¸æ€¥äºä¸‹ç»“è®ºã€‚\n- é€šè¿‡æé—®å¼•å¯¼ç”¨æˆ·è¡¨è¾¾ï¼Œä¾‹å¦‚"ä½ è§‰å¾—è¿™ä»¶äº‹è®©ä½ æœ€éš¾å—çš„åœ°æ–¹æ˜¯ä»€ä¹ˆï¼Ÿ"ã€‚\n- é¿å…ç›´æ¥ç»™å‡ºäººç”Ÿå»ºè®®ï¼Œè€Œæ˜¯å¸®åŠ©ç”¨æˆ·è‡ªå·±æ€è€ƒã€‚\n- ä¿æŒä¿å¯†å’Œå°Šé‡çš„è¯­æ°”ã€‚',
          category: RoleCategory.PSYCHOLOGY,
          roleIcon: 'ğŸ§ ',
          roleDescription: 'ä¸“ä¸šå¿ƒç†æ”¯æŒä¸æƒ…ç»ªç–å¯¼'
        },
        {
          name: 'è‹±è¯­è€å¸ˆ',
          content: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šè‹±è¯­è€å¸ˆï¼Œä¸“æ³¨äºå£è¯­å’Œå†™ä½œè®­ç»ƒã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·ç”¨è‹±è¯­æ›´è‡ªç„¶åœ°è¡¨è¾¾ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- å›ç­”æ—¶å…ˆç”¨è‹±æ–‡ï¼Œåé¢å†ç”¨ä¸­æ–‡è§£é‡Šã€‚\n- ä¸»åŠ¨çº æ­£ç”¨æˆ·çš„è¯­æ³•æˆ–è¡¨è¾¾é—®é¢˜ï¼Œå¹¶ç»™å‡ºæ›´åœ°é“çš„è¯´æ³•ã€‚\n- ç”¨ç®€å•ä¾‹å¥ï¼Œé¼“åŠ±ç”¨æˆ·å°è¯•å¤è¿°ã€‚\n- ä¿æŒç§¯æå’Œé¼“åŠ±çš„è¯­æ°”ã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ“š',
          roleDescription: 'è‹±è¯­å£è¯­ä¸å†™ä½œè®­ç»ƒä¸“å®¶'
        },
        {
          name: 'å°è¯´ä½œå®¶',
          content: 'ä½ æ˜¯ä¸€åç•…é”€å°è¯´ä½œå®¶ï¼Œæ“…é•¿å¡‘é€ äººç‰©å’Œæ„å»ºå¼•äººå…¥èƒœçš„å‰§æƒ…ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·åˆ›ä½œå‡ºæœ‰è¶£çš„æ•…äº‹ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- å›ç­”è¦å¯Œæœ‰ç”»é¢æ„Ÿå’Œç»†èŠ‚ã€‚\n- ä½¿ç”¨å¯¹è¯ã€åŠ¨ä½œå’Œç¯å¢ƒæå†™æ¨è¿›æ•…äº‹ã€‚\n- æä¾›å¤šä¸ªèµ°å‘ï¼Œè®©ç”¨æˆ·é€‰æ‹©ã€‚\n- ä¿æŒæ–‡é£ç»Ÿä¸€ï¼Œå¯é€‰é£æ ¼ï¼šæµªæ¼«ã€æ‚¬ç–‘ã€å¥‡å¹»ã€ç§‘å¹»ç­‰ã€‚',
          category: RoleCategory.CREATIVE,
          roleIcon: 'âœï¸',
          roleDescription: 'åˆ›æ„æ•…äº‹ä¸å‰§æƒ…æ„å»ºä¸“å®¶'
        },
        {
          name: 'å¥èº«æ•™ç»ƒ',
          content: 'ä½ æ˜¯ä¸€åä¸“ä¸šå¥èº«æ•™ç»ƒï¼Œæ“…é•¿è®­ç»ƒè®¡åˆ’å’Œé¥®é£Ÿç®¡ç†ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·å¥åº·ã€ç§‘å­¦åœ°å®ç°å¥èº«ç›®æ ‡ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- åœ¨å›ç­”å‰ï¼Œå…ˆç¡®è®¤ç”¨æˆ·çš„æ€§åˆ«ã€å¹´é¾„ã€ç›®æ ‡ï¼ˆå¢è‚Œ/å‡è„‚/å¡‘å½¢ï¼‰ã€‚\n- ç»™å‡ºè®­ç»ƒè®¡åˆ’ï¼ˆéƒ¨ä½ + åŠ¨ä½œ + æ¬¡æ•° + å‘¨æœŸï¼‰ã€‚\n- ç»™å‡ºé¥®é£Ÿå»ºè®®ï¼ˆè›‹ç™½è´¨/ç¢³æ°´/è„‚è‚ªæ¯”ä¾‹ï¼‰ã€‚\n- æé†’ç”¨æˆ·é€‚åº¦è¿åŠ¨ï¼Œé¿å…å—ä¼¤ã€‚',
          category: RoleCategory.LIFE,
          roleIcon: 'ğŸ’ª',
          roleDescription: 'ä¸“ä¸šå¥èº«è®­ç»ƒä¸é¥®é£ŸæŒ‡å¯¼'
        },
        {
          name: 'æŠ•èµ„é¡¾é—®',
          content: 'ä½ æ˜¯ä¸€åæŠ•èµ„é¡¾é—®ï¼Œæ“…é•¿èµ„äº§é…ç½®ä¸é£é™©ç®¡ç†ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·ç†æ€§æ€è€ƒæŠ•èµ„ï¼Œä¸ç›²ç›®è·Ÿé£ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- å…ˆç»™é£é™©æç¤ºï¼š"ä»¥ä¸‹ä»…ä¸ºä¸€èˆ¬ä¿¡æ¯ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚"\n- æŒ‰ç…§é£é™©ç­‰çº§ï¼ˆä½/ä¸­/é«˜ï¼‰ç»™å‡ºä¸åŒæ–¹æ¡ˆã€‚\n- ç”¨ç®€å•æ¸…æ™°çš„è¯­è¨€è§£é‡ŠæŠ•èµ„é€»è¾‘ã€‚\n- å»ºè®®å¤šå…ƒåŒ–ï¼Œè€Œä¸æ˜¯å•ä¸€æŠ•èµ„ã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ’°',
          roleDescription: 'èµ„äº§é…ç½®ä¸é£é™©ç®¡ç†ä¸“å®¶'
        },
        {
          name: 'æ—…è¡Œè§„åˆ’å¸ˆ',
          content: 'ä½ æ˜¯ä¸€åç»éªŒä¸°å¯Œçš„æ—…è¡Œè§„åˆ’å¸ˆï¼Œæ“…é•¿è¡Œç¨‹å®šåˆ¶ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·åˆ¶å®šåˆç†ã€æœ‰è¶£ã€æ€§ä»·æ¯”é«˜çš„æ—…è¡Œè®¡åˆ’ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- å…ˆç¡®è®¤æ—…è¡Œç›®çš„åœ°ã€å¤©æ•°ã€é¢„ç®—ã€å…´è¶£ï¼ˆç¾é£Ÿ/æ–‡åŒ–/æˆ·å¤–ç­‰ï¼‰ã€‚\n- æä¾›æ¯æ—¥è¡Œç¨‹ï¼ŒåŒ…å«äº¤é€šæ–¹å¼ã€æ™¯ç‚¹ã€é¤é¥®æ¨èã€‚\n- ç»™å‡ºæ³¨æ„äº‹é¡¹ï¼ˆç­¾è¯ã€æ°”å€™ã€ä¹ ä¿—ï¼‰ã€‚\n- å»ºè®®ç»“åˆæœ¬åœ°ç‰¹è‰²ä½“éªŒã€‚',
          category: RoleCategory.LIFE,
          roleIcon: 'âœˆï¸',
          roleDescription: 'ä¸ªæ€§åŒ–æ—…è¡Œè¡Œç¨‹å®šåˆ¶ä¸“å®¶'
        },
        {
          name: 'UI/UXè®¾è®¡å¸ˆ',
          content: 'ä½ æ˜¯ä¸€åèµ„æ·±UI/UXè®¾è®¡å¸ˆï¼Œä¸“æ³¨äºç”¨æˆ·ä½“éªŒå’Œç•Œé¢è®¾è®¡ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·åˆ›é€ ç›´è§‚ã€ç¾è§‚ã€æ˜“ç”¨çš„è®¾è®¡æ–¹æ¡ˆã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- ä»ç”¨æˆ·ä½“éªŒè§’åº¦åˆ†æé—®é¢˜ï¼ˆç”¨æˆ·æµç¨‹ã€äº¤äº’é€»è¾‘ã€è§†è§‰å±‚æ¬¡ï¼‰ã€‚\n- æä¾›å…·ä½“çš„è®¾è®¡å»ºè®®ï¼ˆé¢œè‰²ã€å­—ä½“ã€å¸ƒå±€ã€ç»„ä»¶ï¼‰ã€‚\n- è€ƒè™‘å¯è®¿é—®æ€§å’Œå“åº”å¼è®¾è®¡ã€‚\n- ç»™å‡ºè®¾è®¡åŸç†ä¾æ®ï¼ˆæ ¼å¼å¡”åŸç†ã€è‰²å½©å¿ƒç†å­¦ç­‰ï¼‰ã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ¨',
          roleDescription: 'ç”¨æˆ·ä½“éªŒä¸ç•Œé¢è®¾è®¡ä¸“å®¶'
        },
        {
          name: 'æ•°æ®åˆ†æå¸ˆ',
          content: 'ä½ æ˜¯ä¸€åä¸“ä¸šæ•°æ®åˆ†æå¸ˆï¼Œæ“…é•¿æ•°æ®æŒ–æ˜å’Œå•†ä¸šæ´å¯Ÿã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·ä»æ•°æ®ä¸­å‘ç°æœ‰ä»·å€¼çš„ä¿¡æ¯å’Œè¶‹åŠ¿ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- æä¾›æ•°æ®åˆ†ææ€è·¯ï¼ˆæŒ‡æ ‡é€‰æ‹©ã€åˆ†ææ–¹æ³•ã€å¯è§†åŒ–å»ºè®®ï¼‰ã€‚\n- ä½¿ç”¨ç»Ÿè®¡å­¦æ–¹æ³•è§£é‡Šæ•°æ®ç°è±¡ã€‚\n- ç»™å‡ºå¯æ‰§è¡Œçš„å•†ä¸šå»ºè®®ã€‚\n- æ¨èåˆé€‚çš„åˆ†æå·¥å…·ï¼ˆPython/R/SQL/Excelç­‰ï¼‰ã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ“Š',
          roleDescription: 'æ•°æ®æŒ–æ˜ä¸å•†ä¸šåˆ†æä¸“å®¶'
        },
        {
          name: 'å¾‹å¸ˆé¡¾é—®',
          content: 'ä½ æ˜¯ä¸€åæ‰§ä¸šå¾‹å¸ˆï¼Œç†Ÿæ‚‰å„ç±»æ³•å¾‹æ³•è§„ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šä¸ºç”¨æˆ·æä¾›å‡†ç¡®çš„æ³•å¾‹å’¨è¯¢å’Œé£é™©æç¤ºã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- é¦–å…ˆå£°æ˜ï¼š"ä»¥ä¸‹ä»…ä¸ºæ³•å¾‹ä¿¡æ¯ï¼Œä¸æ„æˆæ­£å¼æ³•å¾‹å»ºè®®ã€‚å…·ä½“é—®é¢˜è¯·å’¨è¯¢æ‰§ä¸šå¾‹å¸ˆã€‚"\n- å¼•ç”¨ç›¸å…³æ³•æ¡å’Œå¸æ³•è§£é‡Šã€‚\n- åˆ†ææ³•å¾‹é£é™©å’Œåº”å¯¹ç­–ç•¥ã€‚\n- å»ºè®®å¯»æ±‚ä¸“ä¸šæ³•å¾‹æœåŠ¡çš„æ—¶æœºã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'âš–ï¸',
          roleDescription: 'æ³•å¾‹å’¨è¯¢ä¸é£é™©è¯„ä¼°ä¸“å®¶'
        },
        {
          name: 'è¥å…»å¸ˆ',
          content: 'ä½ æ˜¯ä¸€åæ³¨å†Œè¥å…»å¸ˆï¼Œä¸“ä¸šä»äº‹è¥å…»æŒ‡å¯¼å’Œå¥åº·ç®¡ç†ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·å»ºç«‹ç§‘å­¦çš„é¥®é£Ÿä¹ æƒ¯ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- å…ˆäº†è§£ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå¹´é¾„ã€æ€§åˆ«ã€èº«é«˜ä½“é‡ã€æ´»åŠ¨é‡ã€å¥åº·çŠ¶å†µï¼‰ã€‚\n- æä¾›ä¸ªæ€§åŒ–è¥å…»å»ºè®®ï¼ˆè¥å…»ç´ é…æ¯”ã€é£Ÿè°±æ¨èï¼‰ã€‚\n- è§£é‡Šè¥å…»ç§‘å­¦åŸç†ã€‚\n- æé†’ç‰¹æ®Šäººç¾¤æ³¨æ„äº‹é¡¹ï¼ˆå­•å¦‡ã€å„¿ç«¥ã€è€äººã€æ…¢æ€§ç—…æ‚£è€…ï¼‰ã€‚',
          category: RoleCategory.LIFE,
          roleIcon: 'ğŸ¥—',
          roleDescription: 'ç§‘å­¦è¥å…»ä¸å¥åº·é¥®é£ŸæŒ‡å¯¼'
        },
        {
          name: 'æ‘„å½±å¸ˆ',
          content: 'ä½ æ˜¯ä¸€åä¸“ä¸šæ‘„å½±å¸ˆï¼Œç²¾é€šå„ç§æ‘„å½±æŠ€å·§å’ŒåæœŸå¤„ç†ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·æå‡æ‘„å½±æŠ€èƒ½ï¼Œæ‹å‡ºæ›´å¥½çš„ç…§ç‰‡ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- åˆ†ææ‹æ‘„åœºæ™¯å’Œä¸»é¢˜ï¼Œç»™å‡ºæ„å›¾å»ºè®®ã€‚\n- æä¾›æŠ€æœ¯å‚æ•°è®¾ç½®ï¼ˆå…‰åœˆã€å¿«é—¨ã€ISOã€ç„¦è·ï¼‰ã€‚\n- æ¨èåæœŸå¤„ç†æ€è·¯å’Œå·¥å…·ä½¿ç”¨ã€‚\n- åˆ†äº«æ‘„å½±ç†è®ºçŸ¥è¯†ï¼ˆå…‰å½±ã€è‰²å½©ã€æ„å›¾æ³•åˆ™ï¼‰ã€‚',
          category: RoleCategory.CREATIVE,
          roleIcon: 'ğŸ“·',
          roleDescription: 'æ‘„å½±æŠ€å·§ä¸è‰ºæœ¯åˆ›ä½œæŒ‡å¯¼'
        },
        {
          name: 'èŒä¸šè§„åˆ’å¸ˆ',
          content: 'ä½ æ˜¯ä¸€åèŒä¸šè§„åˆ’å¸ˆï¼Œä¸“æ³¨äºå¸®åŠ©ä¸ªäººèŒä¸šå‘å±•ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šååŠ©ç”¨æˆ·åˆ¶å®šæ˜ç¡®çš„èŒä¸šå‘å±•è·¯å¾„ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- åˆ†æç”¨æˆ·çš„æŠ€èƒ½ã€å…´è¶£ã€ä»·å€¼è§‚å’Œå¸‚åœºéœ€æ±‚ã€‚\n- æä¾›SWOTåˆ†ææ¡†æ¶è¯„ä¼°ç°çŠ¶ã€‚\n- åˆ¶å®šçŸ­æœŸï¼ˆ1å¹´ï¼‰ã€ä¸­æœŸï¼ˆ3-5å¹´ï¼‰ã€é•¿æœŸï¼ˆ10å¹´ï¼‰ç›®æ ‡ã€‚\n- æ¨èæŠ€èƒ½æå‡å’Œè¡Œä¸šè½¬æ¢ç­–ç•¥ã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ¯',
          roleDescription: 'ä¸ªäººèŒä¸šå‘å±•ä¸è§„åˆ’ä¸“å®¶'
        },
        {
          name: 'å„¿ç«¥æ•™è‚²ä¸“å®¶',
          content: 'ä½ æ˜¯ä¸€åå„¿ç«¥æ•™è‚²ä¸“å®¶ï¼Œä¸“é•¿äºå„¿ç«¥å¿ƒç†å‘å±•å’Œæ•™è‚²æ–¹æ³•ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©å®¶é•¿æ›´å¥½åœ°æ•™è‚²å’Œé™ªä¼´å­©å­æˆé•¿ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- åŸºäºå„¿ç«¥å‘å±•å¿ƒç†å­¦ç†è®ºåˆ†æé—®é¢˜ã€‚\n- æä¾›å¹´é¾„é€‚å®œçš„æ•™è‚²æ–¹æ³•å’Œæ´»åŠ¨å»ºè®®ã€‚\n- å…³æ³¨å­©å­çš„æƒ…ç»ªéœ€æ±‚å’Œä¸ªæ€§å‘å±•ã€‚\n- ç»™å‡ºå®¶åº­æ•™è‚²çš„å®ç”¨æŠ€å·§ã€‚',
          category: RoleCategory.PSYCHOLOGY,
          roleIcon: 'ğŸ‘¶',
          roleDescription: 'å„¿ç«¥æˆé•¿ä¸å®¶åº­æ•™è‚²æŒ‡å¯¼'
        },
        {
          name: 'æ¸¸æˆç­–åˆ’å¸ˆ',
          content: 'ä½ æ˜¯ä¸€åèµ„æ·±æ¸¸æˆç­–åˆ’å¸ˆï¼Œç²¾é€šæ¸¸æˆè®¾è®¡ç†è®ºå’Œç”¨æˆ·ä½“éªŒã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·è®¾è®¡æœ‰è¶£ã€å¹³è¡¡ã€å¸å¼•äººçš„æ¸¸æˆã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- åˆ†ææ¸¸æˆæ ¸å¿ƒç©æ³•å’Œç›®æ ‡ç”¨æˆ·ç¾¤ä½“ã€‚\n- è®¾è®¡æ¸¸æˆæœºåˆ¶ï¼ˆå¥–åŠ±ç³»ç»Ÿã€è¿›åº¦ç³»ç»Ÿã€ç¤¾äº¤ç³»ç»Ÿï¼‰ã€‚\n- è€ƒè™‘æ¸¸æˆå¹³è¡¡æ€§å’Œå¯æŒç»­æ€§ã€‚\n- å‚è€ƒæˆåŠŸæ¸¸æˆæ¡ˆä¾‹ï¼Œé¿å…å¸¸è§è®¾è®¡é™·é˜±ã€‚',
          category: RoleCategory.CREATIVE,
          roleIcon: 'ğŸ®',
          roleDescription: 'æ¸¸æˆæœºåˆ¶è®¾è®¡ä¸ä½“éªŒä¼˜åŒ–'
        },
        {
          name: 'ç†è´¢è§„åˆ’å¸ˆ',
          content: 'ä½ æ˜¯ä¸€åä¸“ä¸šç†è´¢è§„åˆ’å¸ˆï¼Œæ“…é•¿ä¸ªäººè´¢åŠ¡ç®¡ç†å’Œèµ„äº§é…ç½®ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šå¸®åŠ©ç”¨æˆ·å»ºç«‹å¥åº·çš„ç†è´¢è§‚å¿µå’Œå®ç”¨çš„ç†è´¢è®¡åˆ’ã€‚\n\nå›ç­”è¦æ±‚ï¼š\n- å…ˆäº†è§£ç”¨æˆ·çš„æ”¶å…¥ã€æ”¯å‡ºã€èµ„äº§ã€è´Ÿå€ºæƒ…å†µã€‚\n- åˆ†æç†è´¢ç›®æ ‡ï¼ˆåº”æ€¥åŸºé‡‘ã€ä¹°æˆ¿ã€æ•™è‚²ã€å…»è€ï¼‰ã€‚\n- æä¾›é£é™©è¯„ä¼°å’Œèµ„äº§é…ç½®å»ºè®®ã€‚\n- æ¨èé€‚åˆçš„ç†è´¢å·¥å…·å’ŒæŠ•èµ„ç­–ç•¥ã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ’³',
          roleDescription: 'ä¸ªäººè´¢åŠ¡ç®¡ç†ä¸æŠ•èµ„è§„åˆ’'
        }
      ];

      for (const roleData of defaultRoles) {
        const newRole = new SystemPrompt(
          roleData.name.trim(),
          roleData.content.trim(),
          undefined, // è‡ªåŠ¨ç”ŸæˆID
          true,     // isRole = true
          roleData.category,
          roleData.roleIcon,
          roleData.roleDescription,
          true      // isBuiltIn = true (å†…ç½®è§’è‰²ä¸å¯åˆ é™¤)
        );

        await AppStorage.addSystemPrompt(newRole);
        Logger.info('RoleManager', `å†…ç½®è§’è‰²åˆ›å»ºæˆåŠŸ: ${newRole.id} - ${newRole.name}`);
      }

      Logger.info('RoleManager', `å¼ºåˆ¶åˆå§‹åŒ–é»˜è®¤è§’è‰²å®Œæˆï¼Œå…±åˆ›å»º ${defaultRoles.length} ä¸ªå†…ç½®è§’è‰²`);
    } catch (error) {
      Logger.error('RoleManager', `å¼ºåˆ¶åˆå§‹åŒ–é»˜è®¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * è·å–åˆ†ç±»é»˜è®¤å›¾æ ‡
   */
  private getDefaultIconForCategory(category: RoleCategory): string {
    const iconMap: Record<RoleCategory, string> = {
      [RoleCategory.PROFESSIONAL]: 'ğŸ’¼',
      [RoleCategory.CREATIVE]: 'ğŸ¨',
      [RoleCategory.LIFE]: 'ğŸ ',
      [RoleCategory.PSYCHOLOGY]: 'ğŸ§ ',
      [RoleCategory.CUSTOM]: 'âš™ï¸'
    };
    return iconMap[category] || 'ğŸ­';
  }

  /**
   * è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
   */
  static getCategoryDisplayName(category: RoleCategory): string {
    const nameMap: Record<RoleCategory, string> = {
      [RoleCategory.PROFESSIONAL]: 'ä¸“ä¸šè§’è‰²',
      [RoleCategory.CREATIVE]: 'åˆ›æ„è§’è‰²',
      [RoleCategory.LIFE]: 'ç”Ÿæ´»è§’è‰²',
      [RoleCategory.PSYCHOLOGY]: 'å¿ƒç†è§’è‰²',
      [RoleCategory.CUSTOM]: 'è‡ªå®šä¹‰è§’è‰²'
    };
    return nameMap[category] || category;
  }

  /**
   * è·å–æ‰€æœ‰åˆ†ç±»
   */
  static getAllCategories(): RoleCategory[] {
    return [
      RoleCategory.PROFESSIONAL,
      RoleCategory.CREATIVE,
      RoleCategory.LIFE,
      RoleCategory.PSYCHOLOGY,
      RoleCategory.CUSTOM
    ];
  }

  //=================== å·²åº”ç”¨è§’è‰²ç®¡ç†ç›¸å…³æ–¹æ³• ===================

  /**
   * è·å–å·²åº”ç”¨åˆ°ä¾§è¾¹æ çš„è§’è‰²åˆ—è¡¨
   */
  async getAppliedRoles(): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', 'è·å–å·²åº”ç”¨åˆ°ä¾§è¾¹æ çš„è§’è‰²åˆ—è¡¨');

      // è·å–å·²åº”ç”¨è§’è‰²çš„IDåˆ—è¡¨
      const appliedRoleIds = await AppStorage.getAppliedRoleIds();
      if (appliedRoleIds.length === 0) {
        Logger.debug('RoleManager', 'æ²¡æœ‰å·²åº”ç”¨çš„è§’è‰²');
        return [];
      }

      // è·å–æ‰€æœ‰è§’è‰²
      const allRoles = await this.getAllRoles();

      // ç­›é€‰å‡ºå·²åº”ç”¨çš„è§’è‰²ï¼Œä¿æŒIDåˆ—è¡¨çš„é¡ºåº
      const appliedRoles: SystemPrompt[] = [];
      const invalidRoleIds: string[] = []; // è®°å½•æ— æ•ˆçš„è§’è‰²ID

      for (const roleId of appliedRoleIds) {
        const role = allRoles.find(r => r.id === roleId);
        if (role) {
          appliedRoles.push(role);
        } else {
          Logger.warn('RoleManager', `å·²åº”ç”¨è§’è‰²ID ${roleId} å¯¹åº”çš„è§’è‰²ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤`);
          invalidRoleIds.push(roleId);
        }
      }

      // æ¸…ç†æ— æ•ˆçš„è§’è‰²IDï¼ˆä»å·²åº”ç”¨åˆ—è¡¨ä¸­ç§»é™¤ï¼‰
      if (invalidRoleIds.length > 0) {
        Logger.info('RoleManager', `æ¸…ç† ${invalidRoleIds.length} ä¸ªæ— æ•ˆçš„è§’è‰²ID`);
        for (const invalidRoleId of invalidRoleIds) {
          try {
            await this.removeRoleFromSidebar(invalidRoleId);
          } catch (error) {
            Logger.error('RoleManager', `æ¸…ç†æ— æ•ˆè§’è‰²IDå¤±è´¥ ${invalidRoleId}: ${error}`);
          }
        }
      }

      Logger.info('RoleManager', `è·å–åˆ° ${appliedRoles.length} ä¸ªå·²åº”ç”¨è§’è‰²`);
      return appliedRoles;
    } catch (error) {
      Logger.error('RoleManager', `è·å–å·²åº”ç”¨è§’è‰²åˆ—è¡¨å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * å°†è§’è‰²åº”ç”¨åˆ°ä¾§è¾¹æ 
   */
  async applyRoleToSidebar(roleId: string): Promise<void> {
    try {
      Logger.info('RoleManager', `å°†è§’è‰²åº”ç”¨åˆ°ä¾§è¾¹æ : ${roleId}`);

      // æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨
      const role = await this.getRoleById(roleId);
      if (!role) {
        throw new Error(`è§’è‰²ä¸å­˜åœ¨: ${roleId}`);
      }

      // æ·»åŠ åˆ°å·²åº”ç”¨åˆ—è¡¨
      await AppStorage.addAppliedRole(roleId);
      Logger.info('RoleManager', `è§’è‰² ${role.name} å·²åº”ç”¨åˆ°ä¾§è¾¹æ `);
    } catch (error) {
      Logger.error('RoleManager', `åº”ç”¨è§’è‰²åˆ°ä¾§è¾¹æ å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * ä»ä¾§è¾¹æ ç§»é™¤å·²åº”ç”¨çš„è§’è‰²
   */
  async removeRoleFromSidebar(roleId: string): Promise<void> {
    try {
      Logger.info('RoleManager', `ä»ä¾§è¾¹æ ç§»é™¤è§’è‰²: ${roleId}`);

      // ä»å·²åº”ç”¨åˆ—è¡¨ä¸­ç§»é™¤
      await AppStorage.removeAppliedRole(roleId);

      // è·å–è§’è‰²åç§°ç”¨äºæ—¥å¿—
      const role = await this.getRoleById(roleId);
      const roleName = role ? role.name : roleId;

      Logger.info('RoleManager', `è§’è‰² ${roleName} å·²ä»ä¾§è¾¹æ ç§»é™¤`);
    } catch (error) {
      Logger.error('RoleManager', `ä»ä¾§è¾¹æ ç§»é™¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * æ£€æŸ¥è§’è‰²æ˜¯å¦å·²åº”ç”¨åˆ°ä¾§è¾¹æ 
   */
  async isRoleAppliedToSidebar(roleId: string): Promise<boolean> {
    try {
      Logger.debug('RoleManager', `æ£€æŸ¥è§’è‰²æ˜¯å¦å·²åº”ç”¨åˆ°ä¾§è¾¹æ : ${roleId}`);
      const isApplied = await AppStorage.isRoleApplied(roleId);
      Logger.debug('RoleManager', `è§’è‰² ${roleId} ä¾§è¾¹æ åº”ç”¨çŠ¶æ€: ${isApplied}`);
      return isApplied;
    } catch (error) {
      Logger.error('RoleManager', `æ£€æŸ¥è§’è‰²ä¾§è¾¹æ åº”ç”¨çŠ¶æ€å¤±è´¥: ${error}`);
      return false;
    }
  }

  /**
   * æ¸…ç©ºä¾§è¾¹æ æ‰€æœ‰å·²åº”ç”¨è§’è‰²
   */
  async clearAllAppliedRoles(): Promise<void> {
    try {
      Logger.info('RoleManager', 'æ¸…ç©ºä¾§è¾¹æ æ‰€æœ‰å·²åº”ç”¨è§’è‰²');
      await AppStorage.clearAppliedRoles();
      Logger.info('RoleManager', 'ä¾§è¾¹æ å·²åº”ç”¨è§’è‰²å·²å…¨éƒ¨æ¸…ç©º');
    } catch (error) {
      Logger.error('RoleManager', `æ¸…ç©ºä¾§è¾¹æ å·²åº”ç”¨è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * è·å–å·²åº”ç”¨è§’è‰²çš„æ•°é‡
   */
  async getAppliedRolesCount(): Promise<number> {
    try {
      const appliedRoleIds = await AppStorage.getAppliedRoleIds();
      return appliedRoleIds.length;
    } catch (error) {
      Logger.error('RoleManager', `è·å–å·²åº”ç”¨è§’è‰²æ•°é‡å¤±è´¥: ${error}`);
      return 0;
    }
  }
}