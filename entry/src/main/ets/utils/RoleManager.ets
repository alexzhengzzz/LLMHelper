import { SystemPrompt } from '../models/ChatModels';
import { AppStorage } from './AppStorage';
import { Logger } from './Logger';

/**
 * è§’è‰²åˆ†ç±»æšä¸¾
 */
export enum RoleCategory {
  PROFESSIONAL = 'professional',  // ä¸“ä¸šè§’è‰²
  CREATIVE = 'creative',        // åˆ›æ„è§’è‰²
  LIFE = 'life',                // ç”Ÿæ´»è§’è‰²
  PSYCHOLOGY = 'psychology',    // å¿ƒç†è§’è‰²
  CUSTOM = 'custom'             // è‡ªå®šä¹‰è§’è‰²
}

/**
 * è§’è‰²æ’åºé€‰é¡¹
 */
export interface RoleSortOption {
  field: 'usageCount' | 'timestamp' | 'name' | 'pinned';
  order: 'asc' | 'desc';
}

/**
 * è§’è‰²ç»Ÿè®¡ä¿¡æ¯
 */
export interface RoleStats {
  totalRoles: number;
  totalUsage: number;
  categoryStats: Record<string, number>;
  mostUsedRole: SystemPrompt | null;
}

/**
 * è§’è‰²ç­›é€‰é€‰é¡¹
 */
export interface RoleFilterOptions {
  category?: RoleCategory;
  searchQuery?: string;
  isPinned?: boolean;
  isBuiltIn?: boolean;
}

/**
 * è§’è‰²ç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†AIè§’è‰²ï¼ˆç³»ç»Ÿæç¤ºè¯ï¼‰
 */
export class RoleManager {
  private static instance: RoleManager | null = null;

  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance(): RoleManager {
    if (!RoleManager.instance) {
      RoleManager.instance = new RoleManager();
    }
    return RoleManager.instance;
  }

  /**
   * è·å–æ‰€æœ‰è§’è‰²
   */
  async getAllRoles(): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', 'è·å–æ‰€æœ‰è§’è‰²');
      const roles = await AppStorage.getSystemPrompts();
      Logger.info('RoleManager', `è·å–åˆ° ${roles.length} ä¸ªè§’è‰²`);
      return roles.filter(role => role.isRole); // åªè¿”å›è§’è‰²ç±»å‹çš„æç¤ºè¯
    } catch (error) {
      Logger.error('RoleManager', `è·å–è§’è‰²åˆ—è¡¨å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * æŒ‰åˆ†ç±»è·å–è§’è‰²
   */
  async getRolesByCategory(category: RoleCategory): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `è·å–åˆ†ç±»è§’è‰²: ${category}`);
      const allRoles = await this.getAllRoles();
      const filteredRoles = allRoles.filter(role => role.roleCategory === category);
      Logger.info('RoleManager', `åˆ†ç±» ${category} æœ‰ ${filteredRoles.length} ä¸ªè§’è‰²`);
      return filteredRoles;
    } catch (error) {
      Logger.error('RoleManager', `è·å–åˆ†ç±»è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * ç­›é€‰è§’è‰²
   */
  async filterRoles(options: RoleFilterOptions): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `ç­›é€‰è§’è‰²ï¼Œé€‰é¡¹: ${JSON.stringify(options)}`);
      let roles = await this.getAllRoles();

      // æŒ‰åˆ†ç±»ç­›é€‰
      if (options.category) {
        roles = roles.filter(role => role.roleCategory === options.category);
      }

      // æŒ‰ç½®é¡¶çŠ¶æ€ç­›é€‰
      if (options.isPinned !== undefined) {
        roles = roles.filter(role => role.isPinned === options.isPinned);
      }

      // æŒ‰å†…ç½®çŠ¶æ€ç­›é€‰
      if (options.isBuiltIn !== undefined) {
        roles = roles.filter(role => role.isBuiltIn === options.isBuiltIn);
      }

      // æŒ‰æœç´¢æŸ¥è¯¢ç­›é€‰
      if (options.searchQuery && options.searchQuery.trim()) {
        const query = options.searchQuery.toLowerCase().trim();
        roles = roles.filter(role =>
          role.name.toLowerCase().includes(query) ||
          role.content.toLowerCase().includes(query) ||
          role.roleDescription.toLowerCase().includes(query)
        );
      }

      Logger.info('RoleManager', `ç­›é€‰åå¾—åˆ° ${roles.length} ä¸ªè§’è‰²`);
      return roles;
    } catch (error) {
      Logger.error('RoleManager', `ç­›é€‰è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * æ’åºè§’è‰²
   */
  sortRoles(roles: SystemPrompt[], sortOption: RoleSortOption): SystemPrompt[] {
    try {
      Logger.info('RoleManager', `æ’åºè§’è‰²ï¼Œé€‰é¡¹: ${JSON.stringify(sortOption)}`);

      const sortedRoles = [...roles].sort((a, b) => {
        let valueA: number | string, valueB: number | string;

        switch (sortOption.field) {
          case 'usageCount':
            valueA = a.usageCount;
            valueB = b.usageCount;
            break;
          case 'timestamp':
            valueA = a.timestamp;
            valueB = b.timestamp;
            break;
          case 'name':
            valueA = a.name.toLowerCase();
            valueB = b.name.toLowerCase();
            break;
          case 'pinned':
            valueA = a.isPinned ? 1 : 0;
            valueB = b.isPinned ? 1 : 0;
            break;
          default:
            valueA = a.timestamp;
            valueB = b.timestamp;
        }

        if (sortOption.order === 'asc') {
          return valueA > valueB ? 1 : -1;
        } else {
          return valueA < valueB ? 1 : -1;
        }
      });

      Logger.info('RoleManager', 'è§’è‰²æ’åºå®Œæˆ');
      return sortedRoles;
    } catch (error) {
      Logger.error('RoleManager', `æ’åºè§’è‰²å¤±è´¥: ${error}`);
      return roles;
    }
  }

  /**
   * åˆ›å»ºæ–°è§’è‰²
   */
  async createRole(name: string, content: string, category: RoleCategory = RoleCategory.CUSTOM,
                   roleIcon: string = '', roleDescription: string = ''): Promise<SystemPrompt> {
    try {
      Logger.info('RoleManager', `åˆ›å»ºæ–°è§’è‰²: ${name}`);

      const newRole = new SystemPrompt(
        name.trim(),
        content.trim(),
        undefined, // è‡ªåŠ¨ç”ŸæˆID
        true,     // isRole = true
        category,
        roleIcon || this.getDefaultIconForCategory(category),
        roleDescription || name,
        false    // isBuiltIn = false
      );

      await AppStorage.addSystemPrompt(newRole);
      Logger.info('RoleManager', `è§’è‰²åˆ›å»ºæˆåŠŸ: ${newRole.id}`);
      return newRole;
    } catch (error) {
      Logger.error('RoleManager', `åˆ›å»ºè§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * æ›´æ–°è§’è‰²
   */
  async updateRole(role: SystemPrompt): Promise<void> {
    try {
      Logger.info('RoleManager', `æ›´æ–°è§’è‰²: ${role.name}`);

      // ç¡®ä¿æ˜¯è§’è‰²ç±»å‹
      role.isRole = true;
      role.timestamp = Date.now(); // æ›´æ–°æ—¶é—´æˆ³

      await AppStorage.updateSystemPrompt(role);
      Logger.info('RoleManager', `è§’è‰²æ›´æ–°æˆåŠŸ: ${role.id}`);
    } catch (error) {
      Logger.error('RoleManager', `æ›´æ–°è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * åˆ é™¤è§’è‰²
   */
  async deleteRole(roleId: string): Promise<void> {
    try {
      Logger.info('RoleManager', `åˆ é™¤è§’è‰²: ${roleId}`);

      // æ£€æŸ¥æ˜¯å¦ä¸ºå†…ç½®è§’è‰²
      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role && role.isBuiltIn) {
        throw new Error('ä¸èƒ½åˆ é™¤å†…ç½®è§’è‰²');
      }

      await AppStorage.deleteSystemPrompt(roleId);
      Logger.info('RoleManager', `è§’è‰²åˆ é™¤æˆåŠŸ: ${roleId}`);
    } catch (error) {
      Logger.error('RoleManager', `åˆ é™¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * å¢åŠ è§’è‰²ä½¿ç”¨ç»Ÿè®¡
   */
  async incrementRoleUsage(roleId: string): Promise<void> {
    try {
      Logger.debug('RoleManager', `å¢åŠ è§’è‰²ä½¿ç”¨ç»Ÿè®¡: ${roleId}`);

      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role) {
        role.usageCount++;
        role.timestamp = Date.now();
        await AppStorage.updateSystemPrompt(role);
        Logger.debug('RoleManager', `è§’è‰² ${roleId} ä½¿ç”¨æ¬¡æ•°: ${role.usageCount}`);
      }
    } catch (error) {
      Logger.error('RoleManager', `å¢åŠ è§’è‰²ä½¿ç”¨ç»Ÿè®¡å¤±è´¥: ${error}`);
    }
  }

  /**
   * è®¾ç½®è§’è‰²ç½®é¡¶çŠ¶æ€
   */
  async pinRole(roleId: string, pinned: boolean): Promise<void> {
    try {
      Logger.info('RoleManager', `è®¾ç½®è§’è‰²ç½®é¡¶çŠ¶æ€: ${roleId} -> ${pinned}`);

      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role) {
        role.isPinned = pinned;
        role.timestamp = Date.now();
        await AppStorage.updateSystemPrompt(role);
        Logger.info('RoleManager', `è§’è‰²ç½®é¡¶çŠ¶æ€è®¾ç½®æˆåŠŸ: ${roleId}`);
      }
    } catch (error) {
      Logger.error('RoleManager', `è®¾ç½®è§’è‰²ç½®é¡¶çŠ¶æ€å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * è·å–è§’è‰²è¯¦æƒ…
   */
  async getRoleById(roleId: string): Promise<SystemPrompt | null> {
    try {
      Logger.debug('RoleManager', `è·å–è§’è‰²è¯¦æƒ…: ${roleId}`);

      const roles = await this.getAllRoles();
      const role = roles.find(r => r.id === roleId);

      if (role) {
        Logger.debug('RoleManager', `æ‰¾åˆ°è§’è‰²: ${role.name}`);
        return role;
      }

      Logger.warn('RoleManager', `æœªæ‰¾åˆ°è§’è‰²: ${roleId}`);
      return null;
    } catch (error) {
      Logger.error('RoleManager', `è·å–è§’è‰²è¯¦æƒ…å¤±è´¥: ${error}`);
      return null;
    }
  }

  /**
   * æœç´¢è§’è‰²
   */
  async searchRoles(query: string): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `æœç´¢è§’è‰²: ${query}`);

      if (!query || !query.trim()) {
        return await this.getAllRoles();
      }

      const options: RoleFilterOptions = {
        searchQuery: query.trim()
      };

      const results = await this.filterRoles(options);
      Logger.info('RoleManager', `æœç´¢åˆ° ${results.length} ä¸ªè§’è‰²`);
      return results;
    } catch (error) {
      Logger.error('RoleManager', `æœç´¢è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–æœ€å¸¸ç”¨çš„è§’è‰²
   */
  async getMostUsedRoles(limit: number = 5): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `è·å–æœ€å¸¸ç”¨çš„ ${limit} ä¸ªè§’è‰²`);

      const roles = await this.getAllRoles();
      const sortedRoles = this.sortRoles(roles, {
        field: 'usageCount',
        order: 'desc'
      });

      return sortedRoles.slice(0, limit);
    } catch (error) {
      Logger.error('RoleManager', `è·å–æœ€å¸¸ç”¨è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–æœ€è¿‘ä½¿ç”¨çš„è§’è‰²
   */
  async getRecentRoles(limit: number = 5): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', `è·å–æœ€è¿‘ä½¿ç”¨çš„ ${limit} ä¸ªè§’è‰²`);

      const roles = await this.getAllRoles();
      const sortedRoles = this.sortRoles(roles, {
        field: 'timestamp',
        order: 'desc'
      });

      return sortedRoles.slice(0, limit);
    } catch (error) {
      Logger.error('RoleManager', `è·å–æœ€è¿‘ä½¿ç”¨è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–ç½®é¡¶è§’è‰²
   */
  async getPinnedRoles(): Promise<SystemPrompt[]> {
    try {
      Logger.info('RoleManager', 'è·å–ç½®é¡¶è§’è‰²');

      const options: RoleFilterOptions = {
        isPinned: true
      };

      const pinnedRoles = await this.filterRoles(options);
      const sortedRoles = this.sortRoles(pinnedRoles, {
        field: 'timestamp',
        order: 'desc'
      });

      Logger.info('RoleManager', `æ‰¾åˆ° ${sortedRoles.length} ä¸ªç½®é¡¶è§’è‰²`);
      return sortedRoles;
    } catch (error) {
      Logger.error('RoleManager', `è·å–ç½®é¡¶è§’è‰²å¤±è´¥: ${error}`);
      return [];
    }
  }

  /**
   * è·å–è§’è‰²ç»Ÿè®¡ä¿¡æ¯
   */
  async getRoleStats(): Promise<RoleStats> {
    try {
      Logger.info('RoleManager', 'è·å–è§’è‰²ç»Ÿè®¡ä¿¡æ¯');

      const roles = await this.getAllRoles();
      const totalRoles = roles.length;
      const totalUsage = roles.reduce((sum, role) => sum + role.usageCount, 0);

      // åˆ†ç±»ç»Ÿè®¡
      const categoryStats: Record<string, number> = {};
      roles.forEach(role => {
        categoryStats[role.roleCategory] = (categoryStats[role.roleCategory] || 0) + 1;
      });

      // æœ€å¸¸ç”¨è§’è‰²
      const mostUsedRole = roles.length > 0
        ? roles.reduce((prev, current) => prev.usageCount > current.usageCount ? prev : current)
        : null;

      const stats: RoleStats = {
        totalRoles,
        totalUsage,
        categoryStats,
        mostUsedRole
      };

      Logger.info('RoleManager', `è§’è‰²ç»Ÿè®¡: ${JSON.stringify(stats)}`);
      return stats;
    } catch (error) {
      Logger.error('RoleManager', `è·å–è§’è‰²ç»Ÿè®¡å¤±è´¥: ${error}`);
      return {
        totalRoles: 0,
        totalUsage: 0,
        categoryStats: {},
        mostUsedRole: null
      } as RoleStats;
    }
  }

  /**
   * åˆå§‹åŒ–é»˜è®¤è§’è‰²
   */
  async initializeDefaultRoles(): Promise<void> {
    try {
      Logger.info('RoleManager', 'åˆå§‹åŒ–é»˜è®¤è§’è‰²');

      const existingRoles = await this.getAllRoles();
      if (existingRoles.length > 0) {
        Logger.info('RoleManager', 'å·²å­˜åœ¨è§’è‰²ï¼Œè·³è¿‡åˆå§‹åŒ–');
        return;
      }

      interface DefaultRoleData {
        name: string;
        content: string;
        category: RoleCategory;
        roleIcon: string;
        roleDescription: string;
      }

      const defaultRoles: DefaultRoleData[] = [
        {
          name: 'ç¼–ç¨‹åŠ©æ‰‹',
          content: 'ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„ç¼–ç¨‹åŠ©æ‰‹ï¼Œæ“…é•¿å¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·è§£å†³ç¼–ç¨‹é—®é¢˜ã€è°ƒè¯•ä»£ç ã€ä¼˜åŒ–ç®—æ³•ã€‚è¯·ç”¨ä¸“ä¸šä¸”æ˜“æ‡‚çš„è¯­è¨€å›ç­”æŠ€æœ¯é—®é¢˜ã€‚',
          category: RoleCategory.PROFESSIONAL,
          roleIcon: 'ğŸ’»',
          roleDescription: 'ä¸“ä¸šçš„ç¼–ç¨‹æŠ€æœ¯æ”¯æŒ'
        },
        {
          name: 'åˆ›æ„å†™ä½œåŠ©æ‰‹',
          content: 'ä½ æ˜¯ä¸€ä½å¯Œæœ‰åˆ›æ„çš„å†™ä½œåŠ©æ‰‹ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·è¿›è¡Œåˆ›æ„å†™ä½œã€æ•…äº‹åˆ›ä½œã€æ–‡æ¡ˆç­–åˆ’ç­‰ã€‚è¯·ç”¨å¯Œæœ‰æƒ³è±¡åŠ›å’Œå¯å‘æ€§çš„æ–¹å¼ååŠ©ç”¨æˆ·åˆ›ä½œã€‚',
          category: RoleCategory.CREATIVE,
          roleIcon: 'âœï¸',
          roleDescription: 'æ¿€å‘åˆ›æ„çµæ„Ÿçš„å†™ä½œä¼™ä¼´'
        },
        {
          name: 'ç”Ÿæ´»é¡¾é—®',
          content: 'ä½ æ˜¯ä¸€ä½äº²åˆ‡çš„ç”Ÿæ´»é¡¾é—®ï¼Œèƒ½å¤Ÿä¸ºç”¨æˆ·æä¾›ç”Ÿæ´»å»ºè®®ã€æƒ…æ„Ÿæ”¯æŒã€æ—¥å¸¸è§„åˆ’ç­‰å¸®åŠ©ã€‚è¯·ç”¨æ¸©æš–ã€ä½“è´´çš„è¯­è¨€ä¸ç”¨æˆ·äº¤æµã€‚',
          category: RoleCategory.LIFE,
          roleIcon: 'ğŸ ',
          roleDescription: 'æ¸©æš–è´´å¿ƒçš„ç”Ÿæ´»æŒ‡å¯¼'
        },
        {
          name: 'å¿ƒç†å’¨è¯¢å¸ˆ',
          content: 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¿ƒç†å’¨è¯¢å¸ˆï¼Œèƒ½å¤Ÿä¸ºç”¨æˆ·æä¾›å¿ƒç†æ”¯æŒã€æƒ…ç»ªç–å¯¼ã€å‹åŠ›ç®¡ç†ç­‰ä¸“ä¸šå¸®åŠ©ã€‚è¯·ç”¨ä¸“ä¸šã€æ¸©å’Œã€ä¿å¯†çš„æ€åº¦ä¸ºç”¨æˆ·æä¾›æœåŠ¡ã€‚',
          category: RoleCategory.PSYCHOLOGY,
          roleIcon: 'ğŸ§ ',
          roleDescription: 'ä¸“ä¸šå¿ƒç†æ”¯æŒä¸å€¾å¬'
        }
      ];

      for (const roleData of defaultRoles) {
        await this.createRole(
          roleData.name,
          roleData.content,
          roleData.category,
          roleData.roleIcon,
          roleData.roleDescription
        );
      }

      Logger.info('RoleManager', 'é»˜è®¤è§’è‰²åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      Logger.error('RoleManager', `åˆå§‹åŒ–é»˜è®¤è§’è‰²å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * è·å–åˆ†ç±»é»˜è®¤å›¾æ ‡
   */
  private getDefaultIconForCategory(category: RoleCategory): string {
    const iconMap: Record<RoleCategory, string> = {
      [RoleCategory.PROFESSIONAL]: 'ğŸ’¼',
      [RoleCategory.CREATIVE]: 'ğŸ¨',
      [RoleCategory.LIFE]: 'ğŸ ',
      [RoleCategory.PSYCHOLOGY]: 'ğŸ§ ',
      [RoleCategory.CUSTOM]: 'âš™ï¸'
    };
    return iconMap[category] || 'ğŸ­';
  }

  /**
   * è·å–åˆ†ç±»æ˜¾ç¤ºåç§°
   */
  static getCategoryDisplayName(category: RoleCategory): string {
    const nameMap: Record<RoleCategory, string> = {
      [RoleCategory.PROFESSIONAL]: 'ä¸“ä¸šè§’è‰²',
      [RoleCategory.CREATIVE]: 'åˆ›æ„è§’è‰²',
      [RoleCategory.LIFE]: 'ç”Ÿæ´»è§’è‰²',
      [RoleCategory.PSYCHOLOGY]: 'å¿ƒç†è§’è‰²',
      [RoleCategory.CUSTOM]: 'è‡ªå®šä¹‰è§’è‰²'
    };
    return nameMap[category] || category;
  }

  /**
   * è·å–æ‰€æœ‰åˆ†ç±»
   */
  static getAllCategories(): RoleCategory[] {
    return [
      RoleCategory.PROFESSIONAL,
      RoleCategory.CREATIVE,
      RoleCategory.LIFE,
      RoleCategory.PSYCHOLOGY,
      RoleCategory.CUSTOM
    ];
  }
}