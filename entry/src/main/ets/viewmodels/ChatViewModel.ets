import { Message, MessageRole, ChatRequest, Provider, SimpleMessage, SystemPrompt, Session, MultiRoleSession, isMultiRoleSession, SessionParticipant, ThinkingStatus, ThinkingStep, ToolCall, DebateSession, DebateStatus, DebateParticipantStats } from '../models/ChatModels';
import { ApiService } from '../services/ApiService';
import { APIManager, APIMode, AIProvider } from '../services/APIManager';
import { ChatRequest as APIChatRequest, ChatMessage as APIChatMessage } from '../types/APITypes';
import { AppStorage, ModelConfig } from '../utils/AppStorage';
import { TTSService, TTSState, TTSCallbacks } from '../services/TTSService';
import { AutoTTSService } from '../services/AutoTTSService';
import { SessionManager } from '../utils/SessionManager';
import { HybridChatService, HybridChatRequest, HybridChatResponse } from '../services/HybridChatService';
import { MessageEnhancer, SearchInfo } from '../services/MessageEnhancer';
import { DeepThinkingService, DeepThinkingResult, DeepThinkingCallbacks } from '../services/DeepThinkingService';
import { Logger, LogContext } from '../utils/Logger';
import { ErrorManager } from '../utils/ErrorManager';
import { ErrorType, ErrorCode, ErrorLevel, ErrorContext } from '../types/ErrorTypes';
import { ServerConfigManager, ServerEndpoint } from '../utils/ServerConfigManager';
import { ToolCallResult } from '../types/MCPTypes';
import { LocalToolManager } from '../services/LocalToolManager';
import { MemoryManager } from '../utils/MemoryManager';

// ç”¨äºæè¿°ä»å­˜å‚¨ä¸­ååºåˆ—åŒ–çš„æ¶ˆæ¯å¯¹è±¡
interface StoredMessage {
  id?: string;
  __ob_id?: string;
  role?: string;
  __ob_role?: string;
  content?: string;
  __ob_content?: string;
  timestamp?: number;
  __ob_timestamp?: number;
  isLoading?: boolean;
  __ob_isLoading?: boolean;
  webUsed?: boolean;
  __ob_webUsed?: boolean;
  searchInfo?: string;
  __ob_searchInfo?: string;
}

// è‡ªåŠ¨æ’­æŠ¥çŠ¶æ€æ¥å£
interface AutoTTSStatus {
  isEnabled: boolean;
  isPlaying: boolean;
  queueLength: number;
}

// ä¼šè¯ç»Ÿè®¡ä¿¡æ¯è§†å›¾æ¥å£
interface SessionStatsView {
  totalSessions: number;
  maxSessions: number;
  currentSessionName: string | null;
}

// éŸ³é¢‘æ’­æ”¾çŠ¶æ€ä¿¡æ¯æ¥å£
interface AudioStateInfo {
  messagePlaying: boolean;
  ttsPlaying: boolean;
  currentMessage: string | null;
  audioLock: boolean;
}

// å·¥å…·è°ƒç”¨çŠ¶æ€æ¥å£
interface ToolCallState {
  isToolsEnabled: boolean;
  toolsSupported: boolean;
  availableToolsCount: number;
  executingTools: boolean;
  lastToolCalls?: ToolCall[];
  lastToolResults?: ToolCallResult[];
}

/**
 * èŠå¤©åŠŸèƒ½ViewModel - å¤„ç†èŠå¤©ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
 */
@ObservedV2
export class ChatViewModel {
  @Trace messages: Message[] = [];
  @Trace isLoading: boolean = false;
  @Trace currentProvider: string = '';
  @Trace currentModel: string = '';
  @Trace providers: Provider[] = [];
  @Trace systemPrompts: SystemPrompt[] = [];
  // @Trace selectedSystemPrompt: SystemPrompt | null = null; // å·²ç§»é™¤ï¼šä¸å†ä½¿ç”¨å…¨å±€çŠ¶æ€ï¼Œæ”¹ç”¨ä¼šè¯ç»‘å®š

  // ä¼šè¯ç®¡ç†ç›¸å…³å±æ€§
  @Trace currentSession: Session | null = null;
  @Trace sessions: Session[] = [];

  private apiService: ApiService;
  public apiManager: APIManager;
  private ttsService: TTSService;
  private autoTTSService: AutoTTSService;
  private sessionManager: SessionManager;
  private hybridChatService: HybridChatService;
  private deepThinkingService: DeepThinkingService;
  private audioPlaybackStateManager: AudioPlaybackStateManager;
  private serverConfigManager: ServerConfigManager;
  private memoryManager: MemoryManager;
  
  // éŸ³é¢‘æ’­æ”¾é”ï¼Œé˜²æ­¢å¹¶å‘æ’­æ”¾
  private audioPlaybackLock: boolean = false;
  
  // è·Ÿè¸ªTTSå›è°ƒçŠ¶æ€ï¼Œé˜²æ­¢åä¸ºTTSé‡å¤å›è°ƒ
  private ttsCallbackStates: Map<string, boolean> = new Map<string, boolean>();
  
  // æ·±åº¦æ€è€ƒç›¸å…³
  @Trace currentThinkingMessageId: string = '';

  // å·¥å…·è°ƒç”¨ç›¸å…³
  @Trace isToolsEnabled: boolean = false;
  @Trace executingTools: boolean = false;

  constructor() {
    this.apiService = new ApiService();
    this.apiManager = APIManager.getInstance();
    this.ttsService = TTSService.getInstance();
    this.autoTTSService = AutoTTSService.getInstance();
    this.sessionManager = SessionManager.getInstance();
    this.hybridChatService = HybridChatService.getInstance();
    this.deepThinkingService = DeepThinkingService.getInstance();
    this.audioPlaybackStateManager = new AudioPlaybackStateManager();
    this.serverConfigManager = ServerConfigManager.getInstance();
    this.memoryManager = MemoryManager.getInstance();
    
    // æ·»åŠ ä¼šè¯æ•°æ®æ¸…é™¤ç›‘å¬å™¨
    AppStorage.addSessionDataClearedListener(() => this.onSessionDataCleared());
    
    // æ·»åŠ æœåŠ¡å™¨é…ç½®å˜æ›´ç›‘å¬å™¨
    this.serverConfigManager.addConfigChangeListener((config: ServerEndpoint) => {
      this.onServerConfigChanged(config);
    });
    
    // æ·»åŠ APIæ¨¡å¼å˜æ›´ç›‘å¬å™¨
    this.apiManager.addModeChangeListener((mode: APIMode) => {
      this.onAPIModeChanged(mode);
    });
  }

  async loadInitialData(): Promise<void> {
    try {
      // åˆå§‹åŒ–ä¼šè¯ç®¡ç†
      await this.initializeSessions();
      
      // åŠ è½½å½“å‰ä¼šè¯çš„æ¶ˆæ¯
      await this.loadMessages();
      await this.loadProviders();
      await this.loadSystemPrompts();
      
      
      // åˆå§‹åŒ–è‡ªåŠ¨æ’­æŠ¥æœåŠ¡
      await this.initializeAutoTTS();
    } catch (error) {
      const errorContext = new ErrorContext();
      errorContext.module = 'ChatViewModel';
      errorContext.function = 'loadInitialData';
      errorContext.additionalInfo = JSON.stringify({
        errorType: 'InitializationFailed'
      });
      
      const errorManager = ErrorManager.getInstance();
      if (error instanceof Error) {
        errorManager.handleError(
          errorManager.createError(
            ErrorType.SYSTEM,
            ErrorCode.SYSTEM_INITIALIZATION_FAILED,
            `åŠ è½½åˆå§‹æ•°æ®å¤±è´¥: ${error.message}`,
            errorContext,
            ErrorLevel.ERROR,
            error
          )
        );
      }
    }
  }

  /**
   * åˆå§‹åŒ–ä¼šè¯ç®¡ç†
   */
  private async initializeSessions(): Promise<void> {
    try {
      Logger.info('ChatViewModel', 'åˆå§‹åŒ–ä¼šè¯ç®¡ç†');
      
      // ç¡®ä¿æœ‰é»˜è®¤ä¼šè¯
      await this.sessionManager.ensureDefaultSession();
      
      // åŠ è½½æ‰€æœ‰ä¼šè¯
      await this.loadSessions();
      
      // åŠ è½½å½“å‰ä¼šè¯
      await this.loadCurrentSession();
      
      Logger.info('ChatViewModel', 'ä¼šè¯ç®¡ç†åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      Logger.error('ChatViewModel', `åˆå§‹åŒ–ä¼šè¯ç®¡ç†å¤±è´¥: ${error}`);
      throw error as Error;
    }
  }

  /**
   * åŠ è½½æ‰€æœ‰ä¼šè¯åˆ—è¡¨
   */
  async loadSessions(): Promise<void> {
    try {
      this.sessions = await this.sessionManager.getSessions();
      Logger.info('ChatViewModel', `åŠ è½½äº† ${this.sessions.length} ä¸ªä¼šè¯`);
    } catch (error) {
      Logger.error('ChatViewModel', `åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥: ${error}`);
      this.sessions = [];
    }
  }

  /**
   * åŠ è½½å½“å‰ä¼šè¯
   */
  async loadCurrentSession(): Promise<void> {
    try {
      const currentSessionId = await this.sessionManager.getCurrentSessionId();
      if (currentSessionId) {
        this.currentSession = this.sessions.find(s => s.id === currentSessionId) || null;
        Logger.info('ChatViewModel', `å½“å‰ä¼šè¯: ${this.currentSession?.name || 'null'}`);
      } else {
        Logger.warn('ChatViewModel', 'æ²¡æœ‰æ‰¾åˆ°å½“å‰ä¼šè¯ID');
      }
    } catch (error) {
      Logger.error('ChatViewModel', `åŠ è½½å½“å‰ä¼šè¯å¤±è´¥: ${error}`);
    }
  }

  /**
   * å¤„ç†æ·±åº¦æ€è€ƒæ¶ˆæ¯
   */
  private async handleDeepThinking(
    content: string,
    assistantMessage: Message,
    enableWebSearch: boolean
  ): Promise<void> {
    Logger.info('ChatViewModel', 'å¼€å§‹æ·±åº¦æ€è€ƒå¤„ç†');
    
    // è®¾ç½®å½“å‰æ€è€ƒæ¶ˆæ¯ID
    this.currentThinkingMessageId = assistantMessage.id;
    
    // è·å–åŒ…å«è®°å¿†æ³¨å…¥çš„ç³»ç»Ÿæç¤ºè¯
    const systemPromptWithMemory = await this.getSystemPromptWithMemory();
    Logger.info('ChatViewModel', `æ·±åº¦æ€è€ƒæ¨¡å¼ - ç³»ç»Ÿæç¤ºè¯é•¿åº¦: ${systemPromptWithMemory.length} å­—ç¬¦`);

    const filteredMessages = this.messages
      .filter(msg => !msg.isLoading && msg.role !== MessageRole.SYSTEM)
      .map(msg => ({
        role: msg.role === MessageRole.USER ? 'user' : 'assistant',
        content: msg.content
      } as SimpleMessage));

    // æ·»åŠ ç³»ç»Ÿæç¤ºè¯
    const finalMessages = [...filteredMessages];
    if (systemPromptWithMemory) {
      finalMessages.unshift({
        role: 'system',
        content: systemPromptWithMemory
      });
      Logger.info('ChatViewModel', 'æ·±åº¦æ€è€ƒæ¨¡å¼ - å·²æ·»åŠ ç³»ç»Ÿæç¤ºè¯åˆ°æ¶ˆæ¯åˆ—è¡¨');
    } else {
      Logger.warn('ChatViewModel', 'æ·±åº¦æ€è€ƒæ¨¡å¼ - æœªè·å–åˆ°ç³»ç»Ÿæç¤ºè¯');
    }

    // å®šä¹‰æ·±åº¦æ€è€ƒå›è°ƒ
    const callbacks: DeepThinkingCallbacks = {
      onStepStart: (step) => {
        Logger.info('ChatViewModel', `æ­¥éª¤å¼€å§‹: ${step.title}`);
        assistantMessage.thinkingStatus = this.mapThinkingStatus(step.id);
        assistantMessage.thinkingSteps = [...assistantMessage.thinkingSteps || []];
        // æ‰¾åˆ°å¹¶æ›´æ–°æ­¥éª¤çŠ¶æ€
        const stepIndex = assistantMessage.thinkingSteps.findIndex(s => s.id === step.id);
        if (stepIndex >= 0) {
          assistantMessage.thinkingSteps[stepIndex] = step;
        } else {
          assistantMessage.thinkingSteps.push(step);
        }
      },
      onStepComplete: (step) => {
        Logger.info('ChatViewModel', `æ­¥éª¤å®Œæˆ: ${step.title}, è€—æ—¶: ${step.duration}ms`);
        assistantMessage.thinkingStatus = this.mapThinkingStatus(step.id);
        assistantMessage.thinkingSteps = [...assistantMessage.thinkingSteps || []];
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        const stepIndex = assistantMessage.thinkingSteps.findIndex(s => s.id === step.id);
        if (stepIndex >= 0) {
          assistantMessage.thinkingSteps[stepIndex] = step;
        } else {
          assistantMessage.thinkingSteps.push(step);
        }
      },
      onStepError: (step, error) => {
        Logger.error('ChatViewModel', `æ­¥éª¤å¤±è´¥: ${step.title}, é”™è¯¯: ${error}`);
        assistantMessage.thinkingSteps = [...assistantMessage.thinkingSteps || []];
        const stepIndex = assistantMessage.thinkingSteps.findIndex(s => s.id === step.id);
        if (stepIndex >= 0) {
          assistantMessage.thinkingSteps[stepIndex] = step;
        } else {
          assistantMessage.thinkingSteps.push(step);
        }
      },
      onComplete: (result) => {
        Logger.info('ChatViewModel', `æ·±åº¦æ€è€ƒå®Œæˆï¼Œæ€»è€—æ—¶: ${result.totalTime}msï¼Œé™çº§: ${result.fallbackUsed}`);
        assistantMessage.thinkingStatus = ThinkingStatus.COMPLETED;
        assistantMessage.thinkingSteps = result.steps;

        // å¤„ç†å·¥å…·è°ƒç”¨ç»“æœ
        if (result.toolsUsed && result.toolCalls && result.toolCalls.length > 0) {
          assistantMessage.toolType = 'mcp';
          assistantMessage.toolStatus = 'completed';

          // è·å–å®é™…æ‰§è¡Œçš„å·¥å…·åç§°
          const executedToolNames: string[] = result.toolCalls.map((toolCall: ToolCall) => toolCall.function.name);
          assistantMessage.mcpToolNames = executedToolNames;

          // æ›´æ–°å·¥å…·åç§°æ˜¾ç¤ºï¼Œä¸ºäº†å‘åå…¼å®¹ä¹Ÿè®¾ç½®toolName
          if (executedToolNames.length === 1) {
            assistantMessage.toolName = executedToolNames[0];
          } else if (executedToolNames.length > 1) {
            assistantMessage.toolName = `${executedToolNames.length}ä¸ªMCPå·¥å…·`;
          }

          Logger.info('ChatViewModel', `æ·±åº¦æ€è€ƒä½¿ç”¨äº† ${result.toolCalls.length} ä¸ªå·¥å…·: ${executedToolNames.join(', ')}`);
        }
      },
      onError: (error) => {
        Logger.error('ChatViewModel', `æ·±åº¦æ€è€ƒå¤±è´¥: ${error}`);
        assistantMessage.thinkingStatus = ThinkingStatus.FAILED;
      }
    };

    // å¯åŠ¨æ·±åº¦æ€è€ƒè¿‡ç¨‹
    const thinkingResult = await this.deepThinkingService.startDeepThinking(
      content,
      this.currentModel,
      finalMessages,
      callbacks,
      {
        enableWebSearch: false,
        preferFastResponse: content.length <= 80,
        maxSteps: 6
      }
    );

    // å¤„ç†ç»“æœ
    if (thinkingResult.success) {
      assistantMessage.content = thinkingResult.finalAnswer;
      assistantMessage.thinkingStatus = ThinkingStatus.COMPLETED;
      assistantMessage.thinkingSteps = thinkingResult.steps;

      // å¤„ç†å·¥å…·è°ƒç”¨ç»“æœ
      if (thinkingResult.toolsUsed && thinkingResult.toolCalls && thinkingResult.toolCalls.length > 0) {
        assistantMessage.toolType = 'mcp';
        assistantMessage.toolStatus = 'completed';

        // è·å–å®é™…æ‰§è¡Œçš„å·¥å…·åç§°
        const executedToolNames: string[] = thinkingResult.toolCalls.map((toolCall: ToolCall) => toolCall.function.name);
        assistantMessage.mcpToolNames = executedToolNames;

        // æ›´æ–°å·¥å…·åç§°æ˜¾ç¤ºï¼Œä¸ºäº†å‘åå…¼å®¹ä¹Ÿè®¾ç½®toolName
        if (executedToolNames.length === 1) {
          assistantMessage.toolName = executedToolNames[0];
        } else if (executedToolNames.length > 1) {
          assistantMessage.toolName = `${executedToolNames.length}ä¸ªMCPå·¥å…·`;
        }

        Logger.info('ChatViewModel', `æ·±åº¦æ€è€ƒæˆåŠŸå®Œæˆï¼Œä½¿ç”¨äº† ${thinkingResult.toolCalls.length} ä¸ªå·¥å…·: ${executedToolNames.join(', ')}`);
      } else {
        Logger.info('ChatViewModel', 'æ·±åº¦æ€è€ƒæˆåŠŸå®Œæˆ');
      }
    } else {
      // æ·±åº¦æ€è€ƒå¤±è´¥ï¼Œå›é€€åˆ°ç®€å•æ¨¡å¼
      Logger.warn('ChatViewModel', `æ·±åº¦æ€è€ƒå¤±è´¥ï¼Œå›é€€åˆ°ç®€å•æ¨¡å¼: ${thinkingResult.error}`);
      await this.handleSimpleMessage(content, assistantMessage, enableWebSearch);
      assistantMessage.thinkingStatus = ThinkingStatus.FAILED;
    }
    
    // æ¸…é™¤å½“å‰æ€è€ƒæ¶ˆæ¯ID
    this.currentThinkingMessageId = '';
  }

  /**
   * å¤„ç†æ™®é€šæ¶ˆæ¯ï¼ˆç®€å•æ¨¡å¼ï¼‰
   */
  private async handleSimpleMessage(
    content: string,
    assistantMessage: Message,
    enableWebSearch: boolean
  ): Promise<void> {
    const currentMode = this.apiManager.getCurrentMode();
    
    if (currentMode === APIMode.DIRECT_CALL && enableWebSearch) {
      // ç›´è¿æ¨¡å¼ + è”ç½‘æœç´¢ï¼šä½¿ç”¨æ··åˆèŠå¤©æœåŠ¡
      // è·å–åŒ…å«è®°å¿†æ³¨å…¥çš„ç³»ç»Ÿæç¤ºè¯
      const systemPromptWithMemory = await this.getSystemPromptWithMemory();
      Logger.info('ChatViewModel', `æ··åˆèŠå¤©æ¨¡å¼ - ç³»ç»Ÿæç¤ºè¯é•¿åº¦: ${systemPromptWithMemory.length} å­—ç¬¦`);

      const hybridRequest: HybridChatRequest = {
        message: content,
        model: this.currentModel,
        provider: this.getAIProviderByName(this.currentProvider),
        enableSearch: enableWebSearch,
        enableTools: true, // å¯ç”¨å·¥å…·è°ƒç”¨
        systemPrompt: systemPromptWithMemory,
        stream: false,
        max_tokens: 1500,
        temperature: 0.7
      };
  
      const hybridResponse = await this.hybridChatService.sendHybridChatRequest(hybridRequest);

      assistantMessage.content = hybridResponse.response.choices[0]?.message?.content || 'æœªæ”¶åˆ°æœ‰æ•ˆå“åº”';

      // åŒæ­¥å·¥å…·è°ƒç”¨çŠ¶æ€
      if (hybridResponse.response.tool_status) {
        assistantMessage.toolStatus = hybridResponse.response.tool_status;
      }

      // å¤„ç†æœç´¢ç»“æœ
      if (hybridResponse.searchUsed && hybridResponse.searchInfo) {
        assistantMessage.webUsed = true;
        assistantMessage.toolType = 'search';
        assistantMessage.toolName = 'ç½‘ç»œæœç´¢';
        assistantMessage.searchInfo = this.formatSearchInfoSimple(hybridResponse.searchInfo);
        assistantMessage.searchDetails = this.formatSearchInfoDetailed(hybridResponse.searchInfo);
      }

      // å¤„ç†MCPå·¥å…·è°ƒç”¨ç»“æœ
      if (hybridResponse.toolsUsed && hybridResponse.toolCalls && hybridResponse.toolCalls.length > 0) {
        assistantMessage.toolType = 'mcp';
        assistantMessage.toolStatus = 'completed';
        // è·å–å®é™…æ‰§è¡Œçš„å·¥å…·åç§°
        const executedToolNames = hybridResponse.toolCalls.map(toolCall => toolCall.function.name);
        assistantMessage.mcpToolNames = executedToolNames;

        // æ›´æ–°å·¥å…·åç§°æ˜¾ç¤ºï¼Œä¸ºäº†å‘åå…¼å®¹ä¹Ÿè®¾ç½®toolName
        if (executedToolNames.length === 1) {
          assistantMessage.toolName = executedToolNames[0];
        } else if (executedToolNames.length > 1) {
          assistantMessage.toolName = `${executedToolNames.length}ä¸ªMCPå·¥å…·`;
        }

        Logger.info('ChatViewModel', `MCPå·¥å…·æ‰§è¡Œå®Œæˆ: ${executedToolNames.join(', ')}`);
      }
    } else {
      // æœåŠ¡ç«¯æ¨¡å¼æˆ–ç›´è¿æ¨¡å¼æ— æœç´¢ï¼šä½¿ç”¨åŸæœ‰é€»è¾‘
      const filteredMessages = this.messages
        .filter(msg => !msg.isLoading)
        .map(msg => ({
          role: msg.role === MessageRole.USER ? 'user' : 'assistant',
          content: msg.content
        } as SimpleMessage));

      const finalMessages = [...filteredMessages];
      const systemPromptWithMemory = await this.getSystemPromptWithMemory();
      Logger.info('ChatViewModel', `æœåŠ¡ç«¯æ¨¡å¼ - ç³»ç»Ÿæç¤ºè¯é•¿åº¦: ${systemPromptWithMemory.length} å­—ç¬¦`);

      if (systemPromptWithMemory) {
        finalMessages.unshift({
          role: 'system',
          content: systemPromptWithMemory
        });
        Logger.info('ChatViewModel', 'æœåŠ¡ç«¯æ¨¡å¼ - å·²æ·»åŠ ç³»ç»Ÿæç¤ºè¯åˆ°æ¶ˆæ¯åˆ—è¡¨');
      } else {
        Logger.warn('ChatViewModel', 'æœåŠ¡ç«¯æ¨¡å¼ - æœªè·å–åˆ°ç³»ç»Ÿæç¤ºè¯');
      }

      const apiRequest: APIChatRequest = {
        messages: finalMessages.map(msg => {
          const apiMsg: APIChatMessage = {
            role: msg.role,
            content: msg.content
          };
          return apiMsg;
        }),
        model: this.currentModel,
        max_tokens: 1500,
        temperature: 0.7,
        enable_web: enableWebSearch
      };

      const apiResponse = await this.apiManager.sendChatRequest(apiRequest);
      assistantMessage.content = apiResponse.choices[0]?.message?.content || 'æœªæ”¶åˆ°æœ‰æ•ˆå“åº”';

      // åŒæ­¥å·¥å…·è°ƒç”¨çŠ¶æ€
      if (apiResponse.tool_status) {
        assistantMessage.toolStatus = apiResponse.tool_status;
      }

      if (apiResponse.web_used) {
        assistantMessage.webUsed = true;
        assistantMessage.toolType = 'search';
        assistantMessage.toolName = 'ç½‘ç»œæœç´¢';
        assistantMessage.searchInfo = apiResponse.search_info || 'ğŸŒ å·²ä½¿ç”¨ç½‘ç»œæœç´¢';
        assistantMessage.searchDetails = apiResponse.search_info || 'ğŸŒ å·²ä½¿ç”¨ç½‘ç»œæœç´¢';
      }
    }
  }

  /**
   * å¤„ç†æ™ºèƒ½æ¶ˆæ¯ - åŸºäºç»Ÿä¸€çŠ¶æ€ç®¡ç†
   */
  private async handleSmartMessage(
    content: string,
    assistantMessage: Message
  ): Promise<void> {
    try {
      // è·å–åŒ…å«è®°å¿†æ³¨å…¥çš„ç³»ç»Ÿæç¤ºè¯
      const systemPromptWithMemory = await this.getSystemPromptWithMemory();
      Logger.info('ChatViewModel', `æ™ºèƒ½æ¶ˆæ¯æ¨¡å¼ - ç³»ç»Ÿæç¤ºè¯é•¿åº¦: ${systemPromptWithMemory.length} å­—ç¬¦`);

      // ä½¿ç”¨APIManagerçš„æ™ºèƒ½èŠå¤©åŠŸèƒ½
      const response = await this.apiManager.sendSmartChatRequest(
        content,
        this.currentModel,
        systemPromptWithMemory
      );

      // æ›´æ–°åŠ©æ‰‹æ¶ˆæ¯å†…å®¹
      assistantMessage.content = response.response.choices[0]?.message.content || 'æ— å›å¤å†…å®¹';
      assistantMessage.isLoading = false;

      // æ›´æ–°æœç´¢å’Œå·¥å…·ä½¿ç”¨ä¿¡æ¯
      if (response.searchUsed && response.searchInfo) {
        assistantMessage.webUsed = true;
        assistantMessage.searchInfo = response.searchInfo.query || 'ğŸŒ å·²ä½¿ç”¨ç½‘ç»œæœç´¢';
        assistantMessage.searchDetails = response.searchInfo.query || 'ğŸŒ å·²ä½¿ç”¨ç½‘ç»œæœç´¢';
      }

      if (response.toolsUsed && response.toolCalls && response.toolCalls.length > 0) {
        // å·¥å…·è°ƒç”¨ä¿¡æ¯å·²åŒ…å«åœ¨responseä¸­ï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€
        assistantMessage.toolType = 'mcp';
        assistantMessage.toolStatus = 'completed';

        // è·å–å®é™…æ‰§è¡Œçš„å·¥å…·åç§°
        const executedToolNames = response.toolCalls.map(toolCall => toolCall.function.name);
        assistantMessage.mcpToolNames = executedToolNames;

        // æ›´æ–°å·¥å…·åç§°æ˜¾ç¤ºï¼Œä¸ºäº†å‘åå…¼å®¹ä¹Ÿè®¾ç½®toolName
        if (executedToolNames.length === 1) {
          assistantMessage.toolName = executedToolNames[0];
        } else if (executedToolNames.length > 1) {
          assistantMessage.toolName = `${executedToolNames.length}ä¸ªMCPå·¥å…·`;
        }

        Logger.info('ChatViewModel', `ä½¿ç”¨äº† ${response.toolCalls.length} ä¸ªå·¥å…·: ${executedToolNames.join(', ')}`);
      }

      Logger.info('ChatViewModel', `æ™ºèƒ½èŠå¤©å®Œæˆï¼Œæ€»è€—æ—¶: ${response.totalTime}ms`);
    } catch (error) {
      const errorMessage = (error as Error).message;
      Logger.error('ChatViewModel', `æ™ºèƒ½èŠå¤©å¤±è´¥: ${errorMessage}`);

      assistantMessage.content = `æŠ±æ­‰ï¼Œå¤„ç†æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼š${errorMessage}`;
      assistantMessage.isLoading = false;
      throw new Error(errorMessage);
    }
  }

  /**
   * å¤„ç†å¤šäººä¼šè¯å¤šè½®è®¨è®º
   */
  private async handleMultiRoleDiscussion(
    content: string,
    assistantMessage: Message,
    enableWebSearch: boolean
  ): Promise<void> {
    if (!this.currentSession || !isMultiRoleSession(this.currentSession)) {
      Logger.error('ChatViewModel', 'å¤šäººä¼šè¯è®¨è®ºå¤±è´¥ï¼šå½“å‰ä¼šè¯ä¸æ˜¯å¤šäººä¼šè¯');
      assistantMessage.content = 'æŠ±æ­‰ï¼Œå¤šäººä¼šè¯å¤„ç†å¤±è´¥';
      assistantMessage.isLoading = false;
      return;
    }

    const multiRoleSession = this.currentSession as MultiRoleSession;
    const participants = multiRoleSession.participants;
    const discussionRounds = multiRoleSession.discussionRounds || 3;

    Logger.info('ChatViewModel', `å¼€å§‹å¤šäººè®¨è®ºï¼š${participants.length}ä¸ªå‚ä¸è€…ï¼Œ${discussionRounds}è½®è®¨è®º`);

    try {
      // æ„å»ºè®¨è®ºç»“æœ
      let discussionResult = `ğŸ¯ **å¤šäººè®¨è®ºç»“æœ**ï¼ˆ${discussionRounds}è½®ï¼‰\n\n`;

      // ä¸ºæ¯è½®è®¨è®ºæ”¶é›†å‚ä¸è€…çš„å›åº”
      for (let round = 1; round <= discussionRounds; round++) {
        discussionResult += `### ç¬¬${round}è½®è®¨è®º\n\n`;

        // è®©æ¯ä¸ªå‚ä¸è€…å‚ä¸è®¨è®º
        for (const participant of participants) {
          try {
            // æ„å»ºå½“å‰å‚ä¸è€…çš„ç³»ç»Ÿæç¤ºè¯
            const participantSystemPrompt = this.getParticipantSystemPrompt(participant, round, discussionRounds);

            // æ„å»ºæ¶ˆæ¯å†å²
            const messages = this.buildDiscussionMessages(content, participantSystemPrompt, round, participants);

            // å‘é€APIè¯·æ±‚è·å–å‚ä¸è€…å›åº”
            const response = await this.getParticipantResponse(messages, participant);

            // æ·»åŠ åˆ°è®¨è®ºç»“æœ
            discussionResult += `**${participant.displayName}**ï¼š${response}\n\n`;

            // æ·»åŠ å°å»¶è¿Ÿé¿å…APIé™æµ
            await this.delay(500);

          } catch (error) {
            Logger.error('ChatViewModel', `å‚ä¸è€…${participant.displayName}ç¬¬${round}è½®è®¨è®ºå¤±è´¥: ${(error as Error).message}`);
            discussionResult += `**${participant.displayName}**ï¼š[è®¨è®ºå¤±è´¥]\n\n`;
          }
        }

        discussionResult += `---\n\n`;
      }

      // ç”Ÿæˆæ€»ç»“
      discussionResult += `### ğŸ“ è®¨è®ºæ€»ç»“\n\n`;
      const summary = await this.generateDiscussionSummary(content, discussionResult, participants);
      discussionResult += summary;

      // è®¾ç½®æœ€ç»ˆç»“æœ
      assistantMessage.content = discussionResult;
      assistantMessage.isLoading = false;

      Logger.info('ChatViewModel', `å¤šäººè®¨è®ºå®Œæˆï¼Œå…±${discussionRounds}è½®`);

    } catch (error) {
      const errorMessage = (error as Error).message;
      Logger.error('ChatViewModel', `å¤šäººè®¨è®ºå¤±è´¥: ${errorMessage}`);
      assistantMessage.content = `æŠ±æ­‰ï¼Œå¤šäººè®¨è®ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${errorMessage}`;
      assistantMessage.isLoading = false;
      throw new Error(errorMessage);
    }
  }

  /**
   * è·å–å‚ä¸è€…çš„ç³»ç»Ÿæç¤ºè¯
   */
  private getParticipantSystemPrompt(participant: SessionParticipant, currentRound: number, totalRounds: number): string {
    const basePrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œåä¸º${participant.displayName}ã€‚

å½“å‰æ˜¯å¤šäººè®¨è®ºçš„ç¬¬${currentRound}è½®ï¼ˆå…±${totalRounds}è½®ï¼‰ã€‚

ä½ çš„è§’è‰²ç‰¹ç‚¹ï¼š
- ä¸“ä¸šçš„çŸ¥è¯†å’Œè§è§£
- å»ºè®¾æ€§çš„è®¨è®ºæ€åº¦
- å°Šé‡å…¶ä»–å‚ä¸è€…çš„è§‚ç‚¹
- æä¾›æœ‰ä»·å€¼çš„è¡¥å……ä¿¡æ¯

è®¨è®ºè§„åˆ™ï¼š
1. åŸºäºç”¨æˆ·çš„åŸå§‹é—®é¢˜æä¾›ä½ çš„ä¸“ä¸šè§‚ç‚¹
2. å¯ä»¥å‚è€ƒå‰é¢è½®æ¬¡çš„è®¨è®ºï¼ˆå¦‚æœæœ‰ï¼‰
3. ä¿æŒç®€æ´æ˜äº†ï¼Œ1-2å¥è¯å³å¯
4. é¿å…é‡å¤å…¶ä»–å‚ä¸è€…å·²ç»æåˆ°çš„è§‚ç‚¹
5. ä¸“æ³¨äºä½ çš„ä¸“ä¸šé¢†åŸŸ`;

    return basePrompt;
  }

  /**
   * æ„å»ºè®¨è®ºæ¶ˆæ¯å†å²
   */
  private buildDiscussionMessages(
    userContent: string,
    systemPrompt: string,
    currentRound: number,
    participants: SessionParticipant[]
  ): SimpleMessage[] {
    const messages: SimpleMessage[] = [];

    // æ·»åŠ ç³»ç»Ÿæç¤ºè¯
    messages.push({
      role: 'system',
      content: systemPrompt
    });

    // æ·»åŠ ç”¨æˆ·åŸå§‹æ¶ˆæ¯
    messages.push({
      role: 'user',
      content: `ç”¨æˆ·é—®é¢˜ï¼š${userContent}

è¯·æ³¨æ„ï¼šè¿™æ˜¯å¤šäººè®¨è®ºçš„ç¬¬${currentRound}è½®ï¼Œå…±æœ‰${participants.length}ä¸ªå‚ä¸è€…å‚ä¸è®¨è®ºã€‚è¯·æä¾›ä½ çš„ä¸“ä¸šè§‚ç‚¹ã€‚`
    });

    return messages;
  }

  /**
   * è·å–å‚ä¸è€…çš„å›åº”
   */
  private async getParticipantResponse(messages: SimpleMessage[], participant: SessionParticipant): Promise<string> {
    try {
      // ä½¿ç”¨å‚ä¸è€…æŒ‡å®šçš„æ¨¡å‹æˆ–é»˜è®¤æ¨¡å‹
      const model = participant.model || this.currentModel;

      // æ£€æŸ¥messagesæ˜¯å¦å·²ç»åŒ…å«ç³»ç»Ÿæç¤ºè¯
      const hasSystemPrompt = messages.some(msg => msg.role === 'system');

      let chatMessages: SimpleMessage[];

      if (!hasSystemPrompt && participant.systemPrompt && participant.systemPrompt.trim()) {
        // å¦‚æœæ²¡æœ‰ç³»ç»Ÿæç¤ºè¯ä¸”å‚ä¸è€…æœ‰ç³»ç»Ÿæç¤ºè¯ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯å¼€å¤´
        chatMessages = [
          {
            role: 'system',
            content: participant.systemPrompt.trim()
          },
          ...messages
        ];
      } else {
        // å¦åˆ™ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„æ¶ˆæ¯ï¼ˆåº”è¯¥å·²ç»åŒ…å«ç³»ç»Ÿæç¤ºè¯ï¼‰
        chatMessages = messages;
      }

      const apiRequest: APIChatRequest = {
        messages: chatMessages,
        model: model,
        max_tokens: 1500, // å¢åŠ å›å¤é•¿åº¦é™åˆ¶ï¼Œæ”¯æŒæ›´å®Œæ•´çš„è¡¨è¾¾
        temperature: 0.7,
        enable_web: false // è®¨è®ºä¸­ä¸å¯ç”¨ç½‘ç»œæœç´¢
      };

      const apiResponse = await this.apiManager.sendChatRequest(apiRequest);
      const response = apiResponse.choices[0]?.message?.content || 'æ— å›åº”';

      // æ¸…ç†å›å¤ï¼Œå»é™¤å¤šä½™çš„æ ¼å¼
      return response.trim().replace(/^#+\s*/, '').replace(/\n{3,}/g, '\n\n');

    } catch (error) {
      Logger.error('ChatViewModel', `è·å–å‚ä¸è€…${participant.displayName}å›åº”å¤±è´¥: ${(error as Error).message}`);
      return 'å›åº”å¤±è´¥';
    }
  }

  /**
   * ç”Ÿæˆè®¨è®ºæ€»ç»“
   */
  private async generateDiscussionSummary(userQuestion: string, discussionContent: string, participants: SessionParticipant[]): Promise<string> {
    try {
      const summaryPrompt = `è¯·æ ¹æ®ä»¥ä¸‹å¤šäººè®¨è®ºå†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªç®€æ´çš„æ€»ç»“ï¼ˆ200å­—ä»¥å†…ï¼‰ï¼š

ç”¨æˆ·é—®é¢˜ï¼š${userQuestion}

è®¨è®ºå†…å®¹ï¼š
${discussionContent}

æ€»ç»“è¦æ±‚ï¼š
1. æ¦‚æ‹¬ä¸»è¦è§‚ç‚¹å’Œå…±è¯†
2. æŒ‡å‡ºä¸åŒæ„è§ï¼ˆå¦‚æœæœ‰ï¼‰
3. ç»™å‡ºæœ€ç»ˆçš„å»ºè®®æˆ–ç­”æ¡ˆ
4. ä¿æŒå®¢è§‚ä¸­ç«‹çš„æ€åº¦`;

      const summaryMessages: SimpleMessage[] = [
        { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®¨è®ºæ€»ç»“åŠ©æ‰‹ï¼Œæ“…é•¿æç‚¼å¤šäººè®¨è®ºçš„æ ¸å¿ƒè§‚ç‚¹ã€‚' },
        { role: 'user', content: summaryPrompt }
      ];

      const apiRequest: APIChatRequest = {
        messages: summaryMessages,
        model: this.currentModel,
        max_tokens: 1500,
        temperature: 0.5,
        enable_web: false
      };

      const apiResponse = await this.apiManager.sendChatRequest(apiRequest);
      return apiResponse.choices[0]?.message?.content || 'è®¨è®ºæ€»ç»“ç”Ÿæˆå¤±è´¥';

    } catch (error) {
      Logger.error('ChatViewModel', `ç”Ÿæˆè®¨è®ºæ€»ç»“å¤±è´¥: ${(error as Error).message}`);
      return 'æ— æ³•ç”Ÿæˆè®¨è®ºæ€»ç»“';
    }
  }

  //=================== è¾©è®ºç³»ç»Ÿç›¸å…³æ–¹æ³• ===================

  /**
   * ä»ç”¨æˆ·ç¬¬ä¸€å¥è¯æå–è¾©è®ºä¸»é¢˜
   */
  private extractDebateTopic(userMessage: string): string {
    // æ¸…ç†ç”¨æˆ·æ¶ˆæ¯ï¼Œç§»é™¤å¤šä½™ç©ºç™½å­—ç¬¦
    const cleanMessage = userMessage.trim();

    // å¦‚æœæ¶ˆæ¯è¾ƒçŸ­ï¼ˆå°äº50å­—ç¬¦ï¼‰ï¼Œç›´æ¥ä½œä¸ºä¸»é¢˜
    if (cleanMessage.length <= 50) {
      return cleanMessage;
    }

    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–ä¸»é¢˜
    // åŒ¹é…é—®å¥ã€é™ˆè¿°å¥æˆ–è§‚ç‚¹è¡¨è¾¾
    const topicPatterns = [
      /^(.+ï¼Ÿ)/, // ä¸­æ–‡é—®å¥
      /^(.+?\?)/, // è‹±æ–‡é—®å¥
      /^(.+?[ã€‚ï¼ï¼Ÿ!?])/, // ä»¥å¥å·ã€æ„Ÿå¹å·æˆ–é—®å·ç»“å°¾çš„å¥å­
      /^(.{10,50}?[ï¼Œ,ã€])/, // 10-50å­—ç¬¦çš„çŸ­è¯­ï¼ˆä»¥é€—å·æˆ–é¡¿å·ç»“å°¾ï¼‰
      /^(.{20,60}?)/ // 20-60å­—ç¬¦çš„çŸ­è¯­
    ];

    for (const pattern of topicPatterns) {
      const match = cleanMessage.match(pattern);
      if (match && match[1]) {
        return match[1].trim();
      }
    }

    // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°åˆé€‚çš„æ¨¡å¼ï¼Œå–å‰40ä¸ªå­—ç¬¦
    return cleanMessage.substring(0, 40) + (cleanMessage.length > 40 ? '...' : '');
  }

  /**
   * åˆ†æè®¨è®ºæ¿€çƒˆç¨‹åº¦
   */
  private analyzeDiscussionIntensity(messages: Message[]): number {
    if (messages.length === 0) return 0;

    let intensityScore = 0;
    const recentMessages = messages.slice(-10); // åˆ†ææœ€è¿‘10æ¡æ¶ˆæ¯

    for (const message of recentMessages) {
      if (message.role === MessageRole.ASSISTANT && message.content) {
        const content = message.content.toLowerCase();

        // æ£€æµ‹æ¿€çƒˆè®¨è®ºçš„å…³é”®è¯
        const intenseKeywords = [
          'å¼ºçƒˆ', 'åšå†³', 'å®Œå…¨ä¸åŒæ„', 'ç»å¯¹', 'å¿…é¡»', 'é”™è¯¯', 'åå¯¹', 'æ‰¹è¯„',
          'strongly', 'absolutely', 'completely disagree', 'must', 'wrong', 'oppose', 'criticize'
        ];

        // æ£€æµ‹æ¸©å’Œè®¨è®ºçš„å…³é”®è¯
        const mildKeywords = [
          'å»ºè®®', 'æˆ–è®¸', 'å¯èƒ½', 'ä¹Ÿè®¸', 'ä¸ªäººè§‚ç‚¹', 'ä»…ä¾›å‚è€ƒ', 'æ¸©å’Œ',
          'suggest', 'perhaps', 'maybe', 'personal opinion', 'reference only', 'mild'
        ];

        // è®¡ç®—å¼ºåº¦åˆ†æ•°
        for (const keyword of intenseKeywords) {
          if (content.includes(keyword)) {
            intensityScore += 2;
          }
        }

        for (const keyword of mildKeywords) {
          if (content.includes(keyword)) {
            intensityScore += 0.5;
          }
        }

        // æ£€æµ‹æ„Ÿå¹å·å’Œé—®å·æ•°é‡
        const punctuationCount = (content.match(/[!ï¼Ÿ?]/g) || []).length;
        intensityScore += punctuationCount * 0.5;

        // æ£€æµ‹æ¶ˆæ¯é•¿åº¦ï¼ˆè¾ƒé•¿çš„å›å¤å¯èƒ½è¡¨ç¤ºæ›´æ·±å…¥çš„è®¨è®ºï¼‰
        if (content.length > 200) {
          intensityScore += 1;
        }
      }
    }

    // å°†å¼ºåº¦åˆ†æ•°å½’ä¸€åŒ–åˆ°0-10çš„èŒƒå›´
    const maxPossibleIntensity = recentMessages.length * 5;
    const normalizedIntensity = maxPossibleIntensity > 0 ? (intensityScore / maxPossibleIntensity) * 10 : 0;

    return Math.min(10, Math.max(0, normalizedIntensity));
  }

  /**
   * ç”Ÿæˆå¸¦ä¸Šä¸‹æ–‡çš„è¾©è®ºæç¤ºè¯
   */
  private generateContextualDebatePrompt(
    participant: SessionParticipant,
    debateTopic: string,
    currentRound: number,
    totalRounds: number,
    discussionIntensity: number,
    previousMessages: Message[]
  ): string {
    // é¦–å…ˆä½¿ç”¨è§’è‰²çš„åŸå§‹ç³»ç»Ÿæç¤ºè¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const rolePrompt = participant.systemPrompt || `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¾©è®ºå‚ä¸è€…ï¼Œåä¸º${participant.displayName}ã€‚

**ä½ çš„è§’è‰²å®šä½**ï¼š
- åŸºäº${participant.displayName}çš„ä¸“ä¸šèƒŒæ™¯å’Œè§‚ç‚¹
- æä¾›æœ‰æ·±åº¦å’Œè§è§£çš„è®ºç‚¹
- ä¿æŒå»ºè®¾æ€§çš„è¾©è®ºæ€åº¦`;

    const basePrompt = `${rolePrompt}

---

**è¾©è®ºä¸»é¢˜**ï¼š${debateTopic}

**å½“å‰é˜¶æ®µ**ï¼šç¬¬${currentRound}è½®ï¼ˆå…±${totalRounds}è½®ï¼‰

**è®¨è®ºæ¿€çƒˆç¨‹åº¦**ï¼š${discussionIntensity.toFixed(1)}/10`;

    let contextualPrompt = basePrompt;

    // æ ¹æ®è®¨è®ºæ¿€çƒˆç¨‹åº¦è°ƒæ•´æç¤ºè¯
    if (discussionIntensity >= 7) {
      contextualPrompt += `

**é«˜å¼ºåº¦è®¨è®ºæç¤º**ï¼š
- å‰é¢çš„è®¨è®ºå·²ç»ç›¸å½“æ¿€çƒˆï¼Œè¯·æä¾›æ›´æœ‰åŠ›çš„è®ºæ®æ¥æ”¯æŒä½ çš„è§‚ç‚¹
- å¯ä»¥é€‚å½“åé©³å‰é¢çš„ä¸åŒæ„è§ï¼Œä½†ä¿æŒä¸“ä¸šå’Œå°Šé‡
- é¿å…æƒ…ç»ªåŒ–çš„è¡¨è¾¾ï¼Œç”¨äº‹å®å’Œé€»è¾‘æ¥è¯´æœå¯¹æ–¹`;
    } else if (discussionIntensity >= 4) {
      contextualPrompt += `

**ä¸­ç­‰å¼ºåº¦è®¨è®ºæç¤º**ï¼š
- è®¨è®ºæ­£åœ¨å‡æ¸©ï¼Œè¯·æä¾›æ›´æœ‰æ·±åº¦çš„è§‚ç‚¹
- å¯ä»¥å¯¹å‰é¢çš„è§‚ç‚¹è¿›è¡Œè¡¥å……æˆ–æå‡ºä¸åŒè§è§£
- ä¿æŒå®¢è§‚ä¸­ç«‹çš„æ€åº¦ï¼Œç”¨ç†æ€§åˆ†ææ¥æ”¯æŒä½ çš„è®ºç‚¹`;
    } else {
      contextualPrompt += `

**åˆå§‹è®¨è®ºæç¤º**ï¼š
- è¿™æ˜¯è¾©è®ºçš„æ—©æœŸé˜¶æ®µï¼Œè¯·æ¸…æ™°åœ°é™ˆè¿°ä½ çš„æ ¸å¿ƒè§‚ç‚¹
- ä¸ºè¾©è®ºè®¾å®šåŸºè°ƒï¼Œæä¾›æœ‰ä»·å€¼çš„è§è§£
- ä¿æŒå¼€æ”¾å’Œå»ºè®¾æ€§çš„æ€åº¦`;
    }

    // æ ¹æ®è¾©è®ºè½®æ¬¡è°ƒæ•´ç­–ç•¥
    if (currentRound === 1) {
      contextualPrompt += `

**é¦–è½®ç­–ç•¥**ï¼š
- æ¸…æ™°é™ˆè¿°ä½ çš„æ ¸å¿ƒç«‹åœºå’Œä¸»è¦è®ºç‚¹
- ä¸ºåç»­è¾©è®ºå¥ å®šåŸºç¡€
- é¿å…è¿‡æ—©åœ°åé©³ä»–äººï¼ˆè¿™æ˜¯å¼€åœºé™ˆè¿°é˜¶æ®µï¼‰`;
    } else if (currentRound < totalRounds) {
      contextualPrompt += `

**ä¸­æœŸè¾©è®ºç­–ç•¥**ï¼š
- é’ˆå¯¹å‰é¢å‚ä¸è€…çš„è§‚ç‚¹è¿›è¡Œå›åº”
- å¼ºåŒ–ä½ çš„è®ºç‚¹ï¼Œé€‚å½“åé©³ä¸åŒæ„è§
- æä¾›æ–°çš„è¯æ®æˆ–è§’åº¦æ¥æ”¯æŒä½ çš„ç«‹åœº`;
    } else {
      contextualPrompt += `

**æ€»ç»“é˜¶æ®µç­–ç•¥**ï¼š
- æ€»ç»“ä½ çš„æ ¸å¿ƒè®ºç‚¹å’Œå¯¹æ•´ä¸ªè¾©è®ºçš„è´¡çŒ®
- å›åº”æœ€é‡è¦çš„åé©³æ„è§
- æä¾›æœ€ç»ˆçš„è§‚ç‚¹å’Œç»“è®ºæ€§é™ˆè¿°`;
    }

    // å¦‚æœæœ‰å‰é¢çš„è®¨è®ºå†…å®¹ï¼Œæ·»åŠ ä¸Šä¸‹æ–‡
    if (previousMessages.length > 0) {
      contextualPrompt += `

**å‰é¢çš„è®¨è®ºè¦ç‚¹**ï¼š
${this.extractDiscussionKeyPoints(previousMessages)}

è¯·é’ˆå¯¹ä»¥ä¸Šè®¨è®ºå†…å®¹ï¼Œæä¾›ä½ çš„å›åº”ï¼š`;
    }

    return contextualPrompt;
  }

  /**
   * æå–è®¨è®ºçš„å…³é”®è¦ç‚¹
   */
  private extractDiscussionKeyPoints(messages: Message[]): string {
    const keyPoints: string[] = [];
    const assistantMessages = messages.filter(m => m.role === MessageRole.ASSISTANT);

    // åªå–æœ€è¿‘5æ¡æ¶ˆæ¯çš„è¦ç‚¹
    const recentMessages = assistantMessages.slice(-5);

    for (const message of recentMessages) {
      if (message.content && message.senderName) {
        // ç®€åŒ–å†…å®¹ï¼Œæå–è¦ç‚¹
        const content = message.content
          .replace(/\*\*([^*]+)\*\*/g, '$1') // ç§»é™¤åŠ ç²—æ ‡è®°
          .replace(/\*([^*]+)\*/g, '$1')     // ç§»é™¤æ–œä½“æ ‡è®°
          .replace(/#{1,6}\s*/g, '')          // ç§»é™¤æ ‡é¢˜æ ‡è®°
          .trim();

        if (content.length > 20) {
          // å–å†…å®¹çš„å‰100ä¸ªå­—ç¬¦ä½œä¸ºè¦ç‚¹
          const point = content.length > 100 ? content.substring(0, 100) + '...' : content;
          keyPoints.push(`- ${message.senderName}: ${point}`);
        }
      }
    }

    return keyPoints.length > 0 ? keyPoints.join('\n') : 'æš‚æ— å‰é¢çš„è®¨è®ºå†…å®¹';
  }

  /**
   * ç”Ÿæˆè¾©è®ºæ€»ç»“
   */
  private async generateDebateSummary(
    debateTopic: string,
    debateMessages: Message[],
    participantStats: DebateParticipantStats[]
  ): Promise<string> {
    try {
      // æå–å„å‚ä¸è€…çš„å…³é”®è®ºç‚¹
      const participantArguments = participantStats.map(stat => {
        const participant = this.getParticipantFromStats(stat.roleId);
        return `**${participant?.displayName || 'æœªçŸ¥å‚ä¸è€…'}**ï¼š
- å‘è¨€æ¬¡æ•°ï¼š${stat.responseCount}æ¬¡
- å¹³å‡å¼ºåº¦ï¼š${stat.averageIntensity.toFixed(1)}/10
- ä¸»è¦è®ºç‚¹ï¼š${stat.keyPoints.slice(0, 3).join('ï¼›')}`;
      }).join('\n\n');

      const summaryPrompt = `è¯·æ ¹æ®ä»¥ä¸‹è¾©è®ºå†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªä¸“ä¸šçš„è¾©è®ºæ€»ç»“ï¼š

**è¾©è®ºä¸»é¢˜**ï¼š${debateTopic}

**å‚ä¸è€…è¡¨ç°**ï¼š
${participantArguments}

**å®Œæ•´è¾©è®ºå†…å®¹**ï¼š
${debateMessages.map(m => `${m.senderName || 'å‚ä¸è€…'}: ${m.content}`).join('\n')}

æ€»ç»“è¦æ±‚ï¼š
1. **è¾©è®ºæ¦‚è¿°**ï¼šç®€è¦æ€»ç»“è¾©è®ºçš„ä¸»è¦è¿‡ç¨‹å’Œç„¦ç‚¹
2. **å„æ–¹è§‚ç‚¹**ï¼šæ¦‚æ‹¬æ¯ä¸ªå‚ä¸è€…çš„æ ¸å¿ƒç«‹åœºå’Œä¸»è¦è®ºç‚¹
3. **å…±è¯†ä¸åˆ†æ­§**ï¼šæŒ‡å‡ºå‚ä¸è€…ä¹‹é—´çš„å…±è¯†ç‚¹å’Œä¸»è¦åˆ†æ­§
4. **èƒœè´Ÿè¯„ä¼°**ï¼šåŸºäºè®ºè¯è´¨é‡å’Œè¯´æœåŠ›ï¼Œè¯„ä¼°å“ªæ–¹çš„è§‚ç‚¹æ›´æœ‰è¯´æœåŠ›
5. **æœ€ç»ˆç»“è®º**ï¼šç»™å‡ºå¯¹è¾©è®ºä¸»é¢˜çš„æœ€ç»ˆè§è§£æˆ–å»ºè®®

è¯·ç”Ÿæˆä¸€ä¸ªç»“æ„åŒ–ã€å®¢è§‚çš„è¾©è®ºæ€»ç»“ï¼ˆ300-400å­—ï¼‰ï¼š`;

      const summaryMessages: SimpleMessage[] = [
        { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¾©è®ºè¯„å§”å’Œåˆ†æä¸“å®¶ï¼Œæ“…é•¿åˆ†æå’Œæ€»ç»“å¤šè§’åº¦çš„è¾©è®ºå†…å®¹ã€‚' },
        { role: 'user', content: summaryPrompt }
      ];

      const apiRequest: APIChatRequest = {
        messages: summaryMessages,
        model: this.currentModel,
        max_tokens: 1500,
        temperature: 0.3,
        enable_web: false
      };

      const apiResponse = await this.apiManager.sendChatRequest(apiRequest);
      return apiResponse.choices[0]?.message?.content || 'è¾©è®ºæ€»ç»“ç”Ÿæˆå¤±è´¥';

    } catch (error) {
      Logger.error('ChatViewModel', `ç”Ÿæˆè¾©è®ºæ€»ç»“å¤±è´¥: ${(error as Error).message}`);
      return 'æ— æ³•ç”Ÿæˆè¾©è®ºæ€»ç»“';
    }
  }

  /**
   * ä»ç»Ÿè®¡æ•°æ®è·å–å‚ä¸è€…ä¿¡æ¯
   */
  private getParticipantFromStats(roleId: string): SessionParticipant | undefined {
    if (!this.currentSession || !isMultiRoleSession(this.currentSession)) {
      return undefined;
    }

    const multiRoleSession = this.currentSession as MultiRoleSession;
    return multiRoleSession.participants.find(p => p.roleId === roleId);
  }

  /**
   * å¤„ç†è¾©è®ºå¼å¤šäººè®¨è®º
   */
  private async handleDebateDiscussion(
    content: string,
    assistantMessage: Message,
    enableWebSearch: boolean
  ): Promise<void> {
    if (!this.currentSession || !isMultiRoleSession(this.currentSession)) {
      Logger.error('ChatViewModel', 'è¾©è®ºè®¨è®ºå¤±è´¥ï¼šå½“å‰ä¼šè¯ä¸æ˜¯å¤šäººä¼šè¯');
      assistantMessage.content = 'æŠ±æ­‰ï¼Œè¾©è®ºå¤„ç†å¤±è´¥';
      assistantMessage.isLoading = false;
      return;
    }

    const multiRoleSession = this.currentSession as MultiRoleSession;
    const participants = multiRoleSession.participants;
    const discussionRounds = multiRoleSession.discussionRounds || 3;

    Logger.info('ChatViewModel', `å¼€å§‹è¾©è®ºè®¨è®ºï¼š${participants.length}ä¸ªå‚ä¸è€…ï¼Œ${discussionRounds}è½®è¾©è®º`);

    try {
      // ç§»é™¤åˆå§‹çš„assistantæ¶ˆæ¯ï¼Œæˆ‘ä»¬å°†å®æ—¶æ·»åŠ æ¯ä¸ªå‚ä¸è€…çš„æ¶ˆæ¯
      this.removeMessage(assistantMessage);

      // ç¬¬ä¸€æ­¥ï¼šæå–è¾©è®ºä¸»é¢˜
      const debateTopic = this.extractDebateTopic(content);
      Logger.info('ChatViewModel', `æå–è¾©è®ºä¸»é¢˜ï¼š${debateTopic}`);

      // æ·»åŠ è¾©è®ºå¼€å§‹çš„æç¤ºæ¶ˆæ¯
      const introMessage = new Message(
        MessageRole.ASSISTANT,
        `ğŸ¯ **è¾©è®ºä¸»é¢˜**ï¼š${debateTopic}\n\nğŸ‘¥ **å‚ä¸è€…**ï¼š${participants.map(p => p.displayName).join('ã€')}\n\nğŸ’¬ **è®¨è®ºè½®æ•°**ï¼š${discussionRounds}è½®\n\n---\n\nğŸš€ è¾©è®ºå³å°†å¼€å§‹ï¼Œæ¯ä½å‚ä¸è€…å°†æ ¹æ®è‡ªå·±çš„è§’è‰²è§‚ç‚¹è¿›è¡Œè®¨è®º...`,
        this.generateMessageId()
      );
      this.addMessage(introMessage);
      await this.scrollToBottom();

      // åˆå§‹åŒ–è¾©è®ºçŠ¶æ€
      let debateStatus = DebateStatus.OPENING_STATEMENT;
      let currentRound = 0;
      const allMessages: Message[] = [];
      const participantStats: DebateParticipantStats[] = participants.map(p => {
        const stats: DebateParticipantStats = {
          roleId: p.roleId,
          responseCount: 0,
          averageIntensity: 0,
          keyPoints: [],
          effectivenessScore: 0
        };
        return stats;
      });

      // è¿›è¡Œå¤šè½®è¾©è®º
      for (let round = 1; round <= discussionRounds; round++) {
        currentRound = round;

        // æ›´æ–°è¾©è®ºçŠ¶æ€
        if (round === 1) {
          debateStatus = DebateStatus.OPENING_STATEMENT;
        } else if (round < discussionRounds) {
          debateStatus = DebateStatus.REBUTTAL;
        } else {
          debateStatus = DebateStatus.CLOSING_STATEMENT;
        }

        // æ·»åŠ è½®æ¬¡åˆ†éš”æ¶ˆæ¯
        const roundMessage = new Message(
          MessageRole.ASSISTANT,
          `ğŸ”¹ **ç¬¬${round}è½®${this.getDebateStageName(debateStatus)}**`,
          this.generateMessageId()
        );
        this.addMessage(roundMessage);
        await this.scrollToBottom();

        // æ¯ä¸ªå‚ä¸è€…ä¾æ¬¡å‘è¨€
        for (const participant of participants) {
          try {
            // æ·»åŠ "æ€è€ƒä¸­"çŠ¶æ€æ¶ˆæ¯
            const thinkingMessage = new Message(
              MessageRole.ASSISTANT,
              `æ­£åœ¨æ€è€ƒä¸­...`,
              this.generateMessageId()
            );
            thinkingMessage.senderName = participant.displayName;
            thinkingMessage.senderRoleId = participant.roleId;
            thinkingMessage.senderAvatar = participant.avatar;
            thinkingMessage.isLoading = true;
            this.addMessage(thinkingMessage);
            await this.scrollToBottom();

            // åˆ†æå½“å‰è®¨è®ºæ¿€çƒˆç¨‹åº¦
            const currentIntensity = this.analyzeDiscussionIntensity(allMessages);

            // ç”Ÿæˆå¸¦ä¸Šä¸‹æ–‡çš„æç¤ºè¯
            const contextualPrompt = this.generateContextualDebatePrompt(
              participant,
              debateTopic,
              round,
              discussionRounds,
              currentIntensity,
              allMessages
            );

            // æ„å»ºæ¶ˆæ¯å†å²
            const messages = this.buildDebateMessages(content, contextualPrompt, debateTopic, round, allMessages);

            // è·å–å‚ä¸è€…çš„å›åº”
            const response = await this.getParticipantResponse(messages, participant);

            // ç§»é™¤"æ€è€ƒä¸­"æ¶ˆæ¯
            this.removeMessage(thinkingMessage);

            // åˆ›å»ºå‚ä¸è€…çš„å®é™…å‘è¨€æ¶ˆæ¯
            const participantMessage = new Message(
              MessageRole.ASSISTANT,
              response,
              this.generateMessageId()
            );
            participantMessage.senderName = participant.displayName;
            participantMessage.senderRoleId = participant.roleId;
            participantMessage.senderAvatar = participant.avatar;

            // å®æ—¶æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
            this.addMessage(participantMessage);
            allMessages.push(participantMessage);
            await this.scrollToBottom();

            // æ›´æ–°å‚ä¸è€…ç»Ÿè®¡
            const stats = participantStats.find(s => s.roleId === participant.roleId);
            if (stats) {
              stats.responseCount++;
              stats.averageIntensity = (stats.averageIntensity * (stats.responseCount - 1) + currentIntensity) / stats.responseCount;

              // æå–å…³é”®è®ºç‚¹
              const keyPoints = this.extractKeyPointsFromResponse(response);
              stats.keyPoints.push(...keyPoints);
              stats.effectivenessScore = stats.averageIntensity * stats.responseCount;
            }

            // æ·»åŠ å°å»¶è¿Ÿé¿å…APIé™æµ
            await this.delay(800);

          } catch (error) {
            Logger.error('ChatViewModel', `å‚ä¸è€…${participant.displayName}ç¬¬${round}è½®è¾©è®ºå¤±è´¥: ${(error as Error).message}`);

            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„"æ€è€ƒä¸­"æ¶ˆæ¯
            const thinkingMessages = this.messages.filter(m =>
              m.senderRoleId === participant.roleId && m.isLoading
            );
            thinkingMessages.forEach(m => this.removeMessage(m));

            // æ·»åŠ é”™è¯¯æ¶ˆæ¯
            const errorMessage = new Message(
              MessageRole.ASSISTANT,
              `æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å‚ä¸è®¨è®ºã€‚`,
              this.generateMessageId()
            );
            errorMessage.senderName = participant.displayName;
            errorMessage.senderRoleId = participant.roleId;
            errorMessage.senderAvatar = participant.avatar;
            this.addMessage(errorMessage);
            await this.scrollToBottom();
          }
        }
      }

      // ç”Ÿæˆè¾©è®ºæ€»ç»“
      debateStatus = DebateStatus.SUMMARY;
      const summaryLoadingMessage = new Message(
        MessageRole.ASSISTANT,
        `ğŸ† æ­£åœ¨åˆ†æè¾©è®ºå†…å®¹å¹¶ç”Ÿæˆæ€»ç»“...`,
        this.generateMessageId()
      );
      summaryLoadingMessage.isLoading = true;
      this.addMessage(summaryLoadingMessage);
      await this.scrollToBottom();

      const summary = await this.generateDebateSummary(debateTopic, allMessages, participantStats);

      // ç§»é™¤æ€»ç»“åŠ è½½æ¶ˆæ¯
      this.removeMessage(summaryLoadingMessage);

      // æ·»åŠ æœ€ç»ˆæ€»ç»“æ¶ˆæ¯
      const summaryMessage = new Message(
        MessageRole.ASSISTANT,
        `ğŸ† **è¾©è®ºæ€»ç»“**\n\n${summary}`,
        this.generateMessageId()
      );
      this.addMessage(summaryMessage);
      await this.scrollToBottom();

      Logger.info('ChatViewModel', `è¾©è®ºè®¨è®ºå®Œæˆï¼Œå…±${discussionRounds}è½®`);

    } catch (error) {
      const errorMessage = (error as Error).message;
      Logger.error('ChatViewModel', `è¾©è®ºè®¨è®ºå¤±è´¥: ${errorMessage}`);

      // æ·»åŠ é”™è¯¯æ¶ˆæ¯
      const errorMsg = new Message(
        MessageRole.ASSISTANT,
        `âŒ æŠ±æ­‰ï¼Œè¾©è®ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${errorMessage}`,
        this.generateMessageId()
      );
      this.addMessage(errorMsg);
      await this.scrollToBottom();
      throw new Error(errorMessage);
    }
  }

  /**
   * è·å–è¾©è®ºé˜¶æ®µåç§°
   */
  private getDebateStageName(status: DebateStatus): string {
    switch (status) {
      case DebateStatus.OPENING_STATEMENT:
        return 'ï¼ˆå¼€åœºé™ˆè¿°ï¼‰';
      case DebateStatus.REBUTTAL:
        return 'ï¼ˆåé©³è¾©è®ºï¼‰';
      case DebateStatus.CLOSING_STATEMENT:
        return 'ï¼ˆæ€»ç»“é™ˆè¿°ï¼‰';
      default:
        return '';
    }
  }

  /**
   * æ„å»ºè¾©è®ºæ¶ˆæ¯å†å²
   */
  private buildDebateMessages(
    userContent: string,
    systemPrompt: string,
    debateTopic: string,
    currentRound: number,
    previousMessages: Message[]
  ): SimpleMessage[] {
    const messages: SimpleMessage[] = [];

    // æ·»åŠ ç³»ç»Ÿæç¤ºè¯ï¼ˆè¿™é‡ŒåŒ…å«äº†è§’è‰²åŸå§‹æç¤ºè¯å’Œè¾©è®ºä¸Šä¸‹æ–‡ï¼‰
    messages.push({
      role: 'system',
      content: systemPrompt
    });

    // æ·»åŠ ç”¨æˆ·åŸå§‹é—®é¢˜å’Œè¾©è®ºä¸»é¢˜
    messages.push({
      role: 'user',
      content: `**ç”¨æˆ·é—®é¢˜**ï¼š${userContent}

**è¾©è®ºä¸»é¢˜**ï¼š${debateTopic}

**å½“å‰è½®æ¬¡**ï¼šç¬¬${currentRound}è½®

è¯·åŸºäºä½ çš„è§’è‰²å®šä½å’Œå‰é¢çš„è®¨è®ºå†…å®¹ï¼Œæä¾›æœ‰é’ˆå¯¹æ€§çš„è¾©è®ºè§‚ç‚¹ã€‚`
    });

    return messages;
  }

  /**
   * ä»å›åº”ä¸­æå–å…³é”®è®ºç‚¹
   */
  private extractKeyPointsFromResponse(response: string): string[] {
    const keyPoints: string[] = [];

    // æŒ‰å¥å­åˆ†å‰²
    const sentences = response.split(/[ã€‚ï¼ï¼Ÿ!?.]/).filter(s => s.trim().length > 10);

    // æå–åŒ…å«è®ºç‚¹æ ‡å¿—çš„å¥å­
    const argumentKeywords = ['è®¤ä¸º', 'è§‚ç‚¹', 'ç«‹åœº', 'ç†ç”±', 'å› ä¸º', 'æ‰€ä»¥', 'é¦–å…ˆ', 'å…¶æ¬¡', 'æœ€å', 'believe', 'think', 'argue', 'because', 'therefore', 'first', 'second', 'finally'];

    for (const sentence of sentences) {
      const cleanSentence = sentence.trim();
      if (cleanSentence.length > 15 && cleanSentence.length < 100) {
        // æ£€æŸ¥æ˜¯å¦åŒ…å«è®ºç‚¹å…³é”®è¯
        const hasArgumentKeyword = argumentKeywords.some(keyword =>
          cleanSentence.toLowerCase().includes(keyword.toLowerCase())
        );

        if (hasArgumentKeyword || cleanSentence.includes('ï¼š') || cleanSentence.includes(':')) {
          keyPoints.push(cleanSentence);
        }
      }
    }

    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„è®ºç‚¹ï¼Œå–å‰ä¸¤ä¸ªæœ‰æ„ä¹‰çš„å¥å­
    if (keyPoints.length === 0 && sentences.length > 0) {
      keyPoints.push(...sentences.slice(0, 2).map(s => s.trim()));
    }

    return keyPoints.slice(0, 3); // æœ€å¤šè¿”å›3ä¸ªå…³é”®è®ºç‚¹
  }

  /**
   * ç”Ÿæˆæ¶ˆæ¯ID
   */
  private generateMessageId(): string {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
  }

  /**
   * å»¶è¿Ÿå‡½æ•°
   */
  private async delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  /**
   * å°†æ­¥éª¤IDæ˜ å°„åˆ°æ€è€ƒçŠ¶æ€
   */
  private mapThinkingStatus(stepId: string): ThinkingStatus {
    switch (stepId) {
      case 'plan': return ThinkingStatus.PLANNING;
      case 'analyze': return ThinkingStatus.ANALYZING;
      case 'research': return ThinkingStatus.RESEARCHING;
      case 'think': return ThinkingStatus.THINKING;
      case 'verify': return ThinkingStatus.VERIFYING;
      case 'integrate': return ThinkingStatus.INTEGRATING;
      case 'review': return ThinkingStatus.REFINING;
      default: return ThinkingStatus.IDLE;
    }
  }

  /**
   * åŠ è½½å½“å‰ä¼šè¯çš„èŠå¤©è®°å½•
   */
  async loadMessages(): Promise<void> {
    try {
      if (!this.currentSession) {
        Logger.warn('ChatViewModel', 'æ²¡æœ‰å½“å‰ä¼šè¯ï¼Œæ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨');
        this.messages = [];
        return;
      }

      // åœ¨é‡æ–°åŠ è½½å‰ï¼Œä¿å­˜å½“å‰æ’­æ”¾çŠ¶æ€åˆ°çŠ¶æ€ç®¡ç†å™¨
      const currentPlayingMessageId = this.getCurrentPlayingMessage()?.id;
      const currentTtsState = this.ttsService.getState();
      
      // ä½¿ç”¨çŠ¶æ€ç®¡ç†å™¨ä¿å­˜æ’­æ”¾çŠ¶æ€
      this.audioPlaybackStateManager.saveTTSState(currentTtsState);
      if (currentPlayingMessageId) {
        this.audioPlaybackStateManager.savePlayingState(currentPlayingMessageId, currentTtsState === TTSState.PLAYING);
      }
      
      Logger.info('ChatViewModel', `ä¿å­˜æ’­æ”¾çŠ¶æ€ - æ’­æ”¾æ¶ˆæ¯ID: ${currentPlayingMessageId || 'æ— '}, TTSçŠ¶æ€: ${currentTtsState}`);

      const storedMessages = await this.sessionManager.getSessionMessages(this.currentSession.id);
      Logger.info('ChatViewModel', `åŠ è½½ä¼šè¯ ${this.currentSession.id} çš„ ${storedMessages.length} æ¡æ¶ˆæ¯`);
      
      if (storedMessages.length > 0) {
        // æ¸…ç©ºç°æœ‰æ¶ˆæ¯æ•°ç»„
        this.messages.length = 0;
        
        // é€æ¡æ·»åŠ æ¶ˆæ¯ä»¥ç¡®ä¿çŠ¶æ€æ›´æ–°
        (storedMessages as StoredMessage[]).forEach((msgData: StoredMessage) => {
          console.info(`åŸå§‹æ¶ˆæ¯æ•°æ®:`, JSON.stringify(msgData));
          
          // å¤„ç†ObservedV2è£…é¥°å™¨äº§ç”Ÿçš„__ob_å‰ç¼€å­—æ®µ
          const id: string = msgData.id || msgData.__ob_id || '';
          const role: string = msgData.role || msgData.__ob_role || 'user';
          const content: string = msgData.content || msgData.__ob_content || '';
          const timestamp: number = msgData.timestamp || msgData.__ob_timestamp || Date.now();
          
          console.info(`è§£æå­—æ®µ: id=${id}, role=${role}, content=${content.substring(0, 30)}...`);
          
          // ç¡®ä¿roleæ˜¯æ­£ç¡®çš„æšä¸¾å€¼
          let messageRole: MessageRole;
          if (role === 'user' || role === MessageRole.USER) {
            messageRole = MessageRole.USER;
          } else if (role === 'assistant' || role === MessageRole.ASSISTANT) {
            messageRole = MessageRole.ASSISTANT;
          } else if (role === 'system' || role === MessageRole.SYSTEM) {
            messageRole = MessageRole.SYSTEM;
          } else {
            messageRole = MessageRole.USER; // é»˜è®¤å€¼
          }
          
          const message = new Message(messageRole, content, id);
          message.timestamp = timestamp;
          message.isLoading = false;
          
          // æ¢å¤æ’­æ”¾çŠ¶æ€ï¼šä½¿ç”¨çŠ¶æ€ç®¡ç†å™¨æ¢å¤æ’­æ”¾çŠ¶æ€
          if (this.audioPlaybackStateManager.isMessagePlaying(id)) {
            message.isPlaying = true;
            Logger.info('ChatViewModel', `æ¢å¤æ¶ˆæ¯ ${id} çš„æ’­æ”¾çŠ¶æ€`);
          }
          
          // å¤„ç†ç½‘ç»œæœç´¢ç›¸å…³å­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (msgData.__ob_webUsed !== undefined) {
            message.webUsed = msgData.__ob_webUsed;
          }
          if (msgData.__ob_searchInfo !== undefined) {
            message.searchInfo = msgData.__ob_searchInfo;
          }
          
          this.messages.push(message);
          
          console.info(`æ·»åŠ æ¶ˆæ¯æˆåŠŸ: role=${messageRole}, contenté•¿åº¦=${content.length}`);
        });
        
        console.info(`UIæ¶ˆæ¯æ•°ç»„é•¿åº¦: ${this.messages.length}`);
        
        // å¦‚æœTTSä»åœ¨æ’­æ”¾çŠ¶æ€ä½†æ²¡æœ‰æ‰¾åˆ°å¯¹åº”æ¶ˆæ¯ï¼Œè®°å½•è­¦å‘Š
        if (this.audioPlaybackStateManager.hasAnyPlayingMessage()) {
          const playingMessageIds = this.audioPlaybackStateManager.getPlayingMessageIds();
          for (const messageId of playingMessageIds) {
            const restoredMessage = this.messages.find(msg => msg.id === messageId);
            if (!restoredMessage) {
              Logger.warn('ChatViewModel', `TTSä»åœ¨æ’­æ”¾ä½†æ‰¾ä¸åˆ°å¯¹åº”æ¶ˆæ¯ ${messageId}ï¼Œå¼ºåˆ¶åœæ­¢TTS`);
              await this.ttsService.forceStop();
              this.audioPlaybackStateManager.clearAllStates();
              break;
            }
          }
        }
      } else {
        this.messages = [];
      }
    } catch (error) {
      const errorContext = new ErrorContext();
      errorContext.module = 'ChatViewModel';
      errorContext.function = 'loadMessages';
      errorContext.additionalInfo = JSON.stringify({
        errorType: 'MessageLoadFailed'
      });
      
      const errorManager = ErrorManager.getInstance();
      if (error instanceof Error) {
        errorManager.handleError(
          errorManager.createError(
            ErrorType.STORAGE,
            ErrorCode.STORAGE_READ_FAILED,
            `åŠ è½½æ¶ˆæ¯å¤±è´¥: ${error.message}`,
            errorContext,
            ErrorLevel.WARNING,
            error
          )
        );
      }
      
      this.messages = [];
    }
  }

  /**
   * åŠ è½½å‚å•†å’Œæ¨¡å‹åˆ—è¡¨
   */
  async loadProviders(): Promise<void> {
    try {
      this.isLoading = true;
      
      const currentMode = this.apiManager.getCurrentMode();
      console.info(`å½“å‰APIæ¨¡å¼: ${currentMode}ï¼Œå¼€å§‹åŠ è½½providers`);
      
      if (currentMode === APIMode.DIRECT_CALL) {
        // ç›´è¿æ¨¡å¼ï¼šä»DirectAPIServiceè·å–æ¨¡å‹åˆ—è¡¨
        await this.loadProvidersDirectMode();
      } else {
        // æœåŠ¡ç«¯æ¨¡å¼ï¼šä»ApiServiceè·å–
        await this.loadProvidersServerMode();
      }

      console.info(`åŠ è½½äº† ${this.providers.length} ä¸ªå‚å•†:`);
      this.providers.forEach(provider => {
        console.info(`- ${provider.name}: ${provider.models.length} ä¸ªæ¨¡å‹`);
      });

      // å°è¯•æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©ï¼Œå¦‚æœæ²¡æœ‰æˆ–æ— æ•ˆåˆ™ä½¿ç”¨é»˜è®¤é€‰æ‹©
      await this.restoreOrSetDefaultModel();
    } catch (error) {
      const errorContext = new ErrorContext();
      errorContext.module = 'ChatViewModel';
      errorContext.function = 'loadProviders';
      errorContext.additionalInfo = JSON.stringify({
        errorType: 'ProviderLoadFailed',
        apiMode: 'unknown'
      });
      
      const errorManager = ErrorManager.getInstance();
      if (error instanceof Error) {
        errorManager.handleError(
          errorManager.createError(
            ErrorType.API,
            ErrorCode.API_SERVICE_UNAVAILABLE,
            `åŠ è½½å‚å•†åˆ—è¡¨å¤±è´¥: ${error.message}`,
            errorContext,
            ErrorLevel.ERROR,
            error
          )
        );
      }
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * æœåŠ¡ç«¯æ¨¡å¼åŠ è½½providers
   */
  private async loadProvidersServerMode(): Promise<void> {
    try {
      const response = await this.apiService.getProviders();
      console.info('æ”¶åˆ°æœåŠ¡ç«¯providerså“åº”:', JSON.stringify(response));

      this.providers = Object.entries(response.providers).map(
        (entry: [string, string[]]) => new Provider(entry[0], entry[1])
      );
    } catch (error) {
      console.error('æœåŠ¡ç«¯æ¨¡å¼åŠ è½½providerså¤±è´¥:', (error as Error).message);
      throw new Error(`æœåŠ¡ç«¯æ¨¡å¼åŠ è½½providerså¤±è´¥: ${(error as Error).message}`);
    }
  }

  /**
   * ç›´è¿æ¨¡å¼åŠ è½½providersï¼ˆæ”¯æŒç½‘ç»œæŸ¥è¯¢å’Œæœ¬åœ°é™çº§ï¼‰
   */
  private async loadProvidersDirectMode(): Promise<void> {
    try {
      Logger.info('ChatViewModel', '=== å¼€å§‹ç›´è¿æ¨¡å¼åŠ è½½providers ===');
      Logger.info('ChatViewModel', 'æ­£åœ¨ä»ç½‘ç»œè·å–æ¨¡å‹åˆ—è¡¨...');
      
      // è·å–æ¨¡å‹å‚å•†æ˜ å°„ï¼ˆåŒ…å«ç½‘ç»œæŸ¥è¯¢å’Œæœ¬åœ°é™çº§ï¼‰
      const startTime = Date.now();
      const modelProviderMap = await this.apiManager.getModelProviderMap();
      const endTime = Date.now();
      
      Logger.info('ChatViewModel', `æ¨¡å‹åˆ—è¡¨è·å–å®Œæˆï¼Œè€—æ—¶: ${endTime - startTime}ms`);
      Logger.info('ChatViewModel', `æ”¶åˆ°ç›´è¿æ¨¡å¼æ¨¡å‹å‚å•†æ˜ å°„: ${modelProviderMap.size} ä¸ªæ¨¡å‹`);
      
      if (modelProviderMap.size === 0) {
        Logger.warn('ChatViewModel', 'æœªè·å–åˆ°ä»»ä½•æ¨¡å‹ï¼Œå¯èƒ½æ˜¯æœªé…ç½®APIå¯†é’¥æˆ–ç½‘ç»œé—®é¢˜');
        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œè€Œæ˜¯è®¾ç½®ç©ºçš„providersåˆ—è¡¨
        // è¿™æ ·ç”¨æˆ·å¯ä»¥çœ‹åˆ°ç©ºçŠ¶æ€æç¤ºï¼Œè€Œä¸æ˜¯åº”ç”¨å´©æºƒ
        this.providers = [];
        Logger.info('ChatViewModel', 'è®¾ç½®ç©ºçš„providersåˆ—è¡¨ï¼Œå°†æ˜¾ç¤ºç©ºçŠ¶æ€');
        return;
      }
      
      // å°†Map<string, AIProvider>è½¬æ¢ä¸ºProvider[]
      this.providers = [];
      
      // æŒ‰å‚å•†åˆ†ç»„æ¨¡å‹
      const providerModels = new Map<string, string[]>();
      
      modelProviderMap.forEach((provider, model) => {
        const providerName = this.getProviderServerName(provider);
        if (!providerModels.has(providerName)) {
          providerModels.set(providerName, []);
        }
        providerModels.get(providerName)!.push(model);
      });
      
      // åˆ›å»ºProviderå¯¹è±¡
      providerModels.forEach((models, providerName) => {
        this.providers.push(new Provider(providerName, models));
        Logger.info('ChatViewModel', `å‚å•† ${providerName}: ${models.length} ä¸ªæ¨¡å‹`);
      });
      
      Logger.info('ChatViewModel', `=== ç›´è¿æ¨¡å¼providersåŠ è½½å®Œæˆ ===`);
      Logger.info('ChatViewModel', `æ€»å…±åŠ è½½äº† ${this.providers.length} ä¸ªå‚å•†`);
      
    } catch (error) {
      const errorMessage = (error as Error).message;
      Logger.error('ChatViewModel', `=== ç›´è¿æ¨¡å¼åŠ è½½providerså¤±è´¥ ===`);
      Logger.error('ChatViewModel', `é”™è¯¯ä¿¡æ¯: ${errorMessage}`);
      
      // å¦‚æœç½‘ç»œè·å–å¤±è´¥ï¼Œä½¿ç”¨ç©ºçš„providersåˆ—è¡¨ï¼Œä½†ä¸æŠ›å‡ºé”™è¯¯
      // è¿™æ ·å¯ä»¥é¿å…æ•´ä¸ªåº”ç”¨å´©æºƒ
      this.providers = [];
      Logger.warn('ChatViewModel', 'ç›´è¿æ¨¡å¼providersåŠ è½½å¤±è´¥ï¼Œå°†ç»§ç»­å°è¯•ä½¿ç”¨é»˜è®¤é…ç½®');
    }
  }

  /**
   * è·å–å‚å•†åœ¨æœåŠ¡ç«¯æ¨¡å¼ä¸‹çš„åç§°
   */
  private getProviderServerName(provider: AIProvider): string {
    switch (provider) {
      case AIProvider.GLM:
        return 'zhipu';
      case AIProvider.SILICONFLOW:
        return 'siliconflow';
      case AIProvider.GEMINI:
        return 'google';
      default:
        return 'unknown';
    }
  }

  /**
   * æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©ï¼Œå¦‚æœæ²¡æœ‰æˆ–æ— æ•ˆåˆ™ä½¿ç”¨é»˜è®¤é€‰æ‹©
   */
  private async restoreOrSetDefaultModel(): Promise<void> {
    try {
      Logger.info('ChatViewModel', 'å¼€å§‹æ¢å¤æ¨¡å‹é€‰æ‹©é…ç½®');
      
      // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„providers
      if (this.providers.length === 0) {
        this.currentProvider = '';
        this.currentModel = '';
        Logger.warn('ChatViewModel', 'æ²¡æœ‰å¯ç”¨çš„providersï¼Œæ¸…ç©ºå½“å‰æ¨¡å‹é€‰æ‹©');
        return;
      }

      // å°è¯•ä»å­˜å‚¨ä¸­æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©
      const savedConfig = await AppStorage.getCurrentModelConfig();
      
      if (savedConfig) {
        Logger.info('ChatViewModel', `å°è¯•æ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©: ${savedConfig.provider}.${savedConfig.model}`);
        
        // éªŒè¯ä¿å­˜çš„é€‰æ‹©åœ¨å½“å‰providersä¸­æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
        const provider = this.providers.find(p => p.name === savedConfig.provider);
        if (provider && provider.models.includes(savedConfig.model)) {
          // ä¿å­˜çš„é€‰æ‹©ä»ç„¶æœ‰æ•ˆï¼Œæ¢å¤å®ƒ
          this.currentProvider = savedConfig.provider;
          this.currentModel = savedConfig.model;
          Logger.info('ChatViewModel', `æˆåŠŸæ¢å¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©: ${this.currentProvider}.${this.currentModel}`);
          return;
        } else {
          Logger.warn('ChatViewModel', 'ä¿å­˜çš„æ¨¡å‹é€‰æ‹©å·²å¤±æ•ˆï¼Œå°†ä½¿ç”¨é»˜è®¤é€‰æ‹©å¹¶æ¸…é™¤ä¿å­˜çš„é…ç½®');
          // æ¸…é™¤æ— æ•ˆçš„ä¿å­˜é…ç½®
          await AppStorage.clearCurrentModel();
        }
      } else {
        Logger.info('ChatViewModel', 'æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¨¡å‹é€‰æ‹©ï¼Œä½¿ç”¨é»˜è®¤é€‰æ‹©');
      }

      // æ²¡æœ‰ä¿å­˜çš„é€‰æ‹©æˆ–é€‰æ‹©æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤é€‰æ‹©é€»è¾‘
      this.setDefaultModel();
      
    } catch (error) {
      Logger.error('ChatViewModel', `æ¢å¤æ¨¡å‹é€‰æ‹©å¤±è´¥: ${error}ï¼Œä½¿ç”¨é»˜è®¤é€‰æ‹©`);
      this.setDefaultModel();
    }
  }

  /**
   * è®¾ç½®é»˜è®¤æ¨¡å‹é€‰æ‹©
   */
  private setDefaultModel(): void {
    if (this.providers.length === 0) {
      this.currentProvider = '';
      this.currentModel = '';
      Logger.warn('ChatViewModel', 'æ²¡æœ‰å¯ç”¨çš„providersï¼Œæ— æ³•è®¾ç½®é»˜è®¤æ¨¡å‹');
      return;
    }

    // ä¼˜å…ˆé€‰æ‹©siliconflowå‚å•†
    const preferredProvider = this.providers.find(p => p.name === 'siliconflow') || this.providers[0];
    
    if (preferredProvider) {
      this.currentProvider = preferredProvider.name;
      
      if (preferredProvider.models.length > 0) {
        // ä¼˜å…ˆé€‰æ‹©åŒ…å«glmçš„æ¨¡å‹
        const glmModel = preferredProvider.models.find(model => model.includes('glm'));
        this.currentModel = glmModel || preferredProvider.models[0];
      } else {
        this.currentModel = '';
      }
      
      Logger.info('ChatViewModel', `è®¾ç½®é»˜è®¤æ¨¡å‹é€‰æ‹©: ${this.currentProvider}.${this.currentModel}`);
    }
  }

  /**
   * å‘é€æ¶ˆæ¯ - ä½¿ç”¨çŠ¶æ€ç®¡ç†å™¨è‡ªåŠ¨ç¡®å®šåŠŸèƒ½é…ç½®
   */
  async sendMessage(content: string, isVoiceMessage: boolean = false): Promise<void> {
    if (!content.trim() || this.isLoading) {
      return;
    }

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆä¿æŒåŸå§‹å†…å®¹ï¼‰
    const userMessage = new Message(MessageRole.USER, content);
    this.messages.push(userMessage);
    
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œç”ŸæˆåŒ…å«ç³»ç»Ÿæç¤ºè¯å…³é”®è¯çš„ä¼šè¯åç§°
    if (this.currentSession && this.currentSession.messageCount === 0) {
      const sessionName = Session.generateSessionName(content, this.getCurrentSessionSystemPrompt() || undefined); // ä¼ å…¥ç³»ç»Ÿæç¤ºè¯
      await this.sessionManager.renameSession(this.currentSession.id, sessionName);
      this.currentSession.name = sessionName;
    }
    
    await this.saveMessages();

    // è·å–å½“å‰åŠŸèƒ½çŠ¶æ€
    const currentFeatures = this.apiManager.getCurrentFeatures();

    // æ·»åŠ åŠ è½½ä¸­çš„åŠ©æ‰‹æ¶ˆæ¯
    const assistantMessage = new Message(MessageRole.ASSISTANT, '');
    assistantMessage.isLoading = true;
    assistantMessage.isDeepThinking = currentFeatures.enableDeepThinking;
    assistantMessage.thinkingStatus = currentFeatures.enableDeepThinking ? ThinkingStatus.ANALYZING : ThinkingStatus.IDLE;

    // åˆå§‹åŒ–å·¥å…·è°ƒç”¨çŠ¶æ€
    if (currentFeatures.enableWebSearch || currentFeatures.enableMCPTools) {
      assistantMessage.toolStatus = 'calling';
      if (currentFeatures.enableWebSearch) {
        assistantMessage.toolType = 'search';
        assistantMessage.toolName = 'ç½‘ç»œæœç´¢';
      } else if (currentFeatures.enableMCPTools) {
        assistantMessage.toolType = 'mcp';
        assistantMessage.toolName = 'MCPå·¥å…·';
        // åˆå§‹åŒ–ä¸ºç©ºæ•°ç»„ï¼Œç­‰å¾…å®é™…æ‰§è¡Œçš„å·¥å…·ç»“æœ
        assistantMessage.mcpToolNames = [];
      }
    }

    this.messages.push(assistantMessage);

    this.isLoading = true;

    try {
      // æ£€æŸ¥æ˜¯å¦ä¸ºå¤šäººä¼šè¯ï¼Œä¼˜å…ˆå¤„ç†å¤šäººä¼šè¯é€»è¾‘
      if (this.currentSession && isMultiRoleSession(this.currentSession)) {
        Logger.info('ChatViewModel', 'æ£€æµ‹åˆ°å¤šäººä¼šè¯ï¼Œå¯åŠ¨è¾©è®ºå¼è®¨è®º');
        await this.handleDebateDiscussion(content, assistantMessage, currentFeatures.enableWebSearch);
      } else if (currentFeatures.enableDeepThinking) {
        Logger.info('ChatViewModel', 'å¯ç”¨æ·±åº¦æ€è€ƒæ¨¡å¼');
        await this.handleDeepThinking(content, assistantMessage, currentFeatures.enableWebSearch);
      } else {
        Logger.info('ChatViewModel', 'ä½¿ç”¨æ™ºèƒ½èŠå¤©æ¨¡å¼');
        await this.handleSmartMessage(content, assistantMessage);
      }
    } catch (error) {
      const errorContext = new ErrorContext();
      errorContext.module = 'ChatViewModel';
      errorContext.function = 'sendMessage';
      errorContext.additionalInfo = JSON.stringify({
        isVoiceMessage: isVoiceMessage,
        enableWebSearch: currentFeatures.enableWebSearch,
        enableDeepThinking: currentFeatures.enableDeepThinking,
        enableMCPTools: currentFeatures.enableMCPTools,
        messageLength: content.length,
        currentProvider: this.currentProvider,
        currentModel: this.currentModel
      });
      
      const errorManager = ErrorManager.getInstance();
      if (error instanceof Error) {
        const appError = errorManager.createError(
          ErrorType.BUSINESS,
          ErrorCode.UNKNOWN_ERROR,
          `å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`,
          errorContext,
          ErrorLevel.ERROR,
          error
        );
        
        errorManager.handleError(appError);
      }
  
      const errorMessage = (error as Error).message || 'æœªçŸ¥é”™è¯¯';
      assistantMessage.content = `å‘é€æ¶ˆæ¯å¤±è´¥: ${errorMessage}`;

      // é”™è¯¯æƒ…å†µä¸‹è®¾ç½®å·¥å…·è°ƒç”¨å¤±è´¥çŠ¶æ€
      if (assistantMessage.toolStatus === 'calling') {
        assistantMessage.toolStatus = 'failed';
      }
    } finally {
      assistantMessage.isLoading = false;
      this.isLoading = false;

      // ç¡®ä¿å·¥å…·è°ƒç”¨çŠ¶æ€æ­£ç¡®ç»“æŸ
      if (assistantMessage.toolStatus === 'calling') {
        assistantMessage.toolStatus = 'completed';
      }

      await this.saveMessages();
      
      // å¦‚æœåŠ©æ‰‹æ¶ˆæ¯ä¸ä¸ºç©ºä¸”æ²¡æœ‰é”™è¯¯ï¼Œåˆ™è§¦å‘è‡ªåŠ¨æ’­æŠ¥
      if (assistantMessage.content && 
          !assistantMessage.content.startsWith('é”™è¯¯:') && 
          !assistantMessage.content.startsWith('å‘é€æ¶ˆæ¯å¤±è´¥:')) {
        await this.handleAutoPlayback(assistantMessage);
      }
    }
  }

  /**
   * ä¿å­˜èŠå¤©è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
   */
  async saveMessages(): Promise<void> {
    if (!this.currentSession) {
      Logger.warn('ChatViewModel', 'æ²¡æœ‰å½“å‰ä¼šè¯ï¼Œæ— æ³•ä¿å­˜æ¶ˆæ¯');
      return;
    }
    
    const messagesToSave = this.messages.filter(msg => !msg.isLoading);
    await this.sessionManager.saveSessionMessages(this.currentSession.id, messagesToSave);
    
    // ä»…æ›´æ–°å½“å‰ä¼šè¯çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é‡æ–°åŠ è½½æ•´ä¸ªä¼šè¯åˆ—è¡¨
    await this.updateCurrentSessionInfo();
  }

  /**
   * åˆ‡æ¢æ¨¡å‹
   */
  async switchModel(provider: string, model: string): Promise<void> {
    Logger.info('ChatViewModel', `åˆ‡æ¢æ¨¡å‹: ${provider} -> ${model}ï¼Œå…ˆåœæ­¢è¯­éŸ³æ’­æ”¾`);
    
    // åˆ‡æ¢æ¨¡å‹å‰å…ˆåœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾å¹¶æ¸…ç©ºé˜Ÿåˆ—
    await this.stopAllAudio();
    
    // ç›´æ¥ä½¿ç”¨ç”¨æˆ·çš„é€‰æ‹©ï¼Œä¸è¿›è¡ŒéªŒè¯ï¼ˆç”¨æˆ·å·²ç»ä»æ¨¡å‹é€‰æ‹©å™¨ä¸­æ˜ç¡®é€‰æ‹©ï¼‰
    this.currentProvider = provider;
    this.currentModel = model;
    
    // ä¿å­˜æ¨¡å‹é€‰æ‹©åˆ°å­˜å‚¨ä¸­ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯åŠ¨æ—¶æ¢å¤
    try {
      await AppStorage.saveCurrentModel(provider, model);
      Logger.info('ChatViewModel', 'æ¨¡å‹é€‰æ‹©å·²ä¿å­˜åˆ°å­˜å‚¨');
    } catch (error) {
      Logger.warn('ChatViewModel', `ä¿å­˜æ¨¡å‹é€‰æ‹©å¤±è´¥: ${error}ï¼Œä½†ä¸å½±å“å½“å‰ä½¿ç”¨`);
    }
    
    Logger.info('ChatViewModel', `æ¨¡å‹åˆ‡æ¢å®Œæˆ: ${this.currentProvider}.${this.currentModel}`);
  }

  /**
   * æ¸…ç©ºå½“å‰ä¼šè¯çš„èŠå¤©è®°å½•
   */
  async clearMessages(): Promise<void> {
    Logger.info('ChatViewModel', 'å¼€å§‹æ¸…ç©ºå½“å‰ä¼šè¯æ¶ˆæ¯ï¼Œå…ˆåœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾');
    
    // åœ¨æ¸…ç©ºæ¶ˆæ¯å‰å…ˆåœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾å¹¶æ¸…ç©ºé˜Ÿåˆ—
    await this.stopAllAudio();
    
    if (!this.currentSession) {
      Logger.warn('ChatViewModel', 'æ²¡æœ‰å½“å‰ä¼šè¯ï¼Œæ— æ³•æ¸…ç©ºæ¶ˆæ¯');
      return;
    }
    
    // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
    this.messages = [];
    await this.sessionManager.saveSessionMessages(this.currentSession.id, []);
    
    // ä»…æ›´æ–°å½“å‰ä¼šè¯ä¿¡æ¯ï¼Œé¿å…é‡æ–°åŠ è½½æ•´ä¸ªä¼šè¯åˆ—è¡¨
    await this.updateCurrentSessionInfo();
    
    Logger.info('ChatViewModel', 'å½“å‰ä¼šè¯æ¶ˆæ¯æ¸…ç©ºå®Œæˆ');
  }

  /**
   * å‹ç¼©å¯¹è¯ä¸Šä¸‹æ–‡ - ä¿ç•™æœ€è¿‘çš„å…³é”®å¯¹è¯
   */
  async compactMessages(): Promise<void> {
    if (this.messages.length <= 6) {
      // æ¶ˆæ¯æ•°é‡å°‘äº6æ¡æ—¶ä¸éœ€è¦å‹ç¼©
      return;
    }

    Logger.info('ChatViewModel', 'å¼€å§‹å‹ç¼©æ¶ˆæ¯ï¼Œå…ˆåœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾');
    
    // åœ¨å‹ç¼©æ¶ˆæ¯å‰å…ˆåœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾å¹¶æ¸…ç©ºé˜Ÿåˆ—
    await this.stopAllAudio();

    const compactedMessages: Message[] = [];
    const recentMessages = this.messages.slice(-6); // ä¿ç•™æœ€è¿‘6æ¡æ¶ˆæ¯

    // éå†æœ€è¿‘çš„æ¶ˆæ¯ï¼Œä¿ç•™å®Œæ•´çš„å¯¹è¯å¯¹
    for (let i = 0; i < recentMessages.length; i++) {
      const message = recentMessages[i];
      
      // å‹ç¼©è¿‡é•¿çš„æ¶ˆæ¯å†…å®¹
      if (message.content.length > 200) {
        const compactedContent = message.content.substring(0, 150) + 
          '\n...[å†…å®¹å·²å‹ç¼©]...\n' + 
          message.content.substring(message.content.length - 50);
        
        const compactedMessage = new Message(message.role, compactedContent, message.id);
        compactedMessage.timestamp = message.timestamp;
        compactedMessages.push(compactedMessage);
      } else {
        compactedMessages.push(message);
      }
    }

    this.messages = compactedMessages;
    await this.saveMessages();
  }

  /**
   * è·å–å½“å‰é€‰ä¸­çš„å‚å•†ä¿¡æ¯
   */
  getCurrentProvider(): Provider | undefined {
    return this.providers.find(p => p.name === this.currentProvider);
  }

  /**
   * è·å–ä¼šè¯ç®¡ç†å™¨å®ä¾‹
   */
  getSessionManager(): SessionManager {
    return this.sessionManager;
  }

  /**
   * è·å–å½“å‰ä¼šè¯çš„ç³»ç»Ÿæç¤ºè¯ - å¢å¼ºç‰ˆæœ¬æ”¯æŒå¤šè½®è§’è‰²å¯¹è¯
   */
  getCurrentSessionSystemPrompt(): SystemPrompt | null {
    if (!this.currentSession) {
      Logger.debug('ChatViewModel', 'å½“å‰æ²¡æœ‰ä¼šè¯');
      return null;
    }

    // ä¼˜å…ˆä½¿ç”¨æ´»è·ƒè§’è‰²IDï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç»‘å®šçš„ç³»ç»Ÿæç¤ºè¯ID
    const activeRoleId = this.currentSession.getActiveRoleId?.() || this.currentSession.activeRoleId;
    const targetPromptId = activeRoleId || this.currentSession.systemPromptId;

    if (!targetPromptId) {
      Logger.debug('ChatViewModel', 'å½“å‰ä¼šè¯æœªç»‘å®šç³»ç»Ÿæç¤ºè¯');
      return null;
    }

    const prompt = this.systemPrompts.find(p => p.id === targetPromptId);
    if (prompt) {
      Logger.info('ChatViewModel', `è·å–åˆ°ç³»ç»Ÿæç¤ºè¯: ${prompt.name} (ID: ${prompt.id})`);
      if (prompt.isRole) {
        Logger.info('ChatViewModel', `å½“å‰ä¸ºè§’è‰²æ¨¡å¼: ${prompt.roleCategory} - ${prompt.roleDescription}`);
      }

      // å¦‚æœæ´»è·ƒè§’è‰²ä¸ç»‘å®šè§’è‰²ä¸åŒï¼Œè®°å½•çŠ¶æ€
      if (activeRoleId && activeRoleId !== this.currentSession.systemPromptId) {
        Logger.info('ChatViewModel', `ä½¿ç”¨ä¸´æ—¶æ´»è·ƒè§’è‰²: ${activeRoleId}`);
      }
    } else {
      Logger.warn('ChatViewModel', `æœªæ‰¾åˆ°ç³»ç»Ÿæç¤ºè¯: ${targetPromptId}`);
    }

    return prompt || null;
  }

  /**
   * è·å–å½“å‰ä¼šè¯ç³»ç»Ÿæç¤ºè¯å†…å®¹ - å¢å¼ºç‰ˆæœ¬æ”¯æŒå¤šè½®è§’è‰²å¯¹è¯
   * è®°å¿†åŠŸèƒ½ç°åœ¨é€šè¿‡search_memorieså·¥å…·åŠ¨æ€è·å–ï¼Œä¸å†é¢„å…ˆæ³¨å…¥
   */
  async getSystemPromptWithMemory(): Promise<string> {
    try {
      // è·å–åŸå§‹ç³»ç»Ÿæç¤ºè¯
      const originalPrompt = this.getCurrentSessionSystemPrompt();
      const systemPromptContent = originalPrompt?.content || '';

      if (originalPrompt) {
        Logger.info('ChatViewModel', `åº”ç”¨ç³»ç»Ÿæç¤ºè¯: ${originalPrompt.name} (${originalPrompt.isRole ? 'è§’è‰²æ¨¡å¼' : 'æ™®é€šæ¨¡å¼'})`);
        Logger.debug('ChatViewModel', `æç¤ºè¯å†…å®¹é•¿åº¦: ${systemPromptContent.length} å­—ç¬¦`);

        if (originalPrompt.isRole) {
          Logger.info('ChatViewModel', `è§’è‰²ä¿¡æ¯: ${originalPrompt.roleCategory} - ${originalPrompt.roleDescription}`);
        }
      } else {
        Logger.warn('ChatViewModel', 'å½“å‰ä¼šè¯æœªç»‘å®šç³»ç»Ÿæç¤ºè¯ï¼Œå°†ä½¿ç”¨é»˜è®¤è¡Œä¸º');
      }

      return systemPromptContent;
    } catch (error) {
      Logger.error('ChatViewModel', `è·å–ç³»ç»Ÿæç¤ºè¯å¤±è´¥: ${error}`);
      // å‡ºé”™æ—¶è¿”å›ç©ºå­—ç¬¦ä¸²
      return '';
    }
  }

  /**
   * åˆ‡æ¢å½“å‰ä¼šè¯çš„æ´»è·ƒè§’è‰²
   */
  async switchActiveRole(roleId: string): Promise<void> {
    try {
      if (!this.currentSession) {
        Logger.warn('ChatViewModel', 'æ²¡æœ‰å½“å‰ä¼šè¯ï¼Œæ— æ³•åˆ‡æ¢æ´»è·ƒè§’è‰²');
        return;
      }

      // éªŒè¯è§’è‰²æ˜¯å¦å­˜åœ¨
      const role = this.systemPrompts.find(p => p.id === roleId && p.isRole);
      if (!role) {
        Logger.warn('ChatViewModel', `è§’è‰²ä¸å­˜åœ¨: ${roleId}`);
        return;
      }

      // è®¾ç½®æ´»è·ƒè§’è‰²
      this.currentSession.setActiveRole(roleId);

      // ä¿å­˜ä¼šè¯æ›´æ–°ï¼ˆåªæ›´æ–°æ—¶é—´ï¼Œä¸æ”¹å˜å…¶ä»–ä¿¡æ¯ï¼‰
      await this.sessionManager.updateSessionInfo(this.currentSession.id, undefined, {});

      Logger.info('ChatViewModel', `å·²åˆ‡æ¢æ´»è·ƒè§’è‰²: ${role.name} (${roleId})`);

      // ç«‹å³é‡æ–°åŠ è½½æç¤ºè¯ä»¥ç¡®ä¿ä¸‹æ¬¡æ¶ˆæ¯ä½¿ç”¨æ–°è§’è‰²
      await this.loadSystemPrompts();
    } catch (error) {
      Logger.error('ChatViewModel', `åˆ‡æ¢æ´»è·ƒè§’è‰²å¤±è´¥: ${error}`);
    }
  }

  /**
   * æ¸…é™¤å½“å‰ä¼šè¯çš„æ´»è·ƒè§’è‰²ï¼ˆå›åˆ°é»˜è®¤ç»‘å®šè§’è‰²ï¼‰
   */
  async clearActiveRole(): Promise<void> {
    try {
      if (!this.currentSession) {
        Logger.warn('ChatViewModel', 'æ²¡æœ‰å½“å‰ä¼šè¯ï¼Œæ— æ³•æ¸…é™¤æ´»è·ƒè§’è‰²');
        return;
      }

      this.currentSession.clearActiveRole();

      // ä¿å­˜ä¼šè¯æ›´æ–°ï¼ˆåªæ›´æ–°æ—¶é—´ï¼Œä¸æ”¹å˜å…¶ä»–ä¿¡æ¯ï¼‰
      await this.sessionManager.updateSessionInfo(this.currentSession.id, undefined, {});

      Logger.info('ChatViewModel', 'å·²æ¸…é™¤æ´»è·ƒè§’è‰²ï¼Œå›åˆ°é»˜è®¤ç»‘å®šè§’è‰²');

      // ç«‹å³é‡æ–°åŠ è½½æç¤ºè¯
      await this.loadSystemPrompts();
    } catch (error) {
      Logger.error('ChatViewModel', `æ¸…é™¤æ´»è·ƒè§’è‰²å¤±è´¥: ${error}`);
    }
  }

  /**
   * è·å–å½“å‰æ´»è·ƒè§’è‰²ä¿¡æ¯
   */
  getCurrentActiveRole(): SystemPrompt | null {
    if (!this.currentSession) {
      return null;
    }

    const activeRoleId = this.currentSession.getActiveRoleId?.() || this.currentSession.activeRoleId;
    if (!activeRoleId) {
      return null;
    }

    return this.systemPrompts.find(p => p.id === activeRoleId && p.isRole) || null;
  }

  /**
   * åŠ è½½ç³»ç»Ÿæç¤ºè¯
   */
  async loadSystemPrompts(): Promise<void> {
    try {
      console.info('=== ChatViewModel.loadSystemPrompts å¼€å§‹ ===');
      console.info('å½“å‰æ—¶é—´:', new Date().toISOString());
      
      // åˆå§‹åŒ–é»˜è®¤æç¤ºè¯
      console.info('æ­£åœ¨åˆå§‹åŒ–é»˜è®¤æç¤ºè¯...');
      await AppStorage.initializeDefaultPrompts();
      console.info('é»˜è®¤æç¤ºè¯åˆå§‹åŒ–å®Œæˆ');
      
      // åŠ è½½æ‰€æœ‰æç¤ºè¯
      console.info('æ­£åœ¨åŠ è½½æ‰€æœ‰æç¤ºè¯...');
      this.systemPrompts = await AppStorage.getSystemPrompts();
      console.info(`ChatViewModel åŠ è½½äº† ${this.systemPrompts.length} æ¡ç³»ç»Ÿæç¤ºè¯`);
      
      // è¯¦ç»†æ‰“å°æ¯æ¡æç¤ºè¯
      this.systemPrompts.forEach((prompt, index) => {
        console.info(`ChatViewModel æç¤ºè¯[${index}]:`);
        console.info(`  ID: ${prompt.id}`);
        console.info(`  åç§°: ${prompt.name}`);
        console.info(`  å†…å®¹: ${prompt.content.substring(0, 50)}...`);
        });
      
      // ä¸å†åŠ è½½å…¨å±€é€‰ä¸­çš„æç¤ºè¯ï¼Œæ”¹ä¸ºä»ä¼šè¯è·å–
      // await this.loadSelectedSystemPrompt(); // å·²ç§»é™¤
      
      console.info('=== ChatViewModel.loadSystemPrompts å®Œæˆ ===');
    } catch (error) {
      console.error('âŒ ChatViewModel åŠ è½½ç³»ç»Ÿæç¤ºè¯å¤±è´¥:', (error as Error).message);
      console.error('é”™è¯¯å †æ ˆ:', (error as Error).stack);
    }
  }

  // loadSelectedSystemPromptæ–¹æ³•å·²ç§»é™¤ï¼Œä¸å†ä½¿ç”¨å…¨å±€é€‰ä¸­çŠ¶æ€

  // selectSystemPromptæ–¹æ³•å·²ç§»é™¤ï¼Œä¸å†æ”¯æŒå…¨å±€é€‰æ‹©ç³»ç»Ÿæç¤ºè¯
  // ç³»ç»Ÿæç¤ºè¯ç°åœ¨ä¸ä¼šè¯ç»‘å®šï¼Œåœ¨åˆ›å»ºä¼šè¯æ—¶é€‰æ‹©

  /**
   * æ·»åŠ ç³»ç»Ÿæç¤ºè¯
   */
  async addSystemPrompt(name: string, content: string): Promise<void> {
    try {
      const prompt = new SystemPrompt(name, content);
      await AppStorage.addSystemPrompt(prompt);
      await this.loadSystemPrompts(); // é‡æ–°åŠ è½½
      console.info('æ·»åŠ ç³»ç»Ÿæç¤ºè¯æˆåŠŸ');
    } catch (error) {
      console.error('æ·»åŠ ç³»ç»Ÿæç¤ºè¯å¤±è´¥:', (error as Error).message);
    }
  }

  /**
   * æ›´æ–°ç³»ç»Ÿæç¤ºè¯
   */
  async updateSystemPrompt(prompt: SystemPrompt): Promise<void> {
    try {
      await AppStorage.updateSystemPrompt(prompt);
      await this.loadSystemPrompts(); // é‡æ–°åŠ è½½
      
      // ä¸å†éœ€è¦æ›´æ–°å…¨å±€é€‰ä¸­çŠ¶æ€ï¼Œç³»ç»Ÿæç¤ºè¯ç°åœ¨ä¸ä¼šè¯ç»‘å®š
      
      console.info('æ›´æ–°ç³»ç»Ÿæç¤ºè¯æˆåŠŸ');
    } catch (error) {
      console.error('æ›´æ–°ç³»ç»Ÿæç¤ºè¯å¤±è´¥:', (error as Error).message);
    }
  }

  /**
   * åˆ é™¤ç³»ç»Ÿæç¤ºè¯
   */
  async deleteSystemPrompt(promptId: string): Promise<void> {
    try {
      await AppStorage.deleteSystemPrompt(promptId);
      await this.loadSystemPrompts(); // é‡æ–°åŠ è½½
      
      // ä¸å†éœ€è¦æ¸…é™¤å…¨å±€é€‰ä¸­çŠ¶æ€ï¼Œç³»ç»Ÿæç¤ºè¯ç°åœ¨ä¸ä¼šè¯ç»‘å®š
      
      console.info('åˆ é™¤ç³»ç»Ÿæç¤ºè¯æˆåŠŸ');
    } catch (error) {
      console.error('åˆ é™¤ç³»ç»Ÿæç¤ºè¯å¤±è´¥:', (error as Error).message);
    }
  }

  /**
   * é€šè¿‡å‚å•†åç§°è·å–AIProvideræšä¸¾å€¼
   */
  private getAIProviderByName(providerName: string): AIProvider | undefined {
    switch (providerName) {
      case 'siliconflow':
        return AIProvider.SILICONFLOW;
      case 'zhipu':
        return AIProvider.GLM;
      case 'google':
        return AIProvider.GEMINI;
      default:
        return undefined;
    }
  }

  /**
   * æ ¼å¼åŒ–æœç´¢ä¿¡æ¯ä¸ºç®€åŒ–å­—ç¬¦ä¸²ï¼ˆç”¨äºä¸»æ¶ˆæ¯æ˜¾ç¤ºï¼‰
   */
  private formatSearchInfoSimple(searchInfo: SearchInfo): string {
    const parts: string[] = [];
    parts.push('ğŸ” ç½‘ç»œæœç´¢');
    
    if (searchInfo.searchTime) {
      parts.push(`â±ï¸ ${searchInfo.searchTime}ms`);
    }
    
    if (searchInfo.resultCount > 0) {
      parts.push(`ğŸ“Š ${searchInfo.resultCount}ä¸ªç»“æœ`);
    }
    
    return parts.join(' | ');
  }

  /**
   * æ ¼å¼åŒ–æœç´¢ä¿¡æ¯ä¸ºè¯¦ç»†å­—ç¬¦ä¸²ï¼ˆç”¨äºæ°”æ³¡æ˜¾ç¤ºï¼‰
   */
  private formatSearchInfoDetailed(searchInfo: SearchInfo): string {
    const messageEnhancer = MessageEnhancer.getInstance();
    return messageEnhancer.buildUserSearchDetails(searchInfo);
  }

  /**
   * è·å–æœç´¢ç±»åˆ«æ˜¾ç¤ºåç§°
   */
  private getSearchCategoryDisplayName(category: string): string {
    const categoryMap: Record<string, string> = {
      'real_time': 'å®æ—¶ä¿¡æ¯',
      'technical': 'æŠ€æœ¯æŸ¥è¯¢',
      'news': 'æ–°é—»äº‹ä»¶',
      'current_affairs': 'æ—¶äº‹ä¿¡æ¯',
      'factual': 'äº‹å®æŸ¥è¯¢',
      'none': 'æ— '
    };
    return categoryMap[category] || 'æœªçŸ¥';
  }

  /**
   * è·å–é»˜è®¤ç³»ç»Ÿæç¤ºè¯
   */
  getDefaultSystemPrompts(): SystemPrompt[] {
    return AppStorage.getDefaultSystemPrompts();
  }

  // é˜²æŠ–åŠ¨ï¼šè®°å½•ä¸Šæ¬¡æ’­æ”¾æ—¶é—´ï¼Œé˜²æ­¢å¿«é€Ÿé‡å¤ç‚¹å‡»
  private lastPlayTime: Record<string, number> = {};
  private readonly PLAY_DEBOUNCE_TIME = 1000; // 1ç§’é˜²æŠ–åŠ¨

  /**
   * æ’­æ”¾æŒ‡å®šæ¶ˆæ¯çš„è¯­éŸ³
   */
  async playMessageAudio(messageId: string): Promise<boolean> {
    try {
      // é˜²æŠ–åŠ¨æ£€æŸ¥ï¼šé˜²æ­¢å¿«é€Ÿé‡å¤ç‚¹å‡»åŒä¸€ä¸ªæ¶ˆæ¯
      const now = Date.now();
      const lastPlay = this.lastPlayTime[messageId];
      if (lastPlay && now - lastPlay < this.PLAY_DEBOUNCE_TIME) {
        Logger.warn('ChatViewModel', `é˜²æŠ–åŠ¨: æ¶ˆæ¯ ${messageId} åœ¨ ${now - lastPlay}ms å†…é‡å¤ç‚¹å‡»ï¼Œå¿½ç•¥`);
        return false;
      }
      this.lastPlayTime[messageId] = now;

      // æŸ¥æ‰¾æ¶ˆæ¯
      const message = this.messages.find(msg => msg.id === messageId);
      if (!message || !message.canPlayAudio || message.isLoading) {
        Logger.warn('ChatViewModel', `æ— æ³•æ’­æ”¾æ¶ˆæ¯è¯­éŸ³: æ¶ˆæ¯ä¸å­˜åœ¨æˆ–ä¸å¯æ’­æ”¾ (id: ${messageId})`);
        return false;
      }

      // è®°å½•åˆå§‹çŠ¶æ€
      const currentPlayingMsg = this.getCurrentPlayingMessage();
      const isAnyPlaying = this.isAnyMessagePlaying();
      const ttsState = this.ttsService.getState();
      
      Logger.info('ChatViewModel', `=== å¼€å§‹æ‰‹åŠ¨æ’­æ”¾æ¶ˆæ¯è¯­éŸ³: ${messageId} ===`);
      Logger.info('ChatViewModel', `åˆå§‹çŠ¶æ€ - å½“å‰æ’­æ”¾æ¶ˆæ¯: ${currentPlayingMsg?.id || 'æ— '}, ä»»æ„æ’­æ”¾: ${isAnyPlaying}, TTSçŠ¶æ€: ${ttsState}, éŸ³é¢‘é”: ${this.audioPlaybackLock}`);

      // æ£€æŸ¥éŸ³é¢‘æ’­æ”¾é”
      if (this.audioPlaybackLock) {
        Logger.warn('ChatViewModel', 'éŸ³é¢‘æ’­æ”¾é”å·²è¢«å ç”¨ï¼Œç­‰å¾…é‡Šæ”¾');
        // ç­‰å¾…é”é‡Šæ”¾
        await this.waitForAudioLock(3000);
      }
      
      // è·å–éŸ³é¢‘æ’­æ”¾é”
      this.audioPlaybackLock = true;
      Logger.info('ChatViewModel', `å·²è·å–éŸ³é¢‘æ’­æ”¾é”: ${messageId}`);
      
      try {
        // æ£€æŸ¥æ˜¯å¦ä¸ºAAåœºæ™¯ï¼ˆåŒä¸€ä¸ªæ¶ˆæ¯ï¼‰
        if (message.isPlaying) {
          Logger.info('ChatViewModel', `ğŸ”´ AAåœºæ™¯æ£€æµ‹ï¼šç‚¹å‡»æ­£åœ¨æ’­æ”¾çš„æ¶ˆæ¯ ${messageId}ï¼Œå½“å‰çŠ¶æ€: playing=${message.isPlaying}`);
          Logger.info('ChatViewModel', 'AAåœºæ™¯ï¼šåœæ­¢å½“å‰æ¶ˆæ¯æ’­æ”¾');
          message.isPlaying = false; // ç«‹å³æ›´æ–°çŠ¶æ€
          Logger.info('ChatViewModel', `AAåœºæ™¯ï¼šå·²è®¾ç½®æ¶ˆæ¯çŠ¶æ€ä¸º false`);
          await this.ttsService.stop();
          Logger.info('ChatViewModel', `AAåœºæ™¯ï¼šTTS.stop() è°ƒç”¨å®Œæˆ`);
          await this.delay(200);
          Logger.info('ChatViewModel', `AAåœºæ™¯ï¼šå»¶è¿Ÿå®Œæˆï¼ŒçŠ¶æ€æ£€æŸ¥ - playing=${message.isPlaying}, TTSçŠ¶æ€=${this.ttsService.getState()}`);
        } 
        // ABAåœºæ™¯ï¼šåœæ­¢å…¶ä»–æ¶ˆæ¯çš„æ’­æ”¾
        else if (this.isAnyMessagePlaying()) {
          // åœ¨ABAåœºæ™¯å‰å…ˆåŒæ­¥çŠ¶æ€
          await this.syncAudioStates();
          const otherPlayingMsg = this.getCurrentPlayingMessage();
          Logger.info('ChatViewModel', `ğŸ”µ ABAåœºæ™¯æ£€æµ‹ï¼šå½“å‰æ’­æ”¾æ¶ˆæ¯ ${otherPlayingMsg?.id}ï¼Œè¯·æ±‚æ’­æ”¾ ${messageId}`);
          Logger.info('ChatViewModel', 'ABAåœºæ™¯ï¼šåœæ­¢å…¶ä»–æ¶ˆæ¯æ’­æ”¾');
          Logger.info('ChatViewModel', `ABAåœºæ™¯ï¼šåœæ­¢å‰çŠ¶æ€ - ä»»æ„æ’­æ”¾: ${this.isAnyMessagePlaying()}, TTSçŠ¶æ€: ${this.ttsService.getState()}`);
          
          await this.forceStopAllAudio();
          Logger.info('ChatViewModel', `ABAåœºæ™¯ï¼šforceStopAllAudio() å®Œæˆ`);
          await this.delay(300);
          
          // ç¡®ä¿å®Œå…¨åœæ­¢
          const stillPlaying = this.isAnyMessagePlaying();
          const afterTtsState = this.ttsService.getState();
          Logger.info('ChatViewModel', `ABAåœºæ™¯ï¼šåœæ­¢åçŠ¶æ€ - ä»»æ„æ’­æ”¾: ${stillPlaying}, TTSçŠ¶æ€: ${afterTtsState}`);
          
          if (stillPlaying) {
            Logger.warn('ChatViewModel', 'å¼ºåˆ¶åœæ­¢åä»æœ‰éŸ³é¢‘åœ¨æ’­æ”¾ï¼Œæ‰§è¡Œé¢å¤–æ¸…ç†');
            await this.emergencyStop();
          }
        } else {
          Logger.info('ChatViewModel', `ğŸŸ¢ æ­£å¸¸åœºæ™¯ï¼šæ²¡æœ‰å…¶ä»–éŸ³é¢‘åœ¨æ’­æ”¾ï¼Œç›´æ¥æ’­æ”¾ ${messageId}`);
        }
      } catch (error) {
        // å‘ç”Ÿé”™è¯¯æ—¶é‡Šæ”¾é”
        this.audioPlaybackLock = false;
        
        const errorContext = new ErrorContext();
        errorContext.module = 'ChatViewModel';
        errorContext.function = 'playMessageAudio';
        errorContext.additionalInfo = JSON.stringify({
          messageId: messageId,
          errorType: 'AudioPlaybackFailed'
        });
        
        const errorManager = ErrorManager.getInstance();
        if (error instanceof Error) {
          errorManager.handleError(
            errorManager.createError(
              ErrorType.AUDIO,
              ErrorCode.AUDIO_PLAYBACK_FAILED,
              `æ’­æ”¾éŸ³é¢‘å¤±è´¥: ${error.message}`,
              errorContext,
              ErrorLevel.ERROR,
              error
            )
          );
        }
        
        throw new Error(`æ’­æ”¾éŸ³é¢‘å¤±è´¥: ${(error as Error).message}`);
      }

      // ç«‹å³è®¾ç½®å½“å‰æ¶ˆæ¯ä¸ºæ’­æ”¾çŠ¶æ€ï¼Œç¡®ä¿UIå³æ—¶å“åº”
      Logger.info('ChatViewModel', `è®¾ç½®æ¶ˆæ¯ ${messageId} æ’­æ”¾çŠ¶æ€ä¸º true`);
      message.isPlaying = true;
      
      // ä½¿ç”¨çŠ¶æ€ç®¡ç†å™¨ä¿å­˜æ’­æ”¾çŠ¶æ€
      this.audioPlaybackStateManager.savePlayingState(messageId, true);

      // åˆå§‹åŒ–TTSæœåŠ¡
      Logger.info('ChatViewModel', 'åˆå§‹åŒ–TTSæœåŠ¡...');
      const initialized = await this.ttsService.initialize();
      if (!initialized) {
        Logger.error('ChatViewModel', 'TTSæœåŠ¡åˆå§‹åŒ–å¤±è´¥');
        message.isPlaying = false;
        this.audioPlaybackStateManager.savePlayingState(messageId, false);
        return false;
      }
      Logger.info('ChatViewModel', 'TTSæœåŠ¡åˆå§‹åŒ–æˆåŠŸ');

      // åˆ›å»ºTTSå›è°ƒ
      Logger.info('ChatViewModel', `åˆ›å»ºTTSå›è°ƒï¼Œæ¶ˆæ¯: ${messageId}`);
      const callbacks: TTSCallbacks = {
        onStart: () => {
          Logger.info('ChatViewModel', `ğŸµ TTSæ’­æ”¾å¼€å§‹: ${messageId}ï¼Œå½“å‰çŠ¶æ€: playing=${message.isPlaying}`);
        },
        onComplete: () => {
          Logger.info('ChatViewModel', `âœ… TTSæ’­æ”¾å®Œæˆ: ${messageId}ï¼Œå½“å‰çŠ¶æ€: playing=${message.isPlaying}`);
          // æ’­æ”¾å®Œæˆæ—¶æ›´æ–°æ¶ˆæ¯çŠ¶æ€ - ä½¿ç”¨åŒé‡ç¡®ä¿æœºåˆ¶
          message.isPlaying = false;
          
          // ä½¿ç”¨çŠ¶æ€ç®¡ç†å™¨æ¸…ç†æ’­æ”¾çŠ¶æ€
          this.audioPlaybackStateManager.savePlayingState(messageId, false);
          
          // é¢å¤–å®‰å…¨æªæ–½ï¼šé€šè¿‡æ¶ˆæ¯IDå†æ¬¡æŸ¥æ‰¾å¹¶æ›´æ–°çŠ¶æ€
          const msgToUpdate = this.messages.find(msg => msg.id === messageId);
          if (msgToUpdate) {
            msgToUpdate.isPlaying = false;
            Logger.info('ChatViewModel', `âœ… é€šè¿‡IDæŸ¥æ‰¾æ›´æ–°æ¶ˆæ¯ ${messageId} çŠ¶æ€ä¸º false`);
          } else {
            Logger.warn('ChatViewModel', `âš ï¸ æ’­æ”¾å®Œæˆæ—¶æ‰¾ä¸åˆ°æ¶ˆæ¯ ${messageId}ï¼Œå¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ’­æ”¾çŠ¶æ€`);
            // æ‰¾ä¸åˆ°æ¶ˆæ¯æ—¶ï¼Œå¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ’­æ”¾çŠ¶æ€
            this.messages.forEach(msg => {
              if (msg.isPlaying) {
                msg.isPlaying = false;
                Logger.info('ChatViewModel', `âœ… å¼ºåˆ¶æ¸…ç†æ¶ˆæ¯ ${msg.id} çš„æ’­æ”¾çŠ¶æ€`);
              }
            });
          }
          
          Logger.info('ChatViewModel', `âœ… æ’­æ”¾å®ŒæˆçŠ¶æ€å·²æ›´æ–°: playing=${message.isPlaying}`);
        },
        onError: (error) => {
          Logger.error('ChatViewModel', `âŒ TTSæ’­æ”¾é”™è¯¯: ${messageId}, ${error.message}ï¼Œå½“å‰çŠ¶æ€: playing=${message.isPlaying}`);
          // æ’­æ”¾é”™è¯¯æ—¶æ›´æ–°æ¶ˆæ¯çŠ¶æ€ - ä½¿ç”¨åŒé‡ç¡®ä¿æœºåˆ¶
          message.isPlaying = false;
          
          // ä½¿ç”¨çŠ¶æ€ç®¡ç†å™¨æ¸…ç†æ’­æ”¾çŠ¶æ€
          this.audioPlaybackStateManager.savePlayingState(messageId, false);
          
          // é¢å¤–å®‰å…¨æªæ–½ï¼šé€šè¿‡æ¶ˆæ¯IDå†æ¬¡æŸ¥æ‰¾å¹¶æ›´æ–°çŠ¶æ€
          const msgToUpdate = this.messages.find(msg => msg.id === messageId);
          if (msgToUpdate) {
            msgToUpdate.isPlaying = false;
            Logger.info('ChatViewModel', `âŒ é€šè¿‡IDæŸ¥æ‰¾æ›´æ–°æ¶ˆæ¯ ${messageId} çŠ¶æ€ä¸º false`);
          } else {
            Logger.warn('ChatViewModel', `âš ï¸ æ’­æ”¾é”™è¯¯æ—¶æ‰¾ä¸åˆ°æ¶ˆæ¯ ${messageId}ï¼Œå¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ’­æ”¾çŠ¶æ€`);
            // æ‰¾ä¸åˆ°æ¶ˆæ¯æ—¶ï¼Œå¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ’­æ”¾çŠ¶æ€
            this.messages.forEach(msg => {
              if (msg.isPlaying) {
                msg.isPlaying = false;
                Logger.info('ChatViewModel', `âŒ å¼ºåˆ¶æ¸…ç†æ¶ˆæ¯ ${msg.id} çš„æ’­æ”¾çŠ¶æ€`);
              }
            });
          }
          
          Logger.info('ChatViewModel', `âŒ æ’­æ”¾é”™è¯¯çŠ¶æ€å·²æ›´æ–°: playing=${message.isPlaying}`);
        },
        onStop: () => {
          Logger.info('ChatViewModel', `â¹ï¸ TTSæ’­æ”¾åœæ­¢: ${messageId}ï¼Œå½“å‰çŠ¶æ€: playing=${message.isPlaying}`);
          // æ’­æ”¾åœæ­¢æ—¶æ›´æ–°æ¶ˆæ¯çŠ¶æ€ - ä½¿ç”¨åŒé‡ç¡®ä¿æœºåˆ¶
          message.isPlaying = false;
          
          // ä½¿ç”¨çŠ¶æ€ç®¡ç†å™¨æ¸…ç†æ’­æ”¾çŠ¶æ€
          this.audioPlaybackStateManager.savePlayingState(messageId, false);
          
          // é¢å¤–å®‰å…¨æªæ–½ï¼šé€šè¿‡æ¶ˆæ¯IDå†æ¬¡æŸ¥æ‰¾å¹¶æ›´æ–°çŠ¶æ€
          const msgToUpdate = this.messages.find(msg => msg.id === messageId);
          if (msgToUpdate) {
            msgToUpdate.isPlaying = false;
            Logger.info('ChatViewModel', `â¹ï¸ é€šè¿‡IDæŸ¥æ‰¾æ›´æ–°æ¶ˆæ¯ ${messageId} çŠ¶æ€ä¸º false`);
          } else {
            Logger.warn('ChatViewModel', `âš ï¸ æ’­æ”¾åœæ­¢æ—¶æ‰¾ä¸åˆ°æ¶ˆæ¯ ${messageId}ï¼Œå¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ’­æ”¾çŠ¶æ€`);
            // æ‰¾ä¸åˆ°æ¶ˆæ¯æ—¶ï¼Œå¼ºåˆ¶æ¸…ç†æ‰€æœ‰æ’­æ”¾çŠ¶æ€
            this.messages.forEach(msg => {
              if (msg.isPlaying) {
                msg.isPlaying = false;
                Logger.info('ChatViewModel', `â¹ï¸ å¼ºåˆ¶æ¸…ç†æ¶ˆæ¯ ${msg.id} çš„æ’­æ”¾çŠ¶æ€`);
              }
            });
          }
          
          Logger.info('ChatViewModel', `â¹ï¸ æ’­æ”¾åœæ­¢çŠ¶æ€å·²æ›´æ–°: playing=${message.isPlaying}`);
        }
      };

      // ç›´æ¥ä½¿ç”¨TTSServiceæ’­æ”¾ï¼Œç»•è¿‡AutoTTSServiceçš„é˜Ÿåˆ—ç³»ç»Ÿ
      Logger.info('ChatViewModel', `è°ƒç”¨TTSæœåŠ¡å¼€å§‹æ’­æ”¾: ${messageId}`);
      
      // ä¸ºé˜²æ­¢åä¸ºTTSé‡å¤å›è°ƒï¼Œæ·»åŠ å›è°ƒçŠ¶æ€è·Ÿè¸ª
      this.ttsCallbackStates.set(messageId, false);
      const originalCallbacks = callbacks;
      const protectedCallbacks: TTSCallbacks = {
        onStart: originalCallbacks.onStart,
        onComplete: () => {
          Logger.info('ChatViewModel', `ğŸµ TTSæ’­æ”¾å®Œæˆå›è°ƒ: ${messageId}ï¼Œå½“å‰çŠ¶æ€: playing=${message.isPlaying}`);
          
          // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡å®Œæˆå›è°ƒ
          const hasCompleted = this.ttsCallbackStates.get(messageId) || false;
          
          if (!hasCompleted && message.isPlaying) {
            // ç¬¬ä¸€æ¬¡å›è°ƒï¼šæ ‡è®°ä¸ºå·²å®Œæˆï¼Œä½†ä¸ç«‹å³å¤„ç†çŠ¶æ€
            this.ttsCallbackStates.set(messageId, true);
            Logger.info('ChatViewModel', `â³ TTSåˆæˆå®Œæˆï¼Œç­‰å¾…çœŸæ­£çš„æ’­æ”¾å®Œæˆ: ${messageId}`);
          } else if (hasCompleted || !message.isPlaying) {
            // ç¬¬äºŒæ¬¡å›è°ƒæˆ–æ¶ˆæ¯å·²ä¸åœ¨æ’­æ”¾çŠ¶æ€ï¼šçœŸæ­£å¤„ç†å®Œæˆ
            Logger.info('ChatViewModel', `âœ… TTSçœŸæ­£æ’­æ”¾å®Œæˆ: ${messageId}`);
            originalCallbacks.onComplete?.();
            // æ¸…ç†çŠ¶æ€
            this.ttsCallbackStates.delete(messageId);
          } else {
            Logger.warn('ChatViewModel', `âš ï¸ æ„å¤–çš„å›è°ƒçŠ¶æ€: messageId=${messageId}, hasCompleted=${hasCompleted}, isPlaying=${message.isPlaying}`);
          }
        },
        onError: (error) => {
          // é”™è¯¯æ—¶ç«‹å³å¤„ç†å¹¶æ¸…ç†çŠ¶æ€
          originalCallbacks.onError?.(error);
          this.ttsCallbackStates.delete(messageId);
        },
        onStop: () => {
          // åœæ­¢æ—¶ç«‹å³å¤„ç†å¹¶æ¸…ç†çŠ¶æ€
          originalCallbacks.onStop?.();
          this.ttsCallbackStates.delete(messageId);
        },
        onPause: originalCallbacks.onPause,
        onResume: originalCallbacks.onResume
      };
      
      const success = await this.ttsService.speak(message.content, protectedCallbacks);
      if (!success) {
        message.isPlaying = false;
        Logger.error('ChatViewModel', `âŒ å¯åŠ¨è¯­éŸ³æ’­æ”¾å¤±è´¥: ${messageId}`);
        return false;
      }

      Logger.info('ChatViewModel', `âœ… æ¶ˆæ¯è¯­éŸ³æ’­æ”¾å¯åŠ¨æˆåŠŸ: ${messageId}`);
      Logger.info('ChatViewModel', `=== TTSè°ƒç”¨å®Œæˆï¼Œç­‰å¾…å®é™…æ’­æ”¾å®Œæˆ - æ¶ˆæ¯çŠ¶æ€: ${message.isPlaying}, TTSçŠ¶æ€: ${this.ttsService.getState()} ===`);
      return true;

    } catch (error) {
      Logger.error('ChatViewModel', `æ’­æ”¾æ¶ˆæ¯è¯­éŸ³å¼‚å¸¸: ${(error as Error).message}`);
      // æ¢å¤æ¶ˆæ¯çŠ¶æ€
      const message = this.messages.find(msg => msg.id === messageId);
      if (message) {
        message.isPlaying = false;
      }
      return false;
    } finally {
      // é‡Šæ”¾éŸ³é¢‘æ’­æ”¾é”
      this.audioPlaybackLock = false;
      Logger.debug('ChatViewModel', 'éŸ³é¢‘æ’­æ”¾é”å·²é‡Šæ”¾');
    }
  }

  /**
   * åœæ­¢æŒ‡å®šæ¶ˆæ¯çš„è¯­éŸ³æ’­æ”¾
   */
  async stopMessageAudio(messageId: string): Promise<boolean> {
    try {
      const message = this.messages.find(msg => msg.id === messageId);
      if (!message) {
        Logger.warn('ChatViewModel', `è¦åœæ­¢çš„æ¶ˆæ¯ä¸å­˜åœ¨: ${messageId}`);
        return false;
      }

      if (!message.isPlaying) {
        Logger.info('ChatViewModel', `æ¶ˆæ¯æœªåœ¨æ’­æ”¾ï¼Œæ— éœ€åœæ­¢: ${messageId}`);
        return true;
      }

      // åœæ­¢TTSæ’­æ”¾
      const success = await this.ttsService.stop();
      
      // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
      message.isPlaying = false;
      this.audioPlaybackStateManager.savePlayingState(messageId, false);
      
      Logger.info('ChatViewModel', `æ¶ˆæ¯è¯­éŸ³æ’­æ”¾å·²åœæ­¢: ${messageId}`);
      return success;

    } catch (error) {
      Logger.error('ChatViewModel', `åœæ­¢æ¶ˆæ¯è¯­éŸ³æ’­æ”¾å¼‚å¸¸: ${(error as Error).message}`);
      return false;
    }
  }
  
  /**
   * åœæ­¢æ·±åº¦æ€è€ƒè¿‡ç¨‹
   */
  async stopDeepThinking(messageId: string): Promise<boolean> {
    try {
      // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰æ­£åœ¨æ€è€ƒçš„æ¶ˆæ¯
      if (this.currentThinkingMessageId !== messageId) {
        Logger.info('ChatViewModel', `æ¶ˆæ¯ ${messageId} ä¸æ˜¯å½“å‰æ­£åœ¨æ·±åº¦æ€è€ƒçš„æ¶ˆæ¯`);
        return false;
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æ·±åº¦æ€è€ƒæœåŠ¡åœ¨è¿è¡Œ
      if (!this.deepThinkingService.isRunning()) {
        Logger.info('ChatViewModel', 'å½“å‰æ²¡æœ‰æ·±åº¦æ€è€ƒè¿‡ç¨‹åœ¨è¿è¡Œ');
        return true;
      }
      
      Logger.info('ChatViewModel', `æ­£åœ¨å–æ¶ˆæ·±åº¦æ€è€ƒè¿‡ç¨‹: ${messageId}`);
      
      // å–æ¶ˆæ·±åº¦æ€è€ƒæœåŠ¡
      const cancelled = this.deepThinkingService.cancel();
      
      if (cancelled) {
        // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
        const message = this.messages.find(msg => msg.id === messageId);
        if (message) {
          message.thinkingStatus = ThinkingStatus.CANCELLED;
          message.isLoading = false;
        }
        
        // æ¸…é™¤å½“å‰æ€è€ƒæ¶ˆæ¯ID
        this.currentThinkingMessageId = '';
        
        Logger.info('ChatViewModel', `æ·±åº¦æ€è€ƒè¿‡ç¨‹å·²å–æ¶ˆ: ${messageId}`);
      } else {
        Logger.warn('ChatViewModel', 'å–æ¶ˆæ·±åº¦æ€è€ƒè¿‡ç¨‹å¤±è´¥');
      }
      
      return cancelled;
    } catch (error) {
      Logger.error('ChatViewModel', `å–æ¶ˆæ·±åº¦æ€è€ƒè¿‡ç¨‹å¼‚å¸¸: ${(error as Error).message}`);
      return false;
    }
  }

  /**
   * åœæ­¢æ‰€æœ‰æ¶ˆæ¯çš„è¯­éŸ³æ’­æ”¾
   */
  private async stopAllAudio(): Promise<void> {
    try {
      Logger.info('ChatViewModel', 'å¼€å§‹åœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾å¹¶æ¸…ç©ºé˜Ÿåˆ—');

      // é¦–å…ˆåœæ­¢TTSæœåŠ¡ï¼Œç¡®ä¿éŸ³é¢‘åœæ­¢
      await this.ttsService.stop();

      // åœæ­¢è‡ªåŠ¨æ’­æŠ¥æœåŠ¡å¹¶æ¸…ç©ºé˜Ÿåˆ—
      await this.autoTTSService.stopPlayback();
      this.autoTTSService.clearQueue();

      // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿æœåŠ¡åœæ­¢
      await this.delay(200);

      // é‡ç½®æ‰€æœ‰æ¶ˆæ¯çš„æ’­æ”¾çŠ¶æ€
      let resetCount = 0;
      this.messages.forEach(message => {
        if (message.isPlaying) {
          message.isPlaying = false;
          resetCount++;
        }
      });

      // å†æ¬¡æ£€æŸ¥å¹¶ç¡®ä¿TTSæœåŠ¡å®Œå…¨åœæ­¢
      if (this.ttsService.isPlaying()) {
        Logger.warn('ChatViewModel', 'TTSæœåŠ¡ä»åœ¨æ’­æ”¾çŠ¶æ€ï¼Œå°è¯•å†æ¬¡åœæ­¢');
        await this.ttsService.stop();
        await this.delay(100);
      }

      Logger.info('ChatViewModel', `å·²åœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾å¹¶æ¸…ç©ºæ’­æ”¾é˜Ÿåˆ—ï¼Œé‡ç½®äº† ${resetCount} ä¸ªæ¶ˆæ¯çŠ¶æ€`);
    } catch (error) {
      Logger.error('ChatViewModel', `åœæ­¢æ‰€æœ‰è¯­éŸ³æ’­æ”¾å¼‚å¸¸: ${(error as Error).message}`);
      // å³ä½¿å‡ºé”™ï¼Œä¹Ÿè¦ç¡®ä¿é‡ç½®æ‰€æœ‰æ’­æ”¾çŠ¶æ€
      this.messages.forEach(message => {
        if (message.isPlaying) {
          message.isPlaying = false;
        }
      });
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯æ­£åœ¨æ’­æ”¾è¯­éŸ³
   */
  isAnyMessagePlaying(): boolean {
    // åŒæ—¶æ£€æŸ¥æ¶ˆæ¯çŠ¶æ€å’ŒTTSæœåŠ¡çŠ¶æ€ï¼Œç¡®ä¿çŠ¶æ€åŒæ­¥
    const messagePlaying = this.messages.some(message => message.isPlaying);
    const ttsPlaying = this.ttsService.isPlaying();
    
    if (messagePlaying !== ttsPlaying) {
      Logger.warn('ChatViewModel', `çŠ¶æ€ä¸åŒæ­¥ï¼šæ¶ˆæ¯çŠ¶æ€=${messagePlaying}, TTSçŠ¶æ€=${ttsPlaying}`);
    }
    
    // ä¼˜å…ˆä½¿ç”¨æ¶ˆæ¯çŠ¶æ€ï¼Œä½†å¦‚æœæœ‰å†²çªï¼Œä»¥TTSçŠ¶æ€ä¸ºå‡†
    return ttsPlaying || messagePlaying;
  }

  /**
   * è·å–å½“å‰æ’­æ”¾è¯­éŸ³çš„æ¶ˆæ¯
   */
  getCurrentPlayingMessage(): Message | null {
    const playingMessage = this.messages.find(message => message.isPlaying);
    Logger.info('ChatViewModel', `getCurrentPlayingMessage: æ¶ˆæ¯æ€»æ•°=${this.messages.length}, æ‰¾åˆ°æ’­æ”¾æ¶ˆæ¯=${playingMessage?.id || 'æ— '}`);
    
    // è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰æ¶ˆæ¯çš„æ’­æ”¾çŠ¶æ€
    this.messages.forEach(msg => {
      Logger.info('ChatViewModel', `æ¶ˆæ¯ ${msg.id} æ’­æ”¾çŠ¶æ€: ${msg.isPlaying}`);
    });
    
    return playingMessage || null;
  }

  /**
   * è·å–è¯¦ç»†çš„éŸ³é¢‘æ’­æ”¾çŠ¶æ€ä¿¡æ¯
   */
  getAudioStateInfo(): AudioStateInfo {
    const messagePlaying = this.messages.some(message => message.isPlaying);
    const ttsPlaying = this.ttsService.isPlaying();
    const currentMessage = this.getCurrentPlayingMessage();
    
    return {
      messagePlaying,
      ttsPlaying,
      currentMessage: currentMessage?.id || null,
      audioLock: this.audioPlaybackLock
    };
  }

  /**
   * ç­‰å¾…éŸ³é¢‘åœæ­¢
   */
  private async waitForAudioStop(timeoutMs: number = 2000): Promise<void> {
    return new Promise((resolve) => {
      const startTime = Date.now();
      
      const checkInterval = setInterval(() => {
        if (!this.isAnyMessagePlaying()) {
          clearInterval(checkInterval);
          Logger.info('ChatViewModel', 'æ‰€æœ‰éŸ³é¢‘å·²åœæ­¢');
          resolve();
          return;
        }
        
        // æ£€æŸ¥è¶…æ—¶
        if (Date.now() - startTime > timeoutMs) {
          clearInterval(checkInterval);
          Logger.warn('ChatViewModel', `ç­‰å¾…éŸ³é¢‘åœæ­¢è¶…æ—¶ (${timeoutMs}ms)ï¼Œå¼ºåˆ¶ç»§ç»­`);
          resolve();
        }
      }, 100);
    });
  }

  /**
   * ç­‰å¾…éŸ³é¢‘æ’­æ”¾é”é‡Šæ”¾
   */
  private async waitForAudioLock(timeoutMs: number = 3000): Promise<void> {
    return new Promise((resolve) => {
      const startTime = Date.now();
      
      const checkInterval = setInterval(() => {
        if (!this.audioPlaybackLock) {
          clearInterval(checkInterval);
          Logger.info('ChatViewModel', 'éŸ³é¢‘æ’­æ”¾é”å·²é‡Šæ”¾');
          resolve();
          return;
        }
        
        // æ£€æŸ¥è¶…æ—¶
        if (Date.now() - startTime > timeoutMs) {
          clearInterval(checkInterval);
          Logger.warn('ChatViewModel', `ç­‰å¾…éŸ³é¢‘æ’­æ”¾é”è¶…æ—¶ (${timeoutMs}ms)ï¼Œå¼ºåˆ¶ç»§ç»­`);
          // å¼ºåˆ¶é‡Šæ”¾é”
          this.audioPlaybackLock = false;
          resolve();
        }
      }, 50);
    });
  }

  /**
   * å¼ºåˆ¶åœæ­¢æ‰€æœ‰éŸ³é¢‘
   */
  private async forceStopAllAudio(): Promise<void> {
    try {
      const beforeState = this.getAudioStateInfo();
      Logger.info('ChatViewModel', `ğŸ”„ å¼€å§‹å¼ºåˆ¶åœæ­¢æ‰€æœ‰éŸ³é¢‘ - å‰çŠ¶æ€: æ¶ˆæ¯=${beforeState.messagePlaying}, TTS=${beforeState.ttsPlaying}, å½“å‰æ¶ˆæ¯=${beforeState.currentMessage}, é”=${beforeState.audioLock}`);
      
      // ç«‹å³é‡ç½®æ‰€æœ‰æ¶ˆæ¯çŠ¶æ€ï¼ˆä¸ä¾èµ–TTSæœåŠ¡çŠ¶æ€ï¼‰
      let resetCount = 0;
      this.messages.forEach(msg => {
        if (msg.isPlaying) {
          Logger.info('ChatViewModel', `é‡ç½®æ¶ˆæ¯çŠ¶æ€: ${msg.id} (ä» ${msg.isPlaying} å˜ä¸º false)`);
          msg.isPlaying = false;
          
          // åŒæ—¶æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
          this.audioPlaybackStateManager.savePlayingState(msg.id, false);
          resetCount++;
        }
      });
      
      // å°è¯•åœæ­¢TTSæœåŠ¡ï¼ˆä½†ä¸ä¾èµ–å…¶ç»“æœï¼‰
      try {
        Logger.info('ChatViewModel', 'è°ƒç”¨TTS.stop()...');
        await this.ttsService.stop();
        Logger.info('ChatViewModel', 'TTS.stop() å®Œæˆ');
      } catch (error) {
        Logger.warn('ChatViewModel', `åœæ­¢TTSæœåŠ¡å¤±è´¥: ${(error as Error).message}`);
      }
      
      // åœæ­¢è‡ªåŠ¨æ’­æŠ¥æœåŠ¡
      try {
        await this.autoTTSService.stopPlayback();
        this.autoTTSService.clearQueue();
      } catch (error) {
        Logger.warn('ChatViewModel', `åœæ­¢è‡ªåŠ¨æ’­æŠ¥æœåŠ¡å¤±è´¥: ${(error as Error).message}`);
      }
      
      // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿çŠ¶æ€åŒæ­¥
      await this.delay(100);
      
      const afterState = this.getAudioStateInfo();
      Logger.info('ChatViewModel', `âœ… å¼ºåˆ¶åœæ­¢å®Œæˆ - é‡ç½®äº†${resetCount}ä¸ªæ¶ˆæ¯çŠ¶æ€`);
      Logger.info('ChatViewModel', `ğŸ”„ åçŠ¶æ€: æ¶ˆæ¯=${afterState.messagePlaying}, TTS=${afterState.ttsPlaying}, å½“å‰æ¶ˆæ¯=${afterState.currentMessage}, é”=${afterState.audioLock}`);
      
    } catch (error) {
      Logger.error('ChatViewModel', `âŒ å¼ºåˆ¶åœæ­¢å¤±è´¥: ${(error as Error).message}`);
      // å³ä½¿å¤±è´¥ä¹Ÿè¦é‡ç½®æ‰€æœ‰çŠ¶æ€
      this.messages.forEach(msg => {
        if (msg.isPlaying) {
          msg.isPlaying = false;
          this.audioPlaybackStateManager.savePlayingState(msg.id, false);
        }
      });
    }
  }

  /**
   * ç´§æ€¥åœæ­¢ï¼ˆæœ€åçš„ä¿éšœï¼‰
   */
  private async emergencyStop(): Promise<void> {
    try {
      const beforeState = this.getAudioStateInfo();
      Logger.warn('ChatViewModel', `ğŸš¨ æ‰§è¡Œç´§æ€¥åœæ­¢æ“ä½œ - å‰çŠ¶æ€: æ¶ˆæ¯=${beforeState.messagePlaying}, TTS=${beforeState.ttsPlaying}, å½“å‰æ¶ˆæ¯=${beforeState.currentMessage}`);
      
      // é‡ç½®æ‰€æœ‰æ¶ˆæ¯çŠ¶æ€ï¼ˆæœ€é‡è¦çš„ä¸€æ­¥ï¼‰
      let emergencyResetCount = 0;
      this.messages.forEach(msg => {
        if (msg.isPlaying) {
          Logger.warn('ChatViewModel', `ğŸš¨ ç´§æ€¥é‡ç½®æ¶ˆæ¯çŠ¶æ€: ${msg.id}`);
          msg.isPlaying = false;
          
          // åŒæ—¶æ›´æ–°çŠ¶æ€ç®¡ç†å™¨
          this.audioPlaybackStateManager.savePlayingState(msg.id, false);
          emergencyResetCount++;
        }
      });
      
      // æ¸…ç©ºè‡ªåŠ¨æ’­æŠ¥é˜Ÿåˆ—
      this.autoTTSService.clearQueue();
      
      // å°è¯•åœæ­¢TTSæœåŠ¡ï¼ˆå¤šæ¬¡å°è¯•ï¼‰
      for (let i = 0; i < 3; i++) {
        try {
          Logger.warn('ChatViewModel', `ğŸš¨ ç´§æ€¥åœæ­¢TTSå°è¯• ${i + 1}/3`);
          await this.ttsService.stop();
          Logger.warn('ChatViewModel', 'ğŸš¨ TTSç´§æ€¥åœæ­¢æˆåŠŸ');
          break; // å¦‚æœæˆåŠŸå°±é€€å‡ºå¾ªç¯
        } catch (error) {
          if (i === 2) {
            Logger.error('ChatViewModel', 'ğŸš¨ TTSæœåŠ¡ç´§æ€¥åœæ­¢å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰');
          }
          await this.delay(100);
        }
      }
      
      // ç­‰å¾…çŠ¶æ€åŒæ­¥
      await this.delay(150);
      
      const afterState = this.getAudioStateInfo();
      Logger.warn('ChatViewModel', `ğŸš¨ ç´§æ€¥åœæ­¢æ“ä½œå®Œæˆ - é‡ç½®äº†${emergencyResetCount}ä¸ªæ¶ˆæ¯`);
      Logger.warn('ChatViewModel', `ğŸš¨ ç´§æ€¥åœæ­¢åçŠ¶æ€: æ¶ˆæ¯=${afterState.messagePlaying}, TTS=${afterState.ttsPlaying}, å½“å‰æ¶ˆæ¯=${afterState.currentMessage}`);
      
    } catch (error) {
      Logger.error('ChatViewModel', `ğŸš¨ ç´§æ€¥åœæ­¢å¤±è´¥: ${(error as Error).message}`);
      // ç¡®ä¿çŠ¶æ€é‡ç½®
      this.messages.forEach(msg => {
        if (msg.isPlaying) {
          msg.isPlaying = false;
          this.audioPlaybackStateManager.savePlayingState(msg.id, false);
        }
      });
    }
  }

  /**
   * åŒæ­¥æ¶ˆæ¯çŠ¶æ€ä¸TTSçŠ¶æ€
   */
  private async syncAudioStates(): Promise<void> {
    try {
      const messagePlaying = this.messages.some(message => message.isPlaying);
      const ttsPlaying = this.ttsService.isPlaying();
      
      if (messagePlaying !== ttsPlaying) {
        Logger.warn('ChatViewModel', `ğŸ”„ æ£€æµ‹åˆ°çŠ¶æ€ä¸åŒæ­¥ï¼Œå¼€å§‹åŒæ­¥: æ¶ˆæ¯çŠ¶æ€=${messagePlaying}, TTSçŠ¶æ€=${ttsPlaying}`);
        
        if (ttsPlaying && !messagePlaying) {
          // TTSåœ¨æ’­æ”¾ä½†æ²¡æœ‰æ¶ˆæ¯æ ‡è®°ä¸ºæ’­æ”¾ï¼Œå¯èƒ½æ˜¯çŠ¶æ€ä¸¢å¤±
          Logger.warn('ChatViewModel', 'ğŸ”„ TTSåœ¨æ’­æ”¾ä½†æ¶ˆæ¯çŠ¶æ€ä¸¢å¤±ï¼Œå°è¯•æ¢å¤');
          // å¦‚æœæœ‰å½“å‰æ’­æ”¾çš„æ¶ˆæ¯ï¼Œæ¢å¤å…¶çŠ¶æ€
          const currentMsg = this.getCurrentPlayingMessage();
          if (currentMsg) {
            currentMsg.isPlaying = true;
            Logger.info('ChatViewModel', `ğŸ”„ å·²æ¢å¤æ¶ˆæ¯ ${currentMsg.id} çš„æ’­æ”¾çŠ¶æ€`);
          }
        } else if (!ttsPlaying && messagePlaying) {
          // æ¶ˆæ¯æ ‡è®°ä¸ºæ’­æ”¾ä½†TTSå·²åœæ­¢ï¼Œéœ€è¦æ¸…ç†
          Logger.warn('ChatViewModel', 'ğŸ”„ TTSå·²åœæ­¢ä½†æ¶ˆæ¯çŠ¶æ€æœªæ¸…ç†ï¼Œå¼€å§‹æ¸…ç†');
          this.messages.forEach(msg => {
            if (msg.isPlaying) {
              Logger.info('ChatViewModel', `ğŸ”„ æ¸…ç†æ¶ˆæ¯ ${msg.id} çš„æ’­æ”¾çŠ¶æ€`);
              msg.isPlaying = false;
            }
          });
        }
        
        await this.delay(50); // ç­‰å¾…çŠ¶æ€åŒæ­¥å®Œæˆ
        
        const afterSyncState = this.getAudioStateInfo();
        Logger.info('ChatViewModel', `ğŸ”„ çŠ¶æ€åŒæ­¥å®Œæˆ: æ¶ˆæ¯=${afterSyncState.messagePlaying}, TTS=${afterSyncState.ttsPlaying}`);
      }
    } catch (error) {
      Logger.error('ChatViewModel', `ğŸ”„ çŠ¶æ€åŒæ­¥å¤±è´¥: ${(error as Error).message}`);
    }
  }

  /**
   * åˆå§‹åŒ–è‡ªåŠ¨æ’­æŠ¥æœåŠ¡
   */
  private async initializeAutoTTS(): Promise<void> {
    try {
      Logger.info('ChatViewModel', 'åˆå§‹åŒ–è‡ªåŠ¨æ’­æŠ¥æœåŠ¡');
      const initialized = await this.autoTTSService.initialize();
      if (initialized) {
        // é¢å¤–è°ƒç”¨reloadSettingsç¡®ä¿çŠ¶æ€åŒæ­¥
        await this.autoTTSService.reloadSettings();
        const settings = this.autoTTSService.getSettings();
        Logger.info('ChatViewModel', `è‡ªåŠ¨æ’­æŠ¥æœåŠ¡åˆå§‹åŒ–æˆåŠŸï¼Œå½“å‰è®¾ç½®: muted=${settings.muted}, autoPlay=${settings.autoPlayOnReceive}`);
      } else {
        Logger.error('ChatViewModel', 'è‡ªåŠ¨æ’­æŠ¥æœåŠ¡åˆå§‹åŒ–å¤±è´¥');
      }
    } catch (error) {
      Logger.error('ChatViewModel', `åˆå§‹åŒ–è‡ªåŠ¨æ’­æŠ¥æœåŠ¡å¼‚å¸¸: ${(error as Error).message}`);
    }
  }

  /**
   * å¤„ç†è‡ªåŠ¨æ’­æŠ¥é€»è¾‘
   */
  private async handleAutoPlayback(message: Message): Promise<void> {
    try {
      if (!this.autoTTSService.isAutoPlayEnabled()) {
        Logger.debug('ChatViewModel', 'è‡ªåŠ¨æ’­æŠ¥å·²ç¦ç”¨ï¼Œè·³è¿‡æ’­æŠ¥');
        return;
      }

      Logger.info('ChatViewModel', `è§¦å‘è‡ªåŠ¨æ’­æŠ¥: ${message.id}`);
      await this.autoTTSService.addPlaybackTask(message.content, message.id, 1);
      
    } catch (error) {
      Logger.error('ChatViewModel', `è‡ªåŠ¨æ’­æŠ¥å¤„ç†å¤±è´¥: ${(error as Error).message}`);
    }
  }

  /**
   * æ‰‹åŠ¨æ’­æŠ¥æŒ‡å®šæ¶ˆæ¯
   */
  async playMessageViaAutoTTS(messageId: string): Promise<boolean> {
    try {
      // é˜²æŠ–åŠ¨æ£€æŸ¥ï¼šé˜²æ­¢å¿«é€Ÿé‡å¤ç‚¹å‡»åŒä¸€ä¸ªæ¶ˆæ¯
      const now = Date.now();
      const lastPlay = this.lastPlayTime[messageId];
      if (lastPlay && now - lastPlay < this.PLAY_DEBOUNCE_TIME) {
        Logger.warn('ChatViewModel', `é˜²æŠ–åŠ¨: AutoTTSæ¶ˆæ¯ ${messageId} åœ¨ ${now - lastPlay}ms å†…é‡å¤ç‚¹å‡»ï¼Œå¿½ç•¥`);
        return false;
      }
      this.lastPlayTime[messageId] = now;

      const message = this.messages.find(msg => msg.id === messageId);
      if (!message) {
        Logger.warn('ChatViewModel', `è¦æ’­æŠ¥çš„æ¶ˆæ¯ä¸å­˜åœ¨: ${messageId}`);
        return false;
      }

      if (message.role !== MessageRole.ASSISTANT) {
        Logger.warn('ChatViewModel', 'åªèƒ½æ’­æŠ¥åŠ©æ‰‹æ¶ˆæ¯');
        return false;
      }

      Logger.info('ChatViewModel', `æ‰‹åŠ¨æ’­æŠ¥æ¶ˆæ¯: ${messageId}`);
      
      // ä½¿ç”¨è‡ªåŠ¨æ’­æŠ¥æœåŠ¡è¿›è¡Œæ’­æŠ¥
      await this.autoTTSService.playMessage(message.content, message.id);
      
      // è®¾ç½®æ¶ˆæ¯æ’­æ”¾çŠ¶æ€
      message.isPlaying = true;
      
      return true;

    } catch (error) {
      Logger.error('ChatViewModel', `æ‰‹åŠ¨æ’­æŠ¥æ¶ˆæ¯å¤±è´¥: ${(error as Error).message}`);
      return false;
    }
  }

  /**
   * åœæ­¢è‡ªåŠ¨æ’­æŠ¥æœåŠ¡
   */
  async stopAutoPlayback(): Promise<void> {
    try {
      await this.autoTTSService.stopPlayback();
      
      // é‡ç½®æ‰€æœ‰æ¶ˆæ¯çš„æ’­æ”¾çŠ¶æ€
      this.messages.forEach(message => {
        if (message.isPlaying) {
          message.isPlaying = false;
        }
      });
      
      Logger.info('ChatViewModel', 'è‡ªåŠ¨æ’­æŠ¥å·²åœæ­¢');
    } catch (error) {
      Logger.error('ChatViewModel', `åœæ­¢è‡ªåŠ¨æ’­æŠ¥å¤±è´¥: ${(error as Error).message}`);
    }
  }

  /**
   * è·å–è‡ªåŠ¨æ’­æŠ¥æœåŠ¡çŠ¶æ€
   */
  getAutoTTSStatus(): AutoTTSStatus {
    const status: AutoTTSStatus = {
      isEnabled: this.autoTTSService.isAutoPlayEnabled(),
      isPlaying: this.autoTTSService.isPlaying(),
      queueLength: this.autoTTSService.getQueueLength()
    };
    return status;
  }

  //=================== ä¼šè¯ç®¡ç†ç›¸å…³æ–¹æ³• ===================

  /**
   * åˆ›å»ºæ–°ä¼šè¯ï¼ˆå…¼å®¹æ—§æ¥å£ï¼Œä¸ç»‘å®šç³»ç»Ÿæç¤ºè¯ï¼‰
   */
  async createNewSession(): Promise<Session | null> {
    return await this.createNewSessionWithPrompt(null);
  }

  /**
   * åˆ›å»ºæ–°ä¼šè¯ï¼ˆç»‘å®šç³»ç»Ÿæç¤ºè¯ï¼‰
   */
  async createNewSessionWithPrompt(selectedPrompt: SystemPrompt | null): Promise<Session | null> {
    try {
      Logger.info('ChatViewModel', `åˆ›å»ºæ–°ä¼šè¯ï¼Œç³»ç»Ÿæç¤ºè¯: ${selectedPrompt?.name || 'æ— '}`);
      
      // å…ˆä¿å­˜å½“å‰ä¼šè¯çš„æ¶ˆæ¯
      if (this.currentSession) {
        await this.saveMessages();
      }
      
      // åœæ­¢æ‰€æœ‰éŸ³é¢‘æ’­æ”¾
      await this.stopAllAudio();
      
      // åˆ›å»ºæ–°ä¼šè¯ï¼ˆä¼ å…¥ç³»ç»Ÿæç¤ºè¯IDï¼‰
      const newSession = await this.sessionManager.createNewSessionWithPrompt(selectedPrompt?.id || null);
      
      // æ›´æ–°å½“å‰ä¼šè¯
      this.currentSession = newSession;
      
      // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨ï¼ˆæ–°ä¼šè¯å¼€å§‹ï¼‰
      this.messages = [];
      
      // æ›´æ–°ä¼šè¯åˆ—è¡¨
      await this.loadSessions();
      
      Logger.info('ChatViewModel', `æ–°ä¼šè¯åˆ›å»ºæˆåŠŸ: ${newSession.id}, æç¤ºè¯: ${selectedPrompt?.name || 'æ— '}`);
      return newSession;
      
    } catch (error) {
      const errorContext = new ErrorContext();
      errorContext.module = 'ChatViewModel';
      errorContext.function = 'createNewSession';
      errorContext.additionalInfo = JSON.stringify({
        promptName: selectedPrompt?.name || 'none',
        errorType: 'SessionCreationFailed'
      });
      
      const errorManager = ErrorManager.getInstance();
      if (error instanceof Error) {
        errorManager.handleError(
          errorManager.createError(
            ErrorType.BUSINESS,
            ErrorCode.UNKNOWN_ERROR,
            `åˆ›å»ºæ–°ä¼šè¯å¤±è´¥: ${error}`,
            errorContext,
            ErrorLevel.ERROR,
            error
          )
        );
      }
      
      return null;
    }
  }

  /**
   * åˆ›å»ºå¤šäººä¼šè¯
   */
  async createNewMultiRoleSession(participantPrompts: SystemPrompt[]): Promise<Session | null> {
    return await this.createNewMultiRoleSessionWithRounds(participantPrompts, 3); // é»˜è®¤3è½®è®¨è®º
  }

  /**
   * åˆ›å»ºå¤šäººä¼šè¯ï¼ˆå¸¦è®¨è®ºè½®æ•°ï¼‰
   */
  async createNewMultiRoleSessionWithRounds(participantPrompts: SystemPrompt[], discussionRounds: number = 3): Promise<Session | null> {
    if (!participantPrompts || participantPrompts.length === 0) {
      Logger.warn('ChatViewModel', 'å¤šäººä¼šè¯åˆ›å»ºè¯·æ±‚ç¼ºå°‘å‚ä¸è€…');
      return null;
    }

    try {
      Logger.info('ChatViewModel', `åˆ›å»ºå¤šäººä¼šè¯ï¼Œå‚ä¸è€…æ•°é‡: ${participantPrompts.length}, è®¨è®ºè½®æ•°: ${discussionRounds}`);

      if (this.currentSession) {
        await this.saveMessages();
      }

      await this.stopAllAudio();

      const newSession = await this.sessionManager.createMultiRoleSession(participantPrompts, discussionRounds);

      this.currentSession = newSession;
      this.messages = [];
      await this.loadSessions();

      const participantNames = participantPrompts.map(participant => participant.name).join(', ');
      Logger.info('ChatViewModel', `å¤šäººä¼šè¯åˆ›å»ºæˆåŠŸ: ${newSession.id}, å‚ä¸è€…: ${participantNames}, è®¨è®ºè½®æ•°: ${discussionRounds}`);
      return newSession;

    } catch (error) {
      const errorContext = new ErrorContext();
      errorContext.module = 'ChatViewModel';
      errorContext.function = 'createNewMultiRoleSessionWithRounds';
      errorContext.additionalInfo = JSON.stringify({
        participantCount: participantPrompts.length,
        participantIds: participantPrompts.map(participant => participant.id),
        discussionRounds: discussionRounds
      });

      const errorManager = ErrorManager.getInstance();
      if (error instanceof Error) {
        errorManager.handleError(
          errorManager.createError(
            ErrorType.BUSINESS,
            ErrorCode.UNKNOWN_ERROR,
            `åˆ›å»ºå¤šäººä¼šè¯å¤±è´¥: ${error}`,
            errorContext,
            ErrorLevel.ERROR,
            error
          )
        );
      }

      return null;
    }
  }

  /**
   * æ›´æ¢å½“å‰ä¼šè¯çš„ç³»ç»Ÿæç¤ºè¯
   */
  async changeCurrentSessionPrompt(selectedPrompt: SystemPrompt | null): Promise<boolean> {
    try {
      if (!this.currentSession) {
        Logger.warn('ChatViewModel', 'æ²¡æœ‰å½“å‰ä¼šè¯ï¼Œæ— æ³•æ›´æ¢ç³»ç»Ÿæç¤ºè¯');
        return false;
      }
      
      Logger.info('ChatViewModel', `æ›´æ¢å½“å‰ä¼šè¯ç³»ç»Ÿæç¤ºè¯: ${selectedPrompt?.name || 'ç§»é™¤æç¤ºè¯'}`);
      
      // æ›´æ–°ä¼šè¯çš„systemPromptId
      this.currentSession.systemPromptId = selectedPrompt?.id || null;
      
      // ä¿å­˜ä¼šè¯æ›´æ–°
      await this.sessionManager.updateSessionPrompt(this.currentSession.id, selectedPrompt?.id || null);
      
      // æ›´æ–°ä¼šè¯åˆ—è¡¨
      await this.loadSessions();
      
      Logger.info('ChatViewModel', `å½“å‰ä¼šè¯ç³»ç»Ÿæç¤ºè¯æ›´æ¢æˆåŠŸ: ${this.currentSession.name}`);
      return true;
      
    } catch (error) {
      Logger.error('ChatViewModel', `æ›´æ¢ä¼šè¯ç³»ç»Ÿæç¤ºè¯å¤±è´¥: ${error}`);
      return false;
    }
  }

  /**
   * åˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯
   */
  async switchToSession(sessionId: string): Promise<boolean> {
    try {
      Logger.info('ChatViewModel', `åˆ‡æ¢åˆ°ä¼šè¯: ${sessionId}`);
      
      if (this.currentSession && this.currentSession.id === sessionId) {
        Logger.info('ChatViewModel', 'å·²ç»æ˜¯å½“å‰ä¼šè¯ï¼Œæ— éœ€åˆ‡æ¢');
        return true;
      }
      
      // ä¿å­˜å½“å‰ä¼šè¯çš„æ¶ˆæ¯
      if (this.currentSession) {
        await this.saveMessages();
      }
      
      // åœæ­¢æ‰€æœ‰éŸ³é¢‘æ’­æ”¾
      await this.stopAllAudio();
      
      // åˆ‡æ¢ä¼šè¯
      const targetSession = await this.sessionManager.switchToSession(sessionId);
      
      if (!targetSession) {
        Logger.error('ChatViewModel', `åˆ‡æ¢ä¼šè¯å¤±è´¥: ä¼šè¯ä¸å­˜åœ¨ ${sessionId}`);
        return false;
      }
      
      // æ›´æ–°å½“å‰ä¼šè¯
      this.currentSession = targetSession;
      
      // åŠ è½½æ–°ä¼šè¯çš„æ¶ˆæ¯
      await this.loadMessages();
      
      Logger.info('ChatViewModel', `ä¼šè¯åˆ‡æ¢æˆåŠŸ: ${targetSession.name}`);
      return true;
      
    } catch (error) {
      const errorContext = new ErrorContext();
      errorContext.module = 'ChatViewModel';
      errorContext.function = 'switchToSession';
      errorContext.additionalInfo = JSON.stringify({
        sessionId: sessionId,
        errorType: 'SessionSwitchFailed'
      });
      
      const errorManager = ErrorManager.getInstance();
      if (error instanceof Error) {
        errorManager.handleError(
          errorManager.createError(
            ErrorType.BUSINESS,
            ErrorCode.UNKNOWN_ERROR,
            `åˆ‡æ¢ä¼šè¯å¤±è´¥: ${error}`,
            errorContext,
            ErrorLevel.ERROR,
            error
          )
        );
      }
      
      return false;
    }
  }

  /**
   * æ›´æ–°å½“å‰ä¼šè¯ä¿¡æ¯ï¼ˆå¢é‡æ›´æ–°ï¼Œé¿å…é‡æ–°åŠ è½½æ•´ä¸ªä¼šè¯åˆ—è¡¨ï¼‰
   */
  private async updateCurrentSessionInfo(): Promise<void> {
    if (!this.currentSession) {
      return;
    }
    
    try {
      // ä»å­˜å‚¨ä¸­è·å–æœ€æ–°çš„ä¼šè¯ä¿¡æ¯
      const sessions = await this.sessionManager.getSessions();
      const updatedSession = sessions.find(s => s.id === this.currentSession!.id);
      
      if (updatedSession) {
        // æ›´æ–°å½“å‰ä¼šè¯çš„å¼•ç”¨ï¼Œä¿æŒä¼šè¯å¯¹è±¡ä¸å˜ï¼Œåªæ›´æ–°å±æ€§
        this.currentSession!.name = updatedSession.name;
        this.currentSession!.messageCount = updatedSession.messageCount;
        this.currentSession!.updatedAt = updatedSession.updatedAt;
        this.currentSession!.systemPromptId = updatedSession.systemPromptId;
        
        // åŒæ—¶æ›´æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„å¯¹åº”ä¼šè¯
        const sessionIndex = this.sessions.findIndex(s => s.id === this.currentSession!.id);
        if (sessionIndex !== -1) {
          this.sessions[sessionIndex].name = updatedSession.name;
          this.sessions[sessionIndex].messageCount = updatedSession.messageCount;
          this.sessions[sessionIndex].updatedAt = updatedSession.updatedAt;
          this.sessions[sessionIndex].systemPromptId = updatedSession.systemPromptId;
        }
        
        Logger.debug('ChatViewModel', `å½“å‰ä¼šè¯ä¿¡æ¯å·²æ›´æ–°: ${this.currentSession.name}`);
      }
    } catch (error) {
      Logger.error('ChatViewModel', `æ›´æ–°å½“å‰ä¼šè¯ä¿¡æ¯å¤±è´¥: ${error}`);
    }
  }

  /**
   * åˆ é™¤ä¼šè¯
   */
  async deleteSession(sessionId: string): Promise<boolean> {
    try {
      Logger.info('ChatViewModel', `åˆ é™¤ä¼šè¯: ${sessionId}`);
      
      // åœæ­¢æ‰€æœ‰éŸ³é¢‘æ’­æ”¾
      await this.stopAllAudio();
      
      // åˆ é™¤ä¼šè¯
      await this.sessionManager.deleteSession(sessionId);
      
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œéœ€è¦åˆ‡æ¢åˆ°å…¶ä»–ä¼šè¯
      if (this.currentSession && this.currentSession.id === sessionId) {
        // é‡æ–°åŠ è½½å½“å‰ä¼šè¯
        await this.loadCurrentSession();
        await this.loadMessages();
      }
      
      // æ›´æ–°ä¼šè¯åˆ—è¡¨
      await this.loadSessions();
      
      Logger.info('ChatViewModel', `ä¼šè¯åˆ é™¤æˆåŠŸ: ${sessionId}`);
      return true;
      
    } catch (error) {
      const errorContext = new ErrorContext();
      errorContext.module = 'ChatViewModel';
      errorContext.function = 'deleteSession';
      errorContext.additionalInfo = JSON.stringify({
        sessionId: sessionId,
        errorType: 'SessionDeletionFailed'
      });
      
      const errorManager = ErrorManager.getInstance();
      if (error instanceof Error) {
        errorManager.handleError(
          errorManager.createError(
            ErrorType.BUSINESS,
            ErrorCode.UNKNOWN_ERROR,
            `åˆ é™¤ä¼šè¯å¤±è´¥: ${error}`,
            errorContext,
            ErrorLevel.ERROR,
            error
          )
        );
      }
      
      return false;
    }
  }

  /**
   * é‡å‘½åä¼šè¯
   */
  async renameSession(sessionId: string, newName: string): Promise<boolean> {
    try {
      Logger.info('ChatViewModel', `é‡å‘½åä¼šè¯: ${sessionId} -> ${newName}`);
      
      await this.sessionManager.renameSession(sessionId, newName);
      
      // å¦‚æœæ˜¯å½“å‰ä¼šè¯ï¼Œæ›´æ–°å½“å‰ä¼šè¯ä¿¡æ¯
      if (this.currentSession && this.currentSession.id === sessionId) {
        this.currentSession.name = newName;
      }
      
      // æ›´æ–°ä¼šè¯åˆ—è¡¨
      await this.loadSessions();
      
      Logger.info('ChatViewModel', `ä¼šè¯é‡å‘½åæˆåŠŸ: ${sessionId}`);
      return true;
      
    } catch (error) {
      const errorContext = new ErrorContext();
      errorContext.module = 'ChatViewModel';
      errorContext.function = 'renameSession';
      errorContext.additionalInfo = JSON.stringify({
        sessionId: sessionId,
        newName: newName,
        errorType: 'SessionRenameFailed'
      });
      
      const errorManager = ErrorManager.getInstance();
      if (error instanceof Error) {
        errorManager.handleError(
          errorManager.createError(
            ErrorType.BUSINESS,
            ErrorCode.UNKNOWN_ERROR,
            `é‡å‘½åä¼šè¯å¤±è´¥: ${error}`,
            errorContext,
            ErrorLevel.ERROR,
            error
          )
        );
      }
      
      return false;
    }
  }

  /**
   * è·å–ä¼šè¯ç»Ÿè®¡ä¿¡æ¯
   */
  getSessionStats(): SessionStatsView {
    const stats: SessionStatsView = {
      totalSessions: this.sessions.length,
      maxSessions: 10, // ä»SessionManagerè·å–
      currentSessionName: this.currentSession?.name || null
    };
    return stats;
  }

  /**
   * å¤„ç†ä¼šè¯æ•°æ®æ¸…é™¤äº‹ä»¶
   */
  private onSessionDataCleared(): void {
    Logger.info('ChatViewModel', 'æ”¶åˆ°ä¼šè¯æ•°æ®æ¸…é™¤é€šçŸ¥ï¼Œå¼€å§‹é‡ç½®çŠ¶æ€');
    
    // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
    this.messages = [];
    
    // æ¸…ç©ºä¼šè¯åˆ—è¡¨
    this.sessions = [];
    
    // æ¸…é™¤å½“å‰ä¼šè¯
    this.currentSession = null;
    
    // æ¸…é™¤loadingçŠ¶æ€
    this.isLoading = false;
    
    Logger.info('ChatViewModel', 'ä¼šè¯æ•°æ®çŠ¶æ€å·²é‡ç½®');
  }

  /**
   * å¤„ç†æœåŠ¡å™¨é…ç½®å˜æ›´äº‹ä»¶
   */
  private async onServerConfigChanged(config: ServerEndpoint): Promise<void> {
    Logger.info('ChatViewModel', `æ”¶åˆ°æœåŠ¡å™¨é…ç½®å˜æ›´é€šçŸ¥: ${config.protocol}://${config.ip}:${config.port}`);
    
    try {
      // é‡æ–°åˆå§‹åŒ–APIç®¡ç†å™¨ä»¥åº”ç”¨æ–°çš„æœåŠ¡å™¨é…ç½®
      await this.apiManager.initialize();
      
      // é‡æ–°åŠ è½½providersä»¥è·å–æœ€æ–°çš„æ¨¡å‹åˆ—è¡¨
      await this.loadProviders();
      
      Logger.info('ChatViewModel', 'æœåŠ¡å™¨é…ç½®å˜æ›´å¤„ç†å®Œæˆï¼Œæ¨¡å‹åˆ—è¡¨å·²æ›´æ–°');
    } catch (error) {
      Logger.error('ChatViewModel', `å¤„ç†æœåŠ¡å™¨é…ç½®å˜æ›´å¤±è´¥: ${error}`);
    }
  }
  
  /**
   * å¤„ç†APIæ¨¡å¼å˜æ›´äº‹ä»¶
   */
  private async onAPIModeChanged(mode: APIMode): Promise<void> {
    Logger.info('ChatViewModel', `æ”¶åˆ°APIæ¨¡å¼å˜æ›´é€šçŸ¥: ${mode}`);
    
    try {
      // é‡æ–°åŠ è½½providersä»¥è·å–æ–°æ¨¡å¼ä¸‹çš„æ¨¡å‹åˆ—è¡¨
      await this.loadProviders();
      
      Logger.info('ChatViewModel', 'APIæ¨¡å¼å˜æ›´å¤„ç†å®Œæˆï¼Œæ¨¡å‹åˆ—è¡¨å·²æ›´æ–°');
    } catch (error) {
      Logger.error('ChatViewModel', `å¤„ç†APIæ¨¡å¼å˜æ›´å¤±è´¥: ${error}`);
    }
  }

  /**
   * é”€æ¯ViewModel
   */
  async destroy(): Promise<void> {
    try {
      // ä¿å­˜å½“å‰ä¼šè¯çš„æ¶ˆæ¯
      if (this.currentSession) {
        await this.saveMessages();
      }
      
      // åœæ­¢æ‰€æœ‰éŸ³é¢‘æ’­æ”¾
      await this.stopAllAudio();
      
      // é”€æ¯TTSæœåŠ¡
      await this.ttsService.destroy();
      
      // é”€æ¯è‡ªåŠ¨æ’­æŠ¥æœåŠ¡
      await this.autoTTSService.destroy();
      
      // é”€æ¯æ·±åº¦æ€è€ƒæœåŠ¡
      this.deepThinkingService.destroy();
      
      // æ¸…ç†éŸ³é¢‘æ’­æ”¾çŠ¶æ€
      this.audioPlaybackStateManager.clearAllStates();
      
      // é”€æ¯APIæœåŠ¡
      this.apiService.destroy();
      this.apiManager.destroy();
      
      // ç§»é™¤ä¼šè¯æ•°æ®æ¸…é™¤ç›‘å¬å™¨
      // æ³¨æ„ï¼šç”±äºä½¿ç”¨äº†ç®­å¤´å‡½æ•°ï¼Œè¿™é‡Œç§»é™¤ç›‘å¬å™¨éœ€è¦ä¿å­˜å¼•ç”¨
      // åœ¨å½“å‰å®ç°ä¸­ï¼Œç›‘å¬å™¨ä¼šåœ¨é¡µé¢é”€æ¯æ—¶è‡ªåŠ¨æ¸…ç†
      
      Logger.info('ChatViewModel', 'ViewModelå·²é”€æ¯');
    } catch (error) {
      Logger.error('ChatViewModel', `é”€æ¯ViewModelå¤±è´¥: ${(error as Error).message}`);
    }
  }

  //=================== è¾©è®ºç›¸å…³è¾…åŠ©æ–¹æ³• ===================

  /**
   * æ·»åŠ æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
   */
  private addMessage(message: Message): void {
    this.messages.push(message);
    Logger.debug('ChatViewModel', `æ·»åŠ æ¶ˆæ¯: ${message.senderName || 'System'} - ${message.content.substring(0, 50)}...`);
  }

  /**
   * ä»æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤æŒ‡å®šæ¶ˆæ¯
   */
  private removeMessage(message: Message): void {
    const index = this.messages.findIndex(m => m.id === message.id);
    if (index !== -1) {
      this.messages.splice(index, 1);
      Logger.debug('ChatViewModel', `ç§»é™¤æ¶ˆæ¯: ${message.senderName || 'System'} - ${message.content.substring(0, 50)}...`);
    }
  }

  /**
   * æ»šåŠ¨åˆ°æ¶ˆæ¯åˆ—è¡¨åº•éƒ¨
   */
  private async scrollToBottom(): Promise<void> {
    // ä½¿ç”¨å»¶è¿Ÿç¡®ä¿UIæ›´æ–°å®Œæˆåå†æ»šåŠ¨
    return new Promise<void>((resolve) => {
      setTimeout(() => {
        // ç”±äºè¿™æ˜¯ViewModelï¼Œå…·ä½“çš„æ»šåŠ¨éœ€è¦é€šè¿‡å›è°ƒæˆ–äº‹ä»¶é€šçŸ¥UIå±‚
        // è¿™é‡Œä½¿ç”¨ç®€å•çš„å»¶è¿Ÿæ¨¡æ‹Ÿï¼Œå®é™…ä½¿ç”¨ä¸­é¡µé¢ä¼šè‡ªåŠ¨æ£€æµ‹æ–°æ¶ˆæ¯å¹¶æ»šåŠ¨
        Logger.debug('ChatViewModel', 'è¯·æ±‚æ»šåŠ¨åˆ°åº•éƒ¨');
        resolve();
      }, 200); // å¢åŠ å»¶è¿Ÿç¡®ä¿UIå®Œå…¨æ›´æ–°
    });
  }
}

/**
 * éŸ³é¢‘æ’­æ”¾çŠ¶æ€ç®¡ç†å™¨
 * ä¸“é—¨è´Ÿè´£ç®¡ç†éŸ³é¢‘æ’­æ”¾çŠ¶æ€ï¼Œç¡®ä¿çŠ¶æ€åœ¨æ¶ˆæ¯é‡è½½ç­‰æ“ä½œä¸­å¾—åˆ°ä¿æŒ
 */
class AudioPlaybackStateManager {
  private playingStates: Map<string, boolean> = new Map<string, boolean>();
  private ttsState: TTSState = TTSState.IDLE;
  
  /**
   * ä¿å­˜æ¶ˆæ¯æ’­æ”¾çŠ¶æ€
   * @param messageId æ¶ˆæ¯ID
   * @param isPlaying æ˜¯å¦æ­£åœ¨æ’­æ”¾
   */
  savePlayingState(messageId: string, isPlaying: boolean): void {
    if (isPlaying) {
      this.playingStates.set(messageId, true);
      Logger.info('AudioPlaybackStateManager', `ä¿å­˜æ¶ˆæ¯æ’­æ”¾çŠ¶æ€: ${messageId} = ${isPlaying}`);
    } else {
      this.playingStates.delete(messageId);
      Logger.info('AudioPlaybackStateManager', `æ¸…é™¤æ¶ˆæ¯æ’­æ”¾çŠ¶æ€: ${messageId}`);
    }
  }
  
  /**
   * ä¿å­˜TTSå¼•æ“çŠ¶æ€
   * @param state TTSçŠ¶æ€
   */
  saveTTSState(state: TTSState): void {
    this.ttsState = state;
    Logger.info('AudioPlaybackStateManager', `ä¿å­˜TTSçŠ¶æ€: ${state}`);
  }
  
  /**
   * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æ­£åœ¨æ’­æ”¾
   * @param messageId æ¶ˆæ¯ID
   * @returns æ˜¯å¦æ­£åœ¨æ’­æ”¾
   */
  isMessagePlaying(messageId: string): boolean {
    return this.playingStates.has(messageId);
  }
  
  /**
   * è·å–å½“å‰TTSçŠ¶æ€
   * @returns TTSçŠ¶æ€
   */
  getTTSState(): TTSState {
    return this.ttsState;
  }
  
  /**
   * æ¸…é™¤æ‰€æœ‰æ’­æ”¾çŠ¶æ€
   */
  clearAllStates(): void {
    this.playingStates.clear();
    this.ttsState = TTSState.IDLE;
    Logger.info('AudioPlaybackStateManager', 'æ¸…é™¤æ‰€æœ‰æ’­æ”¾çŠ¶æ€');
  }
  
  /**
   * è·å–æ­£åœ¨æ’­æ”¾çš„æ¶ˆæ¯IDåˆ—è¡¨
   * @returns æ­£åœ¨æ’­æ”¾çš„æ¶ˆæ¯IDåˆ—è¡¨
   */
  getPlayingMessageIds(): string[] {
    return Array.from(this.playingStates.keys());
  }
  
  /**
   * æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ¶ˆæ¯æ­£åœ¨æ’­æ”¾
   * @returns æ˜¯å¦æœ‰ä»»ä½•æ¶ˆæ¯æ­£åœ¨æ’­æ”¾
   */
  hasAnyPlayingMessage(): boolean {
    return this.playingStates.size > 0;
  }
}
