/**
 * æ¶ˆæ¯å¢å¼ºå™¨
 * å°†æœç´¢ç»“æœæ•´åˆåˆ°ç”¨æˆ·æ¶ˆæ¯ä¸­
 */

import { Logger } from '../utils/Logger';
import { SearchResponse, SearchResult } from '../clients/SearchAPIClient';
import { SearchDecision, SearchCategory } from './SearchDecisionEngine';

/**
 * å¢å¼ºåçš„æ¶ˆæ¯ç»“æœ
 */
export interface EnhancedMessage {
  originalMessage: string;
  enhancedMessage: string;
  searchUsed: boolean;
  searchInfo?: SearchInfo;
}

/**
 * æœç´¢ä¿¡æ¯
 */
export interface SearchInfo {
  query: string;
  provider?: string;
  resultCount: number;
  searchTime?: number;
  category: SearchCategory;
  sources: SearchSource[];
}

/**
 * æœç´¢æ¥æº
 */
export interface SearchSource {
  title: string;
  url: string;
  snippet: string;
}

/**
 * æœç´¢ç»“æœéªŒè¯ç»“æœ
 */
export interface ValidationResult {
  isValid: boolean;
  validCount: number;
  issues: string[];
}

export class MessageEnhancer {
  private static instance: MessageEnhancer;

  private constructor() {}

  static getInstance(): MessageEnhancer {
    if (!MessageEnhancer.instance) {
      MessageEnhancer.instance = new MessageEnhancer();
    }
    return MessageEnhancer.instance;
  }

  /**
   * å¢å¼ºç”¨æˆ·æ¶ˆæ¯ï¼Œå°†æœç´¢ç»“æœæ•´åˆåˆ°æ¶ˆæ¯ä¸­
   */
  enhanceMessage(
    originalMessage: string,
    searchResponse: SearchResponse,
    searchDecision: SearchDecision
  ): EnhancedMessage {
    Logger.info('MessageEnhancer', `=== æ¶ˆæ¯å¢å¼ºå¼€å§‹ ===`);
    Logger.info('MessageEnhancer', `åŸå§‹æ¶ˆæ¯: "${originalMessage}"`);
    Logger.info('MessageEnhancer', `æœç´¢æˆåŠŸ: ${searchResponse.success}`);
    Logger.info('MessageEnhancer', `æœç´¢ç»“æœæ•°é‡: ${searchResponse.results.length}`);

    if (!searchResponse.success || searchResponse.results.length === 0) {
      // æœç´¢å¤±è´¥æˆ–æ— ç»“æœï¼Œè¿”å›åŸå§‹æ¶ˆæ¯
      const result: EnhancedMessage = {
        originalMessage,
        enhancedMessage: originalMessage,
        searchUsed: false
      };
      Logger.info('MessageEnhancer', `æœç´¢å¤±è´¥æˆ–æ— ç»“æœï¼Œè¿”å›åŸå§‹æ¶ˆæ¯`);
      return result;
    }

    // æ„å»ºæœç´¢ä¿¡æ¯
    const sources = searchResponse.results.slice(0, 5).map(result => {
      const source: SearchSource = {
        title: result.title,
        url: result.url,
        snippet: result.snippet
      };
      return source;
    });
    
    Logger.info('MessageEnhancer', `æœç´¢ç»“æœæ•°é‡: ${searchResponse.results.length}`);
    Logger.info('MessageEnhancer', `é€‰æ‹©çš„æ¥æºæ•°é‡: ${sources.length}`);
    if (sources.length > 0) {
      Logger.info('MessageEnhancer', `ç¬¬ä¸€ä¸ªæ¥æºæ ‡é¢˜: ${sources[0].title}`);
      Logger.info('MessageEnhancer', `ç¬¬ä¸€ä¸ªæ¥æºURL: ${sources[0].url}`);
      Logger.info('MessageEnhancer', `ç¬¬ä¸€ä¸ªæ¥æºæ‘˜è¦: ${sources[0].snippet.substring(0, 50)}...`);
    }
    
    const searchInfo: SearchInfo = {
      query: searchResponse.query,
      provider: searchResponse.provider,
      resultCount: searchResponse.results.length,
      searchTime: searchResponse.search_time,
      category: searchDecision.category,
      sources: sources
    };

    // ç”Ÿæˆå¢å¼ºæ¶ˆæ¯
    const enhancedMessage = this.generateEnhancedMessage(
      originalMessage,
      searchResponse.results,
      searchDecision
    );

    const result: EnhancedMessage = {
      originalMessage,
      enhancedMessage,
      searchUsed: true,
      searchInfo
    };

    Logger.info('MessageEnhancer', `=== æ¶ˆæ¯å¢å¼ºå®Œæˆ ===`);
    Logger.info('MessageEnhancer', `å¢å¼ºæ¶ˆæ¯é•¿åº¦: ${enhancedMessage.length}å­—ç¬¦`);
    Logger.info('MessageEnhancer', `æœç´¢æ¥æºæ•°é‡: ${searchInfo.sources.length}`);
    Logger.info('MessageEnhancer', `æœç´¢ç±»åˆ«: ${searchInfo.category}`);

    return result;
  }

  /**
   * ç”Ÿæˆå¢å¼ºæ¶ˆæ¯
   */
  private generateEnhancedMessage(
    originalMessage: string,
    searchResults: SearchResult[],
    searchDecision: SearchDecision
  ): string {
    Logger.info('MessageEnhancer', 'ç”Ÿæˆå¢å¼ºæ¶ˆæ¯');

    // é€‰æ‹©æœ€ç›¸å…³çš„æœç´¢ç»“æœï¼ˆå‰3-5ä¸ªï¼‰
    const relevantResults = this.selectRelevantResults(searchResults, searchDecision.category);
    
    // æ„å»ºæœç´¢ä¸Šä¸‹æ–‡
    const searchContext = this.buildSearchContext(relevantResults, searchDecision);
    
    // ç»„åˆåŸå§‹æ¶ˆæ¯å’Œæœç´¢ä¸Šä¸‹æ–‡
    const enhancedMessage = `${originalMessage}

[ç½‘ç»œæœç´¢ç»“æœ]
${searchContext}

è¯·åŸºäºä»¥ä¸Šç½‘ç»œæœç´¢ç»“æœå’Œä½ çš„çŸ¥è¯†æ¥å›ç­”æˆ‘çš„é—®é¢˜ã€‚å¦‚æœæœç´¢ç»“æœä¸é—®é¢˜ç›¸å…³ï¼Œè¯·é‡ç‚¹å‚è€ƒè¿™äº›æœ€æ–°ä¿¡æ¯ã€‚`;

    Logger.info('MessageEnhancer', `ç”Ÿæˆçš„å¢å¼ºæ¶ˆæ¯å­—ç¬¦æ•°: ${enhancedMessage.length}`);
    return enhancedMessage;
  }

  /**
   * é€‰æ‹©æœ€ç›¸å…³çš„æœç´¢ç»“æœ
   */
  private selectRelevantResults(searchResults: SearchResult[], category: SearchCategory): SearchResult[] {
    Logger.info('MessageEnhancer', `ä»${searchResults.length}ä¸ªç»“æœä¸­é€‰æ‹©ç›¸å…³ç»“æœ`);

    let maxResults = 3; // é»˜è®¤é€‰æ‹©3ä¸ªç»“æœ
    
    // æ ¹æ®æœç´¢ç±»åˆ«è°ƒæ•´é€‰æ‹©æ•°é‡
    switch (category) {
      case SearchCategory.REAL_TIME:
      case SearchCategory.NEWS:
        maxResults = 4; // å®æ—¶ä¿¡æ¯å’Œæ–°é—»éœ€è¦æ›´å¤šç»“æœ
        break;
      case SearchCategory.TECHNICAL:
        maxResults = 3; // æŠ€æœ¯æŸ¥è¯¢é€šå¸¸éœ€è¦ç²¾ç¡®ä¿¡æ¯
        break;
      case SearchCategory.CURRENT_AFFAIRS:
      case SearchCategory.FACTUAL:
        maxResults = 3;
        break;
      default:
        maxResults = 3;
    }

    // è¿‡æ»¤æ‰å†…å®¹è¿‡çŸ­çš„ç»“æœ
    const validResults = searchResults.filter(result => 
      result.title && result.title.length > 5 &&
      result.snippet && result.snippet.length > 20
    );

    // é€‰æ‹©å‰Nä¸ªç»“æœ
    const selectedResults = validResults.slice(0, maxResults);
    
    Logger.info('MessageEnhancer', `é€‰æ‹©äº†${selectedResults.length}ä¸ªç›¸å…³ç»“æœ`);
    return selectedResults;
  }

  /**
   * æ„å»ºæœç´¢ä¸Šä¸‹æ–‡ï¼ˆç”¨äºAIæ¨¡å‹ï¼‰
   */
  private buildSearchContext(searchResults: SearchResult[], searchDecision: SearchDecision): string {
    Logger.info('MessageEnhancer', 'æ„å»ºæœç´¢ä¸Šä¸‹æ–‡');

    if (searchResults.length === 0) {
      return 'æš‚æ— ç›¸å…³æœç´¢ç»“æœã€‚';
    }

    const contextParts: string[] = [];
    
    // æ·»åŠ æœç´¢æ‘˜è¦
    const summaryLine = `æœç´¢å…³é”®è¯: "${searchDecision.keywords.join(', ')}" | æœç´¢ç±»åˆ«: ${this.getCategoryDisplayName(searchDecision.category)} | ç»“æœæ•°é‡: ${searchResults.length}`;
    contextParts.push(summaryLine);
    contextParts.push('');

    // æ·»åŠ æ¯ä¸ªæœç´¢ç»“æœ
    searchResults.forEach((result, index) => {
      const resultNumber = index + 1;
      const title = this.cleanText(result.title);
      const snippet = this.cleanText(result.snippet);
      const url = result.url;

      const resultBlock = `${resultNumber}. ${title}
   æ‘˜è¦: ${snippet}
   æ¥æº: ${url}`;
      
      contextParts.push(resultBlock);
      
      // åœ¨ç»“æœä¹‹é—´æ·»åŠ åˆ†éš”çº¿
      if (index < searchResults.length - 1) {
        contextParts.push('');
      }
    });

    const context = contextParts.join('\n');
    Logger.info('MessageEnhancer', `æ„å»ºçš„æœç´¢ä¸Šä¸‹æ–‡å­—ç¬¦æ•°: ${context.length}`);
    
    return context;
  }

  /**
   * æ„å»ºç”¨æˆ·ç•Œé¢æœç´¢è¯¦æƒ…ï¼ˆç”¨äºæ°”æ³¡æ˜¾ç¤ºï¼‰
   */
  buildUserSearchDetails(searchInfo: SearchInfo): string {
    Logger.info('MessageEnhancer', 'æ„å»ºç”¨æˆ·ç•Œé¢æœç´¢è¯¦æƒ…');
    Logger.info('MessageEnhancer', `æœç´¢è¯¦æƒ…æ¥æºæ•°é‡: ${searchInfo.sources.length}`);

    const detailsParts: string[] = [];
    
    // æ·»åŠ æœç´¢åŸºæœ¬ä¿¡æ¯
    detailsParts.push('ğŸ” ç½‘ç»œæœç´¢è¯¦æƒ…');
    detailsParts.push('');
    
    // æœç´¢å¼•æ“å’ŒæŸ¥è¯¢
    detailsParts.push(`ğŸ“Š æœç´¢å¼•æ“: ${searchInfo.provider || 'é»˜è®¤'}`);
    detailsParts.push(`ğŸ” æœç´¢æŸ¥è¯¢: "${searchInfo.query}"`);
    detailsParts.push(`ğŸ“‚ æœç´¢ç±»åˆ«: ${this.getCategoryDisplayName(searchInfo.category)}`);
    detailsParts.push(`ğŸ“ˆ ç»“æœæ•°é‡: ${searchInfo.resultCount}`);
    
    if (searchInfo.searchTime) {
      detailsParts.push(`â±ï¸ æœç´¢è€—æ—¶: ${searchInfo.searchTime}ms`);
    }
    
    detailsParts.push('');
    detailsParts.push('ğŸ“‹ æœç´¢æ¥æº:');
    detailsParts.push('');

    // æ·»åŠ æœç´¢æ¥æº
    Logger.info('MessageEnhancer', `å¼€å§‹å¤„ç†æœç´¢æ¥æºï¼Œæ•°é‡: ${searchInfo.sources.length}`);
    searchInfo.sources.forEach((source, index) => {
      const sourceNumber = index + 1;
      const title = this.cleanText(source.title);
      const snippet = this.cleanText(source.snippet);
      const url = source.url;
      
      Logger.info('MessageEnhancer', `å¤„ç†æ¥æº${index + 1}: ${title.substring(0, 30)}..., URL: ${url.substring(0, 50)}...`);

      const sourceBlock = `${sourceNumber}. ${title}
   ğŸ“ ${snippet}
   ğŸ”— ${url}`;
      
      detailsParts.push(sourceBlock);
      
      // åœ¨æ¥æºä¹‹é—´æ·»åŠ åˆ†éš”çº¿
      if (index < searchInfo.sources.length - 1) {
        detailsParts.push('');
      }
    });

    const details = detailsParts.join('\n');
    Logger.info('MessageEnhancer', `æ„å»ºçš„æœç´¢è¯¦æƒ…å­—ç¬¦æ•°: ${details.length}`);
    
    return details;
  }

  /**
   * æ„å»ºç®€åŒ–æœç´¢ä¿¡æ¯ï¼ˆç”¨äºä¸»æ¶ˆæ¯æ˜¾ç¤ºï¼‰
   */
  buildSimpleSearchInfo(searchInfo: SearchInfo): string {
    const parts: string[] = [];
    parts.push('ğŸ” ç½‘ç»œæœç´¢');
    
    if (searchInfo.searchTime) {
      parts.push(`â±ï¸ ${searchInfo.searchTime}ms`);
    }
    
    parts.push(`ğŸ“Š ${searchInfo.resultCount}ä¸ªç»“æœ`);
    
    return parts.join(' | ');
  }

  /**
   * æ¸…ç†æ–‡æœ¬å†…å®¹
   */
  private cleanText(text: string): string {
    if (!text) return '';
    
    return text
      .replace(/\s+/g, ' ') // å¤šä¸ªç©ºç™½å­—ç¬¦æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼
      .replace(/\n/g, ' ') // æ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼
      .trim(); // å»é™¤é¦–å°¾ç©ºç™½
  }

  /**
   * è·å–æœç´¢ç±»åˆ«æ˜¾ç¤ºåç§°
   */
  private getCategoryDisplayName(category: SearchCategory): string {
    const displayNames: Record<SearchCategory, string> = {
      [SearchCategory.REAL_TIME]: 'å®æ—¶ä¿¡æ¯',
      [SearchCategory.TECHNICAL]: 'æŠ€æœ¯æŸ¥è¯¢',
      [SearchCategory.NEWS]: 'æ–°é—»äº‹ä»¶',
      [SearchCategory.CURRENT_AFFAIRS]: 'æ—¶äº‹ä¿¡æ¯',
      [SearchCategory.FACTUAL]: 'äº‹å®æŸ¥è¯¢',
      [SearchCategory.NONE]: 'æ— '
    };
    
    return displayNames[category] || 'æœªçŸ¥';
  }

  /**
   * åˆ›å»ºæœç´¢å¤±è´¥æ—¶çš„å¢å¼ºæ¶ˆæ¯
   */
  createFailureMessage(originalMessage: string, reason: string): EnhancedMessage {
    Logger.info('MessageEnhancer', `åˆ›å»ºæœç´¢å¤±è´¥æ¶ˆæ¯: ${reason}`);
    
    return {
      originalMessage,
      enhancedMessage: originalMessage, // æœç´¢å¤±è´¥æ—¶ä¿æŒåŸå§‹æ¶ˆæ¯
      searchUsed: false
    };
  }

  /**
   * éªŒè¯æœç´¢ç»“æœçš„è´¨é‡
   */
  validateSearchResults(searchResults: SearchResult[]): ValidationResult {
    const issues: string[] = [];
    let validCount = 0;

    if (!searchResults || searchResults.length === 0) {
      issues.push('æœç´¢ç»“æœä¸ºç©º');
      return { isValid: false, validCount: 0, issues };
    }

    for (let i = 0; i < searchResults.length; i++) {
      const result = searchResults[i];
      let isResultValid = true;

      if (!result.title || result.title.trim().length === 0) {
        issues.push(`ç»“æœ${i + 1}: æ ‡é¢˜ä¸ºç©º`);
        isResultValid = false;
      }

      if (!result.snippet || result.snippet.trim().length < 10) {
        issues.push(`ç»“æœ${i + 1}: æ‘˜è¦è¿‡çŸ­æˆ–ä¸ºç©º`);
        isResultValid = false;
      }

      if (!result.url || !this.isValidUrl(result.url)) {
        issues.push(`ç»“æœ${i + 1}: URLæ— æ•ˆ`);
        isResultValid = false;
      }

      if (isResultValid) {
        validCount++;
      }
    }

    const isValid = validCount > 0;
    Logger.info('MessageEnhancer', `æœç´¢ç»“æœéªŒè¯: ${isValid ? 'é€šè¿‡' : 'å¤±è´¥'}, æœ‰æ•ˆç»“æœ: ${validCount}/${searchResults.length}`);

    const result: ValidationResult = { isValid, validCount, issues };
    return result;
  }

  /**
   * éªŒè¯URLæ ¼å¼
   */
  private isValidUrl(url: string): boolean {
    try {
      // ç®€å•çš„URLæ ¼å¼éªŒè¯
      return url.startsWith('http://') || url.startsWith('https://');
    } catch {
      return false;
    }
  }
}