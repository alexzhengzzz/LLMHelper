/**
 * æ·±åº¦æ€è€ƒæœåŠ¡ - å®ç°å¤šè½®æ¨ç†å¼•æ“
 */

import { Message, MessageRole, ThinkingStep, ThinkingStatus, StepStatus, SimpleMessage } from '../models/ChatModels';
import { APIManager, APIMode } from './APIManager';
import { ChatRequest as APIChatRequest, ChatMessage as APIChatMessage } from '../types/APITypes';
import { Logger } from '../utils/Logger';
import { ContentCompressor } from './ContentCompressor';

// æ·±åº¦æ€è€ƒé…ç½®
interface DeepThinkingConfig {
  maxRetries: number;        // æœ€å¤§é‡è¯•æ¬¡æ•°
  timeoutMs: number;         // å•æ­¥è¶…æ—¶æ—¶é—´
  fallbackEnabled: boolean;  // æ˜¯å¦å¯ç”¨é™çº§
  temperature: number;       // æ¸©åº¦å‚æ•°
  maxTokens: number;         // æœ€å¤§tokenæ•°
}

// å®Œæˆæ­¥éª¤æ¥å£
// æ·±åº¦æ€è€ƒæ­¥éª¤å®šä¹‰
type StepCapability = 'web-search' | 'self-review';

interface StepDefinition {
  id: string;
  title: string;
  description: string;
  prompt: string;
  capability?: StepCapability[];
  optional?: boolean;
}

interface StepPlanContext {
  question: string;
  messages: SimpleMessage[];
  options: ResolvedDeepThinkingOptions;
}

export interface DeepThinkingOptions {
  enableWebSearch?: boolean;
  preferFastResponse?: boolean;
  maxSteps?: number;
}

interface ResolvedDeepThinkingOptions {
  enableWebSearch: boolean;
  preferFastResponse: boolean;
  maxSteps: number;
}

// æ·±åº¦æ€è€ƒç»“æœ
export interface DeepThinkingResult {
  success: boolean;
  finalAnswer: string;
  steps: ThinkingStep[];
  totalTime: number;
  fallbackUsed: boolean;
  error?: string;
}

// è¿›åº¦å›è°ƒ
export interface DeepThinkingCallbacks {
  onStepStart?: (step: ThinkingStep) => void;
  onStepComplete?: (step: ThinkingStep) => void;
  onStepError?: (step: ThinkingStep, error: string) => void;
  onProgress?: (currentStep: number, totalSteps: number) => void;
  onComplete?: (result: DeepThinkingResult) => void;
  onError?: (error: string) => void;
}

/**
 * æ·±åº¦æ€è€ƒæœåŠ¡
 */
export class DeepThinkingService {
  private static instance: DeepThinkingService;
  private apiManager: APIManager;
  private config: DeepThinkingConfig;
  private stepTemplates: Map<string, StepDefinition>;
  private contentCompressor: ContentCompressor;
  private isProcessing: boolean = false;
  private currentProcessId: string | null = null;
  private cancellationToken: boolean = false;

  private constructor() {
    this.apiManager = APIManager.getInstance();
    this.contentCompressor = ContentCompressor.getInstance();
    this.config = {
      maxRetries: 2,
      timeoutMs: 120000, // 120ç§’è¶…æ—¶
      fallbackEnabled: true,
      temperature: 0.9,
      maxTokens: 10000
    };
    
    // æ³¨å†Œæ¨ç†æ­¥éª¤æ¨¡æ¿ï¼Œåç»­æ ¹æ®é—®é¢˜æŒ‰éœ€é€‰æ‹©
    this.stepTemplates = new Map<string, StepDefinition>();
    this.stepTemplates.set('plan', {
      id: 'plan',
      title: 'ğŸ—ºï¸ æ€è·¯è§„åˆ’',
      description: 'æ ¹æ®é—®é¢˜ç¡®å®šæ¨ç†ç›®æ ‡ä¸å…³é”®åˆ‡å…¥ç‚¹',
      prompt: 'ä½ æ˜¯èµ„æ·±æ¨ç†è§„åˆ’å¸ˆã€‚\né—®é¢˜ï¼š{question}\nå¯¹è¯ä¸Šä¸‹æ–‡ï¼š\n{context}\n\nè¯·ç”¨ä¸è¶…è¿‡120å­—ç»™å‡ºæœ€é‡è¦çš„ 2-3 ä¸ªåˆ†ææ–¹å‘ï¼Œä½¿ç”¨ç¼–å·åˆ—è¡¨ã€‚æ¯ä¸ªæ–¹å‘æ³¨æ˜é¢„æœŸæˆæœã€‚',
      optional: true
    });
    this.stepTemplates.set('analyze', {
      id: 'analyze',
      title: 'ğŸ” æ·±åº¦åˆ†æ',
      description: 'æç‚¼é—®é¢˜æ ¸å¿ƒã€çº¦æŸæ¡ä»¶ä¸å½±å“å› ç´ ',
      prompt: 'ä½œä¸ºé«˜çº§åˆ†æå¸ˆï¼Œè¯·è¯¦ç»†æ‹†è§£ï¼š{question}\n\nä¸Šä¸‹æ–‡æ‘˜å½•ï¼š\n{context}\n\nè¯·è¾“å‡ºï¼š\n1. æ ¸å¿ƒç›®æ ‡ä¸æˆåŠŸåˆ¤æ®\n2. å…³é”®èƒŒæ™¯/çº¦æŸï¼ˆå¦‚æ—¶é—´ã€èµ„æºã€å¯¹è±¡ï¼‰\n3. éœ€è¦æ¾„æ¸…çš„éšå«å‡è®¾\nç®€æ˜æ¡ç†åŒ–è¡¨è¾¾ï¼Œä¿æŒ 150-250 å­—ã€‚'
    });
    this.stepTemplates.set('research', {
      id: 'research',
      title: 'ğŸŒ èµ„æ–™æ£€ç´¢',
      description: 'è¡¥å……æƒå¨æ•°æ®ä¸å¤–éƒ¨äº‹å®ï¼Œä¸ºåç»­æ¨ç†æä¾›è¯æ®',
      prompt: 'è¯·å›´ç»•ï¼š{question}\nç»“åˆå·²çŸ¥åˆ†æï¼š\n{analysis}\n\næ£€ç´¢å¹¶æ€»ç»“æœ€ç›¸å…³çš„ 2-3 æ¡å¤–éƒ¨äº‹å®æˆ–æ•°æ®ç‚¹ï¼Œè¯´æ˜æ¥æºç±»åˆ«ï¼ˆå®˜æ–¹/è¡Œä¸š/å­¦æœ¯ï¼‰åŠä¸é—®é¢˜çš„å…³è”ã€‚è‹¥ç¼ºä¹è¶³å¤Ÿå…¬å¼€èµ„æ–™ï¼Œè¯·ç»™å‡ºæœ€å€¼å¾—æŸ¥è¯çš„æ–¹å‘ã€‚è¾“å‡ºæ§åˆ¶åœ¨ 180 å­—ä»¥å†…ã€‚',
      capability: ['web-search'],
      optional: true
    });
    this.stepTemplates.set('think', {
      id: 'think',
      title: 'ğŸ§  å¤šè·¯å¾„æ¨æ¼”',
      description: 'ä»ä¸åŒè§’åº¦æå‡ºå¯è¡Œæ–¹æ¡ˆå¹¶æ¯”è¾ƒåˆ©å¼Š',
      prompt: 'åœ¨åˆ†æä¸èµ„æ–™åŸºç¡€ä¸Šï¼Œå¯¹ {question} å±•å¼€å¤šè·¯å¾„æ€è€ƒã€‚\nåˆ†ææ‘˜è¦ï¼š\n{analysis}\nè¡¥å……èµ„æ–™ï¼š\n{research}\n\nè¯·è¾“å‡ºè‡³å°‘ä¸¤ç§æ€è·¯ï¼Œæ¯ç§åŒ…å«ï¼šç­–ç•¥æ¦‚è¦ã€ä¼˜åŠ¿ã€æ½œåœ¨é£é™©æˆ–å‰æã€‚æ¡ç†æ¸…æ™°ï¼Œå»ºè®®ä½¿ç”¨è¡¨æ ¼æˆ–ç¼–å·ã€‚'
    });
    this.stepTemplates.set('verify', {
      id: 'verify',
      title: 'âœ… æ‰¹åˆ¤æ€§éªŒè¯',
      description: 'è¯†åˆ«æ¨ç†ä¸­çš„è–„å¼±ç¯èŠ‚ä¸åä¾‹',
      prompt: 'è¯·å……å½“è‹›åˆ»çš„è¯„å®¡è€…ï¼Œå¯¹å·²æå‡ºçš„æ–¹æ¡ˆå±•å¼€åæ€ã€‚\næ–¹æ¡ˆæ‘˜è¦ï¼š\n{think}\n\nè¯·åˆ—å‡ºï¼š\n1. ä¸»è¦æ¼æ´æˆ–åå¯¹è§‚ç‚¹\n2. å…³é”®ä¿¡æ¯ç¼ºå£\n3. éœ€è¦ç›‘æ§çš„é£é™©ä¿¡å·\næ¯ç‚¹è¯´æ˜ä¸¥é‡æ€§åŠç¼“è§£å»ºè®®ã€‚'
    });
    this.stepTemplates.set('integrate', {
      id: 'integrate',
      title: 'ğŸ¯ ç»¼åˆæ•´åˆ',
      description: 'æ•´åˆæ‰€æœ‰æˆæœå¹¶ç»™å‡ºè¡ŒåŠ¨åŒ–ç»“è®º',
      prompt: 'åŸºäºå‰åºæ¨ç†ï¼Œä¸º {question} è¾“å‡ºç»“æ„åŒ–ç»“è®ºã€‚å†…å®¹éœ€è¦†ç›–ï¼š\n- æ€»ç»“æ€§ç»“è®ºï¼ˆ<=80å­—ï¼‰\n- å…³é”®è®ºæ®ï¼ˆå¼•ç”¨åˆ†æ/èµ„æ–™çš„è¦ç‚¹ï¼‰\n- æ¨èè¡ŒåŠ¨æ­¥éª¤ï¼ˆæœ€å¤š3æ¡ï¼‰\n- é£é™©ä¸å¯¹åº”ç›‘æµ‹æŒ‡æ ‡\n\nå¯å‚è€ƒï¼š\nåˆ†æï¼š{analysis}\næ€è€ƒï¼š{think}\néªŒè¯ï¼š{verify}\nè¯·ä½¿ç”¨ Markdownï¼ŒåŒ…å«å°æ ‡é¢˜ã€‚'
    });
    this.stepTemplates.set('review', {
      id: 'review',
      title: 'ğŸ” è´¨é‡å¤ç›˜',
      description: 'å®¡è§†ç»¼åˆç­”æ¡ˆå¹¶æå‡ºæ”¹è¿›æ–¹å‘',
      prompt: 'ç«™åœ¨è¯»è€…è§†è§’å¤æŸ¥æœ€ç»ˆç­”æ¡ˆï¼š\nç»“è®ºæ‘˜è¦ï¼š\n{integrate}\n\nè¯·è¯„ä¼°ï¼š\n1. ç»“è®ºæ˜¯å¦ç›´æ¥å›åº”é—®é¢˜\n2. è®ºæ®æ˜¯å¦å……åˆ†ã€æœ‰æ— ç¼ºå£\n3. è¿˜éœ€è¡¥å……çš„åç»­å·¥ä½œ\nè¾“å‡ºä¸ºç®€æ´å»ºè®®åˆ—è¡¨ã€‚',
      capability: ['self-review'],
      optional: true
    });
  }

  public static getInstance(): DeepThinkingService {
    if (!DeepThinkingService.instance) {
      DeepThinkingService.instance = new DeepThinkingService();
    }
    return DeepThinkingService.instance;
  }

  /**
   * å¯åŠ¨æ·±åº¦æ€è€ƒè¿‡ç¨‹
   */
  async startDeepThinking(
    question: string,
    model: string,
    messages: SimpleMessage[],
    callbacks?: DeepThinkingCallbacks,
    options?: DeepThinkingOptions
  ): Promise<DeepThinkingResult> {
    if (this.isProcessing) {
      throw new Error('æ·±åº¦æ€è€ƒæœåŠ¡æ­£å¿™ï¼Œè¯·ç¨åå†è¯•');
    }

    this.isProcessing = true;
    this.cancellationToken = false;
    this.currentProcessId = this.generateProcessId();
    
    const startTime = Date.now();
    const steps: ThinkingStep[] = [];
    let fallbackUsed = false;
    const effectiveOptions = this.resolveOptions(options);
    const planContext: StepPlanContext = {
      question,
      messages,
      options: effectiveOptions
    };
    const plannedStepDefs = this.buildStepPlan(planContext);
    const totalSteps = plannedStepDefs.length;
    const conversationContext = this.buildConversationSynopsis(messages);
    
    try {
      Logger.info('DeepThinkingService', `å¼€å§‹æ·±åº¦æ€è€ƒè¿‡ç¨‹: ${this.currentProcessId}`);
      Logger.info('DeepThinkingService', `é—®é¢˜: ${question.substring(0, 100)}...`);
      Logger.info('DeepThinkingService', `æ‰§è¡Œæ­¥éª¤è§„åˆ’: ${plannedStepDefs.map(step => step.id).join(' -> ')}`);
      
      // åˆå§‹åŒ–æ‰€æœ‰æ­¥éª¤
      for (const stepDef of plannedStepDefs) {
        const step = new ThinkingStep(stepDef.id, stepDef.title, stepDef.description);
        steps.push(step);
      }
      
      // ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªæ­¥éª¤
      for (let i = 0; i < plannedStepDefs.length; i++) {
        if (this.cancellationToken) {
          Logger.info('DeepThinkingService', 'æ·±åº¦æ€è€ƒè¿‡ç¨‹è¢«å–æ¶ˆ');
          throw new Error('æ·±åº¦æ€è€ƒè¿‡ç¨‹è¢«ç”¨æˆ·å–æ¶ˆ');
        }
        
        const stepDef = plannedStepDefs[i];
        const step = steps[i];
        
        Logger.info('DeepThinkingService', `å¼€å§‹æ‰§è¡Œæ­¥éª¤ ${i + 1}/${totalSteps}: ${step.title}`);
        
        // è§¦å‘æ­¥éª¤å¼€å§‹å›è°ƒ
        callbacks?.onStepStart?.(step);
        callbacks?.onProgress?.(i + 1, totalSteps);
        
        try {
          step.start();
          
          // æ„å»ºæ­¥éª¤ç‰¹å®šçš„æç¤ºè¯
          const stepPrompt = this.buildStepPrompt(
            stepDef,
            question,
            conversationContext,
            steps,
            i,
            effectiveOptions
          );
          
          // æ‰§è¡ŒAPIè°ƒç”¨
          const stepResult = await this.executeStepWithRetry(
            stepPrompt,
            model,
            stepDef,
            effectiveOptions
          );
          
          step.complete(stepResult);
          Logger.info('DeepThinkingService', `æ­¥éª¤ ${i + 1} å®Œæˆ: ${step.title}`);
          
          // è§¦å‘æ­¥éª¤å®Œæˆå›è°ƒ
          callbacks?.onStepComplete?.(step);
          
        } catch (error) {
          const errorMessage = (error as Error).message;
          Logger.error('DeepThinkingService', `æ­¥éª¤ ${i + 1} æ‰§è¡Œå¤±è´¥: ${errorMessage}`);
          
          step.fail(errorMessage);
          callbacks?.onStepError?.(step, errorMessage);
          
          // æ ¹æ®é…ç½®å†³å®šæ˜¯å¦é™çº§
          if (stepDef.optional) {
            Logger.warn('DeepThinkingService', `å¯é€‰æ­¥éª¤ ${stepDef.id} å¤±è´¥ï¼Œç»§ç»­åç»­æµç¨‹`);
            fallbackUsed = true;
            continue;
          }

          if (this.config.fallbackEnabled && i >= 1) {
            Logger.warn('DeepThinkingService', 'å¯ç”¨é™çº§æ¨¡å¼ï¼Œä½¿ç”¨éƒ¨åˆ†ç»“æœ');
            fallbackUsed = true;
            break;
          } else {
            throw error as Error;
          }
        }
      }
      
      // ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
      const finalAnswer = this.generateFinalAnswer(steps, fallbackUsed);
      const totalTime = Date.now() - startTime;
      
      const result: DeepThinkingResult = {
        success: true,
        finalAnswer,
        steps,
        totalTime,
        fallbackUsed
      };
      
      Logger.info('DeepThinkingService', `æ·±åº¦æ€è€ƒå®Œæˆï¼Œæ€»è€—æ—¶: ${totalTime}msï¼Œé™çº§: ${fallbackUsed}`);
      callbacks?.onComplete?.(result);
      
      return result;
      
    } catch (error) {
      const errorMessage = (error as Error).message;
      Logger.error('DeepThinkingService', `æ·±åº¦æ€è€ƒå¤±è´¥: ${errorMessage}`);
      
      const totalTime = Date.now() - startTime;
      const result: DeepThinkingResult = {
        success: false,
        finalAnswer: '',
        steps,
        totalTime,
        fallbackUsed,
        error: errorMessage
      };
      
      callbacks?.onError?.(errorMessage);
      return result;
      
    } finally {
      this.isProcessing = false;
      this.currentProcessId = null;
      this.cancellationToken = false;
    }
  }

  /**
   * å–æ¶ˆå½“å‰çš„æ·±åº¦æ€è€ƒè¿‡ç¨‹
   */
  cancel(): boolean {
    if (!this.isProcessing) {
      return false;
    }
    
    Logger.info('DeepThinkingService', 'æ­£åœ¨å–æ¶ˆæ·±åº¦æ€è€ƒè¿‡ç¨‹');
    this.cancellationToken = true;
    return true;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦æ­£åœ¨å¤„ç†
   */
  isRunning(): boolean {
    return this.isProcessing;
  }

  /**
   * è·å–å½“å‰å¤„ç†ID
   */
  getCurrentProcessId(): string | null {
    return this.currentProcessId;
  }

  /**
   * è§£æå¹¶è¡¥å…¨æ‰§è¡Œé€‰é¡¹
   */
  private resolveOptions(options?: DeepThinkingOptions): ResolvedDeepThinkingOptions {
    const resolved: ResolvedDeepThinkingOptions = {
      enableWebSearch: options?.enableWebSearch === true,
      preferFastResponse: options?.preferFastResponse === true,
      maxSteps: options?.maxSteps !== undefined ? options.maxSteps : 6
    };

    if (resolved.maxSteps < 2) {
      resolved.maxSteps = 2;
    }
    if (resolved.maxSteps > 8) {
      resolved.maxSteps = 8;
    }

    return resolved;
  }

  /**
   * åŸºäºå½“å‰é—®é¢˜ç”ŸæˆåŠ¨æ€æ¨ç†è®¡åˆ’
   */
  private buildStepPlan(context: StepPlanContext): StepDefinition[] {
    const complexity = this.estimateComplexity(context.question, context.messages);
    Logger.info('DeepThinkingService', `æ¨ç†å¤æ‚åº¦ä¼°è®¡: ${complexity}`);

    const plan: StepDefinition[] = [];
    const addStep = (id: string): void => {
      const template = this.stepTemplates.get(id);
      if (template) {
        plan.push(template);
      }
    };

    const allowResearch = context.options.enableWebSearch && this.stepTemplates.has('research');

    if (context.options.preferFastResponse && complexity < 45) {
      if (complexity >= 28) {
        addStep('plan');
      }
      addStep('analyze');
      if (allowResearch && complexity >= 30) {
        addStep('research');
      }
      addStep('integrate');
      return this.trimPlan(plan, context.options.maxSteps);
    }

    if (complexity >= 55) {
      addStep('plan');
    }

    addStep('analyze');

    if (allowResearch && complexity >= 40) {
      addStep('research');
    }

    if (complexity >= 30) {
      addStep('think');
    }

    if (complexity >= 45 && !context.options.preferFastResponse) {
      addStep('verify');
    }

    addStep('integrate');

    if (complexity >= 65 && !context.options.preferFastResponse) {
      addStep('review');
    }

    return this.trimPlan(plan, context.options.maxSteps);
  }

  /**
   * é™åˆ¶æ¨ç†è®¡åˆ’æ­¥æ•°ï¼Œä¼˜å…ˆä¿ç•™æ ¸å¿ƒæ­¥éª¤
   */
  private trimPlan(plan: StepDefinition[], maxSteps: number): StepDefinition[] {
    if (plan.length <= maxSteps) {
      return plan;
    }

    const trimmed: StepDefinition[] = [...plan];

    for (let i = trimmed.length - 1; i >= 0 && trimmed.length > maxSteps; i--) {
      const step = trimmed[i];
      if (step.optional && step.id !== 'integrate') {
        trimmed.splice(i, 1);
      }
    }

    while (trimmed.length > maxSteps && trimmed.length > 2) {
      trimmed.splice(trimmed.length - 2, 1);
    }

    return trimmed.slice(0, Math.min(trimmed.length, maxSteps));
  }

  /**
   * æ ¹æ®é—®é¢˜å’Œå†å²æ¶ˆæ¯ä¼°ç®—å¤æ‚åº¦
   */
  private estimateComplexity(question: string, messages: SimpleMessage[]): number {
    let score = Math.min(question.length / 5, 40);

    const complexityKeywords: string[] = ['ä¸ºä»€ä¹ˆ', 'å¦‚ä½•', 'ç­–ç•¥', 'è§„åˆ’', 'ä¼˜åŒ–', 'é£é™©', '?', 'åˆ†æ', 'æ¶æ„'];
    for (const keyword of complexityKeywords) {
      if (question.includes(keyword)) {
        score += 6;
      }
    }

    if (messages.length > 6) {
      score += 8;
    }

    const avgMessageLength = messages.length > 0 ? messages.reduce((acc, msg) => acc + msg.content.length, 0) / messages.length : 0;
    if (avgMessageLength > 80) {
      score += 8;
    }

    if (score > 100) {
      return 100;
    }

    return Math.round(score);
  }

  /**
   * æ„å»ºç²¾ç®€çš„å¯¹è¯ä¸Šä¸‹æ–‡
   */
  private buildConversationSynopsis(messages: SimpleMessage[]): string {
    if (!messages || messages.length === 0) {
      return 'ï¼ˆæ— å†å²å¯¹è¯ï¼‰';
    }

    const recent = messages.slice(-6);
    const lines: string[] = recent.map((msg, index) => {
      const role = msg.role === 'user' ? 'ç”¨æˆ·' : (msg.role === 'assistant' ? 'åŠ©æ‰‹' : 'ç³»ç»Ÿ');
      return `${role}${index + 1}: ${this.truncateForSynopsis(msg.content)}`;
    });

    return lines.join('\n');
  }

  private truncateForSynopsis(content: string): string {
    const trimmed = content.replace(/\s+/g, ' ').trim();
    if (trimmed.length <= 80) {
      return trimmed;
    }
    return trimmed.substring(0, 77) + '...';
  }

  /**
   * è·å–å‰ç½®æ­¥éª¤çš„å‹ç¼©æ–‡æœ¬
   */
  private getCompressedStepText(steps: ThinkingStep[], stepId: string, stepType: string): string {
    const referenceStep = steps.find(step => step.id === stepId && step.status === StepStatus.COMPLETED && step.content);
    if (!referenceStep || !referenceStep.content) {
      return 'ï¼ˆæš‚æ— å†…å®¹ï¼‰';
    }

    try {
      const structured = this.contentCompressor.compressStepContent(referenceStep.content, stepType);
      const compressed = this.contentCompressor.buildCompressedPrompt(structured, stepType);
      return compressed || referenceStep.content.substring(0, Math.min(referenceStep.content.length, 180));
    } catch (error) {
      Logger.warn('DeepThinkingService', `å‹ç¼©æ­¥éª¤ ${stepId} å†…å®¹å¤±è´¥: ${(error as Error).message}`);
      const fallbackLength = Math.min(referenceStep.content.length, 180);
      return referenceStep.content.substring(0, fallbackLength);
    }
  }

  /**
   * å¸¦é‡è¯•çš„æ­¥éª¤æ‰§è¡Œ
   */
  private async executeStepWithRetry(
    prompt: string,
    model: string,
    stepDef: StepDefinition,
    options: ResolvedDeepThinkingOptions
  ): Promise<string> {
    const attempts = Math.max(1, this.config.maxRetries + 1);
    let lastError: Error | null = null;

    for (let attempt = 0; attempt < attempts; attempt++) {
      if (this.cancellationToken) {
        throw new Error('æ·±åº¦æ€è€ƒè¿‡ç¨‹è¢«ç”¨æˆ·å–æ¶ˆ');
      }

      try {
        const useWeb = Boolean(stepDef.capability?.includes('web-search') && options.enableWebSearch);
        return await this.executeStep(prompt, model, useWeb);
      } catch (error) {
        lastError = error as Error;
        Logger.warn('DeepThinkingService', `æ­¥éª¤ ${stepDef.id} ç¬¬ ${attempt + 1} æ¬¡å°è¯•å¤±è´¥: ${lastError.message}`);
        if (attempt < attempts - 1) {
          await this.delay(250 * (attempt + 1));
        }
      }
    }

    throw lastError ?? new Error('æ­¥éª¤æ‰§è¡Œå¤±è´¥');
  }

  private async delay(ms: number): Promise<void> {
    await new Promise<void>(resolve => setTimeout(resolve, ms));
  }

  /**
   * æ„å»ºæ­¥éª¤ç‰¹å®šçš„æç¤ºè¯ï¼ˆä¼˜åŒ–ç‰ˆ - ä½¿ç”¨å†…å®¹å‹ç¼©ï¼‰
   */
  private buildStepPrompt(
    stepDef: StepDefinition,
    question: string,
    conversationContext: string,
    steps: ThinkingStep[],
    currentIndex: number,
    options: ResolvedDeepThinkingOptions
  ): string {
    let prompt = stepDef.prompt;
    const shortQuestion = this.compressQuestion(question);
    prompt = prompt.replace(/{question}/g, shortQuestion);
    prompt = prompt.replace(/{context}/g, conversationContext || 'æ— è¡¥å……ä¸Šä¸‹æ–‡');

    const analysisSummary = this.getCompressedStepText(steps, 'analyze', 'analyze');
    const researchSummary = this.getCompressedStepText(steps, 'research', 'research');
    const thinkSummary = this.getCompressedStepText(steps, 'think', 'think');
    const verifySummary = this.getCompressedStepText(steps, 'verify', 'verify');
    const integrateSummary = this.getCompressedStepText(steps, 'integrate', 'integrate');
    const planSummary = this.getCompressedStepText(steps, 'plan', 'plan');

    prompt = prompt.replace(/{analysis}/g, analysisSummary);
    prompt = prompt.replace(/{research}/g, researchSummary);
    prompt = prompt.replace(/{think}/g, thinkSummary);
    prompt = prompt.replace(/{verify}/g, verifySummary);
    prompt = prompt.replace(/{integrate}/g, integrateSummary);
    prompt = prompt.replace(/{plan}/g, planSummary);

    if (stepDef.id === 'plan') {
      prompt += '\n\nè‹¥ç¼ºå°‘ä¸Šä¸‹æ–‡ï¼Œå¯æ ¹æ®é—®é¢˜å¸¸è§åˆ†ææ¡†æ¶è‡ªæ‹Ÿã€‚';
    }

    if (stepDef.id === 'think' && analysisSummary === 'ï¼ˆæš‚æ— å†…å®¹ï¼‰') {
      prompt += '\n\nè‹¥è¿˜æ²¡æœ‰æ­£å¼åˆ†æï¼Œè¯·å¿«é€Ÿæ€»ç»“é—®é¢˜æ ¸å¿ƒåç»™å‡ºæ€è·¯ã€‚';
    }

    if (options.preferFastResponse) {
      prompt += '\n\nè¯·åœ¨ä¿è¯é€»è¾‘çš„å‰æä¸‹å°½é‡ç²¾ç‚¼ï¼ˆâ‰ˆ150å­—ä»¥å†…ï¼‰ã€‚';
    }

    Logger.debug('DeepThinkingService', `æ„å»ºæ­¥éª¤${currentIndex + 1} (${stepDef.id}) æç¤ºè¯ï¼Œé•¿åº¦: ${prompt.length}`);
    return prompt;
  }

  /**
   * å‹ç¼©é—®é¢˜æè¿°
   */
  private compressQuestion(question: string): string {
    // å¦‚æœé—®é¢˜è¾ƒçŸ­ï¼Œç›´æ¥è¿”å›
    if (question.length <= 100) {
      return question;
    }
    
    // å¦‚æœé—®é¢˜è¾ƒé•¿ï¼Œæå–æ ¸å¿ƒéƒ¨åˆ†
    const sentences = question.split(/[ã€‚ï¼ï¼Ÿ]/).filter(s => s.trim().length > 0);
    if (sentences.length > 1) {
      // å–å‰ä¸¤å¥æˆ–å‰100å­—ç¬¦
      const firstTwoSentences = sentences.slice(0, 2).join('ã€‚');
      return firstTwoSentences.length <= 150 ? firstTwoSentences + 'ã€‚' : firstTwoSentences.substring(0, 100) + '...';
    }
    
    // å•å¥æƒ…å†µä¸‹æˆªæ–­
    return question.substring(0, 100) + '...';
  }

  /**
   * æ‰§è¡Œå•ä¸ªæ­¥éª¤
   */
  private async executeStep(prompt: string, model: string, useWebSearch: boolean): Promise<string> {
    const messages: APIChatMessage[] = [
      {
        role: 'user',
        content: prompt
      }
    ];

    const apiRequest: APIChatRequest = {
      model,
      messages,
      max_tokens: this.config.maxTokens,
      temperature: this.config.temperature,
      timeout: this.config.timeoutMs,
      enable_web: useWebSearch
    };

    Logger.debug('DeepThinkingService', `æ‰§è¡ŒAPIè°ƒç”¨ï¼Œæ¨¡å‹: ${model}`);
    if (useWebSearch) {
      Logger.info('DeepThinkingService', 'ä¸ºå½“å‰æ­¥éª¤å¯ç”¨è”ç½‘æ£€ç´¢');
    }
    
    const response = await this.apiManager.sendChatRequest(apiRequest);
    
    if (!response.choices || response.choices.length === 0) {
      throw new Error('APIè¿”å›ç©ºå“åº”');
    }

    const content = response.choices[0].message.content;
    if (!content || content.trim().length === 0) {
      throw new Error('APIè¿”å›ç©ºå†…å®¹');
    }

    return content.trim();
  }

  /**
   * ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
   */
  private generateFinalAnswer(steps: ThinkingStep[], fallbackUsed: boolean): string {
    const completedSteps = steps.filter(step => step.status === StepStatus.COMPLETED && step.content);

    if (completedSteps.length === 0) {
      return 'æ·±åº¦æ€è€ƒè¿‡ç¨‹æœªèƒ½å®Œæˆï¼Œæ— æ³•æä¾›ç­”æ¡ˆã€‚';
    }

    const integrateStep = completedSteps.find(step => step.id === 'integrate');
    let finalAnswer = integrateStep && integrateStep.content ? integrateStep.content : '';

    if (!finalAnswer) {
      finalAnswer = 'åŸºäºå·²å®Œæˆçš„åˆ†ææ­¥éª¤ï¼Œä»¥ä¸‹æ˜¯ç»¼åˆæ€§å›ç­”ï¼š\n\n';
      for (const step of completedSteps) {
        finalAnswer += `## ${step.title}\n${step.content}\n\n`;
      }
    }

    const reviewStep = completedSteps.find(step => step.id === 'review');
    if (reviewStep && reviewStep.content) {
      finalAnswer += '\n---\n### è´¨é‡å¤ç›˜\n' + reviewStep.content;
    }

    if (fallbackUsed) {
      finalAnswer += '\n> **æ³¨æ„**: éƒ¨åˆ†æ­¥éª¤æœªèƒ½é¡ºåˆ©å®Œæˆï¼Œæœ¬å›ç­”åŸºäºå·²å®Œæˆå†…å®¹ç”Ÿæˆã€‚';
    }

    return finalAnswer;
  }

  /**
   * ç”Ÿæˆå¤„ç†ID
   */
  private generateProcessId(): string {
    return 'thinking_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
  }

  /**
   * æ›´æ–°é…ç½®
   */
  updateConfig(newConfig: Partial<DeepThinkingConfig>): void {
    this.config.maxRetries = newConfig.maxRetries ?? this.config.maxRetries;
    this.config.timeoutMs = newConfig.timeoutMs ?? this.config.timeoutMs;
    this.config.fallbackEnabled = newConfig.fallbackEnabled ?? this.config.fallbackEnabled;
    this.config.temperature = newConfig.temperature ?? this.config.temperature;
    this.config.maxTokens = newConfig.maxTokens ?? this.config.maxTokens;
    Logger.info('DeepThinkingService', 'é…ç½®å·²æ›´æ–°');
  }

  /**
   * è·å–é…ç½®
   */
  getConfig(): DeepThinkingConfig {
    return {
      maxRetries: this.config.maxRetries,
      timeoutMs: this.config.timeoutMs,
      fallbackEnabled: this.config.fallbackEnabled,
      temperature: this.config.temperature,
      maxTokens: this.config.maxTokens
    };
  }

  /**
   * é”€æ¯æœåŠ¡
   */
  destroy(): void {
    this.cancel();
    Logger.info('DeepThinkingService', 'æœåŠ¡å·²é”€æ¯');
  }
}
