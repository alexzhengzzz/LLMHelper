import { SystemPrompt } from '../models/ChatModels';
import { Logger } from '../utils/Logger';
import { resourceManager } from '@kit.LocalizationKit';
import { util } from '@kit.ArkTS';

/**
 * JSONé…ç½®æ ¼å¼æ¥å£
 */
interface PromptConfig {
  id: string;
  name: string;
  content: string;
  shortDescription: string;
  category: string;
  icon: string;
  isRole: boolean;
  tags: string[];
}

interface PromptCategory {
  id: string;
  name: string;
  description: string;
  icon: string;
}

interface PromptMetadata {
  totalPrompts: number;
  professionalCount: number;
  characterCount: number;
  formatVersion: string;
  compatibilityLevel: string;
}

interface PromptsCollection {
  professional: PromptConfig[];
  character: PromptConfig[];
}

interface PromptsConfigData {
  version: string;
  lastUpdated: string;
  prompts: PromptsCollection;
  categories: PromptCategory[];
  metadata: PromptMetadata;
}

/**
 * é»˜è®¤ç³»ç»Ÿæç¤ºè¯æ•°æ®
 * æ”¯æŒä»JSONæ–‡ä»¶åŠ è½½é…ç½®ï¼Œä¾¿äºç®¡ç†å’Œä¿®æ”¹
 */
export class DefaultPrompts {
  private static cachedPrompts: SystemPrompt[] | null = null;

  /**
   * è·å–æ‰€æœ‰é»˜è®¤ç³»ç»Ÿæç¤ºè¯
   */
  static async getAllPrompts(): Promise<SystemPrompt[]> {
    if (DefaultPrompts.cachedPrompts) {
      return DefaultPrompts.cachedPrompts;
    }

    try {
      const prompts = await DefaultPrompts.loadPromptsFromJSON();
      DefaultPrompts.cachedPrompts = prompts;
      return prompts;
    } catch (error) {
      Logger.error('DefaultPrompts', `ä»JSONåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨åº”æ€¥åå¤‡æç¤ºè¯: ${error}`);
      // å¦‚æœJSONåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ€å°çš„åº”æ€¥æç¤ºè¯é›†åˆ
      const fallbackPrompts = DefaultPrompts.getEmergencyFallbackPrompts();
      DefaultPrompts.cachedPrompts = fallbackPrompts;
      return fallbackPrompts;
    }
  }

  /**
   * åŒæ­¥è·å–æ‰€æœ‰é»˜è®¤ç³»ç»Ÿæç¤ºè¯ï¼ˆå‘åå…¼å®¹ï¼‰
   */
  static getAllPromptsSync(): SystemPrompt[] {
    if (DefaultPrompts.cachedPrompts) {
      return DefaultPrompts.cachedPrompts;
    }
    // å¦‚æœç¼“å­˜ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„å¹¶è®°å½•è­¦å‘Š
    Logger.warn('DefaultPrompts', 'æç¤ºè¯å°šæœªåŠ è½½ï¼Œè¿”å›ç©ºæ•°ç»„ã€‚è¯·å…ˆè°ƒç”¨ getAllPrompts() è¿›è¡Œå¼‚æ­¥åŠ è½½ã€‚');
    return [];
  }

  /**
   * ä»JSONæ–‡ä»¶åŠ è½½æç¤ºè¯é…ç½®
   */
  private static async loadPromptsFromJSON(): Promise<SystemPrompt[]> {
    try {
      Logger.info('DefaultPrompts', 'å¼€å§‹ä»JSONæ–‡ä»¶åŠ è½½æç¤ºè¯é…ç½®');

      // è·å–èµ„æºç®¡ç†å™¨
      const context = getContext();
      const mgr = context.resourceManager;

      // è¯»å–JSONæ–‡ä»¶
      const rawFileData = await mgr.getRawFileContent('prompts_config.json');

      // ä½¿ç”¨util.TextDecoderæ­£ç¡®å¤„ç†UTF-8ç¼–ç 
      const textDecoder = new util.TextDecoder('utf-8', { ignoreBOM: true });
      const jsonString = textDecoder.decodeToString(rawFileData);

      Logger.debug('DefaultPrompts', `JSONå­—ç¬¦ä¸²é•¿åº¦: ${jsonString.length}`);
      Logger.debug('DefaultPrompts', `JSONå­—ç¬¦ä¸²å‰100å­—ç¬¦: ${jsonString.substring(0, 100)}`);

      let configData: PromptsConfigData;
      try {
        configData = JSON.parse(jsonString) as PromptsConfigData;
      } catch (parseError) {
        const error = parseError as Error;
        Logger.error('DefaultPrompts', `JSONè§£æå¤±è´¥: ${error}`);
        Logger.error('DefaultPrompts', `é”™è¯¯ä½ç½®: ${error.message}`);
        // å°è¯•æ‰¾å‡ºå…·ä½“çš„é”™è¯¯ä½ç½®
        try {
          const errorIndex = error.message.match(/position (\d+)/);
          if (errorIndex) {
            const index = parseInt(errorIndex[1]);
            const context = jsonString.substring(Math.max(0, index - 50), Math.min(jsonString.length, index + 50));
            Logger.error('DefaultPrompts', `é”™è¯¯ä½ç½®ä¸Šä¸‹æ–‡: ...${context}...`);
          }
        } catch (e) {
          const innerError = e as Error;
          Logger.error('DefaultPrompts', `æ— æ³•è·å–é”™è¯¯ä½ç½®ä¿¡æ¯: ${innerError}`);
        }
        throw new Error(error.message);
      }

      Logger.info('DefaultPrompts', `æˆåŠŸè§£æJSONé…ç½®ï¼Œç‰ˆæœ¬: ${configData.version}`);
      Logger.info('DefaultPrompts', `æ€»è®¡ ${configData.metadata.totalPrompts} ä¸ªæç¤ºè¯`);

      const allPrompts: SystemPrompt[] = [];

      // è½¬æ¢ä¸“ä¸šç±»æç¤ºè¯
      for (const promptConfig of configData.prompts.professional) {
        const prompt = new SystemPrompt(
          promptConfig.name,
          promptConfig.content,
          '', // keywords å­—æ®µ
          promptConfig.isRole,
          promptConfig.category,
          promptConfig.icon,
          promptConfig.shortDescription,
          true // isDefault
        );
        allPrompts.push(prompt);
      }

      // è½¬æ¢äººç‰©è§’è‰²æç¤ºè¯
      for (const promptConfig of configData.prompts.character) {
        const prompt = new SystemPrompt(
          promptConfig.name,
          promptConfig.content,
          '', // keywords å­—æ®µ
          promptConfig.isRole,
          promptConfig.category,
          promptConfig.icon,
          promptConfig.shortDescription,
          true // isDefault
        );
        allPrompts.push(prompt);
      }

      Logger.info('DefaultPrompts', `æˆåŠŸä»JSONåŠ è½½ ${allPrompts.length} ä¸ªæç¤ºè¯`);
      return allPrompts;

    } catch (error) {
      Logger.error('DefaultPrompts', `ä»JSONåŠ è½½æç¤ºè¯å¤±è´¥: ${error}`);
      throw new Error(String(error));
    }
  }

  /**
   * æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
   */
  static clearCache(): void {
    DefaultPrompts.cachedPrompts = null;
    Logger.info('DefaultPrompts', 'å·²æ¸…é™¤æç¤ºè¯ç¼“å­˜');
  }

  /**
   * é‡æ–°åŠ è½½æç¤ºè¯é…ç½®
   */
  static async reloadPrompts(): Promise<SystemPrompt[]> {
    DefaultPrompts.clearCache();
    return await DefaultPrompts.getAllPrompts();
  }

  /**
   * åº”æ€¥åå¤‡æç¤ºè¯ï¼ˆä»…åœ¨JSONåŠ è½½å®Œå…¨å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
   */
  private static getEmergencyFallbackPrompts(): SystemPrompt[] {
    Logger.warn('DefaultPrompts', 'ä½¿ç”¨åº”æ€¥åå¤‡æç¤ºè¯ï¼ŒåŠŸèƒ½å—é™');
    return [
      new SystemPrompt(
        'Javis åŸºç¡€åŠ©æ‰‹',
        'ä½ æ˜¯Javisï¼Œä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®åŠ©ä½ å›ç­”é—®é¢˜ã€è§£å†³é—®é¢˜å’Œè¿›è¡Œå¯¹è¯ã€‚è™½ç„¶å½“å‰åŠŸèƒ½å—é™ï¼Œä½†æˆ‘ä¼šå°½åŠ›ä¸ºä½ æä¾›å¸®åŠ©ã€‚',
        '',
        true,
        'professional',
        'ğŸ¤–',
        'åŸºç¡€AIåŠ©æ‰‹ï¼ˆåº”æ€¥æ¨¡å¼ï¼‰',
        true
      )
    ];
  }


  /**
   * æ ¹æ®åˆ†ç±»è·å–æç¤ºè¯
   */
  static getPromptsByCategory(category: string): SystemPrompt[] {
    const allPrompts = DefaultPrompts.getAllPromptsSync();
    switch (category.toLowerCase()) {
      case 'professional':
      case 'ä¸“ä¸š':
      case 'ä¸“ä¸šå’¨è¯¢ç±»':
        return allPrompts.filter(prompt => prompt.roleCategory === 'professional');
      case 'character':
      case 'äººç‰©':
        return allPrompts.filter(prompt => prompt.roleCategory === 'character');
      default:
        return [];
    }
  }

  /**
   * æœç´¢æç¤ºè¯
   */
  static searchPrompts(keyword: string): SystemPrompt[] {
    const lowerKeyword = keyword.toLowerCase();
    return DefaultPrompts.getAllPromptsSync().filter(prompt =>
    prompt.name.toLowerCase().includes(lowerKeyword) ||
    prompt.content.toLowerCase().includes(lowerKeyword)
    );
  }

  /**
   * è·å–æç¤ºè¯åˆ†ç±»åˆ—è¡¨
   */
  static getCategories(): string[] {
    return [
      'ä¸“ä¸šå’¨è¯¢ç±»', 'äººç‰©'
    ];
  }
}
