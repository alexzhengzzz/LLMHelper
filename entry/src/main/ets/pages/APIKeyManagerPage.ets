/**
 * APIå¯†é’¥ç®¡ç†é¡µé¢
 * ç®¡ç†ç›´è¿æ¨¡å¼çš„APIå¯†é’¥é…ç½®
 */

import { router } from '@kit.ArkUI';
import { APIKeyManager } from '../utils/APIKeyManager';
import { 
  APIKeyConfig, 
  ConnectionStatus, 
  ProviderInfo, 
  SUPPORTED_PROVIDERS,
  APIKeyManagerEvent
} from '../types/APIKeyTypes';
import { AIProvider } from '../types/APITypes';
import { Logger } from '../utils/Logger';
import { ThemeManager } from '../utils/ThemeManager';

/**
 * å‚å•†é…ç½®å¡ç‰‡å‚æ•°æ¥å£
 */
interface ProviderConfigCardParams {
  config: APIKeyConfig;
  status: ConnectionStatus;
  providerInfo: ProviderInfo | undefined;
  isTesting: boolean;
  onEdit: () => void;
  onTest: () => void;
  onToggleEnabled: (enabled: boolean) => void;
  getConnectionStatusIcon: (s: ConnectionStatus) => string;
  getConnectionStatusText: (s: ConnectionStatus) => string;
  getConnectionStatusColor: (s: ConnectionStatus) => string;
}

@Entry
@ComponentV2
struct APIKeyManagerPage {
  @Local apiKeyManager: APIKeyManager = APIKeyManager.getInstance();
  @Local configs: Map<AIProvider, APIKeyConfig> = new Map();
  @Local isLoading: boolean = true;
  @Local testingProvider: AIProvider | null = null;
  @Local showDialog: boolean = false;
  @Local editingProvider: AIProvider | null = null;
  @Local editingApiKey: string = '';
  @Local showApiKey: boolean = false;
  @Local connectionStatuses: Map<AIProvider, ConnectionStatus> = new Map();
  @Local themeManager: ThemeManager = ThemeManager.getInstance();
  @Local isDarkMode: boolean = false;
  @Local statusBarHeight: number = 44; // çŠ¶æ€æ é«˜åº¦
  
  private listenerId: string = 'APIKeyManagerPage';

  async aboutToAppear(): Promise<void> {
    Logger.info('APIKeyManagerPage', 'é¡µé¢åˆå§‹åŒ–');
    
    // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
    await this.themeManager.initialize();
    this.isDarkMode = this.themeManager.getDarkMode();
    
    // æ·»åŠ ä¸»é¢˜å˜æ›´ç›‘å¬å™¨
    this.themeManager.addThemeListener((isDark: boolean) => {
      this.isDarkMode = isDark;
    });
    
    try {
      // åˆå§‹åŒ–APIå¯†é’¥ç®¡ç†å™¨
      await this.apiKeyManager.initialize();
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      this.apiKeyManager.addListener(this.listenerId, (event: APIKeyManagerEvent) => this.handleAPIKeyEvent(event));
      
      // åŠ è½½é…ç½®
      await this.loadConfigs();
      
      this.isLoading = false;
      Logger.info('APIKeyManagerPage', 'é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      Logger.error('APIKeyManagerPage', `é¡µé¢åˆå§‹åŒ–å¤±è´¥: ${error}`);
      this.isLoading = false;
    }
  }

  aboutToDisappear(): void {
    Logger.info('APIKeyManagerPage', 'é¡µé¢é”€æ¯');
    
    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    this.apiKeyManager.removeListener(this.listenerId);
    
    // ç§»é™¤ä¸»é¢˜ç›‘å¬å™¨
    this.themeManager.removeThemeListener((isDark: boolean) => {
      this.isDarkMode = isDark;
    });
  }

  /**
   * å¤„ç†APIå¯†é’¥ç®¡ç†å™¨äº‹ä»¶
   */
  private handleAPIKeyEvent(event: APIKeyManagerEvent): void {
    Logger.info('APIKeyManagerPage', `æ”¶åˆ°äº‹ä»¶: ${JSON.stringify(event)}`);
    
    switch (event.type) {
      case 'config_updated':
      case 'connection_tested':
      case 'provider_enabled':
      case 'provider_disabled':
      case 'all_configs_loaded':
        this.loadConfigs();
        break;
    }
  }

  /**
   * åŠ è½½é…ç½®
   */
  private async loadConfigs(): Promise<void> {
    try {
      this.configs = this.apiKeyManager.getAllConfigs();
      
      // æ›´æ–°è¿æ¥çŠ¶æ€
      this.configs.forEach((config, provider) => {
        this.connectionStatuses.set(provider, this.apiKeyManager.getConnectionStatus(provider));
      });
      
      Logger.info('APIKeyManagerPage', `åŠ è½½äº† ${this.configs.size} ä¸ªå‚å•†é…ç½®`);
    } catch (error) {
      Logger.error('APIKeyManagerPage', `åŠ è½½é…ç½®å¤±è´¥: ${error}`);
    }
  }

  /**
   * è¿”å›ä¸Šä¸€é¡µ
   */
  onBackPress(): boolean | void {
    router.back();
    return true;
  }

  /**
   * æ˜¾ç¤ºAPIå¯†é’¥ç¼–è¾‘å¯¹è¯æ¡†
   */
  private showEditDialog(provider: AIProvider): void {
    const config = this.configs.get(provider);
    if (config) {
      this.editingProvider = provider;
      this.editingApiKey = config.apiKey;
      this.showApiKey = false;
      this.showDialog = true;
    }
  }

  /**
   * éšè—ç¼–è¾‘å¯¹è¯æ¡†
   */
  private hideEditDialog(): void {
    this.showDialog = false;
    this.editingProvider = null;
    this.editingApiKey = '';
    this.showApiKey = false;
  }

  /**
   * ä¿å­˜APIå¯†é’¥
   */
  private async saveApiKey(): Promise<void> {
    if (!this.editingProvider) {
      return;
    }

    try {
      await this.apiKeyManager.updateApiKey(this.editingProvider, this.editingApiKey);
      this.hideEditDialog();
      
      // å¦‚æœå¯†é’¥ä¸ä¸ºç©ºï¼Œè‡ªåŠ¨æµ‹è¯•è¿æ¥
      if (this.editingApiKey.trim().length > 0) {
        await this.testConnection(this.editingProvider);
      }
    } catch (error) {
      Logger.error('APIKeyManagerPage', `ä¿å­˜APIå¯†é’¥å¤±è´¥: ${error}`);
      // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºé”™è¯¯æç¤º
    }
  }

  /**
   * æµ‹è¯•è¿æ¥
   */
  private async testConnection(provider: AIProvider): Promise<void> {
    try {
      this.testingProvider = provider;
      await this.apiKeyManager.testConnection(provider);
    } catch (error) {
      Logger.error('APIKeyManagerPage', `æµ‹è¯•è¿æ¥å¤±è´¥: ${error}`);
    } finally {
      this.testingProvider = null;
    }
  }

  /**
   * æµ‹è¯•æ‰€æœ‰è¿æ¥
   */
  private async testAllConnections(): Promise<void> {
    try {
      await this.apiKeyManager.testAllConnections();
    } catch (error) {
      Logger.error('APIKeyManagerPage', `æµ‹è¯•æ‰€æœ‰è¿æ¥å¤±è´¥: ${error}`);
    }
  }

  /**
   * å¯ç”¨/ç¦ç”¨å‚å•†
   */
  private async toggleProviderEnabled(provider: AIProvider, enabled: boolean): Promise<void> {
    try {
      await this.apiKeyManager.setProviderEnabled(provider, enabled);
    } catch (error) {
      Logger.error('APIKeyManagerPage', `åˆ‡æ¢å‚å•†çŠ¶æ€å¤±è´¥: ${error}`);
    }
  }

  /**
   * è·å–è¿æ¥çŠ¶æ€å›¾æ ‡
   */
  private getConnectionStatusIcon(status: ConnectionStatus): string {
    switch (status) {
      case ConnectionStatus.CONNECTED:
        return 'âœ…';
      case ConnectionStatus.DISCONNECTED:
        return 'âšª';
      case ConnectionStatus.ERROR:
        return 'âŒ';
      case ConnectionStatus.TESTING:
        return 'â³';
      default:
        return 'â“';
    }
  }

  /**
   * è·å–è¿æ¥çŠ¶æ€æ–‡æœ¬
   */
  private getConnectionStatusText(status: ConnectionStatus): string {
    switch (status) {
      case ConnectionStatus.CONNECTED:
        return 'å·²è¿æ¥';
      case ConnectionStatus.DISCONNECTED:
        return 'æœªé…ç½®';
      case ConnectionStatus.ERROR:
        return 'è¿æ¥å¤±è´¥';
      case ConnectionStatus.TESTING:
        return 'æµ‹è¯•ä¸­...';
      default:
        return 'æœªçŸ¥çŠ¶æ€';
    }
  }

  /**
   * è·å–è¿æ¥çŠ¶æ€é¢œè‰²
   */
  private getConnectionStatusColor(status: ConnectionStatus): string {
    switch (status) {
      case ConnectionStatus.CONNECTED:
        return '#4CAF50';
      case ConnectionStatus.DISCONNECTED:
        return '#9E9E9E';
      case ConnectionStatus.ERROR:
        return '#F44336';
      case ConnectionStatus.TESTING:
        return '#FF9800';
      default:
        return '#9E9E9E';
    }
  }

  /**
   * è·å–å‚å•†åç§°
   */
  private getProviderName(provider: AIProvider): string {
    const providerInfo = SUPPORTED_PROVIDERS.find(p => p.provider === provider);
    return providerInfo ? providerInfo.name : 'æœªçŸ¥å‚å•†';
  }

  /**
   * è·å–å‚å•†æè¿°
   */
  private getProviderDescription(provider: AIProvider): string {
    const providerInfo = SUPPORTED_PROVIDERS.find(p => p.provider === provider);
    return providerInfo ? providerInfo.description : 'æš‚æ— æè¿°';
  }

  /**
   * è·å–å‚å•†å¯†é’¥æ ¼å¼
   */
  private getProviderKeyFormat(provider: AIProvider): string {
    const providerInfo = SUPPORTED_PROVIDERS.find(p => p.provider === provider);
    return providerInfo ? providerInfo.keyFormat : 'æœªçŸ¥æ ¼å¼';
  }

  /**
   * è·å–å‚å•†å›¾æ ‡
   */
  private getProviderIcon(provider: AIProvider): string {
    switch (provider) {
      case AIProvider.SILICONFLOW:
        return 'ğŸ¤–';
      case AIProvider.GEMINI:
        return 'ğŸŒ';
      case AIProvider.GLM:
        return 'âœ¨';
      default:
        return 'ğŸ—¿';
    }
  }

  /**
   * è·å–å‚å•†ä¸»é¢˜è‰²
   */
  private getProviderColor(provider: AIProvider): string {
    switch (provider) {
      case AIProvider.SILICONFLOW:
        return '#667eea';
      case AIProvider.GEMINI:
        return '#4285F4';
      case AIProvider.GLM:
        return '#7C4DFF';
      default:
        return '#9E9E9E';
    }
  }

  /**
   * ç°ä»£åŒ–å¯¼èˆªæ 
   */
  @Builder
  buildNavigationBar() {
    Row() {
      // ç°ä»£åŒ–è¿”å›æŒ‰é’®
      Button() {
        Row() {
          Text('â†')
            .fontSize(18)
            .fontColor($r('app.color.text_primary'))
            .margin({ right: 4 })
          Text('è¿”å›')
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
        }
        .alignItems(VerticalAlign.Center)
      }
      .height(40)
      .padding({ left: 8, right: 12 })
      .backgroundColor(Color.Transparent)
      .borderRadius(20)
      .onClick(() => {
        this.onBackPress();
      })

      Blank()

      Text('APIå¯†é’¥ç®¡ç†')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))

      Blank()

      // å ä½æŒ‰é’®ä¿æŒå±…ä¸­å¯¹é½
      Button()
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .visibility(Visibility.Hidden)
    }
    .width('100%')
    .height(64)
    .padding({ left: 20, right: 20, top: 12, bottom: 12 })
    .backgroundColor($r('app.color.surface_color'))
    .border({
      width: { bottom: 1 },
      color: $r('app.color.border_color')
    })
  }

  /**
   * åŠ è½½çŠ¶æ€
   */
  @Builder
  buildLoadingState() {
    Column() {
      LoadingProgress()
        .width(60)
        .height(60)
        .color($r('app.color.primary_color'))
        .margin({ bottom: 24 })

      Text('æ­£åœ¨åŠ è½½é…ç½®...')
        .fontSize(18)
        .fontWeight(500)
        .fontColor($r('app.color.text_primary'))
        .textAlign(TextAlign.Center)
        .margin({ bottom: 8 })
      
      Text('è¯·ç¨å€™ï¼Œæ­£åœ¨åˆå§‹åŒ–APIé…ç½®')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .layoutWeight(1)
    .margin({ top: 60 })
  }

  /**
   * ä¸»è¦å†…å®¹åŒºåŸŸ
   */
  @Builder
  buildContent() {
    Scroll() {
      Column() {
        // é¡µé¢æ ‡é¢˜å’Œæè¿°
        Column() {
          Text('é…ç½®AIæœåŠ¡')
            .fontSize(24)
            .fontWeight(700)
            .fontColor($r('app.color.text_primary'))
            .margin({ bottom: 8 })
            .textAlign(TextAlign.Start)
            .width('100%')
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
        .padding({ top: 8, bottom: 24 })

        // å‚å•†é…ç½®åˆ—è¡¨
        ForEach(Array.from(this.configs.entries()), (item: [AIProvider, APIKeyConfig]) => {
          this.ProviderConfigCard({
            config: item[1],
            status: this.connectionStatuses.get(item[0]) || ConnectionStatus.UNKNOWN,
            providerInfo: SUPPORTED_PROVIDERS.find(p => p.provider === item[0]),
            isTesting: this.testingProvider === item[0],
            onEdit: () => this.showEditDialog(item[0]),
            onTest: () => this.testConnection(item[0]),
            onToggleEnabled: (enabled: boolean) => this.toggleProviderEnabled(item[0], enabled),
            getConnectionStatusIcon: (s: ConnectionStatus) => this.getConnectionStatusIcon(s),
            getConnectionStatusText: (s: ConnectionStatus) => this.getConnectionStatusText(s),
            getConnectionStatusColor: (s: ConnectionStatus) => this.getConnectionStatusColor(s)
          });
        });

        // æµ‹è¯•æ‰€æœ‰è¿æ¥æŒ‰é’®
        Button() {
          Row() {
            if (this.apiKeyManager.isTesting()) {
              LoadingProgress()
                .width(20)
                .height(20)
                .color(Color.White)
                .margin({ right: 8 })
            }
            
            Text(this.apiKeyManager.isTesting() ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•æ‰€æœ‰è¿æ¥')
              .fontSize(16)
              .fontWeight(500)
              .fontColor(Color.White)
          }
        }
        .width('100%')
        .height(52)
        .borderRadius(26)
        .margin({ top: 32, bottom: 24 })
        .enabled(!this.apiKeyManager.isTesting())
        .backgroundColor(this.apiKeyManager.isTesting() ? $r('app.color.text_secondary') : $r('app.color.primary_color'))
        .shadow({
          radius: 12,
          color: this.apiKeyManager.isTesting() ? 'rgba(0, 0, 0, 0.1)' : $r('app.color.primary_color_20'),
          offsetY: 4
        })
        .onClick(() => this.testAllConnections())

        // å¸®åŠ©ä¿¡æ¯
        this.HelpSection()
      }
      .padding({ left: 20, right: 20, top: 0, bottom: 20 })
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ  - æ·»åŠ çŠ¶æ€æ é«˜åº¦é¿è®©
        Column() {
          this.buildNavigationBar()
        }
        .margin({ top: this.statusBarHeight })

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        if (this.isLoading) {
          this.buildLoadingState()
        } else {
          this.buildContent()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.background_color'))

      // è’™ç‰ˆå±‚
      if (this.showDialog) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor(this.themeManager.getDarkMode() ? 'rgba(0, 0, 0, 0.7)' : 'rgba(0, 0, 0, 0.5)')
          .onClick(() => this.hideEditDialog())
      }

      // ç¼–è¾‘å¯¹è¯æ¡†
      if (this.showDialog) {
        this.APIKeyEditDialog()
      }
    }
    .width('100%')
    .height('100%')
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  /**
   * å‚å•†é…ç½®å¡ç‰‡ç»„ä»¶
   */
  @Builder
  ProviderConfigCard(params: ProviderConfigCardParams) {
    Column() {
      // å‚å•†ä¿¡æ¯
      Row() {
        Column() {
          Text(params.config.displayName)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .alignSelf(ItemAlign.Start)

          Text(params.config.description)
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 4 })
            .alignSelf(ItemAlign.Start)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // çŠ¶æ€æŒ‡ç¤ºå™¨
        Row() {
          Text(params.getConnectionStatusIcon(params.status))
            .fontSize(16)
            .margin({ right: 4 })
          
          Text(params.getConnectionStatusText(params.status))
            .fontSize(12)
            .fontColor(params.getConnectionStatusColor(params.status))
        }
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor(params.getConnectionStatusColor(params.status) + '20')
        .borderRadius(12)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // APIå¯†é’¥æ˜¾ç¤º
      Row() {
        Text('APIå¯†é’¥:')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .width(80)

        if (params.config.apiKey) {
          Text(params.config.apiKey.substring(0, 8) + '...' + params.config.apiKey.substring(params.config.apiKey.length - 4))
            .fontSize(14)
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
        } else {
          Text('æœªè®¾ç½®')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .layoutWeight(1)
        }

        Button('ç¼–è¾‘')
          .fontSize(12)
          .fontColor($r('app.color.primary_color'))
          .backgroundColor(Color.Transparent)
          .onClick(params.onEdit)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ“ä½œæŒ‰é’®
      Row() {
        Button(params.isTesting ? 'æµ‹è¯•ä¸­...' : 'æµ‹è¯•è¿æ¥')
          .fontSize(12)
          .fontColor(Color.White)
          .backgroundColor(params.isTesting ? $r('app.color.text_secondary') : $r('app.color.success_color'))
          .layoutWeight(1)
          .borderRadius(8)
          .enabled(!params.isTesting && !!params.config.apiKey)
          .onClick(params.onTest)

        Blank()

        Toggle({ type: ToggleType.Switch, isOn: params.config.enabled })
          .onChange(params.onToggleEnabled)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 4,
      color: this.isDarkMode ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.1)',
      offsetY: 2
    })
  }

  /**
   * å¸®åŠ©ä¿¡æ¯ç»„ä»¶
   */
  @Builder
  HelpSection() {
    Column() {
      Text('ä½¿ç”¨è¯´æ˜')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 12 })

      Column() {
        Text('â€¢ ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®è®¾ç½®APIå¯†é’¥')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        Text('â€¢ ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯å¯†é’¥æœ‰æ•ˆæ€§')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        Text('â€¢ å¼€å¯å¼€å…³å¯ç”¨å‚å•†ï¼Œå…³é—­å¼€å…³ç¦ç”¨å‚å•†')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        Text('â€¢ APIå¯†é’¥ä»…å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.primary_color_10'))
    .borderRadius(12)
    .margin({ bottom: 24 })
  }

  /**
   * å‚å•†ä¿¡æ¯æ˜¾ç¤ºç»„ä»¶
   */
  @Builder
  ProviderInfoDisplay(provider: AIProvider) {
    Row() {
      // å‚å•†å›¾æ ‡
      Text(this.getProviderIcon(provider))
        .fontSize(32)
        .width(64)
        .height(64)
        .textAlign(TextAlign.Center)
        .backgroundColor(this.getProviderColor(provider) + '20')
        .borderRadius(32)
        .margin({ right: 16 })
      
      Column() {
        Text(this.getProviderName(provider))
          .fontSize(20)
          .fontWeight(600)
          .fontColor($r('app.color.text_primary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        Text(this.getProviderDescription(provider))
          .fontSize(15)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
          .lineHeight(22)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
    }
    .width('100%')
    .alignItems(VerticalAlign.Center)
    .padding(20)
    .backgroundColor($r('app.color.surface_color'))
    .borderRadius(16)
    .margin({ bottom: 24 })
    .border({
      width: 1,
      color: $r('app.color.border_color')
    })
  }

  /**
   * APIå¯†é’¥ç¼–è¾‘å¯¹è¯æ¡†
   */
  @Builder
  APIKeyEditDialog() {
    Stack() {
      // å¯¹è¯æ¡†å†…å®¹
      Column() {
        // å‚å•†ä¿¡æ¯
        if (this.editingProvider) {
          this.ProviderInfoDisplay(this.editingProvider)
        }

        // APIå¯†é’¥è¾“å…¥åŒºåŸŸ
        Column() {
          Text('APIå¯†é’¥')
            .fontSize(16)
            .fontWeight(500)
            .fontColor($r('app.color.text_primary'))
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 12 })

          Row() {
            TextInput({ placeholder: 'è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥', text: this.editingApiKey })
              .fontSize(15)
              .fontColor($r('app.color.text_primary'))
              .backgroundColor($r('app.color.input_background'))
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .borderRadius(12)
              .layoutWeight(1)
              .type(this.showApiKey ? InputType.Normal : InputType.Password)
              .border({
                width: 1,
                color: $r('app.color.border_color')
              })
              .onChange((value: string) => {
                this.editingApiKey = value;
              })
          }
          .width('100%')
          .alignItems(VerticalAlign.Center)
          .margin({ bottom: 12 })

          Row() {
            Text('ğŸ›¡ï¸')
              .fontSize(14)
              .margin({ right: 8 })
            
            Text('å¯†é’¥ä»…å­˜å‚¨åœ¨æœ¬åœ°è®¾å¤‡ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨')
              .fontSize(13)
              .fontColor($r('app.color.text_secondary'))
              .layoutWeight(1)
              .lineHeight(18)
          }
          .width('100%')
          .alignItems(VerticalAlign.Top)
        }
        .width('100%')
        .margin({ bottom: 32 })

        // æ“ä½œæŒ‰é’®
        Row() {
          Button('å–æ¶ˆ')
            .fontSize(16)
            .fontWeight(500)
            .fontColor($r('app.color.text_secondary'))
            .backgroundColor($r('app.color.primary_color_10'))
            .height(48)
            .borderRadius(24)
            .layoutWeight(1)
            .margin({ right: 12 })
            .onClick(() => this.hideEditDialog())

          Button('ä¿å­˜å¯†é’¥')
            .fontSize(16)
            .fontWeight(500)
            .fontColor(Color.White)
            .height(48)
            .borderRadius(24)
            .layoutWeight(1)
            .margin({ left: 12 })
            .backgroundColor($r('app.color.primary_color'))
            .shadow({
              radius: 8,
              color: $r('app.color.primary_color_20'),
              offsetY: 2
            })
            .onClick(() => this.saveApiKey())
        }
        .width('100%')
      }
      .width('92%')
      .constraintSize({ maxWidth: 480 })
      .padding(28)
      .backgroundColor($r('app.color.surface_color'))
      .borderRadius(24)
      .shadow({
        radius: 24,
        color: this.isDarkMode ? 'rgba(0, 0, 0, 0.5)' : 'rgba(0, 0, 0, 0.15)',
        offsetY: 8
      })
      .border({
        width: 1,
        color: $r('app.color.border_color')
      })
    }
    .width('100%')
    .height('100%')
    .alignContent(Alignment.Center)
  }
}