import { router, promptAction, curves, display } from '@kit.ArkUI';
import { ChatViewModel } from '../viewmodels/ChatViewModel';
import { Message, MessageRole, SystemPrompt, ThinkingStep, ThinkingStatus } from '../models/ChatModels';
import { inputMethod } from '@kit.IMEKit';
import { ModelSelectorComponent } from '../components/ModelSelectorComponent';
import { SystemPromptComponent } from '../components/SystemPromptComponent';
import { QuickCommandsComponent, QuickCommand } from '../components/QuickCommandsComponent';
import { SideDrawerComponent } from '../components/SideDrawerComponent';
import { ToolboxComponent } from '../components/ToolboxComponent';
import { VoiceInputComponent, VoiceRecognitionState, InputMode, VoiceOverlayHint } from '../components/VoiceInputComponent';
import { SmartTextRenderer } from '../components/SmartTextRenderer';
import { DeepThinkingDialog } from '../components/DeepThinkingDialog';
import { SearchDetailsDialog } from '../components/SearchDetailsDialog';
import { DeepThinkingStatusCard } from '../components/DeepThinkingStatusCard';
import { ToolCallStatusComponent } from '../components/ToolCallStatusComponent';
import { ToolType } from '../types/ToolboxTypes';
import { pasteboard } from '@kit.BasicServicesKit';
import { ThemeManager } from '../utils/ThemeManager';
import { FontManager } from '../utils/FontManager';
import { FontSettings } from '../utils/AppStorage';
import { AvatarSettings, UserProfile, AppStorage as StorageManager } from '../utils/AppStorage';
import { UserProfileManager } from '../utils/UserProfileManager';
import { AppConfigManager } from '../utils/AppConfigManager';
import { AutoTTSService } from '../services/AutoTTSService';
import { Logger } from '../utils/Logger';
import { Constants } from '../utils/Constants';
import { BusinessError } from '@kit.BasicServicesKit';

// å¯¼å…¥åŸºç¡€åŠ¨ç”»ç³»ç»Ÿ
import { 
  BasicAnimations, 
  AnimationConfigManager
} from '../animations';

/**
 * å·¥å…·ç®±é¡¹ç›®æ¥å£
 */
interface ToolboxItem {
  id: string;
  title: string;
  description: string;
  icon: string;
  color: string;
  backgroundColor: string;
  enabled: boolean;
  action: () => void | Promise<void>;
}

/**
 * å¯¼èˆªå›¾æ ‡é€‰é¡¹æ¥å£
 */
interface NavigationIconOptions {
  active?: boolean;
  activeColor?: Resource | string;
  inactiveColor?: Resource | string;
  activeBorderColor?: Resource | string;
  inactiveBorderColor?: Resource | string;
}

/**
 * ä½ç½®åæ ‡æ¥å£
 */
interface Position {
  x: number;
  y: number;
}

/**
 * èŠå¤©ä¸»é¡µé¢ - ä½¿ç”¨çŠ¶æ€ç®¡ç†V2å’ŒMVVMæ¨¡å¼
 */
@Entry
@ComponentV2
struct ChatPage {
  @Local chatViewModel: ChatViewModel = new ChatViewModel();
  @Local inputText: string = '';
  @Local showModelSelector: boolean = false;
  // @Local showPromptSelector: boolean = false; // å·²æ³¨é‡Šï¼šä¸å†ä½¿ç”¨é¡¶éƒ¨é€‰æ‹©å™¨
  @Local showQuickCommands: boolean = false;

  // æ¶ˆæ¯å˜åŒ–æ£€æµ‹ç›¸å…³çŠ¶æ€
  @Local messages: Message[] = [];
  @Local lastMessageCount: number = 0;
  @Local lastAssistantMessageContent: string = '';

  // æ¶ˆæ¯å˜åŒ–æ£€æµ‹å®šæ—¶å™¨
  private messageChangeTimer: number = -1;
  @Local isDarkMode: boolean = false;
  @Local isImmersiveMode: boolean = false;
  @Local showSideDrawer: boolean = false;
  @Local enableWebSearch: boolean = false; // è”ç½‘æœç´¢å¼€å…³çŠ¶æ€
  @Local enableDeepThinking: boolean = false; // æ·±åº¦æ€è€ƒå¼€å…³çŠ¶æ€
  @Local showToolboxPanel: boolean = false; // å·¥å…·ç®±é¢æ¿æ˜¾ç¤ºçŠ¶æ€
  @Local toolboxPanelOpacity: number = 0.0; // å·¥å…·ç®±é¢æ¿é€æ˜åº¦
  @Local toolboxPanelTranslateY: number = 400; // å·¥å…·ç®±é¢æ¿Yè½´ä½ç§»
  @Local isMuted: boolean = false; // è‡ªåŠ¨æ’­æŠ¥é™éŸ³çŠ¶æ€
  
  // è¯­éŸ³è¯†åˆ«ç›¸å…³çŠ¶æ€
  @Local voiceRecognitionState: VoiceRecognitionState = VoiceRecognitionState.IDLE;
  @Local voiceInputMode: InputMode = InputMode.TEXT;
  @Local showVoiceInput: boolean = true; // æ˜¯å¦æ˜¾ç¤ºè¯­éŸ³è¾“å…¥æŒ‰é’®
  @Local voiceOverlayHint: VoiceOverlayHint | null = null; // è¯­éŸ³æç¤ºè¦†ç›–å±‚
  @Local sideDrawerSwipeProgress: number = 0; // ä¾§è¾¹æ æ»‘åŠ¨è¿›åº¦ (0-1)
  @Local isSideDrawerSwipeActive: boolean = false; // æ˜¯å¦æ­£åœ¨æ»‘åŠ¨ä¾§è¾¹æ 
  @Local isSwipeDebouncing: boolean = false; // æ»‘åŠ¨é˜²æŠ–çŠ¶æ€
  @Local lastSwipeTime: number = 0; // ä¸Šæ¬¡æ»‘åŠ¨æ—¶é—´
  @Local swipeDirection: 'left' | 'right' | 'none' = 'none'; // å½“å‰æ»‘åŠ¨æ–¹å‘
  @Local isSessionItemSwiping: boolean = false; // ä¼šè¯é¡¹æ˜¯å¦æ­£åœ¨æ»‘åŠ¨
  @Local useModernMessageLayout: boolean = false; // ç°ä»£æ¶ˆæ¯å¸ƒå±€å¼€å…³
  @Local fontSettings: FontSettings = {
    chatFontSize: 16,
    codeFontSize: 14,
    fontFamily: 'playful',
    updatedAt: Date.now()
  };
  @Local userAvatarType: 'default' | 'emoji' | 'image' = 'default';
  @Local userAvatarValue: string = '#4285F4';
  @Local aiAvatarType: 'default' | 'emoji' | 'image' = 'default';
  @Local aiAvatarValue: string = '#34A853';
  @Local userName: string = 'Javisç”¨æˆ·';
  @Local userSignature: string = 'è®©AIæˆä¸ºä½ çš„ç¼–ç¨‹ä¼™ä¼´';
  @Local inputAreaHeight: number = 48; // è¾“å…¥åŒºåŸŸåŠ¨æ€é«˜åº¦
  @Local statusBarHeight: number = 44; // çŠ¶æ€æ é«˜åº¦ï¼Œé»˜è®¤44ï¼Œå®é™…ç”±ç³»ç»ŸAPIè·å–
  @Local keyboardHeight: number = 0; // é”®ç›˜é«˜åº¦ï¼Œç”¨äºåˆ¤æ–­è¾“å…¥æ³•æ˜¯å¦æ˜¾ç¤º
  @Local modelSelectorOpacity: number = 0.0; // æ¨¡å‹é€‰æ‹©å™¨é€æ˜åº¦
  @Local modelSelectorTranslateY: number = 400; // æ¨¡å‹é€‰æ‹©å™¨Yè½´åç§»
  
    
  // æœç´¢è¯¦æƒ…å¼¹æ¡†ç›¸å…³çŠ¶æ€
  @Local showSearchDetailsDialog: boolean = false; // æœç´¢è¯¦æƒ…å¼¹æ¡†æ˜¾ç¤ºçŠ¶æ€
  @Local searchDetailsContent: string = ''; // æœç´¢è¯¦æƒ…å¼¹æ¡†å†…å®¹
  
  // æ·±åº¦æ€è€ƒå¯¹è¯æ¡†ç›¸å…³çŠ¶æ€
  @Local showThinkingDialog: boolean = false; // æ·±åº¦æ€è€ƒå¯¹è¯æ¡†æ˜¾ç¤ºçŠ¶æ€
  @Local thinkingDialogMessage: Message | null = null; // æ·±åº¦æ€è€ƒå¯¹è¯æ¡†çš„æ¶ˆæ¯
  
  private shouldCloseInputMethod: boolean = true;
  private targetSessionId: string = ''; // ç›®æ ‡ä¼šè¯IDï¼ˆä»è·¯ç”±å‚æ•°è·å–ï¼‰
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private fontManager: FontManager = FontManager.getInstance();
  private userProfileManager: UserProfileManager = UserProfileManager.getInstance();
  private autoTTSService: AutoTTSService = AutoTTSService.getInstance();
  private listScroller: ListScroller = new ListScroller();
  private lastProvidersReloadTime: number = 0; // é˜²æŠ–ï¼šè®°å½•ä¸Šæ¬¡providersåŠ è½½æ—¶é—´
  private forceReloadProviders: boolean = false; // å¼ºåˆ¶åˆ·æ–°æ¨¡å‹åˆ—è¡¨æ ‡è®°
  private lastServerConfig: string = ''; // ä¸Šæ¬¡æœåŠ¡å™¨é…ç½®ï¼Œç”¨äºæ£€æµ‹å˜æ›´
  private readonly SIDE_DRAWER_SWIPE_THRESHOLD = 80; // ä¾§è¾¹æ æ»‘åŠ¨é˜ˆå€¼
  private readonly SIDE_DRAWER_PROGRESS_THRESHOLD = 0.3; // ä¾§è¾¹æ è¿›åº¦é˜ˆå€¼ (30%)
  private readonly SIDE_DRAWER_EDGE_WIDTH = 20; // ä¾§è¾¹æ è¾¹ç¼˜æ£€æµ‹å®½åº¦
  private readonly SWIPE_DEBOUNCE_TIME = 150; // æ»‘åŠ¨é˜²æŠ–æ—¶é—´(ms)
  private readonly DIRECTION_CHANGE_THRESHOLD = 100; // æ–¹å‘å˜åŒ–é˜ˆå€¼(ms)
  private avatarListener: (settings: AvatarSettings) => void = (settings: AvatarSettings) => {
    this.userAvatarType = settings.userAvatarType;
    this.userAvatarValue = settings.userAvatarValue;
    this.aiAvatarType = settings.aiAvatarType;
    this.aiAvatarValue = settings.aiAvatarValue;
    Logger.info('ChatPage', 'å¤´åƒè®¾ç½®å·²æ›´æ–°');
  };
  private fontSettingsListener: (settings: FontSettings) => void = (settings: FontSettings) => {
    Logger.info('ChatPage', `æ”¶åˆ°FontManagerå­—ä½“è®¾ç½®å˜æ›´é€šçŸ¥: ${JSON.stringify(settings)}`);
    Logger.info('ChatPage', `æ›´æ–°å‰æœ¬åœ°å­—ä½“è®¾ç½®: ${JSON.stringify(this.fontSettings)}`);
    this.fontSettings = settings;
    Logger.info('ChatPage', `æ›´æ–°åæœ¬åœ°å­—ä½“è®¾ç½®: ${JSON.stringify(this.fontSettings)}`);
  };
  
  private readonly handleVoiceComponentResult = (text: string): void => {
    void this.handleVoiceResult(text);
  };

  private readonly handleVoiceComponentStateChange = (state: VoiceRecognitionState): void => {
    this.voiceRecognitionState = state;
  };

  private readonly handleVoiceComponentModeChange = (mode: InputMode): void => {
    if (this.voiceInputMode === mode) {
      return;
    }

    this.voiceInputMode = mode;

    if (mode === InputMode.VOICE) {
      try {
        inputMethod.getController().stopInputSession();
      } catch (error) {
        Logger.warn('ChatPage', `åœæ­¢è¾“å…¥æ³•ä¼šè¯å¤±è´¥: ${JSON.stringify(error)}`);
      }
      this.keyboardHeight = 0;
    }
  };

  private readonly handleVoiceComponentSmartPrompt = (prompt: string): void => {
    this.handleSmartPrompt(prompt);
  };

  private readonly handleVoiceComponentHintChange = (hint: VoiceOverlayHint | null): void => {
    this.voiceOverlayHint = hint;
  };

  async aboutToAppear(): Promise<void> {
    Logger.info('ChatPage', 'aboutToAppear å¼€å§‹');
    
    // å¤„ç†è·¯ç”±å‚æ•°ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢åˆ°ç‰¹å®šä¼šè¯
    try {
      const params = router.getParams();
      if (params && (params as Record<string, Object>).sessionId) {
        const sessionId = (params as Record<string, Object>).sessionId as string;
        Logger.info('ChatPage', `æ£€æµ‹åˆ°è·¯ç”±å‚æ•°sessionId: ${sessionId}ï¼Œå‡†å¤‡åˆ‡æ¢ä¼šè¯`);
        
        // è®¾ç½®ç›®æ ‡ä¼šè¯IDï¼Œç¨ååœ¨loadInitialDataä¹‹ååˆ‡æ¢
        this.targetSessionId = sessionId;
      }
    } catch (error) {
      Logger.warn('ChatPage', `è·å–è·¯ç”±å‚æ•°å¤±è´¥: ${error}`);
    }
    
    // åˆå§‹åŒ–åŠ¨ç”»ç³»ç»Ÿ
    AnimationConfigManager.getInstance().initialize();
    
    // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
    await this.themeManager.initialize();
    this.isDarkMode = this.themeManager.getDarkMode();
    this.isImmersiveMode = this.themeManager.getImmersiveMode();
    
    // æ·»åŠ ä¸»é¢˜å˜æ›´ç›‘å¬å™¨
    this.themeManager.addThemeListener((isDark: boolean) => {
      this.isDarkMode = isDark;
    });
    
    // æ·»åŠ æ²‰æµ¸å¼æ¨¡å¼å˜æ›´ç›‘å¬å™¨
    this.themeManager.addImmersiveListener((isImmersive: boolean) => {
      this.isImmersiveMode = isImmersive;
    });
    
    await this.chatViewModel.loadInitialData();

    try {
      const autoTTSSettings = this.autoTTSService.getSettings();
      this.isMuted = autoTTSSettings.muted;
    } catch (error) {
      Logger.warn('ChatPage', `è·å–è‡ªåŠ¨æ’­æŠ¥é™éŸ³çŠ¶æ€å¤±è´¥: ${error}`);
    }

    this.autoTTSService.setCallbacks({
      onSettingsChanged: (settings) => {
        this.isMuted = settings.muted;
      }
    });

    // è®°å½•providersåŠ è½½æ—¶é—´ï¼Œé¿å…onPageShowæ—¶é‡å¤åŠ è½½
    this.lastProvidersReloadTime = Date.now();
    Logger.info('ChatPage', `åˆå§‹åŒ–å®Œæˆï¼ŒprovidersåŠ è½½æ—¶é—´å·²è®°å½•: ${this.lastProvidersReloadTime}`);
    
    // å¦‚æœæœ‰ç›®æ ‡ä¼šè¯IDï¼Œåˆ‡æ¢åˆ°æŒ‡å®šä¼šè¯
    if (this.targetSessionId) {
      Logger.info('ChatPage', `å‡†å¤‡åˆ‡æ¢åˆ°ç›®æ ‡ä¼šè¯: ${this.targetSessionId}`);
      try {
        const success = await this.chatViewModel.switchToSession(this.targetSessionId);
        if (success) {
          Logger.info('ChatPage', `æˆåŠŸåˆ‡æ¢åˆ°ä¼šè¯: ${this.targetSessionId}`);
        } else {
          Logger.warn('ChatPage', `åˆ‡æ¢ä¼šè¯å¤±è´¥: ${this.targetSessionId}`);
        }
      } catch (error) {
        Logger.error('ChatPage', `åˆ‡æ¢ä¼šè¯å¼‚å¸¸: ${error}`);
      }
      // æ¸…é™¤ç›®æ ‡ä¼šè¯ID
      this.targetSessionId = '';
    }
    
    // åˆå§‹åŠ è½½å®Œæˆåæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
    this.scrollToBottom();

    // åŒæ­¥æ¶ˆæ¯åˆ—è¡¨åˆ°æœ¬åœ°å‰¯æœ¬ï¼Œç”¨äºç›‘å¬å˜åŒ–
    this.messages = [...this.chatViewModel.messages];

    // åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™ç®¡ç†å™¨
    try {
      await this.userProfileManager.initialize();
      const currentProfile = this.userProfileManager.getCurrentProfile();
      if (currentProfile) {
        this.userName = currentProfile.userName;
        this.userSignature = currentProfile.userSignature;
        this.userAvatarType = currentProfile.userAvatarType;
        this.userAvatarValue = currentProfile.userAvatarValue;
        Logger.info('ChatPage', `ç”¨æˆ·èµ„æ–™åŠ è½½æˆåŠŸ: ${this.userName}`);
      }
    } catch (error) {
      Logger.error('ChatPage', `åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™ç®¡ç†å™¨å¤±è´¥: ${error}`);
    }

    // åŠ è½½AIå¤´åƒè®¾ç½®
    try {
      const avatarSettings = await StorageManager.getAvatarSettings();
      this.aiAvatarType = avatarSettings.aiAvatarType;
      this.aiAvatarValue = avatarSettings.aiAvatarValue;
      Logger.info('ChatPage', `AIå¤´åƒè®¾ç½®åŠ è½½æˆåŠŸ: ${JSON.stringify(avatarSettings)}`);
    } catch (error) {
      Logger.error('ChatPage', `åŠ è½½AIå¤´åƒè®¾ç½®å¤±è´¥: ${error}`);
    }

    // åŠ è½½æ¶ˆæ¯å¸ƒå±€åå¥½
    try {
      const initialLayout = this.useModernMessageLayout; // è®°å½•åˆå§‹å€¼(é€šå¸¸ä¸ºfalse)
      this.useModernMessageLayout = await StorageManager.getMessageLayoutPreference();
      Logger.info('ChatPage', `æ¶ˆæ¯å¸ƒå±€åå¥½åŠ è½½æˆåŠŸ: ${this.useModernMessageLayout ? 'ç°ä»£å¸ƒå±€' : 'ä¼ ç»Ÿæ°”æ³¡'}`);
      
      // å¦‚æœåˆå§‹çŠ¶æ€ä¸å­˜å‚¨ä¸ä¸€è‡´ï¼Œè®°å½•ä¿¡æ¯ï¼ˆé€šå¸¸åˆå§‹å€¼ä¸ºfalseï¼Œæ‰€ä»¥åªåœ¨å­˜å‚¨ä¸ºtrueæ—¶è®°å½•ï¼‰
      if (initialLayout !== this.useModernMessageLayout && this.useModernMessageLayout) {
        Logger.info('ChatPage', `åˆå§‹åŒ–æ—¶æ›´æ–°å¸ƒå±€çŠ¶æ€: ${initialLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'} -> ${this.useModernMessageLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'}`);
      }
    } catch (error) {
      Logger.error('ChatPage', `åŠ è½½æ¶ˆæ¯å¸ƒå±€åå¥½å¤±è´¥: ${error}`);
    }

    // åˆå§‹åŒ–å­—ä½“ç®¡ç†å™¨å¹¶åŠ è½½å­—ä½“è®¾ç½®
    try {
      await this.fontManager.initialize();
      this.fontSettings = this.fontManager.getFontSettings();
      Logger.info('ChatPage', `å­—ä½“è®¾ç½®åŠ è½½æˆåŠŸ: ${JSON.stringify(this.fontSettings)}`);
    } catch (error) {
      Logger.error('ChatPage', `åˆå§‹åŒ–å­—ä½“ç®¡ç†å™¨å¤±è´¥: ${error}`);
    }

    // è·å–åŠ¨æ€çŠ¶æ€æ é«˜åº¦
    const storedHeight = AppStorage.get<number>('statusBarHeight');
    if (storedHeight && storedHeight > 0) {
      this.statusBarHeight = storedHeight;
      Logger.info('ChatPage', `çŠ¶æ€æ é«˜åº¦è·å–æˆåŠŸ: ${this.statusBarHeight}vp`);
    } else {
      Logger.info('ChatPage', 'ä½¿ç”¨é»˜è®¤çŠ¶æ€æ é«˜åº¦44vp');
    }
    
    // ä»APIManageråŒæ­¥åŠŸèƒ½çŠ¶æ€
    try {
      const currentFeatures = this.chatViewModel.apiManager.getCurrentFeatures();
      this.enableWebSearch = currentFeatures.enableWebSearch;
      this.enableDeepThinking = currentFeatures.enableDeepThinking;
      Logger.info('ChatPage', `åŠŸèƒ½çŠ¶æ€åŒæ­¥å®Œæˆ: è”ç½‘æœç´¢=${this.enableWebSearch}, æ·±åº¦æ€è€ƒ=${this.enableDeepThinking}, MCPå·¥å…·=${currentFeatures.enableMCPTools}`);
    } catch (error) {
      Logger.error('ChatPage', `åŒæ­¥åŠŸèƒ½çŠ¶æ€å¤±è´¥: ${error}`);
      // ä½¿ç”¨é»˜è®¤çŠ¶æ€
      this.enableWebSearch = false;
      this.enableDeepThinking = false;
    }
    
    // æ·»åŠ å¤´åƒè®¾ç½®ç›‘å¬å™¨
    StorageManager.addAvatarListener(this.avatarListener);

    // æ·»åŠ å­—ä½“è®¾ç½®ç›‘å¬å™¨
    this.fontManager.addListener(this.fontSettingsListener);

    // æ·»åŠ è¾“å…¥æ³•çŠ¶æ€ç›‘å¬å™¨
    this.setupInputMethodListener();
    
    // åˆå§‹åŒ–æœåŠ¡å™¨é…ç½®è®°å½•
    this.lastServerConfig = this.getCurrentServerConfigString();
    
    Logger.info('ChatPage', `åŠ è½½å®Œæˆ - æ¶ˆæ¯: ${this.chatViewModel.messages.length}, æç¤ºè¯: ${this.chatViewModel.systemPrompts.length}, æ·±è‰²: ${this.isDarkMode}`);
    
    if (this.chatViewModel.systemPrompts.length > 0) {
      // ç³»ç»Ÿæç¤ºè¯åˆ—è¡¨è¯¦æƒ…ä»…åœ¨è°ƒè¯•æ—¶è¾“å‡º
    }

    // åˆå§‹åŒ–æ¶ˆæ¯å˜åŒ–æ£€æµ‹çŠ¶æ€
    this.lastMessageCount = this.chatViewModel.messages.length;
    this.messages = [...this.chatViewModel.messages];

    // åˆå§‹åŒ–æœ€åä¸€æ¡åŠ©æ‰‹æ¶ˆæ¯å†…å®¹
    if (this.chatViewModel.messages.length > 0) {
      const lastMessage = this.chatViewModel.messages[this.chatViewModel.messages.length - 1];
      if (lastMessage.role === MessageRole.ASSISTANT) {
        this.lastAssistantMessageContent = lastMessage.content;
      }
    }

    // å¯åŠ¨æ¶ˆæ¯å˜åŒ–æ£€æµ‹å®šæ—¶å™¨
    this.startMessageChangeTimer();
  }

  async onPageShow(): Promise<void> {
    // é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°åŠ è½½ç³»ç»Ÿæç¤ºè¯ï¼Œç¡®ä¿ä»ç®¡ç†é¡µé¢è¿”å›åæ•°æ®æ˜¯æœ€æ–°çš„
    Logger.info('ChatPage', 'é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ è½½ç³»ç»Ÿæç¤ºè¯');
    await this.chatViewModel.loadSystemPrompts();
    Logger.info('ChatPage', `ç³»ç»Ÿæç¤ºè¯å·²æ›´æ–°ï¼Œå½“å‰æœ‰ ${this.chatViewModel.systemPrompts.length} æ¡`);
    
    // é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨ï¼Œç¡®ä¿æ•°æ®åŒæ­¥
    Logger.info('ChatPage', 'é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨');
    await this.chatViewModel.loadSessions();
    Logger.info('ChatPage', `ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå½“å‰æœ‰ ${this.chatViewModel.sessions.length} ä¸ªä¼šè¯`);
    
    // é‡æ–°åŠ è½½å½“å‰ä¼šè¯ï¼Œç¡®ä¿ç³»ç»Ÿæç¤ºè¯ç­‰ä¿¡æ¯æ˜¯æœ€æ–°çš„ï¼ˆå¿…é¡»åœ¨loadSessionsä¹‹åï¼‰
    Logger.info('ChatPage', 'é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ è½½å½“å‰ä¼šè¯');
    await this.chatViewModel.loadCurrentSession();
    Logger.info('ChatPage', `å½“å‰ä¼šè¯å·²æ›´æ–°: ${this.chatViewModel.currentSession?.name || 'null'}`);
    
    
    // é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°åŠ è½½æ¶ˆæ¯å¸ƒå±€åå¥½ï¼Œç¡®ä¿ä»è®¾ç½®é¡µé¢è¿”å›åå¸ƒå±€è®¾ç½®ç”Ÿæ•ˆ
    try {
      const previousLayout = this.useModernMessageLayout;
      const storedLayout = await StorageManager.getMessageLayoutPreference();
      
      // æ£€æŸ¥çŠ¶æ€ä¸€è‡´æ€§ï¼šå¦‚æœå½“å‰çŠ¶æ€ä¸å­˜å‚¨ä¸ä¸€è‡´ï¼Œè®°å½•è­¦å‘Šå¹¶ä»¥å­˜å‚¨ä¸ºå‡†
      if (previousLayout !== storedLayout) {
        Logger.warn('ChatPage', `æ£€æµ‹åˆ°çŠ¶æ€ä¸ä¸€è‡´ - UIçŠ¶æ€: ${previousLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'}, å­˜å‚¨çŠ¶æ€: ${storedLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'}ï¼Œä»¥å­˜å‚¨çŠ¶æ€ä¸ºå‡†`);
      }
      
      this.useModernMessageLayout = storedLayout;
      
      if (previousLayout !== this.useModernMessageLayout) {
        Logger.info('ChatPage', `æ¶ˆæ¯å¸ƒå±€åå¥½å·²æ›´æ–°: ${previousLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'} -> ${this.useModernMessageLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'}`);
      } else {
        Logger.debug('ChatPage', `æ¶ˆæ¯å¸ƒå±€åå¥½æœªå˜æ›´: ${this.useModernMessageLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'}`);
      }
    } catch (error) {
      Logger.error('ChatPage', `é‡æ–°åŠ è½½æ¶ˆæ¯å¸ƒå±€åå¥½å¤±è´¥: ${error}`);
    }

    // é‡æ–°åŠ è½½å¤´åƒè®¾ç½®ï¼Œç¡®ä¿ä»è®¾ç½®é¡µé¢è¿”å›åå¤´åƒæ˜¯æœ€æ–°çš„
    try {
      Logger.info('ChatPage', 'é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ è½½å¤´åƒè®¾ç½®');
      const avatarSettings = await StorageManager.getAvatarSettings();
      this.aiAvatarType = avatarSettings.aiAvatarType;
      this.aiAvatarValue = avatarSettings.aiAvatarValue;
      Logger.info('ChatPage', `AIå¤´åƒè®¾ç½®å·²æ›´æ–°: ${JSON.stringify(avatarSettings)}`);
      
      // é‡æ–°åŠ è½½ç”¨æˆ·å¤´åƒè®¾ç½®
      const currentProfile = this.userProfileManager.getCurrentProfile();
      if (currentProfile) {
        this.userAvatarType = currentProfile.userAvatarType;
        this.userAvatarValue = currentProfile.userAvatarValue;
        Logger.info('ChatPage', `ç”¨æˆ·å¤´åƒè®¾ç½®å·²æ›´æ–°: ${currentProfile.userAvatarType}, ${currentProfile.userAvatarValue}`);
      }
    } catch (error) {
      Logger.error('ChatPage', `é‡æ–°åŠ è½½å¤´åƒè®¾ç½®å¤±è´¥: ${error}`);
    }

    // é‡æ–°åŠ è½½å­—ä½“è®¾ç½®ï¼Œç¡®ä¿ä»è®¾ç½®é¡µé¢è¿”å›åå­—ä½“è®¾ç½®æ˜¯æœ€æ–°çš„
    try {
      Logger.info('ChatPage', 'é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ è½½å­—ä½“è®¾ç½®');
      const previousFontSettings = this.fontSettings;

      // ç›´æ¥ä»AppStorageè·å–æœ€æ–°å­—ä½“è®¾ç½®ï¼Œé¿å…FontManagerå¼‚æ­¥é€šçŸ¥å»¶è¿Ÿé—®é¢˜
      const latestFontSettings = await StorageManager.getFontSettings();

      Logger.info('ChatPage', `å½“å‰æœ¬åœ°å­—ä½“è®¾ç½®: ${JSON.stringify(previousFontSettings)}`);
      Logger.info('ChatPage', `AppStorageæœ€æ–°å­—ä½“è®¾ç½®: ${JSON.stringify(latestFontSettings)}`);

      this.fontSettings = latestFontSettings;

      // æ£€æŸ¥å­—ä½“è®¾ç½®æ˜¯å¦æœ‰å˜åŒ–
      if (previousFontSettings.chatFontSize !== this.fontSettings.chatFontSize ||
          previousFontSettings.codeFontSize !== this.fontSettings.codeFontSize ||
          previousFontSettings.fontFamily !== this.fontSettings.fontFamily) {
        Logger.info('ChatPage', `å­—ä½“è®¾ç½®å·²æ›´æ–°: ${JSON.stringify(this.fontSettings)}`);
      } else {
        Logger.info('ChatPage', 'å­—ä½“è®¾ç½®æœªå˜æ›´');
      }
    } catch (error) {
      Logger.error('ChatPage', `é‡æ–°åŠ è½½å­—ä½“è®¾ç½®å¤±è´¥: ${error}`);
    }

    // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æ¨¡å‹é…ç½®æ˜¯å¦è¿‡æœŸï¼Œæ¸…ç†è¿‡æœŸé…ç½®
    try {
      const isExpired = await StorageManager.isModelConfigExpired();
      if (isExpired) {
        Logger.info('ChatPage', 'æ£€æµ‹åˆ°æ¨¡å‹é…ç½®å·²è¿‡æœŸå¹¶å·²æ¸…ç†ï¼Œå°†é‡æ–°åŠ è½½providersä»¥åº”ç”¨é»˜è®¤é€‰æ‹©');
      }
    } catch (error) {
      Logger.warn('ChatPage', `æ£€æŸ¥æ¨¡å‹é…ç½®è¿‡æœŸå¤±è´¥: ${error}`);
    }

    // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½providersï¼ˆåªåœ¨æ˜ç¡®éœ€è¦æ—¶æ‰é‡æ–°åŠ è½½ï¼‰
    // æ£€æŸ¥æœåŠ¡å™¨é…ç½®æ˜¯å¦å˜æ›´
    const currentServerConfig = this.getCurrentServerConfigString();
    const serverConfigChanged = this.lastServerConfig && this.lastServerConfig !== currentServerConfig;
    
    // åªåœ¨ä»¥ä¸‹æƒ…å†µæ‰é‡æ–°åŠ è½½providersï¼š
    // 1. å¼ºåˆ¶åˆ·æ–°æ ‡è®°è¢«è®¾ç½®ï¼ˆç”¨æˆ·ä¸»åŠ¨è§¦å‘ï¼‰
    // 2. æœåŠ¡å™¨é…ç½®ç¡®å®å‘ç”Ÿäº†å˜æ›´
    const shouldReload = this.forceReloadProviders || serverConfigChanged;
    
    if (shouldReload) {
      const reason = this.forceReloadProviders ? 'ç”¨æˆ·ä¸»åŠ¨åˆ·æ–°' :
                    serverConfigChanged ? 'æœåŠ¡å™¨é…ç½®å˜æ›´' : 'æœªçŸ¥åŸå› ';
      
      Logger.info('ChatPage', `é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ è½½providers (åŸå› : ${reason})`);
      await this.chatViewModel.loadProviders();
      Logger.info('ChatPage', `Providerså·²æ›´æ–°ï¼Œå½“å‰æœ‰ ${this.chatViewModel.providers.length} ä¸ªå‚å•†`);
      
      this.lastProvidersReloadTime = Date.now();
      this.forceReloadProviders = false; // é‡ç½®å¼ºåˆ¶åˆ·æ–°æ ‡è®°
      this.lastServerConfig = currentServerConfig; // æ›´æ–°æœåŠ¡å™¨é…ç½®è®°å½•
    } else {
      Logger.debug('ChatPage', 'providersæ— éœ€é‡æ–°åŠ è½½ï¼Œé…ç½®æœªå˜æ›´');
      // ä»ç„¶æ›´æ–°é…ç½®è®°å½•ï¼Œç¡®ä¿ä¸‹æ¬¡æ¯”è¾ƒçš„å‡†ç¡®æ€§
      this.lastServerConfig = currentServerConfig;
    }
    
    // é¡µé¢æ˜¾ç¤ºæ—¶æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
    this.scrollToBottom();
  }

  aboutToDisappear(): void {
    this.chatViewModel.destroy();
    
    // ç§»é™¤ä¸»é¢˜ç›‘å¬å™¨
    this.themeManager.removeThemeListener((isDark: boolean) => {
      this.isDarkMode = isDark;
    });
    // ç§»é™¤æ²‰æµ¸å¼æ¨¡å¼ç›‘å¬å™¨
    this.themeManager.removeImmersiveListener((isImmersive: boolean) => {
      this.isImmersiveMode = isImmersive;
    });
    // ç§»é™¤å¤´åƒè®¾ç½®ç›‘å¬å™¨
    StorageManager.removeAvatarListener(this.avatarListener);
    // ç§»é™¤å­—ä½“è®¾ç½®ç›‘å¬å™¨
    this.fontManager.removeListener(this.fontSettingsListener);
    // æ¸…ç©ºè‡ªåŠ¨æ’­æŠ¥å›è°ƒï¼Œé¿å…é‡å¤æ³¨å†Œ
    this.autoTTSService.setCallbacks({});
    
    // ç§»é™¤è¾“å…¥æ³•çŠ¶æ€ç›‘å¬å™¨
    this.cleanupInputMethodListener();

    // åœæ­¢æ¶ˆæ¯å˜åŒ–æ£€æµ‹å®šæ—¶å™¨
    this.stopMessageChangeTimer();
  }

  onBackPress(): boolean | void {
    // å¤„ç†è¿”å›é”®ï¼Œé˜²æ­¢ç›´æ¥é€€å‡ºåº”ç”¨
    return this.handleBackPress();
  }

  build() {
    Stack() {
      // ä¸»é¡µé¢å†…å®¹
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ  - æ·»åŠ çŠ¶æ€æ é«˜åº¦é¿è®©
        Column() {
          this.buildNavigationBar()
        }
        .margin({ top: this.statusBarHeight })

        // åŠ è½½æŒ‡ç¤ºå™¨
        if (this.chatViewModel.isLoading && this.chatViewModel.messages.length === 0) {
          this.buildLoadingIndicator()
        } else {
          // èŠå¤©æ¶ˆæ¯åˆ—è¡¨
          this.buildMessageList()
        }

        // åº•éƒ¨è¾“å…¥åŒºåŸŸ
        this.buildInputArea()
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.background_color'))
      .onTouch((event) => {
        // å¦‚æœå¿«é€ŸæŒ‡ä»¤é¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œä¸å¤„ç†è¿™é‡Œçš„è§¦æ‘¸äº‹ä»¶ï¼Œé¿å…å¹²æ‰°
        if (this.showQuickCommands) {
          Logger.info('ChatPage', 'showQuickCommands=trueï¼Œè·³è¿‡ä¸»é¡µé¢è§¦æ‘¸å¤„ç†');
          return;
        }
        
        // å¦‚æœæ­£åœ¨æ»‘åŠ¨ä¾§è¾¹æ ï¼Œä¸å¤„ç†è§¦æ‘¸äº‹ä»¶
        if (this.isSideDrawerSwipeActive) {
          return;
        }
        
        // ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­è¾“å…¥æ³•ï¼Œä½†é¿å…å¹²æ‰°è¾“å…¥æ¡†æ“ä½œ
        if (event.type === TouchType.Up && this.shouldCloseInputMethod) {
          try {
            inputMethod.getController().stopInputSession();
          } catch (error) {
            Logger.error('ChatPage', `å…³é—­è¾“å…¥æ³•å¤±è´¥: ${error}`);
          }
        }
        // ç©ºç™½åŒºåŸŸè¢«ç‚¹å‡»åï¼Œé‡ç½®æ ‡è®°ä¸ºå…è®¸å…³é—­è¾“å…¥æ³•
        if (event.type === TouchType.Down) {
          this.shouldCloseInputMethod = true;
        }
      })

      if (this.voiceOverlayHint) {
        this.buildVoiceOverlayHint(this.voiceOverlayHint)
      }

      // æ¨¡å‹é€‰æ‹©ç»„ä»¶
      if (this.showModelSelector) {
        Column() {
          // é€æ˜é®ç½©å±‚
          Column() {}
          .layoutWeight(1)
          .width('100%')
          .backgroundColor('rgba(0, 0, 0, 0.0)')
          .opacity(this.modelSelectorOpacity)
          .onClick(() => {
            this.hideModelSelector();
          })

          // åŠæ¨¡æ€ç»„ä»¶
          ModelSelectorComponent({
            providers: this.chatViewModel.providers,
            currentProvider: this.chatViewModel.currentProvider,
            currentModel: this.chatViewModel.currentModel,
            onModelSelected: async (provider: string, model: string) => {
              await this.chatViewModel.switchModel(provider, model);
              this.hideModelSelector();
            },
            onClose: () => {
              this.hideModelSelector();
            },
            onConfigureAPIKeys: () => {
              router.pushUrl({ url: 'pages/APIKeyManagerPage' });
            },
            onReloadProviders: async () => {
              Logger.info('ChatPage', 'ç”¨æˆ·è¯·æ±‚é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨');
              try {
                await this.chatViewModel.loadProviders();
                Logger.info('ChatPage', `é‡æ–°åŠ è½½å®Œæˆï¼Œå½“å‰æœ‰ ${this.chatViewModel.providers.length} ä¸ªå‚å•†`);
              } catch (error) {
                Logger.error('ChatPage', `é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${error}`);
              }
            }
          })
            .borderRadius({ topLeft: 32, topRight: 32 })
            .translate({ y: this.modelSelectorTranslateY })
            .animation({
              duration: 400,
              curve: curves.springMotion(0.6, 0.8)
            })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.End)
        .borderRadius({ topLeft: 32, topRight: 32 })
      }


      
      // å¿«æ·æŒ‡ä»¤ç»„ä»¶ - ç¡®ä¿åœ¨å·¥å…·ç®±é¢æ¿ä¹‹ä¸Š
      if (this.showQuickCommands) {
        QuickCommandsComponent({
          commands: this.getQuickCommands(),
          phrases: [],
          onClose: () => {
            this.showQuickCommands = false;
          },
          onPromptSelected: (prompt: string) => {
            this.handlePromptSelected(prompt);
          }
        })
      }

      // ä¾§æ»‘æŠ½å±‰ç»„ä»¶ - ç§»åˆ°æœ€åç¡®ä¿åœ¨æœ€é¡¶å±‚
      if (this.showSideDrawer) {
        SideDrawerComponent({
          onClose: () => {
            this.showSideDrawer = false;
            // å¹³æ»‘é‡ç½®æ»‘åŠ¨è¿›åº¦ï¼Œä½¿ç”¨æ›´å¹³æ»‘çš„åŠ¨ç”»å‚æ•°å‡å°‘æŠ–åŠ¨
            animateTo({
              duration: 250,
              curve: Curve.EaseOut
            }, () => {
              this.sideDrawerSwipeProgress = 0;
            });
          },
          onSessionSwitched: () => {
            // ä¼šè¯åˆ‡æ¢æˆåŠŸåæ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            this.scrollToBottom();
          },
          chatViewModel: this.chatViewModel,
          sessions: this.chatViewModel.sessions, // å•ç‹¬ä¼ é€’sessionsæ•°ç»„ç¡®ä¿å“åº”å¼æ›´æ–°
          systemPrompts: this.chatViewModel.systemPrompts, // ä¼ é€’ç³»ç»Ÿæç¤ºè¯åˆ—è¡¨ç”¨äºæ˜¾ç¤º
          swipeProgress: this.sideDrawerSwipeProgress,
          isSwipeActive: this.isSideDrawerSwipeActive,
          onSessionSwipeStateChange: (isSwiping: boolean) => {
            this.handleSessionSwipeStateChange(isSwiping);
          }
        })
      }

      // å·¦ä¾§æ»‘åŠ¨æç¤ºæ¡ï¼ˆåªåœ¨æœªæ˜¾ç¤ºä¾§è¾¹æ æ—¶æ˜¾ç¤ºï¼‰
      if (!this.showSideDrawer && !this.isSideDrawerSwipeActive) {
        Column()
          .width(4)
          .height(60)
          .backgroundColor($r('app.color.primary_color'))
          .position({ x: 0, y: '50%' })
          .translate({ y: -30 })
          .borderRadius({ topRight: 2, bottomRight: 2 })
          .opacity(0.3)
      }
      
            
      // æœç´¢è¯¦æƒ…å¼¹æ¡† - æ”¯æŒå†…å®¹é€‰ä¸­å¤åˆ¶
      SearchDetailsDialog({
        isVisible: this.showSearchDetailsDialog,
        content: this.searchDetailsContent,
        onClose: () => {
          this.hideSearchDetailsDialog();
        }
      })
            
      // æ·±åº¦æ€è€ƒå¯¹è¯æ¡† - åœ¨æœ€é¡¶å±‚æ˜¾ç¤º
      DeepThinkingDialog({
        isShowing: this.showThinkingDialog,
        message: this.thinkingDialogMessage,
        onClose: () => {
          this.hideDeepThinkingDialog();
        },
        onShowDetails: (step) => {
          this.handleThinkingStepTap(step);
        }
      })
    }
    .width('100%')
    .height('100%')
    .onTouch((event) => {
      // å¦‚æœå¿«é€ŸæŒ‡ä»¤é¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œä¸å¤„ç†è¿™é‡Œçš„è§¦æ‘¸äº‹ä»¶ï¼Œé¿å…å¹²æ‰°
      if (this.showQuickCommands) {
        return;
      }
      
      // å¦‚æœæ­£åœ¨æ»‘åŠ¨ä¾§è¾¹æ ï¼Œä¸å¤„ç†è§¦æ‘¸äº‹ä»¶
      if (this.isSideDrawerSwipeActive) {
        return;
      }
      
      // å¦‚æœå·¥å…·ç®±é¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­é¢æ¿
      if (this.showToolboxPanel && event.type === TouchType.Up) {
        this.hideToolboxPanel();
        return;
      }
      
      // ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­è¾“å…¥æ³•ï¼Œä½†é¿å…å¹²æ‰°è¾“å…¥æ¡†æ“ä½œ
      if (event.type === TouchType.Up && this.shouldCloseInputMethod) {
        try {
          inputMethod.getController().stopInputSession();
        } catch (error) {
          Logger.error('ChatPage', `å…³é—­è¾“å…¥æ³•å¤±è´¥: ${error}`);
        }
      }
      // ç©ºç™½åŒºåŸŸè¢«ç‚¹å‡»åï¼Œé‡ç½®æ ‡è®°ä¸ºå…è®¸å…³é—­è¾“å…¥æ³•
      if (event.type === TouchType.Down) {
        this.shouldCloseInputMethod = true;
      }
    })
    .gesture(
      PanGesture({ fingers: 1, direction: PanDirection.Horizontal, distance: 5 })
        .onActionStart((event: GestureEvent) => {
          if (this.showQuickCommands) {
            return;
          }
          this.handleSideDrawerSwipeStart(event);
        })
        .onActionUpdate((event: GestureEvent) => {
          if (this.showQuickCommands) {
            return;
          }
          this.handleSideDrawerSwipeUpdate(event);
        })
        .onActionEnd((event: GestureEvent) => {
          if (this.showQuickCommands) {
            return;
          }
          this.handleSideDrawerSwipeEnd(event);
        })
    )
    // .bindSheet($$this.showPromptSelector, this.systemPromptSheetBuilder(), { // å·²æ³¨é‡Šï¼šä¸å†ä½¿ç”¨ç³»ç»Ÿæç¤ºè¯é€‰æ‹©å™¨
    //   height: '70%',
    //   dragBar: true,
    //   backgroundColor: $r('app.color.surface_color')
    // })
  }

  @Builder
  buildModelSelectorButton() {
    Row({ space: 6 }) {
      // å‚å•†å›¾æ ‡
      Circle({ width: 20, height: 20 })
        .fill(this.getProviderColor())
      
      // æ¨¡å‹ä¿¡æ¯
      Column({ space: 1 }) {
        Text(this.getShortModelName())
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Text(this.getProviderDisplayName())
          .fontSize(10)
          .fontColor($r('app.color.text_secondary'))
          .maxLines(1)
      }
      .alignItems(HorizontalAlign.Start)
      .constraintSize({ maxWidth: 60 })
      
      // ä¸‹æ‹‰ç®­å¤´
      Text('â–¼')
        .fontSize(10)
        .fontColor($r('app.color.text_secondary'))
    }
    .height(36)
    .padding({ left: 6, right: 6 })
    .backgroundColor($r('app.color.input_background'))
    .borderRadius(18)
    .border({
      width: 1,
      color: $r('app.color.border_color')
    })
    .onClick(() => {
      this.showModelSelectorMethod();
    })
  }

  @Builder
  private buildNavigationIcon(
    symbol: string,
    onClick: () => void,
    options: NavigationIconOptions = {}
  ) {
    Button() {
      Text(symbol)
        .fontSize(14)
        .fontColor((options.active ?? false) ?
          (options.activeColor ?? $r('app.color.primary_color')) :
          (options.inactiveColor ?? $r('app.color.text_secondary')))
    }
    .width(32)
    .height(32)
    .backgroundColor(Color.Transparent)
    .borderWidth(1)
    .borderColor((options.active ?? false) ?
      (options.activeBorderColor ?? (options.activeColor ?? $r('app.color.primary_color'))) :
      (options.inactiveBorderColor ?? $r('app.color.border_color')))
    .borderRadius(16)
    .onClick(onClick)
  }

  @Builder
  buildPromptSelectorButton() {
    Row({ space: 6 }) {
      // æç¤ºè¯å›¾æ ‡
      Text('ğŸ¯')
        .fontSize(14)
        .fontColor($r('app.color.text_primary'))
      
      // æç¤ºè¯ä¿¡æ¯
      Column({ space: 1 }) {
        Text('ç³»ç»Ÿæç¤ºè¯')
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        
        Text('ç³»ç»Ÿæç¤ºè¯')
          .fontSize(10)
          .fontColor($r('app.color.text_secondary'))
          .maxLines(1)
      }
      .alignItems(HorizontalAlign.Start)
      .constraintSize({ maxWidth: 80 })
      
      // ä¸‹æ‹‰ç®­å¤´
      Text('â–¼')
        .fontSize(10)
        .fontColor($r('app.color.text_secondary'))
    }
    .height(36)
    .padding({ left: 8, right: 8 })
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(18)
    .margin({ left: 8 })
  }


  @Builder
  private buildVoiceOverlayHint(hint: VoiceOverlayHint) {
    Column() {
      Text(hint.text)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.getVoiceOverlayTextColor(hint))
        .textAlign(TextAlign.Center)
        .padding({ left: 20, right: 20, top: 12, bottom: 12 })
        .backgroundColor(this.getVoiceOverlayBackgroundColor(hint))
        .borderRadius(18)
        .opacity(0.94)
        .shadow({
          radius: 8,
          color: 'rgba(0, 0, 0, 0.25)',
          offsetY: 4
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .hitTestBehavior(2)
  }

  private getVoiceOverlayBackgroundColor(hint: VoiceOverlayHint): string {
    switch (hint.tone) {
      case 'warning':
        return 'rgba(255, 77, 79, 0.92)';
      case 'processing':
        return this.isDarkMode ? 'rgba(116, 185, 255, 0.9)' : 'rgba(52, 152, 219, 0.9)';
      default:
        return this.isDarkMode ? 'rgba(0, 0, 0, 0.85)' : 'rgba(0, 0, 0, 0.72)';
    }
  }

  private getVoiceOverlayTextColor(_: VoiceOverlayHint): string {
    return '#FFFFFF';
  }

  @Builder
  buildLoadingIndicator() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .margin({ bottom: 16 })
      Text('æ­£åœ¨åŠ è½½æ¨¡å‹...')
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
    }
    .justifyContent(FlexAlign.Center)
    .width('100%')
    .height('100%')
    .layoutWeight(1)
  }

  @Builder
  buildNavigationBar() {
    Row({ space: 12 }) {
      // å·¦ä¾§ï¼šä¼šè¯æŠ½å±‰å…¥å£
      Button() {
        Text('â˜°')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
      }
      .width(32)
      .height(32)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.showSideDrawer = true;
      })

      Blank()

      // å³ä¾§ï¼šåŠŸèƒ½æŒ‰é’®ç»„
      Row({ space: 8 }) {
        this.buildNavigationIcon(this.isMuted ? 'ğŸ¤«' : 'ğŸ—£ï¸', () => {
          void this.toggleMute();
        }, {
          active: this.isMuted,
          activeColor: $r('app.color.error_color'),
          inactiveColor: $r('app.color.text_primary')
        })

        this.buildNavigationIcon('âš¡', () => {
          if (this.showToolboxPanel) {
            this.hideToolboxPanel();
          }
          this.showQuickCommands = true;
        }, {
          active: this.showQuickCommands,
          activeColor: $r('app.color.primary_color'),
          inactiveColor: $r('app.color.primary_color'),
          inactiveBorderColor: $r('app.color.primary_color')
        })

        Row() {
          this.buildModelSelectorButton()
        }
        .alignItems(VerticalAlign.Center)

        this.buildNavigationIcon('â‹®', () => {
          router.pushUrl({ url: 'pages/SettingsPage' });
        })
      }
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('app.color.surface_color'))
    .alignItems(VerticalAlign.Center)
    .shadow({
      radius: 4,
      color: '#1F000000',
      offsetY: 2
    })
  }

  @Builder
  buildMessageList() {
    List({ space: 8, scroller: this.listScroller }) {
      ForEach(this.chatViewModel.messages, (message: Message, index: number) => {
        ListItem() {
          this.buildMessageItem(message)
        }
        .width('100%')
        .transition(TransitionEffect.asymmetric(
          TransitionEffect.OPACITY.animation({
            duration: BasicAnimations.STANDARD_DURATION,
            curve: Curve.EaseInOut
          }).combine(TransitionEffect.translate({ x: message.role === MessageRole.USER ? 50 : -50, y: 0 })),
          TransitionEffect.OPACITY.animation({
            duration: BasicAnimations.QUICK_DURATION,
            curve: Curve.EaseInOut
          }).combine(TransitionEffect.translate({ x: message.role === MessageRole.USER ? -50 : 50, y: 0 }))
        ))
      }, (message: Message) => message.id)
    }
    .width('100%')
    .layoutWeight(1)
    .padding(16)
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }

  @Builder
  buildMessageItem(message: Message) {
    if (this.useModernMessageLayout) {
      this.buildModernMessageItem(message);
    } else {
      this.buildTraditionalMessageItem(message);
    }
  }

  @Builder
  buildTraditionalMessageItem(message: Message) {
    Row() {
      if (message.role === MessageRole.USER) {
        Blank()
        
        Column() {
          Text(message.content.trim())
            .fontSize(this.fontSettings.chatFontSize)
            .fontColor(Color.White)
            .textAlign(TextAlign.Start)
            .maxLines(100)
            .copyOption(CopyOptions.InApp)
        }
        .backgroundColor($r('app.color.primary_color'))
        .borderRadius(12)
        .padding(12)
        .constraintSize({ maxWidth: '70%' })
        
        Column() {
          this.buildUserAvatar()
        }
        .margin({ left: 8 })
      } else {
        // AIåŠ©æ‰‹æ¶ˆæ¯ - ä¼ ç»Ÿå¸ƒå±€ï¼šå¤´åƒåœ¨å·¦ä¾§ï¼Œæ¶ˆæ¯åœ¨å³ä¾§
        Row() {
          // å·¦ä¾§å¤´åƒ
          Column() {
            this.buildAIAvatar()
          }
          .margin({ right: 8 })
          .width(36)
          .height(36)
          
          // å³ä¾§æ¶ˆæ¯å†…å®¹åŒºåŸŸ
          Column() {
            // æ¶ˆæ¯å¤´éƒ¨ï¼šè§’è‰²æ ‡ç­¾å’ŒéŸ³é¢‘æŒ‰é’®
            Row() {
              Text(`${message.isDeepThinking ? 'ğŸ§  ' : ''}${this.chatViewModel.getCurrentSessionSystemPrompt()?.name || 'AIåŠ©æ‰‹'}`)
                .fontSize(13)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.modern_role_label'))
              
              // è¯­éŸ³æ’­æŠ¥æŒ‰é’® - åªæœ‰assistantæ¶ˆæ¯ä¸”ä¸åœ¨åŠ è½½ä¸­æ‰æ˜¾ç¤º
              if (message.canPlayAudio && !message.isLoading) {
                Button() {
                  Text(message.isPlaying ? 'ğŸ”‡' : 'ğŸ”Š')
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                }
                .width(32)
                .height(32)
                .backgroundColor(message.isPlaying ? $r('app.color.error_color') : $r('app.color.surface_color'))
                .borderRadius(16)
                .border({
                  width: 1,
                  color: message.isPlaying ? $r('app.color.error_color') : $r('app.color.border_color')
                })
                .margin({ left: 8 })
                .onClick(() => {
                  this.toggleMessageAudio(message);
                })
              }
            }
            .width('100%')
            .margin({ bottom: 4 })
            
            this.buildDeepThinkingInlineStatus(message, '70%')
            
            // æ¶ˆæ¯å†…å®¹æ°”æ³¡
          Column() {
            if (message.isLoading) {
              this.buildLoadingStatus(this.enableDeepThinking ? 'ğŸ§  AIæ­£åœ¨æ·±åº¦åˆ†æï¼Œè¯·ç¨å€™...' : 'AIæ­£åœ¨æ€è€ƒ...')
            } else if (message.toolStatus === 'calling') {
              this.buildLoadingStatus('ğŸ” æ­£åœ¨æœç´¢ç½‘ç»œä¿¡æ¯...', true)
            } else {
              Column() {
                  // æ¶ˆæ¯å†…å®¹
                  Text(message.content.trim())
                    .fontSize(this.fontSettings.chatFontSize)
                    .fontColor($r('app.color.text_primary'))
                    .textAlign(TextAlign.Start)
                    .maxLines(100)
                    .copyOption(CopyOptions.InApp)

                  // ç½‘ç»œæœç´¢æ ‡è¯†
                  if (message.webUsed && message.searchInfo) {
                    Row() {
                      Row() {
                        Text('ğŸ”')
                          .fontSize(12)
                          .animation({
                            duration: message.toolStatus === 'calling' ? 1000 : 0,
                            curve: Curve.EaseInOut,
                            iterations: message.toolStatus === 'calling' ? -1 : 1,
                            playMode: PlayMode.Alternate
                          })
                        Text('ç½‘ç»œæœç´¢')
                          .fontSize(12)
                          .fontWeight(FontWeight.Medium)
                          .fontColor($r('app.color.primary_color'))
                      }
                      .padding({ right: 8 })

                      // æˆªæ–­æ˜¾ç¤ºæœç´¢ä¿¡æ¯
                      Text(this.truncateSearchInfo(message.searchInfo ?? ""))
                        .fontSize(12)
                        .fontColor($r('app.color.text_secondary'))
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                    }
                    .margin({ top: 8 })
                    .padding({ top: 6, bottom: 6, left: 12, right: 12 })
                    .backgroundColor($r('app.color.card_background'))
                    .borderRadius(16)
                    .border({
                      width: 1,
                      color: $r('app.color.primary_color')
                    })
                    .shadow({
                      radius: 2,
                      color: '#1A000000',
                      offsetY: 1
                    })
                    .onClick((event) => {
                      // ç‚¹å‡»æœç´¢æ ‡è¯†æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯æ°”æ³¡
                      Logger.info('ChatPage', `æœç´¢æ ‡è¯†è¢«ç‚¹å‡»ï¼ŒsearchDetailså­˜åœ¨: ${!!message.searchDetails}, é•¿åº¦: ${message.searchDetails?.length || 0}`);
                      Logger.info('ChatPage', `ç‚¹å‡»ä½ç½®: (${event.displayX}, ${event.displayY})`);
                      
                      if (message.searchDetails) {
                        Logger.info('ChatPage', 'å‡†å¤‡æ˜¾ç¤ºæœç´¢è¯¦æƒ…æ°”æ³¡');
                        this.showSearchInfoBubble(message.searchDetails);
                      } else {
                        Logger.info('ChatPage', 'searchDetailsä¸ºç©ºï¼Œä¸æ˜¾ç¤ºæ°”æ³¡');
                      }
                    })
                  }
                }
              }
            }
            .backgroundColor($r('app.color.card_background'))
            .borderRadius(12)
            .padding(12)
            .constraintSize({ maxWidth: '70%' })
            .shadow({
              radius: 2,
              color: '#1A000000',
              offsetY: 1
            })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
        }
        .alignItems(VerticalAlign.Top)
        
        Blank()
      }
    }
    .width('100%')
    .margin({ bottom: 8 })
    .alignItems(VerticalAlign.Top)
  }

  @Builder
  private buildDeepThinkingInlineStatus(message: Message, maxWidth: string) {
    if (!message.isDeepThinking) {
      Blank();
    } else {
      DeepThinkingStatusCard({
        message: message,
        onShowDetails: () => {
          this.showDeepThinkingDialog(message);
        },
        onStop: () => {
          this.chatViewModel.stopDeepThinking(message.id);
        }
      })
        .constraintSize({ maxWidth: maxWidth })
        .width(maxWidth)
        .margin({ bottom: 8 })
    }
  }

  @Builder
  buildModernMessageItem(message: Message) {
    Column() {
      // æ¶ˆæ¯å¤´éƒ¨ï¼šè§’è‰² + å¤´åƒ
      Row() {
        if (message.role === MessageRole.USER) {
          Blank()
          
          Text('Javis')
            .fontSize(13)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.modern_role_label'))
            .margin({ right: 8 })
          
          this.buildUserAvatar()
        } else {
          Row() {
            this.buildAIAvatar()
            
            Text(`${message.isDeepThinking ? 'ğŸ§  ' : ''}${this.chatViewModel.getCurrentSessionSystemPrompt()?.name || 'AIåŠ©æ‰‹'}`)
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.modern_role_label'))
              .margin({ left: 8 })
            
            // è¯­éŸ³æ’­æŠ¥æŒ‰é’® - åªæœ‰assistantæ¶ˆæ¯ä¸”ä¸åœ¨åŠ è½½ä¸­æ‰æ˜¾ç¤º
            if (message.canPlayAudio && !message.isLoading) {
              Button() {
                Text(message.isPlaying ? 'ğŸ”‡' : 'ğŸ”Š')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
              }
              .width(32)
              .height(32)
              .backgroundColor(message.isPlaying ? $r('app.color.error_color') : $r('app.color.surface_color'))
              .borderRadius(16)
              .border({
                width: 1,
                color: message.isPlaying ? $r('app.color.error_color') : $r('app.color.border_color')
              })
              .margin({ left: 8 })
              .onClick(() => {
                this.toggleMessageAudio(message);
              })
            }
            
            Blank()
          }
        }
      }
      .width('100%')
      .margin({ bottom: 6 })
      
      // æ¶ˆæ¯å†…å®¹åŒºåŸŸ
      Column() {
        if (message.role === MessageRole.USER) {
          // ç”¨æˆ·æ¶ˆæ¯å†…å®¹ - å³å¯¹é½
          Row() {
            Blank()
            
            Text(message.content.trim())
              .fontSize(this.fontSettings.chatFontSize)
              .fontColor($r('app.color.text_primary'))
              .textAlign(TextAlign.Start)
              .maxLines(100)
              .copyOption(CopyOptions.InApp)
              .padding(14)
              .backgroundColor($r('app.color.modern_user_background'))
              .borderRadius(12)
              .border({
                width: 1,
                color: $r('app.color.border_color')
              })
              .constraintSize({ maxWidth: '82%' })
              .shadow({
                radius: 2,
                color: 'rgba(0, 0, 0, 0.06)',
                offsetY: 1
              })
          }
          .width('100%')
        } else {
          // AIæ¶ˆæ¯å†…å®¹
          Row() {
            Column() {
              this.buildDeepThinkingInlineStatus(message, '80%')
              if (message.isLoading) {
                this.buildLoadingStatus(this.enableDeepThinking ? 'ğŸ§  AIæ­£åœ¨æ·±åº¦åˆ†æï¼Œè¯·ç¨å€™...' : 'AIæ­£åœ¨æ€è€ƒ...')
              } else if (message.toolStatus === 'calling') {
                this.buildLoadingStatus('ğŸ” æ­£åœ¨æœç´¢ç½‘ç»œä¿¡æ¯...', true)
              } else {
                Column() {
                  // å·¥å…·è°ƒç”¨çŠ¶æ€å±•ç¤º
                  ToolCallStatusComponent({
                    message: message,
                    onSearchDetailsClick: (searchDetails: string) => {
                      this.showSearchInfoBubble(searchDetails);
                    }
                  })

                  // æ™ºèƒ½æ¸²æŸ“çš„æ¶ˆæ¯å†…å®¹
                  SmartTextRenderer({
                    content: message.content.trim(),
                    fontSettings: this.fontSettings
                  })
                }
              }
            }
            .padding(14)
            .backgroundColor($r('app.color.modern_ai_background'))
            .borderRadius(12)
            .border({
              width: 1,
              color: $r('app.color.border_color')
            })
            .constraintSize({ maxWidth: '82%' })
            .shadow({
              radius: 3,
              color: 'rgba(0, 0, 0, 0.08)',
              offsetY: 1
            })
            
            Blank()
          }
          .width('100%')
        }
      }
      .width('100%')
      
      // åˆ†éš”çº¿
      Divider()
        .strokeWidth(1)
        .color($r('app.color.modern_separator'))
        .opacity(0.6)
        .margin({ top: 16, bottom: 4 })
    }
    .width('100%')
    .padding({ left: 12, right: 12, top: 12, bottom: 8 })
  }

  @Builder
  buildInputArea() {
    Column() {
      // åŠŸèƒ½æŒ‰é’®è¡Œï¼ˆæ·±åº¦æ€è€ƒå’Œè”ç½‘æœç´¢ï¼‰
      Row({ space: 8 }) {
        // æ·±åº¦æ€è€ƒæŒ‰é’®
        Button() {
          Row({ space: 4 }) {
            Text('ğŸ§ ')
              .fontSize(16)
            Circle()
              .width(8)
              .height(8)
              .fill(this.enableDeepThinking ? '#FF6B35' : '#666666')
              .opacity(this.enableDeepThinking ? 1.0 : 0.5)
          }
        }
        .width(44)
        .height(32)
        .backgroundColor(this.enableDeepThinking ? 'rgba(255, 107, 53, 0.15)' : $r('app.color.input_background'))
        .borderRadius(16)
        .border({
          width: 1,
          color: this.enableDeepThinking ? '#FF6B35' : $r('app.color.border_color')
        })
        .stateStyles({
          normal: {
            .scale({ x: 1.0, y: 1.0 })
          },
          pressed: {
            .scale({ x: 0.95, y: 0.95 })
          }
        })
        .animation({
          duration: 150,
          curve: Curve.EaseInOut
        })
        .onClick(() => {
          this.toggleDeepThinking();
        })

        // è”ç½‘æœç´¢æŒ‰é’®
        Button() {
          Row({ space: 4 }) {
            Text('ğŸŒ')
              .fontSize(16)
            Circle()
              .width(8)
              .height(8)
              .fill(this.enableWebSearch ? '#27AE60' : '#666666')
              .opacity(this.enableWebSearch ? 1.0 : 0.5)
          }
        }
        .width(44)
        .height(32)
        .backgroundColor(this.enableWebSearch ? 'rgba(39, 174, 96, 0.15)' : $r('app.color.input_background'))
        .borderRadius(16)
        .border({
          width: 1,
          color: this.enableWebSearch ? '#27AE60' : $r('app.color.border_color')
        })
        .stateStyles({
          normal: {
            .scale({ x: 1.0, y: 1.0 })
          },
          pressed: {
            .scale({ x: 0.95, y: 0.95 })
          }
        })
        .animation({
          duration: 150,
          curve: Curve.EaseInOut
        })
        .onClick(() => {
          this.toggleWebSearch();
        })

        Blank()
          .layoutWeight(1)

        // å·¥å…·ç®±å…¥å£æŒ‰é’®
        Button() {
          Row({ space: 6 }) {
            Text('ğŸ§°')
              .fontSize(14)
          }
          .justifyContent(FlexAlign.Center)
          .alignItems(VerticalAlign.Center)
        }
        .height(32)
        .padding({ left: 14, right: 14 })
        .backgroundColor('rgba(116, 185, 255, 0.18)')
        .borderRadius(16)
        .border({
          width: 1,
          color: '#74B9FF'
        })
        .stateStyles({
          normal: {
            .scale({ x: 1.0, y: 1.0 })
          },
          pressed: {
            .scale({ x: 0.95, y: 0.95 })
          }
        })
        .animation({
          duration: 150,
          curve: Curve.EaseInOut
        })
        .onClick(() => {
          this.showToolboxPanelMethod();
        })
      }
      .width('95%')
      .margin({ left: 16, right: 16, bottom: 4 })

      // å½“å‰ä¼šè¯ç»‘å®šçš„ç³»ç»Ÿæç¤ºè¯å±•ç¤ºåŒºåŸŸï¼ˆåªè¯»ï¼‰
      // Column() {
      //   this.buildCurrentSessionPromptDisplay()
      // }
      // .width('95%')
      // .margin({ left: 16, right: 16, bottom: 4 })
      
      // ä¸»è¦è¾“å…¥åŒºåŸŸå®¹å™¨ - æ•´ä½“ç§»åŠ¨
      Column() {
        // ä¸»è¾“å…¥è¡Œ - åŒ…å«è¾“å…¥æ¡†å’ŒæŒ‰é’®
        Row() {
          if (this.voiceInputMode === InputMode.TEXT) {
            TextArea({ 
              placeholder: this.getInputPlaceholder(), 
              text: this.inputText 
            })
              .layoutWeight(1)
              .height(this.inputAreaHeight)
              .backgroundColor($r('app.color.input_background'))
              .borderRadius(18)
              .padding({ left: 14, right: 14, top: 10, bottom: 10 })
              .border({
                width: 1,
                color: this.voiceRecognitionState === VoiceRecognitionState.RECORDING 
                  ? $r('app.color.primary_color') 
                  : $r('app.color.border_color')
              })
              .wordBreak(WordBreak.BREAK_WORD)
              .copyOption(CopyOptions.InApp)
              .onChange((value: string) => {
                this.inputText = value;
                // åŠ¨æ€è®¡ç®—å¹¶æ›´æ–°é«˜åº¦
                const newHeight = this.calculateInputHeight(value);
                if (this.inputAreaHeight !== newHeight) {
                  this.inputAreaHeight = newHeight;
                }
              })
              .onTouch((event: TouchEvent) => {
                // è¾“å…¥æ¡†è¢«è§¦æ‘¸æ—¶ï¼Œé˜»æ­¢å…¨å±€å…³é—­è¾“å…¥æ³•
                this.shouldCloseInputMethod = false;
              })
              .onFocus(() => {
                // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ï¼Œè®¾ç½®é”®ç›˜é«˜åº¦æ¨¡æ‹Ÿå€¼
                this.keyboardHeight = 300; // æ¨¡æ‹Ÿé”®ç›˜é«˜åº¦
                Logger.debug('ChatPage', 'è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹ï¼Œè®¾ç½®é”®ç›˜æ˜¾ç¤ºçŠ¶æ€');
              })
              .onBlur(() => {
                // è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œé‡ç½®é”®ç›˜é«˜åº¦
                this.keyboardHeight = 0;
                Logger.debug('ChatPage', 'è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ï¼Œæ¸…é™¤é”®ç›˜æ˜¾ç¤ºçŠ¶æ€');
              })
          }

          // è¯­éŸ³è¾“å…¥æŒ‰é’®
          if (this.showVoiceInput) {
            VoiceInputComponent({
              onVoiceResult: this.handleVoiceComponentResult,
              onStateChange: this.handleVoiceComponentStateChange,
              onSmartPromptTriggered: this.handleVoiceComponentSmartPrompt,
              onInputModeChange: this.handleVoiceComponentModeChange,
              onHintChange: this.handleVoiceComponentHintChange
            })
              .margin({ left: this.voiceInputMode === InputMode.TEXT ? 6 : 0 })
              .width(this.voiceInputMode === InputMode.VOICE ? '100%' : 40)
              .layoutWeight(this.voiceInputMode === InputMode.VOICE ? 1 : 0)
          }

          Button() {
            Image($r('app.media.ic_send'))
              .width(18)
              .height(18)
              .fillColor(Color.White)
          }
          .width(38)
          .height(36)
          .backgroundColor(
            this.voiceInputMode === InputMode.TEXT && this.inputText.trim()
              ? $r('app.color.primary_color')
              : $r('app.color.border_color')
          )
          .borderRadius(18)
          .margin({ left: 6 })
          .enabled(
            this.voiceInputMode === InputMode.TEXT &&
            this.inputText.trim().length > 0 &&
            !this.chatViewModel.isLoading
          )
          .animation({
            duration: BasicAnimations.QUICK_DURATION,
            curve: Curve.EaseInOut
          })
          .onClick(() => {
            this.sendMessage();
          })
        }
        .width('100%')
        .padding({ left: 12, right: 12, top: 4, bottom: 6 })
        .onTouch((event) => {
          // æ•´ä¸ªè¾“å…¥åŒºåŸŸéƒ½ä¸åº”è¯¥è§¦å‘å…¨å±€çš„è¾“å…¥æ³•å…³é—­
          this.shouldCloseInputMethod = false;
          
          // å¦‚æœåœ¨è¾“å…¥åŒºåŸŸå†…å¼€å§‹æ»‘åŠ¨ï¼Œåœæ­¢ä¾§è¾¹æ æ»‘åŠ¨æ£€æµ‹
          if (event.type === TouchType.Down && this.isSideDrawerSwipeActive) {
            this.isSideDrawerSwipeActive = false;
            this.sideDrawerSwipeProgress = 0;
          }
        })
        
        // å·¥å…·ç®±é¢æ¿ - ç´§è´´åœ¨è¾“å…¥åŒºåŸŸä¸‹æ–¹
        if (this.showToolboxPanel) {
          Column() {
            // æ‹–æ‹½æŒ‡ç¤ºå™¨
            Row() {
              Column()
                .width(36)
                .height(4)
                .backgroundColor(this.isDarkMode ? '#555555' : '#E0E0E0')
                .borderRadius(2)
            }
            .width('100%')
            .height(20)
            .justifyContent(FlexAlign.Center)
            
            // å·¥å…·åˆ—è¡¨
            Column({ space: 0 }) {
              ForEach(this.getToolboxItems(), (item: ToolboxItem) => {
                this.buildToolboxItem(item);
              }, (item: ToolboxItem) => item.id);
            }
            .width('100%')
            .padding({ bottom: 8 })
          }
          .width('100%')
          .backgroundColor(this.isDarkMode ? '#2C2C2C' : '#FFFFFF')
          .borderRadius({
            topLeft: 20,
            topRight: 20
          })
          .shadow({
            radius: 12,
            color: 'rgba(0, 0, 0, 0.15)',
            offsetX: 0,
            offsetY: -4
          })
          .margin({ top: 4 })
          .opacity(this.toolboxPanelOpacity)
          .translate({ y: this.toolboxPanelTranslateY })
        }
      }
      .width('100%')
    }
    .backgroundColor($r('app.color.surface_color'))
    .constraintSize({ minHeight: 100, maxHeight: this.showToolboxPanel ? 450 : 300 })
    .padding({ top: 2, bottom: this.showToolboxPanel ? 6 : 12 })
  }

  /**
   * å¤„ç†ä¾§è¾¹æ æ»‘åŠ¨å¼€å§‹
   */
  private handleSideDrawerSwipeStart(event: GestureEvent): void {
    // å¦‚æœæœ‰å…¶ä»–å¼¹çª—æ‰“å¼€ï¼Œä¸å“åº”æ»‘åŠ¨
    if (this.showModelSelector || this.showQuickCommands) {
      return;
    }
    
    // å¦‚æœé”®ç›˜æ­£åœ¨æ˜¾ç¤ºï¼ˆé”®ç›˜é«˜åº¦å¤§äº0ï¼‰ï¼Œä¸å¤„ç†ä¾§è¾¹æ æ»‘åŠ¨æ‰‹åŠ¿
    if (this.keyboardHeight > 0) {
      Logger.debug('ChatPage', `é”®ç›˜æ­£åœ¨æ˜¾ç¤º(é«˜åº¦:${this.keyboardHeight})ï¼Œä¸å¤„ç†ä¾§è¾¹æ æ»‘åŠ¨æ‰‹åŠ¿`);
      return;
    }
    
    // å¦‚æœä¼šè¯é¡¹æ­£åœ¨æ»‘åŠ¨ï¼Œä¸å¤„ç†ä¾§è¾¹æ æ»‘åŠ¨æ‰‹åŠ¿
    if (this.isSessionItemSwiping) {
      Logger.debug('ChatPage', 'ä¼šè¯é¡¹æ­£åœ¨æ»‘åŠ¨ï¼Œä¸å¤„ç†ä¾§è¾¹æ æ»‘åŠ¨æ‰‹åŠ¿');
      return;
    }
    
    // å¦‚æœæ»‘åŠ¨å¼€å§‹ä½ç½®åœ¨ä¾§è¾¹æ ä¸­å¤®åŒºåŸŸï¼ˆé®ç½©å±‚ç‚¹å‡»åŒºåŸŸï¼‰ï¼Œä¸å¤„ç†æ»‘åŠ¨
    const startX = event.fingerList[0]?.globalX || 0;
    const startY = event.fingerList[0]?.globalY || 0;
    const screenWidth = 360; // å¤§æ¦‚çš„å±å¹•å®½åº¦ï¼Œå®é™…åº”è¯¥åŠ¨æ€è·å–
    if (this.showSideDrawer && startX > 280) {
      // ç‚¹å‡»åœ¨é®ç½©åŒºåŸŸï¼Œä¸å¤„ç†ä¸ºæ»‘åŠ¨æ‰‹åŠ¿
      Logger.debug('ChatPage', 'ç‚¹å‡»åœ¨é®ç½©åŒºåŸŸï¼Œä¸å¤„ç†æ»‘åŠ¨æ‰‹åŠ¿');
      return;
    }
    
    // é˜²æŠ–æ£€æŸ¥ï¼šå¦‚æœæ­£åœ¨é˜²æŠ–ä¸­ï¼Œå¿½ç•¥æ­¤æ¬¡æ»‘åŠ¨
    const currentTime = Date.now();
    if (this.isSwipeDebouncing && (currentTime - this.lastSwipeTime) < this.SWIPE_DEBOUNCE_TIME) {
      Logger.debug('ChatPage', 'æ»‘åŠ¨é˜²æŠ–ä¸­ï¼Œå¿½ç•¥æ­¤æ¬¡æ»‘åŠ¨å¼€å§‹');
      return;
    }
    
    Logger.info('ChatPage', 'ä¾§è¾¹æ æ»‘åŠ¨å¼€å§‹');
    this.isSideDrawerSwipeActive = true;
    this.sideDrawerSwipeProgress = this.showSideDrawer ? 1 : 0; // æ ¹æ®å½“å‰çŠ¶æ€è®¾ç½®åˆå§‹è¿›åº¦
    this.swipeDirection = 'none';
    this.lastSwipeTime = currentTime;
    this.isSwipeDebouncing = false;
  }

  /**
   * å¤„ç†ä¾§è¾¹æ æ»‘åŠ¨æ›´æ–°
   */
  private handleSideDrawerSwipeUpdate(event: GestureEvent): void {
    if (!this.isSideDrawerSwipeActive) {
      return;
    }

    const deltaX = event.offsetX;
    const currentTime = Date.now();
    
    // æ£€æµ‹æ»‘åŠ¨æ–¹å‘
    const currentDirection = deltaX > 5 ? 'right' : deltaX < -5 ? 'left' : 'none';
    
    // æ–¹å‘å˜åŒ–é˜²æŠ–ï¼šå¦‚æœæ–¹å‘å˜åŒ–è¿‡å¿«ï¼Œå¿½ç•¥æ­¤æ¬¡æ›´æ–°
    if (this.swipeDirection !== 'none' && 
        currentDirection !== 'none' && 
        this.swipeDirection !== currentDirection &&
        (currentTime - this.lastSwipeTime) < this.DIRECTION_CHANGE_THRESHOLD) {
      Logger.debug('ChatPage', `æ–¹å‘å˜åŒ–è¿‡å¿«ï¼Œä» ${this.swipeDirection} åˆ° ${currentDirection}ï¼Œå¿½ç•¥æ­¤æ¬¡æ›´æ–°`);
      return;
    }
    
    // æ›´æ–°æ»‘åŠ¨æ–¹å‘
    if (currentDirection !== 'none') {
      this.swipeDirection = currentDirection;
      this.lastSwipeTime = currentTime;
    }

    const maxSwipeDistance = this.SIDE_DRAWER_SWIPE_THRESHOLD * 1.5;
    let progress: number;
    
    // ç»Ÿä¸€çš„è¿›åº¦è®¡ç®—é€»è¾‘
    if (this.showSideDrawer) {
      // ä¾§è¾¹æ å·²æ‰“å¼€ï¼šåªå“åº”å‘å·¦æ»‘åŠ¨å…³é—­
      if (deltaX >= 0) {
        // å‘å³æ»‘åŠ¨æˆ–é™æ­¢ï¼Œä¿æŒå®Œå…¨æ‰“å¼€çŠ¶æ€
        progress = 1;
      } else {
        // å‘å·¦æ»‘åŠ¨å…³é—­ï¼Œè®¡ç®—å…³é—­è¿›åº¦
        progress = Math.max(0, 1 + deltaX / maxSwipeDistance);
      }
    } else {
      // ä¾§è¾¹æ å·²å…³é—­ï¼šåªå“åº”å‘å³æ»‘åŠ¨æ‰“å¼€
      if (deltaX <= 0) {
        // å‘å·¦æ»‘åŠ¨æˆ–é™æ­¢ï¼Œä¿æŒå®Œå…¨å…³é—­çŠ¶æ€
        progress = 0;
      } else {
        // å‘å³æ»‘åŠ¨æ‰“å¼€ï¼Œè®¡ç®—æ‰“å¼€è¿›åº¦
        progress = Math.min(deltaX / maxSwipeDistance, 1);
      }
    }
    
    this.sideDrawerSwipeProgress = progress;
    
    // åŠ¨æ€æ˜¾ç¤ºä¾§è¾¹æ ï¼ˆåªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºï¼Œä¸åœ¨æ»‘åŠ¨è¿‡ç¨‹ä¸­éšè—ï¼‰
    if (progress > 0.05 && !this.showSideDrawer) {
      this.showSideDrawer = true;
      Logger.debug('ChatPage', 'æ»‘åŠ¨è¿›åº¦è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤ºä¾§è¾¹æ ');
    }
    // æ»‘åŠ¨è¿‡ç¨‹ä¸­ä¸éšè—ä¾§è¾¹æ ï¼Œé¿å…é—ªçƒï¼Œåªåœ¨æ»‘åŠ¨ç»“æŸæ—¶å†³å®šæœ€ç»ˆçŠ¶æ€
  }

  /**
   * å¤„ç†ä¾§è¾¹æ æ»‘åŠ¨ç»“æŸ
   */
  private handleSideDrawerSwipeEnd(event: GestureEvent): void {
    if (!this.isSideDrawerSwipeActive) {
      return;
    }

    const progress = this.sideDrawerSwipeProgress;
    const deltaX = event.offsetX;
    const currentTime = Date.now();
    
    Logger.info('ChatPage', `ä¾§è¾¹æ æ»‘åŠ¨ç»“æŸï¼Œæ»‘åŠ¨è¿›åº¦: ${progress.toFixed(2)}, æ»‘åŠ¨è·ç¦»: ${deltaX}, æ–¹å‘: ${this.swipeDirection}`);
    
    // å¯åŠ¨é˜²æŠ–ï¼Œé˜²æ­¢å¿«é€Ÿè¿ç»­æ“ä½œ
    this.isSwipeDebouncing = true;
    
    // åŸºäºè¿›åº¦é˜ˆå€¼å’Œæ»‘åŠ¨é€Ÿåº¦ç»¼åˆåˆ¤æ–­
    const PROGRESS_THRESHOLD = this.SIDE_DRAWER_PROGRESS_THRESHOLD; // 30%çš„è¿›åº¦é˜ˆå€¼
    const velocity = Math.abs(deltaX) / 200; // ç®€å•é€Ÿåº¦è®¡ç®—
    
    let shouldOpen = false;
    
    if (this.swipeDirection === 'right') {
      // å‘å³æ»‘åŠ¨ï¼Œæ„å›¾æ˜¯æ‰“å¼€ä¾§è¾¹æ ï¼Œè€ƒè™‘é€Ÿåº¦å› ç´ 
      shouldOpen = progress >= PROGRESS_THRESHOLD || velocity > 0.5;
    } else if (this.swipeDirection === 'left') {
      // å‘å·¦æ»‘åŠ¨ï¼Œæ„å›¾æ˜¯å…³é—­ä¾§è¾¹æ ï¼Œè€ƒè™‘é€Ÿåº¦å› ç´ 
      shouldOpen = progress > (1 - PROGRESS_THRESHOLD) && velocity < 0.5;
    } else {
      // æ— æ˜ç¡®æ–¹å‘ï¼ŒåŸºäºå½“å‰è¿›åº¦åˆ¤æ–­
      shouldOpen = progress >= 0.5;
    }
    
    // åº”ç”¨æœ€ç»ˆçŠ¶æ€
    if (shouldOpen && !this.showSideDrawer) {
      this.showSideDrawer = true;
      Logger.info('ChatPage', 'æ»‘åŠ¨ç»“æŸï¼Œæ‰“å¼€ä¾§è¾¹æ ');
    } else if (!shouldOpen && this.showSideDrawer) {
      this.showSideDrawer = false;
      Logger.info('ChatPage', 'æ»‘åŠ¨ç»“æŸï¼Œå…³é—­ä¾§è¾¹æ ');
    } else {
      Logger.info('ChatPage', `æ»‘åŠ¨ç»“æŸï¼Œä¿æŒå½“å‰çŠ¶æ€: ${this.showSideDrawer ? 'æ‰“å¼€' : 'å…³é—­'}`);
    }
    
    // é‡ç½®æ»‘åŠ¨çŠ¶æ€ï¼Œä½†ä¿æŒæœ€ç»ˆè¿›åº¦çŠ¶æ€
    this.isSideDrawerSwipeActive = false;
    this.swipeDirection = 'none';
    
    // ä½¿ç”¨æ›´å¹³æ»‘çš„è¿‡æ¸¡åŠ¨ç”»
    animateTo({
      duration: 250,
      curve: Curve.EaseOut
    }, () => {
      this.sideDrawerSwipeProgress = this.showSideDrawer ? 1 : 0;
    });
    
    // å»¶è¿Ÿé‡ç½®é˜²æŠ–çŠ¶æ€
    setTimeout(() => {
      this.isSwipeDebouncing = false;
      Logger.debug('ChatPage', 'æ»‘åŠ¨é˜²æŠ–ç»“æŸ');
    }, this.SWIPE_DEBOUNCE_TIME);
  }

  private async sendMessage(isVoiceMessage: boolean = false): Promise<void> {
    if (!this.inputText.trim() || this.chatViewModel.isLoading) {
      return;
    }

    const message = this.inputText.trim();
    this.inputText = '';

    // å‘é€æ¶ˆæ¯åå…³é—­è¾“å…¥æ³•ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
    try {
      inputMethod.getController().stopInputSession();
    } catch (error) {
      Logger.error('ChatPage', `å…³é—­è¾“å…¥æ³•å¤±è´¥: ${error}`);
    }

    const sendPromise = this.chatViewModel.sendMessage(
      message,
      isVoiceMessage
    );

    // å…ˆæ»šåŠ¨è®©æ–°æ¶ˆæ¯ç«‹å³å¯è§ï¼Œå†ç­‰å¾…å¤„ç†å®Œæˆ
    this.scrollToBottom();

    try {
      await sendPromise;
    } finally {
      // åŠ©æ‰‹å›å¤å®Œæˆåå†æ¬¡ç¡®ä¿åœç•™åœ¨åº•éƒ¨
      this.scrollToBottom();
    }
  }

  private async sendRecognizedVoiceText(message: string): Promise<void> {
    const trimmed = message.trim();
    if (!trimmed) {
      return;
    }

    if (this.chatViewModel.isLoading) {
      Logger.warn('ChatPage', 'åŠ©æ‰‹æ­£åœ¨å¤„ç†ä¸­ï¼Œæš‚ä¸å‘é€æ–°çš„è¯­éŸ³æ¶ˆæ¯');
      return;
    }

    const sendPromise = this.chatViewModel.sendMessage(
      trimmed,
      true
    );

    this.scrollToBottom();

    try {
      await sendPromise;
    } finally {
      this.scrollToBottom();
    }
  }

  /**
   * å¤„ç†è¯­éŸ³è¯†åˆ«ç»“æœ
   */
  private async handleVoiceResult(text: string): Promise<void> {
    Logger.info('ChatPage', `æ”¶åˆ°è¯­éŸ³è¯†åˆ«ç»“æœ: ${text}`);
    
    if (!text.trim()) {
      Logger.warn('ChatPage', 'è¯­éŸ³è¯†åˆ«ç»“æœä¸ºç©ºï¼Œå¿½ç•¥');
      return;
    }

    const trimmedResult = text.trim();

    if (!this.isMeaningfulVoiceResult(trimmedResult)) {
      Logger.warn('ChatPage', `è¯­éŸ³è¯†åˆ«ç»“æœä»…åŒ…å«æ ‡ç‚¹ï¼Œå¿½ç•¥: ${trimmedResult}`);
      promptAction.showToast({
        message: 'æ²¡å¬æ¸…å†…å®¹ï¼Œè¯·å†è¯´ä¸€é~',
        duration: 2000
      });
      return;
    }

    if (this.voiceInputMode === InputMode.VOICE) {
      Logger.info('ChatPage', 'è¯­éŸ³æ¨¡å¼ä¸‹è‡ªåŠ¨å‘é€è¯†åˆ«æ–‡æœ¬');
      await this.sendRecognizedVoiceText(trimmedResult);
      return;
    }

    this.inputText = trimmedResult;
    this.scrollToBottom();
    Logger.info('ChatPage', 'è¯­éŸ³è¯†åˆ«ç»“æœå·²å¡«å…¥è¾“å…¥æ¡†ï¼Œå¹¶æ»šåŠ¨åˆ°åº•éƒ¨');
  }

  private isMeaningfulVoiceResult(text: string): boolean {
    const sanitized = text.replace(/[\s\u3000]/g, '');
    if (!sanitized) {
      return false;
    }

    // è‡³å°‘åŒ…å«ä¸€ä¸ªä¸­æ–‡ã€è‹±æ–‡å­—æ¯æˆ–æ•°å­—æ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆè¯­å¥
    return /[\u4e00-\u9fa5A-Za-z0-9]/.test(sanitized);
  }

  /**
   * å¤„ç†æ™ºèƒ½promptè§¦å‘
   */
  private async handleSmartPrompt(prompt: string): Promise<void> {
    Logger.info('ChatPage', `æ”¶åˆ°æ™ºèƒ½prompt: ${prompt}`);
    
    if (!prompt.trim()) {
      Logger.warn('ChatPage', 'æ™ºèƒ½promptä¸ºç©ºï¼Œå¿½ç•¥');
      return;
    }

    // å°†æ™ºèƒ½promptå¡«å…¥è¾“å…¥æ¡†
    this.inputText = prompt.trim();
    
    // å¯ä»¥é€‰æ‹©è‡ªåŠ¨å‘é€
    // await this.sendMessage();
    
    Logger.info('ChatPage', 'æ™ºèƒ½promptå·²å¡«å…¥è¾“å…¥æ¡†');
  }

  
  /**
   * åˆ‡æ¢æ¶ˆæ¯è¯­éŸ³æ’­æŠ¥çŠ¶æ€
   */
  private async toggleMessageAudio(message: Message): Promise<void> {
    if (!message.canPlayAudio) {
      Logger.warn('ChatPage', 'æ¶ˆæ¯ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾');
      return;
    }

    try {
      if (message.isPlaying) {
        Logger.info('ChatPage', `åœæ­¢æ’­æ”¾æ¶ˆæ¯éŸ³é¢‘: ${message.id}`);
        // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåˆ™åœæ­¢
        await this.chatViewModel.stopMessageAudio(message.id);
        promptAction.showToast({
          message: 'ğŸ”‡ å·²åœæ­¢æ’­æ”¾',
          duration: 1000
        });
      } else {
        Logger.info('ChatPage', `å¼€å§‹æ’­æ”¾æ¶ˆæ¯éŸ³é¢‘: ${message.id}`);
        // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ¶ˆæ¯æ­£åœ¨æ’­æ”¾ï¼Œæä¾›ç”¨æˆ·åé¦ˆ
        if (this.chatViewModel.isAnyMessagePlaying()) {
          const currentPlaying = this.chatViewModel.getCurrentPlayingMessage();
          if (currentPlaying) {
            Logger.info('ChatPage', `æ£€æµ‹åˆ°å…¶ä»–æ¶ˆæ¯æ­£åœ¨æ’­æ”¾ï¼Œå°†è‡ªåŠ¨åˆ‡æ¢: ${currentPlaying.id}`);
          }
        }
        
        // å¦‚æœæœªåœ¨æ’­æ”¾ï¼Œåˆ™å¼€å§‹æ’­æ”¾
        const success = await this.chatViewModel.playMessageAudio(message.id);
        if (success) {
          promptAction.showToast({
            message: 'ğŸ”Š å¼€å§‹æ’­æ”¾',
            duration: 1000
          });
        } else {
          promptAction.showToast({
            message: 'æ’­æ”¾å¤±è´¥',
            duration: 1500
          });
        }
      }
    } catch (error) {
      Logger.error('ChatPage', `åˆ‡æ¢è¯­éŸ³æ’­æŠ¥å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: 'è¯­éŸ³æ’­æŠ¥æ“ä½œå¤±è´¥',
        duration: 1500
      });
    }
  }

  private getShortModelName(): string {
    const modelName = this.chatViewModel.currentModel;
    if (!modelName) return 'é€‰æ‹©æ¨¡å‹';
    
    // æå–æ¨¡å‹åç§°çš„ä¸»è¦éƒ¨åˆ†
    if (modelName.includes('Qwen')) return 'Qwen';
    if (modelName.includes('Claude')) return 'Claude';  
    if (modelName.includes('DeepSeek')) return 'DeepSeek';
    if (modelName.includes('GPT')) return 'GPT';
    if (modelName.includes('gemma')) return 'Gemma';
    if (modelName.includes('ChatGLM')) return 'ChatGLM';
    
    // å¦‚æœåŒ…å«'/'ï¼Œå–åé¢çš„éƒ¨åˆ†
    if (modelName.includes('/')) {
      const parts = modelName.split('/');
      const lastPart = parts[parts.length - 1];
      return lastPart.length > 10 ? lastPart.substring(0, 10) + '...' : lastPart;
    }
    
    return modelName.length > 10 ? modelName.substring(0, 10) + '...' : modelName;
  }

  private getProviderDisplayName(): string {
    const provider = this.chatViewModel.currentProvider;
    switch (provider) {
      case 'siliconflow': return 'ç¡…åŸºæµåŠ¨';
      case 'anthropic': return 'Anthropic';
      case 'openai': return 'OpenAI';
      case 'zhipu': return 'æ™ºè°±AI';
      default: return provider || 'æœªçŸ¥';
    }
  }

  private getProviderColor(): string {
    const provider = this.chatViewModel.currentProvider;
    switch (provider) {
      case 'siliconflow': return '#4285F4';
      case 'anthropic': return '#FF6B35';
      case 'openai': return '#00A67E';
      case 'zhipu': return '#5856D6';
      default: return '#666666';
    }
  }

  /**
   * è®¾ç½®è¾“å…¥æ³•çŠ¶æ€ç›‘å¬å™¨
   */
  private setupInputMethodListener(): void {
    Logger.info('ChatPage', 'é”®ç›˜çŠ¶æ€ç›‘å¬é€šè¿‡è¾“å…¥æ¡†ç„¦ç‚¹çŠ¶æ€æ£€æµ‹');
  }

  /**
   * æ¸…ç†è¾“å…¥æ³•çŠ¶æ€ç›‘å¬å™¨
   */
  private cleanupInputMethodListener(): void {
    Logger.info('ChatPage', 'é”®ç›˜çŠ¶æ€ç›‘å¬å·²æ¸…ç†');
  }

  // getSelectedPromptNameæ–¹æ³•å·²ç§»é™¤ï¼Œä¸å†ä½¿ç”¨å…¨å±€é€‰ä¸­çŠ¶æ€

  private getQuickCommands(): QuickCommand[] {
    return [
      {
        id: 'clear',
        title: 'æ¸…ç©ºå¯¹è¯',
        subtitle: 'åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•ï¼Œå¼€å§‹æ–°çš„å¯¹è¯',
        icon: 'ğŸ—‘ï¸',
        color: '#FF4757',
        backgroundColor: '#FFE8E8',
        action: () => {
          this.clearMessages();
        }
      },
      {
        id: 'compact',
        title: 'å‹ç¼©ä¸Šä¸‹æ–‡',
        subtitle: 'ä¿ç•™æœ€è¿‘æ¶ˆæ¯ï¼Œå‹ç¼©å†å²è®°å½•èŠ‚çœç©ºé—´',
        icon: 'ğŸ“¦',
        color: '#3742FA',
        backgroundColor: '#E8EAFF',
        action: () => {
          this.compactMessages();
        }
      },
      {
        id: 'network',
        title: this.enableWebSearch ? 'å…³é—­è”ç½‘æœç´¢' : 'å¼€å¯è”ç½‘æœç´¢',
        subtitle: this.enableWebSearch ? 'ç›´è¿æ¨¡å¼è”ç½‘æœç´¢å·²å¯ç”¨ï¼Œæ™ºèƒ½è·å–æœ€æ–°ä¿¡æ¯' : 'å¼€å¯è”ç½‘æœç´¢åï¼ŒAIå°†è·å–æœ€æ–°ç½‘ç»œä¿¡æ¯',
        icon: 'ğŸŒ',
        color: this.enableWebSearch ? '#FF4757' : '#27AE60',
        backgroundColor: this.enableWebSearch ? '#FFE8E8' : '#E8F8F5',
        action: () => {
          this.toggleWebSearch();
        }
      },
      {
        id: 'prompts',
        title: 'æç¤ºè¯ç®¡ç†',
        subtitle: 'ç®¡ç†å’Œç¼–è¾‘ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿',
        icon: 'ğŸ¯',
        color: '#8E44AD',
        backgroundColor: '#F3E8FF',
        action: () => {
          router.pushUrl({ 
            url: 'pages/SystemPromptManagerPage',
            params: { 
              fromChatPage: true,
              currentSessionId: this.chatViewModel.currentSession?.id || null
            }
          });
        }
      },
    ];
  }

  private async clearMessages(): Promise<void> {
    await this.chatViewModel.clearMessages();
  }

  private async toggleWebSearch(): Promise<void> {
    try {
      const currentState = !this.enableWebSearch;
      const result = await this.chatViewModel.apiManager.setFeature('enableWebSearch', currentState);

      if (result) {
        // åŠŸèƒ½ä¸æ”¯æŒ
        promptAction.showToast({
          message: `â— ${result}`,
          duration: 2000
        });
        return;
      }

      // æ›´æ–°æˆåŠŸï¼ŒåŒæ­¥æœ¬åœ°çŠ¶æ€
      this.enableWebSearch = currentState;
      Logger.info('ChatPage', `è”ç½‘æœç´¢çŠ¶æ€åˆ‡æ¢: ${this.enableWebSearch}`);

      // æ˜¾ç¤ºçŠ¶æ€åˆ‡æ¢æç¤º
      promptAction.showToast({
        message: this.enableWebSearch ? 'ğŸŒ è”ç½‘æœç´¢å·²å¼€å¯' : 'ğŸ“± å·²åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼',
        duration: 1500
      });
    } catch (error) {
      Logger.error('ChatPage', `åˆ‡æ¢è”ç½‘æœç´¢å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: 'â— è”ç½‘æœç´¢åˆ‡æ¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        duration: 1500
      });
    }
  }

  private async toggleMute(): Promise<void> {
    try {
      const updatedSettings = await this.autoTTSService.toggleMuteState();
      this.isMuted = updatedSettings.muted;
      promptAction.showToast({
        message: this.isMuted ? 'ğŸ¤« è‡ªåŠ¨æ’­æŠ¥å·²é™éŸ³' : 'ğŸ—£ï¸ è‡ªåŠ¨æ’­æŠ¥å·²æ¢å¤',
        duration: 1500
      });
    } catch (error) {
      Logger.error('ChatPage', `åˆ‡æ¢é™éŸ³å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: 'â— é™éŸ³åˆ‡æ¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        duration: 1500
      });
    }
  }

  private async toggleDeepThinking(): Promise<void> {
    try {
      const currentState = !this.enableDeepThinking;
      const result = await this.chatViewModel.apiManager.setFeature('enableDeepThinking', currentState);

      if (result) {
        // åŠŸèƒ½ä¸æ”¯æŒ
        promptAction.showToast({
          message: `â— ${result}`,
          duration: 2000
        });
        return;
      }

      // æ›´æ–°æˆåŠŸï¼ŒåŒæ­¥æœ¬åœ°çŠ¶æ€
      this.enableDeepThinking = currentState;
      Logger.info('ChatPage', `æ·±åº¦æ€è€ƒçŠ¶æ€åˆ‡æ¢: ${this.enableDeepThinking}`);

      // æ˜¾ç¤ºçŠ¶æ€åˆ‡æ¢æç¤º
      promptAction.showToast({
        message: this.enableDeepThinking ? 'ğŸ§  æ·±åº¦æ€è€ƒæ¨¡å¼å·²å¼€å¯' : 'ğŸ’­ åˆ‡æ¢åˆ°æ™®é€šæ¨¡å¼',
        duration: 1500
      });
    } catch (error) {
      Logger.error('ChatPage', `åˆ‡æ¢æ·±åº¦æ€è€ƒå¤±è´¥: ${error}`);
      promptAction.showToast({
        message: 'â— æ·±åº¦æ€è€ƒåˆ‡æ¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        duration: 1500
      });
    }
  }

  private async toggleMessageLayout(): Promise<void> {
    const previousLayout = this.useModernMessageLayout;
    this.useModernMessageLayout = !this.useModernMessageLayout;
    
    Logger.info('ChatPage', `æ¶ˆæ¯å¸ƒå±€æ ·å¼åˆ‡æ¢: ${previousLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'} -> ${this.useModernMessageLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'}`);
    
    // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
    await StorageManager.saveMessageLayoutPreference(this.useModernMessageLayout);
    
    // æ˜¾ç¤ºçŠ¶æ€åˆ‡æ¢æç¤º
    promptAction.showToast({
      message: this.useModernMessageLayout ? 'ğŸ“± å·²åˆ‡æ¢åˆ°ç°ä»£çº¿æ€§å¸ƒå±€' : 'ğŸ’¬ å·²åˆ‡æ¢åˆ°ä¼ ç»Ÿæ¶ˆæ¯æ°”æ³¡',
      duration: 1500
    });
  }

  private async compactMessages(): Promise<void> {
    const currentCount = this.chatViewModel.messages.length;
    if (currentCount <= 6) {
      AlertDialog.show({
        title: 'æ— éœ€å‹ç¼©',
        message: `å½“å‰ä»…æœ‰ ${currentCount} æ¡æ¶ˆæ¯ï¼Œæ— éœ€å‹ç¼©ã€‚`,
        primaryButton: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
      return;
    }

    AlertDialog.show({
      title: 'ç¡®è®¤å‹ç¼©',
      message: `å½“å‰æœ‰ ${currentCount} æ¡æ¶ˆæ¯ï¼Œå‹ç¼©åå°†ä¿ç•™æœ€è¿‘6æ¡æ¶ˆæ¯å¹¶å‹ç¼©é•¿æ¶ˆæ¯å†…å®¹ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
      primaryButton: {
        value: 'ç¡®å®š',
        action: async () => {
          await this.chatViewModel.compactMessages();
          const newCount = this.chatViewModel.messages.length;
          // æ˜¾ç¤ºå‹ç¼©ç»“æœ
          setTimeout(() => {
            AlertDialog.show({
              title: 'å‹ç¼©å®Œæˆ',
              message: `å·²å‹ç¼© ${currentCount - newCount} æ¡æ¶ˆæ¯ï¼Œå½“å‰ä¿ç•™ ${newCount} æ¡æ¶ˆæ¯ã€‚`,
              primaryButton: {
                value: 'ç¡®å®š',
                action: () => {}
              }
            });
          }, 500);
        }
      },
      secondaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      }
    });
  }

  private copyToClipboard(text: string): void {
    try {
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, text);
      const systemPasteboard = pasteboard.getSystemPasteboard();
      systemPasteboard.setData(pasteData);
      
      // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
      promptAction.showToast({
        message: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
        duration: 1500
      });
    } catch (error) {
      Logger.error('ChatPage', `å¤åˆ¶å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: 'å¤åˆ¶å¤±è´¥',
        duration: 1500
      });
    }
  }

  /**
   * å¯åŠ¨æ¶ˆæ¯å˜åŒ–æ£€æµ‹å®šæ—¶å™¨
   */
  private startMessageChangeTimer(): void {
    // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
    this.stopMessageChangeTimer();

    // æ¯500msæ£€æŸ¥ä¸€æ¬¡æ¶ˆæ¯å˜åŒ–
    this.messageChangeTimer = setInterval(() => {
      this.checkMessageChangesAndScroll();
    }, 500);

    Logger.info('ChatPage', 'æ¶ˆæ¯å˜åŒ–æ£€æµ‹å®šæ—¶å™¨å·²å¯åŠ¨');
  }

  /**
   * åœæ­¢æ¶ˆæ¯å˜åŒ–æ£€æµ‹å®šæ—¶å™¨
   */
  private stopMessageChangeTimer(): void {
    if (this.messageChangeTimer !== -1) {
      clearInterval(this.messageChangeTimer);
      this.messageChangeTimer = -1;
      Logger.info('ChatPage', 'æ¶ˆæ¯å˜åŒ–æ£€æµ‹å®šæ—¶å™¨å·²åœæ­¢');
    }
  }

  /**
   * æ£€æŸ¥æ¶ˆæ¯å˜åŒ–å¹¶è‡ªåŠ¨æ»šåŠ¨
   */
  private checkMessageChangesAndScroll(): void {
    try {
      const currentMessages = this.chatViewModel.messages;

      // æ£€æŸ¥æ¶ˆæ¯æ•°é‡æ˜¯å¦å¢åŠ 
      if (currentMessages.length > this.lastMessageCount) {
        this.lastMessageCount = currentMessages.length;
        this.messages = [...currentMessages];

        // æ–°æ¶ˆæ¯æ·»åŠ ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(() => {
          this.scrollToBottom();
        }, 100);
        return;
      }

      // æ£€æŸ¥æœ€åä¸€æ¡åŠ©æ‰‹æ¶ˆæ¯å†…å®¹æ˜¯å¦æœ‰æ›´æ–°
      if (currentMessages.length > 0) {
        const lastMessage = currentMessages[currentMessages.length - 1];

        if (lastMessage.role === MessageRole.ASSISTANT &&
            lastMessage.content !== this.lastAssistantMessageContent &&
            lastMessage.content.trim().length > 0) {

          this.lastAssistantMessageContent = lastMessage.content;
          this.messages = [...currentMessages];

          // åŠ©æ‰‹æ¶ˆæ¯å†…å®¹æ›´æ–°ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
          setTimeout(() => {
            this.scrollToBottom();
          }, 100);
        }
      }
    } catch (error) {
      Logger.error('ChatPage', `æ£€æµ‹æ¶ˆæ¯å˜åŒ–å¤±è´¥: ${error}`);
    }
  }

  /**
   * æ»šåŠ¨åˆ°æ¶ˆæ¯åˆ—è¡¨åº•éƒ¨ï¼ˆæœ€æ–°æ¶ˆæ¯ï¼‰
   */
  private scrollToBottom(): void {
    try {
      const messageCount = this.chatViewModel.messages.length;
      if (messageCount > 0) {
        // å»¶è¿Ÿæ‰§è¡Œæ»šåŠ¨ï¼Œç¡®ä¿UIæ¸²æŸ“å®Œæˆ
        setTimeout(() => {
          this.performScrollToBottom(messageCount - 1, 0);
        }, 200);
      } else {
        // æ²¡æœ‰æ¶ˆæ¯æ—¶ä¹Ÿå°è¯•æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿è¾“å…¥æ¡†å¯è§
        setTimeout(() => {
          this.performScrollToBottom(0, 0);
        }, 200);
      }
    } catch (error) {
      Logger.error('ChatPage', `æ»šåŠ¨åˆ°åº•éƒ¨å¤±è´¥: ${error}`);
    }
  }

  /**
   * æ‰§è¡Œæ»šåŠ¨æ“ä½œï¼Œå¸¦é‡è¯•æœºåˆ¶
   */
  private performScrollToBottom(targetIndex: number, retryCount: number): void {
    const maxRetries = 3;
    try {
      this.listScroller.scrollToIndex(targetIndex, true, ScrollAlign.END);
      Logger.info('ChatPage', `è‡ªåŠ¨æ»šåŠ¨åˆ°ç´¢å¼• ${targetIndex}ï¼Œé‡è¯•æ¬¡æ•°: ${retryCount}`);
    } catch (scrollError) {
      Logger.warn('ChatPage', `æ»šåŠ¨æ‰§è¡Œå¤±è´¥: ${scrollError}ï¼Œé‡è¯•æ¬¡æ•°: ${retryCount}`);

      // å¦‚æœæ»šåŠ¨å¤±è´¥ä¸”è¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œåˆ™é‡è¯•
      if (retryCount < maxRetries) {
        setTimeout(() => {
          this.performScrollToBottom(targetIndex, retryCount + 1);
        }, 100 * (retryCount + 1)); // é€’å¢å»¶è¿Ÿæ—¶é—´
      } else {
        Logger.error('ChatPage', `æ»šåŠ¨é‡è¯•å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°: ${maxRetries}`);
      }
    }
  }

  /**
   * å¤„ç†è¿”å›é”®
   */
  private handleBackPress(): boolean {
    // å¦‚æœæœ‰å¼¹çª—æ‰“å¼€ï¼Œå…ˆå…³é—­å¼¹çª—
    if (this.showToolboxPanel) {
      this.hideToolboxPanel();
      return true; // é˜»æ­¢é»˜è®¤è¿”å›è¡Œä¸º
    }
    
    if (this.showModelSelector) {
      this.hideModelSelector();
      return true; // é˜»æ­¢é»˜è®¤è¿”å›è¡Œä¸º
    }
    
    // if (this.showPromptSelector) {
    //   this.showPromptSelector = false;
    //   return true;
    // }
    
    if (this.showQuickCommands) {
      this.showQuickCommands = false;
      return true;
    }
    
    if (this.showSideDrawer) {
      this.showSideDrawer = false;
      // é‡ç½®æ»‘åŠ¨çŠ¶æ€å’Œé˜²æŠ–çŠ¶æ€
      this.resetSideDrawerState();
      return true;
    }
    
    // å¦‚æœæ­£åœ¨æ»‘åŠ¨ä¾§è¾¹æ ï¼Œä¹Ÿé˜»æ­¢è¿”å›è¡Œä¸º
    if (this.isSideDrawerSwipeActive) {
      this.resetSideDrawerState();
      return true;
    }
    
    // å…è®¸é»˜è®¤è¿”å›è¡Œä¸ºï¼ˆé€€å‡ºåº”ç”¨ï¼‰
    return false;
  }

  /**
   * æ„å»ºåŠ è½½çŠ¶æ€ç»„ä»¶
   */
  @Builder
  private buildLoadingStatus(text: string, showAnimation: boolean = false) {
    Row() {
      LoadingProgress()
        .width(20)
        .height(20)
        .margin({ right: 8 })
      
      Text(text)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
    }
    .animation(showAnimation ? {
      duration: 800,
      curve: Curve.EaseInOut,
      iterations: -1,
      playMode: PlayMode.Alternate
    } : undefined)
  }

  /**
   * é‡ç½®ä¾§è¾¹æ æ»‘åŠ¨ç›¸å…³çŠ¶æ€
   */
  private resetSideDrawerState(): void {
    this.isSideDrawerSwipeActive = false;
    this.isSwipeDebouncing = false;
    this.swipeDirection = 'none';
    this.lastSwipeTime = 0;
    
    // å¹³æ»‘é‡ç½®è¿›åº¦åˆ°å¯¹åº”çŠ¶æ€ï¼Œä½¿ç”¨æ›´é•¿çš„æŒç»­æ—¶é—´å‡å°‘æŠ–åŠ¨
    animateTo({
      duration: 200,
      curve: Curve.EaseOut
    }, () => {
      this.sideDrawerSwipeProgress = this.showSideDrawer ? 1 : 0;
    });
    
    Logger.debug('ChatPage', 'ä¾§è¾¹æ æ»‘åŠ¨çŠ¶æ€å·²é‡ç½®');
  }

  /**
   * å¤„ç†ä¼šè¯é¡¹æ»‘åŠ¨çŠ¶æ€å˜åŒ–
   */
  private handleSessionSwipeStateChange(isSwiping: boolean): void {
    this.isSessionItemSwiping = isSwiping;
    Logger.debug('ChatPage', `ä¼šè¯é¡¹æ»‘åŠ¨çŠ¶æ€å˜åŒ–: ${isSwiping}`);
  }

  @Builder
  buildUserAvatar() {
    if (this.userAvatarType === 'emoji') {
      Text(this.userAvatarValue)
        .fontSize(20)
        .width(36)
        .height(36)
        .textAlign(TextAlign.Center)
        .borderRadius(18)
        .backgroundColor($r('app.color.input_background'))
        .onClick(() => {
          this.navigateToProfileEdit();
        })
    } else if (this.userAvatarType === 'image') {
      Image(this.userAvatarValue)
        .width(36)
        .height(36)
        .borderRadius(18)
        .objectFit(ImageFit.Cover)
        .onError(() => {
          // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
          Logger.warn('ChatPage', 'ç”¨æˆ·å¤´åƒå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ');
        })
        .onClick(() => {
          this.navigateToProfileEdit();
        })
    } else {
      Circle({ width: 36, height: 36 })
        .fill(this.userAvatarValue)
        .onClick(() => {
          this.navigateToProfileEdit();
        })
    }
  }

  @Builder
  buildAIAvatar() {
    if (this.aiAvatarType === 'emoji') {
      Text(this.aiAvatarValue)
        .fontSize(20)
        .width(36)
        .height(36)
        .textAlign(TextAlign.Center)
        .borderRadius(18)
        .backgroundColor($r('app.color.input_background'))
    } else if (this.aiAvatarType === 'image') {
      Image(this.aiAvatarValue)
        .width(36)
        .height(36)
        .borderRadius(18)
        .objectFit(ImageFit.Cover)
        .onError(() => {
          // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
          Logger.warn('ChatPage', 'AIå¤´åƒå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ');
        })
    } else {
      Circle({ width: 36, height: 36 })
        .fill(this.aiAvatarValue)
    }
  }

  // systemPromptSheetBuilderå·²æ³¨é‡Šï¼Œä¸å†ä½¿ç”¨é¡¶éƒ¨é€‰æ‹©å™¨
  // @Builder
  // systemPromptSheetBuilder() {
  //   SystemPromptComponent({
  //     prompts: this.chatViewModel.systemPrompts || [],
  //     selectedPrompt: this.chatViewModel.selectedSystemPrompt,
  //     onPromptSelected: (prompt: SystemPrompt | null) => {
  //       this.chatViewModel.selectSystemPrompt(prompt);
  //       this.showPromptSelector = false;
  //     },
  //     onClose: () => {
  //       this.showPromptSelector = false;
  //     }
  //   })
  // }

  /**
   * å½“å‰ä¼šè¯ç³»ç»Ÿæç¤ºè¯åªè¯»å±•ç¤º
   */
  @Builder
  buildCurrentSessionPromptDisplay() {
    Row({ space: 8 }) {
      // ä½¿ç”¨å›¾æ ‡+çŠ¶æ€ç‚¹ç®€åŒ–å±•ç¤º
      Text('ğŸ­')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))

      Circle()
        .width(8)
        .height(8)
        .fill(this.chatViewModel.getCurrentSessionSystemPrompt() ? '#74B9FF' : '#BDBDBD')
        .opacity(this.chatViewModel.getCurrentSessionSystemPrompt() ? 1.0 : 0.6)

      Blank()
    }
    .width('100%')
    .padding({ left: 12, right: 12, top: 4, bottom: 2 })
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(16)
    .clip(true)
  }


  /**
   * å¤„ç†Promptæ¨¡æ¿é€‰æ‹©
   */
  private handlePromptSelected(prompt: string): void {
    Logger.info('ChatPage', `é€‰æ‹©Promptæ¨¡æ¿: ${prompt}`);
    
    // å°†Promptå†…å®¹æ·»åŠ åˆ°è¾“å…¥æ¡†
    const currentText = this.inputText.trim();
    const promptContent = prompt.trim();
    
    if (currentText) {
      // å¦‚æœè¾“å…¥æ¡†æœ‰å†…å®¹ï¼Œåœ¨åé¢æ·»åŠ ç©ºæ ¼å’Œpromptå†…å®¹
      this.inputText = currentText + ' ' + promptContent;
    } else {
      // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œç›´æ¥è®¾ç½®promptå†…å®¹
      this.inputText = promptContent;
    }
    
    // æ›´æ–°è¾“å…¥åŒºåŸŸé«˜åº¦
    this.inputAreaHeight = this.calculateInputHeight(this.inputText);
    
    Logger.info('ChatPage', `Promptå·²æ’å…¥è¾“å…¥æ¡†ï¼Œå½“å‰å†…å®¹: ${this.inputText}`);
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    promptAction.showToast({
      message: 'æ™ºèƒ½æ¨¡æ¿å·²æ’å…¥',
      duration: 1000
    });
  }

  /**
   * å¤„ç†å·¥å…·ç®±å·¥å…·é€‰æ‹©
   */
  private handleToolSelected(tool: ToolType): void {
    Logger.info('ChatPage', `å·¥å…·ç®±å·¥å…·è¢«é€‰æ‹©: ${tool}`);
    
    switch (tool) {
      case ToolType.CLEAR_SESSION:
        this.clearMessages();
        break;
      case ToolType.COMPACT_CONTEXT:
        this.compactMessages();
        break;
      default:
        Logger.warn('ChatPage', `æœªçŸ¥çš„å·¥å…·ç±»å‹: ${tool}`);
        break;
    }
  }

  
  
  /**
   * æ„å»ºå·¥å…·ç®±é¡¹ç›®
   */
  @Builder
  buildToolboxItem(item: ToolboxItem) {
    Row() {
      // å·¥å…·å›¾æ ‡
      Text(item.icon)
        .fontSize(22)
        .fontColor(item.color)
        .width(40)
        .height(40)
        .backgroundColor(item.backgroundColor)
        .borderRadius(20)
        .textAlign(TextAlign.Center)
        .margin({ right: 16 })
      
      // å·¥å…·ä¿¡æ¯
      Column({ space: 6 }) {
        Text(item.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.isDarkMode ? '#FFFFFF' : '#1A1A1A')
          .textAlign(TextAlign.Start)
        
        Text(item.description)
          .fontSize(13)
          .fontColor(this.isDarkMode ? '#CCCCCC' : '#666666')
          .textAlign(TextAlign.Start)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      
    }
    .width('100%')
    .height(64)
    .padding({ left: 20, right: 20 })
    .backgroundColor(Color.Transparent)
    .borderRadius(12)
    .stateStyles({
      normal: {
        .backgroundColor(Color.Transparent)
      },
      pressed: {
        .backgroundColor(this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)')
      }
    })
    .animation({
      duration: 150,
      curve: Curve.EaseInOut
    })
    .onClick(() => {
      Logger.info('ChatPage', `å·¥å…·é¡¹è¢«ç‚¹å‡»: ${item.title}`);
      this.handleToolboxItemClick(item);
    })
    .hitTestBehavior(1)
  }

  /**
   * æ˜¾ç¤ºå·¥å…·ç®±é¢æ¿
   */
  private showToolboxPanelMethod(): void {
    Logger.info('ChatPage', 'æ˜¾ç¤ºå·¥å…·ç®±é¢æ¿');
    // æ˜¾ç¤ºå·¥å…·ç®±é¢æ¿å‰å…ˆå…³é—­å¿«é€ŸæŒ‡ä»¤é¢æ¿
    if (this.showQuickCommands) {
      this.showQuickCommands = false;
    }
    this.showToolboxPanel = true;
    
    // åŠ¨ç”»æ˜¾ç¤ºé¢æ¿ - æ¸å…¥+ä¸Šæ»‘æ•ˆæœ
    animateTo({
      duration: 350,
      curve: curves.springMotion(0.6, 0.8)
    }, () => {
      this.toolboxPanelOpacity = 1.0;
      this.toolboxPanelTranslateY = 0; // æ»‘åˆ°æ­£ç¡®ä½ç½®
    });
  }

  /**
   * éšè—å·¥å…·ç®±é¢æ¿
   */
  private hideToolboxPanel(): void {
    Logger.info('ChatPage', 'éšè—å·¥å…·ç®±é¢æ¿');
    
    // åŠ¨ç”»éšè—é¢æ¿ - æ¸å‡º+ä¸‹ç§»æ•ˆæœ
    animateTo({
      duration: 300,
      curve: curves.springMotion(0.6, 0.8)
    }, () => {
      this.toolboxPanelOpacity = 0.0;
      this.toolboxPanelTranslateY = 400; // å‘ä¸‹æ»‘å‡ºå±å¹•
    });
    
    // å»¶è¿Ÿé‡ç½®æ˜¾ç¤ºçŠ¶æ€
    setTimeout(() => {
      this.showToolboxPanel = false;
    }, 250);
  }

  /**
   * è·å–å·¥å…·ç®±é¡¹ç›®åˆ—è¡¨
   */
  private getToolboxItems(): ToolboxItem[] {
    return [
      {
        id: 'clear_session',
        title: 'æ¸…ç©ºä¼šè¯',
        description: 'åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•ï¼Œå¼€å§‹æ–°çš„å¯¹è¯',
        icon: 'ğŸ—‘ï¸',
        color: '#FF4757',
        backgroundColor: 'rgba(255, 71, 87, 0.1)',
        enabled: true,
        action: async () => {
          Logger.info('ChatPage', 'æ‰§è¡Œæ¸…ç©ºä¼šè¯æ“ä½œ');
          await this.clearMessages();
        }
      },
      {
        id: 'toggle_style',
        title: this.useModernMessageLayout ? 'åˆ‡æ¢åˆ°ä¼ ç»Ÿæ ·å¼' : 'åˆ‡æ¢åˆ°ç°ä»£æ ·å¼',
        description: this.useModernMessageLayout ? 'å½“å‰ä¸ºç°ä»£çº¿æ€§å¸ƒå±€ï¼Œå¯åˆ‡æ¢å›ä¼ ç»Ÿæ¶ˆæ¯æ°”æ³¡' : 'å½“å‰ä¸ºä¼ ç»Ÿæ¶ˆæ¯æ°”æ³¡ï¼Œå¯åˆ‡æ¢åˆ°ç°ä»£çº¿æ€§å¸ƒå±€',
        icon: this.useModernMessageLayout ? 'ğŸ’¬' : 'ğŸ“±',
        color: this.useModernMessageLayout ? '#3742FA' : '#8E44AD',
        backgroundColor: this.useModernMessageLayout ? 'rgba(55, 66, 250, 0.1)' : 'rgba(142, 68, 173, 0.1)',
        enabled: true,
        action: () => {
          Logger.info('ChatPage', 'æ‰§è¡Œæ ·å¼åˆ‡æ¢æ“ä½œ');
          this.toggleMessageLayout();
        }
      },
      {
        id: 'compact_context',
        title: 'å‹ç¼©ä¸Šä¸‹æ–‡',
        description: 'ä¿ç•™æœ€è¿‘æ¶ˆæ¯ï¼Œå‹ç¼©å†å²è®°å½•èŠ‚çœç©ºé—´',
        icon: 'ğŸ“¦',
        color: '#3742FA',
        backgroundColor: 'rgba(55, 66, 250, 0.1)',
        enabled: true,
        action: async () => {
          Logger.info('ChatPage', 'æ‰§è¡Œå‹ç¼©ä¸Šä¸‹æ–‡æ“ä½œ');
          await this.compactMessages();
        }
      },
      {
        id: 'system_prompt_manager',
        title: 'ç®¡ç†æç¤ºè¯',
        description: 'è°ƒæ•´ç³»ç»Ÿæç¤ºè¯ä¸è§’è‰²è®¾å®š',
        icon: 'âœï¸',
        color: '#0984E3',
        backgroundColor: 'rgba(9, 132, 227, 0.1)',
        enabled: true,
        action: () => {
          Logger.info('ChatPage', 'è·³è½¬åˆ°ç³»ç»Ÿæç¤ºè¯ç®¡ç†é¡µé¢');
          router.pushUrl({
            url: 'pages/SystemPromptManagerPage',
            params: {
              fromChatPage: true,
              currentSessionId: this.chatViewModel.currentSession?.id || null
            }
          });
        }
      },
      {
        id: 'settings',
        title: 'è®¾ç½®',
        description: 'åº”ç”¨è®¾ç½®å’Œä¸ªæ€§åŒ–é…ç½®',
        icon: 'âš™ï¸',
        color: '#95A5A6',
        backgroundColor: 'rgba(149, 165, 166, 0.1)',
        enabled: true,
        action: () => {
          Logger.info('ChatPage', 'è·³è½¬åˆ°è®¾ç½®é¡µé¢');
          router.pushUrl({ url: 'pages/SettingsPage' });
        }
      }
    ];
  }

  /**
   * è·³è½¬åˆ°ç”¨æˆ·èµ„æ–™ç¼–è¾‘é¡µé¢
   */
  private navigateToProfileEdit(): void {
    Logger.info('ChatPage', 'è·³è½¬åˆ°ç”¨æˆ·èµ„æ–™ç¼–è¾‘é¡µé¢');
    router.pushUrl({ url: 'pages/UserProfileEditPage' });
  }

  /**
   * æˆªæ–­æœç´¢ä¿¡æ¯æ˜¾ç¤º
   */
  private truncateSearchInfo(searchInfo: string): string {
    if (!searchInfo) return '';
    
    // å¦‚æœä¿¡æ¯é•¿åº¦è¶…è¿‡30ä¸ªå­—ç¬¦ï¼Œè¿›è¡Œæˆªæ–­
    const maxLength = 30;
    if (searchInfo.length <= maxLength) {
      return searchInfo;
    }
    
    return searchInfo.substring(0, maxLength) + '...';
  }

  /**
   * æ˜¾ç¤ºæœç´¢ä¿¡æ¯å¼¹æ¡†
   */
  private showSearchInfoBubble(content: string): void {
    Logger.info('ChatPage', `showSearchInfoBubbleè¢«è°ƒç”¨ï¼Œcontenté•¿åº¦: ${content.length}`);
    Logger.info('ChatPage', `å†…å®¹é¢„è§ˆ: ${content.substring(0, 100)}...`);
    
    // ä½¿ç”¨è‡ªå®šä¹‰å¼¹æ¡†æ˜¾ç¤ºæœç´¢ä¿¡æ¯ï¼Œæ”¯æŒé€‰ä¸­å¤åˆ¶
    this.searchDetailsContent = content;
    this.showSearchDetailsDialog = true;
    
    Logger.info('ChatPage', 'æœç´¢ä¿¡æ¯å¼¹æ¡†å·²æ˜¾ç¤º');
  }

  /**
   * éšè—æœç´¢ä¿¡æ¯å¼¹æ¡†
   */
  private hideSearchDetailsDialog(): void {
    this.showSearchDetailsDialog = false;
    this.searchDetailsContent = '';
    Logger.info('ChatPage', 'æœç´¢ä¿¡æ¯å¼¹æ¡†å·²éšè—');
  }

  
  /**
   * å¤„ç†å·¥å…·ç®±é¡¹ç›®ç‚¹å‡»
   */
  private handleToolboxItemClick(item: ToolboxItem): void {
    Logger.info('ChatPage', `å·¥å…·ç®±å·¥å…·è¢«ç‚¹å‡»: ${item.title}`);
    
    // å…ˆéšè—é¢æ¿
    this.hideToolboxPanel();
    
    // å»¶è¿Ÿæ‰§è¡Œå·¥å…·åŠ¨ä½œï¼Œç¡®ä¿å…³é—­åŠ¨ç”»å®Œæˆ
    setTimeout(async () => {
      try {
        Logger.info('ChatPage', `æ‰§è¡Œå·¥å…·åŠ¨ä½œ: ${item.id}`);
        const result = item.action();
        if (result instanceof Promise) {
          await result;
        }
        Logger.info('ChatPage', `å·¥å…·åŠ¨ä½œæ‰§è¡Œå®Œæˆ: ${item.id}`);
        
        // æ‰§è¡ŒæˆåŠŸåæ˜¾ç¤ºæç¤ºï¼ˆè·³è½¬ç±»æŒ‰é’®é™¤å¤–ï¼‰
        if (item.id !== 'settings' && item.id !== 'system_prompt_manager') {
          promptAction.showToast({
            message: `${item.title}æ“ä½œæˆåŠŸ`,
            duration: 1500
          });
        }
      } catch (error) {
        Logger.error('ChatPage', `å·¥å…·æ‰§è¡Œå¼‚å¸¸: ${item.id}, é”™è¯¯: ${error}`);
        // è®¾ç½®æŒ‰é’®é™¤å¤–ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
        if (item.id !== 'settings' && item.id !== 'system_prompt_manager') {
          promptAction.showToast({
            message: `${item.title}æ“ä½œå¤±è´¥`,
            duration: 1500
          });
        }
      }
    }, 200);
  }


  /**
   * è¾“å…¥åŒºåŸŸæç¤ºæ–‡æ¡ˆ
   */
  private getInputPlaceholder(): string {
    switch (this.voiceRecognitionState) {
      case VoiceRecognitionState.RECORDING:
        return 'æ­£åœ¨è¯­éŸ³è¾“å…¥ï¼Œä¸Šæ»‘å–æ¶ˆå³å¯...';
      case VoiceRecognitionState.PROCESSING:
        return 'è¯­éŸ³è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...';
      case VoiceRecognitionState.ERROR:
        return 'è¯­éŸ³è¯†åˆ«æš‚ä¸å¯ç”¨ï¼Œè¯·æ”¹ç”¨æ–‡å­—è¾“å…¥';
      default:
        return 'è¾“å…¥æ–‡å­—æˆ–æŒ‰ä½è¯­éŸ³é”®è¯´è¯...';
    }
  }

  /**
   * è®¡ç®—è¾“å…¥åŒºåŸŸåŠ¨æ€é«˜åº¦
   */
  private calculateInputHeight(text: string): number {
    const minHeight = 48; // æœ€å°é«˜åº¦ (ä¸€è¡Œé«˜åº¦: 24pxè¡Œé«˜ + 24pxå†…è¾¹è·)
    const maxHeight = 280; // æœ€å¤§é«˜åº¦ï¼Œé…åˆè¾“å…¥åŒºåŸŸæœ€å¤§é«˜åº¦350px
    const lineHeight = 24; // æ¯è¡Œé«˜åº¦
    const padding = 24; // ä¸Šä¸‹å†…è¾¹è·
    
    if (!text || text.trim() === '') {
      return minHeight;
    }
    
    // è®¡ç®—æ˜ç¡®çš„æ¢è¡Œç¬¦è¡Œæ•°
    const lineBreaks = (text.match(/\n/g) || []).length;
    const explicitLines = lineBreaks + 1;
    
    // æ ¹æ®å­—ç¬¦é•¿åº¦å’Œå®é™…å®½åº¦ä¼°ç®—è‡ªåŠ¨æ¢è¡Œè¡Œæ•°
    // è€ƒè™‘ä¸­æ–‡å­—ç¬¦å®½åº¦çº¦ä¸ºè‹±æ–‡å­—ç¬¦çš„2å€ï¼Œè¾“å…¥æ¡†æœ‰æ•ˆå®½åº¦çº¦å¯å®¹çº³30-35ä¸ªè‹±æ–‡å­—ç¬¦
    const charsPerLine = 30;
    let totalChars = 0;
    
    // æ›´å‡†ç¡®åœ°è®¡ç®—å­—ç¬¦å®½åº¦ï¼ˆä¸­æ–‡æŒ‰2ä¸ªå­—ç¬¦è®¡ç®—ï¼‰
    for (let i = 0; i < text.length; i++) {
      const char = text.charAt(i);
      // åˆ¤æ–­æ˜¯å¦ä¸ºä¸­æ–‡å­—ç¬¦
      if (/[\u4e00-\u9fa5]/.test(char)) {
        totalChars += 2;
      } else {
        totalChars += 1;
      }
    }
    
    const estimatedLinesByWidth = Math.ceil(totalChars / charsPerLine);
    
    // ç»¼åˆè€ƒè™‘æ¢è¡Œç¬¦å’Œå­—ç¬¦å®½åº¦
    const totalLines = Math.max(explicitLines, estimatedLinesByWidth);
    
    // è®¡ç®—åŠ¨æ€é«˜åº¦ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´æ˜¾ç¤ºæ‰€æœ‰æ–‡æœ¬
    const calculatedHeight = Math.min(maxHeight, Math.max(minHeight, totalLines * lineHeight + padding));
    
    return calculatedHeight;
  }

  /**
   * æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å™¨ - å¸¦å¼¹ç°§åŠ¨ç”»
   */
  private showModelSelectorMethod(): void {
    Logger.info('ChatPage', 'æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å™¨');
    this.showModelSelector = true;
    this.modelSelectorOpacity = 1.0;
    // å¼¹ç°§åŠ¨ç”»æ˜¾ç¤ºé¢æ¿
    animateTo({
      duration: 450,
      curve: curves.springMotion(0.6, 0.8)
    }, () => {
      this.modelSelectorTranslateY = 0; // æ»‘åˆ°å±å¹•åº•éƒ¨æ­£ç¡®ä½ç½®
    });
  }

  /**
   * éšè—æ¨¡å‹é€‰æ‹©å™¨ - å¸¦å¼¹ç°§åŠ¨ç”»
   */
  private hideModelSelector(): void {
    Logger.info('ChatPage', 'éšè—æ¨¡å‹é€‰æ‹©å™¨');
    
    // å¼¹ç°§åŠ¨ç”»éšè—é¢æ¿
    animateTo({
      duration: 350,
      curve: curves.springMotion(0.8, 0.8)
    }, () => {
      this.modelSelectorTranslateY = 600; // å‘ä¸‹æ»‘å‡ºå±å¹•
    });
    
    // å»¶è¿Ÿé‡ç½®æ˜¾ç¤ºçŠ¶æ€
    setTimeout(() => {
      this.showModelSelector = false;
    }, 350);
  }

  
  /**
   * æ˜¾ç¤ºæ·±åº¦æ€è€ƒå¯¹è¯æ¡†
   */
  private showDeepThinkingDialog(message: Message): void {
    Logger.info('ChatPage', `æ˜¾ç¤ºæ·±åº¦æ€è€ƒå¯¹è¯æ¡†: ${message.id}`);
    this.thinkingDialogMessage = message;
    this.showThinkingDialog = true;
  }

  /**
   * éšè—æ·±åº¦æ€è€ƒå¯¹è¯æ¡†
   */
  private hideDeepThinkingDialog(): void {
    Logger.info('ChatPage', 'éšè—æ·±åº¦æ€è€ƒå¯¹è¯æ¡†');
    this.showThinkingDialog = false;
    this.thinkingDialogMessage = null;
  }

  /**
   * å¤„ç†æ€è€ƒæ­¥éª¤ç‚¹å‡»
   */
  private handleThinkingStepTap(step: ThinkingStep): void {
    Logger.info('ChatPage', `æ€è€ƒæ­¥éª¤è¢«ç‚¹å‡»: ${step.title}`);
    // å¯ä»¥åœ¨è¿™é‡Œå®ç°æ­¥éª¤è¯¦æƒ…çš„è¿›ä¸€æ­¥å¤„ç†
  }

  /**
   * è·å–å½“å‰æœåŠ¡å™¨é…ç½®å­—ç¬¦ä¸²ï¼Œç”¨äºæ£€æµ‹é…ç½®å˜æ›´
   */
  private getCurrentServerConfigString(): string {
    try {
      // ä»AppConfigManagerè·å–å½“å‰æœåŠ¡å™¨é…ç½®
      const appConfigManager = AppConfigManager.getInstance();
      const config = appConfigManager.getServerConfig();
      return `${config.baseUrl}|${config.wsUrl}`;
    } catch (error) {
      Logger.warn('ChatPage', `è·å–æœåŠ¡å™¨é…ç½®å¤±è´¥: ${error}`);
      return '';
    }
  }

  /**
   * è¯·æ±‚å¼ºåˆ¶åˆ·æ–°æ¨¡å‹åˆ—è¡¨
   */
  private requestForceReloadProviders(): void {
    Logger.info('ChatPage', 'è¯·æ±‚å¼ºåˆ¶åˆ·æ–°æ¨¡å‹åˆ—è¡¨');
    this.forceReloadProviders = true;
  }

}
