import { router } from '@kit.ArkUI';
import { Constants } from '../utils/Constants';
import { AutoTTSSettings, AvatarSettings, UserProfile, AppStorage as StorageManager } from '../utils/AppStorage';
import { UserProfileManager } from '../utils/UserProfileManager';
import { AutoTTSService } from '../services/AutoTTSService';
import { APIManager, APIMode, AIProvider } from '../services/APIManager';
import { Logger } from '../utils/Logger';
import { AppConfigManager } from '../utils/AppConfigManager';
import { ServerConfigManager, ServerEndpoint } from '../utils/ServerConfigManager';
import { ThemeManager } from '../utils/ThemeManager';
import { FontManager } from '../utils/FontManager';
import { FontSettings } from '../utils/AppStorage';
import { BasicAnimations, AnimationConfigManager } from '../animations';
import { picker } from '@kit.CoreFileKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { MemoryManager } from '../utils/MemoryManager';
import { MemoryStats, MemoryCategoryCounts, MemoryImportanceCounts } from '../types/MemoryTypes';

interface SettingItem {
  title: string;
  subtitle: string;
  type: 'input' | 'switch' | 'info' | 'button' | 'slider' | 'avatar';
  value?: boolean;
  numValue?: number;
  minValue?: number;
  maxValue?: number;
  step?: number;
  avatarValue?: string;
  visible?: boolean;
  avatarType?: 'default' | 'emoji' | 'image';
}

interface AvatarOption {
  text: string;
  value: string;
}

/**
 * è®¾ç½®é¡µé¢
 */
@Entry
@ComponentV2
struct SettingsPage {
  @Local serverUrl: string = AppConfigManager.getInstance().getServerConfig().baseUrl;
  @Local enableNotifications: boolean = true;
  @Local autoTTSSettings: AutoTTSSettings = StorageManager.getDefaultAutoTTSSettings();
  @Local userAvatarType: 'default' | 'emoji' | 'image' = 'default';
  @Local userAvatarValue: string = '#4285F4';
  @Local aiAvatarType: 'default' | 'emoji' | 'image' = 'default';
  @Local aiAvatarValue: string = '#34A853';
  @Local userName: string = 'Javisç”¨æˆ·';
  @Local userSignature: string = 'è®©AIæˆä¸ºä½ çš„ç¼–ç¨‹ä¼™ä¼´';
  @Local avatarSettingsItems: SettingItem[] = [];
  
  // è®¡ç®—å±æ€§ï¼šè‡ªåŠ¨ç”Ÿæˆä¸ªäººèµ„æ–™è®¾ç½®é¡¹æ•°ç»„
  @Computed
  get computedProfileSettingsItems(): SettingItem[] {
    return [
      {
        title: 'ä¸ªäººèµ„æ–™',
        subtitle: `${this.userName} â€¢ ${this.userSignature}`,
        type: 'button'
      },
      {
        title: 'AIå¤´åƒ', 
        subtitle: this.getAvatarDisplayText(this.aiAvatarType, this.aiAvatarValue),
        type: 'avatar',
        avatarType: this.aiAvatarType,
        avatarValue: this.aiAvatarValue
      }
    ];
  }
  @Local currentAPIMode: APIMode = APIMode.DIRECT_CALL;
  @Local isInitialized: boolean = false; // æ ‡è®°é¡µé¢æ˜¯å¦å·²å®Œæˆåˆå§‹åŒ–
  @Local useModernMessageLayout: boolean = false; // æ¶ˆæ¯å¸ƒå±€åå¥½
  @Local statusBarHeight: number = 44; // çŠ¶æ€æ é«˜åº¦
  @Local currentServer: ServerEndpoint = {
    ip: 'localhost',
    port: 8080,
    protocol: 'http',
    wsProtocol: 'ws'
  };
  @Local fontSettings: FontSettings = {
    chatFontSize: 16,
    codeFontSize: 14,
    fontFamily: 'system',
    updatedAt: Date.now()
  };
  private readonly PAGE_ENTER_OFFSET: number = 96;
  @Local private pageTranslateX: number = this.PAGE_ENTER_OFFSET;
  @Local private pageOpacity: number = BasicAnimations.HIDDEN_OPACITY;
  private hasPlayedEnterAnimation: boolean = false;
  private animationConfigManager: AnimationConfigManager = AnimationConfigManager.getInstance();
  private autoTTSService: AutoTTSService = AutoTTSService.getInstance();
  private apiManager: APIManager = APIManager.getInstance();
  private userProfileManager: UserProfileManager = UserProfileManager.getInstance();
  private serverConfigManager: ServerConfigManager = ServerConfigManager.getInstance();
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private fontManager: FontManager = FontManager.getInstance();
  private memoryManager: MemoryManager = MemoryManager.getInstance();
  @Local private defaultCategoryCounts: MemoryCategoryCounts = {
    personal: 0,
    preference: 0,
    work: 0,
    study: 0,
    hobby: 0,
    family: 0,
    health: 0,
    custom: 0
  };

  @Local private defaultImportanceCounts: MemoryImportanceCounts = {
    low: 0,
    medium: 0,
    high: 0,
    critical: 0
  };

  @Local memoryStats: MemoryStats = {
    totalFragments: 0,
    activeFragments: 0,
    categoryCounts: this.defaultCategoryCounts,
    importanceCounts: this.defaultImportanceCounts,
    lastUpdated: 0,
    totalUsageCount: 0
  };
  private avatarListener: (settings: AvatarSettings) => void = (settings: AvatarSettings) => {
    // æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œ@Computedä¼šè‡ªåŠ¨å¤„ç†åç»­æ›´æ–°
    this.aiAvatarType = settings.aiAvatarType;
    this.aiAvatarValue = settings.aiAvatarValue;
  };
  private userProfileListener: (profile: UserProfile) => void = (profile: UserProfile) => {
    this.userName = profile.userName;
    this.userSignature = profile.userSignature;
    this.userAvatarType = profile.userAvatarType;
    this.userAvatarValue = profile.userAvatarValue;
  };
  private serverConfigListener: (config: ServerEndpoint) => void = (config: ServerEndpoint) => {
    // æ›´æ–°æœ¬åœ°æœåŠ¡å™¨é…ç½®çŠ¶æ€
    Logger.info('SettingsPage', `æ”¶åˆ°æœåŠ¡å™¨é…ç½®å˜æ›´é€šçŸ¥: ${config.protocol}://${config.ip}:${config.port}`);

    // æ›´æ–°å„ä¸ªå±æ€§ä»¥ç¡®ä¿å“åº”æ€§
    this.currentServer.ip = config.ip;
    this.currentServer.port = config.port;
    this.currentServer.protocol = config.protocol;
    this.currentServer.wsProtocol = config.wsProtocol;
    this.currentServer.description = config.description;

    Logger.info('SettingsPage', `æœåŠ¡å™¨é…ç½®å·²æ›´æ–°ä¸º: ${this.currentServer.protocol}://${this.currentServer.ip}:${this.currentServer.port}`);
  };
  private fontSettingsListener: (settings: FontSettings) => void = (settings: FontSettings) => {
    // æ›´æ–°æœ¬åœ°å­—ä½“è®¾ç½®çŠ¶æ€
    Logger.info('SettingsPage', `æ”¶åˆ°å­—ä½“è®¾ç½®å˜æ›´é€šçŸ¥: ${JSON.stringify(settings)}`);
    Logger.info('SettingsPage', `å½“å‰å­—ä½“è®¾ç½®: ${JSON.stringify(this.fontSettings)}`);
    this.fontSettings = settings;
    Logger.info('SettingsPage', `æ›´æ–°åå­—ä½“è®¾ç½®: ${JSON.stringify(this.fontSettings)}`);
  };

  async aboutToAppear(): Promise<void> {
    Logger.info('SettingsPage', 'aboutToAppear');
    this.resetEnterAnimationState();
    
    // åŠ è½½è‡ªåŠ¨æ’­æŠ¥è®¾ç½®
    try {
      this.autoTTSSettings = await StorageManager.getAutoTTSSettings();
      Logger.info('SettingsPage', `è‡ªåŠ¨æ’­æŠ¥è®¾ç½®åŠ è½½æˆåŠŸ: ${JSON.stringify(this.autoTTSSettings)}`);
    } catch (error) {
      Logger.error('SettingsPage', `åŠ è½½è‡ªåŠ¨æ’­æŠ¥è®¾ç½®å¤±è´¥: ${error}`);
    }

    // åŠ è½½è®°å¿†ç»Ÿè®¡ä¿¡æ¯
    try {
      this.memoryStats = await this.memoryManager.getMemoryStats();
      Logger.info('SettingsPage', `è®°å¿†ç»Ÿè®¡ä¿¡æ¯åŠ è½½æˆåŠŸ: æ€»è®¡${this.memoryStats.totalFragments}ä¸ªï¼Œæ¿€æ´»${this.memoryStats.activeFragments}ä¸ª`);
    } catch (error) {
      Logger.error('SettingsPage', `åŠ è½½è®°å¿†ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${error}`);
    }

    // åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™ç®¡ç†å™¨
    try {
      await this.userProfileManager.initialize();
      const currentProfile = this.userProfileManager.getCurrentProfile();
      if (currentProfile) {
        this.userName = currentProfile.userName;
        this.userSignature = currentProfile.userSignature;
        this.userAvatarType = currentProfile.userAvatarType;
        this.userAvatarValue = currentProfile.userAvatarValue;
      }
    } catch (error) {
      Logger.error('SettingsPage', `åˆå§‹åŒ–ç”¨æˆ·èµ„æ–™ç®¡ç†å™¨å¤±è´¥: ${error}`);
    }

    // åŠ è½½AIå¤´åƒè®¾ç½®
    try {
      const avatarSettings = await StorageManager.getAvatarSettings();
      this.aiAvatarType = avatarSettings.aiAvatarType;
      this.aiAvatarValue = avatarSettings.aiAvatarValue;
    } catch (error) {
      Logger.error('SettingsPage', `åŠ è½½AIå¤´åƒè®¾ç½®å¤±è´¥: ${error}`);
    }

    // åŠ è½½APIè°ƒç”¨æ¨¡å¼ï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼Œä¸æ‰§è¡Œä»»ä½•åŒæ­¥æ“ä½œï¼‰
    try {
      const apiModeStr = await StorageManager.getAPIMode();
      const storedMode = apiModeStr === 'direct_call' ? APIMode.DIRECT_CALL : APIMode.SERVER_PROXY;
      
      // åªæ›´æ–°UIæ˜¾ç¤ºçŠ¶æ€ï¼Œä¸è§¦å‘ä»»ä½•æ¨¡å¼åˆ‡æ¢æˆ–åŒæ­¥æ“ä½œ
      this.currentAPIMode = storedMode;
      Logger.info('SettingsPage', `APIè°ƒç”¨æ¨¡å¼æ˜¾ç¤ºçŠ¶æ€å·²åŠ è½½: ${this.currentAPIMode}ï¼Œè®¾ç½®é¡µé¢ä¸æ‰§è¡Œæ¨¡å¼åŒæ­¥`);
    } catch (error) {
      Logger.error('SettingsPage', `åŠ è½½APIè°ƒç”¨æ¨¡å¼æ˜¾ç¤ºçŠ¶æ€å¤±è´¥: ${error}`);
    }

    // åŠ è½½æ¶ˆæ¯å¸ƒå±€åå¥½
    try {
      this.useModernMessageLayout = await StorageManager.getMessageLayoutPreference();
      Logger.info('SettingsPage', `æ¶ˆæ¯å¸ƒå±€åå¥½åŠ è½½æˆåŠŸ: ${this.useModernMessageLayout ? 'ç°ä»£å¸ƒå±€' : 'ä¼ ç»Ÿæ°”æ³¡'}`);
    } catch (error) {
      Logger.error('SettingsPage', `åŠ è½½æ¶ˆæ¯å¸ƒå±€åå¥½å¤±è´¥: ${error}`);
    }

    // åŠ è½½æœåŠ¡å™¨é…ç½®
    try {
      await this.serverConfigManager.initialize();
      const serverConfig = this.serverConfigManager.getCurrentServer();
      
      // æ›´æ–°å„ä¸ªå±æ€§ä»¥ç¡®ä¿å“åº”æ€§
      this.currentServer.ip = serverConfig.ip;
      this.currentServer.port = serverConfig.port;
      this.currentServer.protocol = serverConfig.protocol;
      this.currentServer.wsProtocol = serverConfig.wsProtocol;
      this.currentServer.description = serverConfig.description;
      
      Logger.info('SettingsPage', `æœåŠ¡å™¨é…ç½®åŠ è½½æˆåŠŸ: ${this.currentServer.protocol}://${this.currentServer.ip}:${this.currentServer.port}`);
    } catch (error) {
      Logger.error('SettingsPage', `åŠ è½½æœåŠ¡å™¨é…ç½®å¤±è´¥: ${error}`);
    }
    
    // æ·»åŠ ç”¨æˆ·èµ„æ–™ç›‘å¬å™¨
    this.userProfileManager.addProfileListener(this.userProfileListener);
    
    // æ·»åŠ å¤´åƒè®¾ç½®ç›‘å¬å™¨ï¼ˆä»…ç”¨äºAIå¤´åƒï¼‰
    StorageManager.addAvatarListener(this.avatarListener);
    
    // æ·»åŠ æœåŠ¡å™¨é…ç½®å˜æ›´ç›‘å¬å™¨
    this.serverConfigManager.addConfigChangeListener(this.serverConfigListener);

    // åˆå§‹åŒ–å­—ä½“ç®¡ç†å™¨
    try {
      await this.fontManager.initialize();
      this.fontSettings = this.fontManager.getFontSettings();
      this.fontManager.addListener(this.fontSettingsListener);
      Logger.info('SettingsPage', `å­—ä½“è®¾ç½®åˆå§‹åŒ–å®Œæˆ: ${JSON.stringify(this.fontSettings)}`);
    } catch (error) {
      Logger.error('SettingsPage', `åˆå§‹åŒ–å­—ä½“è®¾ç½®å¤±è´¥: ${error}`);
    }

    // æš‚æ—¶ä½¿ç”¨å›ºå®šçŠ¶æ€æ é«˜åº¦ï¼Œåç»­åŠ¨æ€è·å–
    Logger.info('SettingsPage', 'ä½¿ç”¨å›ºå®šçŠ¶æ€æ é«˜åº¦44vp');

    // è®¾ç½®åˆå§‹åŒ–å®Œæˆæ ‡è®°ï¼Œé¿å…åˆå§‹åŒ–è¿‡ç¨‹ä¸­è§¦å‘onChangeäº‹ä»¶
    this.isInitialized = true;
    Logger.info('SettingsPage', 'é¡µé¢åˆå§‹åŒ–å®Œæˆ');
  }

  async onPageShow(): Promise<void> {
    Logger.info('SettingsPage', 'é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ è½½è®¾ç½®çŠ¶æ€');
    this.playEnterTransition();
    
    // é‡æ–°åŠ è½½æ¶ˆæ¯å¸ƒå±€åå¥½ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
    try {
      const previousLayout = this.useModernMessageLayout;
      this.useModernMessageLayout = await StorageManager.getMessageLayoutPreference();
      
      if (previousLayout !== this.useModernMessageLayout) {
        Logger.info('SettingsPage', `æ¶ˆæ¯å¸ƒå±€åå¥½å·²æ›´æ–°: ${previousLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'} -> ${this.useModernMessageLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'}`);
        
        // å¼ºåˆ¶UIåˆ·æ–°ï¼šé€šè¿‡å¾®å°å»¶è¿Ÿç¡®ä¿çŠ¶æ€å˜åŒ–èƒ½æ­£ç¡®åæ˜ åˆ°UI
        setTimeout(() => {
          Logger.debug('SettingsPage', `UIåˆ·æ–°å®Œæˆï¼Œå½“å‰çŠ¶æ€: ${this.useModernMessageLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'}`);
        }, 50);
      } else {
        Logger.debug('SettingsPage', `æ¶ˆæ¯å¸ƒå±€åå¥½æœªå˜æ›´: ${this.useModernMessageLayout ? 'ç°ä»£' : 'ä¼ ç»Ÿ'}`);
      }
    } catch (error) {
      Logger.error('SettingsPage', `é‡æ–°åŠ è½½æ¶ˆæ¯å¸ƒå±€åå¥½å¤±è´¥: ${error}`);
    }

    // é‡æ–°åŠ è½½æœåŠ¡å™¨é…ç½®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
    try {
      const serverConfig = this.serverConfigManager.getCurrentServer();
      
      // æ›´æ–°å„ä¸ªå±æ€§ä»¥ç¡®ä¿å“åº”æ€§
      this.currentServer.ip = serverConfig.ip;
      this.currentServer.port = serverConfig.port;
      this.currentServer.protocol = serverConfig.protocol;
      this.currentServer.wsProtocol = serverConfig.wsProtocol;
      this.currentServer.description = serverConfig.description;
      
      Logger.info('SettingsPage', `é‡æ–°åŠ è½½æœåŠ¡å™¨é…ç½®å®Œæˆ: ${serverConfig.protocol}://${serverConfig.ip}:${serverConfig.port}`);
    } catch (error) {
      Logger.error('SettingsPage', `é‡æ–°åŠ è½½æœåŠ¡å™¨é…ç½®å¤±è´¥: ${error}`);
    }
  }

  aboutToDisappear(): void {
    // ç§»é™¤ç”¨æˆ·èµ„æ–™ç›‘å¬å™¨
    this.userProfileManager.removeProfileListener(this.userProfileListener);

    // ç§»é™¤å¤´åƒè®¾ç½®ç›‘å¬å™¨
    StorageManager.removeAvatarListener(this.avatarListener);

    // ç§»é™¤æœåŠ¡å™¨é…ç½®å˜æ›´ç›‘å¬å™¨
    this.serverConfigManager.removeConfigChangeListener(this.serverConfigListener);

    // ç§»é™¤å­—ä½“è®¾ç½®ç›‘å¬å™¨
    this.fontManager.removeListener(this.fontSettingsListener);
  }

  onBackPress(): boolean | void {
    // ç›´æ¥è¿”å›ä¸Šä¸€é¡µ
    router.back();
    return true;
  }

  // å¤´åƒè®¾ç½®å˜åŒ–ç›‘å¬å™¨
  onAvatarSettingsChanged(): void {
    // å¤´åƒè®¾ç½®å˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘ï¼Œ@Computedå±æ€§ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—
  }

  private resetEnterAnimationState(): void {
    this.pageTranslateX = this.PAGE_ENTER_OFFSET;
    this.pageOpacity = BasicAnimations.HIDDEN_OPACITY;
    this.hasPlayedEnterAnimation = false;
  }

  private playEnterTransition(): void {
    if (this.hasPlayedEnterAnimation) {
      return;
    }

    this.hasPlayedEnterAnimation = true;
    const duration = this.animationConfigManager.getDuration(BasicAnimations.STANDARD_DURATION);
    const curve = this.animationConfigManager.getCurve();

    animateTo({
      duration,
      curve
    }, () => {
      this.pageTranslateX = 0;
      this.pageOpacity = BasicAnimations.STANDARD_OPACITY;
    });
  }

  private getServerSettings(): SettingItem[] {
    // è·å–å®æ—¶çš„æœåŠ¡å™¨é…ç½®
    const currentServer = this.serverConfigManager.getCurrentServer();
    const serverUrl = `${currentServer.protocol}://${currentServer.ip}:${currentServer.port}`;
    return [
      {
        title: 'æœåŠ¡å™¨é…ç½®',
        subtitle: `${currentServer.ip}:${currentServer.port}`,
        type: 'button'
      }
    ];
  }

  private getAppSettings(): SettingItem[] {
    return [
      {
        title: 'é€šçŸ¥',
        subtitle: 'æ¥æ”¶æ¶ˆæ¯é€šçŸ¥',
        type: 'switch',
        value: this.enableNotifications
      },
      {
        title: 'æ¶ˆæ¯æ ·å¼',
        subtitle: this.useModernMessageLayout ? 'ç°ä»£çº¿æ€§å¸ƒå±€' : 'ä¼ ç»Ÿæ¶ˆæ¯æ°”æ³¡',
        type: 'switch',
        value: this.useModernMessageLayout
      },
      {
        title: 'æ¸…é™¤èŠå¤©è®°å½•',
        subtitle: 'åˆ é™¤æ‰€æœ‰æœ¬åœ°èŠå¤©æ¶ˆæ¯',
        type: 'button'
      },
      {
        title: 'é‡ç½®æ¨¡å‹é€‰æ‹©',
        subtitle: 'æ¸…é™¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©é…ç½®',
        type: 'button'
      }
    ];
  }

  private getAISettings(): SettingItem[] {
    return [
      {
        title: 'APIè°ƒç”¨æ¨¡å¼',
        subtitle: APIManager.getModeDescription(this.currentAPIMode),
        type: 'switch',
        value: this.currentAPIMode === APIMode.DIRECT_CALL
      },
      {
        title: 'APIå¯†é’¥ç®¡ç†',
        subtitle: 'ç›´è¿æ¨¡å¼å¯†é’¥é…ç½®',
        type: 'button'
      },
      {
        title: 'è§’è‰²ç®¡ç†',
        subtitle: 'AIåŠ©æ‰‹è§’è‰²è®¾å®š',
        type: 'button'
      },
      {
        title: 'MCPè®¾ç½®',
        subtitle: 'Model Context Protocol æœåŠ¡å™¨å’Œå·¥å…·é…ç½®',
        type: 'button'
      }
    ];
  }

  
  
  
  private getVoiceSettings(): SettingItem[] {
    return [
      {
        title: 'æ”¶åˆ°å›å¤æ—¶æ’­æ”¾',
        subtitle: this.autoTTSSettings.autoPlayOnReceive ? 'æ”¶åˆ°AIå›å¤æ—¶è‡ªåŠ¨æ’­æ”¾' : 'éœ€è¦æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾',
        type: 'switch',
        value: this.autoTTSSettings.autoPlayOnReceive
      },
      {
        title: 'è¯­éŸ³é€Ÿåº¦',
        subtitle: '', // å°†ç”± getDynamicSubtitle åŠ¨æ€ç”Ÿæˆ
        type: 'slider',
        numValue: this.autoTTSSettings.speed,
        minValue: 0.5,
        maxValue: 2.0,
        step: 0.1
      },
      {
        title: 'éŸ³é‡å¤§å°',
        subtitle: '', // å°†ç”± getDynamicSubtitle åŠ¨æ€ç”Ÿæˆ
        type: 'slider',
        numValue: this.autoTTSSettings.volume,
        minValue: 0.1,
        maxValue: 1.0,
        step: 0.1
      },
      {
        title: 'éŸ³è°ƒé«˜ä½',
        subtitle: '', // å°†ç”± getDynamicSubtitle åŠ¨æ€ç”Ÿæˆ
        type: 'slider',
        numValue: this.autoTTSSettings.pitch,
        minValue: 0.5,
        maxValue: 2.0,
        step: 0.1
      }
    ];
  }

  private getFontSettings(): SettingItem[] {
    return [
      {
        title: 'èŠå¤©å­—ä½“å¤§å°',
        subtitle: '', // å°†ç”± getDynamicSubtitle åŠ¨æ€ç”Ÿæˆ
        type: 'slider',
        numValue: this.fontSettings.chatFontSize,
        minValue: 12,
        maxValue: 20,
        step: 1
      },
      {
        title: 'ä»£ç å­—ä½“å¤§å°',
        subtitle: '', // å°†ç”± getDynamicSubtitle åŠ¨æ€ç”Ÿæˆ
        type: 'slider',
        numValue: this.fontSettings.codeFontSize,
        minValue: 10,
        maxValue: 18,
        step: 1
      },
      {
        title: 'å­—ä½“å®¶æ—',
        subtitle: '', // å°†ç”± getDynamicSubtitle åŠ¨æ€ç”Ÿæˆ
        type: 'info'
      }
    ];
  }

  private getMemorySettings(): SettingItem[] {
    return [
      {
        title: 'è®°å¿†ä¸­å¿ƒ',
        subtitle: `${this.memoryStats.totalFragments}ä¸ªè®°å¿†ç¢ç‰‡ï¼Œ${this.memoryStats.activeFragments}ä¸ªå·²æ¿€æ´»`,
        type: 'button'
      }
    ];
  }

  private getAboutSettings(): SettingItem[] {
    const configManager = AppConfigManager.getInstance();
    const privacyConfig = configManager.getPrivacyConfig();
    
    const developerInfo = privacyConfig.showDeveloperInfo ? privacyConfig.developerName : '';
    
    const settings: SettingItem[] = [
      {
        title: 'å…³äºåº”ç”¨',
        subtitle: 'LLMåŠ©æ‰‹åº”ç”¨ä»‹ç»',
        type: 'button'
      },
      {
        title: 'ç‰ˆæœ¬å·',
        subtitle: 'v1.0.0',
        type: 'info'
      }
    ];
    
    if (privacyConfig.showDeveloperInfo) {
      settings.push({
        title: 'å¼€å‘è€…ä¿¡æ¯',
        subtitle: developerInfo,
        type: developerInfo ? 'button' : 'info'
      });
    }
    
    return settings;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ  - æ·»åŠ çŠ¶æ€æ é«˜åº¦é¿è®©
        Column() {
          this.buildNavigationBar()
        }
        .margin({ top: this.statusBarHeight })

        // è®¾ç½®é€‰é¡¹åˆ—è¡¨
        this.buildSettingsList()
      }
      .translate({ x: this.pageTranslateX, y: 0 })
      .opacity(this.pageOpacity)
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.background_color'))

      // å­—ä½“å®¶æ—é€‰æ‹©å¯¹è¯æ¡†
      if (this.showFontFamilyDialog) {
        this.FontFamilySelectionDialog()
      }

      // æœåŠ¡å™¨è¾“å…¥å¯¹è¯æ¡†
      if (this.showServerInputDialog) {
        this.ServerInputDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildNavigationBar() {
    Row() {
      Button('è¿”å›')
        .fontSize(15)
        .backgroundColor(Color.Transparent)
        .fontColor($r('app.color.primary_color'))
        .padding({ left: 0, right: 0 })
        .onClick(() => {
          router.back();
        })

      Text('è®¾ç½®')
        .fontSize(18)
        .fontColor($r('app.color.text_primary'))
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Blank()
        .width(48) // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
    }
    .width('100%')
    .height(52)
    .padding({ left: 20, right: 20 })
    .backgroundColor($r('app.color.surface_color'))
    .shadow({
      radius: 2,
      color: '#0D000000',
      offsetY: 1
    })
  }

  @Builder
  buildSettingsList() {
    Scroll() {
      Column() {
        // æœåŠ¡å™¨è®¾ç½®
        this.buildSettingsGroup('æœåŠ¡å™¨è®¾ç½®', this.getServerSettings(), 'server')

        // AIè®¾ç½®
        this.buildSettingsGroup('AIè®¾ç½®', this.getAISettings(), 'ai')

        // ä¸ªäººèµ„æ–™è®¾ç½®
        this.buildSettingsGroup('ä¸ªäººèµ„æ–™', this.computedProfileSettingsItems, 'profile')

        // è®°å¿†ç®¡ç†è®¾ç½®
        this.buildSettingsGroup('è®°å¿†ç®¡ç†', this.getMemorySettings(), 'memory')

        // è¯­éŸ³æ’­æŠ¥è®¾ç½®
        this.buildSettingsGroup('è¯­éŸ³æ’­æŠ¥', this.getVoiceSettings(), 'voice')

        // å­—ä½“è®¾ç½®
        this.buildSettingsGroup('å­—ä½“è®¾ç½®', this.getFontSettings(), 'font')

        // åº”ç”¨è®¾ç½®
        this.buildSettingsGroup('åº”ç”¨è®¾ç½®', this.getAppSettings(), 'app')

        // å…³äºä¿¡æ¯
        this.buildSettingsGroup('å…³äº', this.getAboutSettings(), 'about')
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 20, bottom: 32 })
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  buildSettingsGroup(title: string, items: SettingItem[], sectionId: string) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .fontWeight(FontWeight.Medium)
        .width('100%')
        .margin({ bottom: 8 })

      Column() {
        ForEach(items, (item: SettingItem, index: number) => {
          this.buildSettingsItem(item, index === items.length - 1)
        })
      }
      .backgroundColor($r('app.color.surface_color'))
      .borderRadius(12)
      .margin({ bottom: 24 })
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .id(sectionId)
  }

  @Builder
  buildSettingsItem(item: SettingItem, isLast: boolean) {
    Column() {
      Row() {
        Column() {
          Text(item.title)
            .fontSize(16)
            .fontColor(item.type === 'button' ? $r('app.color.primary_color') : $r('app.color.text_primary'))
            .width('100%')
            .textAlign(TextAlign.Start)

          if (this.getDynamicSubtitle(item)) {
            Text(this.getDynamicSubtitle(item))
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ top: 2 })
              .maxLines(2)
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

        // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ§ä»¶
        if (item.type === 'switch') {
          Toggle({ type: ToggleType.Switch, isOn: this.getSwitchValue(item) })
            .onChange(async (isOn: boolean) => {
              Logger.info('SettingsPage', `Toggle onChangeè§¦å‘: ${item.title}, isOn: ${isOn}, isInitialized: ${this.isInitialized}`);
              
              // åªåœ¨é¡µé¢åˆå§‹åŒ–å®Œæˆåæ‰å¤„ç†onChangeäº‹ä»¶ï¼Œé¿å…åˆå§‹åŒ–è¿‡ç¨‹ä¸­çš„æ„å¤–è§¦å‘
              if (!this.isInitialized) {
                Logger.debug('SettingsPage', `è·³è¿‡åˆå§‹åŒ–é˜¶æ®µçš„å¼€å…³å˜æ›´: ${item.title}`);
                return;
              }
              
              if (item.title === 'é€šçŸ¥') {
                this.enableNotifications = isOn;
              } else if (item.title === 'æ¶ˆæ¯æ ·å¼') {
                // ç›´æ¥æ›´æ–°çŠ¶æ€
                this.useModernMessageLayout = isOn;
                // å¼‚æ­¥ä¿å­˜åˆ°å­˜å‚¨
                try {
                  await StorageManager.saveMessageLayoutPreference(isOn);
                  Logger.info('SettingsPage', `æ¶ˆæ¯å¸ƒå±€æ ·å¼å·²ä¿å­˜: ${isOn ? 'ç°ä»£å¸ƒå±€' : 'ä¼ ç»Ÿæ°”æ³¡'}`);
                } catch (error) {
                  Logger.error('SettingsPage', `ä¿å­˜æ¶ˆæ¯å¸ƒå±€æ ·å¼å¤±è´¥: ${error}`);
                }
              } else if (item.title === 'APIè°ƒç”¨æ¨¡å¼') {
                Logger.info('SettingsPage', `ç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢APIæ¨¡å¼: ${isOn ? 'ç›´è¿' : 'æœåŠ¡å™¨ä»£ç†'}`);
                await this.handleAPIModeChange(isOn, true); // trueè¡¨ç¤ºæ‰‹åŠ¨åˆ‡æ¢
              } else if (item.title === 'æ”¶åˆ°å›å¤æ—¶æ’­æ”¾') {
                await this.updateAutoTTSSetting('autoPlayOnReceive', isOn);
              }
            })
        } else if (item.type === 'slider') {
          Column() {
            Slider({
              value: item.numValue || 0,
              min: item.minValue || 0,
              max: item.maxValue || 1,
              step: item.step || 0.1
            })
              .width(120)
              .trackColor($r('app.color.border_color'))
              .selectedColor($r('app.color.primary_color'))
              .blockColor($r('app.color.primary_color'))
              .onChange(async (value: number) => {
                if (item.title === 'è¯­éŸ³é€Ÿåº¦') {
                  await this.updateAutoTTSSetting('speed', value);
                } else if (item.title === 'éŸ³é‡å¤§å°') {
                  await this.updateAutoTTSSetting('volume', value);
                } else if (item.title === 'éŸ³è°ƒé«˜ä½') {
                  await this.updateAutoTTSSetting('pitch', value);
                } else if (item.title === 'èŠå¤©å­—ä½“å¤§å°') {
                  await this.updateChatFontSize(value);
                } else if (item.title === 'ä»£ç å­—ä½“å¤§å°') {
                  await this.updateCodeFontSize(value);
                }
              })
          }
        } else if (item.type === 'avatar') {
          // æ ¹æ®æ ‡é¢˜åˆ¤æ–­æ˜¯ç”¨æˆ·å¤´åƒè¿˜æ˜¯AIå¤´åƒï¼Œç›´æ¥ä½¿ç”¨æœ€æ–°çš„avatarSettingsæ•°æ®
          this.buildAvatarPreview(item.title === 'æˆ‘çš„å¤´åƒ')
        } else if (item.type === 'input' || item.type === 'button') {
          Text('>')
            .fontSize(16)
            .fontColor($r('app.color.text_secondary'))
        }
      }
      .width('100%')
      .height(64)
      .alignItems(VerticalAlign.Center)
      .onClick(() => {
        Logger.info('SettingsPage', `è®¾ç½®é¡¹è¢«ç‚¹å‡»: ${item.title}, ç±»å‹: ${item.type}`);
        if (item.type === 'input' && item.title === 'æœåŠ¡å™¨åœ°å€') {
          this.showServerUrlDialog();
        } else if (item.type === 'avatar') {
          this.showAvatarSelectionDialog(item.title);
        } else if (item.type === 'button') {
          this.handleButtonClick(item.title);
        } else if (item.title === 'å­—ä½“å®¶æ—') {
          this.showFontFamilyDialog = true;
        }
      })

      if (!isLast) {
        Divider()
          .color($r('app.color.border_color'))
          .height(0.5)
          .margin({ left: 0, right: 0 })
      }
    }
    .padding({ left: 16, right: 16 })
  }

  // æœåŠ¡å™¨åœ°å€è¾“å…¥å¯¹è¯æ¡†çŠ¶æ€
  @Local showServerInputDialog: boolean = false;
  @Local serverInputIp: string = '';
  @Local serverInputPort: string = '';
  @Local serverInputProtocol: 'http' | 'https' = 'http';
  @Local serverInputError: string = '';

  // å­—ä½“å®¶æ—é€‰æ‹©å¯¹è¯æ¡†çŠ¶æ€
  @Local showFontFamilyDialog: boolean = false;
  
  
  private showServerUrlDialog(): void {
    // åˆå§‹åŒ–è¾“å…¥æ¡†çš„å€¼ä¸ºå½“å‰æœåŠ¡å™¨é…ç½®
    this.serverInputIp = this.currentServer.ip;
    this.serverInputPort = this.currentServer.port.toString();
    this.serverInputProtocol = this.currentServer.protocol;
    this.serverInputError = '';
    this.showServerInputDialog = true;
  }

  private async saveServerConfig(): Promise<void> {
    try {
      // éªŒè¯è¾“å…¥
      const ip = this.serverInputIp.trim();
      const port = parseInt(this.serverInputPort);
      
      if (!ip) {
        this.serverInputError = 'IPåœ°å€ä¸èƒ½ä¸ºç©º';
        return;
      }
      
      if (!this.serverConfigManager.validateIpFormat(ip)) {
        this.serverInputError = 'IPåœ°å€æ ¼å¼ä¸æ­£ç¡®';
        return;
      }
      
      if (isNaN(port) || !this.serverConfigManager.validatePort(port)) {
        this.serverInputError = 'ç«¯å£èŒƒå›´: 1-65535';
        return;
      }
      
      // åˆ›å»ºæ–°çš„æœåŠ¡å™¨é…ç½®
      const newEndpoint: ServerEndpoint = {
        ip: ip,
        port: port,
        protocol: this.serverInputProtocol,
        wsProtocol: this.serverInputProtocol === 'https' ? 'wss' : 'ws',
        description: 'è‡ªå®šä¹‰æœåŠ¡å™¨'
      };
      
      // æ›´æ–°æœåŠ¡å™¨é…ç½®
      await this.serverConfigManager.setCurrentServer(newEndpoint);
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      this.currentServer = newEndpoint;
      
      // åŒæ­¥åˆ°AppConfigManager
      const configManager = AppConfigManager.getInstance();
      await configManager.updateServerEndpoint(newEndpoint);
      
      // å…³é—­å¯¹è¯æ¡†
      this.showServerInputDialog = false;
      
      Logger.info('SettingsPage', `æœåŠ¡å™¨é…ç½®å·²æ›´æ–°: ${newEndpoint.protocol}://${newEndpoint.ip}:${newEndpoint.port}`);
      
      // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
      const testResult = await this.serverConfigManager.validateServer(newEndpoint);
      
      // æ˜¾ç¤ºä¿å­˜ç»“æœ
      if (testResult.success) {
        AlertDialog.show({
          title: 'é…ç½®å·²ä¿å­˜',
          message: `æœåŠ¡å™¨åœ°å€å·²æ›´æ–°ä¸º: ${newEndpoint.protocol}://${newEndpoint.ip}:${newEndpoint.port}\nè¿æ¥æµ‹è¯•æˆåŠŸï¼å“åº”æ—¶é—´: ${testResult.responseTime}ms`,
          confirm: {
            value: 'ç¡®å®š',
            action: () => {}
          }
        });
      } else {
        AlertDialog.show({
          title: 'é…ç½®å·²ä¿å­˜',
          message: `æœåŠ¡å™¨åœ°å€å·²æ›´æ–°ä¸º: ${newEndpoint.protocol}://${newEndpoint.ip}:${newEndpoint.port}\nâš ï¸ è¿æ¥æµ‹è¯•å¤±è´¥: ${testResult.errorMessage}`,
          confirm: {
            value: 'ç¡®å®š',
            action: () => {}
          }
        });
      }
      
    } catch (error) {
      Logger.error('SettingsPage', `ä¿å­˜æœåŠ¡å™¨é…ç½®å¤±è´¥: ${error}`);
      this.serverInputError = `ä¿å­˜å¤±è´¥: ${(error as Error).message}`;
    }
  }

  private handleButtonClick(title: string): void {
    Logger.info('SettingsPage', `handleButtonClickè¢«è°ƒç”¨: ${title}`);
    switch (title) {
      case 'æœåŠ¡å™¨é…ç½®':
        Logger.info('SettingsPage', 'è·³è½¬åˆ°æœåŠ¡å™¨è®¾ç½®é¡µé¢');
        this.navigateToServerSettings();
        break;
      case 'æœåŠ¡å™¨åœ°å€':
        this.showServerUrlDialog();
        break;
      case 'ä¸ªäººèµ„æ–™':
        this.navigateToProfileEdit();
        break;
      case 'æ¸…é™¤èŠå¤©è®°å½•':
        this.showClearHistoryDialog();
        break;
      case 'é‡ç½®æ¨¡å‹é€‰æ‹©':
        this.showClearModelConfigDialog();
        break;
      case 'APIå¯†é’¥ç®¡ç†':
        this.navigateToAPIKeyManager();
        break;
      case 'è§’è‰²ç®¡ç†':
        this.navigateToPromptManager();
        break;
      case 'MCPè®¾ç½®':
        this.navigateToMCPSettings();
        break;
      case 'è®°å¿†ä¸­å¿ƒ':
        this.navigateToMemoryManager();
        break;
      case 'å…³äºåº”ç”¨':
        this.showAbout();
        break;
      case 'å¼€å‘è€…ä¿¡æ¯':
        this.showDeveloperInfo();
        break;
      default:
        Logger.warn('SettingsPage', `æœªçŸ¥çš„æŒ‰é’®ç‚¹å‡»: ${title}`);
    }
  }

  @Builder
  buildAvatarPreview(isUserAvatar: boolean) {
    if ((isUserAvatar ? this.userAvatarType : this.aiAvatarType) === 'emoji') {
      Text(isUserAvatar ? this.userAvatarValue : this.aiAvatarValue)
        .fontSize(24)
        .width(40)
        .height(40)
        .textAlign(TextAlign.Center)
        .borderRadius(20)
        .backgroundColor($r('app.color.input_background'))
    } else if ((isUserAvatar ? this.userAvatarType : this.aiAvatarType) === 'image') {
      Image(isUserAvatar ? this.userAvatarValue : this.aiAvatarValue)
        .width(40)
        .height(40)
        .borderRadius(20)
        .objectFit(ImageFit.Cover)
    } else {
      Circle({ width: 40, height: 40 })
        .fill(isUserAvatar ? this.userAvatarValue : this.aiAvatarValue)
    }
  }


  
  private navigateToServerSettings(): void {
    Logger.info('SettingsPage', 'å¯¼èˆªåˆ°æœåŠ¡å™¨è®¾ç½®é¡µé¢');
    router.pushUrl({ 
      url: 'pages/ServerSettingsPage'
    }).catch((error: Error) => {
      Logger.error('SettingsPage', `è·³è½¬å¤±è´¥: ${error.message}`);
    });
  }

  private navigateToPromptManager(): void {
    router.pushUrl({
      url: 'pages/RoleManagerPage',
      params: { fromSettingsPage: true }
    });
  }

  private navigateToMCPSettings(): void {
    router.pushUrl({
      url: 'pages/MCPSettingsPage'
    }).catch((error: Error) => {
      Logger.error('SettingsPage', `è·³è½¬åˆ°MCPè®¾ç½®é¡µé¢å¤±è´¥: ${error.message}`);
    });
  }

  private navigateToMemoryManager(): void {
    router.pushUrl({
      url: 'pages/MemoryManagerPage'
    }).catch((error: Error) => {
      Logger.error('SettingsPage', `è·³è½¬åˆ°è®°å¿†ä¸­å¿ƒé¡µé¢å¤±è´¥: ${error.message}`);
    });
  }

  private navigateToAPIKeyManager(): void {
    router.pushUrl({
      url: 'pages/APIKeyManagerPage'
    });
  }

  private navigateToProfileEdit(): void {
    router.pushUrl({ 
      url: 'pages/UserProfileEditPage'
    });
  }


  private showAbout(): void {
    AlertDialog.show({
      title: 'å…³äºåº”ç”¨',
      message: 'ğŸ¤– Javis - æ™ºèƒ½AIç¼–ç¨‹åŠ©æ‰‹ v1.0.0\n\nä¸€æ¬¾åŸºäºé¸¿è’™ç³»ç»Ÿçš„æ™ºèƒ½AIç¼–ç¨‹åŠ©æ‰‹åº”ç”¨ï¼Œé€šè¿‡é›†æˆå¤šä¸ªå¤§è¯­è¨€æ¨¡å‹APIï¼Œä¸ºå¼€å‘è€…æä¾›æ™ºèƒ½ç¼–ç¨‹è¾…åŠ©ã€ä»£ç ç”Ÿæˆã€é—®é¢˜è§£ç­”ç­‰å…¨æ–¹ä½æœåŠ¡ã€‚\n\nâœ¨ æ ¸å¿ƒåŠŸèƒ½ï¼š\nâ€¢ æ™ºèƒ½ç¼–ç¨‹å¯¹è¯ï¼šåŸºäºå¤šå‚å•†å¤§æ¨¡å‹çš„ä»£ç åŠ©æ‰‹\nâ€¢ è¯­éŸ³äº¤äº’ï¼šåä¸ºè¯­éŸ³è¯†åˆ« + TTSè¯­éŸ³æœ—è¯»\nâ€¢ å¤šæ¨¡å‹æ”¯æŒï¼šClaudeã€Qwenã€DeepSeekã€Google Gemini\nâ€¢ ä»£ç æ‰§è¡Œï¼šPythonã€JavaScriptã€Goã€Bashåœ¨çº¿æ‰§è¡Œ\nâ€¢ è§’è‰²ç®¡ç†ï¼šè‡ªå®šä¹‰AIåŠ©æ‰‹è§’è‰²ï¼Œä¸ªæ€§åŒ–å¯¹è¯ä½“éªŒ\nâ€¢ ç°ä»£åŒ–UIï¼šä¾§è¾¹æ å¯¼èˆªã€ä¸»é¢˜åˆ‡æ¢ã€å¤´åƒç®¡ç†\n\nğŸ¯ æŠ€æœ¯ç‰¹è‰²ï¼š\nâ€¢ ArkTS V2çŠ¶æ€ç®¡ç†ï¼Œå“åº”å¼ç•Œé¢è®¾è®¡\nâ€¢ MVVM + ç»„ä»¶åŒ–å¼€å‘æ¶æ„\nâ€¢ åä¸ºè¯­éŸ³æœåŠ¡å’ŒTTSå¼•æ“é›†æˆ\nâ€¢ WebSocketå®æ—¶é€šä¿¡æ”¯æŒ\nâ€¢ å®‰å…¨çš„ä»£ç æ‰§è¡Œæ²™ç®±ç¯å¢ƒ',
      confirm: {
        value: 'ç¡®å®š',
        action: () => {}
      }
    });
  }

  private showDeveloperInfo(): void {
    const configManager = AppConfigManager.getInstance();
    const privacyConfig = configManager.getPrivacyConfig();
    
    if (!privacyConfig.showDeveloperInfo) {
      return;
    }
    
    let message = `å¼€å‘è€…ï¼š${privacyConfig.developerName}`;
    
    if (privacyConfig.developerContact) {
      message += `\n\nğŸ“§ è”ç³»æ–¹å¼ï¼š\n${privacyConfig.developerContact}`;
    }
    
    if (privacyConfig.githubUrl) {
      message += `\n\nğŸš€ é¡¹ç›®åœ°å€ï¼š\n${privacyConfig.githubUrl}`;
    }
    
    AlertDialog.show({
      title: 'å¼€å‘è€…ä¿¡æ¯',
      message: message,
      confirm: {
        value: 'ç¡®å®š',
        action: () => {}
      }
    });
  }

  private showClearHistoryDialog(): void {
    AlertDialog.show({
      title: 'ç¡®è®¤æ¸…é™¤',
      message: 'æ‚¨ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          Logger.debug('SettingsPage', 'å–æ¶ˆæ¸…é™¤èŠå¤©è®°å½•');
        }
      },
      secondaryButton: {
        value: 'ç¡®è®¤',
        fontColor: Color.Red,
        action: async () => {
          await this.clearAllChatData();
        }
      }
    });
  }

  private showClearModelConfigDialog(): void {
    AlertDialog.show({
      title: 'é‡ç½®æ¨¡å‹é€‰æ‹©',
      message: 'æ˜¯å¦æ¸…é™¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©é…ç½®ï¼Ÿä¸‹æ¬¡å¯åŠ¨æ—¶å°†ä½¿ç”¨é»˜è®¤æ¨¡å‹ã€‚',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {
          Logger.debug('SettingsPage', 'å–æ¶ˆé‡ç½®æ¨¡å‹é€‰æ‹©');
        }
      },
      secondaryButton: {
        value: 'é‡ç½®',
        fontColor: $r('app.color.primary_color'),
        action: async () => {
          await this.clearModelConfig();
        }
      }
    });
  }

  /**
   * æ¸…é™¤æ‰€æœ‰èŠå¤©æ•°æ®
   */
  private async clearAllChatData(): Promise<void> {
    try {
      Logger.info('SettingsPage', 'å¼€å§‹æ¸…é™¤æ‰€æœ‰èŠå¤©æ•°æ®...');
      
      // æ¸…é™¤æ—§çš„æ¶ˆæ¯å­˜å‚¨ï¼ˆå…¼å®¹æ€§ï¼‰
      await StorageManager.clearMessages();
      Logger.info('SettingsPage', 'æ—§æ¶ˆæ¯å­˜å‚¨å·²æ¸…é™¤');
      
      // è·å–æ‰€æœ‰ä¼šè¯å¹¶åˆ é™¤æ¯ä¸ªä¼šè¯çš„æ¶ˆæ¯
      const sessions = await StorageManager.getSessions();
      Logger.info('SettingsPage', `æ‰¾åˆ° ${sessions.length} ä¸ªä¼šè¯ï¼Œå¼€å§‹åˆ é™¤æ¶ˆæ¯`);
      
      for (const session of sessions) {
        await StorageManager.deleteSessionMessages(session.id);
        Logger.debug('SettingsPage', `ä¼šè¯ ${session.id} çš„æ¶ˆæ¯å·²åˆ é™¤`);
      }
      
      // æ¸…ç©ºæ‰€æœ‰ä¼šè¯
      await StorageManager.clearSessions();
      Logger.info('SettingsPage', 'æ‰€æœ‰ä¼šè¯å·²æ¸…ç©º');
      
      // æ¸…é™¤å½“å‰ä¼šè¯ID
      await StorageManager.setCurrentSessionId('');
      Logger.info('SettingsPage', 'å½“å‰ä¼šè¯IDå·²æ¸…é™¤');
      
      // é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨ä¼šè¯æ•°æ®å·²æ¸…é™¤
      StorageManager.notifySessionDataClearedListeners();
      Logger.info('SettingsPage', 'å·²é€šçŸ¥ç›‘å¬å™¨ä¼šè¯æ•°æ®å·²æ¸…é™¤');
      
      Logger.info('SettingsPage', 'âœ… æ‰€æœ‰èŠå¤©æ•°æ®æ¸…é™¤å®Œæˆ');
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      AlertDialog.show({
        title: 'æ¸…é™¤æˆåŠŸ',
        message: 'æ‰€æœ‰èŠå¤©è®°å½•å·²æˆåŠŸæ¸…é™¤',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
      
    } catch (error) {
      Logger.error('SettingsPage', `æ¸…é™¤èŠå¤©æ•°æ®å¤±è´¥: ${error}`);
      
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      AlertDialog.show({
        title: 'æ¸…é™¤å¤±è´¥',
        message: `æ¸…é™¤èŠå¤©è®°å½•æ—¶å‘ç”Ÿé”™è¯¯: ${(error as Error).message}`,
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    }
  }

  /**
   * æ¸…é™¤æ¨¡å‹é€‰æ‹©é…ç½®
   */
  private async clearModelConfig(): Promise<void> {
    try {
      Logger.info('SettingsPage', 'å¼€å§‹æ¸…é™¤æ¨¡å‹é€‰æ‹©é…ç½®...');
      
      // æ¸…é™¤ä¿å­˜çš„æ¨¡å‹é€‰æ‹©é…ç½®
      await StorageManager.clearCurrentModel();
      Logger.info('SettingsPage', 'æ¨¡å‹é€‰æ‹©é…ç½®å·²æ¸…é™¤');
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      AlertDialog.show({
        title: 'é‡ç½®æˆåŠŸ',
        message: 'æ¨¡å‹é€‰æ‹©é…ç½®å·²æ¸…é™¤ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶å°†ä½¿ç”¨é»˜è®¤æ¨¡å‹',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
      
    } catch (error) {
      Logger.error('SettingsPage', `æ¸…é™¤æ¨¡å‹é…ç½®å¤±è´¥: ${error}`);
      
      // æ˜¾ç¤ºé”™è¯¯æç¤º
      AlertDialog.show({
        title: 'é‡ç½®å¤±è´¥',
        message: `æ¸…é™¤æ¨¡å‹é€‰æ‹©é…ç½®æ—¶å‘ç”Ÿé”™è¯¯: ${(error as Error).message}`,
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    }
  }

  /**
   * æ›´æ–°è‡ªåŠ¨æ’­æŠ¥è®¾ç½®
   */
  private async updateAutoTTSSetting(key: keyof AutoTTSSettings, value: boolean | number): Promise<void> {
    try {
      const updates: Partial<AutoTTSSettings> = {};
      if (key === 'muted' && typeof value === 'boolean') {
        updates.muted = value;
      } else if (key === 'speed' && typeof value === 'number') {
        updates.speed = value;
      } else if (key === 'volume' && typeof value === 'number') {
        updates.volume = value;
      } else if (key === 'pitch' && typeof value === 'number') {
        updates.pitch = value;
      } else if (key === 'language' && typeof value === 'string') {
        updates.language = value;
      } else if (key === 'autoPlayOnReceive' && typeof value === 'boolean') {
        updates.autoPlayOnReceive = value;
      }
      
      // åŒæ—¶æ›´æ–°AppStorageå’ŒAutoTTSService
      await StorageManager.updateAutoTTSSettings(updates);
      const serviceSettings = await this.autoTTSService.updateSettings(updates);
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      this.autoTTSSettings = {
        muted: serviceSettings.muted,
        speed: serviceSettings.speed,
        volume: serviceSettings.volume,
        pitch: serviceSettings.pitch,
        language: serviceSettings.language,
        autoPlayOnReceive: serviceSettings.autoPlayOnReceive
      };
      
      Logger.info('SettingsPage', `è‡ªåŠ¨æ’­æŠ¥è®¾ç½®å·²æ›´æ–°: ${key} = ${value}`);
    } catch (error) {
      Logger.error('SettingsPage', `æ›´æ–°è‡ªåŠ¨æ’­æŠ¥è®¾ç½®å¤±è´¥: ${error}`);
    }
  }

  private getAvatarDisplayText(avatarType: string, avatarValue: string): string {
    switch (avatarType) {
      case 'emoji':
        return `è¡¨æƒ…ç¬¦å·: ${avatarValue}`;
      case 'image':
        return 'è‡ªå®šä¹‰å›¾ç‰‡';
      case 'default':
      default:
        return `é»˜è®¤é¢œè‰²: ${avatarValue}`;
    }
  }

  private getSwitchValue(item: SettingItem): boolean {
    // ç›´æ¥ä½¿ç”¨çŠ¶æ€å˜é‡ï¼Œç¡®ä¿å®æ—¶çŠ¶æ€åæ˜ åˆ°UI
    switch (item.title) {
      case 'é€šçŸ¥':
        return this.enableNotifications;
      case 'æ¶ˆæ¯æ ·å¼':
        return this.useModernMessageLayout;
      case 'APIè°ƒç”¨æ¨¡å¼':
        return this.currentAPIMode === APIMode.DIRECT_CALL;
      case 'æ”¶åˆ°å›å¤æ—¶æ’­æ”¾':
        return this.autoTTSSettings.autoPlayOnReceive;
      default:
        return item.value || false;
    }
  }

  private getDynamicSubtitle(item: SettingItem): string {
    if (item.type === 'avatar') {
      if (item.title === 'æˆ‘çš„å¤´åƒ') {
        return this.getAvatarDisplayText(this.userAvatarType, this.userAvatarValue);
      } else if (item.title === 'AIå¤´åƒ') {
        return this.getAvatarDisplayText(this.aiAvatarType, this.aiAvatarValue);
      }
    } else if (item.type === 'slider') {
      if (item.title === 'è¯­éŸ³é€Ÿåº¦') {
        return `å½“å‰: ${this.autoTTSSettings.speed.toFixed(1)}x`;
      } else if (item.title === 'éŸ³é‡å¤§å°') {
        return `å½“å‰: ${Math.round(this.autoTTSSettings.volume * 100)}%`;
      } else if (item.title === 'éŸ³è°ƒé«˜ä½') {
        return `å½“å‰: ${this.autoTTSSettings.pitch.toFixed(1)}`;
      } else if (item.title === 'èŠå¤©å­—ä½“å¤§å°') {
        return `å½“å‰: ${this.fontSettings.chatFontSize}px`;
      } else if (item.title === 'ä»£ç å­—ä½“å¤§å°') {
        return `å½“å‰: ${this.fontSettings.codeFontSize}px`;
      } else if (item.title === 'å­—ä½“å®¶æ—') {
        return `å½“å‰: ${FontManager.getFontFamilyDisplayText(this.fontSettings.fontFamily)}`;
      }
    }
    return item.subtitle || '';
  }

  private showAvatarSelectionDialog(title: string): void {
    const isUserAvatar = title === 'æˆ‘çš„å¤´åƒ';
    const avatarOptions: AvatarOption[] = [
      { text: 'é»˜è®¤è“è‰²', value: 'default:#4285F4' },
      { text: 'é»˜è®¤ç»¿è‰²', value: 'default:#34A853' },
      { text: 'é»˜è®¤çº¢è‰²', value: 'default:#EA4335' },
      { text: 'é»˜è®¤æ©™è‰²', value: 'default:#FBBC05' },
      { text: 'é»˜è®¤ç´«è‰²', value: 'default:#9C27B0' },
      { text: 'ğŸ˜€', value: 'emoji:ğŸ˜€' },
      { text: 'ğŸ™‚', value: 'emoji:ğŸ™‚' },
      { text: 'ğŸ˜Š', value: 'emoji:ğŸ˜Š' },
      { text: 'ğŸ¤”', value: 'emoji:ğŸ¤”' },
      { text: 'ğŸ¤–', value: 'emoji:ğŸ¤–' },
      { text: 'ğŸ‘¨â€ğŸ’»', value: 'emoji:ğŸ‘¨â€ğŸ’»' },
      { text: 'ğŸ‘©â€ğŸ’»', value: 'emoji:ğŸ‘©â€ğŸ’»' },
      { text: 'é€‰æ‹©å›¾ç‰‡', value: 'image:select' }
    ];

    // ç›´æ¥æ˜¾ç¤ºé€‰æ‹©åˆ—è¡¨ï¼Œä¸æ˜¾ç¤ºAlertDialog
    this.showAvatarGridDialog(isUserAvatar, avatarOptions);
  }

  private showAvatarActionDialog(isUserAvatar: boolean): void {
    ActionSheet.show({
      title: 'å¤´åƒé€‰é¡¹',
      message: 'é€‰æ‹©æ“ä½œ',
      sheets: [
        {
          title: 'é€‰æ‹©æœ¬åœ°å›¾ç‰‡',
          action: () => {
            this.selectImageFromGallery(isUserAvatar);
          }
        },
        {
          title: 'é‡ç½®ä¸ºé»˜è®¤',
          action: async () => {
            await this.resetAvatar(isUserAvatar);
          }
        }
      ],
      cancel: () => {
        // å–æ¶ˆå¤´åƒé€‰æ‹©
      }
    });
  }

  private showAvatarGridDialog(isUserAvatar: boolean, options: AvatarOption[]): void {
    // è¿™é‡Œä½¿ç”¨ç®€åŒ–çš„åˆ—è¡¨é€‰æ‹©
    const optionTexts = options.map((opt: AvatarOption) => opt.text);
    
    TextPickerDialog.show({
      range: optionTexts,
      selected: 0,
      onAccept: async (value: TextPickerResult) => {
        const selectedIndex: number = value.index as number;
        const selectedOption = options[selectedIndex];
        
        if (selectedOption.value === 'image:select') {
          await this.selectImageFromGallery(isUserAvatar);
        } else {
          const parts = selectedOption.value.split(':');
          const type = parts[0] as 'default' | 'emoji';
          const val = parts[1];
          await this.updateAvatarSetting(isUserAvatar, type, val);
        }
      },
      onCancel: () => {
        // å–æ¶ˆå¤´åƒé€‰æ‹©
      }
    });
  }

  private async selectImageFromGallery(isUserAvatar: boolean): Promise<void> {
    try {
      const photoSelectOptions: picker.PhotoSelectOptions = {
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      };

      const photoPicker: picker.PhotoViewPicker = new picker.PhotoViewPicker();
      const photoSelectResult: picker.PhotoSelectResult = await photoPicker.select(photoSelectOptions);

      if (photoSelectResult.photoUris.length > 0) {
        const imageUri: string = photoSelectResult.photoUris[0];
        await this.updateAvatarSetting(isUserAvatar, 'image', imageUri);
        // å¤´åƒå›¾ç‰‡é€‰æ‹©æˆåŠŸ
      }
    } catch (error) {
      Logger.error('SettingsPage', `é€‰æ‹©å¤´åƒå›¾ç‰‡å¤±è´¥: ${error}`);
      AlertDialog.show({
        title: 'é€‰æ‹©å¤±è´¥',
        message: 'æ— æ³•é€‰æ‹©å›¾ç‰‡ï¼Œè¯·é‡è¯•',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    }
  }

  private async resetAvatar(isUserAvatar: boolean): Promise<void> {
    const defaultColor = isUserAvatar ? '#4285F4' : '#34A853';
    await this.updateAvatarSetting(isUserAvatar, 'default', defaultColor);
    // å¤´åƒå·²é‡ç½®ä¸ºé»˜è®¤
  }

  private async updateAvatarSetting(isUserAvatar: boolean, type: 'default' | 'emoji' | 'image', value: string): Promise<void> {
    try {
      // ç›´æ¥ä¿®æ”¹æœ¬åœ°çŠ¶æ€ï¼Œ@Computedä¼šè‡ªåŠ¨å¤„ç†UIæ›´æ–°
      if (isUserAvatar) {
        this.userAvatarType = type;
        this.userAvatarValue = value;
      } else {
        this.aiAvatarType = type;
        this.aiAvatarValue = value;
      }
      
      // ä¿å­˜åˆ°å­˜å‚¨å¹¶é€šçŸ¥å…¶ä»–ç»„ä»¶
      const avatarSettings = new AvatarSettings(
        this.userAvatarType,
        this.userAvatarValue,
        this.aiAvatarType,
        this.aiAvatarValue
      );
      await StorageManager.updateAvatarSettings(avatarSettings.toObject());
    } catch (error) {
      Logger.error('SettingsPage', `æ›´æ–°å¤´åƒè®¾ç½®å¤±è´¥: ${error}`);
    }
  }

  
  //=================== APIæ¨¡å¼ç›¸å…³æ–¹æ³• ===================

  /**
   * å¤„ç†APIæ¨¡å¼åˆ‡æ¢
   * @param isDirectCall æ˜¯å¦ä¸ºç›´è¿æ¨¡å¼
   * @param showDialog æ˜¯å¦æ˜¾ç¤ºåˆ‡æ¢æç¤ºå¯¹è¯æ¡†ï¼Œé»˜è®¤falseï¼ˆç”¨äºåŒºåˆ†æ‰‹åŠ¨åˆ‡æ¢å’Œé¡µé¢åŠ è½½ï¼‰
   */
  private async handleAPIModeChange(isDirectCall: boolean, showDialog: boolean = false): Promise<void> {
    try {
      const newMode = isDirectCall ? APIMode.DIRECT_CALL : APIMode.SERVER_PROXY;
      
      // å¦‚æœæ–°æ¨¡å¼ä¸å½“å‰æ¨¡å¼ç›¸åŒï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
      if (newMode === this.currentAPIMode) {
        Logger.info('SettingsPage', `APIæ¨¡å¼æœªå‘ç”Ÿå˜åŒ– (${newMode})ï¼Œè·³è¿‡åˆ‡æ¢æ“ä½œ`);
        return;
      }
      
      Logger.info('SettingsPage', `åˆ‡æ¢APIè°ƒç”¨æ¨¡å¼: ${this.currentAPIMode} -> ${newMode}`);
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      this.currentAPIMode = newMode;
      
      // è®¾ç½®APIç®¡ç†å™¨æ¨¡å¼
      await this.apiManager.setAPIMode(newMode);
      
      Logger.info('SettingsPage', `APIè°ƒç”¨æ¨¡å¼åˆ‡æ¢å®Œæˆ: ${newMode}`);
      
      // åªåœ¨æ‰‹åŠ¨åˆ‡æ¢æ—¶æ˜¾ç¤ºåˆ‡æ¢æç¤º
      if (showDialog) {
        AlertDialog.show({
          title: 'æ¨¡å¼åˆ‡æ¢æˆåŠŸ',
          message: `å·²åˆ‡æ¢åˆ°${APIManager.getModeDisplayName(newMode)}æ¨¡å¼`,
          confirm: {
            value: 'ç¡®å®š',
            action: () => {}
          }
        });
      }
      
    } catch (error) {
      Logger.error('SettingsPage', `APIæ¨¡å¼åˆ‡æ¢å¤±è´¥: ${error}`);
      
      // åˆ‡æ¢å¤±è´¥ï¼Œæ¢å¤åŸçŠ¶æ€
      this.currentAPIMode = this.currentAPIMode === APIMode.DIRECT_CALL ? APIMode.SERVER_PROXY : APIMode.DIRECT_CALL;
      
      AlertDialog.show({
        title: 'åˆ‡æ¢å¤±è´¥',
        message: `æ— æ³•åˆ‡æ¢APIè°ƒç”¨æ¨¡å¼: ${(error as Error).message}`,
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    }
  }

  /**
   * å¤„ç†æ¶ˆæ¯å¸ƒå±€æ ·å¼åˆ‡æ¢
   */

  //=================== å­—ä½“è®¾ç½®ç›¸å…³æ–¹æ³• ===================

  /**
   * æ›´æ–°èŠå¤©å­—ä½“å¤§å°
   */
  private async updateChatFontSize(size: number): Promise<void> {
    try {
      await this.fontManager.updateChatFontSize(size);
      Logger.info('SettingsPage', `èŠå¤©å­—ä½“å¤§å°å·²æ›´æ–°: ${size}px`);
    } catch (error) {
      Logger.error('SettingsPage', `æ›´æ–°èŠå¤©å­—ä½“å¤§å°å¤±è´¥: ${error}`);
    }
  }

  /**
   * æ›´æ–°ä»£ç å­—ä½“å¤§å°
   */
  private async updateCodeFontSize(size: number): Promise<void> {
    try {
      await this.fontManager.updateCodeFontSize(size);
      Logger.info('SettingsPage', `ä»£ç å­—ä½“å¤§å°å·²æ›´æ–°: ${size}px`);
    } catch (error) {
      Logger.error('SettingsPage', `æ›´æ–°ä»£ç å­—ä½“å¤§å°å¤±è´¥: ${error}`);
    }
  }

  /**
   * æ›´æ–°å­—ä½“å®¶æ—
   */
  private async updateFontFamily(family: 'system' | 'serif' | 'monospace' | 'rounded' | 'elegant' | 'playful' | 'modern' | 'classic'): Promise<void> {
    try {
      Logger.info('SettingsPage', `å¼€å§‹æ›´æ–°å­—ä½“å®¶æ—: ${family}`);
      Logger.info('SettingsPage', `æ›´æ–°å‰å­—ä½“è®¾ç½®: ${JSON.stringify(this.fontSettings)}`);
      await this.fontManager.updateFontFamily(family);
      Logger.info('SettingsPage', `å­—ä½“å®¶æ—å·²æ›´æ–°: ${family}`);
      Logger.info('SettingsPage', `æ›´æ–°åå­—ä½“è®¾ç½®: ${JSON.stringify(this.fontSettings)}`);
    } catch (error) {
      Logger.error('SettingsPage', `æ›´æ–°å­—ä½“å®¶æ—å¤±è´¥: ${error}`);
    }
  }

  // æœåŠ¡å™¨åœ°å€è¾“å…¥å¯¹è¯æ¡†
  @Builder
  ServerInputDialog() {
    Column() {
      Text('æœåŠ¡å™¨è®¾ç½®')
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 24 })

      // IPåœ°å€è¾“å…¥
      Column() {
        Text('æœåŠ¡å™¨åœ°å€')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        TextInput({ placeholder: 'ä¾‹å¦‚: 192.168.1.100 æˆ– localhost' })
          .width('100%')
          .height(48)
          .borderRadius(8)
          .backgroundColor($r('app.color.input_background'))
          .placeholderColor($r('app.color.text_secondary'))
          .fontColor($r('app.color.text_primary'))
          .focusable(true)
          .onChange((value: string) => {
            this.serverInputIp = value;
            if (this.serverInputError) {
              this.serverInputError = '';
            }
          })

        if (this.serverInputError) {
          Text(this.serverInputError)
            .fontSize(14)
            .fontColor('#F44336')
            .alignSelf(ItemAlign.Start)
            .margin({ top: 4 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ bottom: 16 })

      // ç«¯å£å’Œåè®®è¾“å…¥
      Row() {
        Column() {
          Text('ç«¯å£')
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })

          TextInput({ placeholder: '8080' })
            .width('100%')
            .height(48)
            .borderRadius(8)
            .backgroundColor($r('app.color.input_background'))
            .placeholderColor($r('app.color.text_secondary'))
            .fontColor($r('app.color.text_primary'))
            .type(InputType.Number)
            .onChange((value: string) => {
              this.serverInputPort = value;
              if (this.serverInputError) {
                this.serverInputError = '';
              }
            })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Column() {
          Text('åè®®')
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
            .alignSelf(ItemAlign.Start)
            .margin({ bottom: 8 })

          Select([
            { value: 'HTTP' },
            { value: 'HTTPS' }
          ])
            .value(this.serverInputProtocol === 'http' ? 'HTTP' : 'HTTPS')
            .width('100%')
            .height(48)
            .borderRadius(8)
            .backgroundColor($r('app.color.input_background'))
            .fontColor($r('app.color.text_primary'))
            .selectedOptionBgColor($r('app.color.primary_color'))
            .selectedOptionFontColor(Color.White)
            .onSelect((index: number) => {
              this.serverInputProtocol = index === 0 ? 'http' : 'https';
            })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 12 })
        .width(100)
      }
      .width('100%')
      .margin({ bottom: 24 })

      // å½“å‰é…ç½®ä¿¡æ¯
      Column() {
        Text('å½“å‰é…ç½®')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })

        Text(`${this.currentServer.protocol}://${this.currentServer.ip}:${this.currentServer.port}`)
          .fontSize(14)
          .fontColor($r('app.color.text_primary'))
          .alignSelf(ItemAlign.Start)
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ bottom: 24 })

      // æŒ‰é’®è¡Œ
      Row() {
        Button('å–æ¶ˆ')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor($r('app.color.text_secondary'))
          .borderWidth(1)
          .borderColor($r('app.color.text_secondary'))
          .borderRadius(8)
          .layoutWeight(1)
          .height(48)
          .onClick(() => {
            this.showServerInputDialog = false;
            this.serverInputError = '';
          })

        Button('ä¿å­˜')
          .fontSize(16)
          .backgroundColor($r('app.color.primary_color'))
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)
          .height(48)
          .margin({ left: 16 })
          .onClick(() => this.saveServerConfig())
      }
      .width('100%')
    }
    .width('90%')
    .padding(24)
    .backgroundColor($r('app.color.surface_color'))
    .borderRadius(16)
  }

  // å­—ä½“å®¶æ—é€‰æ‹©å¯¹è¯æ¡†
  @Builder
  FontFamilySelectionDialog() {
    Column() {
      // èƒŒæ™¯é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showFontFamilyDialog = false;
        })

      // å¯¹è¯æ¡†å†…å®¹
      Column() {
        Text('é€‰æ‹©å­—ä½“å®¶æ—')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ bottom: 20 })

        // å­—ä½“é€‰é¡¹åˆ—è¡¨
        Column() {
          this.buildFontFamilyOption('system', 'ç³»ç»Ÿé»˜è®¤', 'system-ui, -apple-system, "PingFang SC"')
          Divider().color($r('app.color.border_color')).margin({ top: 1, bottom: 1 })

          this.buildFontFamilyOption('modern', 'ç°ä»£å­—ä½“', '"SF Pro Display", "Roboto", "Noto Sans CJK SC"')
          Divider().color($r('app.color.border_color')).margin({ top: 1, bottom: 1 })

          this.buildFontFamilyOption('elegant', 'ä¼˜é›…å­—ä½“', '"Optima", "Avenir Next", "PingFang SC"')
          Divider().color($r('app.color.border_color')).margin({ top: 1, bottom: 1 })

          this.buildFontFamilyOption('rounded', 'åœ†æ¶¦å­—ä½“', '"SF Pro Rounded", "PingFang SC"')
          Divider().color($r('app.color.border_color')).margin({ top: 1, bottom: 1 })

          this.buildFontFamilyOption('serif', 'è¡¬çº¿å­—ä½“', 'Georgia, "Times New Roman", "Songti SC"')
          Divider().color($r('app.color.border_color')).margin({ top: 1, bottom: 1 })

          this.buildFontFamilyOption('classic', 'ç»å…¸å­—ä½“', '"Palatino", "Book Antiqua", "Times New Roman"')
          Divider().color($r('app.color.border_color')).margin({ top: 1, bottom: 1 })

          this.buildFontFamilyOption('monospace', 'ç­‰å®½å­—ä½“', 'Monaco, Consolas, "SF Mono"')
          Divider().color($r('app.color.border_color')).margin({ top: 1, bottom: 1 })

          this.buildFontFamilyOption('playful', 'æ´»æ³¼å­—ä½“', '"Comic Sans MS", "Marker Felt"')
        }
        .backgroundColor($r('app.color.surface_color'))
        .borderRadius(12)
        .padding({ top: 8, bottom: 8 })

        // å–æ¶ˆæŒ‰é’®
        Button('å–æ¶ˆ')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor($r('app.color.text_secondary'))
          .borderWidth(1)
          .borderColor($r('app.color.border_color'))
          .borderRadius(8)
          .width('100%')
          .height(44)
          .margin({ top: 16 })
          .onClick(() => {
            this.showFontFamilyDialog = false;
          })
      }
      .width('80%')
      .padding(20)
      .backgroundColor($r('app.color.surface_color'))
      .borderRadius(16)
      .position({ x: '50%', y: '50%' })
      .translate({ x: '-50%', y: '-50%' })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildFontFamilyOption(
    family: 'system' | 'serif' | 'monospace' | 'rounded' | 'elegant' | 'playful' | 'modern' | 'classic',
    displayName: string,
    previewText: string
  ) {
    Row() {
      Column({ space: 4 }) {
        Text(displayName)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .alignSelf(ItemAlign.Start)

        Text(previewText)
          .fontSize(13)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // é€‰ä¸­æ ‡è¯†
      if (this.fontSettings.fontFamily === family) {
        Text('âœ“')
          .fontSize(18)
          .fontColor($r('app.color.primary_color'))
      }
    }
    .width('100%')
    .height(64)
    .padding({ left: 16, right: 16 })
    .alignItems(VerticalAlign.Center)
    .onClick(async () => {
      await this.updateFontFamily(family);
      this.showFontFamilyDialog = false;
    })
  }
}
