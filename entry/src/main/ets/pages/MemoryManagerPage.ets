import { router } from '@kit.ArkUI';
import { MemoryManager, MemoryItemWithoutId } from '../utils/MemoryManager';
import { MemoryItem, MemoryStats, MemoryCategory, MemoryImportance, ObservableMemoryStats, ObservableMemoryCategoryCounts, ObservableMemoryImportanceCounts } from '../types/MemoryTypes';
import { MemoryItemComponent } from '../components/MemoryItemComponent';
import { Logger } from '../utils/Logger';
import { BasicAnimations, AnimationConfigManager } from '../animations';

interface MemoryItemWithId extends MemoryItem {
  id: string;
}



/**
 * ËÆ∞ÂøÜ‰∏≠ÂøÉÈ°µÈù¢
 * ÁÆ°ÁêÜÁî®Êà∑ÁöÑËÆ∞ÂøÜÁ¢éÁâáÔºåÊîØÊåÅÊü•Áúã„ÄÅÊ∑ªÂä†„ÄÅÁºñËæë„ÄÅÂà†Èô§ËÆ∞ÂøÜ
 */
@Entry
@ComponentV2
struct MemoryManagerPage {
  @Local private memoryItems: MemoryItemWithId[] = [];
  @Local private memoryStats: ObservableMemoryStats = new ObservableMemoryStats();
  @Local private selectedCategory: MemoryCategory | 'all' = 'all';
  @Local private selectedImportance: MemoryImportance | 'all' = 'all';
  @Local private searchQuery: string = '';
  @Local private isLoading: boolean = true;
  @Local private showAddDialog: boolean = false;
  @Local private showDeleteDialog: boolean = false;
  @Local private deleteTargetId: string = '';
  @Local private deleteTargetTitle: string = '';
  @Local private statusBarHeight: number = 44;

  // Êñ∞Âª∫ËÆ∞ÂøÜË°®Âçï
  @Local private newMemoryTitle: string = '';
  @Local private newMemoryContent: string = '';
  @Local private newMemoryCategory: MemoryCategory = MemoryCategory.PERSONAL;
  @Local private newMemoryImportance: MemoryImportance = MemoryImportance.MEDIUM;
  @Local private newMemoryTags: string = '';

  // ÁºñËæëËÆ∞ÂøÜË°®Âçï
  @Local private showEditDialog: boolean = false;
  @Local private editMemoryId: string = '';
  @Local private editMemoryTitle: string = '';
  @Local private editMemoryContent: string = '';
  @Local private editMemoryCategory: MemoryCategory = MemoryCategory.PERSONAL;
  @Local private editMemoryImportance: MemoryImportance = MemoryImportance.MEDIUM;
  @Local private editMemoryTags: string = '';

  private readonly PAGE_ENTER_OFFSET: number = 96;
  @Local private pageTranslateX: number = this.PAGE_ENTER_OFFSET;
  @Local private pageOpacity: number = BasicAnimations.HIDDEN_OPACITY;
  private hasPlayedEnterAnimation: boolean = false;
  private animationConfigManager: AnimationConfigManager = AnimationConfigManager.getInstance();
  private memoryManager: MemoryManager = MemoryManager.getInstance();

  async aboutToAppear(): Promise<void> {
    Logger.info('MemoryManagerPage', 'È°µÈù¢ÂàùÂßãÂåñÂºÄÂßã');
    this.resetEnterAnimationState();

    try {
      await this.loadMemoryData();
    } catch (error) {
      Logger.error('MemoryManagerPage', `È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•: ${error}`);
    }
  }

  onPageShow(): void {
    Logger.info('MemoryManagerPage', 'È°µÈù¢ÊòæÁ§∫');
    this.playEnterTransition();

    // È°µÈù¢ÊòæÁ§∫Êó∂ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
    this.loadMemoryData();
  }

  private resetEnterAnimationState(): void {
    this.pageTranslateX = this.PAGE_ENTER_OFFSET;
    this.pageOpacity = BasicAnimations.HIDDEN_OPACITY;
    this.hasPlayedEnterAnimation = false;
  }

  private playEnterTransition(): void {
    if (this.hasPlayedEnterAnimation) {
      return;
    }

    this.hasPlayedEnterAnimation = true;
    const duration = this.animationConfigManager.getDuration(BasicAnimations.STANDARD_DURATION);
    const curve = this.animationConfigManager.getCurve();

    animateTo({
      duration,
      curve
    }, () => {
      this.pageTranslateX = 0;
      this.pageOpacity = BasicAnimations.STANDARD_OPACITY;
    });
  }

  private async loadMemoryData(): Promise<void> {
    try {
      this.isLoading = true;

      // Âä†ËΩΩËÆ∞ÂøÜÁªüËÆ°‰ø°ÊÅØ
      const stats = await this.memoryManager.getMemoryStats();
      this.memoryStats.updateFromStats(stats);
      Logger.info('MemoryManagerPage', `ËÆ∞ÂøÜÁªüËÆ°‰ø°ÊÅØÂä†ËΩΩÊàêÂäü: ÊÄªËÆ°${this.memoryStats.totalFragments}‰∏™`);

      // Âä†ËΩΩËÆ∞ÂøÜÂàóË°®
      await this.loadMemoryItems();

    } catch (error) {
      Logger.error('MemoryManagerPage', `Âä†ËΩΩËÆ∞ÂøÜÊï∞ÊçÆÂ§±Ë¥•: ${error}`);
    } finally {
      this.isLoading = false;
    }
  }

  private async loadMemoryItems(): Promise<void> {
    try {
      const items: MemoryItem[] = await this.memoryManager.getMemoryItems();

      // ËΩ¨Êç¢‰∏∫Â∏¶IDÁöÑÊï∞ÁªÑÔºå‰øùÊåÅÂéüÂßãID
      const memoryItemsWithId: MemoryItemWithId[] = items.map((item: MemoryItem) => {
        const memoryItem: MemoryItemWithId = {
          id: item.id, // üîß ‰øÆÂ§çÔºö‰ΩøÁî®ÂéüÂßãIDËÄå‰∏çÊòØÁîüÊàêÊñ∞ID
          title: item.title,
          content: item.content,
          tags: item.tags,
          category: item.category,
          importance: item.importance,
          isActive: item.isActive,
          createdAt: item.createdAt,
          updatedAt: item.updatedAt,
          usageCount: item.usageCount,
          lastUsedAt: item.lastUsedAt
        };
        return memoryItem;
      });

      this.memoryItems = memoryItemsWithId;

      Logger.info('MemoryManagerPage', `ËÆ∞ÂøÜÂàóË°®Âä†ËΩΩÊàêÂäü: ${this.memoryItems.length}‰∏™ÔºåIDÁ§∫‰æã: ${this.memoryItems.length > 0 ? this.memoryItems[0].id : 'none'}`);

    } catch (error) {
      Logger.error('MemoryManagerPage', `Âä†ËΩΩËÆ∞ÂøÜÂàóË°®Â§±Ë¥•: ${error}`);
      this.memoryItems = [];
    }
  }

  private getFilteredMemoryItems(): MemoryItemWithId[] {
    let filtered: MemoryItemWithId[] = [...this.memoryItems];

    // ÊåâÂàÜÁ±ªÁ≠õÈÄâ
    if (this.selectedCategory !== 'all') {
      filtered = filtered.filter(item => item.category === this.selectedCategory);
    }

    // ÊåâÈáçË¶ÅÊÄßÁ≠õÈÄâ
    if (this.selectedImportance !== 'all') {
      filtered = filtered.filter(item => item.importance === this.selectedImportance);
    }

    // ÊåâÊêúÁ¥¢ÂÖ≥ÈîÆËØçÁ≠õÈÄâ
    if (this.searchQuery.trim()) {
      const query = this.searchQuery.toLowerCase();
      filtered = filtered.filter(item =>
        item.title.toLowerCase().includes(query) ||
        item.content.toLowerCase().includes(query) ||
        item.tags.some(tag => tag.toLowerCase().includes(query))
      );
    }

    return filtered;
  }

  private showAddMemoryDialog(): void {
    this.resetNewMemoryForm();
    this.showAddDialog = true;
  }

  private resetNewMemoryForm(): void {
    this.newMemoryTitle = '';
    this.newMemoryContent = '';
    this.newMemoryCategory = MemoryCategory.PERSONAL;
    this.newMemoryImportance = MemoryImportance.MEDIUM;
    this.newMemoryTags = '';
  }

  private showEditMemoryDialog(item: MemoryItem): void {
    this.editMemoryId = item.id;
    this.editMemoryTitle = item.title;
    this.editMemoryContent = item.content;
    this.editMemoryCategory = item.category;
    this.editMemoryImportance = item.importance;
    this.editMemoryTags = item.tags.join(', ');
    this.showEditDialog = true;
  }

  private resetEditMemoryForm(): void {
    this.editMemoryId = '';
    this.editMemoryTitle = '';
    this.editMemoryContent = '';
    this.editMemoryCategory = MemoryCategory.PERSONAL;
    this.editMemoryImportance = MemoryImportance.MEDIUM;
    this.editMemoryTags = '';
  }

  private async addNewMemory(): Promise<void> {
    try {
      if (!this.newMemoryContent.trim()) {
        AlertDialog.show({
          title: 'ÊèêÁ§∫',
          message: 'ËØ∑Â°´ÂÜôËÆ∞ÂøÜÂÜÖÂÆπ',
          confirm: {
            value: 'Á°ÆÂÆö',
            action: () => {}
          }
        });
        return;
      }

      const tags: string[] = this.newMemoryTags.split(',').map(tag => tag.trim()).filter(tag => tag);

      const newMemory: MemoryItemWithoutId = {
        title: '', // üîß titleÂ∞ÜÁî±MemoryManagerËá™Âä®ÁîüÊàê
        content: this.newMemoryContent.trim(),
        category: this.newMemoryCategory,
        importance: this.newMemoryImportance,
        tags: tags,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        isActive: true,
        usageCount: 0,
        lastUsedAt: 0
      };

      Logger.info('MemoryManagerPage', `ÂáÜÂ§áÊ∑ªÂä†ËÆ∞ÂøÜ: ${newMemory.title}`);
      const result = await this.memoryManager.addMemoryItem(newMemory);
      Logger.info('MemoryManagerPage', `Ê∑ªÂä†ËÆ∞ÂøÜÁªìÊûú: ${JSON.stringify(result)}`);

      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      Logger.info('MemoryManagerPage', `ÂºÄÂßãÈáçÊñ∞Âä†ËΩΩËÆ∞ÂøÜÊï∞ÊçÆ`);
      await this.loadMemoryData();
      Logger.info('MemoryManagerPage', `ÈáçÊñ∞Âä†ËΩΩÂÆåÊàêÔºåÂΩìÂâçËÆ∞ÂøÜÁªüËÆ°: ÊÄªËÆ°${this.memoryStats.totalFragments}‰∏™ÔºåÊøÄÊ¥ª${this.memoryStats.activeFragments}‰∏™`);

      // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
      this.showAddDialog = false;

      AlertDialog.show({
        title: 'Ê∑ªÂä†ÊàêÂäü',
        message: 'ËÆ∞ÂøÜÁ¢éÁâáÂ∑≤ÊàêÂäüÊ∑ªÂä†',
        confirm: {
          value: 'Á°ÆÂÆö',
          action: () => {}
        }
      });

    } catch (error) {
      Logger.error('MemoryManagerPage', `Ê∑ªÂä†ËÆ∞ÂøÜÂ§±Ë¥•: ${error}`);
      AlertDialog.show({
        title: 'Ê∑ªÂä†Â§±Ë¥•',
        message: `Ê∑ªÂä†ËÆ∞ÂøÜÊó∂ÂèëÁîüÈîôËØØ: ${(error as Error).message}`,
        confirm: {
          value: 'Á°ÆÂÆö',
          action: () => {}
        }
      });
    }
  }

  private showDeleteConfirmDialog(itemId: string, title: string): void {
    this.deleteTargetId = itemId;
    this.deleteTargetTitle = title;
    this.showDeleteDialog = true;
  }

  private async deleteMemory(): Promise<void> {
    try {
      // üîß Â¢ûÂº∫Êó•ÂøóÔºöËÆ∞ÂΩïÂà†Èô§IDÂíåÁé∞ÊúâËÆ∞ÂøÜÂàóË°®
      Logger.info('MemoryManagerPage', `ÂáÜÂ§áÂà†Èô§ËÆ∞ÂøÜÔºåID: ${this.deleteTargetId}ÔºåÊ†áÈ¢ò: ${this.deleteTargetTitle}`);
      Logger.debug('MemoryManagerPage', `ÂΩìÂâçËÆ∞ÂøÜÂàóË°®ÈïøÂ∫¶: ${this.memoryItems.length}`);
      if (this.memoryItems.length > 0) {
        Logger.debug('MemoryManagerPage', `Áé∞ÊúâËÆ∞ÂøÜIDÂàóË°®: ${this.memoryItems.map(item => item.id).slice(0, 3).join(', ')}...`);
      }

      const result = await this.memoryManager.deleteMemoryItem(this.deleteTargetId);
      Logger.info('MemoryManagerPage', `Âà†Èô§ËÆ∞ÂøÜÊìç‰ΩúÂÆåÊàêÔºåÊàêÂäü: ${result ? 'true' : 'false'}`);

      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      Logger.info('MemoryManagerPage', `ÂºÄÂßãÈáçÊñ∞Âä†ËΩΩËÆ∞ÂøÜÊï∞ÊçÆ`);
      await this.loadMemoryData();
      Logger.info('MemoryManagerPage', `ÈáçÊñ∞Âä†ËΩΩÂÆåÊàêÔºåÂΩìÂâçËÆ∞ÂøÜÁªüËÆ°: ÊÄªËÆ°${this.memoryStats.totalFragments}‰∏™ÔºåÊøÄÊ¥ª${this.memoryStats.activeFragments}‰∏™`);

      // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
      this.showDeleteDialog = false;

      AlertDialog.show({
        title: 'Âà†Èô§ÊàêÂäü',
        message: 'ËÆ∞ÂøÜÁ¢éÁâáÂ∑≤ÊàêÂäüÂà†Èô§',
        confirm: {
          value: 'Á°ÆÂÆö',
          action: () => {}
        }
      });

    } catch (error) {
      Logger.error('MemoryManagerPage', `Âà†Èô§ËÆ∞ÂøÜÂ§±Ë¥•ÔºåID: ${this.deleteTargetId}, ÈîôËØØ: ${error}`);
      AlertDialog.show({
        title: 'Âà†Èô§Â§±Ë¥•',
        message: `Âà†Èô§ËÆ∞ÂøÜÊó∂ÂèëÁîüÈîôËØØ: ${(error as Error).message}`,
        confirm: {
          value: 'Á°ÆÂÆö',
          action: () => {}
        }
      });
    }
  }

  private async editMemory(): Promise<void> {
    try {
      if (!this.editMemoryContent.trim()) {
        AlertDialog.show({
          title: 'ÊèêÁ§∫',
          message: 'ËØ∑Â°´ÂÜôËÆ∞ÂøÜÂÜÖÂÆπ',
          confirm: {
            value: 'Á°ÆÂÆö',
            action: () => {}
          }
        });
        return;
      }

      // üîß Â¢ûÂº∫Êó•ÂøóÔºöËÆ∞ÂΩïÁºñËæëIDÂíåÁé∞ÊúâËÆ∞ÂøÜÂàóË°®
      Logger.info('MemoryManagerPage', `ÂáÜÂ§áÁºñËæëËÆ∞ÂøÜÔºåID: ${this.editMemoryId}`);
      Logger.debug('MemoryManagerPage', `ÂΩìÂâçËÆ∞ÂøÜÂàóË°®ÈïøÂ∫¶: ${this.memoryItems.length}`);
      if (this.memoryItems.length > 0) {
        Logger.debug('MemoryManagerPage', `Áé∞ÊúâËÆ∞ÂøÜIDÂàóË°®: ${this.memoryItems.map(item => item.id).slice(0, 3).join(', ')}...`);
      }

      const tags: string[] = this.editMemoryTags.split(',').map(tag => tag.trim()).filter(tag => tag);

      const updatedMemory: MemoryItemWithoutId = {
        title: '', // üîß titleÂ∞ÜÁî±MemoryManagerËá™Âä®ÁîüÊàê
        content: this.editMemoryContent.trim(),
        category: this.editMemoryCategory,
        importance: this.editMemoryImportance,
        tags: tags,
        createdAt: 0, // ‰øùÊåÅÂéüÊúâÂàõÂª∫Êó∂Èó¥
        updatedAt: Date.now(),
        isActive: true,
        usageCount: 0, // ‰øùÊåÅÂéüÊúâ‰ΩøÁî®Ê¨°Êï∞
        lastUsedAt: 0 // ‰øùÊåÅÂéüÊúâÊúÄÂêé‰ΩøÁî®Êó∂Èó¥
      };

      Logger.info('MemoryManagerPage', `ÂáÜÂ§áÁºñËæëËÆ∞ÂøÜ: ${updatedMemory.title}ÔºåID: ${this.editMemoryId}`);
      const result = await this.memoryManager.updateMemoryItem(this.editMemoryId, updatedMemory);
      Logger.info('MemoryManagerPage', `ÁºñËæëËÆ∞ÂøÜÊìç‰ΩúÂÆåÊàêÔºåÊàêÂäü: ${result ? 'true' : 'false'}`);

      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      Logger.info('MemoryManagerPage', `ÂºÄÂßãÈáçÊñ∞Âä†ËΩΩËÆ∞ÂøÜÊï∞ÊçÆ`);
      await this.loadMemoryData();
      Logger.info('MemoryManagerPage', `ÈáçÊñ∞Âä†ËΩΩÂÆåÊàêÔºåÂΩìÂâçËÆ∞ÂøÜÁªüËÆ°: ÊÄªËÆ°${this.memoryStats.totalFragments}‰∏™ÔºåÊøÄÊ¥ª${this.memoryStats.activeFragments}‰∏™`);

      // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
      this.showEditDialog = false;
      this.resetEditMemoryForm();

      AlertDialog.show({
        title: 'ÁºñËæëÊàêÂäü',
        message: 'ËÆ∞ÂøÜÁ¢éÁâáÂ∑≤ÊàêÂäüÊõ¥Êñ∞',
        confirm: {
          value: 'Á°ÆÂÆö',
          action: () => {}
        }
      });

    } catch (error) {
      Logger.error('MemoryManagerPage', `ÁºñËæëËÆ∞ÂøÜÂ§±Ë¥•ÔºåID: ${this.editMemoryId}, ÈîôËØØ: ${error}`);
      AlertDialog.show({
        title: 'ÁºñËæëÂ§±Ë¥•',
        message: `ÁºñËæëËÆ∞ÂøÜÊó∂ÂèëÁîüÈîôËØØ: ${(error as Error).message}`,
        confirm: {
          value: 'Á°ÆÂÆö',
          action: () => {}
        }
      });
    }
  }

  private getCategoryDisplayName(category: MemoryCategory | 'all'): string {
    switch (category) {
      case 'all':
        return 'ÂÖ®ÈÉ®ÂàÜÁ±ª';
      case MemoryCategory.PERSONAL:
        return '‰∏™‰∫∫';
      case MemoryCategory.PREFERENCE:
        return 'ÂÅèÂ•Ω';
      case MemoryCategory.WORK:
        return 'Â∑•‰Ωú';
      case MemoryCategory.STUDY:
        return 'Â≠¶‰π†';
      case MemoryCategory.HOBBY:
        return 'Áà±Â•Ω';
      case MemoryCategory.FAMILY:
        return 'ÂÆ∂Â∫≠';
      case MemoryCategory.HEALTH:
        return 'ÂÅ•Â∫∑';
      case MemoryCategory.CUSTOM:
        return 'Ëá™ÂÆö‰πâ';
      default:
        return 'ÂÖ∂‰ªñ';
    }
  }

  private getImportanceDisplayName(importance: MemoryImportance | 'all'): string {
    switch (importance) {
      case 'all':
        return 'ÂÖ®ÈÉ®ÈáçË¶ÅÊÄß';
      case MemoryImportance.LOW:
        return '‰Ωé';
      case MemoryImportance.MEDIUM:
        return '‰∏≠';
      case MemoryImportance.HIGH:
        return 'È´ò';
      case MemoryImportance.CRITICAL:
        return 'ÂÖ≥ÈîÆ';
      default:
        return '‰∏≠';
    }
  }

  private getImportanceColor(importance: MemoryImportance | 'all'): string {
    switch (importance) {
      case 'all':
        return '#666666';
      case MemoryImportance.LOW:
        return '#4CAF50';
      case MemoryImportance.MEDIUM:
        return '#2196F3';
      case MemoryImportance.HIGH:
        return '#FF9800';
      case MemoryImportance.CRITICAL:
        return '#F44336';
      default:
        return '#2196F3';
    }
  }

  build() {
    Stack() {
      Column() {
        // È°∂ÈÉ®ÂØºËà™Ê†è
        Column() {
          this.buildNavigationBar()
        }
        .margin({ top: this.statusBarHeight })

        // ‰∏ªÂÜÖÂÆπÂå∫Âüü
        if (this.isLoading) {
          this.buildLoadingView()
        } else {
          this.buildMainContent()
        }
      }
      .translate({ x: this.pageTranslateX, y: 0 })
      .opacity(this.pageOpacity)
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.background_color'))

      // Ê∑ªÂä†ËÆ∞ÂøÜÂØπËØùÊ°Ü
      if (this.showAddDialog) {
        this.buildAddMemoryDialog()
      }

      // Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°Ü
      if (this.showDeleteDialog) {
        this.buildDeleteConfirmDialog()
      }

      // ÁºñËæëËÆ∞ÂøÜÂØπËØùÊ°Ü
      if (this.showEditDialog) {
        this.buildEditMemoryDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildNavigationBar() {
    Row() {
      Button('ËøîÂõû')
        .fontSize(15)
        .backgroundColor(Color.Transparent)
        .fontColor($r('app.color.primary_color'))
        .padding({ left: 0, right: 0 })
        .onClick(() => {
          router.back();
        })

      Text('ËÆ∞ÂøÜ‰∏≠ÂøÉ')
        .fontSize(18)
        .fontColor($r('app.color.text_primary'))
        .fontWeight(FontWeight.Medium)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button('Ê∑ªÂä†')
        .fontSize(15)
        .backgroundColor(Color.Transparent)
        .fontColor($r('app.color.primary_color'))
        .padding({ left: 0, right: 0 })
        .onClick(() => {
          this.showAddMemoryDialog();
        })
    }
    .width('100%')
    .height(52)
    .padding({ left: 20, right: 20 })
    .backgroundColor($r('app.color.surface_color'))
    .shadow({
      radius: 2,
      color: '#0D000000',
      offsetY: 1
    })
  }

  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color($r('app.color.primary_color'))

      Text('Âä†ËΩΩ‰∏≠...')
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildMainContent() {
    Column() {
      // ÁªüËÆ°‰ø°ÊÅØÂç°Áâá
      this.buildStatsCard()

      // Á≠õÈÄâÂå∫Âüü
      this.buildFilterSection()

      // ËÆ∞ÂøÜÂàóË°®
      Scroll() {
        Column() {
          if (this.getFilteredMemoryItems().length === 0) {
            this.buildEmptyView()
          } else {
            ForEach(this.getFilteredMemoryItems(), (item: MemoryItemWithId) => {
              MemoryItemComponent({
                memoryItem: item,
                onEdit: (editItem: MemoryItem) => {
                  this.showEditMemoryDialog(editItem);
                },
                onDelete: (itemId: string) => {
                  const item = this.memoryItems.find(i => i.id === itemId);
                  if (item) {
                    this.showDeleteConfirmDialog(itemId, item.title);
                  }
                }
              })
            })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 32 })
        .alignItems(HorizontalAlign.Start)
      }
      .layoutWeight(1)
      .align(Alignment.TopStart)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildStatsCard() {
    Column() {
      Row() {
        Column() {
          Text(this.memoryStats.totalFragments.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))

          Text('ÊÄªËÆ°')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)

        Column() {
          Text(this.memoryStats.activeFragments.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.primary_color'))

          Text('ÊøÄÊ¥ª')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)

        Column() {
          Text(this.memoryStats.totalUsageCount.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#4CAF50')

          Text('‰ΩøÁî®Ê¨°Êï∞')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .height(80)
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .margin({ left: 16, right: 16, top: 16 })
    .padding(16)
    .backgroundColor($r('app.color.surface_color'))
    .borderRadius(12)
  }

  @Builder
  buildFilterSection() {
    Column() {
      // ÊêúÁ¥¢Ê°Ü
      Row() {
        TextInput({ placeholder: 'ÊêúÁ¥¢ËÆ∞ÂøÜ...' })
          .width('100%')
          .height(40)
          .backgroundColor($r('app.color.input_background'))
          .borderRadius(8)
          .placeholderColor($r('app.color.text_secondary'))
          .fontColor($r('app.color.text_primary'))
          .onChange((value: string) => {
            this.searchQuery = value;
          })
      }
      .margin({ bottom: 12 })

      // ÂàÜÁ±ªÂíåÈáçË¶ÅÊÄßÁ≠õÈÄâ
      Row() {
        // ÂàÜÁ±ªÁ≠õÈÄâ
        Row() {
          Select([
            { value: 'ÂÖ®ÈÉ®ÂàÜÁ±ª' },
            { value: '‰∏™‰∫∫' },
            { value: 'ÂÅèÂ•Ω' },
            { value: 'Â∑•‰Ωú' },
            { value: 'Â≠¶‰π†' },
            { value: 'Áà±Â•Ω' },
            { value: 'ÂÆ∂Â∫≠' },
            { value: 'ÂÅ•Â∫∑' },
            { value: 'Ëá™ÂÆö‰πâ' }
          ])
            .selected(this.getCategoryIndex(this.selectedCategory))
            .value(this.getCategoryDisplayName(this.selectedCategory))
            .font({ size: 14 })
            .fontColor($r('app.color.text_primary'))
            .selectedOptionFontColor(Color.White)
            .selectedOptionBgColor($r('app.color.primary_color'))
            .onSelect((index: number) => {
              this.selectedCategory = this.getCategoryByIndex(index);
            })
            .width('100%')
            .height(36)
            .backgroundColor($r('app.color.input_background'))
            .borderRadius(6)
        }
        .layoutWeight(1)
        .margin({ right: 8 })

        // ÈáçË¶ÅÊÄßÁ≠õÈÄâ
        Row() {
          Select([
            { value: 'ÂÖ®ÈÉ®ÈáçË¶ÅÊÄß' },
            { value: '‰Ωé' },
            { value: '‰∏≠' },
            { value: 'È´ò' },
            { value: 'ÂÖ≥ÈîÆ' }
          ])
            .selected(this.getImportanceIndex(this.selectedImportance))
            .value(this.getImportanceDisplayName(this.selectedImportance))
            .font({ size: 14 })
            .fontColor($r('app.color.text_primary'))
            .selectedOptionFontColor(Color.White)
            .selectedOptionBgColor($r('app.color.primary_color'))
            .onSelect((index: number) => {
              this.selectedImportance = this.getImportanceByIndex(index);
            })
            .width('100%')
            .height(36)
            .backgroundColor($r('app.color.input_background'))
            .borderRadius(6)
        }
        .layoutWeight(1)
        .margin({ left: 8 })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .margin({ left: 16, right: 16, top: 12, bottom: 12 })
  }

  @Builder
  buildEmptyView() {
    Column() {
      Image($r('app.media.empty_state'))
        .width(120)
        .height(120)
        .objectFit(ImageFit.Contain)
        .margin({ bottom: 16 })

      Text('ÊöÇÊó†ËÆ∞ÂøÜÁ¢éÁâá')
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
        .margin({ bottom: 8 })

      Text('ÁÇπÂáªÂè≥‰∏äËßíÊ∑ªÂä†ÊåâÈíÆÂàõÂª∫ÊÇ®ÁöÑÁ¨¨‰∏Ä‰∏™ËÆ∞ÂøÜ')
        .fontSize(14)
        .fontColor($r('app.color.text_tertiary'))
        .textAlign(TextAlign.Center)
        .padding({ left: 32, right: 32 })
    }
    .width('100%')
    .margin({ top: 64, bottom: 64 })
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildAddMemoryDialog() {
    Column() {
      // ËÉåÊôØÈÅÆÁΩ©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showAddDialog = false;
        })

      // ÂØπËØùÊ°ÜÂÜÖÂÆπ
      Column() {
        Text('Ê∑ªÂä†ËÆ∞ÂøÜÁ¢éÁâá')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ bottom: 20 })

        Scroll() {
          Column() {
            // Ê†áÈ¢òÊòæÁ§∫ÔºàÂè™ËØªÔºâ
            Column() {
              Row() {
                Text('Ê†áÈ¢ò')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                Text('(Ëá™Âä®ÁîüÊàê)')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ left: 8 })
              }
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })

              TextInput({ placeholder: 'Ê†áÈ¢òÂ∞ÜÂü∫‰∫éÂàõÂª∫Êó∂Èó¥Ëá™Âä®ÁîüÊàê...' })
                .width('100%')
                .height(44)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
                .placeholderColor($r('app.color.text_secondary'))
                .fontColor($r('app.color.text_secondary'))
                .enabled(false) // üîß Á¶ÅÁî®Ê†áÈ¢òÁºñËæë
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })

            // ÂÜÖÂÆπËæìÂÖ•
            Column() {
              Text('ÂÜÖÂÆπ')
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              TextArea({ placeholder: 'ËæìÂÖ•ËÆ∞ÂøÜÂÜÖÂÆπ...' })
                .width('100%')
                .height(100)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
                .placeholderColor($r('app.color.text_secondary'))
                .fontColor($r('app.color.text_primary'))
                .onChange((value: string) => {
                  this.newMemoryContent = value;
                })
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })

            // ÂàÜÁ±ªÈÄâÊã©
            Column() {
              Text('ÂàÜÁ±ª')
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              Select([
                { value: '‰∏™‰∫∫' },
                { value: 'ÂÅèÂ•Ω' },
                { value: 'Â∑•‰Ωú' },
                { value: 'Â≠¶‰π†' },
                { value: 'Áà±Â•Ω' },
                { value: 'ÂÆ∂Â∫≠' },
                { value: 'ÂÅ•Â∫∑' },
                { value: 'Ëá™ÂÆö‰πâ' }
              ])
                .selected(this.getCategoryIndex(this.newMemoryCategory) - 1)
                .value(this.getCategoryDisplayName(this.newMemoryCategory))
                .font({ size: 14 })
                .fontColor($r('app.color.text_primary'))
                .selectedOptionFontColor(Color.White)
                .selectedOptionBgColor($r('app.color.primary_color'))
                .onSelect((index: number) => {
                  const category = this.getCategoryByIndex(index + 1);
                  if (category !== 'all') {
                    this.newMemoryCategory = category;
                  }
                })
                .width('100%')
                .height(40)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })

            // ÈáçË¶ÅÊÄßÈÄâÊã©
            Column() {
              Text('ÈáçË¶ÅÊÄß')
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              Select([
                { value: '‰Ωé' },
                { value: '‰∏≠' },
                { value: 'È´ò' },
                { value: 'ÂÖ≥ÈîÆ' }
              ])
                .selected(this.getImportanceIndex(this.newMemoryImportance) - 1)
                .value(this.getImportanceDisplayName(this.newMemoryImportance))
                .font({ size: 14 })
                .fontColor($r('app.color.text_primary'))
                .selectedOptionFontColor(Color.White)
                .selectedOptionBgColor($r('app.color.primary_color'))
                .onSelect((index: number) => {
                  const importance = this.getImportanceByIndex(index + 1);
                  if (importance !== 'all') {
                    this.newMemoryImportance = importance;
                  }
                })
                .width('100%')
                .height(40)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })

            // Ê†áÁ≠æËæìÂÖ•
            Column() {
              Text('Ê†áÁ≠æ')
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              TextInput({ placeholder: 'ËæìÂÖ•Ê†áÁ≠æÔºåÁî®ÈÄóÂè∑ÂàÜÈöî...' })
                .width('100%')
                .height(44)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
                .placeholderColor($r('app.color.text_secondary'))
                .fontColor($r('app.color.text_primary'))
                .onChange((value: string) => {
                  this.newMemoryTags = value;
                })
            }
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
        }
        .height(400)

        // ÊåâÈíÆË°å
        Row() {
          Button('ÂèñÊ∂à')
            .fontSize(16)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.text_secondary'))
            .borderWidth(1)
            .borderColor($r('app.color.text_secondary'))
            .borderRadius(8)
            .layoutWeight(1)
            .height(44)
            .onClick(() => {
              this.showAddDialog = false;
            })

          Button('Ê∑ªÂä†')
            .fontSize(16)
            .backgroundColor($r('app.color.primary_color'))
            .fontColor(Color.White)
            .borderRadius(8)
            .layoutWeight(1)
            .height(44)
            .margin({ left: 12 })
            .onClick(() => this.addNewMemory())
        }
        .width('100%')
        .margin({ top: 20 })
      }
      .width('90%')
      .height('80%')
      .padding(20)
      .backgroundColor($r('app.color.surface_color'))
      .borderRadius(16)
      .position({ x: '50%', y: '50%' })
      .translate({ x: '-50%', y: '-50%' })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildDeleteConfirmDialog() {
    Column() {
      // ËÉåÊôØÈÅÆÁΩ©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showDeleteDialog = false;
        })

      // ÂØπËØùÊ°ÜÂÜÖÂÆπ
      Column() {
        Text('Á°ÆËÆ§Âà†Èô§')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ bottom: 16 })

        Text(`Á°ÆÂÆöË¶ÅÂà†Èô§ËÆ∞ÂøÜÁ¢éÁâá"${this.deleteTargetTitle}"ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Center)
          .margin({ bottom: 24 })

        // ÊåâÈíÆË°å
        Row() {
          Button('ÂèñÊ∂à')
            .fontSize(16)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.text_secondary'))
            .borderWidth(1)
            .borderColor($r('app.color.text_secondary'))
            .borderRadius(8)
            .layoutWeight(1)
            .height(44)
            .onClick(() => {
              this.showDeleteDialog = false;
            })

          Button('Âà†Èô§')
            .fontSize(16)
            .backgroundColor('#F44336')
            .fontColor(Color.White)
            .borderRadius(8)
            .layoutWeight(1)
            .height(44)
            .margin({ left: 12 })
            .onClick(() => this.deleteMemory())
        }
        .width('100%')
      }
      .width('85%')
      .padding(24)
      .backgroundColor($r('app.color.surface_color'))
      .borderRadius(16)
      .position({ x: '50%', y: '50%' })
      .translate({ x: '-50%', y: '-50%' })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  buildEditMemoryDialog() {
    Column() {
      // ËÉåÊôØÈÅÆÁΩ©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showEditDialog = false;
          this.resetEditMemoryForm();
        })

      // ÂØπËØùÊ°ÜÂÜÖÂÆπ
      Column() {
        Text('ÁºñËæëËÆ∞ÂøÜÁ¢éÁâá')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ bottom: 20 })

        Scroll() {
          Column() {
            // Ê†áÈ¢òÊòæÁ§∫ÔºàÂè™ËØªÔºâ
            Column() {
              Row() {
                Text('Ê†áÈ¢ò')
                  .fontSize(14)
                  .fontColor($r('app.color.text_primary'))
                Text('(Ëá™Âä®ÁîüÊàê)')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ left: 8 })
              }
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 8 })

              TextInput({ text: this.editMemoryTitle, placeholder: 'Ê†áÈ¢òÂ∞ÜËá™Âä®ÁîüÊàê...' })
                .width('100%')
                .height(44)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
                .placeholderColor($r('app.color.text_secondary'))
                .fontColor($r('app.color.text_secondary'))
                .enabled(false) // üîß Á¶ÅÁî®Ê†áÈ¢òÁºñËæë
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })

            // ÂÜÖÂÆπËæìÂÖ•
            Column() {
              Text('ÂÜÖÂÆπ')
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              TextArea({ text: this.editMemoryContent, placeholder: 'ËæìÂÖ•ËÆ∞ÂøÜÂÜÖÂÆπ...' })
                .width('100%')
                .height(100)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
                .placeholderColor($r('app.color.text_secondary'))
                .fontColor($r('app.color.text_primary'))
                .onChange((value: string) => {
                  this.editMemoryContent = value;
                })
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })

            // ÂàÜÁ±ªÈÄâÊã©
            Column() {
              Text('ÂàÜÁ±ª')
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              Select([
                { value: '‰∏™‰∫∫' },
                { value: 'ÂÅèÂ•Ω' },
                { value: 'Â∑•‰Ωú' },
                { value: 'Â≠¶‰π†' },
                { value: 'Áà±Â•Ω' },
                { value: 'ÂÆ∂Â∫≠' },
                { value: 'ÂÅ•Â∫∑' },
                { value: 'Ëá™ÂÆö‰πâ' }
              ])
                .selected(this.getCategoryIndex(this.editMemoryCategory) - 1)
                .value(this.getCategoryDisplayName(this.editMemoryCategory))
                .font({ size: 14 })
                .fontColor($r('app.color.text_primary'))
                .selectedOptionFontColor(Color.White)
                .selectedOptionBgColor($r('app.color.primary_color'))
                .onSelect((index: number) => {
                  const category = this.getCategoryByIndex(index + 1);
                  if (category !== 'all') {
                    this.editMemoryCategory = category;
                  }
                })
                .width('100%')
                .height(40)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })

            // ÈáçË¶ÅÊÄßÈÄâÊã©
            Column() {
              Text('ÈáçË¶ÅÊÄß')
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              Select([
                { value: '‰Ωé' },
                { value: '‰∏≠' },
                { value: 'È´ò' },
                { value: 'ÂÖ≥ÈîÆ' }
              ])
                .selected(this.getImportanceIndex(this.editMemoryImportance) - 1)
                .value(this.getImportanceDisplayName(this.editMemoryImportance))
                .font({ size: 14 })
                .fontColor($r('app.color.text_primary'))
                .selectedOptionFontColor(Color.White)
                .selectedOptionBgColor($r('app.color.primary_color'))
                .onSelect((index: number) => {
                  const importance = this.getImportanceByIndex(index + 1);
                  if (importance !== 'all') {
                    this.editMemoryImportance = importance;
                  }
                })
                .width('100%')
                .height(40)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ bottom: 16 })

            // Ê†áÁ≠æËæìÂÖ•
            Column() {
              Text('Ê†áÁ≠æ')
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              TextInput({ text: this.editMemoryTags, placeholder: 'ËæìÂÖ•Ê†áÁ≠æÔºåÁî®ÈÄóÂè∑ÂàÜÈöî...' })
                .width('100%')
                .height(44)
                .backgroundColor($r('app.color.input_background'))
                .borderRadius(8)
                .placeholderColor($r('app.color.text_secondary'))
                .fontColor($r('app.color.text_primary'))
                .onChange((value: string) => {
                  this.editMemoryTags = value;
                })
            }
            .alignItems(HorizontalAlign.Start)
          }
          .width('100%')
        }
        .height(400)

        // ÊåâÈíÆË°å
        Row() {
          Button('ÂèñÊ∂à')
            .fontSize(16)
            .backgroundColor(Color.Transparent)
            .fontColor($r('app.color.text_secondary'))
            .borderWidth(1)
            .borderColor($r('app.color.text_secondary'))
            .borderRadius(8)
            .layoutWeight(1)
            .height(44)
            .onClick(() => {
              this.showEditDialog = false;
              this.resetEditMemoryForm();
            })

          Button('‰øùÂ≠ò')
            .fontSize(16)
            .backgroundColor($r('app.color.primary_color'))
            .fontColor(Color.White)
            .borderRadius(8)
            .layoutWeight(1)
            .height(44)
            .margin({ left: 12 })
            .onClick(() => this.editMemory())
        }
        .width('100%')
        .margin({ top: 20 })
      }
      .width('90%')
      .height('80%')
      .padding(20)
      .backgroundColor($r('app.color.surface_color'))
      .borderRadius(16)
      .position({ x: '50%', y: '50%' })
      .translate({ x: '-50%', y: '-50%' })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // ËæÖÂä©ÊñπÊ≥ï
  private getCategoryIndex(category: MemoryCategory | 'all'): number {
    const categories: (MemoryCategory | 'all')[] = ['all', MemoryCategory.PERSONAL, MemoryCategory.PREFERENCE, MemoryCategory.WORK, MemoryCategory.STUDY, MemoryCategory.HOBBY, MemoryCategory.FAMILY, MemoryCategory.HEALTH, MemoryCategory.CUSTOM];
    return categories.indexOf(category);
  }

  private getCategoryByIndex(index: number): MemoryCategory | 'all' {
    const categories: (MemoryCategory | 'all')[] = ['all', MemoryCategory.PERSONAL, MemoryCategory.PREFERENCE, MemoryCategory.WORK, MemoryCategory.STUDY, MemoryCategory.HOBBY, MemoryCategory.FAMILY, MemoryCategory.HEALTH, MemoryCategory.CUSTOM];
    return categories[index] || 'all';
  }

  private getImportanceIndex(importance: MemoryImportance | 'all'): number {
    const importances: (MemoryImportance | 'all')[] = ['all', MemoryImportance.LOW, MemoryImportance.MEDIUM, MemoryImportance.HIGH, MemoryImportance.CRITICAL];
    return importances.indexOf(importance);
  }

  private getImportanceByIndex(index: number): MemoryImportance | 'all' {
    const importances: (MemoryImportance | 'all')[] = ['all', MemoryImportance.LOW, MemoryImportance.MEDIUM, MemoryImportance.HIGH, MemoryImportance.CRITICAL];
    return importances[index] || 'all';
  }
}