import { router, promptAction } from '@kit.ArkUI';
import { AppStorage } from '../utils/AppStorage';
import { SystemPrompt } from '../models/ChatModels';
import { common } from '@kit.AbilityKit';
import { ThemeManager } from '../utils/ThemeManager';
import { Logger } from '../utils/Logger';
import { ChatViewModel } from '../viewmodels/ChatViewModel';
import { Constants } from '../utils/Constants';
import { BusinessError } from '@kit.BasicServicesKit';
import { SessionManager } from '../utils/SessionManager';
import { RoleManager, RoleCategory, RoleSortOption } from '../utils/RoleManager';

// æ‰©å±•RoleCategoryæšä¸¾æ·»åŠ â€œå…¨éƒ¨â€é€‰é¡¹
enum ExtendedRoleCategory {
  ALL = 'all',
  PROFESSIONAL = 'professional',
  CREATIVE = 'creative',
  LIFE = 'life',
  PSYCHOLOGY = 'psychology',
  CUSTOM = 'custom'
}

interface RouteParams {
  fromChatPage?: boolean;
  currentSessionId?: string;
}

interface CategoryInfo {
  key: ExtendedRoleCategory;
  name: string;
  icon: string;
  count: number;
}

/**
 * è§’è‰²ç®¡ç†é¡µé¢ - ç®¡ç†AIåŠ©æ‰‹è§’è‰²
 */
@Entry
@ComponentV2
struct RoleManagerPage {
  @Local roles: SystemPrompt[] = [];
  @Local filteredRoles: SystemPrompt[] = [];
  @Local showAddDialog: boolean = false;
  @Local showEditDialog: boolean = false;
  @Local editingRole: SystemPrompt | null = null;
  @Local newRoleName: string = '';
  @Local newRoleContent: string = '';
  @Local newRoleCategory: RoleCategory = RoleCategory.CUSTOM;
  @Local newRoleIcon: string = '';
  @Local newRoleDescription: string = '';
  @Local editRoleName: string = '';
  @Local editRoleContent: string = '';
  @Local editRoleCategory: RoleCategory = RoleCategory.CUSTOM;
  @Local editRoleIcon: string = '';
  @Local editRoleDescription: string = '';
  @Local roleNameError: string = ''; // è§’è‰²åç§°é”™è¯¯æç¤º
  @Local isDarkMode: boolean = false;
  @Local statusBarHeight: number = 44;
  @Local usingRoleId: string = '';
  @Local isFromChatPage: boolean = false;
  @Local currentSessionId: string | null = null;
  @Local selectedCategory: ExtendedRoleCategory = ExtendedRoleCategory.ALL;
  @Local searchQuery: string = '';
  @Local isLoading: boolean = true;
  @Local showSortOptions: boolean = false;
  @Local currentSortOption: RoleSortOption = { field: 'usageCount', order: 'desc' };
  @Local appliedRoleIds: string[] = []; // å·²åº”ç”¨åˆ°ä¾§è¾¹æ çš„è§’è‰²IDåˆ—è¡¨
  @Local applyingRoleId: string = ''; // æ­£åœ¨åº”ç”¨çš„è§’è‰²IDï¼ˆç”¨äºæ˜¾ç¤ºloadingçŠ¶æ€ï¼‰
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private chatViewModel: ChatViewModel = new ChatViewModel();
  private sessionManager: SessionManager = SessionManager.getInstance();
  private roleManager: RoleManager = RoleManager.getInstance();

  async aboutToAppear(): Promise<void> {
    // æ¥æ”¶è·¯ç”±å‚æ•°
    const params = router.getParams() as RouteParams;
    if (params) {
      this.isFromChatPage = !!(params.fromChatPage);
      this.currentSessionId = params.currentSessionId || null;
    }
    Logger.info('RoleManagerPage', `é¡µé¢æ¥æºæ£€æµ‹: fromChatPage=${this.isFromChatPage}, currentSessionId=${this.currentSessionId}`);
    
    // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
    await this.themeManager.initialize();
    this.isDarkMode = this.themeManager.getDarkMode();
    
    // æ·»åŠ ä¸»é¢˜å˜æ›´ç›‘å¬å™¨
    this.themeManager.addThemeListener((isDark: boolean) => {
      this.isDarkMode = isDark;
    });
    
    // æš‚æ—¶ä½¿ç”¨å›ºå®šçŠ¶æ€æ é«˜åº¦ï¼Œåç»­åŠ¨æ€è·å–
    Logger.info('RoleManagerPage', 'ä½¿ç”¨å›ºå®šçŠ¶æ€æ é«˜åº¦44vp');

    // åŠ è½½è§’è‰²
    await this.loadRoles();
  }

  async onPageShow(): Promise<void> {
    // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
    await this.loadRoles();
  }

  aboutToDisappear(): void {
    // ç§»é™¤ä¸»é¢˜ç›‘å¬å™¨
    this.themeManager.removeThemeListener((isDark: boolean) => {
      this.isDarkMode = isDark;
    });
  }

  onBackPress(): boolean | void {
    // å¦‚æœæœ‰å¯¹è¯æ¡†æ‰“å¼€ï¼Œå…ˆå…³é—­å¯¹è¯æ¡†
    if (this.showAddDialog) {
      this.showAddDialog = false;
      return true;
    }
    
    if (this.showEditDialog) {
      this.showEditDialog = false;
      return true;
    }
    
    // æ²¡æœ‰å¯¹è¯æ¡†æ—¶è¿”å›ä¸Šä¸€é¡µ
    router.back();
    return true;
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ  - æ·»åŠ çŠ¶æ€æ é«˜åº¦é¿è®©
        Column() {
          this.buildNavigationBar()
        }
        .margin({ top: this.statusBarHeight })

        // åˆ†ç±»ç­›é€‰å™¨
        if (this.roles.length > 0) {
          this.buildCategoryFilter()
        }

        // è§’è‰²åˆ—è¡¨
        if (this.roles.length > 0) {
          this.buildRoleList()
        } else {
          this.buildEmptyState()
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('app.color.background_color'))

      // è’™ç‰ˆå±‚
      if (this.showAddDialog || this.showEditDialog) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor(this.isDarkMode ? 'rgba(0, 0, 0, 0.7)' : 'rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            if (this.showAddDialog) {
              this.showAddDialog = false;
            }
            if (this.showEditDialog) {
              this.showEditDialog = false;
            }
          })
      }

      // æ·»åŠ è§’è‰²å¯¹è¯æ¡†
      if (this.showAddDialog) {
        this.buildAddRoleDialog()
      }

      // ç¼–è¾‘è§’è‰²å¯¹è¯æ¡†
      if (this.showEditDialog && this.editingRole) {
        this.buildEditRoleDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildNavigationBar() {
    Row() {
      // ç°ä»£åŒ–è¿”å›æŒ‰é’®
      Button() {
        Row() {
          Text('â†')
            .fontSize(18)
            .fontColor($r('app.color.text_primary'))
            .margin({ right: 4 })
          Text('è¿”å›')
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
        }
        .alignItems(VerticalAlign.Center)
      }
      .height(40)
      .padding({ left: 8, right: 12 })
      .backgroundColor(Color.Transparent)
      .borderRadius(20)
      .onClick(() => {
        router.back();
      })

      Blank()

      Text('è§’è‰²ç®¡ç†')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))

      Blank()

      // ä¿®å¤è§’è‰²æŒ‰é’®
      Button() {
        Text('ğŸ”§')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
      }
      .width(40)
      .height(40)
      .backgroundColor($r('app.color.input_background'))
      .borderRadius(20)
      .border({
        width: 0.5,
        color: $r('app.color.border_color')
      })
      .margin({ right: 8 })
      .onClick(() => {
        this.fixSystemPrompts();
      })

      // åˆ·æ–°è§’è‰²æŒ‰é’®
      Button() {
        Text('ğŸ”„')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
      }
      .width(40)
      .height(40)
      .backgroundColor($r('app.color.input_background'))
      .borderRadius(20)
      .border({
        width: 0.5,
        color: $r('app.color.border_color')
      })
      .margin({ right: 8 })
      .onClick(() => {
        this.refreshRoles();
      })

      // ç°ä»£åŒ–æ·»åŠ æŒ‰é’® - åœ†å½¢å›¾æ ‡æŒ‰é’®
      Button() {
        Text('+')
          .fontSize(20)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
      }
      .width(44)
      .height(44)
      .backgroundColor($r('app.color.primary_color'))
      .borderRadius(22)
      .shadow({
        radius: 8,
        color: $r('app.color.primary_color_20'),
        offsetY: 2
      })
      .onClick(() => {
        this.showAddDialog = true;
        this.newRoleName = '';
        this.newRoleContent = '';
        this.clearRoleNameError();
      })
    }
    .width('100%')
    .height(64)
    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    .backgroundColor($r('app.color.surface_color'))
    .border({
      width: { bottom: 0.5 },
      color: $r('app.color.border_color')
    })
  }

  @Builder
  buildCategoryFilter() {
    Column() {
      Scroll() {
        Row({ space: 12 }) {
          ForEach([
            { key: ExtendedRoleCategory.ALL, name: 'å…¨éƒ¨', icon: 'ğŸ“', count: this.roles.length },
            { key: ExtendedRoleCategory.PROFESSIONAL, name: 'ä¸“ä¸š', icon: 'ğŸ’¼', count: this.roles.filter(r => r.roleCategory === RoleCategory.PROFESSIONAL).length },
            { key: ExtendedRoleCategory.CREATIVE, name: 'åˆ›æ„', icon: 'ğŸ¨', count: this.roles.filter(r => r.roleCategory === RoleCategory.CREATIVE).length },
            { key: ExtendedRoleCategory.LIFE, name: 'ç”Ÿæ´»', icon: 'ğŸ ', count: this.roles.filter(r => r.roleCategory === RoleCategory.LIFE).length },
            { key: ExtendedRoleCategory.PSYCHOLOGY, name: 'å¿ƒç†', icon: 'ğŸ’­', count: this.roles.filter(r => r.roleCategory === RoleCategory.PSYCHOLOGY).length },
            { key: ExtendedRoleCategory.CUSTOM, name: 'è‡ªå®šä¹‰', icon: 'âš™ï¸', count: this.roles.filter(r => r.roleCategory === RoleCategory.CUSTOM).length }
          ], (category: CategoryInfo) => {
            // èƒ¶å›Šæ ·å¼åˆ†ç±»æŒ‰é’®
            Button() {
              Row({ space: 6 }) {
                Text(category.icon)
                  .fontSize(14)
                  .fontColor(this.selectedCategory === category.key ? Color.White : $r('app.color.text_primary'))
                  .transition({
                    type: TransitionType.All,
                    opacity: 1,
                    scale: { x: 1, y: 1 }
                  })

                Text(category.name)
                  .fontSize(14)
                  .fontWeight(this.selectedCategory === category.key ? FontWeight.Medium : FontWeight.Normal)
                  .fontColor(this.selectedCategory === category.key ? Color.White : $r('app.color.text_primary'))
                  .transition({
                    type: TransitionType.All,
                    opacity: 1,
                    scale: { x: 1, y: 1 }
                  })

                if (category.count > 0) {
                  Text(`${category.count}`)
                    .fontSize(12)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.selectedCategory === category.key ?
                      'rgba(255, 255, 255, 0.8)' : $r('app.color.text_secondary'))
                    .padding({ left: 4, right: 4, top: 1, bottom: 1 })
                    .backgroundColor(this.selectedCategory === category.key ?
                      'rgba(255, 255, 255, 0.2)' : $r('app.color.background_color'))
                    .borderRadius(8)
                    .transition({
                      type: TransitionType.All,
                      opacity: 1,
                      scale: { x: 1, y: 1 }
                    })
                }
              }
              .alignItems(VerticalAlign.Center)
              .justifyContent(FlexAlign.Center)
            }
            .height(36)
            .padding({ left: 14, right: 14 })
            .backgroundColor(this.selectedCategory === category.key ?
              $r('app.color.primary_color') : $r('app.color.input_background'))
            .borderRadius(18) // å®Œå…¨åœ†è§’çš„èƒ¶å›Šæ ·å¼
            .border({
              width: this.selectedCategory === category.key ? 0 : 0.5,
              color: $r('app.color.border_color')
            })
            .shadow(this.selectedCategory === category.key ? {
              radius: 8,
              color: $r('app.color.primary_color_20'),
              offsetY: 2,
              offsetX: 0
            } : {
              radius: 2,
              color: this.isDarkMode ? '#20000000' : '#08000000',
              offsetY: 1,
              offsetX: 0
            })
            .stateEffect(true)
            .transition({
              type: TransitionType.All,
              opacity: 1,
              scale: { x: 1, y: 1 }
            })
            .animation({
              duration: 250,
              curve: Curve.EaseInOut,
              iterations: 1,
              playMode: PlayMode.Normal
            })
            .onClick(() => {
              // æ·»åŠ é€‰ä¸­åŠ¨ç”»æ•ˆæœ
              animateTo({
                duration: 200,
                curve: Curve.EaseInOut
              }, () => {
                this.selectedCategory = category.key;
              });

              // åº”ç”¨ç­›é€‰
              this.applyFiltersAndSort();
            })
          }, (category: CategoryInfo) => category.key)
        }
        .alignItems(VerticalAlign.Center)
        .padding({ left: 16, right: 16 })
      }
      .scrollBar(BarState.Off)
      .scrollable(ScrollDirection.Horizontal)
    }
    .width('100%')
    .padding({ top: 12, bottom: 16 })
    .backgroundColor($r('app.color.surface_color'))
    .border({
      width: { bottom: 0.5 },
      color: $r('app.color.border_color')
    })
  }

  @Builder
  buildCurrentSessionInfo() {
    Column() {
      Row() {
        Column() {
          Text(this.chatViewModel.currentSession?.name || 'æ— ä¼šè¯')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')
            .textAlign(TextAlign.Start)
          
          if (this.chatViewModel.getCurrentSessionSystemPrompt()) {
            Text(`å½“å‰è§’è‰²: ${this.chatViewModel.getCurrentSessionSystemPrompt()!.name}`)
              .fontSize(12)
              .fontColor($r('app.color.primary_color'))
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ top: 2 })
          } else {
            Text('å½“å‰è§’è‰²: é€šç”¨åŠ©æ‰‹')
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .width('100%')
              .textAlign(TextAlign.Start)
              .margin({ top: 2 })
          }
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
        
        Text('ğŸ’¬')
          .fontSize(20)
      }
      .width('100%')
      .padding(12)
      .backgroundColor($r('app.color.card_background'))
      .borderRadius(8)
      .border({
        width: 1,
        color: $r('app.color.border_color')
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 8, bottom: 16 })
    .backgroundColor($r('app.color.background_color'))
  }

  @Builder
  buildRoleList() {
    List({ space: 16 }) {
      ForEach(this.filteredRoles, (role: SystemPrompt) => {
        ListItem() {
          this.buildRoleItem(role)
        }
        .transition({
          type: TransitionType.All,
          scale: { x: 0.95, y: 0.95 },
          opacity: 0
        })
      }, (role: SystemPrompt) => `${role.id}_${role.timestamp}`)
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ left: 16, right: 16, top: 16, bottom: 20 })
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
    .divider({
      strokeWidth: 0,
      color: Color.Transparent
    })
  }

  @Builder
  buildRoleItem(role: SystemPrompt) {
    Column() {
      // å†…å®¹åŒºåŸŸ
      Column() {
        // æ ‡é¢˜è¡Œ
        Row() {
          Text(role.name)
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
            .textAlign(TextAlign.Start)
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          // å½“å‰ä¼šè¯ä½¿ç”¨æŒ‡ç¤ºå™¨
          if (this.chatViewModel.getCurrentSessionSystemPrompt()?.id === role.id) {
            Row() {
              Text('âœ“')
                .fontSize(10)
                .fontColor(Color.White)
                .margin({ right: 2 })
              Text('å½“å‰ä½¿ç”¨')
                .fontSize(11)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Medium)
            }
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor($r('app.color.primary_color'))
            .borderRadius(12)
            .alignItems(VerticalAlign.Center)
            .margin({ left: 8 })
          }
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)
        .margin({ bottom: 12 })

        // å†…å®¹é¢„è§ˆ
        Text(role.content)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Start)
          .maxLines(3)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .lineHeight(20)
          .width('100%')
          .margin({ bottom: 12 })

        // æ“ä½œæŒ‰é’®ï¼šä½¿ç”¨ã€åº”ç”¨åˆ°ä¾§è¾¹æ ã€ç¼–è¾‘ã€åˆ é™¤ä¸€è¡Œå¸ƒå±€ - å››ä¸ªæŒ‰é’®ç›¸ç­‰å¤§å°
        Row({ space: 8 }) {
          // ä½¿ç”¨æŒ‰é’® - å 1/4å®½åº¦
          Button() {
            Row() {
              if (this.usingRoleId === role.id) {
                // LoadingçŠ¶æ€
                LoadingProgress()
                  .width(14)
                  .height(14)
                  .color(Color.White)
                  .margin({ right: 4 })
                Text(this.isFromChatPage ? 'åº”ç”¨ä¸­...' : 'åˆ›å»ºä¸­...')
                  .fontSize(12)
                  .fontColor(Color.White)
                  .fontWeight(FontWeight.Medium)
              } else {
                Text(this.isFromChatPage ? 'ğŸ¯' : 'ğŸš€')
                  .fontSize(14)
                  .margin({ right: 3 })
                Text(this.isFromChatPage ? 'åº”ç”¨' : 'å¯¹è¯')
                  .fontSize(12)
                  .fontColor(Color.White)
                  .fontWeight(FontWeight.Medium)
              }
            }
            .alignItems(VerticalAlign.Center)
          }
          .height(40)
          .layoutWeight(1)
          .backgroundColor(this.usingRoleId === role.id ? '#999999' : $r('app.color.primary_color'))
          .borderRadius(8)
          .shadow({
            radius: 4,
            color: this.usingRoleId === role.id ? '#40999999' : $r('app.color.primary_color_20'),
            offsetY: 1
          })
          .enabled(this.usingRoleId === '')
          .onClick(() => {
            if (this.isFromChatPage) {
              this.applyToCurrentSession(role);
            } else {
              this.useRole(role);
            }
          })

          // åº”ç”¨åˆ°ä¾§è¾¹æ æŒ‰é’® - å 1/4å®½åº¦
          Button() {
            Row() {
              if (this.applyingRoleId === role.id) {
                // LoadingçŠ¶æ€
                LoadingProgress()
                  .width(14)
                  .height(14)
                  .color(Color.White)
                  .margin({ right: 4 })
                Text('å¤„ç†ä¸­...')
                  .fontSize(12)
                  .fontColor(Color.White)
                  .fontWeight(FontWeight.Medium)
              } else {
                // æ ¹æ®æ˜¯å¦å·²åº”ç”¨æ˜¾ç¤ºä¸åŒçš„å›¾æ ‡å’Œæ–‡å­—
                if (this.isRoleAppliedToSidebar(role.id)) {
                  Text('âœ“')
                    .fontSize(14)
                    .margin({ right: 3 })
                  Text('å·²æ·»åŠ ')
                    .fontSize(12)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Medium)
                } else {
                  Text('ğŸ“Œ')
                    .fontSize(14)
                    .margin({ right: 3 })
                  Text('æ·»åŠ ')
                    .fontSize(12)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Medium)
                }
              }
            }
            .alignItems(VerticalAlign.Center)
          }
          .height(40)
          .layoutWeight(1)
          .backgroundColor(this.applyingRoleId === role.id ? '#999999' :
            this.isRoleAppliedToSidebar(role.id) ? '#4CAF50' : $r('app.color.primary_color'))
          .borderRadius(8)
          .shadow({
            radius: 4,
            color: this.applyingRoleId === role.id ? '#40999999' :
              this.isRoleAppliedToSidebar(role.id) ? '#404CAF50' : $r('app.color.primary_color_20'),
            offsetY: 1
          })
          .enabled(this.applyingRoleId === '')
          .onClick(() => {
            if (this.isRoleAppliedToSidebar(role.id)) {
              this.removeRoleFromSidebar(role);
            } else {
              this.applyRoleToSidebar(role);
            }
          })

          // ç¼–è¾‘æŒ‰é’® - å 1/4å®½åº¦ï¼ˆå†…ç½®è§’è‰²ä¸å¯ç¼–è¾‘ï¼‰
          Button() {
            Row() {
              Text(role.isBuiltIn ? 'ğŸ‘ï¸' : 'âœï¸')
                .fontSize(14)
                .margin({ right: 3 })
              Text(role.isBuiltIn ? 'æŸ¥çœ‹' : 'ç¼–è¾‘')
                .fontSize(12)
                .fontColor(role.isBuiltIn ? $r('app.color.text_secondary') : $r('app.color.text_primary'))
                .fontWeight(FontWeight.Medium)
            }
            .alignItems(VerticalAlign.Center)
          }
          .height(40)
          .layoutWeight(1)
          .backgroundColor(role.isBuiltIn ? $r('app.color.card_background') : $r('app.color.input_background'))
          .borderRadius(8)
          .border({
            width: 0.5,
            color: $r('app.color.border_color')
          })
          .stateEffect(!role.isBuiltIn)
          .enabled(!role.isBuiltIn)
          .onClick(() => {
            if (!role.isBuiltIn) {
              this.editingRole = role;
              this.editRoleName = role.name;
              this.editRoleContent = role.content;
              this.clearRoleNameError();
              this.showEditDialog = true;
            }
          })

          // åˆ é™¤æŒ‰é’® - å 1/4å®½åº¦ï¼ˆå†…ç½®è§’è‰²ä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼‰
          if (!role.isBuiltIn) {
            Button() {
              Row() {
                Text('ğŸ—‘ï¸')
                  .fontSize(14)
                  .margin({ right: 3 })
                Text('åˆ é™¤')
                  .fontSize(12)
                  .fontColor($r('app.color.error_color'))
                  .fontWeight(FontWeight.Medium)
              }
              .alignItems(VerticalAlign.Center)
            }
            .height(40)
            .layoutWeight(1)
            .backgroundColor($r('app.color.input_background'))
            .borderRadius(8)
            .border({
              width: 0.5,
              color: $r('app.color.border_color')
            })
            .stateEffect(true)
            .onClick(() => {
              this.deleteRole(role);
            })
          } else {
            // å†…ç½®è§’è‰²æ˜¾ç¤ºæ ‡è¯†
            Button() {
              Row() {
                Text('ğŸ“‹')
                  .fontSize(14)
                  .margin({ right: 3 })
                Text('å†…ç½®')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
                  .fontWeight(FontWeight.Medium)
              }
              .alignItems(VerticalAlign.Center)
            }
            .height(40)
            .layoutWeight(1)
            .backgroundColor($r('app.color.card_background'))
            .borderRadius(8)
            .border({
              width: 0.5,
              color: $r('app.color.border_color')
            })
            .enabled(false)
          }
        }
        .width('100%')
      }
      .width('100%')
      .padding(18)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .backgroundColor($r('app.color.surface_color'))
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: this.isDarkMode ? '#30000000' : '#08000000',
      offsetY: 2,
      offsetX: 0
    })
    .border({
      width: 0.5,
      color: $r('app.color.border_color')
    })
  }

  @Builder
  buildEmptyState() {
    Column() {
      // æ’å›¾åŒºåŸŸ
      Column() {
        Text('ğŸ“')
          .fontSize(64)
          .margin({ bottom: 16 })
        
        Text('æš‚æ— è§’è‰²')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ bottom: 8 })

        Text('è§’è‰²å¯ä»¥å®šåˆ¶AIåŠ©æ‰‹çš„è¡Œä¸ºå’Œé£æ ¼\nè®©å¯¹è¯æ›´ç¬¦åˆæ‚¨çš„éœ€æ±‚')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Center)
          .lineHeight(20)
          .margin({ bottom: 24 })
      }
      .alignItems(HorizontalAlign.Center)
      
      // å¼•å¯¼æŒ‰é’®
      Button() {
        Row() {
          Text('+')
            .fontSize(16)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
            .margin({ right: 4 })
          Text('åˆ›å»ºç¬¬ä¸€ä¸ªè§’è‰²')
            .fontSize(15)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
        }
        .alignItems(VerticalAlign.Center)
      }
      .height(44)
      .padding({ left: 24, right: 24 })
      .backgroundColor($r('app.color.primary_color'))
      .borderRadius(12)
      .shadow({
        radius: 8,
        color: $r('app.color.primary_color_20'),
        offsetY: 2
      })
      .onClick(() => {
        this.showAddDialog = true;
        this.newRoleName = '';
        this.newRoleContent = '';
        this.clearRoleNameError();
      })
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .padding(32)
  }

  @Builder
  buildAddRoleDialog() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('âœ¨')
          .fontSize(20)
          .margin({ right: 8 })

        Text('æ·»åŠ è§’è‰²')
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
        
        Button() {
          Text('Ã—')
            .fontSize(20)
            .fontColor($r('app.color.text_secondary'))
        }
        .width(32)
        .height(32)
        .backgroundColor(Color.Transparent)
        .borderRadius(16)
        .onClick(() => {
          this.showAddDialog = false;
        })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 24 })

      // è¡¨å•åŒºåŸŸ
      Column({ space: 20 }) {
        // åç§°è¾“å…¥
        Column({ space: 8 }) {
          Row() {
            Text('è§’è‰²åç§°')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))

            Text('*')
              .fontSize(15)
              .fontColor($r('app.color.error_color'))
              .margin({ left: 2 })
          }
          .alignItems(VerticalAlign.Center)

          TextInput({ placeholder: 'ä¾‹å¦‚ï¼šç¼–ç¨‹åŠ©æ‰‹ã€åˆ›æ„å†™ä½œ...' })
            .width('100%')
            .height(48)
            .backgroundColor($r('app.color.input_background'))
            .borderRadius(12)
            .padding({ left: 16, right: 16 })
            .border({
              width: 1,
              color: this.roleNameError ? $r('app.color.error_color') :
                (this.newRoleName.trim().length > 0 ? $r('app.color.primary_color') : $r('app.color.border_color'))
            })
            .onChange((value: string) => {
              this.newRoleName = value;
              this.validateRoleName(value);
            })

          // æ˜¾ç¤ºé”™è¯¯æç¤º
          if (this.roleNameError) {
            Text(this.roleNameError)
              .fontSize(12)
              .fontColor($r('app.color.error_color'))
              .textAlign(TextAlign.Start)
              .width('100%')
              .margin({ top: 4 })
          }
        }
        .alignItems(HorizontalAlign.Start)

        // å†…å®¹è¾“å…¥
        Column({ space: 8 }) {
          Row() {
            Text('è§’è‰²å†…å®¹')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
            
            Text('*')
              .fontSize(15)
              .fontColor($r('app.color.error_color'))
              .margin({ left: 2 })
          }
          .alignItems(VerticalAlign.Center)
          
          TextArea({ placeholder: 'è¯·è¯¦ç»†æè¿°æ‚¨å¸Œæœ›AIåŠ©æ‰‹æ‰®æ¼”çš„è§’è‰²å’Œè¡Œä¸ºæ–¹å¼...' })
            .width('100%')
            .height(140)
            .backgroundColor($r('app.color.input_background'))
            .borderRadius(12)
            .padding(16)
            .border({
              width: 1,
              color: this.newRoleContent.trim().length > 0 ? $r('app.color.primary_color') : $r('app.color.border_color')
            })
            .onChange((value: string) => {
              this.newRoleContent = value;
            })
        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .margin({ bottom: 24 })

      // æŒ‰é’®ç»„
      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .backgroundColor($r('app.color.border_color'))
          .borderRadius(12)
          .height(44)
          .layoutWeight(1)
          .onClick(() => {
            this.showAddDialog = false;
          })

        Button('åˆ›å»ºè§’è‰²')
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor(this.newRoleName.trim().length > 0 && this.newRoleContent.trim().length > 0 && !this.roleNameError ?
            $r('app.color.primary_color') : $r('app.color.border_color'))
          .borderRadius(12)
          .height(44)
          .layoutWeight(1)
          .enabled(this.newRoleName.trim().length > 0 && this.newRoleContent.trim().length > 0 && !this.roleNameError)
          .onClick(() => {
            this.addRole();
          })
      }
      .width('100%')
    }
    .width('90%')
    .padding(24)
    .backgroundColor($r('app.color.surface_color'))
    .borderRadius(16)
    .shadow({
      radius: 16,
      color: this.isDarkMode ? '#50000000' : '#12000000',
      offsetX: 0,
      offsetY: 6
    })
    .border({
      width: 0.5,
      color: $r('app.color.border_color')
    })
  }

  @Builder
  buildEditRoleDialog() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('âœï¸')
          .fontSize(20)
          .margin({ right: 8 })
        
        Text('ç¼–è¾‘è§’è‰²')
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
        
        Button() {
          Text('Ã—')
            .fontSize(20)
            .fontColor($r('app.color.text_secondary'))
        }
        .width(32)
        .height(32)
        .backgroundColor(Color.Transparent)
        .borderRadius(16)
        .onClick(() => {
          this.showEditDialog = false;
        })
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)
      .margin({ bottom: 24 })

      // è¡¨å•åŒºåŸŸ
      Column({ space: 20 }) {
        // åç§°è¾“å…¥
        Column({ space: 8 }) {
          Row() {
            Text('è§’è‰²åç§°')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))

            Text('*')
              .fontSize(15)
              .fontColor($r('app.color.error_color'))
              .margin({ left: 2 })
          }
          .alignItems(VerticalAlign.Center)

          TextInput({ placeholder: 'è¯·è¾“å…¥è§’è‰²åç§°', text: this.editRoleName })
            .width('100%')
            .height(48)
            .backgroundColor($r('app.color.input_background'))
            .borderRadius(12)
            .padding({ left: 16, right: 16 })
            .border({
              width: 1,
              color: this.roleNameError ? $r('app.color.error_color') :
                (this.editRoleName.trim().length > 0 ? $r('app.color.primary_color') : $r('app.color.border_color'))
            })
            .onChange((value: string) => {
              this.editRoleName = value;
              this.validateEditRoleName(value);
            })

          // æ˜¾ç¤ºé”™è¯¯æç¤º
          if (this.roleNameError) {
            Text(this.roleNameError)
              .fontSize(12)
              .fontColor($r('app.color.error_color'))
              .textAlign(TextAlign.Start)
              .width('100%')
              .margin({ top: 4 })
          }
        }
        .alignItems(HorizontalAlign.Start)

        // å†…å®¹è¾“å…¥
        Column({ space: 8 }) {
          Row() {
            Text('è§’è‰²å†…å®¹')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor($r('app.color.text_primary'))
            
            Text('*')
              .fontSize(15)
              .fontColor($r('app.color.error_color'))
              .margin({ left: 2 })
          }
          .alignItems(VerticalAlign.Center)
          
          TextArea({ placeholder: 'è¯·è¾“å…¥è§’è‰²å†…å®¹', text: this.editRoleContent })
            .width('100%')
            .height(140)
            .backgroundColor($r('app.color.input_background'))
            .borderRadius(12)
            .padding(16)
            .border({
              width: 1,
              color: this.editRoleContent.trim().length > 0 ? $r('app.color.primary_color') : $r('app.color.border_color')
            })
            .onChange((value: string) => {
              this.editRoleContent = value;
            })
        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .margin({ bottom: 24 })

      // æŒ‰é’®ç»„
      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .backgroundColor($r('app.color.border_color'))
          .borderRadius(12)
          .height(44)
          .layoutWeight(1)
          .onClick(() => {
            this.showEditDialog = false;
          })

        Button('ä¿å­˜æ›´æ”¹')
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor(this.editRoleName.trim().length > 0 && this.editRoleContent.trim().length > 0 && !this.roleNameError ?
            $r('app.color.primary_color') : $r('app.color.border_color'))
          .borderRadius(12)
          .height(44)
          .layoutWeight(1)
          .enabled(this.editRoleName.trim().length > 0 && this.editRoleContent.trim().length > 0 && !this.roleNameError)
          .onClick(() => {
            this.updateRole();
          })
      }
      .width('100%')
    }
    .width('90%')
    .padding(24)
    .backgroundColor($r('app.color.surface_color'))
    .borderRadius(16)
    .shadow({
      radius: 16,
      color: this.isDarkMode ? '#50000000' : '#12000000',
      offsetX: 0,
      offsetY: 6
    })
    .border({
      width: 0.5,
      color: $r('app.color.border_color')
    })
  }

  private async useRole(role: SystemPrompt): Promise<void> {
    try {
      // è®¾ç½®loadingçŠ¶æ€
      this.usingRoleId = role.id;

      Logger.info('RoleManagerPage', `å¼€å§‹ä½¿ç”¨è§’è‰²åˆ›å»ºæ–°ä¼šè¯: ${role.name}`);

      // æ˜¾ç¤ºtoastæç¤º
      promptAction.showToast({
        message: `æ­£åœ¨ä½¿ç”¨"${role.name}"åˆ›å»ºæ–°ä¼šè¯...`,
        duration: 2000
      });

      // ä½¿ç”¨SessionManageråˆ›å»ºè§’è‰²ä¼šè¯
      const newSession = await this.sessionManager.createRoleSession(role);

      Logger.info('RoleManagerPage', `æ–°ä¼šè¯åˆ›å»ºæˆåŠŸ: ${newSession.id}ï¼Œå‡†å¤‡è·³è½¬...`);

      // æ¸…é™¤loadingçŠ¶æ€
      this.usingRoleId = '';

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      promptAction.showToast({
        message: 'æ–°ä¼šè¯åˆ›å»ºæˆåŠŸï¼',
        duration: 1500
      });

      // å»¶è¿Ÿè·³è½¬ä»¥ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æˆåŠŸæç¤º
      setTimeout(() => {
        router.pushUrl({
          url: 'pages/ChatPage',
          params: { sessionId: newSession.id }
        }).then(() => {
          Logger.info('RoleManagerPage', 'æˆåŠŸè·³è½¬åˆ°èŠå¤©é¡µé¢');
        }).catch((error: Error) => {
          Logger.error('RoleManagerPage', `è·³è½¬å¤±è´¥: ${error.message}`);
        });
      }, 300);

    } catch (error) {
      // æ¸…é™¤loadingçŠ¶æ€
      this.usingRoleId = '';

      Logger.error('RoleManagerPage', `ä½¿ç”¨è§’è‰²åˆ›å»ºä¼šè¯å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: `åˆ›å»ºå¤±è´¥: ${(error as Error).message}`,
        duration: 3000
      });
    }
  }

  /**
   * åº”ç”¨æç¤ºè¯åˆ°å½“å‰ä¼šè¯
   */
  private async applyToCurrentSession(role: SystemPrompt): Promise<void> {
    try {
      // è®¾ç½®loadingçŠ¶æ€
      this.usingRoleId = role.id;

      Logger.info('RoleManagerPage', `å¼€å§‹åº”ç”¨è§’è‰²åˆ°å½“å‰ä¼šè¯: ${role.name}`);

      // æ˜¾ç¤ºtoastæç¤º
      promptAction.showToast({
        message: `æ­£åœ¨åº”ç”¨"${role.name}"åˆ°å½“å‰ä¼šè¯...`,
        duration: 2000
      });

      // æ£€æŸ¥æ˜¯å¦æœ‰å½“å‰ä¼šè¯ID
      if (!this.currentSessionId) {
        throw new Error('å½“å‰æ²¡æœ‰æ´»åŠ¨ä¼šè¯');
      }

      // ä½¿ç”¨ SessionManager æ›´æ–°ä¼šè¯çš„ç³»ç»Ÿæç¤ºè¯
      await this.sessionManager.updateSessionPrompt(this.currentSessionId, role.id);

      Logger.info('RoleManagerPage', `è§’è‰²å·²åº”ç”¨åˆ°ä¼šè¯: ${this.currentSessionId}`);

      // æ¸…é™¤loadingçŠ¶æ€
      this.usingRoleId = '';

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      promptAction.showToast({
        message: 'è§’è‰²åº”ç”¨æˆåŠŸï¼',
        duration: 1500
      });

      // å»¶è¿Ÿè¿”å›åˆ°èŠå¤©é¡µé¢
      setTimeout(() => {
        router.back();
      }, 800);

    } catch (error) {
      // æ¸…é™¤loadingçŠ¶æ€
      this.usingRoleId = '';

      Logger.error('RoleManagerPage', `åº”ç”¨è§’è‰²åˆ°å½“å‰ä¼šè¯å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: `åº”ç”¨å¤±è´¥: ${(error as Error).message}`,
        duration: 3000
      });
    }
  }


  private async loadRoles(): Promise<void> {
    try {
      Logger.info('RoleManagerPage', 'å¼€å§‹åŠ è½½è§’è‰²');

      // ä½¿ç”¨RoleManageråŠ è½½æ‰€æœ‰è§’è‰²
      const loadedRoles = await this.roleManager.getAllRoles();
      Logger.info('RoleManagerPage', `ä»RoleManageråŠ è½½äº† ${loadedRoles.length} ä¸ªè§’è‰²`);

      // å¼ºåˆ¶è§¦å‘UIæ›´æ–° - ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦åˆ›å»ºæ–°æ•°ç»„
      this.roles = [...loadedRoles];

      // åŠ è½½å·²åº”ç”¨åˆ°ä¾§è¾¹æ çš„è§’è‰²IDåˆ—è¡¨
      this.appliedRoleIds = await AppStorage.getAppliedRoleIds();
      Logger.info('RoleManagerPage', `åŠ è½½äº† ${this.appliedRoleIds.length} ä¸ªå·²åº”ç”¨è§’è‰²`);

      // åº”ç”¨ç­›é€‰å’Œæ’åº
      await this.applyFiltersAndSort();

      Logger.info('RoleManagerPage', 'è§’è‰²åŠ è½½å®Œæˆ');
    } catch (error) {
      Logger.error('RoleManagerPage', `åŠ è½½è§’è‰²å¤±è´¥: ${(error as Error).message}`);
    }
  }

  private async applyFiltersAndSort(): Promise<void> {
    try {
      let filtered = this.roles;

      // æŒ‰åˆ†ç±»ç­›é€‰
      if (this.selectedCategory !== ExtendedRoleCategory.ALL) {
        const categoryToFilter = this.selectedCategory as string;
        filtered = filtered.filter(role => role.roleCategory === categoryToFilter);
        Logger.debug('RoleManagerPage', `æŒ‰åˆ†ç±» ${categoryToFilter} ç­›é€‰ï¼Œç»“æœ: ${filtered.length} ä¸ªè§’è‰²`);
      }

      // æŒ‰æœç´¢æŸ¥è¯¢ç­›é€‰
      if (this.searchQuery.trim()) {
        const query = this.searchQuery.toLowerCase().trim();
        filtered = filtered.filter(role =>
          role.name.toLowerCase().includes(query) ||
          role.content.toLowerCase().includes(query) ||
          (role.roleDescription && role.roleDescription.toLowerCase().includes(query))
        );
      }

      // åº”ç”¨æ’åº
      this.filteredRoles = this.roleManager.sortRoles(filtered, this.currentSortOption);

      Logger.debug('RoleManagerPage', `ç­›é€‰æ’åºå: ${this.filteredRoles.length} ä¸ªè§’è‰²`);
    } catch (error) {
      Logger.error('RoleManagerPage', `ç­›é€‰æ’åºå¤±è´¥: ${error}`);
      this.filteredRoles = [...this.roles];
    }
  }



  
  private async addRole(): Promise<void> {
    try {
      Logger.info('RoleManagerPage', `å¼€å§‹æ·»åŠ è§’è‰²: ${this.newRoleName.trim()}`);

      // ç¡®è®¤ï¼šæ²¡æœ‰è§’è‰²æ•°é‡é™åˆ¶ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„è§’è‰²
      Logger.info('RoleManagerPage', `å½“å‰è§’è‰²æ•°é‡: ${this.roles.length}ï¼Œå‡†å¤‡æ·»åŠ æ–°è§’è‰²`);

      // ä½¿ç”¨RoleManageråˆ›å»ºè§’è‰²
      const newRole = await this.roleManager.createRole(
        this.newRoleName.trim(),
        this.newRoleContent.trim(),
        RoleCategory.CUSTOM,
        '', // ä½¿ç”¨é»˜è®¤å›¾æ ‡
        this.newRoleName.trim() // ä½¿ç”¨åç§°ä½œä¸ºæè¿°
      );

      Logger.info('RoleManagerPage', `è§’è‰²å·²åˆ›å»º: ${newRole.id}`);

      // å…³é—­å¯¹è¯æ¡†å¹¶æ¸…ç©ºè¾“å…¥
      this.showAddDialog = false;
      this.newRoleName = '';
      this.newRoleContent = '';
      this.clearRoleNameError();

      // é‡æ–°åŠ è½½æ•°æ®
      await this.loadRoles();

      Logger.debug('RoleManagerPage', 'å¯¹è¯æ¡†çŠ¶æ€å·²é‡ç½®');

      promptAction.showToast({
        message: 'æ·»åŠ æˆåŠŸ',
        duration: 1500
      });

      Logger.info('RoleManagerPage', 'è§’è‰²æ·»åŠ å®Œæˆ');
    } catch (error) {
      Logger.error('RoleManagerPage', `æ·»åŠ è§’è‰²å¤±è´¥: ${(error as Error).message}`);
      promptAction.showToast({
        message: 'æ·»åŠ å¤±è´¥',
        duration: 1500
      });
    }
  }

  private async updateRole(): Promise<void> {
    try {
      if (this.editingRole) {
        Logger.info('RoleManagerPage', `å¼€å§‹æ›´æ–°è§’è‰²: ${this.editingRole.id}`);
        Logger.info('RoleManagerPage', `æ–°åç§°: ${this.editRoleName.trim()}`);
        Logger.info('RoleManagerPage', `æ–°å†…å®¹é•¿åº¦: ${this.editRoleContent.trim().length}`);

        // æ›´æ–°è§’è‰²ä¿¡æ¯
        this.editingRole.name = this.editRoleName.trim();
        this.editingRole.content = this.editRoleContent.trim();
        this.editingRole.timestamp = Date.now();

        Logger.debug('RoleManagerPage', `æ›´æ–°åçš„è§’è‰²å¯¹è±¡: ${JSON.stringify(this.editingRole)}`);

        // ä½¿ç”¨RoleManageræ›´æ–°è§’è‰²
        await this.roleManager.updateRole(this.editingRole);
        Logger.info('RoleManagerPage', 'è§’è‰²å·²æ›´æ–°åˆ°å­˜å‚¨ï¼Œå‡†å¤‡é‡æ–°åŠ è½½');

        // å…³é—­ç¼–è¾‘å¯¹è¯æ¡†
        this.showEditDialog = false;
        this.editingRole = null;
        this.clearRoleNameError();

        // é‡æ–°åŠ è½½æ•°æ®
        await this.loadRoles();

        promptAction.showToast({
          message: 'æ›´æ–°æˆåŠŸ',
          duration: 1500
        });

        Logger.info('RoleManagerPage', 'è§’è‰²æ›´æ–°å®Œæˆ');
      }
    } catch (error) {
      Logger.error('RoleManagerPage', `æ›´æ–°è§’è‰²å¤±è´¥: ${(error as Error).message}`);
      promptAction.showToast({
        message: 'æ›´æ–°å¤±è´¥',
        duration: 1500
      });
    }
  }


  private async deleteRole(role: SystemPrompt): Promise<void> {
    AlertDialog.show({
      title: 'ç¡®è®¤åˆ é™¤',
      message: `ç¡®å®šè¦åˆ é™¤è§’è‰²"${role.name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
      primaryButton: {
        value: 'ç¡®å®š',
        action: async () => {
          try {
            Logger.info('RoleManagerPage', `å¼€å§‹åˆ é™¤è§’è‰²: ${role.name}`);

            // ä½¿ç”¨RoleManageråˆ é™¤è§’è‰²
            await this.roleManager.deleteRole(role.id);
            Logger.info('RoleManagerPage', 'è§’è‰²å·²ä»å­˜å‚¨åˆ é™¤ï¼Œå‡†å¤‡é‡æ–°åŠ è½½');

            // é‡æ–°åŠ è½½æ•°æ®
            await this.loadRoles();

            promptAction.showToast({
              message: 'åˆ é™¤æˆåŠŸ',
              duration: 1500
            });

            Logger.info('RoleManagerPage', 'è§’è‰²åˆ é™¤å®Œæˆ');
          } catch (error) {
            Logger.error('RoleManagerPage', `åˆ é™¤è§’è‰²å¤±è´¥: ${(error as Error).message}`);
            promptAction.showToast({
              message: 'åˆ é™¤å¤±è´¥',
              duration: 1500
            });
          }
        }
      },
      secondaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      }
    });
  }

  /**
   * åº”ç”¨è§’è‰²åˆ°ä¾§è¾¹æ 
   */
  private async applyRoleToSidebar(role: SystemPrompt): Promise<void> {
    try {
      this.applyingRoleId = role.id;
      Logger.info('RoleManagerPage', `å¼€å§‹åº”ç”¨è§’è‰²åˆ°ä¾§è¾¹æ : ${role.name}`);

      // ä½¿ç”¨RoleManageråº”ç”¨è§’è‰²åˆ°ä¾§è¾¹æ 
      await this.roleManager.applyRoleToSidebar(role.id);

      // æ›´æ–°æœ¬åœ°å·²åº”ç”¨è§’è‰²åˆ—è¡¨
      if (!this.appliedRoleIds.includes(role.id)) {
        this.appliedRoleIds = [...this.appliedRoleIds, role.id];
      }

      promptAction.showToast({
        message: `è§’è‰²"${role.name}"å·²åº”ç”¨åˆ°ä¾§è¾¹æ `,
        duration: 2000
      });

      Logger.info('RoleManagerPage', `è§’è‰² ${role.name} å·²æˆåŠŸåº”ç”¨åˆ°ä¾§è¾¹æ `);
    } catch (error) {
      Logger.error('RoleManagerPage', `åº”ç”¨è§’è‰²åˆ°ä¾§è¾¹æ å¤±è´¥: ${(error as Error).message}`);
      promptAction.showToast({
        message: 'åº”ç”¨å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 1500
      });
    } finally {
      this.applyingRoleId = '';
    }
  }

  /**
   * ä»ä¾§è¾¹æ ç§»é™¤è§’è‰²
   */
  private async removeRoleFromSidebar(role: SystemPrompt): Promise<void> {
    try {
      this.applyingRoleId = role.id;
      Logger.info('RoleManagerPage', `å¼€å§‹ä»ä¾§è¾¹æ ç§»é™¤è§’è‰²: ${role.name}`);

      // ä½¿ç”¨RoleManagerä»ä¾§è¾¹æ ç§»é™¤è§’è‰²
      await this.roleManager.removeRoleFromSidebar(role.id);

      // æ›´æ–°æœ¬åœ°å·²åº”ç”¨è§’è‰²åˆ—è¡¨
      this.appliedRoleIds = this.appliedRoleIds.filter(id => id !== role.id);

      promptAction.showToast({
        message: `è§’è‰²"${role.name}"å·²ä»ä¾§è¾¹æ ç§»é™¤`,
        duration: 2000
      });

      Logger.info('RoleManagerPage', `è§’è‰² ${role.name} å·²ä»ä¾§è¾¹æ ç§»é™¤`);
    } catch (error) {
      Logger.error('RoleManagerPage', `ä»ä¾§è¾¹æ ç§»é™¤è§’è‰²å¤±è´¥: ${(error as Error).message}`);
      promptAction.showToast({
        message: 'ç§»é™¤å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 1500
      });
    } finally {
      this.applyingRoleId = '';
    }
  }

  /**
   * æ£€æŸ¥è§’è‰²æ˜¯å¦å·²åº”ç”¨åˆ°ä¾§è¾¹æ 
   */
  private isRoleAppliedToSidebar(roleId: string): boolean {
    return this.appliedRoleIds.includes(roleId);
  }

  /**
   * ä¿®å¤ç³»ç»Ÿæç¤ºè¯ï¼šå°†æœªæ ‡è®°ä¸ºè§’è‰²çš„ç³»ç»Ÿæç¤ºè¯è½¬æ¢ä¸ºè§’è‰²ï¼Œå¹¶ä¿®å¤è§’è‰²åˆ†ç±»
   */
  private async fixSystemPrompts(): Promise<void> {
    try {
      Logger.info('RoleManagerPage', 'å¼€å§‹ä¿®å¤ç³»ç»Ÿæç¤ºè¯å’Œè§’è‰²åˆ†ç±»');

      // æ˜¾ç¤ºloadingæç¤º
      promptAction.showToast({
        message: 'æ­£åœ¨ä¿®å¤ç³»ç»Ÿæç¤ºè¯å’Œè§’è‰²åˆ†ç±»...',
        duration: 3000
      });

      // å…ˆä¿®å¤ç³»ç»Ÿæç¤ºè¯è½¬è§’è‰²
      const convertedCount = await this.roleManager.convertSystemPromptsToRoles();

      // å†ä¿®å¤è§’è‰²åˆ†ç±»
      const categoryFixedCount = await this.roleManager.fixRoleCategories();

      const totalFixed = convertedCount + categoryFixedCount;

      if (totalFixed > 0) {
        // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨
        await this.loadRoles();

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        let message = '';
        if (convertedCount > 0 && categoryFixedCount > 0) {
          message = `æˆåŠŸä¿®å¤ ${convertedCount} ä¸ªç³»ç»Ÿæç¤ºè¯ï¼Œ${categoryFixedCount} ä¸ªè§’è‰²åˆ†ç±»ï¼`;
        } else if (convertedCount > 0) {
          message = `æˆåŠŸä¿®å¤ ${convertedCount} ä¸ªç³»ç»Ÿæç¤ºè¯ï¼`;
        } else if (categoryFixedCount > 0) {
          message = `æˆåŠŸä¿®å¤ ${categoryFixedCount} ä¸ªè§’è‰²åˆ†ç±»ï¼`;
        }

        promptAction.showToast({
          message: message,
          duration: 3000
        });

        Logger.info('RoleManagerPage', message);
      } else {
        // æ˜¾ç¤ºæ²¡æœ‰éœ€è¦ä¿®å¤çš„æç¤º
        promptAction.showToast({
          message: 'æ‰€æœ‰è§’è‰²æ•°æ®éƒ½å·²æ­£ç¡®é…ç½®',
          duration: 2000
        });

        Logger.info('RoleManagerPage', 'æ²¡æœ‰éœ€è¦ä¿®å¤çš„æ•°æ®');
      }
    } catch (error) {
      Logger.error('RoleManagerPage', `ä¿®å¤å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: `ä¿®å¤å¤±è´¥: ${(error as Error).message}`,
        duration: 3000
      });
    }
  }

  /**
   * éªŒè¯è§’è‰²åç§°ï¼ˆç”¨äºæ·»åŠ å¯¹è¯æ¡†ï¼‰
   */
  private async validateRoleName(name: string): Promise<void> {
    try {
      const trimmedName = name.trim();

      // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯
      this.roleNameError = '';

      // å¦‚æœä¸ºç©ºï¼Œä¸æ˜¾ç¤ºé”™è¯¯ï¼ˆç”±å¿…å¡«æ ‡è®°å¤„ç†ï¼‰
      if (!trimmedName) {
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåç§°
      if (await this.roleManager.isRoleNameExists(trimmedName)) {
        this.roleNameError = `è§’è‰²åç§° "${trimmedName}" å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`;
      }
    } catch (error) {
      Logger.error('RoleManagerPage', `éªŒè¯è§’è‰²åç§°å¤±è´¥: ${error}`);
      // éªŒè¯å¤±è´¥æ—¶ä¸æ¸…é™¤é”™è¯¯ï¼Œä¿æŒä¹‹å‰çš„é”™è¯¯çŠ¶æ€
    }
  }

  /**
   * éªŒè¯ç¼–è¾‘è§’è‰²åç§°ï¼ˆç”¨äºç¼–è¾‘å¯¹è¯æ¡†ï¼‰
   */
  private async validateEditRoleName(name: string): Promise<void> {
    try {
      const trimmedName = name.trim();

      // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯
      this.roleNameError = '';

      // å¦‚æœä¸ºç©ºï¼Œä¸æ˜¾ç¤ºé”™è¯¯ï¼ˆç”±å¿…å¡«æ ‡è®°å¤„ç†ï¼‰
      if (!trimmedName) {
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåç§°ï¼ˆæ’é™¤å½“å‰ç¼–è¾‘çš„è§’è‰²ï¼‰
      if (this.editingRole && await this.roleManager.isRoleNameExists(trimmedName, this.editingRole.id)) {
        this.roleNameError = `è§’è‰²åç§° "${trimmedName}" å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°`;
      }
    } catch (error) {
      Logger.error('RoleManagerPage', `éªŒè¯ç¼–è¾‘è§’è‰²åç§°å¤±è´¥: ${error}`);
      // éªŒè¯å¤±è´¥æ—¶ä¸æ¸…é™¤é”™è¯¯ï¼Œä¿æŒä¹‹å‰çš„é”™è¯¯çŠ¶æ€
    }
  }

  /**
   * æ¸…ç©ºè§’è‰²åç§°é”™è¯¯ï¼ˆåœ¨æ‰“å¼€/å…³é—­å¯¹è¯æ¡†æ—¶è°ƒç”¨ï¼‰
   */
  private clearRoleNameError(): void {
    this.roleNameError = '';
  }

  /**
   * åˆ·æ–°è§’è‰²åˆ—è¡¨ï¼ˆå¼ºåˆ¶é‡æ–°åˆå§‹åŒ–é¢„ç½®è§’è‰²ï¼‰
   */
  private async refreshRoles(): Promise<void> {
    try {
      Logger.info('RoleManagerPage', 'å¼€å§‹åˆ·æ–°è§’è‰²åˆ—è¡¨');

      // æ˜¾ç¤ºloadingæç¤º
      promptAction.showToast({
        message: 'æ­£åœ¨åˆ·æ–°è§’è‰²åˆ—è¡¨...',
        duration: 2000
      });

      // å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–é»˜è®¤è§’è‰²
      await this.roleManager.forceInitializeDefaultRoles();

      // é‡æ–°åŠ è½½è§’è‰²åˆ—è¡¨
      await this.loadRoles();

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      promptAction.showToast({
        message: 'è§’è‰²åˆ—è¡¨å·²åˆ·æ–°ï¼',
        duration: 1500
      });

      Logger.info('RoleManagerPage', 'è§’è‰²åˆ—è¡¨åˆ·æ–°å®Œæˆ');
    } catch (error) {
      Logger.error('RoleManagerPage', `åˆ·æ–°è§’è‰²åˆ—è¡¨å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: `åˆ·æ–°å¤±è´¥: ${(error as Error).message}`,
        duration: 3000
      });
    }
  }
}