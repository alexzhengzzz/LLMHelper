import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium';
import { TestUtils, TestSuiteBase, AsyncTestUtils } from './TestUtils';
import { SmartTextRenderer } from '../main/ets/components/SmartTextRenderer';
import { RenderConfig, RenderResult } from '../main/ets/types/RenderTypes';

/**
 * æ™ºèƒ½æ–‡æœ¬æ¸²æŸ“å™¨æµ‹è¯•å¥—ä»¶
 * æµ‹è¯•ä»£ç é«˜äº®ã€Markdownæ¸²æŸ“ã€å¯Œæ–‡æœ¬å¤„ç†ç­‰åŠŸèƒ½
 */
export default function smartTextRendererTest() {
  const testSuite = new TestSuiteBase();
  testSuite.setTestTag('SmartTextRendererTest');
  
  describe('SmartTextRendererTest', () => {
    let smartTextRenderer: SmartTextRenderer;
    
    beforeAll(async () => {
      testSuite.beforeAll();
      TestUtils.log('åˆå§‹åŒ–æ™ºèƒ½æ–‡æœ¬æ¸²æŸ“å™¨æµ‹è¯•ç¯å¢ƒ');
      
      // è·å–æ™ºèƒ½æ–‡æœ¬æ¸²æŸ“å™¨å®ä¾‹
      smartTextRenderer = SmartTextRenderer.getInstance();
      
      // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
      await TestUtils.sleep(1000);
    });
    
    afterAll(async () => {
      await TestUtils.cleanupTestData();
      testSuite.afterAll();
    });
    
    beforeEach(() => {
      testSuite.beforeEach();
    });
    
    afterEach(() => {
      testSuite.afterEach();
    });
    
    /**
     * æµ‹è¯•å•ä¾‹æ¨¡å¼
     */
    it('should_be_singleton_instance', 0, () => {
      TestUtils.log('æµ‹è¯•å•ä¾‹æ¨¡å¼');
      
      const instance1 = SmartTextRenderer.getInstance();
      const instance2 = SmartTextRenderer.getInstance();
      
      expect(instance1).assertEqual(instance2);
      TestUtils.log('å•ä¾‹æ¨¡å¼éªŒè¯é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•Markdownæ¸²æŸ“
     */
    it('should_render_markdown', 0, () => {
      TestUtils.log('æµ‹è¯•Markdownæ¸²æŸ“');
      
      const markdownText = `
# æ ‡é¢˜1
## æ ‡é¢˜2
**ç²—ä½“æ–‡æœ¬**
*æ–œä½“æ–‡æœ¬*
- åˆ—è¡¨é¡¹1
- åˆ—è¡¨é¡¹2
[é“¾æ¥](https://example.com)
\`ä»£ç \`
`;
      
      const result = smartTextRenderer.renderMarkdown(markdownText);
      
      // éªŒè¯æ¸²æŸ“ç»“æœ
      expect(TestUtils.validateObjectStructure(result, ['html', 'metadata', 'renderTime'])).assertTrue();
      expect(result.html.length).assertGreaterThan(0);
      expect(result.html.includes('<h1>')).assertTrue();
      expect(result.html.includes('<strong>')).assertTrue();
      expect(result.html.includes('<em>')).assertTrue();
      expect(result.html.includes('<ul>')).assertTrue();
      expect(result.html.includes('<a href=')).assertTrue();
      expect(result.html.includes('<code>')).assertTrue();
      
      TestUtils.log('Markdownæ¸²æŸ“æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•ä»£ç é«˜äº®
     */
    it('should_highlight_code', 0, () => {
      TestUtils.log('æµ‹è¯•ä»£ç é«˜äº®');
      
      const pythonCode = `
def fibonacci(n):
    if n <= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)

# è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—
result = fibonacci(10)
print(f"ç»“æœ: {result}")
`;
      
      const result = smartTextRenderer.highlightCode(pythonCode, 'python');
      
      // éªŒè¯ä»£ç é«˜äº®ç»“æœ
      expect(TestUtils.validateObjectStructure(result, ['html', 'language', 'lineCount', 'highlightTime'])).assertTrue();
      expect(result.language).assertEqual('python');
      expect(result.lineCount).assertEqual(7);
      expect(result.html.includes('<span class="keyword">')).assertTrue();
      expect(result.html.includes('<span class="function">')).assertTrue();
      expect(result.html.includes('<span class="comment">')).assertTrue();
      
      TestUtils.log('ä»£ç é«˜äº®æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•å¤šè¯­è¨€ä»£ç é«˜äº®
     */
    it('should_highlight_multiple_languages', 0, () => {
      TestUtils.log('æµ‹è¯•å¤šè¯­è¨€ä»£ç é«˜äº®');
      
      const languages = [
        { code: 'const x = 10;', lang: 'javascript' },
        { code: 'int x = 10;', lang: 'java' },
        { code: 'x := 10', lang: 'go' },
        { code: 'x = 10', lang: 'python' },
        { code: '$x = 10', lang: 'php' }
      ];
      
      languages.forEach(({ code, lang }) => {
        const result = smartTextRenderer.highlightCode(code, lang);
        expect(result.language).assertEqual(lang);
        expect(result.html.length).assertGreaterThan(0);
      });
      
      TestUtils.log('å¤šè¯­è¨€ä»£ç é«˜äº®æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•å¯Œæ–‡æœ¬å¤„ç†
     */
    it('should_process_rich_text', 0, () => {
      TestUtils.log('æµ‹è¯•å¯Œæ–‡æœ¬å¤„ç†');
      
      const richText = `
<div>
  <p>è¿™æ˜¯ä¸€ä¸ªæ®µè½</p>
  <ul>
    <li>åˆ—è¡¨é¡¹1</li>
    <li>åˆ—è¡¨é¡¹2</li>
  </ul>
  <table>
    <tr><th>è¡¨å¤´1</th><th>è¡¨å¤´2</th></tr>
    <tr><td>æ•°æ®1</td><td>æ•°æ®2</td></tr>
  </table>
</div>
`;
      
      const result = smartTextRenderer.processRichText(richText);
      
      // éªŒè¯å¯Œæ–‡æœ¬å¤„ç†ç»“æœ
      expect(TestUtils.validateObjectStructure(result, ['processed', 'sanitized', 'styles'])).assertTrue();
      expect(result.processed.length).assertGreaterThan(0);
      expect(result.sanitized).assertTrue();
      
      TestUtils.log('å¯Œæ–‡æœ¬å¤„ç†æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•è¡¨æƒ…ç¬¦å·å¤„ç†
     */
    it('should_handle_emojis', 0, () => {
      TestUtils.log('æµ‹è¯•è¡¨æƒ…ç¬¦å·å¤„ç†');
      
      const textWithEmojis = 'ä½ å¥½ï¼ğŸ˜Š è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• ğŸš€ å¾ˆæœ‰è¶£ï¼ğŸ‰';
      const result = smartTextRenderer.processEmojis(textWithEmojis);
      
      // éªŒè¯è¡¨æƒ…ç¬¦å·å¤„ç†
      expect(TestUtils.validateObjectStructure(result, ['processed', 'emojiCount', 'replacements'])).assertTrue();
      expect(result.emojiCount).assertEqual(3);
      expect(result.replacements.length).assertEqual(3);
      expect(result.processed.includes('<img')).assertTrue();
      
      TestUtils.log('è¡¨æƒ…ç¬¦å·å¤„ç†æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•é“¾æ¥è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢
     */
    it('should_detect_and_convert_links', 0, () => {
      TestUtils.log('æµ‹è¯•é“¾æ¥è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢');
      
      const textWithLinks = 'è®¿é—® https://www.example.com æŸ¥çœ‹æ›´å¤šä¿¡æ¯ï¼Œæˆ–è€…å‘é€é‚®ä»¶åˆ° user@example.com';
      const result = smartTextRenderer.processLinks(textWithLinks);
      
      // éªŒè¯é“¾æ¥å¤„ç†
      expect(TestUtils.validateObjectStructure(result, ['processed', 'linksFound', 'linkTypes'])).assertTrue();
      expect(result.linksFound).assertEqual(2);
      expect(result.linkTypes).assertEqual(['url', 'email']);
      expect(result.processed.includes('<a href="https://www.example.com"')).assertTrue();
      expect(result.processed.includes('<a href="mailto:user@example.com"')).assertTrue();
      
      TestUtils.log('é“¾æ¥è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•æ–‡æœ¬æˆªæ–­å’Œçœç•¥
     */
    it('should_truncate_and_ellipsize_text', 0, () => {
      TestUtils.log('æµ‹è¯•æ–‡æœ¬æˆªæ–­å’Œçœç•¥');
      
      const longText = 'è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„æ–‡æœ¬ï¼Œéœ€è¦è¢«æˆªæ–­ä»¥é€‚åº”æ˜¾ç¤ºåŒºåŸŸçš„è¦æ±‚ã€‚è¿™ä¸ªæµ‹è¯•ç¡®ä¿æ–‡æœ¬æˆªæ–­åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚';
      
      // æµ‹è¯•å­—ç¬¦æˆªæ–­
      const charTruncated = smartTextRenderer.truncateText(longText, 20);
      expect(charTruncated.length).assertLessThanOrEqual(20 + 3); // +3 for ellipsis
      expect(charTruncated.includes('...')).assertTrue();
      
      // æµ‹è¯•å•è¯æˆªæ–­
      const wordTruncated = smartTextRenderer.truncateText(longText, 25, 'word');
      expect(wordTruncated.length).assertLessThanOrEqual(25 + 3);
      expect(wordTruncated.includes('...')).assertTrue();
      
      // æµ‹è¯•å¥å­æˆªæ–­
      const sentenceTruncated = smartTextRenderer.truncateText(longText, 30, 'sentence');
      expect(sentenceTruncated.length).assertLessThanOrEqual(30 + 3);
      
      TestUtils.log('æ–‡æœ¬æˆªæ–­å’Œçœç•¥æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•æ–‡æœ¬æœç´¢å’Œé«˜äº®
     */
    it('should_search_and_highlight_text', 0, () => {
      TestUtils.log('æµ‹è¯•æ–‡æœ¬æœç´¢å’Œé«˜äº®');
      
      const text = 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬ï¼Œç”¨äºæµ‹è¯•æœç´¢åŠŸèƒ½ã€‚æœç´¢åŠŸèƒ½åº”è¯¥èƒ½å¤Ÿæ­£ç¡®åŒ¹é…å’Œé«˜äº®æ–‡æœ¬ã€‚';
      const searchTerm = 'æœç´¢';
      
      const result = smartTextRenderer.searchAndHighlight(text, searchTerm);
      
      // éªŒè¯æœç´¢ç»“æœ
      expect(TestUtils.validateObjectStructure(result, ['highlighted', 'matches', 'positions'])).assertTrue();
      expect(result.matches).assertEqual(2);
      expect(result.positions.length).assertEqual(2);
      expect(result.highlighted.includes('<mark>')).assertTrue();
      expect(result.highlighted.includes('</mark>')).assertTrue();
      
      TestUtils.log('æ–‡æœ¬æœç´¢å’Œé«˜äº®æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•æ–‡æœ¬æ–¹å‘å’Œå¯¹é½
     */
    it('should_handle_text_direction_and_alignment', 0, () => {
      TestUtils.log('æµ‹è¯•æ–‡æœ¬æ–¹å‘å’Œå¯¹é½');
      
      const englishText = 'Hello World';
      const arabicText = 'Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù…';
      const mixedText = 'Hello Ù…Ø±Ø­Ø¨Ø§';
      
      // æµ‹è¯•æ–‡æœ¬æ–¹å‘æ£€æµ‹
      const englishDirection = smartTextRenderer.detectTextDirection(englishText);
      const arabicDirection = smartTextRenderer.detectTextDirection(arabicText);
      const mixedDirection = smartTextRenderer.detectTextDirection(mixedText);
      
      expect(englishDirection).assertEqual('ltr');
      expect(arabicDirection).assertEqual('rtl');
      expect(mixedDirection).assertEqual('mixed');
      
      // æµ‹è¯•æ–‡æœ¬å¯¹é½
      const alignedText = smartTextRenderer.alignText(englishText, 'center');
      expect(alignedText.includes('text-align: center')).assertTrue();
      
      TestUtils.log('æ–‡æœ¬æ–¹å‘å’Œå¯¹é½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–
     */
    it('should_optimize_rendering_performance', 0, async () => {
      TestUtils.log('æµ‹è¯•æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–');
      
      // åˆ›å»ºå¤§é‡æ–‡æœ¬
      const largeText = 'æµ‹è¯•æ–‡æœ¬\n'.repeat(1000);
      
      // æµ‹è¯•åˆ†å—æ¸²æŸ“
      const chunkedResult = await smartTextRenderer.renderInChunks(largeText, 100);
      
      // éªŒè¯åˆ†å—æ¸²æŸ“ç»“æœ
      expect(TestUtils.validateObjectStructure(chunkedResult, ['chunks', 'totalTime', 'averageChunkTime'])).assertTrue();
      expect(chunkedResult.chunks.length).assertEqual(10);
      expect(chunkedResult.totalTime).assertGreaterThan(0);
      expect(chunkedResult.averageChunkTime).assertGreaterThan(0);
      
      // æµ‹è¯•è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–
      const virtualScrollConfig = {
        itemHeight: 20,
        containerHeight: 200,
        totalItems: 1000,
        startIndex: 100
      };
      
      const virtualResult = smartTextRenderer.renderVirtualScroll(virtualScrollConfig);
      expect(TestUtils.validateObjectStructure(virtualResult, ['visibleItems', 'startIndex', 'endIndex', 'offset'])).assertTrue();
      expect(virtualResult.visibleItems.length).assertEqual(10);
      
      TestUtils.log('æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•é…ç½®ç®¡ç†
     */
    it('should_manage_configuration', 0, () => {
      TestUtils.log('æµ‹è¯•é…ç½®ç®¡ç†');
      
      // è·å–é»˜è®¤é…ç½®
      const defaultConfig = smartTextRenderer.getDefaultConfig();
      expect(TestUtils.validateObjectStructure(defaultConfig, ['theme', 'fontSize', 'lineHeight', 'codeHighlight', 'enableEmojis'])).assertTrue();
      
      // æµ‹è¯•é…ç½®æ›´æ–°
      const customConfig: RenderConfig = {
        theme: 'dark',
        fontSize: 16,
        lineHeight: 1.6,
        codeHighlight: true,
        enableEmojis: true,
        customStyles: {
          backgroundColor: '#1e1e1e',
          textColor: '#ffffff'
        }
      };
      
      smartTextRenderer.updateConfiguration(customConfig);
      
      // éªŒè¯é…ç½®æ›´æ–°
      const currentConfig = smartTextRenderer.getCurrentConfig();
      expect(currentConfig.theme).assertEqual('dark');
      expect(currentConfig.fontSize).assertEqual(16);
      expect(currentConfig.lineHeight).assertEqual(1.6);
      
      TestUtils.log('é…ç½®ç®¡ç†æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•é”™è¯¯å¤„ç†å’Œå®¹é”™
     */
    it('should_handle_errors_and_fault_tolerance', 0, () => {
      TestUtils.log('æµ‹è¯•é”™è¯¯å¤„ç†å’Œå®¹é”™');
      
      // æµ‹è¯•æ— æ•ˆMarkdown
      const invalidMarkdown = '# æ ‡é¢˜\n**ç²—ä½“\n*æ–œä½“';
      const result = smartTextRenderer.renderMarkdown(invalidMarkdown);
      expect(result.html.length).assertGreaterThan(0);
      
      // æµ‹è¯•æ— æ•ˆä»£ç è¯­è¨€
      const invalidLanguageCode = 'invalid code syntax';
      const invalidResult = smartTextRenderer.highlightCode(invalidLanguageCode, 'nonexistent');
      expect(invalidResult.html.length).assertGreaterThan(0);
      
      // æµ‹è¯•ç©ºè¾“å…¥
      const emptyResult = smartTextRenderer.renderMarkdown('');
      expect(emptyResult.html).assertEqual('');
      
      // æµ‹è¯•nullè¾“å…¥
      const nullResult = smartTextRenderer.renderMarkdown(null as any);
      expect(nullResult.html).assertEqual('');
      
      TestUtils.log('é”™è¯¯å¤„ç†å’Œå®¹é”™æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•æ¸²æŸ“ç¼“å­˜æœºåˆ¶
     */
    it('should_cache_rendering_results', 0, async () => {
      TestUtils.log('æµ‹è¯•æ¸²æŸ“ç¼“å­˜æœºåˆ¶');
      
      const testText = '# æµ‹è¯•æ ‡é¢˜\nè¿™æ˜¯æµ‹è¯•å†…å®¹';
      
      // ç¬¬ä¸€æ¬¡æ¸²æŸ“
      const result1 = await smartTextRenderer.renderWithCache(testText, 'markdown');
      const renderTime1 = result1.renderTime;
      
      // ç¬¬äºŒæ¬¡æ¸²æŸ“ï¼ˆåº”è¯¥ä½¿ç”¨ç¼“å­˜ï¼‰
      const result2 = await smartTextRenderer.renderWithCache(testText, 'markdown');
      const renderTime2 = result2.renderTime;
      
      // éªŒè¯ç¼“å­˜æ•ˆæœ
      expect(result2.fromCache).assertTrue();
      expect(renderTime2).assertLessThan(renderTime1);
      expect(result1.html).assertEqual(result2.html);
      
      // æµ‹è¯•ç¼“å­˜ç»Ÿè®¡
      const cacheStats = smartTextRenderer.getCacheStatistics();
      expect(TestUtils.validateObjectStructure(cacheStats, ['hits', 'misses', 'size', 'hitRate'])).assertTrue();
      expect(cacheStats.hits).assertGreaterThan(0);
      expect(cacheStats.misses).assertGreaterThan(0);
      
      TestUtils.log('æ¸²æŸ“ç¼“å­˜æœºåˆ¶æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•è‡ªå®šä¹‰æ ·å¼å’Œä¸»é¢˜
     */
    it('should_handle_custom_styles_and_themes', 0, () => {
      TestUtils.log('æµ‹è¯•è‡ªå®šä¹‰æ ·å¼å’Œä¸»é¢˜');
      
      const customTheme = {
        name: 'custom',
        colors: {
          primary: '#ff6b6b',
          secondary: '#4ecdc4',
          background: '#f7f7f7',
          text: '#2d3436',
          code: '#dfe6e9'
        },
        fonts: {
          heading: 'Arial',
          body: 'Georgia',
          code: 'Courier New'
        }
      };
      
      // åº”ç”¨è‡ªå®šä¹‰ä¸»é¢˜
      smartTextRenderer.applyCustomTheme(customTheme);
      
      // æ¸²æŸ“æµ‹è¯•æ–‡æœ¬
      const testText = '# æ ‡é¢˜\n**ç²—ä½“** `ä»£ç `';
      const result = smartTextRenderer.renderMarkdown(testText);
      
      // éªŒè¯è‡ªå®šä¹‰ä¸»é¢˜åº”ç”¨
      expect(result.html.includes(customTheme.colors.primary)).assertTrue();
      expect(result.html.includes(customTheme.fonts.heading)).assertTrue();
      
      TestUtils.log('è‡ªå®šä¹‰æ ·å¼å’Œä¸»é¢˜æµ‹è¯•é€šè¿‡');
    });
  });
}