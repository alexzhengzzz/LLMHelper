import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium';
import { TestUtils, TestSuiteBase, AsyncTestUtils } from './TestUtils';
import { AppStorage } from '../main/ets/utils/AppStorage';
import { Message, SystemPrompt, Session, SystemPromptData } from '../main/ets/models/ChatModels';
import { AvatarSettings, AutoTTSSettings, ModelConfig, UserProfileData } from '../main/ets/utils/AppStorage';

/**
 * AppStorageæµ‹è¯•å¥—ä»¶
 * æµ‹è¯•æ•°æ®å­˜å‚¨ã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤ç­‰åŠŸèƒ½
 */
export default function appStorageTest() {
  const testSuite = new TestSuiteBase();
  testSuite.setTestTag('AppStorageTest');
  
  describe('AppStorageTest', () => {
    let testDataPrefix = 'test_';
    
    beforeAll(async () => {
      testSuite.beforeAll();
      TestUtils.log('åˆå§‹åŒ–AppStorageæµ‹è¯•ç¯å¢ƒ');
      
      // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æµ‹è¯•æ•°æ®
      await cleanupTestData();
    });
    
    afterAll(async () => {
      // æ¸…ç†æµ‹è¯•æ•°æ®
      await cleanupTestData();
      testSuite.afterAll();
    });
    
    beforeEach(() => {
      testSuite.beforeEach();
    });
    
    afterEach(() => {
      testSuite.afterEach();
    });
    
    /**
     * æ¸…ç†æµ‹è¯•æ•°æ®çš„è¾…åŠ©å‡½æ•°
     */
    async function cleanupTestData(): Promise<void> {
      try {
        await AppStorage.clearMessages();
        TestUtils.log('æµ‹è¯•æ¶ˆæ¯æ¸…ç†å®Œæˆ');
      } catch (error) {
        TestUtils.warn('æ¸…ç†æµ‹è¯•æ¶ˆæ¯æ—¶å‡ºé”™: ' + (error as Error).message);
      }
    }
    
    /**
     * æµ‹è¯•AppStorageåŸºæœ¬åŠŸèƒ½
     */
    it('should_have_basic_storage_methods', 0, () => {
      TestUtils.log('æµ‹è¯•AppStorageåŸºæœ¬åŠŸèƒ½');
      
      // éªŒè¯é™æ€æ–¹æ³•å­˜åœ¨
      expect(typeof AppStorage.getStorage).assertEqual('function');
      expect(typeof AppStorage.saveMessages).assertEqual('function');
      expect(typeof AppStorage.getMessages).assertEqual('function');
      expect(typeof AppStorage.clearMessages).assertEqual('function');
      expect(typeof AppStorage.saveSystemPrompts).assertEqual('function');
      expect(typeof AppStorage.getSystemPrompts).assertEqual('function');
      expect(typeof AppStorage.saveSessions).assertEqual('function');
      expect(typeof AppStorage.getSessions).assertEqual('function');
      
      TestUtils.log('AppStorageåŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•æ¶ˆæ¯å­˜å‚¨åŠŸèƒ½
     */
    it('should_save_and_get_messages', 0, async () => {
      TestUtils.log('æµ‹è¯•æ¶ˆæ¯å­˜å‚¨åŠŸèƒ½');
      
      // åˆ›å»ºæµ‹è¯•æ¶ˆæ¯
      const testMessages: Message[] = [
        TestUtils.createMockMessage(testDataPrefix + 'msg1', 'ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£æ›´å¤šå…³äºAIç¼–ç¨‹åŠ©æ‰‹çš„ä¿¡æ¯'),
        TestUtils.createMockMessage(testDataPrefix + 'msg2', 'AIç¼–ç¨‹åŠ©æ‰‹å¯ä»¥å¸®åŠ©ä½ è¿›è¡Œä»£ç ç”Ÿæˆã€è°ƒè¯•å’Œä¼˜åŒ–'),
        TestUtils.createMockMessage(testDataPrefix + 'msg3', 'èƒ½å¦ç»™æˆ‘ä¸€ä¸ªPythonçš„Hello Worldç¤ºä¾‹ï¼Ÿ')
      ];
      
      // ä¿å­˜æ¶ˆæ¯
      await AppStorage.saveMessages(testMessages);
      TestUtils.log('æµ‹è¯•æ¶ˆæ¯ä¿å­˜å®Œæˆ');
      
      // ç­‰å¾…å­˜å‚¨æ“ä½œå®Œæˆ
      await TestUtils.sleep(500);
      
      // è¯»å–æ¶ˆæ¯
      const retrievedMessages = await AppStorage.getMessages();
      
      // éªŒè¯æ¶ˆæ¯æ•°é‡
      expect(retrievedMessages.length).assertEqual(3);
      
      // éªŒè¯æ¶ˆæ¯å†…å®¹
      expect(retrievedMessages[0].id).assertEqual(testDataPrefix + 'msg1');
      expect(retrievedMessages[0].content).assertEqual('ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£æ›´å¤šå…³äºAIç¼–ç¨‹åŠ©æ‰‹çš„ä¿¡æ¯');
      expect(retrievedMessages[0].role).assertEqual('user');
      
      expect(retrievedMessages[1].id).assertEqual(testDataPrefix + 'msg2');
      expect(retrievedMessages[1].content).assertEqual('AIç¼–ç¨‹åŠ©æ‰‹å¯ä»¥å¸®åŠ©ä½ è¿›è¡Œä»£ç ç”Ÿæˆã€è°ƒè¯•å’Œä¼˜åŒ–');
      expect(retrievedMessages[1].role).assertEqual('assistant');
      
      expect(retrievedMessages[2].id).assertEqual(testDataPrefix + 'msg3');
      expect(retrievedMessages[2].content).assertEqual('èƒ½å¦ç»™æˆ‘ä¸€ä¸ªPythonçš„Hello Worldç¤ºä¾‹ï¼Ÿ');
      
      TestUtils.log('æ¶ˆæ¯å­˜å‚¨åŠŸèƒ½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•æ¶ˆæ¯æ¸…ç†åŠŸèƒ½
     */
    it('should_clear_messages', 0, async () => {
      TestUtils.log('æµ‹è¯•æ¶ˆæ¯æ¸…ç†åŠŸèƒ½');
      
      // å…ˆä¿å­˜ä¸€äº›æ¶ˆæ¯
      const testMessages: Message[] = [
        TestUtils.createMockMessage(testDataPrefix + 'clear_msg1', 'è¿™æ¡æ¶ˆæ¯å°†è¢«åˆ é™¤'),
        TestUtils.createMockMessage(testDataPrefix + 'clear_msg2', 'è¿™æ¡æ¶ˆæ¯ä¹Ÿå°†è¢«åˆ é™¤')
      ];
      
      await AppStorage.saveMessages(testMessages);
      
      // éªŒè¯æ¶ˆæ¯å·²ä¿å­˜
      let retrievedMessages = await AppStorage.getMessages();
      expect(retrievedMessages.length).assertLarger(0);
      
      // æ¸…ç†æ¶ˆæ¯
      await AppStorage.clearMessages();
      
      // ç­‰å¾…æ¸…ç†æ“ä½œå®Œæˆ
      await TestUtils.sleep(500);
      
      // éªŒè¯æ¶ˆæ¯å·²æ¸…ç†
      retrievedMessages = await AppStorage.getMessages();
      expect(retrievedMessages.length).assertEqual(0);
      
      TestUtils.log('æ¶ˆæ¯æ¸…ç†åŠŸèƒ½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•ç³»ç»Ÿæç¤ºè¯å­˜å‚¨åŠŸèƒ½
     */
    it('should_save_and_get_system_prompts', 0, async () => {
      TestUtils.log('æµ‹è¯•ç³»ç»Ÿæç¤ºè¯å­˜å‚¨åŠŸèƒ½');
      
      // åˆ›å»ºæµ‹è¯•ç³»ç»Ÿæç¤ºè¯
      const testPrompts: SystemPrompt[] = [
        TestUtils.createMockSystemPrompt(testDataPrefix + 'prompt1', 'ç¼–ç¨‹åŠ©æ‰‹', 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·è§£å†³å„ç§ç¼–ç¨‹é—®é¢˜ã€‚', 'ç¼–ç¨‹'),
        TestUtils.createMockSystemPrompt(testDataPrefix + 'prompt2', 'ä»£ç å®¡æŸ¥', 'è¯·å¯¹ä»¥ä¸‹ä»£ç è¿›è¡Œå®¡æŸ¥ï¼ŒæŒ‡å‡ºå¯èƒ½çš„é—®é¢˜å’Œæ”¹è¿›å»ºè®®ã€‚', 'ä»£ç '),
        TestUtils.createMockSystemPrompt(testDataPrefix + 'prompt3', 'å­¦ä¹ åŠ©æ‰‹', 'ç”¨ç®€å•æ˜“æ‡‚çš„æ–¹å¼è§£é‡Šå¤æ‚çš„æ¦‚å¿µï¼Œå¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ç†è§£ã€‚', 'å­¦ä¹ ')
      ];
      
      // ä¿å­˜ç³»ç»Ÿæç¤ºè¯
      await AppStorage.saveSystemPrompts(testPrompts);
      TestUtils.log('æµ‹è¯•ç³»ç»Ÿæç¤ºè¯ä¿å­˜å®Œæˆ');
      
      // ç­‰å¾…å­˜å‚¨æ“ä½œå®Œæˆ
      await TestUtils.sleep(500);
      
      // è¯»å–ç³»ç»Ÿæç¤ºè¯
      const retrievedPrompts = await AppStorage.getSystemPrompts();
      
      // éªŒè¯æç¤ºè¯æ•°é‡
      expect(retrievedPrompts.length).assertEqual(3);
      
      // éªŒè¯æç¤ºè¯å†…å®¹
      expect(retrievedPrompts[0].id).assertEqual(testDataPrefix + 'prompt1');
      expect(retrievedPrompts[0].name).assertEqual('ç¼–ç¨‹åŠ©æ‰‹');
      expect(retrievedPrompts[0].content).toContain('ç¼–ç¨‹åŠ©æ‰‹');
      expect(retrievedPrompts[0].category).assertEqual('ç¼–ç¨‹');
      
      expect(retrievedPrompts[1].id).assertEqual(testDataPrefix + 'prompt2');
      expect(retrievedPrompts[1].name).assertEqual('ä»£ç å®¡æŸ¥');
      expect(retrievedPrompts[1].category).assertEqual('ä»£ç ');
      
      expect(retrievedPrompts[2].id).assertEqual(testDataPrefix + 'prompt3');
      expect(retrievedPrompts[2].name).assertEqual('å­¦ä¹ åŠ©æ‰‹');
      expect(retrievedPrompts[2].category).assertEqual('å­¦ä¹ ');
      
      TestUtils.log('ç³»ç»Ÿæç¤ºè¯å­˜å‚¨åŠŸèƒ½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•ä¼šè¯å­˜å‚¨åŠŸèƒ½
     */
    it('should_save_and_get_sessions', 0, async () => {
      TestUtils.log('æµ‹è¯•ä¼šè¯å­˜å‚¨åŠŸèƒ½');
      
      // åˆ›å»ºæµ‹è¯•ä¼šè¯
      const testSessions: Session[] = [
        TestUtils.createMockSession(testDataPrefix + 'session1', 'ç¼–ç¨‹è®¨è®º', 5),
        TestUtils.createMockSession(testDataPrefix + 'session2', 'å­¦ä¹ å’¨è¯¢', 3),
        TestUtils.createMockSession(testDataPrefix + 'session3', 'ä»£ç å®¡æŸ¥', 8)
      ];
      
      // ä¿å­˜ä¼šè¯
      await AppStorage.saveSessions(testSessions);
      TestUtils.log('æµ‹è¯•ä¼šè¯ä¿å­˜å®Œæˆ');
      
      // ç­‰å¾…å­˜å‚¨æ“ä½œå®Œæˆ
      await TestUtils.sleep(500);
      
      // è¯»å–ä¼šè¯
      const retrievedSessions = await AppStorage.getSessions();
      
      // éªŒè¯ä¼šè¯æ•°é‡
      expect(retrievedSessions.length).assertEqual(3);
      
      // éªŒè¯ä¼šè¯å†…å®¹
      expect(retrievedSessions[0].id).assertEqual(testDataPrefix + 'session1');
      expect(retrievedSessions[0].title).assertEqual('ç¼–ç¨‹è®¨è®º');
      expect(retrievedSessions[0].messageCount).assertEqual(5);
      
      expect(retrievedSessions[1].id).assertEqual(testDataPrefix + 'session2');
      expect(retrievedSessions[1].title).assertEqual('å­¦ä¹ å’¨è¯¢');
      expect(retrievedSessions[1].messageCount).assertEqual(3);
      
      expect(retrievedSessions[2].id).assertEqual(testDataPrefix + 'session3');
      expect(retrievedSessions[2].title).assertEqual('ä»£ç å®¡æŸ¥');
      expect(retrievedSessions[2].messageCount).assertEqual(8);
      
      TestUtils.log('ä¼šè¯å­˜å‚¨åŠŸèƒ½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•å¤´åƒè®¾ç½®å­˜å‚¨åŠŸèƒ½
     */
    it('should_save_and_get_avatar_settings', 0, async () => {
      TestUtils.log('æµ‹è¯•å¤´åƒè®¾ç½®å­˜å‚¨åŠŸèƒ½');
      
      // åˆ›å»ºæµ‹è¯•å¤´åƒè®¾ç½®
      const testAvatarSettings = new AvatarSettings(
        'emoji',
        'ğŸ˜Š',
        'default',
        '#34A853'
      );
      
      // ä¿å­˜å¤´åƒè®¾ç½®
      await AppStorage.saveAvatarSettings(testAvatarSettings);
      TestUtils.log('æµ‹è¯•å¤´åƒè®¾ç½®ä¿å­˜å®Œæˆ');
      
      // ç­‰å¾…å­˜å‚¨æ“ä½œå®Œæˆ
      await TestUtils.sleep(500);
      
      // è¯»å–å¤´åƒè®¾ç½®
      const retrievedSettings = await AppStorage.getAvatarSettings();
      
      // éªŒè¯å¤´åƒè®¾ç½®å†…å®¹
      expect(retrievedSettings).assertEqual(true);
      expect(retrievedSettings.userAvatarType).assertEqual('emoji');
      expect(retrievedSettings.userAvatarValue).assertEqual('ğŸ˜Š');
      expect(retrievedSettings.aiAvatarType).assertEqual('default');
      expect(retrievedSettings.aiAvatarValue).assertEqual('#34A853');
      
      TestUtils.log('å¤´åƒè®¾ç½®å­˜å‚¨åŠŸèƒ½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•TTSè®¾ç½®å­˜å‚¨åŠŸèƒ½
     */
    it('should_save_and_get_tts_settings', 0, async () => {
      TestUtils.log('æµ‹è¯•TTSè®¾ç½®å­˜å‚¨åŠŸèƒ½');
      
      // åˆ›å»ºæµ‹è¯•TTSè®¾ç½®
      const testTTSSettings: AutoTTSSettings = {
        muted: false,
        speed: 1.2,
        volume: 0.8,
        pitch: 1.0,
        language: 'zh-CN',
        autoPlayOnReceive: true
      };
      
      // ä¿å­˜TTSè®¾ç½®
      await AppStorage.saveAutoTTSSettings(testTTSSettings);
      TestUtils.log('æµ‹è¯•TTSè®¾ç½®ä¿å­˜å®Œæˆ');
      
      // ç­‰å¾…å­˜å‚¨æ“ä½œå®Œæˆ
      await TestUtils.sleep(500);
      
      // è¯»å–TTSè®¾ç½®
      const retrievedSettings = await AppStorage.getAutoTTSSettings();
      
      // éªŒè¯TTSè®¾ç½®å†…å®¹
      expect(retrievedSettings).assertEqual(true);
      expect(retrievedSettings.muted).assertEqual(true);
      expect(retrievedSettings.speed).assertEqual(1.2);
      expect(retrievedSettings.volume).assertEqual(0.8);
      expect(retrievedSettings.pitch).assertEqual(1.0);
      expect(retrievedSettings.language).assertEqual('zh-CN');
      expect(retrievedSettings.autoPlayOnReceive).assertEqual(true);
      
      TestUtils.log('TTSè®¾ç½®å­˜å‚¨åŠŸèƒ½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•ç”¨æˆ·èµ„æ–™å­˜å‚¨åŠŸèƒ½
     */
    it('should_save_and_get_user_profile', 0, async () => {
      TestUtils.log('æµ‹è¯•ç”¨æˆ·èµ„æ–™å­˜å‚¨åŠŸèƒ½');
      
      // åˆ›å»ºæµ‹è¯•ç”¨æˆ·èµ„æ–™
      const testUserProfile: UserProfileData = {
        userName: 'æµ‹è¯•ç”¨æˆ·',
        userSignature: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨æˆ·çš„ä¸ªæ€§ç­¾å',
        userAvatarType: 'emoji',
        userAvatarValue: 'ğŸ§ª',
        updatedAt: Date.now()
      };
      
      // ä¿å­˜ç”¨æˆ·èµ„æ–™
      await AppStorage.saveUserProfile(testUserProfile);
      TestUtils.log('æµ‹è¯•ç”¨æˆ·èµ„æ–™ä¿å­˜å®Œæˆ');
      
      // ç­‰å¾…å­˜å‚¨æ“ä½œå®Œæˆ
      await TestUtils.sleep(500);
      
      // è¯»å–ç”¨æˆ·èµ„æ–™
      const retrievedProfile = await AppStorage.getUserProfile();
      
      // éªŒè¯ç”¨æˆ·èµ„æ–™å†…å®¹
      expect(retrievedProfile).assertEqual(true);
      expect(retrievedProfile.userName).assertEqual('æµ‹è¯•ç”¨æˆ·');
      expect(retrievedProfile.userSignature).assertEqual('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨æˆ·çš„ä¸ªæ€§ç­¾å');
      expect(retrievedProfile.userAvatarType).assertEqual('emoji');
      expect(retrievedProfile.userAvatarValue).assertEqual('ğŸ§ª');
      
      TestUtils.log('ç”¨æˆ·èµ„æ–™å­˜å‚¨åŠŸèƒ½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•æ¨¡å‹é…ç½®å­˜å‚¨åŠŸèƒ½
     */
    it('should_save_and_get_model_config', 0, async () => {
      TestUtils.log('æµ‹è¯•æ¨¡å‹é…ç½®å­˜å‚¨åŠŸèƒ½');
      
      // åˆ›å»ºæµ‹è¯•æ¨¡å‹é…ç½®
      const testModelConfig: ModelConfig = {
        provider: 'siliconflow',
        model: 'Qwen/Qwen2.5-7B-Instruct',
        savedAt: Date.now()
      };
      
      // ä¿å­˜æ¨¡å‹é…ç½®
      await AppStorage.saveModelConfig(testModelConfig);
      TestUtils.log('æµ‹è¯•æ¨¡å‹é…ç½®ä¿å­˜å®Œæˆ');
      
      // ç­‰å¾…å­˜å‚¨æ“ä½œå®Œæˆ
      await TestUtils.sleep(500);
      
      // è¯»å–æ¨¡å‹é…ç½®
      const retrievedConfig = await AppStorage.getModelConfig();
      
      // éªŒè¯æ¨¡å‹é…ç½®å†…å®¹
      expect(retrievedConfig).assertEqual(true);
      expect(retrievedConfig.provider).assertEqual('siliconflow');
      expect(retrievedConfig.model).assertEqual('Qwen/Qwen2.5-7B-Instruct');
      expect(typeof retrievedConfig.savedAt).assertEqual('number');
      
      TestUtils.log('æ¨¡å‹é…ç½®å­˜å‚¨åŠŸèƒ½æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•é”™è¯¯å¤„ç†
     */
    it('should_handle_storage_errors', 0, async () => {
      TestUtils.log('æµ‹è¯•å­˜å‚¨é”™è¯¯å¤„ç†');
      
      // æµ‹è¯•ç©ºæ•°æ®å¤„ç†
      const emptyMessages: Message[] = [];
      await AppStorage.saveMessages(emptyMessages);
      
      const retrievedEmptyMessages = await AppStorage.getMessages();
      expect(retrievedEmptyMessages.length).assertEqual(0);
      
      // æµ‹è¯•ç©ºç³»ç»Ÿæç¤ºè¯å¤„ç†
      const emptyPrompts: SystemPrompt[] = [];
      await AppStorage.saveSystemPrompts(emptyPrompts);
      
      const retrievedEmptyPrompts = await AppStorage.getSystemPrompts();
      expect(retrievedEmptyPrompts.length).assertEqual(0);
      
      TestUtils.log('å­˜å‚¨é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡');
    });
    
    /**
     * æµ‹è¯•å¹¶å‘è®¿é—®
     */
    it('should_handle_concurrent_access', 0, async () => {
      TestUtils.log('æµ‹è¯•å¹¶å‘è®¿é—®');
      
      // åˆ›å»ºå¤šä¸ªå¹¶å‘å­˜å‚¨æ“ä½œ
      const concurrentOperations = [
        AppStorage.saveMessages([
          TestUtils.createMockMessage(testDataPrefix + 'concurrent1', 'å¹¶å‘æ¶ˆæ¯1'),
          TestUtils.createMockMessage(testDataPrefix + 'concurrent2', 'å¹¶å‘æ¶ˆæ¯2')
        ]),
        AppStorage.saveSessions([
          TestUtils.createMockSession(testDataPrefix + 'concurrent_session1', 'å¹¶å‘ä¼šè¯1', 2)
        ]),
        AppStorage.saveSystemPrompts([
          TestUtils.createMockSystemPrompt(testDataPrefix + 'concurrent_prompt1', 'å¹¶å‘æç¤ºè¯1', 'å¹¶å‘å†…å®¹1', 'æµ‹è¯•')
        ])
      ];
      
      // ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
      await Promise.all(concurrentOperations);
      
      // ç­‰å¾…å­˜å‚¨æ“ä½œå®Œæˆ
      await TestUtils.sleep(1000);
      
      // éªŒè¯æ•°æ®å®Œæ•´æ€§
      const messages = await AppStorage.getMessages();
      const sessions = await AppStorage.getSessions();
      const prompts = await AppStorage.getSystemPrompts();
      
      expect(messages.length).assertLarger(0);
      expect(sessions.length).assertLarger(0);
      expect(prompts.length).assertLarger(0);
      
      TestUtils.log('å¹¶å‘è®¿é—®æµ‹è¯•é€šè¿‡');
    });
  });
}